
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Mining Input Grammars &#8212; The Fuzzing Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=42e1b1a5" />
    <link rel="stylesheet" type="text/css" href="_static/mastodon-timeline.css?v=f82c2b23" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'GrammarMiner';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Tracking Information Flow" href="InformationFlow.html" />
    <link rel="prev" title="Fuzzing with Constraints" href="FuzzingWithConstraints.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content"><p>This is a beta version of fuzzingbook.org, currently in development. See the <a href="https://fuzzingbook.org/classic/"  style="color:white!important;">classic site</a> for the 2024 version.</p></div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/fuzzingbook.png" class="logo__image only-light" alt="The Fuzzing Book - Home"/>
    <script>document.write(`<img src="_static/fuzzingbook.png" class="logo__image only-dark" alt="The Fuzzing Book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    The Fuzzing Book
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tours.html">Sitemap</a></li>
<li class="toctree-l1"><a class="reference internal" href="Intro_Testing.html">Introduction to Software Testing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Lexical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Fuzzer.html">Fuzzing: Breaking Things with Random Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Coverage.html">Code Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="MutationFuzzer.html">Mutation-Based Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GreyboxFuzzer.html">Greybox Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="SearchBasedFuzzer.html">Search-Based Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="MutationAnalysis.html">Mutation Analysis</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Syntactical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Grammars.html">Fuzzing with Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarFuzzer.html">Efficient Grammar Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarCoverageFuzzer.html">Grammar Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="Parser.html">Parsing Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ProbabilisticGrammarFuzzer.html">Probabilistic Grammar Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GeneratorGrammarFuzzer.html">Fuzzing with Generators</a></li>

<li class="toctree-l1"><a class="reference internal" href="GreyboxGrammarFuzzer.html">Greybox Fuzzing with Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="Reducer.html">Reducing Failure-Inducing Inputs</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Semantical Fuzzing</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="FuzzingWithConstraints.html">Fuzzing with Constraints</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Mining Input Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="InformationFlow.html">Tracking Information Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="ConcolicFuzzer.html">Concolic Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="SymbolicFuzzer.html">Symbolic Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="DynamicInvariants.html">Mining Function Specifications</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Domain-Specific Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ConfigurationFuzzer.html">Testing Configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="APIFuzzer.html">Fuzzing APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Carver.html">Carving Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="PythonFuzzer.html">Testing Compilers</a></li>
<li class="toctree-l1"><a class="reference internal" href="WebFuzzer.html">Testing Web Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="GUIFuzzer.html">Testing Graphical User Interfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Managing Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="FuzzingInTheLarge.html">Fuzzing in the Large</a></li>
<li class="toctree-l1"><a class="reference internal" href="WhenToStopFuzzing.html">When To Stop Fuzzing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Essays</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="AcademicPrototyping.html">Academic Prototyping</a></li>
<li class="toctree-l1"><a class="reference internal" href="PrototypingWithPython.html">Prototyping with Python</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ExpectError.html">Error Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timer.html">Timer</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timeout.html">Timeout</a></li>
<li class="toctree-l1"><a class="reference internal" href="ClassDiagram.html">Class Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="RailroadDiagrams.html">Railroad Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="ControlFlow.html">Control Flow Graph</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About This Book</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ReleaseNotes.html">Fuzzingbook Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="Importing.html">Downloads and Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="Guide_for_Authors.html">Guide for Authors</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/master?urlpath=tree/docs/notebooks/GrammarMiner.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/uds-se/fuzzingbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/uds-se/fuzzingbook/issues/new?title=Issue%20on%20page%20%2FGrammarMiner.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
    <li><a href="../code/GrammarMiner.py" target="_blank"
       class="btn btn-sm btn-download-source-button dropdown-item"
       title="Download Python code"
       data-bs-placement="left" data-bs-toggle="tooltip"
    >
  

    <span class="btn__icon-container">
      <i class="fas fa-file"></i>
      </span>
    <span class="btn__text-container">.py</span>
    </a>
    </li>
    
      
      
      
      <li><a href="_sources/GrammarMiner.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download notebook"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  
    <li><a href="Importing.html" target="_blank"
       class="btn btn-sm btn-download-source-button dropdown-item"
       title="All downloads"
       data-bs-placement="left" data-bs-toggle="tooltip"
    >
  

    <span class="btn__icon-container">
      <i class="fas fa-file"></i>
      </span>
    <span class="btn__text-container">All downloads</span>
    </a>
    </li>
    </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Mining Input Grammars</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-grammar-challenge">A Grammar Challenge</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-simple-grammar-miner">A Simple Grammar Miner</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tracer">Tracer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#context">Context</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#definetracker">DefineTracker</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assembling-a-derivation-tree">Assembling a Derivation Tree</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#recovering-grammars-from-derivation-trees">Recovering Grammars from Derivation Trees</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-1-recovering-the-inventory-grammar">Example 1. Recovering the Inventory Grammar</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2-recovering-url-grammar">Example 2. Recovering URL Grammar</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fuzzing">Fuzzing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problems-with-the-simple-miner">Problems with the Simple Miner</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#grammar-miner-with-reassignment">Grammar Miner with Reassignment</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tracking-variable-assignment-locations">Tracking variable assignment locations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#callstack">CallStack</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#vars">Vars</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assignmentvars">AssignmentVars</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assignmenttracker">AssignmentTracker</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#recovering-a-derivation-tree">Recovering a Derivation Tree</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-1-recovering-url-derivation-tree">Example 1: Recovering URL Derivation Tree</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#url-1-derivation-tree">URL 1 derivation tree</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#url-4-derivation-tree">URL 4 derivation tree</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#recover-grammar">Recover Grammar</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2-recovering-inventory-grammar">Example 2: Recovering Inventory Grammar</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problems-with-the-grammar-miner-with-reassignment">Problems with the Grammar Miner with Reassignment</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-grammar-miner-with-scope">A Grammar Miner with Scope</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#input-stack">Input Stack</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#scopedvars">ScopedVars</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#scope-tracker">Scope Tracker</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Recovering a Derivation Tree</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-1-recovering-url-parse-tree">Example 1: Recovering URL Parse Tree</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2-recovering-inventory-parse-tree">Example 2: Recovering Inventory Parse Tree</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#grammar-mining">Grammar Mining</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-flattening-complex-objects">Exercise 1: Flattening complex objects</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-incorporating-taints-from-informationflow">Exercise 2: Incorporating Taints from InformationFlow</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="mining-input-grammars">
<h1>Mining Input Grammars<a class="headerlink" href="#mining-input-grammars" title="Link to this heading">#</a></h1>
<p>So far, the grammars we have seen have been mostly specified manually – that is, you (or the person knowing the input format) had to design and write a grammar in the first place.  While the grammars we have seen so far have been rather simple, creating a grammar for complex inputs can involve quite some effort.  In this chapter, we therefore introduce techniques that <em>automatically mine grammars from programs</em> – by executing the programs and observing how they process which parts of the input.  In conjunction with a grammar fuzzer, this allows us to</p>
<ol class="arabic simple">
<li><p>take a program,</p></li>
<li><p>extract its input grammar, and</p></li>
<li><p>fuzz it with high efficiency and effectiveness, using the concepts in this book.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">YouTubeVideo</span>
<span class="n">YouTubeVideo</span><span class="p">(</span><span class="s2">&quot;ddM1oL2LYDI&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="640"
            height="360"
            src="https://www.youtube-nocookie.com/embed/ddM1oL2LYDI"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<p><strong>Prerequisites</strong></p>
<ul class="simple">
<li><p>You should have read the <a class="reference internal" href="Grammars.html"><span class="std std-doc">chapter on grammars</span></a>.</p></li>
<li><p>The <a class="reference internal" href="ConfigurationFuzzer.html"><span class="std std-doc">chapter on configuration fuzzing</span></a> introduces grammar mining for configuration options, as well as observing variables and values during execution.</p></li>
<li><p>We use the tracer from the <a class="reference internal" href="Coverage.html"><span class="std std-doc">chapter on coverage</span></a>.</p></li>
<li><p>The concept of parsing from the <a class="reference internal" href="Parser.html"><span class="std std-doc">chapter on parsers</span></a> is also useful.</p></li>
</ul>
<section id="synopsis">
<h2>Synopsis<a class="headerlink" href="#synopsis" title="Link to this heading">#</a></h2>
<p>To <a class="reference internal" href="Importing.html"><span class="std std-doc">use the code provided in this chapter</span></a>, write</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">fuzzingbook.GrammarMiner</span><span class="w"> </span><span class="kn">import</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>and then make use of the following features.</p>
<p><strong>Note</strong>: The examples in this section only work after the rest of the cells have been executed.</p>
<p>We apply <code class="docutils literal notranslate"><span class="pre">recover_grammar()</span></code> on a <code class="docutils literal notranslate"><span class="pre">url_parse()</span></code> function that takes and decomposes URLs:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url_parse</span><span class="p">(</span><span class="s1">&#39;https://www.fuzzingbook.org/&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">URLS</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;http://user:pass@www.google.com:80/?q=path#ref&#39;,
 &#39;https://www.cispa.saarland:80/&#39;,
 &#39;http://www.fuzzingbook.org/#News&#39;]
</pre></div>
</div>
</div>
</div>
<p>We extract the input grammar for <code class="docutils literal notranslate"><span class="pre">url_parse()</span></code> using <code class="docutils literal notranslate"><span class="pre">recover_grammar()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grammar</span> <span class="o">=</span> <span class="n">recover_grammar</span><span class="p">(</span><span class="n">url_parse</span><span class="p">,</span> <span class="n">URLS</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;urllib/parse.py&#39;</span><span class="p">])</span>
<span class="n">grammar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&lt;start&gt;&#39;: [&#39;&lt;urlsplit@469:url&gt;&#39;],
 &#39;&lt;urlsplit@469:url&gt;&#39;: [&#39;&lt;urlparse@396:scheme&gt;:&lt;_splitnetloc@413:url&gt;&#39;],
 &#39;&lt;urlparse@396:scheme&gt;&#39;: [&#39;http&#39;, &#39;https&#39;],
 &#39;&lt;_splitnetloc@413:url&gt;&#39;: [&#39;//&lt;urlparse@396:netloc&gt;/&#39;,
  &#39;//&lt;urlparse@396:netloc&gt;&lt;urlsplit@511:url&gt;&#39;],
 &#39;&lt;urlparse@396:netloc&gt;&#39;: [&#39;www.cispa.saarland:80&#39;,
  &#39;user:pass@www.google.com:80&#39;,
  &#39;www.fuzzingbook.org&#39;],
 &#39;&lt;urlsplit@511:url&gt;&#39;: [&#39;&lt;urlsplit@518:url&gt;#&lt;urlparse@396:fragment&gt;&#39;,
  &#39;/#&lt;urlparse@396:fragment&gt;&#39;],
 &#39;&lt;urlsplit@518:url&gt;&#39;: [&#39;/?&lt;urlparse@396:query&gt;&#39;],
 &#39;&lt;urlparse@396:query&gt;&#39;: [&#39;q=path&#39;],
 &#39;&lt;urlparse@396:fragment&gt;&#39;: [&#39;ref&#39;, &#39;News&#39;]}
</pre></div>
</div>
</div>
</div>
<p>The names of nonterminals are a bit technical; but the grammar nicely represents the structure of the input; for instance, the different schemes (<code class="docutils literal notranslate"><span class="pre">&quot;http&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;https&quot;</span></code>) are all identified:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">syntax_diagram</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>start
</pre></div>
</div>
<img alt="_images/b06277ac1338f7c428c2b7ceafbcb78edb1bd70411afb4024832ba97d5d34350.svg" src="_images/b06277ac1338f7c428c2b7ceafbcb78edb1bd70411afb4024832ba97d5d34350.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlsplit@469:url
</pre></div>
</div>
<img alt="_images/83886c01d3bacf2ad0eabfffd56eaa1c902a0ad7a0f9da61a33a4e5aa1a43e0b.svg" src="_images/83886c01d3bacf2ad0eabfffd56eaa1c902a0ad7a0f9da61a33a4e5aa1a43e0b.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlparse@396:scheme
</pre></div>
</div>
<img alt="_images/fbb19724c7b27c1f23463890bb881a9dcdf2ebda97a1701b57710139fe86089f.svg" src="_images/fbb19724c7b27c1f23463890bb881a9dcdf2ebda97a1701b57710139fe86089f.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>_splitnetloc@413:url
</pre></div>
</div>
<img alt="_images/4842e9cfc5629d48f4dddbd8c5624f98a9a178e979973034ae002572fc0da1a6.svg" src="_images/4842e9cfc5629d48f4dddbd8c5624f98a9a178e979973034ae002572fc0da1a6.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlparse@396:netloc
</pre></div>
</div>
<img alt="_images/a95d882a02080f35a9676cd55c7556a55350efbf28d62fc3f7d7ab79da2bc3df.svg" src="_images/a95d882a02080f35a9676cd55c7556a55350efbf28d62fc3f7d7ab79da2bc3df.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlsplit@511:url
</pre></div>
</div>
<img alt="_images/1c4e7f6b860594323f69c5504368b4ed3995ec871f3afdb458bd77681b8f5071.svg" src="_images/1c4e7f6b860594323f69c5504368b4ed3995ec871f3afdb458bd77681b8f5071.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlsplit@518:url
</pre></div>
</div>
<img alt="_images/e3061240e0a85b6c401488c81692b59f76eaab5b55c6512cf37acb776286dca8.svg" src="_images/e3061240e0a85b6c401488c81692b59f76eaab5b55c6512cf37acb776286dca8.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlparse@396:query
</pre></div>
</div>
<img alt="_images/de5ded46744e5b7c67e252ef1e6584905ae59e3a3258135bbbcf6d2489bc30e1.svg" src="_images/de5ded46744e5b7c67e252ef1e6584905ae59e3a3258135bbbcf6d2489bc30e1.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlparse@396:fragment
</pre></div>
</div>
<img alt="_images/b1807127561ada743af29d4ef4cf46599809761428c1f041734488b36269fe20.svg" src="_images/b1807127561ada743af29d4ef4cf46599809761428c1f041734488b36269fe20.svg" />
</div>
</div>
<p>The grammar can be immediately used for fuzzing, producing arbitrary combinations of input elements, which are all syntactically valid.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">GrammarCoverageFuzzer</span><span class="w"> </span><span class="kn">import</span> <span class="n">GrammarCoverageFuzzer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fuzzer</span> <span class="o">=</span> <span class="n">GrammarCoverageFuzzer</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>
<span class="p">[</span><span class="n">fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;http://www.cispa.saarland:80/?q=path#ref&#39;,
 &#39;https://user:pass@www.google.com:80/&#39;,
 &#39;https://www.fuzzingbook.org/#News&#39;,
 &#39;https://user:pass@www.google.com:80/&#39;,
 &#39;https://www.fuzzingbook.org/?q=path#ref&#39;]
</pre></div>
</div>
</div>
</div>
<p>Being able to automatically extract a grammar and to use this grammar for fuzzing makes for very effective test generation with a minimum of manual work.</p>
</section>
<section id="a-grammar-challenge">
<h2>A Grammar Challenge<a class="headerlink" href="#a-grammar-challenge" title="Link to this heading">#</a></h2>
<p>Consider the <code class="docutils literal notranslate"><span class="pre">process_inventory()</span></code> method from the <a class="reference internal" href="Parser.html"><span class="std std-doc">chapter on parsers</span></a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">bookutils.setup</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterable</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">Parser</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_inventory</span><span class="p">,</span> <span class="n">process_vehicle</span><span class="p">,</span> <span class="n">process_car</span><span class="p">,</span> <span class="n">process_van</span><span class="p">,</span> <span class="n">lr_graph</span>  <span class="c1"># minor dependency</span>
</pre></div>
</div>
</div>
</div>
<p>It takes inputs of the following form.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">INVENTORY</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">1997,van,Ford,E350</span>
<span class="s2">2000,car,Mercury,Cougar</span>
<span class="s2">1999,car,Chevy,Venture</span><span class="se">\</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">process_inventory</span><span class="p">(</span><span class="n">INVENTORY</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>We have a Ford E350 van from 1997 vintage.
It is an old but reliable model!
We have a Mercury Cougar car from 2000 vintage.
It is an old but reliable model!
We have a Chevy Venture car from 1999 vintage.
It is an old but reliable model!
</pre></div>
</div>
</div>
</div>
<p>We found from the <a class="reference internal" href="Parser.html"><span class="std std-doc">chapter on parsers</span></a> that coarse grammars do not work well for fuzzing when the input format includes details expressed only in code. That is, even though we have the formal specification of CSV files (<a class="reference external" href="https://tools.ietf.org/html/rfc4180">RFC 4180</a>), the inventory system includes further rules as to what is expected at each index of the CSV file. The solution of simply recombining existing inputs, while practical, is incomplete. In particular, it relies on a formal input specification being available in the first place. However, we have no assurance that the program obeys the input specification given.</p>
<p>One of the ways out of this predicament is to interrogate the program under test as to what its input specification is. That is, if the program under test is written in a style such that specific methods are responsible for handling specific parts of the input, one can recover the parse tree by observing the process of parsing. Further, one can recover a reasonable approximation of the grammar by abstraction from multiple input trees.</p>
<p><em>We start with the assumption (1) that the program is written in such a fashion that specific methods are responsible for parsing specific fragments of the program – This includes almost all ad hoc parsers.</em></p>
<p>The idea is as follows:</p>
<ul class="simple">
<li><p>Hook into the Python execution and observe the fragments of input string as they are produced and named in different methods.</p></li>
<li><p>Stitch the input fragments together in a tree structure to retrieve the <strong>Parse Tree</strong>.</p></li>
<li><p>Abstract common elements from multiple parse trees to produce the <strong>Context Free Grammar</strong> of the input.</p></li>
</ul>
</section>
<section id="a-simple-grammar-miner">
<h2>A Simple Grammar Miner<a class="headerlink" href="#a-simple-grammar-miner" title="Link to this heading">#</a></h2>
<p>Say we want to obtain the input grammar for the function <code class="docutils literal notranslate"><span class="pre">process_vehicle()</span></code>. We first collect the sample inputs for this function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">VEHICLES</span> <span class="o">=</span> <span class="n">INVENTORY</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The set of methods responsible for processing inventory are the following.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">INVENTORY_METHODS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;process_inventory&#39;</span><span class="p">,</span>
    <span class="s1">&#39;process_vehicle&#39;</span><span class="p">,</span>
    <span class="s1">&#39;process_van&#39;</span><span class="p">,</span>
    <span class="s1">&#39;process_car&#39;</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>We have seen from the chapter on <a class="reference internal" href="ConfigurationFuzzer.html"><span class="std std-doc">configuration fuzzing</span></a> that one can hook into the Python runtime to observe the arguments to a function and any local variables created. We have also seen that one can obtain the context of execution by inspecting the <code class="docutils literal notranslate"><span class="pre">frame</span></code> argument. Here is a simple tracer that can return the local variables and other contextual information in a traced function. We reuse the <code class="docutils literal notranslate"><span class="pre">Coverage</span></code> tracing class.</p>
<section id="tracer">
<h3>Tracer<a class="headerlink" href="#tracer" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">Coverage</span><span class="w"> </span><span class="kn">import</span> <span class="n">Coverage</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Tracer</span><span class="p">(</span><span class="n">Coverage</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">traceit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="n">method_name</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getframeinfo</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span><span class="o">.</span><span class="n">function</span>
        <span class="k">if</span> <span class="n">method_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">INVENTORY_METHODS</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getframeinfo</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span><span class="o">.</span><span class="n">filename</span>

        <span class="n">param_names</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargvalues</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
        <span class="n">lineno</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getframeinfo</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span><span class="o">.</span><span class="n">lineno</span>
        <span class="n">local_vars</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargvalues</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span><span class="o">.</span><span class="n">locals</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="n">param_names</span><span class="p">,</span> <span class="n">local_vars</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">traceit</span>
</pre></div>
</div>
</div>
</div>
<p>We run the code under trace context.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Tracer</span><span class="p">()</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">process_vehicle</span><span class="p">(</span><span class="n">VEHICLES</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>call Parser.ipynb 29 process_vehicle [&#39;vehicle&#39;] {&#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;}
line Parser.ipynb 30 process_vehicle [&#39;vehicle&#39;] {&#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;}
line Parser.ipynb 31 process_vehicle [&#39;vehicle&#39;] {&#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;, &#39;year&#39;: &#39;1997&#39;, &#39;kind&#39;: &#39;van&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;, &#39;_&#39;: []}
line Parser.ipynb 32 process_vehicle [&#39;vehicle&#39;] {&#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;, &#39;year&#39;: &#39;1997&#39;, &#39;kind&#39;: &#39;van&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;, &#39;_&#39;: []}
call Parser.ipynb 40 process_van [&#39;year&#39;, &#39;company&#39;, &#39;model&#39;] {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;}
line Parser.ipynb 40 process_van [&#39;year&#39;, &#39;company&#39;, &#39;model&#39;] {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;}
line Parser.ipynb 41 process_van [&#39;year&#39;, &#39;company&#39;, &#39;model&#39;] {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;}
line Parser.ipynb 42 process_van [&#39;year&#39;, &#39;company&#39;, &#39;model&#39;] {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;, &#39;res&#39;: [&#39;We have a Ford E350 van from 1997 vintage.&#39;]}
line Parser.ipynb 43 process_van [&#39;year&#39;, &#39;company&#39;, &#39;model&#39;] {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;, &#39;res&#39;: [&#39;We have a Ford E350 van from 1997 vintage.&#39;], &#39;iyear&#39;: 1997}
line Parser.ipynb 46 process_van [&#39;year&#39;, &#39;company&#39;, &#39;model&#39;] {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;, &#39;res&#39;: [&#39;We have a Ford E350 van from 1997 vintage.&#39;], &#39;iyear&#39;: 1997}
line Parser.ipynb 47 process_van [&#39;year&#39;, &#39;company&#39;, &#39;model&#39;] {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;, &#39;res&#39;: [&#39;We have a Ford E350 van from 1997 vintage.&#39;, &#39;It is an old but reliable model!&#39;], &#39;iyear&#39;: 1997}
return Parser.ipynb 47 process_van [&#39;year&#39;, &#39;company&#39;, &#39;model&#39;] {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;, &#39;res&#39;: [&#39;We have a Ford E350 van from 1997 vintage.&#39;, &#39;It is an old but reliable model!&#39;], &#39;iyear&#39;: 1997}
return Parser.ipynb 32 process_vehicle [&#39;vehicle&#39;] {&#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;, &#39;year&#39;: &#39;1997&#39;, &#39;kind&#39;: &#39;van&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;, &#39;_&#39;: []}
</pre></div>
</div>
</div>
</div>
<p>The main thing that we want out of tracing is a list of assignments of input fragments to different variables. We can use the tracing facility <code class="docutils literal notranslate"><span class="pre">settrace()</span></code> to get that as we showed above.</p>
<p>However, the <code class="docutils literal notranslate"><span class="pre">settrace()</span></code> function hooks into the Python debugging facility. When it is in operation, no debugger can hook into the program. That is, if there is a problem with our grammar miner, we will not be able to attach a debugger to it to understand what is happening. This is not ideal. Hence, we limit the tracer to the simplest implementation possible, and implement the core of grammar mining in later stages.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">traceit()</span></code> function relies on information from the <code class="docutils literal notranslate"><span class="pre">frame</span></code> variable which exposes Python internals. We define a <code class="docutils literal notranslate"><span class="pre">context</span></code> class that encapsulates the information that we need from the <code class="docutils literal notranslate"><span class="pre">frame</span></code>.</p>
</section>
<section id="context">
<h3>Context<a class="headerlink" href="#context" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Context</span></code> class provides easy access to the information such as the current module, and parameter names.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Context</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">track_caller</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getframeinfo</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span><span class="o">.</span><span class="n">function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_names</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargvalues</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getframeinfo</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span><span class="o">.</span><span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_no</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getframeinfo</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span><span class="o">.</span><span class="n">lineno</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_t</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_no</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameter_names</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%d</span><span class="s2">:</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Here we add a few convenience methods that operate on the <code class="docutils literal notranslate"><span class="pre">frame</span></code> to <code class="docutils literal notranslate"><span class="pre">Context</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Context</span><span class="p">(</span><span class="n">Context</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargvalues</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span><span class="o">.</span><span class="n">locals</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_vars</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">all_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_names</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">qualified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_vars</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">all_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</pre></div>
</div>
</div>
</div>
<p>We hook printing the context to our <code class="docutils literal notranslate"><span class="pre">traceit()</span></code> to see it in action. First we define a <code class="docutils literal notranslate"><span class="pre">log_event()</span></code> for displaying events.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">log_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">({</span><span class="s1">&#39;call&#39;</span><span class="p">:</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;-&#39;</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="p">),</span> <span class="n">var</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And use the <code class="docutils literal notranslate"><span class="pre">log_event()</span></code> in the <code class="docutils literal notranslate"><span class="pre">traceit()</span></code> function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Tracer</span><span class="p">(</span><span class="n">Tracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">traceit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="n">log_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">Context</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">traceit</span>
</pre></div>
</div>
</div>
</div>
<p>Running <code class="docutils literal notranslate"><span class="pre">process_vehicle()</span></code> under trace prints the contexts encountered.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Tracer</span><span class="p">()</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">process_vehicle</span><span class="p">(</span><span class="n">VEHICLES</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-&gt; Parser.ipynb:29:process_vehicle(vehicle)
   Parser.ipynb:30:process_vehicle(vehicle)
   Parser.ipynb:31:process_vehicle(vehicle)
   Parser.ipynb:32:process_vehicle(vehicle)
-&gt; Parser.ipynb:40:process_van(year,company,model)
   Parser.ipynb:40:process_van(year,company,model)
   Parser.ipynb:41:process_van(year,company,model)
   Parser.ipynb:42:process_van(year,company,model)
   Parser.ipynb:43:process_van(year,company,model)
   Parser.ipynb:46:process_van(year,company,model)
   Parser.ipynb:47:process_van(year,company,model)
&lt;- Parser.ipynb:47:process_van(year,company,model)
&lt;- Parser.ipynb:32:process_vehicle(vehicle)
-&gt; Coverage.ipynb:102:__exit__(self,exc_type,exc_value,tb)
   Coverage.ipynb:105:__exit__(self,exc_type,exc_value,tb)
</pre></div>
</div>
</div>
</div>
<p>The trace produced by executing any function can get overwhelmingly large. Hence, we need to restrict our attention to specific modules. Further, we also restrict our attention exclusively to <code class="docutils literal notranslate"><span class="pre">str</span></code> variables since these variables are more likely to contain input fragments. (We will show how to deal with complex objects later in exercises.)</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Context</span></code> class we developed earlier is used to decide which modules to monitor, and which variables to trace.</p>
<p>We store the current <em>input string</em> so that it can be used to determine if any particular string fragments came from the current input string. Any optional arguments are processed separately.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Tracer</span><span class="p">(</span><span class="n">Tracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">my_input</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="n">my_input</span><span class="p">,</span> <span class="p">[]</span>
</pre></div>
</div>
</div>
</div>
<p>We use an optional argument <code class="docutils literal notranslate"><span class="pre">files</span></code> to indicate the specific source files we are interested in, and <code class="docutils literal notranslate"><span class="pre">methods</span></code> to indicate which specific methods are of interest. Further, we also use <code class="docutils literal notranslate"><span class="pre">log</span></code> to specify whether verbose logging should be enabled during trace. We use the <code class="docutils literal notranslate"><span class="pre">log_event()</span></code> method we defined earlier for logging.</p>
<p>The options processing is as below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Tracer</span><span class="p">(</span><span class="n">Tracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;files&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methods</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;methods&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log_event</span> <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="k">lambda</span> <span class="n">_evt</span><span class="p">,</span> <span class="n">_var</span><span class="p">:</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">files</span></code> and <code class="docutils literal notranslate"><span class="pre">methods</span></code> are checked to determine, if a particular event should be traced or not</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Tracer</span><span class="p">(</span><span class="n">Tracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tracing_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cxt</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="n">fres</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">cxt</span><span class="o">.</span><span class="n">file_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>
        <span class="n">mres</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">methods</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">cxt</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fres</span> <span class="ow">and</span> <span class="n">mres</span>
</pre></div>
</div>
</div>
</div>
<p>Similar to the context of events, we also want to restrict our attention to specific variables. For now, we want to focus only on strings. (See the Exercises at the end of the chapter on how to extend it to other kinds of objects).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Tracer</span><span class="p">(</span><span class="n">Tracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tracing_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We modify the <code class="docutils literal notranslate"><span class="pre">traceit()</span></code> to call an <code class="docutils literal notranslate"><span class="pre">on_event()</span></code> function with the context information only on the specific events we are interested in.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Tracer</span><span class="p">(</span><span class="n">Tracer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">cxt</span><span class="p">,</span> <span class="n">my_vars</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">cxt</span><span class="p">,</span> <span class="n">my_vars</span><span class="p">))</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">create_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Context</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">traceit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="n">cxt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_context</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracing_context</span><span class="p">(</span><span class="n">cxt</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">traceit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">cxt</span><span class="p">)</span>

        <span class="n">my_vars</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cxt</span><span class="o">.</span><span class="n">extract_vars</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracing_var</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">cxt</span><span class="p">,</span> <span class="n">my_vars</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">traceit</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Tracer</span></code> class can now focus on specific kinds of events on specific files. Further, it provides a first level filter for variables that we find interesting. For example, we want to focus specifically on variables from <code class="docutils literal notranslate"><span class="pre">process_*</span></code> methods that contain input fragments. Here is how our updated <code class="docutils literal notranslate"><span class="pre">Tracer</span></code> can be used.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Tracer</span><span class="p">(</span><span class="n">VEHICLES</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">methods</span><span class="o">=</span><span class="n">INVENTORY_METHODS</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">process_vehicle</span><span class="p">(</span><span class="n">VEHICLES</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-&gt; Parser.ipynb:29:process_vehicle(vehicle)
   Parser.ipynb:30:process_vehicle(vehicle)
   Parser.ipynb:31:process_vehicle(vehicle)
   Parser.ipynb:32:process_vehicle(vehicle)
-&gt; Parser.ipynb:40:process_van(year,company,model)
   Parser.ipynb:40:process_van(year,company,model)
   Parser.ipynb:41:process_van(year,company,model)
   Parser.ipynb:42:process_van(year,company,model)
   Parser.ipynb:43:process_van(year,company,model)
   Parser.ipynb:46:process_van(year,company,model)
   Parser.ipynb:47:process_van(year,company,model)
&lt;- Parser.ipynb:47:process_van(year,company,model)
&lt;- Parser.ipynb:32:process_vehicle(vehicle)
</pre></div>
</div>
</div>
</div>
<p>The execution produced the following trace.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tracer</span><span class="o">.</span><span class="n">trace</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>call process_vehicle {&#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;}
line process_vehicle {&#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;}
line process_vehicle {&#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;, &#39;year&#39;: &#39;1997&#39;, &#39;kind&#39;: &#39;van&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;}
line process_vehicle {&#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;, &#39;year&#39;: &#39;1997&#39;, &#39;kind&#39;: &#39;van&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;}
call process_van {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;}
line process_van {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;}
line process_van {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;}
line process_van {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;}
line process_van {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;}
line process_van {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;}
line process_van {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;}
return process_van {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;}
return process_vehicle {&#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;, &#39;year&#39;: &#39;1997&#39;, &#39;kind&#39;: &#39;van&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;}
</pre></div>
</div>
</div>
</div>
<p>Since we are saving the input already in <code class="docutils literal notranslate"><span class="pre">Tracer</span></code>, it is redundant to specify it separately again as an argument.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Tracer</span><span class="p">(</span><span class="n">VEHICLES</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">methods</span><span class="o">=</span><span class="n">INVENTORY_METHODS</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">process_vehicle</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-&gt; Parser.ipynb:29:process_vehicle(vehicle)
   Parser.ipynb:30:process_vehicle(vehicle)
   Parser.ipynb:31:process_vehicle(vehicle)
   Parser.ipynb:32:process_vehicle(vehicle)
-&gt; Parser.ipynb:40:process_van(year,company,model)
   Parser.ipynb:40:process_van(year,company,model)
   Parser.ipynb:41:process_van(year,company,model)
   Parser.ipynb:42:process_van(year,company,model)
   Parser.ipynb:43:process_van(year,company,model)
   Parser.ipynb:46:process_van(year,company,model)
   Parser.ipynb:47:process_van(year,company,model)
&lt;- Parser.ipynb:47:process_van(year,company,model)
&lt;- Parser.ipynb:32:process_vehicle(vehicle)
</pre></div>
</div>
</div>
</div>
</section>
<section id="definetracker">
<h3>DefineTracker<a class="headerlink" href="#definetracker" title="Link to this heading">#</a></h3>
<p>We define a <code class="docutils literal notranslate"><span class="pre">DefineTracker</span></code> class that processes the trace from the <code class="docutils literal notranslate"><span class="pre">Tracer</span></code>. The idea is to store different variable definitions which are input fragments.</p>
<p>The tracker identifies string fragments that are part of the input string, and stores them in a dictionary <code class="docutils literal notranslate"><span class="pre">my_assignments</span></code>. It saves the trace, and the corresponding input for processing. Finally, it calls <code class="docutils literal notranslate"><span class="pre">process()</span></code> to process the <code class="docutils literal notranslate"><span class="pre">trace</span></code> it was given. We will start with a simple tracker that relies on certain assumptions, and later see how these assumptions can be relaxed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DefineTracker</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">my_input</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_input</span> <span class="o">=</span> <span class="n">my_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="n">trace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_assignments</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>One of the problems of using substring search is that short string sequences tend to be included in other string sequences even though they may not have come from the original string. That is, say the input fragment is <code class="docutils literal notranslate"><span class="pre">v</span></code>, it could have equally come from either <code class="docutils literal notranslate"><span class="pre">van</span></code> or <code class="docutils literal notranslate"><span class="pre">chevy</span></code>. We rely on being able to predict the exact place in the input where a given fragment occurred. Hence, we define a constant <code class="docutils literal notranslate"><span class="pre">FRAGMENT_LEN</span></code> such that we ignore strings up to that length. We also incorporate a logging facility as before.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">FRAGMENT_LEN</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DefineTracker</span><span class="p">(</span><span class="n">DefineTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log_event</span> <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="k">lambda</span> <span class="n">_evt</span><span class="p">,</span> <span class="n">_var</span><span class="p">:</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fragment_len</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fragment_len&#39;</span><span class="p">,</span> <span class="n">FRAGMENT_LEN</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Our tracer simply records the variable values as they occur. We next need to check if the variables contain values from the <strong>input string</strong>. Common ways to do this is to rely on symbolic execution or at least dynamic tainting, which are powerful, but also complex. However, one can obtain a reasonable approximation by simply relying on substring search. That is, we consider any value produced that is a substring of the original input string to have come from the original input.</p>
<p>We define an <code class="docutils literal notranslate"><span class="pre">is_input_fragment()</span></code> method that relies on string inclusion to detect if the string came from the input.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DefineTracker</span><span class="p">(</span><span class="n">DefineTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_input_fragment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_len</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_input</span>
</pre></div>
</div>
</div>
</div>
<p>We can use <code class="docutils literal notranslate"><span class="pre">is_input_fragment()</span></code> to select only a subset of variables defined, as implemented below in <code class="docutils literal notranslate"><span class="pre">fragments()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DefineTracker</span><span class="p">(</span><span class="n">DefineTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fragments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">(</span>
        <span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_input_fragment</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)}</span>
</pre></div>
</div>
</div>
</div>
<p>The tracker processes each event, and at each event, it updates the dictionary <code class="docutils literal notranslate"><span class="pre">my_assignments</span></code> with the current local variables that contain strings that are part of the input. Note that there is a choice here with respect to what happens during reassignment. We can either discard all the reassignments, or keep only the last assignment. Here, we choose the latter. If you want the former behavior, check whether the value exists in <code class="docutils literal notranslate"><span class="pre">my_assignments</span></code> before storing a fragment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DefineTracker</span><span class="p">(</span><span class="n">DefineTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">track_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">cxt</span><span class="p">,</span> <span class="n">my_vars</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="p">(</span><span class="n">cxt</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">my_vars</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_assignments</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">(</span><span class="n">my_vars</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">cxt</span><span class="p">,</span> <span class="n">my_vars</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">track_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">cxt</span><span class="p">,</span> <span class="n">my_vars</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Using the tracker, we can obtain the input fragments. For example, say we are only interested in strings that are at least <code class="docutils literal notranslate"><span class="pre">5</span></code> characters long.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tracker</span> <span class="o">=</span> <span class="n">DefineTracker</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="n">tracer</span><span class="o">.</span><span class="n">trace</span><span class="p">,</span> <span class="n">fragment_len</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tracker</span><span class="o">.</span><span class="n">my_assignments</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>vehicle = &#39;1997,van,Ford,E350&#39;
</pre></div>
</div>
</div>
</div>
<p>Or strings that are <code class="docutils literal notranslate"><span class="pre">2</span></code> characters long (the default).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tracker</span> <span class="o">=</span> <span class="n">DefineTracker</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="n">tracer</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tracker</span><span class="o">.</span><span class="n">my_assignments</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>vehicle = &#39;1997,van,Ford,E350&#39;
year = &#39;1997&#39;
kind = &#39;van&#39;
company = &#39;Ford&#39;
model = &#39;E350&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DefineTracker</span><span class="p">(</span><span class="n">DefineTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">assignments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_assignments</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="assembling-a-derivation-tree">
<h3>Assembling a Derivation Tree<a class="headerlink" href="#assembling-a-derivation-tree" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">Grammars</span><span class="w"> </span><span class="kn">import</span> <span class="n">START_SYMBOL</span><span class="p">,</span> <span class="n">syntax_diagram</span><span class="p">,</span> \
    <span class="n">is_nonterminal</span><span class="p">,</span> <span class="n">Grammar</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">GrammarFuzzer</span><span class="w"> </span><span class="kn">import</span> <span class="n">GrammarFuzzer</span><span class="p">,</span> <span class="n">display_tree</span><span class="p">,</span> \
    <span class="n">DerivationTree</span>
</pre></div>
</div>
</div>
</div>
<p>The input fragments from the <code class="docutils literal notranslate"><span class="pre">DefineTracker</span></code> only tell half the story. The fragments may be created at different stages of parsing. Hence, we need to assemble the fragments to a  derivation tree of the input. The basic idea is as follows:</p>
<p>Our input from the previous step was:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;1997,van,Ford,E350&quot;</span>
</pre></div>
</div>
<p>We start a derivation tree, and associate it with the start symbol in the grammar.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">derivation_tree</span><span class="p">:</span> <span class="n">DerivationTree</span> <span class="o">=</span> <span class="p">(</span><span class="n">START_SYMBOL</span><span class="p">,</span> <span class="p">[(</span><span class="s2">&quot;1997,van,Ford,E350&quot;</span><span class="p">,</span> <span class="p">[])])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/9de6fb5b75c21c05c76ce47a7b0879ebee0c387e86d4463936e2e40b5e280a7b.svg" src="_images/9de6fb5b75c21c05c76ce47a7b0879ebee0c387e86d4463936e2e40b5e280a7b.svg" />
</div>
</div>
<p>The next input was:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">vehicle</span> <span class="o">=</span> <span class="s2">&quot;1997,van,Ford,E350&quot;</span>
</pre></div>
</div>
<p>Since vehicle covers the <code class="docutils literal notranslate"><span class="pre">&lt;start&gt;</span></code> node’s value completely, we replace the value with the vehicle node.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">derivation_tree</span><span class="p">:</span> <span class="n">DerivationTree</span> <span class="o">=</span> <span class="p">(</span><span class="n">START_SYMBOL</span><span class="p">,</span> 
                                   <span class="p">[(</span><span class="s1">&#39;&lt;vehicle&gt;&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s2">&quot;1997,van,Ford,E350&quot;</span><span class="p">,</span> <span class="p">[])],</span>
                                                   <span class="p">[])])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/88fd498e9339015d88539fe2dbd468829a675a61bc43babfe40aebe978fd1fdd.svg" src="_images/88fd498e9339015d88539fe2dbd468829a675a61bc43babfe40aebe978fd1fdd.svg" />
</div>
</div>
<p>The next input was:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">year</span> <span class="o">=</span> <span class="s1">&#39;1997&#39;</span>
</pre></div>
</div>
<p>Traversing the derivation tree from <code class="docutils literal notranslate"><span class="pre">&lt;start&gt;</span></code>, we see that it replaces a portion of the <code class="docutils literal notranslate"><span class="pre">&lt;vehicle&gt;</span></code> node’s value. Hence we split the <code class="docutils literal notranslate"><span class="pre">&lt;vehicle&gt;</span></code> node’s value to two children, where one corresponds to the value <code class="docutils literal notranslate"><span class="pre">&quot;1997&quot;</span></code> and the other to <code class="docutils literal notranslate"><span class="pre">&quot;,van,Ford,E350&quot;</span></code>, and replace the first one with the node <code class="docutils literal notranslate"><span class="pre">&lt;year&gt;</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">derivation_tree</span><span class="p">:</span> <span class="n">DerivationTree</span> <span class="o">=</span> <span class="p">(</span><span class="n">START_SYMBOL</span><span class="p">,</span> 
                                   <span class="p">[(</span><span class="s1">&#39;&lt;vehicle&gt;&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;&lt;year&gt;&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;1997&#39;</span><span class="p">,</span> <span class="p">[])]),</span>
                                                   <span class="p">(</span><span class="s2">&quot;,van,Ford,E350&quot;</span><span class="p">,</span> <span class="p">[])],</span> <span class="p">[])])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/8b8ce67d11a12232020ce3cb05b2559ec34a31cac1c4dadfc89bd02568b786ea.svg" src="_images/8b8ce67d11a12232020ce3cb05b2559ec34a31cac1c4dadfc89bd02568b786ea.svg" />
</div>
</div>
<p>We perform similar operations for</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">company</span> <span class="o">=</span> <span class="s1">&#39;Ford&#39;</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">derivation_tree</span><span class="p">:</span> <span class="n">DerivationTree</span> <span class="o">=</span> <span class="p">(</span><span class="n">START_SYMBOL</span><span class="p">,</span> 
                                   <span class="p">[(</span><span class="s1">&#39;&lt;vehicle&gt;&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;&lt;year&gt;&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;1997&#39;</span><span class="p">,</span> <span class="p">[])]),</span>
                                                   <span class="p">(</span><span class="s2">&quot;,van,&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                                                   <span class="p">(</span><span class="s1">&#39;&lt;company&gt;&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;Ford&#39;</span><span class="p">,</span> <span class="p">[])]),</span>
                                                   <span class="p">(</span><span class="s2">&quot;,E350&quot;</span><span class="p">,</span> <span class="p">[])],</span> <span class="p">[])])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/e391c9f9eebba526ff1979289ec9b9ddf15d5838fd66027ed400e12eb7823de6.svg" src="_images/e391c9f9eebba526ff1979289ec9b9ddf15d5838fd66027ed400e12eb7823de6.svg" />
</div>
</div>
<p>Similarly for</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">kind</span> <span class="o">=</span> <span class="s1">&#39;van&#39;</span>
</pre></div>
</div>
<p>and</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s1">&#39;E350&#39;</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">derivation_tree</span><span class="p">:</span> <span class="n">DerivationTree</span> <span class="o">=</span> <span class="p">(</span><span class="n">START_SYMBOL</span><span class="p">,</span> 
                                   <span class="p">[(</span><span class="s1">&#39;&lt;vehicle&gt;&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;&lt;year&gt;&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;1997&#39;</span><span class="p">,</span> <span class="p">[])]),</span>
                                                   <span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                                                   <span class="p">(</span><span class="s2">&quot;&lt;kind&gt;&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;van&#39;</span><span class="p">,</span> <span class="p">[])]),</span>
                                                   <span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                                                   <span class="p">(</span><span class="s1">&#39;&lt;company&gt;&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;Ford&#39;</span><span class="p">,</span> <span class="p">[])]),</span>
                                                   <span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                                                   <span class="p">(</span><span class="s2">&quot;&lt;model&gt;&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;E350&#39;</span><span class="p">,</span> <span class="p">[])])</span>
                                                   <span class="p">],</span> <span class="p">[])])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/cde9d85100444427a1a783d6c0fe47647c00673ed98e12654e167fd4446d6f4f.svg" src="_images/cde9d85100444427a1a783d6c0fe47647c00673ed98e12654e167fd4446d6f4f.svg" />
</div>
</div>
<p>We now develop the complete algorithm with the above described steps.
The derivation tree <code class="docutils literal notranslate"><span class="pre">TreeMiner</span></code> is initialized with the input string, and the variable assignments, and it converts the assignments to the corresponding derivation tree.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TreeMiner</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">my_input</span><span class="p">,</span> <span class="n">my_assignments</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_input</span> <span class="o">=</span> <span class="n">my_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_assignments</span> <span class="o">=</span> <span class="n">my_assignments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_derivation_tree</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log_call</span> <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="k">lambda</span> <span class="n">_i</span><span class="p">,</span> <span class="n">_v</span><span class="p">:</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_derivation_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">START_SYMBOL</span><span class="p">,</span> <span class="p">[])</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">log_call()</span></code> is as follows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">log_call</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="n">indent</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The basic idea is as follows:</p>
<ul class="simple">
<li><p><strong>For now, we assume that the value assigned to a variable is stable. That is, it is never reassigned. In particular, there are no recursive calls, or multiple calls to the same function from different parts.</strong> (We will show how to overcome this limitation later).</p></li>
<li><p>For each pair <em>var</em>, <em>value</em> found in <code class="docutils literal notranslate"><span class="pre">my_assignments</span></code>:</p>
<ol class="arabic simple">
<li><p>We search for occurrences of <em>value</em> <code class="docutils literal notranslate"><span class="pre">val</span></code> in the derivation tree recursively.</p></li>
<li><p>If an occurrence was found as a value <code class="docutils literal notranslate"><span class="pre">V1</span></code> of a node <code class="docutils literal notranslate"><span class="pre">P1</span></code>, we partition the value of the node <code class="docutils literal notranslate"><span class="pre">P1</span></code> into three parts, with the central part matching the <em>value</em> <code class="docutils literal notranslate"><span class="pre">val</span></code>, and the first and last part, the corresponding prefix and suffix in <code class="docutils literal notranslate"><span class="pre">V1</span></code>.</p></li>
<li><p>Reconstitute the node <code class="docutils literal notranslate"><span class="pre">P1</span></code> with three children, where prefix and suffix mentioned earlier are string values, and the matching value <code class="docutils literal notranslate"><span class="pre">val</span></code> is replaced by a node <code class="docutils literal notranslate"><span class="pre">var</span></code> with a single value <code class="docutils literal notranslate"><span class="pre">val</span></code>.</p></li>
</ol>
</li>
</ul>
<p>First, we define a wrapper to generate a nonterminal from a variable name.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">to_nonterminal</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="n">var</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">string_part_of_value()</span></code> method checks whether the given <code class="docutils literal notranslate"><span class="pre">part</span></code> value was part of the whole.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TreeMiner</span><span class="p">(</span><span class="n">TreeMiner</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">string_part_of_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">part</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">part</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">partition_by_part()</span></code> splits the <code class="docutils literal notranslate"><span class="pre">value</span></code> by the given part if it matches, and returns a list containing the first part, the part that was replaced, and the last part. This is a format that can be used as a part of the list of children.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TreeMiner</span><span class="p">(</span><span class="n">TreeMiner</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">partition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">part</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TreeMiner</span><span class="p">(</span><span class="n">TreeMiner</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">partition_by_part</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">part</span> <span class="o">=</span> <span class="n">pair</span>
        <span class="n">prefix_k_suffix</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">[[</span><span class="n">part</span><span class="p">,</span> <span class="p">[]]])</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">e</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">prefix_k_suffix</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">insert_into_tree()</span></code> method accepts a given tree <code class="docutils literal notranslate"><span class="pre">tree</span></code> and a <code class="docutils literal notranslate"><span class="pre">(k,v)</span></code> pair.  It recursively checks whether the given pair can be applied. If the pair can be applied, it applies the pair and returns <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TreeMiner</span><span class="p">(</span><span class="n">TreeMiner</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">insert_into_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">my_tree</span><span class="p">,</span> <span class="n">pair</span><span class="p">):</span>
        <span class="n">var</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">my_tree</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">pair</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;- Node: </span><span class="si">%s</span><span class="se">\t\t</span><span class="s2">? (</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
        <span class="n">applied</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
            <span class="n">value</span><span class="p">,</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">value_</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;-&gt; [</span><span class="si">%d</span><span class="s2">] </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">is_nonterminal</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="n">applied</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_into_tree</span><span class="p">(</span><span class="n">value_</span><span class="p">,</span> <span class="n">pair</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">applied</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">string_part_of_value</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                <span class="n">prefix_k_suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition_by_part</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">rep</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prefix_k_suffix</span><span class="p">):</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">rep</span><span class="p">)</span>
                <span class="n">applied</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot; &gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prefix_k_suffix</span><span class="p">])))</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="n">applied</span>
</pre></div>
</div>
</div>
</div>
<p>Here is how <code class="docutils literal notranslate"><span class="pre">insert_into_tree()</span></code> is used.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tree</span><span class="p">:</span> <span class="n">DerivationTree</span> <span class="o">=</span> <span class="p">(</span><span class="n">START_SYMBOL</span><span class="p">,</span> <span class="p">[(</span><span class="s2">&quot;1997,van,Ford,E350&quot;</span><span class="p">,</span> <span class="p">[])])</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">TreeMiner</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>First, we have our input string as the only node.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/9de6fb5b75c21c05c76ce47a7b0879ebee0c387e86d4463936e2e40b5e280a7b.svg" src="_images/9de6fb5b75c21c05c76ce47a7b0879ebee0c387e86d4463936e2e40b5e280a7b.svg" />
</div>
</div>
<p>Inserting the <code class="docutils literal notranslate"><span class="pre">&lt;vehicle&gt;</span></code> node.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">v</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">insert_into_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;&lt;vehicle&gt;&#39;</span><span class="p">,</span> <span class="s2">&quot;1997,van,Ford,E350&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>	 - Node: &lt;start&gt;		? (&lt;vehicle&gt;:&#39;1997,van,Ford,E350&#39;)
		 -&gt; [0] &#39;1997,van,Ford,E350&#39;
		  &gt; [&#39;&lt;vehicle&gt;&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/88fd498e9339015d88539fe2dbd468829a675a61bc43babfe40aebe978fd1fdd.svg" src="_images/88fd498e9339015d88539fe2dbd468829a675a61bc43babfe40aebe978fd1fdd.svg" />
</div>
</div>
<p>Inserting <code class="docutils literal notranslate"><span class="pre">&lt;model&gt;</span></code> node.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">v</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">insert_into_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;&lt;model&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;E350&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>	 - Node: &lt;start&gt;		? (&lt;model&gt;:&#39;E350&#39;)
		 -&gt; [0] &#39;&lt;vehicle&gt;&#39;
	 - Node: &lt;vehicle&gt;		? (&lt;model&gt;:&#39;E350&#39;)
		 -&gt; [0] &#39;1997,van,Ford,E350&#39;
		  &gt; [&#39;1997,van,Ford,&#39;, &#39;&lt;model&gt;&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/935aa9f1f83980de696c56bdaa957c1a513c6170a625b74fccdeb11932cb2d10.svg" src="_images/935aa9f1f83980de696c56bdaa957c1a513c6170a625b74fccdeb11932cb2d10.svg" />
</div>
</div>
<p>Inserting <code class="docutils literal notranslate"><span class="pre">&lt;company&gt;</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">v</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">insert_into_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;&lt;company&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;Ford&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>	 - Node: &lt;start&gt;		? (&lt;company&gt;:&#39;Ford&#39;)
		 -&gt; [0] &#39;&lt;vehicle&gt;&#39;
	 - Node: &lt;vehicle&gt;		? (&lt;company&gt;:&#39;Ford&#39;)
		 -&gt; [0] &#39;1997,van,Ford,&#39;
		  &gt; [&#39;1997,van,&#39;, &#39;&lt;company&gt;&#39;, &#39;,&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/e2ba5daa84122727353a6637bc6ce7ae688a3d214aae569b1dc8a49c2e770101.svg" src="_images/e2ba5daa84122727353a6637bc6ce7ae688a3d214aae569b1dc8a49c2e770101.svg" />
</div>
</div>
<p>Inserting <code class="docutils literal notranslate"><span class="pre">&lt;kind&gt;</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">v</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">insert_into_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;&lt;kind&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;van&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>	 - Node: &lt;start&gt;		? (&lt;kind&gt;:&#39;van&#39;)
		 -&gt; [0] &#39;&lt;vehicle&gt;&#39;
	 - Node: &lt;vehicle&gt;		? (&lt;kind&gt;:&#39;van&#39;)
		 -&gt; [0] &#39;1997,van,&#39;
		  &gt; [&#39;1997,&#39;, &#39;&lt;kind&gt;&#39;, &#39;,&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/3cd7e44831e5309be46ab18bb805e938d480a11bdd9c17cd20de0803f19ced49.svg" src="_images/3cd7e44831e5309be46ab18bb805e938d480a11bdd9c17cd20de0803f19ced49.svg" />
</div>
</div>
<p>Inserting <code class="docutils literal notranslate"><span class="pre">&lt;year&gt;</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">v</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">insert_into_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;&lt;year&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;1997&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>	 - Node: &lt;start&gt;		? (&lt;year&gt;:&#39;1997&#39;)
		 -&gt; [0] &#39;&lt;vehicle&gt;&#39;
	 - Node: &lt;vehicle&gt;		? (&lt;year&gt;:&#39;1997&#39;)
		 -&gt; [0] &#39;1997,&#39;
		  &gt; [&#39;&lt;year&gt;&#39;, &#39;,&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/cde9d85100444427a1a783d6c0fe47647c00673ed98e12654e167fd4446d6f4f.svg" src="_images/cde9d85100444427a1a783d6c0fe47647c00673ed98e12654e167fd4446d6f4f.svg" />
</div>
</div>
<p>To make life simple, we define a wrapper function <code class="docutils literal notranslate"><span class="pre">nt_var()</span></code> that will convert a token to its corresponding nonterminal symbol.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TreeMiner</span><span class="p">(</span><span class="n">TreeMiner</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nt_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">var</span> <span class="k">if</span> <span class="n">is_nonterminal</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="k">else</span> <span class="n">to_nonterminal</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, we need to apply a new definition to an entire grammar.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TreeMiner</span><span class="p">(</span><span class="n">TreeMiner</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_new_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">nt_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nt_var</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_into_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="p">(</span><span class="n">nt_var</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>This algorithm is implemented as <code class="docutils literal notranslate"><span class="pre">get_derivation_tree()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TreeMiner</span><span class="p">(</span><span class="n">TreeMiner</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_derivation_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="p">(</span><span class="n">START_SYMBOL</span><span class="p">,</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="p">[])])</span>

        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_assignments</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_new_definition</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tree</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">TreeMiner</span></code> is used as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Tracer</span><span class="p">(</span><span class="n">VEHICLES</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">process_vehicle</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">)</span>
<span class="n">assignments</span> <span class="o">=</span> <span class="n">DefineTracker</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="n">tracer</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span><span class="o">.</span><span class="n">assignments</span><span class="p">()</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">TreeMiner</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="n">assignments</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">dt</span><span class="o">.</span><span class="n">tree</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> vehicle=&#39;1997,van,Ford,E350&#39;
	 - Node: &lt;start&gt;		? (&lt;vehicle&gt;:&#39;1997,van,Ford,E350&#39;)
		 -&gt; [0] &#39;1997,van,Ford,E350&#39;
		  &gt; [&#39;&lt;vehicle&gt;&#39;]
 year=&#39;1997&#39;
	 - Node: &lt;start&gt;		? (&lt;year&gt;:&#39;1997&#39;)
		 -&gt; [0] &#39;&lt;vehicle&gt;&#39;
	 - Node: &lt;vehicle&gt;		? (&lt;year&gt;:&#39;1997&#39;)
		 -&gt; [0] &#39;1997,van,Ford,E350&#39;
		  &gt; [&#39;&lt;year&gt;&#39;, &#39;,van,Ford,E350&#39;]
 kind=&#39;van&#39;
	 - Node: &lt;start&gt;		? (&lt;kind&gt;:&#39;van&#39;)
		 -&gt; [0] &#39;&lt;vehicle&gt;&#39;
	 - Node: &lt;vehicle&gt;		? (&lt;kind&gt;:&#39;van&#39;)
		 -&gt; [0] &#39;&lt;year&gt;&#39;
	 - Node: &lt;year&gt;		? (&lt;kind&gt;:&#39;van&#39;)
		 -&gt; [0] &#39;1997&#39;
		 -&gt; [1] &#39;,van,Ford,E350&#39;
		  &gt; [&#39;,&#39;, &#39;&lt;kind&gt;&#39;, &#39;,Ford,E350&#39;]
 company=&#39;Ford&#39;
	 - Node: &lt;start&gt;		? (&lt;company&gt;:&#39;Ford&#39;)
		 -&gt; [0] &#39;&lt;vehicle&gt;&#39;
	 - Node: &lt;vehicle&gt;		? (&lt;company&gt;:&#39;Ford&#39;)
		 -&gt; [0] &#39;&lt;year&gt;&#39;
	 - Node: &lt;year&gt;		? (&lt;company&gt;:&#39;Ford&#39;)
		 -&gt; [0] &#39;1997&#39;
		 -&gt; [1] &#39;,&#39;
		 -&gt; [2] &#39;&lt;kind&gt;&#39;
	 - Node: &lt;kind&gt;		? (&lt;company&gt;:&#39;Ford&#39;)
		 -&gt; [0] &#39;van&#39;
		 -&gt; [3] &#39;,Ford,E350&#39;
		  &gt; [&#39;,&#39;, &#39;&lt;company&gt;&#39;, &#39;,E350&#39;]
 model=&#39;E350&#39;
	 - Node: &lt;start&gt;		? (&lt;model&gt;:&#39;E350&#39;)
		 -&gt; [0] &#39;&lt;vehicle&gt;&#39;
	 - Node: &lt;vehicle&gt;		? (&lt;model&gt;:&#39;E350&#39;)
		 -&gt; [0] &#39;&lt;year&gt;&#39;
	 - Node: &lt;year&gt;		? (&lt;model&gt;:&#39;E350&#39;)
		 -&gt; [0] &#39;1997&#39;
		 -&gt; [1] &#39;,&#39;
		 -&gt; [2] &#39;&lt;kind&gt;&#39;
	 - Node: &lt;kind&gt;		? (&lt;model&gt;:&#39;E350&#39;)
		 -&gt; [0] &#39;van&#39;
		 -&gt; [3] &#39;,&#39;
		 -&gt; [4] &#39;&lt;company&gt;&#39;
	 - Node: &lt;company&gt;		? (&lt;model&gt;:&#39;E350&#39;)
		 -&gt; [0] &#39;Ford&#39;
		 -&gt; [5] &#39;,E350&#39;
		  &gt; [&#39;,&#39;, &#39;&lt;model&gt;&#39;]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;&lt;start&gt;&#39;,
 [(&#39;&lt;vehicle&gt;&#39;,
   [(&#39;&lt;year&gt;&#39;, [[&#39;1997&#39;, []]]),
    (&#39;,&#39;, []),
    (&#39;&lt;kind&gt;&#39;, [[&#39;van&#39;, []]]),
    (&#39;,&#39;, []),
    (&#39;&lt;company&gt;&#39;, [[&#39;Ford&#39;, []]]),
    (&#39;,&#39;, []),
    (&#39;&lt;model&gt;&#39;, [[&#39;E350&#39;, []]])])])
</pre></div>
</div>
</div>
</div>
<p>The obtained derivation tree is as below.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/cde9d85100444427a1a783d6c0fe47647c00673ed98e12654e167fd4446d6f4f.svg" src="_images/cde9d85100444427a1a783d6c0fe47647c00673ed98e12654e167fd4446d6f4f.svg" />
</div>
</div>
<p>Combining all the pieces:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trees</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="n">VEHICLES</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">vehicle</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">Tracer</span><span class="p">(</span><span class="n">vehicle</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
        <span class="n">process_vehicle</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">)</span>
    <span class="n">assignments</span> <span class="o">=</span> <span class="n">DefineTracker</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="n">tracer</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span><span class="o">.</span><span class="n">assignments</span><span class="p">()</span>
    <span class="n">trees</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="n">assignments</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">var</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1997,van,Ford,E350
vehicle = &#39;1997,van,Ford,E350&#39;
year = &#39;1997&#39;
kind = &#39;van&#39;
company = &#39;Ford&#39;
model = &#39;E350&#39;

2000,car,Mercury,Cougar
vehicle = &#39;2000,car,Mercury,Cougar&#39;
year = &#39;2000&#39;
kind = &#39;car&#39;
company = &#39;Mercury&#39;
model = &#39;Cougar&#39;

1999,car,Chevy,Venture
vehicle = &#39;1999,car,Chevy,Venture&#39;
year = &#39;1999&#39;
kind = &#39;car&#39;
company = &#39;Chevy&#39;
model = &#39;Venture&#39;
</pre></div>
</div>
</div>
</div>
<p>The corresponding derivation trees are below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">csv_dt</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">inputstr</span><span class="p">,</span> <span class="n">assignments</span> <span class="ow">in</span> <span class="n">trees</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">inputstr</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">TreeMiner</span><span class="p">(</span><span class="n">inputstr</span><span class="p">,</span> <span class="n">assignments</span><span class="p">)</span>
    <span class="n">csv_dt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
    <span class="n">display_tree</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1997,van,Ford,E350
2000,car,Mercury,Cougar
1999,car,Chevy,Venture
</pre></div>
</div>
</div>
</div>
</section>
<section id="recovering-grammars-from-derivation-trees">
<h3>Recovering Grammars from Derivation Trees<a class="headerlink" href="#recovering-grammars-from-derivation-trees" title="Link to this heading">#</a></h3>
<p>We define a class <code class="docutils literal notranslate"><span class="pre">Miner</span></code> that can combine multiple derivation trees to produce the grammar. The initial grammar is empty.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">GrammarMiner</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="o">=</span> <span class="p">{}</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">tree_to_grammar()</span></code> method converts our derivation tree to a grammar by picking one node at a time, and adding it to the grammar. The node name becomes the key, and any list of children it has becomes another alternative for that key.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">GrammarMiner</span><span class="p">(</span><span class="n">GrammarMiner</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tree_to_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="n">tree</span>
        <span class="n">one_alt</span> <span class="o">=</span> <span class="p">[</span><span class="n">ck</span> <span class="k">for</span> <span class="n">ck</span><span class="p">,</span> <span class="n">gc</span> <span class="ow">in</span> <span class="n">children</span><span class="p">]</span>
        <span class="n">hsh</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="p">:</span> <span class="p">[</span><span class="n">one_alt</span><span class="p">]</span> <span class="k">if</span> <span class="n">one_alt</span> <span class="k">else</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_nonterminal</span><span class="p">(</span><span class="n">child</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">continue</span>
            <span class="n">chsh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_to_grammar</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">chsh</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hsh</span><span class="p">:</span>
                    <span class="n">hsh</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">chsh</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">hsh</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">chsh</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">hsh</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gm</span> <span class="o">=</span> <span class="n">GrammarMiner</span><span class="p">()</span>
<span class="n">gm</span><span class="o">.</span><span class="n">tree_to_grammar</span><span class="p">(</span><span class="n">csv_dt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&lt;start&gt;&#39;: [[&#39;&lt;vehicle&gt;&#39;]],
 &#39;&lt;vehicle&gt;&#39;: [[&#39;&lt;year&gt;&#39;, &#39;,&#39;, &#39;&lt;kind&gt;&#39;, &#39;,&#39;, &#39;&lt;company&gt;&#39;, &#39;,&#39;, &#39;&lt;model&gt;&#39;]],
 &#39;&lt;year&gt;&#39;: [[&#39;1997&#39;]],
 &#39;&lt;kind&gt;&#39;: [[&#39;van&#39;]],
 &#39;&lt;company&gt;&#39;: [[&#39;Ford&#39;]],
 &#39;&lt;model&gt;&#39;: [[&#39;E350&#39;]]}
</pre></div>
</div>
</div>
</div>
<p>The grammar being generated here is <code class="docutils literal notranslate"><span class="pre">canonical</span></code>. We define a function <code class="docutils literal notranslate"><span class="pre">readable()</span></code> that takes in a canonical grammar and returns it in a readable form.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">readable</span><span class="p">(</span><span class="n">grammar</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">readable_rule</span><span class="p">(</span><span class="n">rule</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">readable_rule</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">grammar</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">grammar</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">syntax_diagram</span><span class="p">(</span><span class="n">readable</span><span class="p">(</span><span class="n">gm</span><span class="o">.</span><span class="n">tree_to_grammar</span><span class="p">(</span><span class="n">csv_dt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tree</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>start
</pre></div>
</div>
<img alt="_images/8b4e0952ac9e310a9a80c83744f307356e75e307e091472f79ddc5cfbfb5f241.svg" src="_images/8b4e0952ac9e310a9a80c83744f307356e75e307e091472f79ddc5cfbfb5f241.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>vehicle
</pre></div>
</div>
<img alt="_images/6878eb3f53f14ce21556db33834fee8cc472ac2296839b3c0596cf123a18fa81.svg" src="_images/6878eb3f53f14ce21556db33834fee8cc472ac2296839b3c0596cf123a18fa81.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>year
</pre></div>
</div>
<img alt="_images/dd84b034adfbd0fc337e1af20fc5114e420d6f95a9c507ad395dac04b92fb593.svg" src="_images/dd84b034adfbd0fc337e1af20fc5114e420d6f95a9c507ad395dac04b92fb593.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kind
</pre></div>
</div>
<img alt="_images/8a71ae3a44b4ecb1371371a7009b62d79d864fb7e426c63ee92b24bcfa1d0c2b.svg" src="_images/8a71ae3a44b4ecb1371371a7009b62d79d864fb7e426c63ee92b24bcfa1d0c2b.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>company
</pre></div>
</div>
<img alt="_images/5495c5732be2d54f42285617c92f98ec3a794c3e9c1561e09cdb66bdeafcf81d.svg" src="_images/5495c5732be2d54f42285617c92f98ec3a794c3e9c1561e09cdb66bdeafcf81d.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>model
</pre></div>
</div>
<img alt="_images/4e6e3e6686b5cb0d97982922a873431d7f42d5fe7f3cbe62db545eb31b8ab4cb.svg" src="_images/4e6e3e6686b5cb0d97982922a873431d7f42d5fe7f3cbe62db545eb31b8ab4cb.svg" />
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">add_tree()</span></code> method gets a combined list of non-terminals from current grammar, and the tree to be added to the grammar, and updates the definitions of each non-terminal.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">GrammarMiner</span><span class="p">(</span><span class="n">GrammarMiner</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">t_grammar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_to_grammar</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">tree</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> <span class="n">t_grammar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">t_grammar</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">add_tree()</span></code> is used as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inventory_grammar_miner</span> <span class="o">=</span> <span class="n">GrammarMiner</span><span class="p">()</span>
<span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">csv_dt</span><span class="p">:</span>
    <span class="n">inventory_grammar_miner</span><span class="o">.</span><span class="n">add_tree</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">syntax_diagram</span><span class="p">(</span><span class="n">readable</span><span class="p">(</span><span class="n">inventory_grammar_miner</span><span class="o">.</span><span class="n">grammar</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>start
</pre></div>
</div>
<img alt="_images/8b4e0952ac9e310a9a80c83744f307356e75e307e091472f79ddc5cfbfb5f241.svg" src="_images/8b4e0952ac9e310a9a80c83744f307356e75e307e091472f79ddc5cfbfb5f241.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>vehicle
</pre></div>
</div>
<img alt="_images/6878eb3f53f14ce21556db33834fee8cc472ac2296839b3c0596cf123a18fa81.svg" src="_images/6878eb3f53f14ce21556db33834fee8cc472ac2296839b3c0596cf123a18fa81.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>year
</pre></div>
</div>
<img alt="_images/c249ec4ab4606e5b0571d2800d84bacff0a1171a57b7dd77674c8759ef16af57.svg" src="_images/c249ec4ab4606e5b0571d2800d84bacff0a1171a57b7dd77674c8759ef16af57.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kind
</pre></div>
</div>
<img alt="_images/d6a1f534cf99e7dc5738dfbb392886c1fe95da23c0341c7456c6c4736711c80e.svg" src="_images/d6a1f534cf99e7dc5738dfbb392886c1fe95da23c0341c7456c6c4736711c80e.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>company
</pre></div>
</div>
<img alt="_images/7cb050d423aa105091f207ab988949dcdc12a7c0dd6d684c893b7bfde2a44bf3.svg" src="_images/7cb050d423aa105091f207ab988949dcdc12a7c0dd6d684c893b7bfde2a44bf3.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>model
</pre></div>
</div>
<img alt="_images/27fbf9db6711e1282b0b07762acf3beee370008b436c79aa8685803f42ad853b.svg" src="_images/27fbf9db6711e1282b0b07762acf3beee370008b436c79aa8685803f42ad853b.svg" />
</div>
</div>
<p>Given execution traces from various inputs, one can define <code class="docutils literal notranslate"><span class="pre">update_grammar()</span></code> to obtain the complete grammar from the traces.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">GrammarMiner</span><span class="p">(</span><span class="n">GrammarMiner</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputstr</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_tracker</span><span class="p">(</span><span class="n">inputstr</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_tree_miner</span><span class="p">(</span><span class="n">inputstr</span><span class="p">,</span> <span class="n">at</span><span class="o">.</span><span class="n">assignments</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_tree</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_tracker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DefineTracker</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_tree_miner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TreeMiner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The complete grammar recovery is implemented in <code class="docutils literal notranslate"><span class="pre">recover_grammar()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">recover_grammar</span><span class="p">(</span><span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> 
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Grammar</span><span class="p">:</span>
    <span class="n">miner</span> <span class="o">=</span> <span class="n">GrammarMiner</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">inputstr</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">Tracer</span><span class="p">(</span><span class="n">inputstr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
            <span class="n">fn</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">)</span>
        <span class="n">miner</span><span class="o">.</span><span class="n">update_grammar</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="n">tracer</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">readable</span><span class="p">(</span><span class="n">miner</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Note that the grammar could have been retrieved directly from the tracker, without the intermediate derivation tree stage. However, going through the derivation tree allows one to inspect the inputs being fragmented and verify that it happens correctly.</p>
<section id="example-1-recovering-the-inventory-grammar">
<h4>Example 1. Recovering the Inventory Grammar<a class="headerlink" href="#example-1-recovering-the-inventory-grammar" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inventory_grammar</span> <span class="o">=</span> <span class="n">recover_grammar</span><span class="p">(</span><span class="n">process_vehicle</span><span class="p">,</span> <span class="n">VEHICLES</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inventory_grammar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&lt;start&gt;&#39;: [&#39;&lt;vehicle&gt;&#39;],
 &#39;&lt;vehicle&gt;&#39;: [&#39;&lt;year&gt;,&lt;kind&gt;,&lt;company&gt;,&lt;model&gt;&#39;],
 &#39;&lt;year&gt;&#39;: [&#39;1997&#39;, &#39;2000&#39;, &#39;1999&#39;],
 &#39;&lt;kind&gt;&#39;: [&#39;car&#39;, &#39;van&#39;],
 &#39;&lt;company&gt;&#39;: [&#39;Ford&#39;, &#39;Mercury&#39;, &#39;Chevy&#39;],
 &#39;&lt;model&gt;&#39;: [&#39;Venture&#39;, &#39;E350&#39;, &#39;Cougar&#39;]}
</pre></div>
</div>
</div>
</div>
</section>
<section id="example-2-recovering-url-grammar">
<h4>Example 2. Recovering URL Grammar<a class="headerlink" href="#example-2-recovering-url-grammar" title="Link to this heading">#</a></h4>
<p>Our algorithm is robust enough to recover grammar from real world programs. For example, the <code class="docutils literal notranslate"><span class="pre">urlparse</span></code> function in the Python <code class="docutils literal notranslate"><span class="pre">urlib</span></code> module accepts the following sample URLs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">URLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;http://user:pass@www.google.com:80/?q=path#ref&#39;</span><span class="p">,</span>
    <span class="s1">&#39;https://www.cispa.saarland:80/&#39;</span><span class="p">,</span>
    <span class="s1">&#39;http://www.fuzzingbook.org/#News&#39;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>The urllib caches its intermediate results for faster access. Hence, we need to disable it using <code class="docutils literal notranslate"><span class="pre">clear_cache()</span></code> after every invocation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlparse</span><span class="p">,</span> <span class="n">clear_cache</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
</div>
<p>We use the sample URLs to recover grammar as follows. The <code class="docutils literal notranslate"><span class="pre">urlparse</span></code> function tends to cache its previous parsing results. Hence, we define a new method <code class="docutils literal notranslate"><span class="pre">url_parse()</span></code> that clears the cache before each call.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">url_parse</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">clear_cache</span><span class="p">()</span>
    <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trees</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">URLS</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">Tracer</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
        <span class="n">url_parse</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">)</span>
    <span class="n">assignments</span> <span class="o">=</span> <span class="n">DefineTracker</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="n">tracer</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span><span class="o">.</span><span class="n">assignments</span><span class="p">()</span>
    <span class="n">trees</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="n">assignments</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">var</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">()</span>


<span class="n">url_dt</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">inputstr</span><span class="p">,</span> <span class="n">assignments</span> <span class="ow">in</span> <span class="n">trees</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">inputstr</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">TreeMiner</span><span class="p">(</span><span class="n">inputstr</span><span class="p">,</span> <span class="n">assignments</span><span class="p">)</span>
    <span class="n">url_dt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
    <span class="n">display_tree</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>http://user:pass@www.google.com:80/?q=path#ref
url = &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;
scheme = &#39;http&#39;
netloc = &#39;user:pass@www.google.com:80&#39;
fragment = &#39;ref&#39;
query = &#39;q=path&#39;

https://www.cispa.saarland:80/
url = &#39;https://www.cispa.saarland:80/&#39;
scheme = &#39;https&#39;
netloc = &#39;www.cispa.saarland:80&#39;

http://www.fuzzingbook.org/#News
url = &#39;http://www.fuzzingbook.org/#News&#39;
scheme = &#39;http&#39;
netloc = &#39;www.fuzzingbook.org&#39;
fragment = &#39;News&#39;

http://user:pass@www.google.com:80/?q=path#ref
https://www.cispa.saarland:80/
http://www.fuzzingbook.org/#News
</pre></div>
</div>
</div>
</div>
<p>Let us use <code class="docutils literal notranslate"><span class="pre">url_parse()</span></code> to recover the grammar:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url_grammar</span> <span class="o">=</span> <span class="n">recover_grammar</span><span class="p">(</span><span class="n">url_parse</span><span class="p">,</span> <span class="n">URLS</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;urllib/parse.py&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">syntax_diagram</span><span class="p">(</span><span class="n">url_grammar</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>start
</pre></div>
</div>
<img alt="_images/5008ab6664beaa41645000b660b94b148ebf68edd3538e65026fa2e55b104831.svg" src="_images/5008ab6664beaa41645000b660b94b148ebf68edd3538e65026fa2e55b104831.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>url
</pre></div>
</div>
<img alt="_images/94a6916d72c740f39ba7bfe369497ce85a31df2a8f0601d572f2115f6bebadae.svg" src="_images/94a6916d72c740f39ba7bfe369497ce85a31df2a8f0601d572f2115f6bebadae.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>scheme
</pre></div>
</div>
<img alt="_images/fbb19724c7b27c1f23463890bb881a9dcdf2ebda97a1701b57710139fe86089f.svg" src="_images/fbb19724c7b27c1f23463890bb881a9dcdf2ebda97a1701b57710139fe86089f.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>netloc
</pre></div>
</div>
<img alt="_images/a95d882a02080f35a9676cd55c7556a55350efbf28d62fc3f7d7ab79da2bc3df.svg" src="_images/a95d882a02080f35a9676cd55c7556a55350efbf28d62fc3f7d7ab79da2bc3df.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>query
</pre></div>
</div>
<img alt="_images/de5ded46744e5b7c67e252ef1e6584905ae59e3a3258135bbbcf6d2489bc30e1.svg" src="_images/de5ded46744e5b7c67e252ef1e6584905ae59e3a3258135bbbcf6d2489bc30e1.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fragment
</pre></div>
</div>
<img alt="_images/b1807127561ada743af29d4ef4cf46599809761428c1f041734488b36269fe20.svg" src="_images/b1807127561ada743af29d4ef4cf46599809761428c1f041734488b36269fe20.svg" />
</div>
</div>
<p>The recovered grammar describes the URL format reasonably well.</p>
</section>
</section>
<section id="fuzzing">
<h3>Fuzzing<a class="headerlink" href="#fuzzing" title="Link to this heading">#</a></h3>
<p>We can now use our recovered grammar for fuzzing as follows.</p>
<p>First, the inventory grammar.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">inventory_grammar</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1999,car,Ford,Venture
2000,car,Mercury,E350
1999,van,Ford,Cougar
1997,car,Chevy,Cougar
2000,car,Ford,Venture
2000,car,Ford,E350
1999,car,Mercury,Venture
1999,car,Mercury,Venture
1999,car,Ford,E350
1997,car,Mercury,Venture
</pre></div>
</div>
</div>
</div>
<p>Next, the URL grammar.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">url_grammar</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>https://www.fuzzingbook.org/
https://www.cispa.saarland:80/#News
https://user:pass@www.google.com:80/?q=path#ref
http://www.fuzzingbook.org/?q=path#News
https://www.fuzzingbook.org/#News
https://www.cispa.saarland:80/#News
http://www.cispa.saarland:80/
http://www.fuzzingbook.org/#ref
http://www.fuzzingbook.org/
http://www.fuzzingbook.org/?q=path#ref
</pre></div>
</div>
</div>
</div>
<p>What this means is that we can now take a program and a few samples, extract its grammar, and then use this very grammar for fuzzing.  Now that’s quite an opportunity!</p>
</section>
<section id="problems-with-the-simple-miner">
<h3>Problems with the Simple Miner<a class="headerlink" href="#problems-with-the-simple-miner" title="Link to this heading">#</a></h3>
<p>One of the problems with our simple grammar miner is the assumption that the values assigned to variables are stable. Unfortunately, that may not hold true in all cases. For example, here is a URL with a slightly different format.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">URLS_X</span> <span class="o">=</span> <span class="n">URLS</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;ftp://freebsd.org/releases/5.8&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>The grammar generated from this set of samples is not as nice as what we got earlier</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url_grammar</span> <span class="o">=</span> <span class="n">recover_grammar</span><span class="p">(</span><span class="n">url_parse</span><span class="p">,</span> <span class="n">URLS_X</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;urllib/parse.py&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">syntax_diagram</span><span class="p">(</span><span class="n">url_grammar</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>start
</pre></div>
</div>
<img alt="_images/e0db7bfea8bc1364b6aec6486a1f454757592ed28f179534fd0ce1efd774d535.svg" src="_images/e0db7bfea8bc1364b6aec6486a1f454757592ed28f179534fd0ce1efd774d535.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>url
</pre></div>
</div>
<img alt="_images/95bfa37afdc8b9e616b929d5bedb2dab26d5f9dc095affb301acdb2cb430862a.svg" src="_images/95bfa37afdc8b9e616b929d5bedb2dab26d5f9dc095affb301acdb2cb430862a.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>scheme
</pre></div>
</div>
<img alt="_images/4b0db156a45750f69822d33089f76cf81a73e0a45f8151652b9cbcd0c2af6dba.svg" src="_images/4b0db156a45750f69822d33089f76cf81a73e0a45f8151652b9cbcd0c2af6dba.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>netloc
</pre></div>
</div>
<img alt="_images/44230824aadb05bf7b7a30c3c8796c9c697bf5d43dbac7a93a3ca48978ecd7bc.svg" src="_images/44230824aadb05bf7b7a30c3c8796c9c697bf5d43dbac7a93a3ca48978ecd7bc.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>query
</pre></div>
</div>
<img alt="_images/de5ded46744e5b7c67e252ef1e6584905ae59e3a3258135bbbcf6d2489bc30e1.svg" src="_images/de5ded46744e5b7c67e252ef1e6584905ae59e3a3258135bbbcf6d2489bc30e1.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fragment
</pre></div>
</div>
<img alt="_images/b1807127561ada743af29d4ef4cf46599809761428c1f041734488b36269fe20.svg" src="_images/b1807127561ada743af29d4ef4cf46599809761428c1f041734488b36269fe20.svg" />
</div>
</div>
<p>Clearly, something has gone wrong.</p>
<p>To investigate why the <code class="docutils literal notranslate"><span class="pre">url</span></code> definition has gone wrong, let us inspect the trace for the URL.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clear_cache</span><span class="p">()</span>
<span class="k">with</span> <span class="n">Tracer</span><span class="p">(</span><span class="n">URLS_X</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">urlparse</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">trace</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="s1">&#39;line&#39;</span><span class="p">}</span> <span class="ow">and</span> <span class="s1">&#39;parse.py&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="ow">and</span> <span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">_t</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 374 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;},)
1 394 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;},)
5 129 ({&#39;arg&#39;: &#39;&#39;},)
6 126 ({&#39;arg&#39;: &#39;&#39;},)
7 131 ({&#39;arg&#39;: &#39;&#39;},)
8 132 ({&#39;arg&#39;: &#39;&#39;},)
10 395 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;},)
11 469 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;},)
12 491 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;},)
16 129 ({&#39;arg&#39;: &#39;&#39;},)
17 126 ({&#39;arg&#39;: &#39;&#39;},)
18 131 ({&#39;arg&#39;: &#39;&#39;},)
19 132 ({&#39;arg&#39;: &#39;&#39;},)
21 494 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;},)
22 495 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;},)
23 497 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;},)
24 498 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;, &#39;b&#39;: &#39;\t&#39;},)
25 499 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;, &#39;b&#39;: &#39;\t&#39;},)
26 497 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;, &#39;b&#39;: &#39;\t&#39;},)
27 498 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;, &#39;b&#39;: &#39;\r&#39;},)
28 499 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;, &#39;b&#39;: &#39;\r&#39;},)
29 497 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;, &#39;b&#39;: &#39;\r&#39;},)
30 498 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;, &#39;b&#39;: &#39;\n&#39;},)
31 499 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;, &#39;b&#39;: &#39;\n&#39;},)
32 497 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;, &#39;b&#39;: &#39;\n&#39;},)
33 501 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;, &#39;b&#39;: &#39;\n&#39;},)
34 502 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;, &#39;b&#39;: &#39;\n&#39;},)
35 503 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;, &#39;b&#39;: &#39;\n&#39;, &#39;netloc&#39;: &#39;&#39;, &#39;query&#39;: &#39;&#39;, &#39;fragment&#39;: &#39;&#39;},)
36 504 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;, &#39;b&#39;: &#39;\n&#39;, &#39;netloc&#39;: &#39;&#39;, &#39;query&#39;: &#39;&#39;, &#39;fragment&#39;: &#39;&#39;},)
37 505 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;, &#39;b&#39;: &#39;\n&#39;, &#39;netloc&#39;: &#39;&#39;, &#39;query&#39;: &#39;&#39;, &#39;fragment&#39;: &#39;&#39;},)
38 506 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;, &#39;b&#39;: &#39;\n&#39;, &#39;netloc&#39;: &#39;&#39;, &#39;query&#39;: &#39;&#39;, &#39;fragment&#39;: &#39;&#39;, &#39;c&#39;: &#39;h&#39;},)
39 505 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;, &#39;b&#39;: &#39;\n&#39;, &#39;netloc&#39;: &#39;&#39;, &#39;query&#39;: &#39;&#39;, &#39;fragment&#39;: &#39;&#39;, &#39;c&#39;: &#39;h&#39;},)
40 506 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;, &#39;b&#39;: &#39;\n&#39;, &#39;netloc&#39;: &#39;&#39;, &#39;query&#39;: &#39;&#39;, &#39;fragment&#39;: &#39;&#39;, &#39;c&#39;: &#39;t&#39;},)
41 505 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;, &#39;b&#39;: &#39;\n&#39;, &#39;netloc&#39;: &#39;&#39;, &#39;query&#39;: &#39;&#39;, &#39;fragment&#39;: &#39;&#39;, &#39;c&#39;: &#39;t&#39;},)
42 506 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;, &#39;b&#39;: &#39;\n&#39;, &#39;netloc&#39;: &#39;&#39;, &#39;query&#39;: &#39;&#39;, &#39;fragment&#39;: &#39;&#39;, &#39;c&#39;: &#39;t&#39;},)
43 505 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;, &#39;b&#39;: &#39;\n&#39;, &#39;netloc&#39;: &#39;&#39;, &#39;query&#39;: &#39;&#39;, &#39;fragment&#39;: &#39;&#39;, &#39;c&#39;: &#39;t&#39;},)
44 506 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;, &#39;b&#39;: &#39;\n&#39;, &#39;netloc&#39;: &#39;&#39;, &#39;query&#39;: &#39;&#39;, &#39;fragment&#39;: &#39;&#39;, &#39;c&#39;: &#39;p&#39;},)
45 505 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;, &#39;b&#39;: &#39;\n&#39;, &#39;netloc&#39;: &#39;&#39;, &#39;query&#39;: &#39;&#39;, &#39;fragment&#39;: &#39;&#39;, &#39;c&#39;: &#39;p&#39;},)
46 509 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;, &#39;b&#39;: &#39;\n&#39;, &#39;netloc&#39;: &#39;&#39;, &#39;query&#39;: &#39;&#39;, &#39;fragment&#39;: &#39;&#39;, &#39;c&#39;: &#39;p&#39;},)
47 510 ({&#39;url&#39;: &#39;//user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;http&#39;, &#39;b&#39;: &#39;\n&#39;, &#39;netloc&#39;: &#39;&#39;, &#39;query&#39;: &#39;&#39;, &#39;fragment&#39;: &#39;&#39;, &#39;c&#39;: &#39;p&#39;},)
48 511 ({&#39;url&#39;: &#39;//user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;http&#39;, &#39;b&#39;: &#39;\n&#39;, &#39;netloc&#39;: &#39;&#39;, &#39;query&#39;: &#39;&#39;, &#39;fragment&#39;: &#39;&#39;, &#39;c&#39;: &#39;p&#39;},)
49 413 ({&#39;url&#39;: &#39;//user:pass@www.google.com:80/?q=path#ref&#39;},)
50 414 ({&#39;url&#39;: &#39;//user:pass@www.google.com:80/?q=path#ref&#39;},)
51 415 ({&#39;url&#39;: &#39;//user:pass@www.google.com:80/?q=path#ref&#39;},)
52 416 ({&#39;url&#39;: &#39;//user:pass@www.google.com:80/?q=path#ref&#39;, &#39;c&#39;: &#39;/&#39;},)
53 417 ({&#39;url&#39;: &#39;//user:pass@www.google.com:80/?q=path#ref&#39;, &#39;c&#39;: &#39;/&#39;},)
54 418 ({&#39;url&#39;: &#39;//user:pass@www.google.com:80/?q=path#ref&#39;, &#39;c&#39;: &#39;/&#39;},)
55 415 ({&#39;url&#39;: &#39;//user:pass@www.google.com:80/?q=path#ref&#39;, &#39;c&#39;: &#39;/&#39;},)
56 416 ({&#39;url&#39;: &#39;//user:pass@www.google.com:80/?q=path#ref&#39;, &#39;c&#39;: &#39;?&#39;},)
57 417 ({&#39;url&#39;: &#39;//user:pass@www.google.com:80/?q=path#ref&#39;, &#39;c&#39;: &#39;?&#39;},)
58 418 ({&#39;url&#39;: &#39;//user:pass@www.google.com:80/?q=path#ref&#39;, &#39;c&#39;: &#39;?&#39;},)
59 415 ({&#39;url&#39;: &#39;//user:pass@www.google.com:80/?q=path#ref&#39;, &#39;c&#39;: &#39;?&#39;},)
60 416 ({&#39;url&#39;: &#39;//user:pass@www.google.com:80/?q=path#ref&#39;, &#39;c&#39;: &#39;#&#39;},)
61 417 ({&#39;url&#39;: &#39;//user:pass@www.google.com:80/?q=path#ref&#39;, &#39;c&#39;: &#39;#&#39;},)
62 418 ({&#39;url&#39;: &#39;//user:pass@www.google.com:80/?q=path#ref&#39;, &#39;c&#39;: &#39;#&#39;},)
63 415 ({&#39;url&#39;: &#39;//user:pass@www.google.com:80/?q=path#ref&#39;, &#39;c&#39;: &#39;#&#39;},)
64 419 ({&#39;url&#39;: &#39;//user:pass@www.google.com:80/?q=path#ref&#39;, &#39;c&#39;: &#39;#&#39;},)
66 512 ({&#39;url&#39;: &#39;/?q=path#ref&#39;, &#39;scheme&#39;: &#39;http&#39;, &#39;b&#39;: &#39;\n&#39;, &#39;netloc&#39;: &#39;user:pass@www.google.com:80&#39;, &#39;query&#39;: &#39;&#39;, &#39;fragment&#39;: &#39;&#39;, &#39;c&#39;: &#39;p&#39;},)
67 513 ({&#39;url&#39;: &#39;/?q=path#ref&#39;, &#39;scheme&#39;: &#39;http&#39;, &#39;b&#39;: &#39;\n&#39;, &#39;netloc&#39;: &#39;user:pass@www.google.com:80&#39;, &#39;query&#39;: &#39;&#39;, &#39;fragment&#39;: &#39;&#39;, &#39;c&#39;: &#39;p&#39;},)
68 515 ({&#39;url&#39;: &#39;/?q=path#ref&#39;, &#39;scheme&#39;: &#39;http&#39;, &#39;b&#39;: &#39;\n&#39;, &#39;netloc&#39;: &#39;user:pass@www.google.com:80&#39;, &#39;query&#39;: &#39;&#39;, &#39;fragment&#39;: &#39;&#39;, &#39;c&#39;: &#39;p&#39;},)
69 517 ({&#39;url&#39;: &#39;/?q=path#ref&#39;, &#39;scheme&#39;: &#39;http&#39;, &#39;b&#39;: &#39;\n&#39;, &#39;netloc&#39;: &#39;user:pass@www.google.com:80&#39;, &#39;query&#39;: &#39;&#39;, &#39;fragment&#39;: &#39;&#39;, &#39;c&#39;: &#39;p&#39;},)
70 518 ({&#39;url&#39;: &#39;/?q=path#ref&#39;, &#39;scheme&#39;: &#39;http&#39;, &#39;b&#39;: &#39;\n&#39;, &#39;netloc&#39;: &#39;user:pass@www.google.com:80&#39;, &#39;query&#39;: &#39;&#39;, &#39;fragment&#39;: &#39;&#39;, &#39;c&#39;: &#39;p&#39;},)
71 519 ({&#39;url&#39;: &#39;/?q=path&#39;, &#39;scheme&#39;: &#39;http&#39;, &#39;b&#39;: &#39;\n&#39;, &#39;netloc&#39;: &#39;user:pass@www.google.com:80&#39;, &#39;query&#39;: &#39;&#39;, &#39;fragment&#39;: &#39;ref&#39;, &#39;c&#39;: &#39;p&#39;},)
72 520 ({&#39;url&#39;: &#39;/?q=path&#39;, &#39;scheme&#39;: &#39;http&#39;, &#39;b&#39;: &#39;\n&#39;, &#39;netloc&#39;: &#39;user:pass@www.google.com:80&#39;, &#39;query&#39;: &#39;&#39;, &#39;fragment&#39;: &#39;ref&#39;, &#39;c&#39;: &#39;p&#39;},)
73 521 ({&#39;url&#39;: &#39;/&#39;, &#39;scheme&#39;: &#39;http&#39;, &#39;b&#39;: &#39;\n&#39;, &#39;netloc&#39;: &#39;user:pass@www.google.com:80&#39;, &#39;query&#39;: &#39;q=path&#39;, &#39;fragment&#39;: &#39;ref&#39;, &#39;c&#39;: &#39;p&#39;},)
74 421 ({&#39;netloc&#39;: &#39;user:pass@www.google.com:80&#39;},)
75 422 ({&#39;netloc&#39;: &#39;user:pass@www.google.com:80&#39;},)
76 423 ({&#39;netloc&#39;: &#39;user:pass@www.google.com:80&#39;},)
78 522 ({&#39;url&#39;: &#39;/&#39;, &#39;scheme&#39;: &#39;http&#39;, &#39;b&#39;: &#39;\n&#39;, &#39;netloc&#39;: &#39;user:pass@www.google.com:80&#39;, &#39;query&#39;: &#39;q=path&#39;, &#39;fragment&#39;: &#39;ref&#39;, &#39;c&#39;: &#39;p&#39;},)
82 523 ({&#39;url&#39;: &#39;/&#39;, &#39;scheme&#39;: &#39;http&#39;, &#39;b&#39;: &#39;\n&#39;, &#39;netloc&#39;: &#39;user:pass@www.google.com:80&#39;, &#39;query&#39;: &#39;q=path&#39;, &#39;fragment&#39;: &#39;ref&#39;, &#39;c&#39;: &#39;p&#39;},)
87 396 ({&#39;url&#39;: &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, &#39;scheme&#39;: &#39;&#39;},)
88 397 ({&#39;url&#39;: &#39;/&#39;, &#39;scheme&#39;: &#39;http&#39;, &#39;netloc&#39;: &#39;user:pass@www.google.com:80&#39;, &#39;query&#39;: &#39;q=path&#39;, &#39;fragment&#39;: &#39;ref&#39;},)
89 400 ({&#39;url&#39;: &#39;/&#39;, &#39;scheme&#39;: &#39;http&#39;, &#39;netloc&#39;: &#39;user:pass@www.google.com:80&#39;, &#39;query&#39;: &#39;q=path&#39;, &#39;fragment&#39;: &#39;ref&#39;},)
90 401 ({&#39;url&#39;: &#39;/&#39;, &#39;scheme&#39;: &#39;http&#39;, &#39;netloc&#39;: &#39;user:pass@www.google.com:80&#39;, &#39;query&#39;: &#39;q=path&#39;, &#39;fragment&#39;: &#39;ref&#39;, &#39;params&#39;: &#39;&#39;},)
94 402 ({&#39;url&#39;: &#39;/&#39;, &#39;scheme&#39;: &#39;http&#39;, &#39;netloc&#39;: &#39;user:pass@www.google.com:80&#39;, &#39;query&#39;: &#39;q=path&#39;, &#39;fragment&#39;: &#39;ref&#39;, &#39;params&#39;: &#39;&#39;},)
</pre></div>
</div>
</div>
</div>
<p>Notice how the value of <code class="docutils literal notranslate"><span class="pre">url</span></code> changes as the parsing progresses? This violates our assumption that the value assigned to a variable is stable. We next look at how this limitation can be removed.</p>
</section>
</section>
<section id="grammar-miner-with-reassignment">
<h2>Grammar Miner with Reassignment<a class="headerlink" href="#grammar-miner-with-reassignment" title="Link to this heading">#</a></h2>
<p>One way to uniquely identify different variables is to annotate them with <em>line numbers</em> both when they are defined and also when their value changes. Consider the code fragment below</p>
<section id="tracking-variable-assignment-locations">
<h3>Tracking variable assignment locations<a class="headerlink" href="#tracking-variable-assignment-locations" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="n">cp_1</span><span class="p">):</span>
    <span class="n">c_2</span> <span class="o">=</span> <span class="n">cp_1</span> <span class="o">+</span> <span class="s1">&#39;@2&#39;</span>
    <span class="n">c_3</span> <span class="o">=</span> <span class="n">c_2</span> <span class="o">+</span> <span class="s1">&#39;@3&#39;</span>
    <span class="k">return</span> <span class="n">c_3</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">B</span><span class="p">(</span><span class="n">bp_7</span><span class="p">):</span>
    <span class="n">b_8</span> <span class="o">=</span> <span class="n">bp_7</span> <span class="o">+</span> <span class="s1">&#39;@8&#39;</span>
    <span class="k">return</span> <span class="n">C</span><span class="p">(</span><span class="n">b_8</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">A</span><span class="p">(</span><span class="n">ap_12</span><span class="p">):</span>
    <span class="n">a_13</span> <span class="o">=</span> <span class="n">ap_12</span> <span class="o">+</span> <span class="s1">&#39;@13&#39;</span>
    <span class="n">a_14</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">a_13</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;@14&#39;</span>
    <span class="n">a_14</span> <span class="o">=</span> <span class="n">a_14</span> <span class="o">+</span> <span class="s1">&#39;@15&#39;</span>
    <span class="n">a_13</span> <span class="o">=</span> <span class="n">a_14</span> <span class="o">+</span> <span class="s1">&#39;@16&#39;</span>
    <span class="n">a_14</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">a_13</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;@17&#39;</span>
    <span class="n">a_14</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">a_13</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;@18&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>Notice how all variables are either named corresponding to either where they are defined, or the value is annotated to indicate that it was changed.</p>
<p>Let us run this under the trace.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Tracer</span><span class="p">(</span><span class="s1">&#39;____&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">A</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">)</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tracer</span><span class="o">.</span><span class="n">trace</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">line_no</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">method</span><span class="p">),</span> <span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>call 1:A {&#39;ap_12&#39;: &#39;____&#39;}
line 2:A {&#39;ap_12&#39;: &#39;____&#39;}
line 3:A {&#39;ap_12&#39;: &#39;____&#39;, &#39;a_13&#39;: &#39;____@13&#39;}
call 1:B {&#39;bp_7&#39;: &#39;____@13&#39;}
line 2:B {&#39;bp_7&#39;: &#39;____@13&#39;}
line 3:B {&#39;bp_7&#39;: &#39;____@13&#39;, &#39;b_8&#39;: &#39;____@13@8&#39;}
call 1:C {&#39;cp_1&#39;: &#39;____@13@8&#39;}
line 2:C {&#39;cp_1&#39;: &#39;____@13@8&#39;}
line 3:C {&#39;cp_1&#39;: &#39;____@13@8&#39;, &#39;c_2&#39;: &#39;____@13@8@2&#39;}
line 4:C {&#39;cp_1&#39;: &#39;____@13@8&#39;, &#39;c_2&#39;: &#39;____@13@8@2&#39;, &#39;c_3&#39;: &#39;____@13@8@2@3&#39;}
return 4:C {&#39;cp_1&#39;: &#39;____@13@8&#39;, &#39;c_2&#39;: &#39;____@13@8@2&#39;, &#39;c_3&#39;: &#39;____@13@8@2@3&#39;}
return 3:B {&#39;bp_7&#39;: &#39;____@13&#39;, &#39;b_8&#39;: &#39;____@13@8&#39;}
line 4:A {&#39;ap_12&#39;: &#39;____&#39;, &#39;a_13&#39;: &#39;____@13&#39;, &#39;a_14&#39;: &#39;____@13@8@2@3@14&#39;}
line 5:A {&#39;ap_12&#39;: &#39;____&#39;, &#39;a_13&#39;: &#39;____@13&#39;, &#39;a_14&#39;: &#39;____@13@8@2@3@14@15&#39;}
line 6:A {&#39;ap_12&#39;: &#39;____&#39;, &#39;a_13&#39;: &#39;____@13@8@2@3@14@15@16&#39;, &#39;a_14&#39;: &#39;____@13@8@2@3@14@15&#39;}
call 1:B {&#39;bp_7&#39;: &#39;____@13@8@2@3@14@15@16&#39;}
line 2:B {&#39;bp_7&#39;: &#39;____@13@8@2@3@14@15@16&#39;}
line 3:B {&#39;bp_7&#39;: &#39;____@13@8@2@3@14@15@16&#39;, &#39;b_8&#39;: &#39;____@13@8@2@3@14@15@16@8&#39;}
call 1:C {&#39;cp_1&#39;: &#39;____@13@8@2@3@14@15@16@8&#39;}
line 2:C {&#39;cp_1&#39;: &#39;____@13@8@2@3@14@15@16@8&#39;}
line 3:C {&#39;cp_1&#39;: &#39;____@13@8@2@3@14@15@16@8&#39;, &#39;c_2&#39;: &#39;____@13@8@2@3@14@15@16@8@2&#39;}
line 4:C {&#39;cp_1&#39;: &#39;____@13@8@2@3@14@15@16@8&#39;, &#39;c_2&#39;: &#39;____@13@8@2@3@14@15@16@8@2&#39;, &#39;c_3&#39;: &#39;____@13@8@2@3@14@15@16@8@2@3&#39;}
return 4:C {&#39;cp_1&#39;: &#39;____@13@8@2@3@14@15@16@8&#39;, &#39;c_2&#39;: &#39;____@13@8@2@3@14@15@16@8@2&#39;, &#39;c_3&#39;: &#39;____@13@8@2@3@14@15@16@8@2@3&#39;}
return 3:B {&#39;bp_7&#39;: &#39;____@13@8@2@3@14@15@16&#39;, &#39;b_8&#39;: &#39;____@13@8@2@3@14@15@16@8&#39;}
line 7:A {&#39;ap_12&#39;: &#39;____&#39;, &#39;a_13&#39;: &#39;____@13@8@2@3@14@15@16&#39;, &#39;a_14&#39;: &#39;____@13@8@2@3@14@15@16@8@2@3@17&#39;}
call 1:B {&#39;bp_7&#39;: &#39;____@13@8@2@3@14@15@16&#39;}
line 2:B {&#39;bp_7&#39;: &#39;____@13@8@2@3@14@15@16&#39;}
line 3:B {&#39;bp_7&#39;: &#39;____@13@8@2@3@14@15@16&#39;, &#39;b_8&#39;: &#39;____@13@8@2@3@14@15@16@8&#39;}
call 1:C {&#39;cp_1&#39;: &#39;____@13@8@2@3@14@15@16@8&#39;}
line 2:C {&#39;cp_1&#39;: &#39;____@13@8@2@3@14@15@16@8&#39;}
line 3:C {&#39;cp_1&#39;: &#39;____@13@8@2@3@14@15@16@8&#39;, &#39;c_2&#39;: &#39;____@13@8@2@3@14@15@16@8@2&#39;}
line 4:C {&#39;cp_1&#39;: &#39;____@13@8@2@3@14@15@16@8&#39;, &#39;c_2&#39;: &#39;____@13@8@2@3@14@15@16@8@2&#39;, &#39;c_3&#39;: &#39;____@13@8@2@3@14@15@16@8@2@3&#39;}
return 4:C {&#39;cp_1&#39;: &#39;____@13@8@2@3@14@15@16@8&#39;, &#39;c_2&#39;: &#39;____@13@8@2@3@14@15@16@8@2&#39;, &#39;c_3&#39;: &#39;____@13@8@2@3@14@15@16@8@2@3&#39;}
return 3:B {&#39;bp_7&#39;: &#39;____@13@8@2@3@14@15@16&#39;, &#39;b_8&#39;: &#39;____@13@8@2@3@14@15@16@8&#39;}
return 7:A {&#39;ap_12&#39;: &#39;____&#39;, &#39;a_13&#39;: &#39;____@13@8@2@3@14@15@16&#39;, &#39;a_14&#39;: &#39;____@13@8@2@3@14@15@16@8@2@3@18&#39;}
call 102:__exit__ {}
line 105:__exit__ {}
</pre></div>
</div>
</div>
</div>
<p>Each variable was referenced first as follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cp_1</span></code> – <em>call</em> <code class="docutils literal notranslate"><span class="pre">1:C</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">c_2</span></code> – <em>line</em> <code class="docutils literal notranslate"><span class="pre">3:C</span></code> (but the previous event was <em>line</em> <code class="docutils literal notranslate"><span class="pre">2:C</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">c_3</span></code> – <em>line</em> <code class="docutils literal notranslate"><span class="pre">4:C</span></code> (but the previous event was <em>line</em> <code class="docutils literal notranslate"><span class="pre">3:C</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bp_7</span></code> – <em>call</em> <code class="docutils literal notranslate"><span class="pre">7:B</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">b_8</span></code> – <em>line</em> <code class="docutils literal notranslate"><span class="pre">9:B</span></code> (but the previous event was <em>line</em> <code class="docutils literal notranslate"><span class="pre">8:B</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ap_12</span></code> – <em>call</em> <code class="docutils literal notranslate"><span class="pre">12:A</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">a_13</span></code> – <em>line</em> <code class="docutils literal notranslate"><span class="pre">14:A</span></code> (but the previous event was <em>line</em> <code class="docutils literal notranslate"><span class="pre">13:A</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">a_14</span></code> – <em>line</em> <code class="docutils literal notranslate"><span class="pre">15:A</span></code> (the previous event was <em>return</em> <code class="docutils literal notranslate"><span class="pre">9:B</span></code>. However, the previous event in <code class="docutils literal notranslate"><span class="pre">A()</span></code> was <em>line</em> <code class="docutils literal notranslate"><span class="pre">14:A</span></code>)</p></li>
<li><p>reassign <code class="docutils literal notranslate"><span class="pre">a_14</span></code> at <em>15</em> – <em>line</em> <code class="docutils literal notranslate"><span class="pre">16:A</span></code> (the previous event was <em>line</em> <code class="docutils literal notranslate"><span class="pre">15:A</span></code>)</p></li>
<li><p>reassign <code class="docutils literal notranslate"><span class="pre">a_13</span></code> at <em>16</em> – <em>line</em> <code class="docutils literal notranslate"><span class="pre">17:A</span></code> (the previous event was <em>line</em> <code class="docutils literal notranslate"><span class="pre">16:A</span></code>)</p></li>
<li><p>reassign <code class="docutils literal notranslate"><span class="pre">a_14</span></code> at <em>17</em> – <em>return</em> <code class="docutils literal notranslate"><span class="pre">17:A</span></code> (the previous event in <code class="docutils literal notranslate"><span class="pre">A()</span></code> was <em>line</em> <code class="docutils literal notranslate"><span class="pre">17:A</span></code>)</p></li>
<li><p>reassign <code class="docutils literal notranslate"><span class="pre">a_14</span></code> at <em>18</em> – <em>return</em> <code class="docutils literal notranslate"><span class="pre">18:A</span></code> (the previous event in <code class="docutils literal notranslate"><span class="pre">A()</span></code> was <em>line</em> <code class="docutils literal notranslate"><span class="pre">18:A</span></code>)</p></li>
</ul>
<p>So, our observations are that, if it is a call, the current location is the right one for any new variables being defined. On the other hand, if the variable being referenced for the first time (or reassigned a new value), then the  right location to consider is the previous location <em>in the same method invocation</em>. Next, let us see how we can incorporate this information into variable naming.</p>
<p>Next, we need a way to track the individual method calls as they are being made. For this we define the class <code class="docutils literal notranslate"><span class="pre">CallStack</span></code>. Each method invocation gets a separate identifier, and when the method call is over, the identifier is reset.</p>
</section>
<section id="callstack">
<h3>CallStack<a class="headerlink" href="#callstack" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CallStack</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">START_SYMBOL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method_register</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mstack</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">method_id</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">enter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method_register</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_register</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mstack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method_id</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">leave</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mstack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mstack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>A few extra functions to make life simpler.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CallStack</span><span class="p">(</span><span class="n">CallStack</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log_event</span> <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="k">lambda</span> <span class="n">_evt</span><span class="p">,</span> <span class="n">_var</span><span class="p">:</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">indent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mstack</span><span class="p">)</span> <span class="o">*</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mstack</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">mstack</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_id</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method_id</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We also define a convenience method to display a given stack.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">display_stack</span><span class="p">(</span><span class="n">istack</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">stack_to_tree</span><span class="p">(</span><span class="n">stack</span><span class="p">):</span>
        <span class="n">current</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span> <span class="o">=</span> <span class="n">stack</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rest</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="p">[])</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="p">[</span><span class="n">stack_to_tree</span><span class="p">(</span><span class="n">rest</span><span class="p">)])</span>
    <span class="n">display_tree</span><span class="p">(</span><span class="n">stack_to_tree</span><span class="p">(</span><span class="n">istack</span><span class="o">.</span><span class="n">mstack</span><span class="p">),</span> <span class="n">graph_attr</span><span class="o">=</span><span class="n">lr_graph</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here is how we can use the <code class="docutils literal notranslate"><span class="pre">CallStack</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cs</span> <span class="o">=</span> <span class="n">CallStack</span><span class="p">()</span>
<span class="n">display_stack</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
<span class="n">cs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;&lt;start&gt;&#39;, 0)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cs</span><span class="o">.</span><span class="n">enter</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
<span class="n">display_stack</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
<span class="n">cs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;hello&#39;, 1)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cs</span><span class="o">.</span><span class="n">enter</span><span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">)</span>
<span class="n">display_stack</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
<span class="n">cs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;world&#39;, 2)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cs</span><span class="o">.</span><span class="n">leave</span><span class="p">()</span>
<span class="n">display_stack</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
<span class="n">cs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;hello&#39;, 1)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cs</span><span class="o">.</span><span class="n">enter</span><span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">)</span>
<span class="n">display_stack</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
<span class="n">cs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;world&#39;, 3)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cs</span><span class="o">.</span><span class="n">leave</span><span class="p">()</span>
<span class="n">display_stack</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
<span class="n">cs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;hello&#39;, 1)
</pre></div>
</div>
</div>
</div>
<p>In order to account for variable reassignments, we need to have a more intelligent data structure than a dictionary for storing variables. We first define a simple interface <code class="docutils literal notranslate"><span class="pre">Vars</span></code>. It acts as a container for variables, and is instantiated at <code class="docutils literal notranslate"><span class="pre">my_assignments</span></code>.</p>
</section>
<section id="vars">
<h3>Vars<a class="headerlink" href="#vars" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Vars</span></code> stores references to variables as they occur during parsing in its internal dictionary <code class="docutils literal notranslate"><span class="pre">defs</span></code>. We initialize the dictionary with the original string.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Vars</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_input</span> <span class="o">=</span> <span class="n">original</span>
</pre></div>
</div>
</div>
</div>
<p>The dictionary needs two methods: <code class="docutils literal notranslate"><span class="pre">update()</span></code> that takes a set of key-value pairs to update itself, and <code class="docutils literal notranslate"><span class="pre">_set_kv()</span></code> that updates a particular key-value pair.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Vars</span><span class="p">(</span><span class="n">Vars</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_kv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_kv</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_kv</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Vars</span></code> is a proxy for the internal dictionary. For example, here is how one can use it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">v</span> <span class="o">=</span> <span class="n">Vars</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">v</span><span class="o">.</span><span class="n">defs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;X&#39;</span>
<span class="n">v</span><span class="o">.</span><span class="n">defs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;x&#39;: &#39;X&#39;}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">v</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="s1">&#39;y&#39;</span><span class="p">})</span>
<span class="n">v</span><span class="o">.</span><span class="n">defs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;x&#39;: &#39;x&#39;, &#39;y&#39;: &#39;y&#39;}
</pre></div>
</div>
</div>
</div>
</section>
<section id="assignmentvars">
<h3>AssignmentVars<a class="headerlink" href="#assignmentvars" title="Link to this heading">#</a></h3>
<p>We now extend the simple <code class="docutils literal notranslate"><span class="pre">Vars</span></code> to account for variable reassignments. For this, we define <code class="docutils literal notranslate"><span class="pre">AssignmentVars</span></code>.</p>
<p>The idea for detecting reassignments and renaming variables is as follows: We keep track of the previous reassignments to particular variables using <code class="docutils literal notranslate"><span class="pre">accessed_seq_var</span></code>. It contains the last rename of any particular variable as its corresponding value. The <code class="docutils literal notranslate"><span class="pre">new_vars</span></code> contains a list of all new variables that were added on this iteration.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AssignmentVars</span><span class="p">(</span><span class="n">Vars</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accessed_seq_var</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_def_lines</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_vars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method_init</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">method_init()</span></code> method takes care of keeping track of method invocations using records saved in the <code class="docutils literal notranslate"><span class="pre">call_stack</span></code>. <code class="docutils literal notranslate"><span class="pre">event_locations</span></code> is for keeping track of the locations accessed <em>within this method</em>. This is used for line number tracking of variable definitions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AssignmentVars</span><span class="p">(</span><span class="n">AssignmentVars</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">method_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span> <span class="o">=</span> <span class="n">CallStack</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_locations</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span><span class="o">.</span><span class="n">method_id</span><span class="p">:</span> <span class="p">[]}</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">update()</span></code> is now modified to track the changed line numbers if any, using <code class="docutils literal notranslate"><span class="pre">var_location_register()</span></code>. We reinitialize the <code class="docutils literal notranslate"><span class="pre">new_vars</span></code> after use for the next event.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AssignmentVars</span><span class="p">(</span><span class="n">AssignmentVars</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_kv</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_location_register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_vars</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_vars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The variable name now incorporates an index of how many reassignments it has gone through, effectively making each reassignment a unique variable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AssignmentVars</span><span class="p">(</span><span class="n">AssignmentVars</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">var_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">accessed_seq_var</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>While storing variables, we need to first check whether it was previously known. If it is not, we need to initialize the rename count. This is accomplished by <code class="docutils literal notranslate"><span class="pre">var_access</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AssignmentVars</span><span class="p">(</span><span class="n">AssignmentVars</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">var_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">accessed_seq_var</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">accessed_seq_var</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>During a variable reassignment, we update the <code class="docutils literal notranslate"><span class="pre">accessed_seq_var</span></code> to reflect the new count.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AssignmentVars</span><span class="p">(</span><span class="n">AssignmentVars</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">var_assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accessed_seq_var</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_vars</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>These methods can be used as follows</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sav</span> <span class="o">=</span> <span class="n">AssignmentVars</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">sav</span><span class="o">.</span><span class="n">defs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sav</span><span class="o">.</span><span class="n">var_access</span><span class="p">(</span><span class="s1">&#39;v1&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;v1&#39;, 0)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sav</span><span class="o">.</span><span class="n">var_assign</span><span class="p">(</span><span class="s1">&#39;v1&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;v1&#39;, 1)
</pre></div>
</div>
</div>
</div>
<p>Assigning to it again increments the counter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sav</span><span class="o">.</span><span class="n">var_assign</span><span class="p">(</span><span class="s1">&#39;v1&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;v1&#39;, 2)
</pre></div>
</div>
</div>
</div>
<p>The core of the logic is in <code class="docutils literal notranslate"><span class="pre">_set_kv()</span></code>. When a variable is being assigned, we get the sequenced variable name <code class="docutils literal notranslate"><span class="pre">s_var</span></code>. If the sequenced variable name was previously unknown in <code class="docutils literal notranslate"><span class="pre">defs</span></code>, then we have no further concerns. We add the sequenced variable to <code class="docutils literal notranslate"><span class="pre">defs</span></code>.</p>
<p>If the variable is previously known, then it is an indication of a possible reassignment. In this case, we look at the value the variable is holding. We check if the value changed. If it has not, then it is not.</p>
<p>If the value has changed, it is a reassignment. We first increment the variable usage sequence using <code class="docutils literal notranslate"><span class="pre">var_assign</span></code>, retrieve the new name, update the new name in <code class="docutils literal notranslate"><span class="pre">defs</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AssignmentVars</span><span class="p">(</span><span class="n">AssignmentVars</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_kv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="n">s_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_access</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s_var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">defs</span><span class="p">[</span><span class="n">s_var</span><span class="p">]</span> <span class="o">==</span> <span class="n">val</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var_assign</span><span class="p">(</span><span class="n">var</span><span class="p">)]</span> <span class="o">=</span> <span class="n">val</span>
</pre></div>
</div>
</div>
</div>
<p>Here is how it can be used. Assigning a variable the first time initializes its counter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sav</span> <span class="o">=</span> <span class="n">AssignmentVars</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">sav</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;X&#39;</span>
<span class="n">sav</span><span class="o">.</span><span class="n">defs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{(&#39;x&#39;, 1): &#39;X&#39;}
</pre></div>
</div>
</div>
</div>
<p>If the variable is assigned again with the same value, it is probably not a reassignment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sav</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;X&#39;</span>
<span class="n">sav</span><span class="o">.</span><span class="n">defs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{(&#39;x&#39;, 1): &#39;X&#39;}
</pre></div>
</div>
</div>
</div>
<p>However, if the value changed, it is a reassignment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sav</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span>
<span class="n">sav</span><span class="o">.</span><span class="n">defs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{(&#39;x&#39;, 1): &#39;X&#39;, (&#39;x&#39;, 2): &#39;Y&#39;}
</pre></div>
</div>
</div>
</div>
<p>There is a subtlety here. It is possible for a child method to be called from the middle of a parent method, and for both to use the same variable name with different values. In this case, when the child returns, parent will have the old variable with old value in context. With our implementation, we consider this as a reassignment. However, this is OK because adding a new reassignment is harmless, but missing one is not. Further, we will discuss later how this can be avoided.</p>
<p>We also define bookkeeping codes for <code class="docutils literal notranslate"><span class="pre">register_event()</span></code> <code class="docutils literal notranslate"><span class="pre">method_enter()</span></code> and <code class="docutils literal notranslate"><span class="pre">method_exit()</span></code> which are the methods responsible for keeping track of the method stack. The basic idea is that, each <code class="docutils literal notranslate"><span class="pre">method_enter()</span></code> represents a new method invocation. Hence, it merits a new method id, which is generated from the <code class="docutils literal notranslate"><span class="pre">method_register</span></code>, and saved in the <code class="docutils literal notranslate"><span class="pre">method_id</span></code>. Since this is a new method, the method stack is extended by one element with this id. In the case of <code class="docutils literal notranslate"><span class="pre">method_exit()</span></code>, we pop the method stack, and reset the current <code class="docutils literal notranslate"><span class="pre">method_id</span></code> to what was below the current one.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AssignmentVars</span><span class="p">(</span><span class="n">AssignmentVars</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">method_enter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cxt</span><span class="p">,</span> <span class="n">my_vars</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span> <span class="o">=</span> <span class="s1">&#39;call&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span><span class="o">.</span><span class="n">enter</span><span class="p">(</span><span class="n">cxt</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_locations</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span><span class="o">.</span><span class="n">method_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_event</span><span class="p">(</span><span class="n">cxt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">my_vars</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">method_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cxt</span><span class="p">,</span> <span class="n">my_vars</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span> <span class="o">=</span> <span class="s1">&#39;return&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_event</span><span class="p">(</span><span class="n">cxt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">my_vars</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span><span class="o">.</span><span class="n">leave</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">method_statement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cxt</span><span class="p">,</span> <span class="n">my_vars</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span> <span class="o">=</span> <span class="s1">&#39;line&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_event</span><span class="p">(</span><span class="n">cxt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">my_vars</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>For each of the method events, we also register the event using <code class="docutils literal notranslate"><span class="pre">register_event()</span></code> which keeps track of the line numbers that were referenced in <em>this</em> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AssignmentVars</span><span class="p">(</span><span class="n">AssignmentVars</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">register_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cxt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_locations</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span><span class="o">.</span><span class="n">method_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cxt</span><span class="o">.</span><span class="n">line_no</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">var_location_register()</span></code> keeps the locations of newly added variables. The definition location of variables in a <code class="docutils literal notranslate"><span class="pre">call</span></code> is the <em>current</em>  location. However, for a <code class="docutils literal notranslate"><span class="pre">line</span></code>, it would be the previous event in the current method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AssignmentVars</span><span class="p">(</span><span class="n">AssignmentVars</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">var_location_register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">my_vars</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">loc</span><span class="p">(</span><span class="n">mid</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_locations</span><span class="p">[</span><span class="n">mid</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_locations</span><span class="p">[</span><span class="n">mid</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span> <span class="o">==</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_locations</span><span class="p">[</span><span class="n">mid</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="kc">False</span>

        <span class="n">my_loc</span> <span class="o">=</span> <span class="n">loc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span><span class="o">.</span><span class="n">method_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">my_vars</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var_def_lines</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_loc</span>
</pre></div>
</div>
</div>
</div>
<p>We define <code class="docutils literal notranslate"><span class="pre">defined_vars()</span></code> which returns the names of variables annotated with the line numbers as below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AssignmentVars</span><span class="p">(</span><span class="n">AssignmentVars</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">defined_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formatted</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">fmt</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_def_lines</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">if</span> <span class="n">formatted</span> <span class="k">else</span> <span class="n">v</span>

        <span class="k">return</span> <span class="p">[(</span><span class="n">fmt</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
</pre></div>
</div>
</div>
</div>
<p>Similar to <code class="docutils literal notranslate"><span class="pre">defined_vars()</span></code> we define <code class="docutils literal notranslate"><span class="pre">seq_vars()</span></code> which annotates different variables with the number of times they were used.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AssignmentVars</span><span class="p">(</span><span class="n">AssignmentVars</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">seq_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formatted</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">fmt</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_def_lines</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">if</span> <span class="n">formatted</span> <span class="k">else</span> <span class="n">v</span>

        <span class="k">return</span> <span class="p">{</span><span class="n">fmt</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="assignmenttracker">
<h3>AssignmentTracker<a class="headerlink" href="#assignmenttracker" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">AssignmentTracker</span></code> keeps the assignment definitions using the <code class="docutils literal notranslate"><span class="pre">AssignmentVars</span></code> we defined previously.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AssignmentTracker</span><span class="p">(</span><span class="n">DefineTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">my_input</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_input</span> <span class="o">=</span> <span class="n">my_input</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">my_assignments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_assignments</span><span class="p">(</span><span class="n">my_input</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="n">trace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_assignments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">AssignmentVars</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>To fine-tune the process, we define an optional parameter called <code class="docutils literal notranslate"><span class="pre">track_return</span></code>. During tracing a method return, Python produces a virtual variable that contains the result of the returned value. If the <code class="docutils literal notranslate"><span class="pre">track_return</span></code> is set, we capture this value as a variable.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">track_return</span></code> – if true, add a <em>virtual variable</em> to the Vars representing the return value</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AssignmentTracker</span><span class="p">(</span><span class="n">AssignmentTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_return</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;track_return&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>There can be different kinds of events during a trace, which includes <code class="docutils literal notranslate"><span class="pre">call</span></code> when a function is entered, <code class="docutils literal notranslate"><span class="pre">return</span></code> when the function returns, <code class="docutils literal notranslate"><span class="pre">exception</span></code> when an exception is thrown and <code class="docutils literal notranslate"><span class="pre">line</span></code> when a statement is executed.</p>
<p>The previous <code class="docutils literal notranslate"><span class="pre">Tracker</span></code> was too simplistic in that it did not distinguish between the different events. We rectify that and define <code class="docutils literal notranslate"><span class="pre">on_call()</span></code>, <code class="docutils literal notranslate"><span class="pre">on_return()</span></code>, and <code class="docutils literal notranslate"><span class="pre">on_line()</span></code> respectively, which get called on their corresponding events.</p>
<p>Note that <code class="docutils literal notranslate"><span class="pre">on_line()</span></code> is called also for <code class="docutils literal notranslate"><span class="pre">on_return()</span></code>. The reason is, that Python invokes the trace function <em>before</em> the corresponding line is executed. Hence, effectively, the <code class="docutils literal notranslate"><span class="pre">on_return()</span></code> is called with the binding produced by the execution of the previous statement in the environment. Our processing in effect is done on values that were bound by the previous statement. Hence, calling <code class="docutils literal notranslate"><span class="pre">on_line()</span></code> here is appropriate as it provides the event handler a chance to work on the previous binding.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AssignmentTracker</span><span class="p">(</span><span class="n">AssignmentTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">cxt</span><span class="p">,</span> <span class="n">my_vars</span><span class="p">):</span>
        <span class="n">my_vars</span> <span class="o">=</span> <span class="n">cxt</span><span class="o">.</span><span class="n">parameters</span><span class="p">(</span><span class="n">my_vars</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_assignments</span><span class="o">.</span><span class="n">method_enter</span><span class="p">(</span><span class="n">cxt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">(</span><span class="n">my_vars</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">cxt</span><span class="p">,</span> <span class="n">my_vars</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_assignments</span><span class="o">.</span><span class="n">method_statement</span><span class="p">(</span><span class="n">cxt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">(</span><span class="n">my_vars</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_return</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">cxt</span><span class="p">,</span> <span class="n">my_vars</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_line</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">cxt</span><span class="p">,</span> <span class="n">my_vars</span><span class="p">)</span>
        <span class="n">my_vars</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;&lt;-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cxt</span><span class="o">.</span><span class="n">method</span><span class="p">:</span> <span class="n">arg</span><span class="p">}</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_return</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_assignments</span><span class="o">.</span><span class="n">method_exit</span><span class="p">(</span><span class="n">cxt</span><span class="p">,</span> <span class="n">my_vars</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">cxt</span><span class="p">,</span> <span class="n">my_vara</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">track_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">cxt</span><span class="p">,</span> <span class="n">my_vars</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span> <span class="o">=</span> <span class="n">event</span>
        <span class="n">dispatch</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;call&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_call</span><span class="p">,</span>
            <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_return</span><span class="p">,</span>
            <span class="s1">&#39;line&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_line</span><span class="p">,</span>
            <span class="s1">&#39;exception&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_exception</span>
        <span class="p">}</span>
        <span class="n">dispatch</span><span class="p">[</span><span class="n">event</span><span class="p">](</span><span class="n">arg</span><span class="p">,</span> <span class="n">cxt</span><span class="p">,</span> <span class="n">my_vars</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can now use <code class="docutils literal notranslate"><span class="pre">AssignmentTracker</span></code> to track the different variables. To verify that our variable line number inference works, we recover definitions from the functions <code class="docutils literal notranslate"><span class="pre">A()</span></code>, <code class="docutils literal notranslate"><span class="pre">B()</span></code> and <code class="docutils literal notranslate"><span class="pre">C()</span></code> (with data annotations removed so that the input fragments are correctly identified).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="n">cp_1</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="n">c_2</span> <span class="o">=</span> <span class="n">cp_1</span>
    <span class="n">c_3</span> <span class="o">=</span> <span class="n">c_2</span>
    <span class="k">return</span> <span class="n">c_3</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">B</span><span class="p">(</span><span class="n">bp_7</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="n">b_8</span> <span class="o">=</span> <span class="n">bp_7</span>
    <span class="k">return</span> <span class="n">C</span><span class="p">(</span><span class="n">b_8</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">A</span><span class="p">(</span><span class="n">ap_12</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="n">a_13</span> <span class="o">=</span> <span class="n">ap_12</span>
    <span class="n">a_14</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">a_13</span><span class="p">)</span>
    <span class="n">a_14</span> <span class="o">=</span> <span class="n">a_14</span>
    <span class="n">a_13</span> <span class="o">=</span> <span class="n">a_14</span>
    <span class="n">a_14</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">a_13</span><span class="p">)</span>
    <span class="n">a_14</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">a_14</span><span class="p">)[</span><span class="mi">3</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<p>Running <code class="docutils literal notranslate"><span class="pre">A()</span></code> with sufficient input.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Tracer</span><span class="p">(</span><span class="s1">&#39;---xxx&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">A</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">)</span>
<span class="n">tracker</span> <span class="o">=</span> <span class="n">AssignmentTracker</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="n">tracer</span><span class="o">.</span><span class="n">trace</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tracker</span><span class="o">.</span><span class="n">my_assignments</span><span class="o">.</span><span class="n">seq_vars</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
<span class="nb">print</span><span class="p">()</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tracker</span><span class="o">.</span><span class="n">my_assignments</span><span class="o">.</span><span class="n">defined_vars</span><span class="p">(</span><span class="n">formatted</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ap_12@1:1 = &#39;---xxx&#39;
a_13@2:1 = &#39;---xxx&#39;
bp_7@1:1 = &#39;---xxx&#39;
b_8@2:1 = &#39;---xxx&#39;
cp_1@1:1 = &#39;---xxx&#39;
c_2@2:1 = &#39;---xxx&#39;
c_3@3:1 = &#39;---xxx&#39;
a_14@3:1 = &#39;---xxx&#39;
a_14@7:2 = &#39;xxx&#39;

ap_12@1 = &#39;---xxx&#39;
a_13@2 = &#39;---xxx&#39;
bp_7@1 = &#39;---xxx&#39;
b_8@2 = &#39;---xxx&#39;
cp_1@1 = &#39;---xxx&#39;
c_2@2 = &#39;---xxx&#39;
c_3@3 = &#39;---xxx&#39;
a_14@3 = &#39;---xxx&#39;
a_14@7 = &#39;xxx&#39;
</pre></div>
</div>
</div>
</div>
<p>As can be seen, the line numbers are now correctly identified for each variable.</p>
<p>Let us try retrieving the assignments for a real world example.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">traces</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">inputstr</span> <span class="ow">in</span> <span class="n">URLS_X</span><span class="p">:</span>
    <span class="n">clear_cache</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">Tracer</span><span class="p">(</span><span class="n">inputstr</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;urllib/parse.py&#39;</span><span class="p">])</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
        <span class="n">urlparse</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">)</span>
    <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="n">tracer</span><span class="o">.</span><span class="n">trace</span><span class="p">))</span>

    <span class="n">tracker</span> <span class="o">=</span> <span class="n">AssignmentTracker</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="n">tracer</span><span class="o">.</span><span class="n">trace</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tracker</span><span class="o">.</span><span class="n">my_assignments</span><span class="o">.</span><span class="n">defined_vars</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>url@374 = &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;
url@509 = &#39;//user:pass@www.google.com:80/?q=path#ref&#39;
scheme@509 = &#39;http&#39;
url@511 = &#39;/?q=path#ref&#39;
netloc@511 = &#39;user:pass@www.google.com:80&#39;
url@518 = &#39;/?q=path&#39;
fragment@518 = &#39;ref&#39;
query@520 = &#39;q=path&#39;
url@395 = &#39;http://user:pass@www.google.com:80/?q=path#ref&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>url@374 = &#39;https://www.cispa.saarland:80/&#39;
url@509 = &#39;//www.cispa.saarland:80/&#39;
scheme@509 = &#39;https&#39;
netloc@511 = &#39;www.cispa.saarland:80&#39;
url@395 = &#39;https://www.cispa.saarland:80/&#39;

url@374 = &#39;http://www.fuzzingbook.org/#News&#39;
url@509 = &#39;//www.fuzzingbook.org/#News&#39;
scheme@509 = &#39;http&#39;
url@511 = &#39;/#News&#39;
netloc@511 = &#39;www.fuzzingbook.org&#39;
fragment@518 = &#39;News&#39;
url@395 = &#39;http://www.fuzzingbook.org/#News&#39;

url@374 = &#39;ftp://freebsd.org/releases/5.8&#39;
url@509 = &#39;//freebsd.org/releases/5.8&#39;
scheme@509 = &#39;ftp&#39;
url@511 = &#39;/releases/5.8&#39;
netloc@511 = &#39;freebsd.org&#39;
url@395 = &#39;ftp://freebsd.org/releases/5.8&#39;
url@396 = &#39;/releases/5.8&#39;
</pre></div>
</div>
</div>
</div>
<p>The line numbers of variables can be verified from the source code of <a class="reference external" href="https://github.com/python/cpython/blob/3.6/Lib/urllib/parse.py">urllib/parse.py</a>.</p>
</section>
<section id="recovering-a-derivation-tree">
<h3>Recovering a Derivation Tree<a class="headerlink" href="#recovering-a-derivation-tree" title="Link to this heading">#</a></h3>
<p>Does handling variable reassignments help with our URL examples? We look at these next.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TreeMiner</span><span class="p">(</span><span class="n">TreeMiner</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_derivation_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="p">(</span><span class="n">START_SYMBOL</span><span class="p">,</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="p">[])])</span>
        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_assignments</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_new_definition</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tree</span>
</pre></div>
</div>
</div>
</div>
<section id="example-1-recovering-url-derivation-tree">
<h4>Example 1: Recovering URL Derivation Tree<a class="headerlink" href="#example-1-recovering-url-derivation-tree" title="Link to this heading">#</a></h4>
<p>First we obtain the derivation tree of the URL 1</p>
<section id="url-1-derivation-tree">
<h5>URL 1 derivation tree<a class="headerlink" href="#url-1-derivation-tree" title="Link to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clear_cache</span><span class="p">()</span>
<span class="k">with</span> <span class="n">Tracer</span><span class="p">(</span><span class="n">URLS_X</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">files</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;urllib/parse.py&#39;</span><span class="p">])</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">urlparse</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">)</span>
<span class="n">sm</span> <span class="o">=</span> <span class="n">AssignmentTracker</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="n">tracer</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">TreeMiner</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="n">sm</span><span class="o">.</span><span class="n">my_assignments</span><span class="o">.</span><span class="n">defined_vars</span><span class="p">())</span>
<span class="n">display_tree</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/78435a714fe348c5741cd535d29bd7b6ba24b960f65a558187d73e24dec7218f.svg" src="_images/78435a714fe348c5741cd535d29bd7b6ba24b960f65a558187d73e24dec7218f.svg" />
</div>
</div>
<p>Next, we obtain the derivation tree of URL 4</p>
</section>
<section id="url-4-derivation-tree">
<h5>URL 4 derivation tree<a class="headerlink" href="#url-4-derivation-tree" title="Link to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clear_cache</span><span class="p">()</span>
<span class="k">with</span> <span class="n">Tracer</span><span class="p">(</span><span class="n">URLS_X</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">files</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;urllib/parse.py&#39;</span><span class="p">])</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">urlparse</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">)</span>
<span class="n">sm</span> <span class="o">=</span> <span class="n">AssignmentTracker</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="n">tracer</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">TreeMiner</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="n">sm</span><span class="o">.</span><span class="n">my_assignments</span><span class="o">.</span><span class="n">defined_vars</span><span class="p">())</span>
<span class="n">display_tree</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/19959811d51de006385b02a41d362b8872341497a9d5898238ec63e0b3fdd157.svg" src="_images/19959811d51de006385b02a41d362b8872341497a9d5898238ec63e0b3fdd157.svg" />
</div>
</div>
<p>The derivation trees seem to belong to the same grammar. Hence, we obtain the grammar for the complete set. First, we update the <code class="docutils literal notranslate"><span class="pre">recover_grammar()</span></code> to use <code class="docutils literal notranslate"><span class="pre">AssignTracker</span></code>.</p>
</section>
</section>
</section>
<section id="recover-grammar">
<h3>Recover Grammar<a class="headerlink" href="#recover-grammar" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">GrammarMiner</span><span class="p">(</span><span class="n">GrammarMiner</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputstr</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_tracker</span><span class="p">(</span><span class="n">inputstr</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_tree_miner</span><span class="p">(</span><span class="n">inputstr</span><span class="p">,</span> <span class="n">at</span><span class="o">.</span><span class="n">my_assignments</span><span class="o">.</span><span class="n">defined_vars</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_tree</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_tracker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">AssignmentTracker</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_tree_miner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TreeMiner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we use the modified <code class="docutils literal notranslate"><span class="pre">recover_grammar()</span></code> on derivation trees obtained from URLs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url_grammar</span> <span class="o">=</span> <span class="n">recover_grammar</span><span class="p">(</span><span class="n">url_parse</span><span class="p">,</span> <span class="n">URLS_X</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;urllib/parse.py&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>The recovered grammar is below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">syntax_diagram</span><span class="p">(</span><span class="n">url_grammar</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>start
</pre></div>
</div>
<img alt="_images/561a4a4f09dfebd93543f9e69f474184b8089ddb0e6845f3d3537c1ae95bd40a.svg" src="_images/561a4a4f09dfebd93543f9e69f474184b8089ddb0e6845f3d3537c1ae95bd40a.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>url@374
</pre></div>
</div>
<img alt="_images/174b617772321b570fa587ac8589757f42f689fb2c5c679b7de604c62f170c9a.svg" src="_images/174b617772321b570fa587ac8589757f42f689fb2c5c679b7de604c62f170c9a.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>scheme@509
</pre></div>
</div>
<img alt="_images/4b0db156a45750f69822d33089f76cf81a73e0a45f8151652b9cbcd0c2af6dba.svg" src="_images/4b0db156a45750f69822d33089f76cf81a73e0a45f8151652b9cbcd0c2af6dba.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>url@509
</pre></div>
</div>
<img alt="_images/693445b46455eb2748f2e1e44329fd69561e9065f9d77edb09f4aab40be5cfe1.svg" src="_images/693445b46455eb2748f2e1e44329fd69561e9065f9d77edb09f4aab40be5cfe1.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>netloc@511
</pre></div>
</div>
<img alt="_images/44230824aadb05bf7b7a30c3c8796c9c697bf5d43dbac7a93a3ca48978ecd7bc.svg" src="_images/44230824aadb05bf7b7a30c3c8796c9c697bf5d43dbac7a93a3ca48978ecd7bc.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>url@511
</pre></div>
</div>
<img alt="_images/c22364289f15afcfac701eed853adb8f76f7a3864efcff3b37e19f95382c5dc4.svg" src="_images/c22364289f15afcfac701eed853adb8f76f7a3864efcff3b37e19f95382c5dc4.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>url@518
</pre></div>
</div>
<img alt="_images/27838f329801c8ada1ad1bc2dc7e3d454260594a0f634ac76d215a6c2d879e3c.svg" src="_images/27838f329801c8ada1ad1bc2dc7e3d454260594a0f634ac76d215a6c2d879e3c.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>query@520
</pre></div>
</div>
<img alt="_images/de5ded46744e5b7c67e252ef1e6584905ae59e3a3258135bbbcf6d2489bc30e1.svg" src="_images/de5ded46744e5b7c67e252ef1e6584905ae59e3a3258135bbbcf6d2489bc30e1.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fragment@518
</pre></div>
</div>
<img alt="_images/b1807127561ada743af29d4ef4cf46599809761428c1f041734488b36269fe20.svg" src="_images/b1807127561ada743af29d4ef4cf46599809761428c1f041734488b36269fe20.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>url@396
</pre></div>
</div>
<img alt="_images/1b3d67af485704bbc0825b2f527a52b29594985a73b8b83974db760124476ea1.svg" src="_images/1b3d67af485704bbc0825b2f527a52b29594985a73b8b83974db760124476ea1.svg" />
</div>
</div>
<p>Let us fuzz a little to see if the produced values are sane.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">url_grammar</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>https://user:pass@www.google.com:80/#ref
ftp://www.fuzzingbook.org/
ftp://www.cispa.saarland:80/releases/5.8
https://freebsd.org/
ftp://user:pass@www.google.com:80/releases/5.8
https://www.cispa.saarland:80/
https://www.fuzzingbook.org/releases/5.8
http://freebsd.org/
http://freebsd.org/
ftp://www.fuzzingbook.org/
</pre></div>
</div>
</div>
</div>
<p>Our modifications do seem to help. Next, we check whether we can still retrieve the grammar for inventory.</p>
<section id="example-2-recovering-inventory-grammar">
<h4>Example 2: Recovering Inventory Grammar<a class="headerlink" href="#example-2-recovering-inventory-grammar" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inventory_grammar</span> <span class="o">=</span> <span class="n">recover_grammar</span><span class="p">(</span><span class="n">process_vehicle</span><span class="p">,</span> <span class="n">VEHICLES</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">syntax_diagram</span><span class="p">(</span><span class="n">inventory_grammar</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>start
</pre></div>
</div>
<img alt="_images/c551032741244dd4408688e220e893f6d4c1080f656391aa185f18c6fd4b76ae.svg" src="_images/c551032741244dd4408688e220e893f6d4c1080f656391aa185f18c6fd4b76ae.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>vehicle@29
</pre></div>
</div>
<img alt="_images/f5ef0fd8b9b018d87b993bc916bc96651e7a608deb31dffdbd7e42cacd385263.svg" src="_images/f5ef0fd8b9b018d87b993bc916bc96651e7a608deb31dffdbd7e42cacd385263.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>year@30
</pre></div>
</div>
<img alt="_images/c249ec4ab4606e5b0571d2800d84bacff0a1171a57b7dd77674c8759ef16af57.svg" src="_images/c249ec4ab4606e5b0571d2800d84bacff0a1171a57b7dd77674c8759ef16af57.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kind@30
</pre></div>
</div>
<img alt="_images/d6a1f534cf99e7dc5738dfbb392886c1fe95da23c0341c7456c6c4736711c80e.svg" src="_images/d6a1f534cf99e7dc5738dfbb392886c1fe95da23c0341c7456c6c4736711c80e.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>company@30
</pre></div>
</div>
<img alt="_images/7cb050d423aa105091f207ab988949dcdc12a7c0dd6d684c893b7bfde2a44bf3.svg" src="_images/7cb050d423aa105091f207ab988949dcdc12a7c0dd6d684c893b7bfde2a44bf3.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>model@30
</pre></div>
</div>
<img alt="_images/27fbf9db6711e1282b0b07762acf3beee370008b436c79aa8685803f42ad853b.svg" src="_images/27fbf9db6711e1282b0b07762acf3beee370008b436c79aa8685803f42ad853b.svg" />
</div>
</div>
<p>Using fuzzing to produce values from the grammar.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">inventory_grammar</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2000,car,Chevy,E350
2000,car,Mercury,Venture
2000,car,Ford,Cougar
1997,van,Chevy,E350
1999,car,Ford,Cougar
1999,van,Chevy,Venture
1999,car,Ford,Cougar
1997,car,Chevy,Venture
2000,car,Chevy,Cougar
2000,car,Mercury,Venture
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="problems-with-the-grammar-miner-with-reassignment">
<h3>Problems with the Grammar Miner with Reassignment<a class="headerlink" href="#problems-with-the-grammar-miner-with-reassignment" title="Link to this heading">#</a></h3>
<p>One of the problems with our grammar miner is that it doesn’t yet account for the current context. That is, when replacing, a variable can replace tokens that it does not have access to (and hence, it is not a fragment of). Consider this example.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Tracer</span><span class="p">(</span><span class="n">INVENTORY</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">process_inventory</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">)</span>
<span class="n">sm</span> <span class="o">=</span> <span class="n">AssignmentTracker</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="n">tracer</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">TreeMiner</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="n">sm</span><span class="o">.</span><span class="n">my_assignments</span><span class="o">.</span><span class="n">defined_vars</span><span class="p">())</span>
<span class="n">display_tree</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">tree</span><span class="p">,</span> <span class="n">graph_attr</span><span class="o">=</span><span class="n">lr_graph</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2a1d102ba7eb7c4030353fe8a891bb770868d4c862977e780e3c2151f65e3c48.svg" src="_images/2a1d102ba7eb7c4030353fe8a891bb770868d4c862977e780e3c2151f65e3c48.svg" />
</div>
</div>
<p>As can be seen, the derivation tree obtained is not quite what we expected. The issue is easily seen if we enable logging in the <code class="docutils literal notranslate"><span class="pre">TreeMiner</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dt</span> <span class="o">=</span> <span class="n">TreeMiner</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="n">sm</span><span class="o">.</span><span class="n">my_assignments</span><span class="o">.</span><span class="n">defined_vars</span><span class="p">(),</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> inventory@22=&#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;
	 - Node: &lt;start&gt;		? (&lt;inventory@22&gt;:&#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;)
		 -&gt; [0] &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;
		  &gt; [&#39;&lt;inventory@22&gt;&#39;]
 vehicle@24=&#39;1997,van,Ford,E350&#39;
	 - Node: &lt;start&gt;		? (&lt;vehicle@24&gt;:&#39;1997,van,Ford,E350&#39;)
		 -&gt; [0] &#39;&lt;inventory@22&gt;&#39;
	 - Node: &lt;inventory@22&gt;		? (&lt;vehicle@24&gt;:&#39;1997,van,Ford,E350&#39;)
		 -&gt; [0] &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;
		  &gt; [&#39;&lt;vehicle@24&gt;&#39;, &#39;\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;]
 year@30=&#39;1997&#39;
	 - Node: &lt;start&gt;		? (&lt;year@30&gt;:&#39;1997&#39;)
		 -&gt; [0] &#39;&lt;inventory@22&gt;&#39;
	 - Node: &lt;inventory@22&gt;		? (&lt;year@30&gt;:&#39;1997&#39;)
		 -&gt; [0] &#39;&lt;vehicle@24&gt;&#39;
	 - Node: &lt;vehicle@24&gt;		? (&lt;year@30&gt;:&#39;1997&#39;)
		 -&gt; [0] &#39;1997,van,Ford,E350&#39;
		  &gt; [&#39;&lt;year@30&gt;&#39;, &#39;,van,Ford,E350&#39;]
 kind@30=&#39;van&#39;
	 - Node: &lt;start&gt;		? (&lt;kind@30&gt;:&#39;van&#39;)
		 -&gt; [0] &#39;&lt;inventory@22&gt;&#39;
	 - Node: &lt;inventory@22&gt;		? (&lt;kind@30&gt;:&#39;van&#39;)
		 -&gt; [0] &#39;&lt;vehicle@24&gt;&#39;
	 - Node: &lt;vehicle@24&gt;		? (&lt;kind@30&gt;:&#39;van&#39;)
		 -&gt; [0] &#39;&lt;year@30&gt;&#39;
	 - Node: &lt;year@30&gt;		? (&lt;kind@30&gt;:&#39;van&#39;)
		 -&gt; [0] &#39;1997&#39;
		 -&gt; [1] &#39;,van,Ford,E350&#39;
		  &gt; [&#39;,&#39;, &#39;&lt;kind@30&gt;&#39;, &#39;,Ford,E350&#39;]
 company@30=&#39;Ford&#39;
	 - Node: &lt;start&gt;		? (&lt;company@30&gt;:&#39;Ford&#39;)
		 -&gt; [0] &#39;&lt;inventory@22&gt;&#39;
	 - Node: &lt;inventory@22&gt;		? (&lt;company@30&gt;:&#39;Ford&#39;)
		 -&gt; [0] &#39;&lt;vehicle@24&gt;&#39;
	 - Node: &lt;vehicle@24&gt;		? (&lt;company@30&gt;:&#39;Ford&#39;)
		 -&gt; [0] &#39;&lt;year@30&gt;&#39;
	 - Node: &lt;year@30&gt;		? (&lt;company@30&gt;:&#39;Ford&#39;)
		 -&gt; [0] &#39;1997&#39;
		 -&gt; [1] &#39;,&#39;
		 -&gt; [2] &#39;&lt;kind@30&gt;&#39;
	 - Node: &lt;kind@30&gt;		? (&lt;company@30&gt;:&#39;Ford&#39;)
		 -&gt; [0] &#39;van&#39;
		 -&gt; [3] &#39;,Ford,E350&#39;
		  &gt; [&#39;,&#39;, &#39;&lt;company@30&gt;&#39;, &#39;,E350&#39;]
 model@30=&#39;E350&#39;
	 - Node: &lt;start&gt;		? (&lt;model@30&gt;:&#39;E350&#39;)
		 -&gt; [0] &#39;&lt;inventory@22&gt;&#39;
	 - Node: &lt;inventory@22&gt;		? (&lt;model@30&gt;:&#39;E350&#39;)
		 -&gt; [0] &#39;&lt;vehicle@24&gt;&#39;
	 - Node: &lt;vehicle@24&gt;		? (&lt;model@30&gt;:&#39;E350&#39;)
		 -&gt; [0] &#39;&lt;year@30&gt;&#39;
	 - Node: &lt;year@30&gt;		? (&lt;model@30&gt;:&#39;E350&#39;)
		 -&gt; [0] &#39;1997&#39;
		 -&gt; [1] &#39;,&#39;
		 -&gt; [2] &#39;&lt;kind@30&gt;&#39;
	 - Node: &lt;kind@30&gt;		? (&lt;model@30&gt;:&#39;E350&#39;)
		 -&gt; [0] &#39;van&#39;
		 -&gt; [3] &#39;,&#39;
		 -&gt; [4] &#39;&lt;company@30&gt;&#39;
	 - Node: &lt;company@30&gt;		? (&lt;model@30&gt;:&#39;E350&#39;)
		 -&gt; [0] &#39;Ford&#39;
		 -&gt; [5] &#39;,E350&#39;
		  &gt; [&#39;,&#39;, &#39;&lt;model@30&gt;&#39;]
 vehicle@24=&#39;2000,car,Mercury,Cougar&#39;
	 - Node: &lt;start&gt;		? (&lt;vehicle@24&gt;:&#39;2000,car,Mercury,Cougar&#39;)
		 -&gt; [0] &#39;&lt;inventory@22&gt;&#39;
	 - Node: &lt;inventory@22&gt;		? (&lt;vehicle@24&gt;:&#39;2000,car,Mercury,Cougar&#39;)
		 -&gt; [0] &#39;&lt;vehicle@24&gt;&#39;
	 - Node: &lt;vehicle@24&gt;		? (&lt;vehicle@24&gt;:&#39;2000,car,Mercury,Cougar&#39;)
		 -&gt; [0] &#39;&lt;year@30&gt;&#39;
	 - Node: &lt;year@30&gt;		? (&lt;vehicle@24&gt;:&#39;2000,car,Mercury,Cougar&#39;)
		 -&gt; [0] &#39;1997&#39;
		 -&gt; [1] &#39;,&#39;
		 -&gt; [2] &#39;&lt;kind@30&gt;&#39;
	 - Node: &lt;kind@30&gt;		? (&lt;vehicle@24&gt;:&#39;2000,car,Mercury,Cougar&#39;)
		 -&gt; [0] &#39;van&#39;
		 -&gt; [3] &#39;,&#39;
		 -&gt; [4] &#39;&lt;company@30&gt;&#39;
	 - Node: &lt;company@30&gt;		? (&lt;vehicle@24&gt;:&#39;2000,car,Mercury,Cougar&#39;)
		 -&gt; [0] &#39;Ford&#39;
		 -&gt; [5] &#39;,&#39;
		 -&gt; [6] &#39;&lt;model@30&gt;&#39;
	 - Node: &lt;model@30&gt;		? (&lt;vehicle@24&gt;:&#39;2000,car,Mercury,Cougar&#39;)
		 -&gt; [0] &#39;E350&#39;
		 -&gt; [1] &#39;\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;
		  &gt; [&#39;\n&#39;, &#39;&lt;vehicle@24&gt;&#39;, &#39;\n1999,car,Chevy,Venture&#39;]
 year@30=&#39;2000&#39;
	 - Node: &lt;start&gt;		? (&lt;year@30&gt;:&#39;2000&#39;)
		 -&gt; [0] &#39;&lt;inventory@22&gt;&#39;
	 - Node: &lt;inventory@22&gt;		? (&lt;year@30&gt;:&#39;2000&#39;)
		 -&gt; [0] &#39;&lt;vehicle@24&gt;&#39;
	 - Node: &lt;vehicle@24&gt;		? (&lt;year@30&gt;:&#39;2000&#39;)
		 -&gt; [0] &#39;&lt;year@30&gt;&#39;
	 - Node: &lt;year@30&gt;		? (&lt;year@30&gt;:&#39;2000&#39;)
		 -&gt; [0] &#39;1997&#39;
		 -&gt; [1] &#39;,&#39;
		 -&gt; [2] &#39;&lt;kind@30&gt;&#39;
	 - Node: &lt;kind@30&gt;		? (&lt;year@30&gt;:&#39;2000&#39;)
		 -&gt; [0] &#39;van&#39;
		 -&gt; [3] &#39;,&#39;
		 -&gt; [4] &#39;&lt;company@30&gt;&#39;
	 - Node: &lt;company@30&gt;		? (&lt;year@30&gt;:&#39;2000&#39;)
		 -&gt; [0] &#39;Ford&#39;
		 -&gt; [5] &#39;,&#39;
		 -&gt; [6] &#39;&lt;model@30&gt;&#39;
	 - Node: &lt;model@30&gt;		? (&lt;year@30&gt;:&#39;2000&#39;)
		 -&gt; [0] &#39;E350&#39;
		 -&gt; [1] &#39;\n&#39;
		 -&gt; [2] &#39;&lt;vehicle@24&gt;&#39;
	 - Node: &lt;vehicle@24&gt;		? (&lt;year@30&gt;:&#39;2000&#39;)
		 -&gt; [0] &#39;2000,car,Mercury,Cougar&#39;
		  &gt; [&#39;&lt;year@30&gt;&#39;, &#39;,car,Mercury,Cougar&#39;]
 kind@30=&#39;car&#39;
	 - Node: &lt;start&gt;		? (&lt;kind@30&gt;:&#39;car&#39;)
		 -&gt; [0] &#39;&lt;inventory@22&gt;&#39;
	 - Node: &lt;inventory@22&gt;		? (&lt;kind@30&gt;:&#39;car&#39;)
		 -&gt; [0] &#39;&lt;vehicle@24&gt;&#39;
	 - Node: &lt;vehicle@24&gt;		? (&lt;kind@30&gt;:&#39;car&#39;)
		 -&gt; [0] &#39;&lt;year@30&gt;&#39;
	 - Node: &lt;year@30&gt;		? (&lt;kind@30&gt;:&#39;car&#39;)
		 -&gt; [0] &#39;1997&#39;
		 -&gt; [1] &#39;,&#39;
		 -&gt; [2] &#39;&lt;kind@30&gt;&#39;
	 - Node: &lt;kind@30&gt;		? (&lt;kind@30&gt;:&#39;car&#39;)
		 -&gt; [0] &#39;van&#39;
		 -&gt; [3] &#39;,&#39;
		 -&gt; [4] &#39;&lt;company@30&gt;&#39;
	 - Node: &lt;company@30&gt;		? (&lt;kind@30&gt;:&#39;car&#39;)
		 -&gt; [0] &#39;Ford&#39;
		 -&gt; [5] &#39;,&#39;
		 -&gt; [6] &#39;&lt;model@30&gt;&#39;
	 - Node: &lt;model@30&gt;		? (&lt;kind@30&gt;:&#39;car&#39;)
		 -&gt; [0] &#39;E350&#39;
		 -&gt; [1] &#39;\n&#39;
		 -&gt; [2] &#39;&lt;vehicle@24&gt;&#39;
	 - Node: &lt;vehicle@24&gt;		? (&lt;kind@30&gt;:&#39;car&#39;)
		 -&gt; [0] &#39;&lt;year@30&gt;&#39;
	 - Node: &lt;year@30&gt;		? (&lt;kind@30&gt;:&#39;car&#39;)
		 -&gt; [0] &#39;2000&#39;
		 -&gt; [1] &#39;,car,Mercury,Cougar&#39;
		  &gt; [&#39;,&#39;, &#39;&lt;kind@30&gt;&#39;, &#39;,Mercury,Cougar&#39;]
 company@30=&#39;Mercury&#39;
	 - Node: &lt;start&gt;		? (&lt;company@30&gt;:&#39;Mercury&#39;)
		 -&gt; [0] &#39;&lt;inventory@22&gt;&#39;
	 - Node: &lt;inventory@22&gt;		? (&lt;company@30&gt;:&#39;Mercury&#39;)
		 -&gt; [0] &#39;&lt;vehicle@24&gt;&#39;
	 - Node: &lt;vehicle@24&gt;		? (&lt;company@30&gt;:&#39;Mercury&#39;)
		 -&gt; [0] &#39;&lt;year@30&gt;&#39;
	 - Node: &lt;year@30&gt;		? (&lt;company@30&gt;:&#39;Mercury&#39;)
		 -&gt; [0] &#39;1997&#39;
		 -&gt; [1] &#39;,&#39;
		 -&gt; [2] &#39;&lt;kind@30&gt;&#39;
	 - Node: &lt;kind@30&gt;		? (&lt;company@30&gt;:&#39;Mercury&#39;)
		 -&gt; [0] &#39;van&#39;
		 -&gt; [3] &#39;,&#39;
		 -&gt; [4] &#39;&lt;company@30&gt;&#39;
	 - Node: &lt;company@30&gt;		? (&lt;company@30&gt;:&#39;Mercury&#39;)
		 -&gt; [0] &#39;Ford&#39;
		 -&gt; [5] &#39;,&#39;
		 -&gt; [6] &#39;&lt;model@30&gt;&#39;
	 - Node: &lt;model@30&gt;		? (&lt;company@30&gt;:&#39;Mercury&#39;)
		 -&gt; [0] &#39;E350&#39;
		 -&gt; [1] &#39;\n&#39;
		 -&gt; [2] &#39;&lt;vehicle@24&gt;&#39;
	 - Node: &lt;vehicle@24&gt;		? (&lt;company@30&gt;:&#39;Mercury&#39;)
		 -&gt; [0] &#39;&lt;year@30&gt;&#39;
	 - Node: &lt;year@30&gt;		? (&lt;company@30&gt;:&#39;Mercury&#39;)
		 -&gt; [0] &#39;2000&#39;
		 -&gt; [1] &#39;,&#39;
		 -&gt; [2] &#39;&lt;kind@30&gt;&#39;
	 - Node: &lt;kind@30&gt;		? (&lt;company@30&gt;:&#39;Mercury&#39;)
		 -&gt; [0] &#39;car&#39;
		 -&gt; [3] &#39;,Mercury,Cougar&#39;
		  &gt; [&#39;,&#39;, &#39;&lt;company@30&gt;&#39;, &#39;,Cougar&#39;]
 model@30=&#39;Cougar&#39;
	 - Node: &lt;start&gt;		? (&lt;model@30&gt;:&#39;Cougar&#39;)
		 -&gt; [0] &#39;&lt;inventory@22&gt;&#39;
	 - Node: &lt;inventory@22&gt;		? (&lt;model@30&gt;:&#39;Cougar&#39;)
		 -&gt; [0] &#39;&lt;vehicle@24&gt;&#39;
	 - Node: &lt;vehicle@24&gt;		? (&lt;model@30&gt;:&#39;Cougar&#39;)
		 -&gt; [0] &#39;&lt;year@30&gt;&#39;
	 - Node: &lt;year@30&gt;		? (&lt;model@30&gt;:&#39;Cougar&#39;)
		 -&gt; [0] &#39;1997&#39;
		 -&gt; [1] &#39;,&#39;
		 -&gt; [2] &#39;&lt;kind@30&gt;&#39;
	 - Node: &lt;kind@30&gt;		? (&lt;model@30&gt;:&#39;Cougar&#39;)
		 -&gt; [0] &#39;van&#39;
		 -&gt; [3] &#39;,&#39;
		 -&gt; [4] &#39;&lt;company@30&gt;&#39;
	 - Node: &lt;company@30&gt;		? (&lt;model@30&gt;:&#39;Cougar&#39;)
		 -&gt; [0] &#39;Ford&#39;
		 -&gt; [5] &#39;,&#39;
		 -&gt; [6] &#39;&lt;model@30&gt;&#39;
	 - Node: &lt;model@30&gt;		? (&lt;model@30&gt;:&#39;Cougar&#39;)
		 -&gt; [0] &#39;E350&#39;
		 -&gt; [1] &#39;\n&#39;
		 -&gt; [2] &#39;&lt;vehicle@24&gt;&#39;
	 - Node: &lt;vehicle@24&gt;		? (&lt;model@30&gt;:&#39;Cougar&#39;)
		 -&gt; [0] &#39;&lt;year@30&gt;&#39;
	 - Node: &lt;year@30&gt;		? (&lt;model@30&gt;:&#39;Cougar&#39;)
		 -&gt; [0] &#39;2000&#39;
		 -&gt; [1] &#39;,&#39;
		 -&gt; [2] &#39;&lt;kind@30&gt;&#39;
	 - Node: &lt;kind@30&gt;		? (&lt;model@30&gt;:&#39;Cougar&#39;)
		 -&gt; [0] &#39;car&#39;
		 -&gt; [3] &#39;,&#39;
		 -&gt; [4] &#39;&lt;company@30&gt;&#39;
	 - Node: &lt;company@30&gt;		? (&lt;model@30&gt;:&#39;Cougar&#39;)
		 -&gt; [0] &#39;Mercury&#39;
		 -&gt; [5] &#39;,Cougar&#39;
		  &gt; [&#39;,&#39;, &#39;&lt;model@30&gt;&#39;]
 vehicle@24=&#39;1999,car,Chevy,Venture&#39;
	 - Node: &lt;start&gt;		? (&lt;vehicle@24&gt;:&#39;1999,car,Chevy,Venture&#39;)
		 -&gt; [0] &#39;&lt;inventory@22&gt;&#39;
	 - Node: &lt;inventory@22&gt;		? (&lt;vehicle@24&gt;:&#39;1999,car,Chevy,Venture&#39;)
		 -&gt; [0] &#39;&lt;vehicle@24&gt;&#39;
	 - Node: &lt;vehicle@24&gt;		? (&lt;vehicle@24&gt;:&#39;1999,car,Chevy,Venture&#39;)
		 -&gt; [0] &#39;&lt;year@30&gt;&#39;
	 - Node: &lt;year@30&gt;		? (&lt;vehicle@24&gt;:&#39;1999,car,Chevy,Venture&#39;)
		 -&gt; [0] &#39;1997&#39;
		 -&gt; [1] &#39;,&#39;
		 -&gt; [2] &#39;&lt;kind@30&gt;&#39;
	 - Node: &lt;kind@30&gt;		? (&lt;vehicle@24&gt;:&#39;1999,car,Chevy,Venture&#39;)
		 -&gt; [0] &#39;van&#39;
		 -&gt; [3] &#39;,&#39;
		 -&gt; [4] &#39;&lt;company@30&gt;&#39;
	 - Node: &lt;company@30&gt;		? (&lt;vehicle@24&gt;:&#39;1999,car,Chevy,Venture&#39;)
		 -&gt; [0] &#39;Ford&#39;
		 -&gt; [5] &#39;,&#39;
		 -&gt; [6] &#39;&lt;model@30&gt;&#39;
	 - Node: &lt;model@30&gt;		? (&lt;vehicle@24&gt;:&#39;1999,car,Chevy,Venture&#39;)
		 -&gt; [0] &#39;E350&#39;
		 -&gt; [1] &#39;\n&#39;
		 -&gt; [2] &#39;&lt;vehicle@24&gt;&#39;
	 - Node: &lt;vehicle@24&gt;		? (&lt;vehicle@24&gt;:&#39;1999,car,Chevy,Venture&#39;)
		 -&gt; [0] &#39;&lt;year@30&gt;&#39;
	 - Node: &lt;year@30&gt;		? (&lt;vehicle@24&gt;:&#39;1999,car,Chevy,Venture&#39;)
		 -&gt; [0] &#39;2000&#39;
		 -&gt; [1] &#39;,&#39;
		 -&gt; [2] &#39;&lt;kind@30&gt;&#39;
	 - Node: &lt;kind@30&gt;		? (&lt;vehicle@24&gt;:&#39;1999,car,Chevy,Venture&#39;)
		 -&gt; [0] &#39;car&#39;
		 -&gt; [3] &#39;,&#39;
		 -&gt; [4] &#39;&lt;company@30&gt;&#39;
	 - Node: &lt;company@30&gt;		? (&lt;vehicle@24&gt;:&#39;1999,car,Chevy,Venture&#39;)
		 -&gt; [0] &#39;Mercury&#39;
		 -&gt; [5] &#39;,&#39;
		 -&gt; [6] &#39;&lt;model@30&gt;&#39;
	 - Node: &lt;model@30&gt;		? (&lt;vehicle@24&gt;:&#39;1999,car,Chevy,Venture&#39;)
		 -&gt; [0] &#39;Cougar&#39;
		 -&gt; [3] &#39;\n1999,car,Chevy,Venture&#39;
		  &gt; [&#39;\n&#39;, &#39;&lt;vehicle@24&gt;&#39;]
 year@30=&#39;1999&#39;
	 - Node: &lt;start&gt;		? (&lt;year@30&gt;:&#39;1999&#39;)
		 -&gt; [0] &#39;&lt;inventory@22&gt;&#39;
	 - Node: &lt;inventory@22&gt;		? (&lt;year@30&gt;:&#39;1999&#39;)
		 -&gt; [0] &#39;&lt;vehicle@24&gt;&#39;
	 - Node: &lt;vehicle@24&gt;		? (&lt;year@30&gt;:&#39;1999&#39;)
		 -&gt; [0] &#39;&lt;year@30&gt;&#39;
	 - Node: &lt;year@30&gt;		? (&lt;year@30&gt;:&#39;1999&#39;)
		 -&gt; [0] &#39;1997&#39;
		 -&gt; [1] &#39;,&#39;
		 -&gt; [2] &#39;&lt;kind@30&gt;&#39;
	 - Node: &lt;kind@30&gt;		? (&lt;year@30&gt;:&#39;1999&#39;)
		 -&gt; [0] &#39;van&#39;
		 -&gt; [3] &#39;,&#39;
		 -&gt; [4] &#39;&lt;company@30&gt;&#39;
	 - Node: &lt;company@30&gt;		? (&lt;year@30&gt;:&#39;1999&#39;)
		 -&gt; [0] &#39;Ford&#39;
		 -&gt; [5] &#39;,&#39;
		 -&gt; [6] &#39;&lt;model@30&gt;&#39;
	 - Node: &lt;model@30&gt;		? (&lt;year@30&gt;:&#39;1999&#39;)
		 -&gt; [0] &#39;E350&#39;
		 -&gt; [1] &#39;\n&#39;
		 -&gt; [2] &#39;&lt;vehicle@24&gt;&#39;
	 - Node: &lt;vehicle@24&gt;		? (&lt;year@30&gt;:&#39;1999&#39;)
		 -&gt; [0] &#39;&lt;year@30&gt;&#39;
	 - Node: &lt;year@30&gt;		? (&lt;year@30&gt;:&#39;1999&#39;)
		 -&gt; [0] &#39;2000&#39;
		 -&gt; [1] &#39;,&#39;
		 -&gt; [2] &#39;&lt;kind@30&gt;&#39;
	 - Node: &lt;kind@30&gt;		? (&lt;year@30&gt;:&#39;1999&#39;)
		 -&gt; [0] &#39;car&#39;
		 -&gt; [3] &#39;,&#39;
		 -&gt; [4] &#39;&lt;company@30&gt;&#39;
	 - Node: &lt;company@30&gt;		? (&lt;year@30&gt;:&#39;1999&#39;)
		 -&gt; [0] &#39;Mercury&#39;
		 -&gt; [5] &#39;,&#39;
		 -&gt; [6] &#39;&lt;model@30&gt;&#39;
	 - Node: &lt;model@30&gt;		? (&lt;year@30&gt;:&#39;1999&#39;)
		 -&gt; [0] &#39;Cougar&#39;
		 -&gt; [3] &#39;\n&#39;
		 -&gt; [4] &#39;&lt;vehicle@24&gt;&#39;
	 - Node: &lt;vehicle@24&gt;		? (&lt;year@30&gt;:&#39;1999&#39;)
		 -&gt; [0] &#39;1999,car,Chevy,Venture&#39;
		  &gt; [&#39;&lt;year@30&gt;&#39;, &#39;,car,Chevy,Venture&#39;]
 company@30=&#39;Chevy&#39;
	 - Node: &lt;start&gt;		? (&lt;company@30&gt;:&#39;Chevy&#39;)
		 -&gt; [0] &#39;&lt;inventory@22&gt;&#39;
	 - Node: &lt;inventory@22&gt;		? (&lt;company@30&gt;:&#39;Chevy&#39;)
		 -&gt; [0] &#39;&lt;vehicle@24&gt;&#39;
	 - Node: &lt;vehicle@24&gt;		? (&lt;company@30&gt;:&#39;Chevy&#39;)
		 -&gt; [0] &#39;&lt;year@30&gt;&#39;
	 - Node: &lt;year@30&gt;		? (&lt;company@30&gt;:&#39;Chevy&#39;)
		 -&gt; [0] &#39;1997&#39;
		 -&gt; [1] &#39;,&#39;
		 -&gt; [2] &#39;&lt;kind@30&gt;&#39;
	 - Node: &lt;kind@30&gt;		? (&lt;company@30&gt;:&#39;Chevy&#39;)
		 -&gt; [0] &#39;van&#39;
		 -&gt; [3] &#39;,&#39;
		 -&gt; [4] &#39;&lt;company@30&gt;&#39;
	 - Node: &lt;company@30&gt;		? (&lt;company@30&gt;:&#39;Chevy&#39;)
		 -&gt; [0] &#39;Ford&#39;
		 -&gt; [5] &#39;,&#39;
		 -&gt; [6] &#39;&lt;model@30&gt;&#39;
	 - Node: &lt;model@30&gt;		? (&lt;company@30&gt;:&#39;Chevy&#39;)
		 -&gt; [0] &#39;E350&#39;
		 -&gt; [1] &#39;\n&#39;
		 -&gt; [2] &#39;&lt;vehicle@24&gt;&#39;
	 - Node: &lt;vehicle@24&gt;		? (&lt;company@30&gt;:&#39;Chevy&#39;)
		 -&gt; [0] &#39;&lt;year@30&gt;&#39;
	 - Node: &lt;year@30&gt;		? (&lt;company@30&gt;:&#39;Chevy&#39;)
		 -&gt; [0] &#39;2000&#39;
		 -&gt; [1] &#39;,&#39;
		 -&gt; [2] &#39;&lt;kind@30&gt;&#39;
	 - Node: &lt;kind@30&gt;		? (&lt;company@30&gt;:&#39;Chevy&#39;)
		 -&gt; [0] &#39;car&#39;
		 -&gt; [3] &#39;,&#39;
		 -&gt; [4] &#39;&lt;company@30&gt;&#39;
	 - Node: &lt;company@30&gt;		? (&lt;company@30&gt;:&#39;Chevy&#39;)
		 -&gt; [0] &#39;Mercury&#39;
		 -&gt; [5] &#39;,&#39;
		 -&gt; [6] &#39;&lt;model@30&gt;&#39;
	 - Node: &lt;model@30&gt;		? (&lt;company@30&gt;:&#39;Chevy&#39;)
		 -&gt; [0] &#39;Cougar&#39;
		 -&gt; [3] &#39;\n&#39;
		 -&gt; [4] &#39;&lt;vehicle@24&gt;&#39;
	 - Node: &lt;vehicle@24&gt;		? (&lt;company@30&gt;:&#39;Chevy&#39;)
		 -&gt; [0] &#39;&lt;year@30&gt;&#39;
	 - Node: &lt;year@30&gt;		? (&lt;company@30&gt;:&#39;Chevy&#39;)
		 -&gt; [0] &#39;1999&#39;
		 -&gt; [1] &#39;,car,Chevy,Venture&#39;
		  &gt; [&#39;,car,&#39;, &#39;&lt;company@30&gt;&#39;, &#39;,Venture&#39;]
 model@30=&#39;Venture&#39;
	 - Node: &lt;start&gt;		? (&lt;model@30&gt;:&#39;Venture&#39;)
		 -&gt; [0] &#39;&lt;inventory@22&gt;&#39;
	 - Node: &lt;inventory@22&gt;		? (&lt;model@30&gt;:&#39;Venture&#39;)
		 -&gt; [0] &#39;&lt;vehicle@24&gt;&#39;
	 - Node: &lt;vehicle@24&gt;		? (&lt;model@30&gt;:&#39;Venture&#39;)
		 -&gt; [0] &#39;&lt;year@30&gt;&#39;
	 - Node: &lt;year@30&gt;		? (&lt;model@30&gt;:&#39;Venture&#39;)
		 -&gt; [0] &#39;1997&#39;
		 -&gt; [1] &#39;,&#39;
		 -&gt; [2] &#39;&lt;kind@30&gt;&#39;
	 - Node: &lt;kind@30&gt;		? (&lt;model@30&gt;:&#39;Venture&#39;)
		 -&gt; [0] &#39;van&#39;
		 -&gt; [3] &#39;,&#39;
		 -&gt; [4] &#39;&lt;company@30&gt;&#39;
	 - Node: &lt;company@30&gt;		? (&lt;model@30&gt;:&#39;Venture&#39;)
		 -&gt; [0] &#39;Ford&#39;
		 -&gt; [5] &#39;,&#39;
		 -&gt; [6] &#39;&lt;model@30&gt;&#39;
	 - Node: &lt;model@30&gt;		? (&lt;model@30&gt;:&#39;Venture&#39;)
		 -&gt; [0] &#39;E350&#39;
		 -&gt; [1] &#39;\n&#39;
		 -&gt; [2] &#39;&lt;vehicle@24&gt;&#39;
	 - Node: &lt;vehicle@24&gt;		? (&lt;model@30&gt;:&#39;Venture&#39;)
		 -&gt; [0] &#39;&lt;year@30&gt;&#39;
	 - Node: &lt;year@30&gt;		? (&lt;model@30&gt;:&#39;Venture&#39;)
		 -&gt; [0] &#39;2000&#39;
		 -&gt; [1] &#39;,&#39;
		 -&gt; [2] &#39;&lt;kind@30&gt;&#39;
	 - Node: &lt;kind@30&gt;		? (&lt;model@30&gt;:&#39;Venture&#39;)
		 -&gt; [0] &#39;car&#39;
		 -&gt; [3] &#39;,&#39;
		 -&gt; [4] &#39;&lt;company@30&gt;&#39;
	 - Node: &lt;company@30&gt;		? (&lt;model@30&gt;:&#39;Venture&#39;)
		 -&gt; [0] &#39;Mercury&#39;
		 -&gt; [5] &#39;,&#39;
		 -&gt; [6] &#39;&lt;model@30&gt;&#39;
	 - Node: &lt;model@30&gt;		? (&lt;model@30&gt;:&#39;Venture&#39;)
		 -&gt; [0] &#39;Cougar&#39;
		 -&gt; [3] &#39;\n&#39;
		 -&gt; [4] &#39;&lt;vehicle@24&gt;&#39;
	 - Node: &lt;vehicle@24&gt;		? (&lt;model@30&gt;:&#39;Venture&#39;)
		 -&gt; [0] &#39;&lt;year@30&gt;&#39;
	 - Node: &lt;year@30&gt;		? (&lt;model@30&gt;:&#39;Venture&#39;)
		 -&gt; [0] &#39;1999&#39;
		 -&gt; [1] &#39;,car,&#39;
		 -&gt; [2] &#39;&lt;company@30&gt;&#39;
	 - Node: &lt;company@30&gt;		? (&lt;model@30&gt;:&#39;Venture&#39;)
		 -&gt; [0] &#39;Chevy&#39;
		 -&gt; [3] &#39;,Venture&#39;
		  &gt; [&#39;,&#39;, &#39;&lt;model@30&gt;&#39;]
</pre></div>
</div>
</div>
</div>
<p>Look at the last statement. We have a value <code class="docutils literal notranslate"><span class="pre">1999,car,</span></code> where only the <code class="docutils literal notranslate"><span class="pre">year</span></code> got replaced. We no longer have a <code class="docutils literal notranslate"><span class="pre">'car'</span></code> variable to continue the replacement here. This happens because the <code class="docutils literal notranslate"><span class="pre">'car'</span></code> value in <code class="docutils literal notranslate"><span class="pre">'1999,car,Chevy,Venture'</span></code> is not treated as a new value because the value <code class="docutils literal notranslate"><span class="pre">'car'</span></code> had occurred for <code class="docutils literal notranslate"><span class="pre">'vehicle'</span></code> variable in the exact same location for a <em>different</em> method call (for <code class="docutils literal notranslate"><span class="pre">'2000,car,Mercury,Cougar'</span></code>).</p>
</section>
</section>
<section id="a-grammar-miner-with-scope">
<h2>A Grammar Miner with Scope<a class="headerlink" href="#a-grammar-miner-with-scope" title="Link to this heading">#</a></h2>
<p>We need to incorporate inspection of the variables in the current context. We already have a stack of method calls so that we can obtain the current method at any point. We need to do the same for variables.</p>
<p>For that, we extend the <code class="docutils literal notranslate"><span class="pre">CallStack</span></code> to a new class <code class="docutils literal notranslate"><span class="pre">InputStack</span></code> which holds the method invoked as well as the parameters observed. It is essentially the record of activation of the method. We start with the original input at the base of the stack, and for each new method-call, we push the parameters of that call into the stack as a new record.</p>
<section id="input-stack">
<h3>Input Stack<a class="headerlink" href="#input-stack" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">InputStack</span><span class="p">(</span><span class="n">CallStack</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">fragment_len</span><span class="o">=</span><span class="n">FRAGMENT_LEN</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="p">[{</span><span class="n">START_SYMBOL</span><span class="p">:</span> <span class="n">i</span><span class="p">}]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fragment_len</span> <span class="o">=</span> <span class="n">fragment_len</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>In order to check if a particular variable be saved, we define <code class="docutils literal notranslate"><span class="pre">in_current_record()</span></code> which checks only the variables in the current scope for inclusion (rather than the original input string).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">InputStack</span><span class="p">(</span><span class="n">InputStack</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">in_current_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">val</span> <span class="ow">in</span> <span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_istack</span> <span class="o">=</span> <span class="n">InputStack</span><span class="p">(</span><span class="s1">&#39;hello my world&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_istack</span><span class="o">.</span><span class="n">in_current_record</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_istack</span><span class="o">.</span><span class="n">in_current_record</span><span class="p">(</span><span class="s1">&#39;bye&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_istack</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;greeting&#39;</span><span class="p">:</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="s1">&#39;world&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_istack</span><span class="o">.</span><span class="n">in_current_record</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_istack</span><span class="o">.</span><span class="n">in_current_record</span><span class="p">(</span><span class="s1">&#39;my&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False
</pre></div>
</div>
</div>
</div>
<p>We define the method <code class="docutils literal notranslate"><span class="pre">ignored()</span></code> that returns true if either the variable is not a string, or the variable length is less than the defined <code class="docutils literal notranslate"><span class="pre">fragment_len</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">InputStack</span><span class="p">(</span><span class="n">InputStack</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ignored</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_len</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_istack</span> <span class="o">=</span> <span class="n">InputStack</span><span class="p">(</span><span class="s1">&#39;hello world&#39;</span><span class="p">)</span>
<span class="n">my_istack</span><span class="o">.</span><span class="n">ignored</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_istack</span><span class="o">.</span><span class="n">ignored</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_istack</span><span class="o">.</span><span class="n">ignored</span><span class="p">(</span><span class="s1">&#39;help&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False
</pre></div>
</div>
</div>
</div>
<p>We can now define the <code class="docutils literal notranslate"><span class="pre">in_scope()</span></code> method that checks whether the variable needs to be ignored, and if it is not to be ignored, whether the variable value is present in the current scope.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">InputStack</span><span class="p">(</span><span class="n">InputStack</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">in_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignored</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_current_record</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we update <code class="docutils literal notranslate"><span class="pre">enter()</span></code> that pushes relevant variables in the current context to the stack.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">InputStack</span><span class="p">(</span><span class="n">InputStack</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">enter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="n">my_inputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_scope</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">my_inputs</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">enter</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>When a method returns, we also need a corresponding <code class="docutils literal notranslate"><span class="pre">leave()</span></code> to pop out the inputs and unwind the stack.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">InputStack</span><span class="p">(</span><span class="n">InputStack</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">leave</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">leave</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="scopedvars">
<h3>ScopedVars<a class="headerlink" href="#scopedvars" title="Link to this heading">#</a></h3>
<p>We need to update our <code class="docutils literal notranslate"><span class="pre">AssignmentVars</span></code> to include information about which scope the variable was defined in. We start by updating <code class="docutils literal notranslate"><span class="pre">method_init()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ScopedVars</span><span class="p">(</span><span class="n">AssignmentVars</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">method_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_call_stack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">my_input</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_locations</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span><span class="o">.</span><span class="n">method_id</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_call_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">InputStack</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Similarly, the <code class="docutils literal notranslate"><span class="pre">method_enter()</span></code> now initializes the <code class="docutils literal notranslate"><span class="pre">accessed_seq_var</span></code> for the current method call.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ScopedVars</span><span class="p">(</span><span class="n">ScopedVars</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">method_enter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cxt</span><span class="p">,</span> <span class="n">my_vars</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span> <span class="o">=</span> <span class="s1">&#39;call&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span><span class="o">.</span><span class="n">enter</span><span class="p">(</span><span class="n">cxt</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">my_vars</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accessed_seq_var</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span><span class="o">.</span><span class="n">method_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_locations</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span><span class="o">.</span><span class="n">method_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_event</span><span class="p">(</span><span class="n">cxt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">my_vars</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">update()</span></code> method now saves the context in which the value is defined. In the case of a parameter to a function, the context should be the context in which the function was called. On the other hand, a value defined during a statement execution would have the current context.</p>
<p>Further, we annotate on value rather than key because we do not want to duplicate variables when parameters are in context in the next line. They will have same value, but different context because they are present in a statement execution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ScopedVars</span><span class="p">(</span><span class="n">ScopedVars</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span> <span class="o">==</span> <span class="s1">&#39;call&#39;</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_kv</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">context</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_location_register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_vars</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_vars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We also need to save the current method invocation to determine which variables are in scope. This information is now incorporated in the variable name as <code class="docutils literal notranslate"><span class="pre">accessed_seq_var[method_id][var]</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ScopedVars</span><span class="p">(</span><span class="n">ScopedVars</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">var_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span><span class="o">.</span><span class="n">method_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">accessed_seq_var</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span><span class="o">.</span><span class="n">method_id</span><span class="p">][</span><span class="n">var</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>As before, <code class="docutils literal notranslate"><span class="pre">var_access</span></code> simply initializes the corresponding counter, this time in the context of <code class="docutils literal notranslate"><span class="pre">method_id</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ScopedVars</span><span class="p">(</span><span class="n">ScopedVars</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">var_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">accessed_seq_var</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span><span class="o">.</span><span class="n">method_id</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">accessed_seq_var</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span><span class="o">.</span><span class="n">method_id</span><span class="p">][</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>During a variable reassignment, we update the <code class="docutils literal notranslate"><span class="pre">accessed_seq_var</span></code> to reflect the new count.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ScopedVars</span><span class="p">(</span><span class="n">ScopedVars</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">var_assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accessed_seq_var</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">call_stack</span><span class="o">.</span><span class="n">method_id</span><span class="p">][</span><span class="n">var</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_vars</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We now update <code class="docutils literal notranslate"><span class="pre">defined_vars()</span></code> to account for the new information.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ScopedVars</span><span class="p">(</span><span class="n">ScopedVars</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">defined_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formatted</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">fmt</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">method</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_def_lines</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">[</span><span class="si">%d</span><span class="s2">]:</span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">if</span> <span class="n">formatted</span> <span class="k">else</span> <span class="n">v</span>

        <span class="k">return</span> <span class="p">[(</span><span class="n">fmt</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
</pre></div>
</div>
</div>
</div>
<p>Updating <code class="docutils literal notranslate"><span class="pre">seq_vars()</span></code> to account for new information.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ScopedVars</span><span class="p">(</span><span class="n">ScopedVars</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">seq_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formatted</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">fmt</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">method</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_def_lines</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">k</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">[</span><span class="si">%d</span><span class="s2">]:</span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">if</span> <span class="n">formatted</span> <span class="k">else</span> <span class="n">v</span>

        <span class="k">return</span> <span class="p">{</span><span class="n">fmt</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="scope-tracker">
<h3>Scope Tracker<a class="headerlink" href="#scope-tracker" title="Link to this heading">#</a></h3>
<p>With the <code class="docutils literal notranslate"><span class="pre">InputStack</span></code> and <code class="docutils literal notranslate"><span class="pre">Vars</span></code> defined, we can now define the <code class="docutils literal notranslate"><span class="pre">ScopeTracker</span></code>. The <code class="docutils literal notranslate"><span class="pre">ScopeTracker</span></code> only saves variables if the value is present in the current scope.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ScopeTracker</span><span class="p">(</span><span class="n">AssignmentTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">my_input</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_event</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">my_input</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_assignments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ScopedVars</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We define a wrapper for checking whether a variable is present in the scope.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ScopeTracker</span><span class="p">(</span><span class="n">ScopeTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_input_fragment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_assignments</span><span class="o">.</span><span class="n">call_stack</span><span class="o">.</span><span class="n">in_scope</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can use the <code class="docutils literal notranslate"><span class="pre">ScopeTracker</span></code> as follows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vehicle_traces</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">with</span> <span class="n">Tracer</span><span class="p">(</span><span class="n">INVENTORY</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">process_inventory</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">)</span>
<span class="n">sm</span> <span class="o">=</span> <span class="n">ScopeTracker</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="n">tracer</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span>
<span class="n">vehicle_traces</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="n">sm</span><span class="p">))</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sm</span><span class="o">.</span><span class="n">my_assignments</span><span class="o">.</span><span class="n">seq_vars</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_inventory[1]:inventory@22:1 = (&#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, (&#39;&lt;start&gt;&#39;, 0))
process_inventory[1]:inventory@22:2 = (&#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, (&#39;process_inventory&#39;, 1))
process_inventory[1]:vehicle@24:1 = (&#39;1997,van,Ford,E350&#39;, (&#39;process_inventory&#39;, 1))
process_vehicle[2]:vehicle@29:1 = (&#39;1997,van,Ford,E350&#39;, (&#39;process_inventory&#39;, 1))
process_vehicle[2]:vehicle@29:2 = (&#39;1997,van,Ford,E350&#39;, (&#39;process_vehicle&#39;, 2))
process_vehicle[2]:year@30:1 = (&#39;1997&#39;, (&#39;process_vehicle&#39;, 2))
process_vehicle[2]:kind@30:1 = (&#39;van&#39;, (&#39;process_vehicle&#39;, 2))
process_vehicle[2]:company@30:1 = (&#39;Ford&#39;, (&#39;process_vehicle&#39;, 2))
process_vehicle[2]:model@30:1 = (&#39;E350&#39;, (&#39;process_vehicle&#39;, 2))
process_van[3]:year@40:1 = (&#39;1997&#39;, (&#39;process_vehicle&#39;, 2))
process_van[3]:company@40:1 = (&#39;Ford&#39;, (&#39;process_vehicle&#39;, 2))
process_van[3]:model@40:1 = (&#39;E350&#39;, (&#39;process_vehicle&#39;, 2))
process_van[3]:year@40:2 = (&#39;1997&#39;, (&#39;process_van&#39;, 3))
process_van[3]:company@40:2 = (&#39;Ford&#39;, (&#39;process_van&#39;, 3))
process_van[3]:model@40:2 = (&#39;E350&#39;, (&#39;process_van&#39;, 3))
process_inventory[1]:vehicle@24:2 = (&#39;2000,car,Mercury,Cougar&#39;, (&#39;process_inventory&#39;, 1))
process_vehicle[4]:vehicle@29:1 = (&#39;2000,car,Mercury,Cougar&#39;, (&#39;process_inventory&#39;, 1))
process_vehicle[4]:vehicle@29:2 = (&#39;2000,car,Mercury,Cougar&#39;, (&#39;process_vehicle&#39;, 4))
process_vehicle[4]:year@30:1 = (&#39;2000&#39;, (&#39;process_vehicle&#39;, 4))
process_vehicle[4]:kind@30:1 = (&#39;car&#39;, (&#39;process_vehicle&#39;, 4))
process_vehicle[4]:company@30:1 = (&#39;Mercury&#39;, (&#39;process_vehicle&#39;, 4))
process_vehicle[4]:model@30:1 = (&#39;Cougar&#39;, (&#39;process_vehicle&#39;, 4))
process_car[5]:year@49:1 = (&#39;2000&#39;, (&#39;process_vehicle&#39;, 4))
process_car[5]:company@49:1 = (&#39;Mercury&#39;, (&#39;process_vehicle&#39;, 4))
process_car[5]:model@49:1 = (&#39;Cougar&#39;, (&#39;process_vehicle&#39;, 4))
process_car[5]:year@49:2 = (&#39;2000&#39;, (&#39;process_car&#39;, 5))
process_car[5]:company@49:2 = (&#39;Mercury&#39;, (&#39;process_car&#39;, 5))
process_car[5]:model@49:2 = (&#39;Cougar&#39;, (&#39;process_car&#39;, 5))
process_inventory[1]:vehicle@24:3 = (&#39;1999,car,Chevy,Venture&#39;, (&#39;process_inventory&#39;, 1))
process_vehicle[6]:vehicle@29:1 = (&#39;1999,car,Chevy,Venture&#39;, (&#39;process_inventory&#39;, 1))
process_vehicle[6]:vehicle@29:2 = (&#39;1999,car,Chevy,Venture&#39;, (&#39;process_vehicle&#39;, 6))
process_vehicle[6]:year@30:1 = (&#39;1999&#39;, (&#39;process_vehicle&#39;, 6))
process_vehicle[6]:kind@30:1 = (&#39;car&#39;, (&#39;process_vehicle&#39;, 6))
process_vehicle[6]:company@30:1 = (&#39;Chevy&#39;, (&#39;process_vehicle&#39;, 6))
process_vehicle[6]:model@30:1 = (&#39;Venture&#39;, (&#39;process_vehicle&#39;, 6))
process_car[7]:year@49:1 = (&#39;1999&#39;, (&#39;process_vehicle&#39;, 6))
process_car[7]:company@49:1 = (&#39;Chevy&#39;, (&#39;process_vehicle&#39;, 6))
process_car[7]:model@49:1 = (&#39;Venture&#39;, (&#39;process_vehicle&#39;, 6))
process_car[7]:year@49:2 = (&#39;1999&#39;, (&#39;process_car&#39;, 7))
process_car[7]:company@49:2 = (&#39;Chevy&#39;, (&#39;process_car&#39;, 7))
process_car[7]:model@49:2 = (&#39;Venture&#39;, (&#39;process_car&#39;, 7))
</pre></div>
</div>
</div>
</div>
</section>
<section id="id1">
<h3>Recovering a Derivation Tree<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<p>The main difference in <code class="docutils literal notranslate"><span class="pre">apply_new_definition()</span></code> is that we add a second condition that checks for scope. In particular, variables are only allowed to replace portions of string fragments that were in scope.
The variable scope is indicated by <code class="docutils literal notranslate"><span class="pre">scope</span></code>. However, merely accounting for scope is not sufficient. For example, consider the fragment below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">my_fn</span><span class="p">(</span><span class="n">stringval</span><span class="p">):</span>
    <span class="n">partA</span><span class="p">,</span> <span class="n">partB</span> <span class="o">=</span> <span class="n">stringval</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">partA</span><span class="p">,</span> <span class="n">partB</span>

<span class="n">svalue</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">my_fn</span><span class="p">(</span><span class="n">svalue</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">v1</span></code> and <code class="docutils literal notranslate"><span class="pre">v2</span></code> get their values from a previous function call. Not from their current context. That is, we have to provide an exception for cases where an internal child method call may have generated a large fragment as we showed above. To account for that, we define <code class="docutils literal notranslate"><span class="pre">mseq()</span></code> that retrieves the method call sequence. In the above case, the <code class="docutils literal notranslate"><span class="pre">mseq()</span></code> of the internal child method call would be larger than the current <code class="docutils literal notranslate"><span class="pre">mseq()</span></code>. If so, we allow the replacement to proceed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ScopeTreeMiner</span><span class="p">(</span><span class="n">TreeMiner</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mseq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">method</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">lno</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">return</span> <span class="n">seq</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">nt_var()</span></code> method needs to take the tuple and generate a non-terminal symbol out of it. We skip the method sequence because it is not relevant for the grammar.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ScopeTreeMiner</span><span class="p">(</span><span class="n">ScopeTreeMiner</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">nt_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">method</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">lno</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">return</span> <span class="n">to_nonterminal</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">@</span><span class="si">%d</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">lno</span><span class="p">,</span> <span class="n">var</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>We now redefine the <code class="docutils literal notranslate"><span class="pre">apply_new_definition()</span></code> to account for context and scope. In particular, a variable is allowed to replace a part of a value only if the variable is in <em>scope</em> – that is, it’s scope (method sequence number of either its calling context in case it is a parameter or the current context in case it is a statement) is same as that of the value’s method sequence number. An exception is made when the value’s method sequence number is greater than the variable’s method sequence number. In that case, the value may have come from an internal call. We allow the replacement to proceed in that case.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ScopeTreeMiner</span><span class="p">(</span><span class="n">ScopeTreeMiner</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">partition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">part</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">partition_by_part</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="p">(</span><span class="n">nt_var</span><span class="p">,</span> <span class="n">nt_seq</span><span class="p">),</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v_scope</span><span class="p">)</span> <span class="o">=</span> <span class="n">pair</span>
        <span class="n">prefix_k_suffix</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">nt_var</span><span class="p">,</span> <span class="p">[(</span><span class="n">v</span><span class="p">,</span> <span class="p">[],</span> <span class="n">nt_seq</span><span class="p">)])</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">e</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">prefix_k_suffix</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">insert_into_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">my_tree</span><span class="p">,</span> <span class="n">pair</span><span class="p">):</span>
        <span class="n">var</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">my_scope</span> <span class="o">=</span> <span class="n">my_tree</span>
        <span class="p">(</span><span class="n">nt_var</span><span class="p">,</span> <span class="n">nt_seq</span><span class="p">),</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v_scope</span><span class="p">)</span> <span class="o">=</span> <span class="n">pair</span>
        <span class="n">applied</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">scope</span> <span class="o">=</span> <span class="n">value_</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;-&gt; [</span><span class="si">%d</span><span class="s2">] </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value_</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">is_nonterminal</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="n">applied</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_into_tree</span><span class="p">(</span><span class="n">value_</span><span class="p">,</span> <span class="n">pair</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">applied</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v_scope</span> <span class="o">!=</span> <span class="n">scope</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">nt_seq</span> <span class="o">&gt;</span> <span class="n">scope</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">string_part_of_value</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">prefix_k_suffix</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">children</span>
                                   <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition_by_part</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">key</span><span class="p">)]</span>
                <span class="k">del</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">rep</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prefix_k_suffix</span><span class="p">):</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">rep</span><span class="p">)</span>

                <span class="n">applied</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot; &gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prefix_k_suffix</span><span class="p">])))</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">applied</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">apply_new_definition()</span></code> is now modified to carry additional contextual information <code class="docutils literal notranslate"><span class="pre">mseq</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ScopeTreeMiner</span><span class="p">(</span><span class="n">ScopeTreeMiner</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_new_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value_</span><span class="p">):</span>
        <span class="n">nt_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nt_var</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mseq</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">smethod</span><span class="p">,</span> <span class="n">mseq</span><span class="p">)</span> <span class="o">=</span> <span class="n">value_</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_into_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="p">((</span><span class="n">nt_var</span><span class="p">,</span> <span class="n">seq</span><span class="p">),</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">mseq</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<p>We also modify <code class="docutils literal notranslate"><span class="pre">get_derivation_tree()</span></code> so that the initial node carries the context.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ScopeTreeMiner</span><span class="p">(</span><span class="n">ScopeTreeMiner</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_derivation_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="p">(</span><span class="n">START_SYMBOL</span><span class="p">,</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">)],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_assignments</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_new_definition</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tree</span>
</pre></div>
</div>
</div>
</div>
<section id="example-1-recovering-url-parse-tree">
<h4>Example 1: Recovering URL Parse Tree<a class="headerlink" href="#example-1-recovering-url-parse-tree" title="Link to this heading">#</a></h4>
<p>We verify that our URL parse tree recovery still works as expected.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url_dts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">inputstr</span> <span class="ow">in</span> <span class="n">URLS_X</span><span class="p">:</span>
    <span class="n">clear_cache</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">Tracer</span><span class="p">(</span><span class="n">inputstr</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;urllib/parse.py&#39;</span><span class="p">])</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
        <span class="n">urlparse</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">)</span>
    <span class="n">sm</span> <span class="o">=</span> <span class="n">ScopeTracker</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="n">tracer</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sm</span><span class="o">.</span><span class="n">my_assignments</span><span class="o">.</span><span class="n">defined_vars</span><span class="p">(</span><span class="n">formatted</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">ScopeTreeMiner</span><span class="p">(</span>
        <span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span>
        <span class="n">sm</span><span class="o">.</span><span class="n">my_assignments</span><span class="o">.</span><span class="n">defined_vars</span><span class="p">(</span>
            <span class="n">formatted</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">display_tree</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">tree</span><span class="p">,</span> <span class="n">graph_attr</span><span class="o">=</span><span class="n">lr_graph</span><span class="p">)</span>
    <span class="n">url_dts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;urlparse&#39;, 1, &#39;url&#39;, 374) = (&#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, (&#39;&lt;start&gt;&#39;, 0))
(&#39;urlparse&#39;, 1, &#39;url&#39;, 374) = (&#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, (&#39;urlparse&#39;, 1))
(&#39;urlsplit&#39;, 3, &#39;url&#39;, 469) = (&#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, (&#39;urlparse&#39;, 1))
(&#39;urlsplit&#39;, 3, &#39;url&#39;, 469) = (&#39;http://user:pass@www.google.com:80/?q=path#ref&#39;, (&#39;urlsplit&#39;, 3))
(&#39;urlsplit&#39;, 3, &#39;url&#39;, 509) = (&#39;//user:pass@www.google.com:80/?q=path#ref&#39;, (&#39;urlsplit&#39;, 3))
(&#39;urlsplit&#39;, 3, &#39;scheme&#39;, 509) = (&#39;http&#39;, (&#39;urlsplit&#39;, 3))
(&#39;_splitnetloc&#39;, 5, &#39;url&#39;, 413) = (&#39;//user:pass@www.google.com:80/?q=path#ref&#39;, (&#39;urlsplit&#39;, 3))
(&#39;_splitnetloc&#39;, 5, &#39;url&#39;, 413) = (&#39;//user:pass@www.google.com:80/?q=path#ref&#39;, (&#39;_splitnetloc&#39;, 5))
(&#39;urlsplit&#39;, 3, &#39;url&#39;, 511) = (&#39;/?q=path#ref&#39;, (&#39;urlsplit&#39;, 3))
(&#39;urlsplit&#39;, 3, &#39;netloc&#39;, 511) = (&#39;user:pass@www.google.com:80&#39;, (&#39;urlsplit&#39;, 3))
(&#39;urlsplit&#39;, 3, &#39;url&#39;, 518) = (&#39;/?q=path&#39;, (&#39;urlsplit&#39;, 3))
(&#39;urlsplit&#39;, 3, &#39;fragment&#39;, 518) = (&#39;ref&#39;, (&#39;urlsplit&#39;, 3))
(&#39;urlsplit&#39;, 3, &#39;query&#39;, 520) = (&#39;q=path&#39;, (&#39;urlsplit&#39;, 3))
(&#39;_checknetloc&#39;, 6, &#39;netloc&#39;, 421) = (&#39;user:pass@www.google.com:80&#39;, (&#39;urlsplit&#39;, 3))
(&#39;_checknetloc&#39;, 6, &#39;netloc&#39;, 421) = (&#39;user:pass@www.google.com:80&#39;, (&#39;_checknetloc&#39;, 6))
(&#39;urlparse&#39;, 1, &#39;scheme&#39;, 396) = (&#39;http&#39;, (&#39;urlparse&#39;, 1))
(&#39;urlparse&#39;, 1, &#39;netloc&#39;, 396) = (&#39;user:pass@www.google.com:80&#39;, (&#39;urlparse&#39;, 1))
(&#39;urlparse&#39;, 1, &#39;query&#39;, 396) = (&#39;q=path&#39;, (&#39;urlparse&#39;, 1))
(&#39;urlparse&#39;, 1, &#39;fragment&#39;, 396) = (&#39;ref&#39;, (&#39;urlparse&#39;, 1))
(&#39;urlparse&#39;, 1, &#39;url&#39;, 374) = (&#39;https://www.cispa.saarland:80/&#39;, (&#39;&lt;start&gt;&#39;, 0))
(&#39;urlparse&#39;, 1, &#39;url&#39;, 374) = (&#39;https://www.cispa.saarland:80/&#39;, (&#39;urlparse&#39;, 1))
(&#39;urlsplit&#39;, 3, &#39;url&#39;, 469) = (&#39;https://www.cispa.saarland:80/&#39;, (&#39;urlparse&#39;, 1))
(&#39;urlsplit&#39;, 3, &#39;url&#39;, 469) = (&#39;https://www.cispa.saarland:80/&#39;, (&#39;urlsplit&#39;, 3))
(&#39;urlsplit&#39;, 3, &#39;url&#39;, 509) = (&#39;//www.cispa.saarland:80/&#39;, (&#39;urlsplit&#39;, 3))
(&#39;urlsplit&#39;, 3, &#39;scheme&#39;, 509) = (&#39;https&#39;, (&#39;urlsplit&#39;, 3))
(&#39;_splitnetloc&#39;, 5, &#39;url&#39;, 413) = (&#39;//www.cispa.saarland:80/&#39;, (&#39;urlsplit&#39;, 3))
(&#39;_splitnetloc&#39;, 5, &#39;url&#39;, 413) = (&#39;//www.cispa.saarland:80/&#39;, (&#39;_splitnetloc&#39;, 5))
(&#39;urlsplit&#39;, 3, &#39;netloc&#39;, 511) = (&#39;www.cispa.saarland:80&#39;, (&#39;urlsplit&#39;, 3))
(&#39;_checknetloc&#39;, 6, &#39;netloc&#39;, 421) = (&#39;www.cispa.saarland:80&#39;, (&#39;urlsplit&#39;, 3))
(&#39;_checknetloc&#39;, 6, &#39;netloc&#39;, 421) = (&#39;www.cispa.saarland:80&#39;, (&#39;_checknetloc&#39;, 6))
(&#39;urlparse&#39;, 1, &#39;scheme&#39;, 396) = (&#39;https&#39;, (&#39;urlparse&#39;, 1))
(&#39;urlparse&#39;, 1, &#39;netloc&#39;, 396) = (&#39;www.cispa.saarland:80&#39;, (&#39;urlparse&#39;, 1))
(&#39;urlparse&#39;, 1, &#39;url&#39;, 374) = (&#39;http://www.fuzzingbook.org/#News&#39;, (&#39;&lt;start&gt;&#39;, 0))
(&#39;urlparse&#39;, 1, &#39;url&#39;, 374) = (&#39;http://www.fuzzingbook.org/#News&#39;, (&#39;urlparse&#39;, 1))
(&#39;urlsplit&#39;, 3, &#39;url&#39;, 469) = (&#39;http://www.fuzzingbook.org/#News&#39;, (&#39;urlparse&#39;, 1))
(&#39;urlsplit&#39;, 3, &#39;url&#39;, 469) = (&#39;http://www.fuzzingbook.org/#News&#39;, (&#39;urlsplit&#39;, 3))
(&#39;urlsplit&#39;, 3, &#39;url&#39;, 509) = (&#39;//www.fuzzingbook.org/#News&#39;, (&#39;urlsplit&#39;, 3))
(&#39;urlsplit&#39;, 3, &#39;scheme&#39;, 509) = (&#39;http&#39;, (&#39;urlsplit&#39;, 3))
(&#39;_splitnetloc&#39;, 5, &#39;url&#39;, 413) = (&#39;//www.fuzzingbook.org/#News&#39;, (&#39;urlsplit&#39;, 3))
(&#39;_splitnetloc&#39;, 5, &#39;url&#39;, 413) = (&#39;//www.fuzzingbook.org/#News&#39;, (&#39;_splitnetloc&#39;, 5))
(&#39;urlsplit&#39;, 3, &#39;url&#39;, 511) = (&#39;/#News&#39;, (&#39;urlsplit&#39;, 3))
(&#39;urlsplit&#39;, 3, &#39;netloc&#39;, 511) = (&#39;www.fuzzingbook.org&#39;, (&#39;urlsplit&#39;, 3))
(&#39;urlsplit&#39;, 3, &#39;fragment&#39;, 518) = (&#39;News&#39;, (&#39;urlsplit&#39;, 3))
(&#39;_checknetloc&#39;, 6, &#39;netloc&#39;, 421) = (&#39;www.fuzzingbook.org&#39;, (&#39;urlsplit&#39;, 3))
(&#39;_checknetloc&#39;, 6, &#39;netloc&#39;, 421) = (&#39;www.fuzzingbook.org&#39;, (&#39;_checknetloc&#39;, 6))
(&#39;urlparse&#39;, 1, &#39;scheme&#39;, 396) = (&#39;http&#39;, (&#39;urlparse&#39;, 1))
(&#39;urlparse&#39;, 1, &#39;netloc&#39;, 396) = (&#39;www.fuzzingbook.org&#39;, (&#39;urlparse&#39;, 1))
(&#39;urlparse&#39;, 1, &#39;fragment&#39;, 396) = (&#39;News&#39;, (&#39;urlparse&#39;, 1))
(&#39;urlparse&#39;, 1, &#39;url&#39;, 374) = (&#39;ftp://freebsd.org/releases/5.8&#39;, (&#39;&lt;start&gt;&#39;, 0))
(&#39;urlparse&#39;, 1, &#39;url&#39;, 374) = (&#39;ftp://freebsd.org/releases/5.8&#39;, (&#39;urlparse&#39;, 1))
(&#39;urlsplit&#39;, 3, &#39;url&#39;, 469) = (&#39;ftp://freebsd.org/releases/5.8&#39;, (&#39;urlparse&#39;, 1))
(&#39;urlsplit&#39;, 3, &#39;url&#39;, 469) = (&#39;ftp://freebsd.org/releases/5.8&#39;, (&#39;urlsplit&#39;, 3))
(&#39;urlsplit&#39;, 3, &#39;url&#39;, 509) = (&#39;//freebsd.org/releases/5.8&#39;, (&#39;urlsplit&#39;, 3))
(&#39;urlsplit&#39;, 3, &#39;scheme&#39;, 509) = (&#39;ftp&#39;, (&#39;urlsplit&#39;, 3))
(&#39;_splitnetloc&#39;, 5, &#39;url&#39;, 413) = (&#39;//freebsd.org/releases/5.8&#39;, (&#39;urlsplit&#39;, 3))
(&#39;_splitnetloc&#39;, 5, &#39;url&#39;, 413) = (&#39;//freebsd.org/releases/5.8&#39;, (&#39;_splitnetloc&#39;, 5))
(&#39;urlsplit&#39;, 3, &#39;url&#39;, 511) = (&#39;/releases/5.8&#39;, (&#39;urlsplit&#39;, 3))
(&#39;urlsplit&#39;, 3, &#39;netloc&#39;, 511) = (&#39;freebsd.org&#39;, (&#39;urlsplit&#39;, 3))
(&#39;_checknetloc&#39;, 6, &#39;netloc&#39;, 421) = (&#39;freebsd.org&#39;, (&#39;urlsplit&#39;, 3))
(&#39;_checknetloc&#39;, 6, &#39;netloc&#39;, 421) = (&#39;freebsd.org&#39;, (&#39;_checknetloc&#39;, 6))
(&#39;urlparse&#39;, 1, &#39;url&#39;, 396) = (&#39;/releases/5.8&#39;, (&#39;urlparse&#39;, 1))
(&#39;urlparse&#39;, 1, &#39;scheme&#39;, 396) = (&#39;ftp&#39;, (&#39;urlparse&#39;, 1))
(&#39;urlparse&#39;, 1, &#39;netloc&#39;, 396) = (&#39;freebsd.org&#39;, (&#39;urlparse&#39;, 1))
</pre></div>
</div>
</div>
</div>
</section>
<section id="example-2-recovering-inventory-parse-tree">
<h4>Example 2: Recovering Inventory Parse Tree<a class="headerlink" href="#example-2-recovering-inventory-parse-tree" title="Link to this heading">#</a></h4>
<p>Next, we look at recovering the parse tree from <code class="docutils literal notranslate"><span class="pre">process_inventory()</span></code> which failed last time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Tracer</span><span class="p">(</span><span class="n">INVENTORY</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">process_inventory</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">)</span>

<span class="n">sm</span> <span class="o">=</span> <span class="n">ScopeTracker</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="n">tracer</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sm</span><span class="o">.</span><span class="n">my_assignments</span><span class="o">.</span><span class="n">defined_vars</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
<span class="n">inventory_dt</span> <span class="o">=</span> <span class="n">ScopeTreeMiner</span><span class="p">(</span>
    <span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span>
    <span class="n">sm</span><span class="o">.</span><span class="n">my_assignments</span><span class="o">.</span><span class="n">defined_vars</span><span class="p">(</span>
        <span class="n">formatted</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="n">display_tree</span><span class="p">(</span><span class="n">inventory_dt</span><span class="o">.</span><span class="n">tree</span><span class="p">,</span> <span class="n">graph_attr</span><span class="o">=</span><span class="n">lr_graph</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_inventory[1]:inventory@22 = (&#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, (&#39;&lt;start&gt;&#39;, 0))
process_inventory[1]:inventory@22 = (&#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, (&#39;process_inventory&#39;, 1))
process_inventory[1]:vehicle@24 = (&#39;1997,van,Ford,E350&#39;, (&#39;process_inventory&#39;, 1))
process_vehicle[2]:vehicle@29 = (&#39;1997,van,Ford,E350&#39;, (&#39;process_inventory&#39;, 1))
process_vehicle[2]:vehicle@29 = (&#39;1997,van,Ford,E350&#39;, (&#39;process_vehicle&#39;, 2))
process_vehicle[2]:year@30 = (&#39;1997&#39;, (&#39;process_vehicle&#39;, 2))
process_vehicle[2]:kind@30 = (&#39;van&#39;, (&#39;process_vehicle&#39;, 2))
process_vehicle[2]:company@30 = (&#39;Ford&#39;, (&#39;process_vehicle&#39;, 2))
process_vehicle[2]:model@30 = (&#39;E350&#39;, (&#39;process_vehicle&#39;, 2))
process_van[3]:year@40 = (&#39;1997&#39;, (&#39;process_vehicle&#39;, 2))
process_van[3]:company@40 = (&#39;Ford&#39;, (&#39;process_vehicle&#39;, 2))
process_van[3]:model@40 = (&#39;E350&#39;, (&#39;process_vehicle&#39;, 2))
process_van[3]:year@40 = (&#39;1997&#39;, (&#39;process_van&#39;, 3))
process_van[3]:company@40 = (&#39;Ford&#39;, (&#39;process_van&#39;, 3))
process_van[3]:model@40 = (&#39;E350&#39;, (&#39;process_van&#39;, 3))
process_inventory[1]:vehicle@24 = (&#39;2000,car,Mercury,Cougar&#39;, (&#39;process_inventory&#39;, 1))
process_vehicle[4]:vehicle@29 = (&#39;2000,car,Mercury,Cougar&#39;, (&#39;process_inventory&#39;, 1))
process_vehicle[4]:vehicle@29 = (&#39;2000,car,Mercury,Cougar&#39;, (&#39;process_vehicle&#39;, 4))
process_vehicle[4]:year@30 = (&#39;2000&#39;, (&#39;process_vehicle&#39;, 4))
process_vehicle[4]:kind@30 = (&#39;car&#39;, (&#39;process_vehicle&#39;, 4))
process_vehicle[4]:company@30 = (&#39;Mercury&#39;, (&#39;process_vehicle&#39;, 4))
process_vehicle[4]:model@30 = (&#39;Cougar&#39;, (&#39;process_vehicle&#39;, 4))
process_car[5]:year@49 = (&#39;2000&#39;, (&#39;process_vehicle&#39;, 4))
process_car[5]:company@49 = (&#39;Mercury&#39;, (&#39;process_vehicle&#39;, 4))
process_car[5]:model@49 = (&#39;Cougar&#39;, (&#39;process_vehicle&#39;, 4))
process_car[5]:year@49 = (&#39;2000&#39;, (&#39;process_car&#39;, 5))
process_car[5]:company@49 = (&#39;Mercury&#39;, (&#39;process_car&#39;, 5))
process_car[5]:model@49 = (&#39;Cougar&#39;, (&#39;process_car&#39;, 5))
process_inventory[1]:vehicle@24 = (&#39;1999,car,Chevy,Venture&#39;, (&#39;process_inventory&#39;, 1))
process_vehicle[6]:vehicle@29 = (&#39;1999,car,Chevy,Venture&#39;, (&#39;process_inventory&#39;, 1))
process_vehicle[6]:vehicle@29 = (&#39;1999,car,Chevy,Venture&#39;, (&#39;process_vehicle&#39;, 6))
process_vehicle[6]:year@30 = (&#39;1999&#39;, (&#39;process_vehicle&#39;, 6))
process_vehicle[6]:kind@30 = (&#39;car&#39;, (&#39;process_vehicle&#39;, 6))
process_vehicle[6]:company@30 = (&#39;Chevy&#39;, (&#39;process_vehicle&#39;, 6))
process_vehicle[6]:model@30 = (&#39;Venture&#39;, (&#39;process_vehicle&#39;, 6))
process_car[7]:year@49 = (&#39;1999&#39;, (&#39;process_vehicle&#39;, 6))
process_car[7]:company@49 = (&#39;Chevy&#39;, (&#39;process_vehicle&#39;, 6))
process_car[7]:model@49 = (&#39;Venture&#39;, (&#39;process_vehicle&#39;, 6))
process_car[7]:year@49 = (&#39;1999&#39;, (&#39;process_car&#39;, 7))
process_car[7]:company@49 = (&#39;Chevy&#39;, (&#39;process_car&#39;, 7))
process_car[7]:model@49 = (&#39;Venture&#39;, (&#39;process_car&#39;, 7))
</pre></div>
</div>
<img alt="_images/a62c36de0d6a448af72089e0329272f035cfbff7629139ebd7b97584f98ec08f.svg" src="_images/a62c36de0d6a448af72089e0329272f035cfbff7629139ebd7b97584f98ec08f.svg" />
</div>
</div>
<p>The recovered parse tree seems reasonable.</p>
<p>One of the things that one might notice from our Example (2) is that the three subtrees – <code class="docutils literal notranslate"><span class="pre">vehicle[2:1]</span></code>, <code class="docutils literal notranslate"><span class="pre">vehicle[4:1]</span></code> and <code class="docutils literal notranslate"><span class="pre">vehicle[6:1]</span></code> are quite alike. We will examine how this can be exploited to generate a grammar directly, next.</p>
</section>
</section>
<section id="grammar-mining">
<h3>Grammar Mining<a class="headerlink" href="#grammar-mining" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">tree_to_grammar()</span></code> is now redefined as follows, to account for the extra scope in nodes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ScopedGrammarMiner</span><span class="p">(</span><span class="n">GrammarMiner</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tree_to_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="n">scope</span> <span class="o">=</span> <span class="n">tree</span>
        <span class="n">one_alt</span> <span class="o">=</span> <span class="p">[</span><span class="n">ckey</span> <span class="k">for</span> <span class="n">ckey</span><span class="p">,</span> <span class="n">gchildren</span><span class="p">,</span> <span class="n">cscope</span> <span class="ow">in</span> <span class="n">children</span> <span class="k">if</span> <span class="n">ckey</span> <span class="o">!=</span> <span class="n">key</span><span class="p">]</span>
        <span class="n">hsh</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[</span><span class="n">one_alt</span><span class="p">]</span> <span class="k">if</span> <span class="n">one_alt</span> <span class="k">else</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="p">(</span><span class="n">ckey</span><span class="p">,</span> <span class="n">_gc</span><span class="p">,</span> <span class="n">_cscope</span><span class="p">)</span> <span class="o">=</span> <span class="n">child</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_nonterminal</span><span class="p">(</span><span class="n">ckey</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">chsh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_to_grammar</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">chsh</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hsh</span><span class="p">:</span>
                    <span class="n">hsh</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">chsh</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">hsh</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">chsh</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">hsh</span>
</pre></div>
</div>
</div>
</div>
<p>The grammar is in canonical form, which needs to be massaged to display. First, the recovered grammar for inventory.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">si</span> <span class="o">=</span> <span class="n">ScopedGrammarMiner</span><span class="p">()</span>
<span class="n">si</span><span class="o">.</span><span class="n">add_tree</span><span class="p">(</span><span class="n">inventory_dt</span><span class="p">)</span>
<span class="n">syntax_diagram</span><span class="p">(</span><span class="n">readable</span><span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">grammar</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>start
</pre></div>
</div>
<img alt="_images/6c056864e9f0af26e9c19761beb74ab9bd60112b23d9108f164c758c404f723d.svg" src="_images/6c056864e9f0af26e9c19761beb74ab9bd60112b23d9108f164c758c404f723d.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_inventory@22:inventory
</pre></div>
</div>
<img alt="_images/cfce385ecb62f5d6539e83f1a990c824741b4cc5f836f259be094faf6f129636.svg" src="_images/cfce385ecb62f5d6539e83f1a990c824741b4cc5f836f259be094faf6f129636.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_inventory@24:vehicle
</pre></div>
</div>
<img alt="_images/a117ebf3e82ec9f2323ca63192063dfd19335d8652ae02e348f11721bb216444.svg" src="_images/a117ebf3e82ec9f2323ca63192063dfd19335d8652ae02e348f11721bb216444.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@29:vehicle
</pre></div>
</div>
<img alt="_images/5fcd32d403c69da30dea9e26247e65c3f3e260c06e1a3e1dedc4620f89417c5d.svg" src="_images/5fcd32d403c69da30dea9e26247e65c3f3e260c06e1a3e1dedc4620f89417c5d.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@30:year
</pre></div>
</div>
<img alt="_images/09b44707f6ced919217083f06665cd148302f4a85522318ec555e6ff6397b2e5.svg" src="_images/09b44707f6ced919217083f06665cd148302f4a85522318ec555e6ff6397b2e5.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_van@40:year
</pre></div>
</div>
<img alt="_images/dd84b034adfbd0fc337e1af20fc5114e420d6f95a9c507ad395dac04b92fb593.svg" src="_images/dd84b034adfbd0fc337e1af20fc5114e420d6f95a9c507ad395dac04b92fb593.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@30:kind
</pre></div>
</div>
<img alt="_images/d6a1f534cf99e7dc5738dfbb392886c1fe95da23c0341c7456c6c4736711c80e.svg" src="_images/d6a1f534cf99e7dc5738dfbb392886c1fe95da23c0341c7456c6c4736711c80e.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@30:company
</pre></div>
</div>
<img alt="_images/d24e873d9ab9979991e9597f0fb28fbfa9c9bdfac4967be2173bdb69ee6a231f.svg" src="_images/d24e873d9ab9979991e9597f0fb28fbfa9c9bdfac4967be2173bdb69ee6a231f.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_van@40:company
</pre></div>
</div>
<img alt="_images/5495c5732be2d54f42285617c92f98ec3a794c3e9c1561e09cdb66bdeafcf81d.svg" src="_images/5495c5732be2d54f42285617c92f98ec3a794c3e9c1561e09cdb66bdeafcf81d.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@30:model
</pre></div>
</div>
<img alt="_images/1b9ee4af98ae54f3835f39ecfd4b2c1e96041e3e309ff5f653d8351fa5a65c30.svg" src="_images/1b9ee4af98ae54f3835f39ecfd4b2c1e96041e3e309ff5f653d8351fa5a65c30.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_van@40:model
</pre></div>
</div>
<img alt="_images/4e6e3e6686b5cb0d97982922a873431d7f42d5fe7f3cbe62db545eb31b8ab4cb.svg" src="_images/4e6e3e6686b5cb0d97982922a873431d7f42d5fe7f3cbe62db545eb31b8ab4cb.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_car@49:year
</pre></div>
</div>
<img alt="_images/263f457f6ae5c30dcf368dd37fb53b591a66af9c6ba371fe6a26df893174c7db.svg" src="_images/263f457f6ae5c30dcf368dd37fb53b591a66af9c6ba371fe6a26df893174c7db.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_car@49:company
</pre></div>
</div>
<img alt="_images/a1c131d94f989585235ad08b92ab43a97ea650f5d80686c4778438be8f043cc3.svg" src="_images/a1c131d94f989585235ad08b92ab43a97ea650f5d80686c4778438be8f043cc3.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_car@49:model
</pre></div>
</div>
<img alt="_images/ecb95e553bd994422e60063ee70a20d5c1c0272d78dba46e154f5ce30b6c4757.svg" src="_images/ecb95e553bd994422e60063ee70a20d5c1c0272d78dba46e154f5ce30b6c4757.svg" />
</div>
</div>
<p>The recovered grammar for URLs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">su</span> <span class="o">=</span> <span class="n">ScopedGrammarMiner</span><span class="p">()</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">url_dts</span><span class="p">:</span>
    <span class="n">su</span><span class="o">.</span><span class="n">add_tree</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="n">syntax_diagram</span><span class="p">(</span><span class="n">readable</span><span class="p">(</span><span class="n">su</span><span class="o">.</span><span class="n">grammar</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>start
</pre></div>
</div>
<img alt="_images/671506d4e54293356308a587f80c7e353d6fbfee1624b5c890b27b2115792c01.svg" src="_images/671506d4e54293356308a587f80c7e353d6fbfee1624b5c890b27b2115792c01.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlparse@374:url
</pre></div>
</div>
<img alt="_images/b06277ac1338f7c428c2b7ceafbcb78edb1bd70411afb4024832ba97d5d34350.svg" src="_images/b06277ac1338f7c428c2b7ceafbcb78edb1bd70411afb4024832ba97d5d34350.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlsplit@469:url
</pre></div>
</div>
<img alt="_images/9f5b67778cfb6cb2023564164f4c8443e38e5e6a90608a21416783f11ebb3c7e.svg" src="_images/9f5b67778cfb6cb2023564164f4c8443e38e5e6a90608a21416783f11ebb3c7e.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlsplit@509:scheme
</pre></div>
</div>
<img alt="_images/47d99256c93e87b807f4f6103affe5cff2e1e22e5ccbe07a3a089a1a87848452.svg" src="_images/47d99256c93e87b807f4f6103affe5cff2e1e22e5ccbe07a3a089a1a87848452.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlparse@396:scheme
</pre></div>
</div>
<img alt="_images/4b0db156a45750f69822d33089f76cf81a73e0a45f8151652b9cbcd0c2af6dba.svg" src="_images/4b0db156a45750f69822d33089f76cf81a73e0a45f8151652b9cbcd0c2af6dba.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlsplit@509:url
</pre></div>
</div>
<img alt="_images/19f63f50150d0ca587e2df830846ed90d6fb6878c5fd465dff98d0d91b799fbc.svg" src="_images/19f63f50150d0ca587e2df830846ed90d6fb6878c5fd465dff98d0d91b799fbc.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>_splitnetloc@413:url
</pre></div>
</div>
<img alt="_images/4a5f07b20370d3319dcedba1763a1d43f95037ebe6a4c72dcbe25b9bbb8fc247.svg" src="_images/4a5f07b20370d3319dcedba1763a1d43f95037ebe6a4c72dcbe25b9bbb8fc247.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlsplit@511:netloc
</pre></div>
</div>
<img alt="_images/925bbf0aa90d3f24737a50f968449c65b4bd9f83cd9807e77b68282e47685b78.svg" src="_images/925bbf0aa90d3f24737a50f968449c65b4bd9f83cd9807e77b68282e47685b78.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>_checknetloc@421:netloc
</pre></div>
</div>
<img alt="_images/c91f8ce449dd793ae0dfad0eb45063c30d46338918c211ad29752dceb8ecee75.svg" src="_images/c91f8ce449dd793ae0dfad0eb45063c30d46338918c211ad29752dceb8ecee75.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlparse@396:netloc
</pre></div>
</div>
<img alt="_images/44230824aadb05bf7b7a30c3c8796c9c697bf5d43dbac7a93a3ca48978ecd7bc.svg" src="_images/44230824aadb05bf7b7a30c3c8796c9c697bf5d43dbac7a93a3ca48978ecd7bc.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlsplit@511:url
</pre></div>
</div>
<img alt="_images/1435908bca4078adfe5a5f2efdd7197f659ea9dd457d296eb937368e462c76b4.svg" src="_images/1435908bca4078adfe5a5f2efdd7197f659ea9dd457d296eb937368e462c76b4.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlsplit@518:url
</pre></div>
</div>
<img alt="_images/cf9086b2e310e52e63ce16fa098ec7132352a5f20222ab30ce776152ca185306.svg" src="_images/cf9086b2e310e52e63ce16fa098ec7132352a5f20222ab30ce776152ca185306.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlsplit@520:query
</pre></div>
</div>
<img alt="_images/f1b0b3e8336b7359cf91c601cea3705bf43d5e32fdc5cf4be4d78cd0ba071612.svg" src="_images/f1b0b3e8336b7359cf91c601cea3705bf43d5e32fdc5cf4be4d78cd0ba071612.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlparse@396:query
</pre></div>
</div>
<img alt="_images/de5ded46744e5b7c67e252ef1e6584905ae59e3a3258135bbbcf6d2489bc30e1.svg" src="_images/de5ded46744e5b7c67e252ef1e6584905ae59e3a3258135bbbcf6d2489bc30e1.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlsplit@518:fragment
</pre></div>
</div>
<img alt="_images/c5a2dade7217d98921211c438e6c5b04aa78318dc7aecbb2b565d9a7e67907e7.svg" src="_images/c5a2dade7217d98921211c438e6c5b04aa78318dc7aecbb2b565d9a7e67907e7.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlparse@396:fragment
</pre></div>
</div>
<img alt="_images/b1807127561ada743af29d4ef4cf46599809761428c1f041734488b36269fe20.svg" src="_images/b1807127561ada743af29d4ef4cf46599809761428c1f041734488b36269fe20.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlparse@396:url
</pre></div>
</div>
<img alt="_images/1b3d67af485704bbc0825b2f527a52b29594985a73b8b83974db760124476ea1.svg" src="_images/1b3d67af485704bbc0825b2f527a52b29594985a73b8b83974db760124476ea1.svg" />
</div>
</div>
<p>One might notice that the grammar is not entirely human-readable, with a number of single token definitions.</p>
<p>Hence, the last piece of the puzzle is the cleanup method <code class="docutils literal notranslate"><span class="pre">clean_grammar()</span></code>, which cleans up such definitions. The idea is to look for single token definitions such that a key is defined exactly by another key (single alternative, single token, nonterminal).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ScopedGrammarMiner</span><span class="p">(</span><span class="n">ScopedGrammarMiner</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_replacements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grammar</span><span class="p">):</span>
        <span class="n">replacements</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">grammar</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">START_SYMBOL</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">alts</span> <span class="o">=</span> <span class="n">grammar</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">alts</span><span class="p">]))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">rule</span> <span class="o">=</span> <span class="n">alts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">tok</span> <span class="o">=</span> <span class="n">rule</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_nonterminal</span><span class="p">(</span><span class="n">tok</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">replacements</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">tok</span>
        <span class="k">return</span> <span class="n">replacements</span>
</pre></div>
</div>
</div>
</div>
<p>Once we have such a list, iteratively replace the original key where ever it is used with the token we found earlier. Repeat until none is left.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ScopedGrammarMiner</span><span class="p">(</span><span class="n">ScopedGrammarMiner</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">clean_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">replacements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_replacements</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">replacements</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">new_alts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">alt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="n">new_alt</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">alt</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">replacements</span><span class="p">:</span>
                            <span class="n">new_alt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">replacements</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
                            <span class="n">changed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">new_alt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">new_alts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_alt</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_alts</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">changed</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">changed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">readable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">clean_grammar()</span></code> is used as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">si</span> <span class="o">=</span> <span class="n">ScopedGrammarMiner</span><span class="p">()</span>
<span class="n">si</span><span class="o">.</span><span class="n">add_tree</span><span class="p">(</span><span class="n">inventory_dt</span><span class="p">)</span>
<span class="n">syntax_diagram</span><span class="p">(</span><span class="n">readable</span><span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">clean_grammar</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>start
</pre></div>
</div>
<img alt="_images/6c056864e9f0af26e9c19761beb74ab9bd60112b23d9108f164c758c404f723d.svg" src="_images/6c056864e9f0af26e9c19761beb74ab9bd60112b23d9108f164c758c404f723d.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_inventory@22:inventory
</pre></div>
</div>
<img alt="_images/ed6ed4edb28cbe61dd3df592ce5a27dc5d2cb006c310317db087a5d18610776f.svg" src="_images/ed6ed4edb28cbe61dd3df592ce5a27dc5d2cb006c310317db087a5d18610776f.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@29:vehicle
</pre></div>
</div>
<img alt="_images/5fcd32d403c69da30dea9e26247e65c3f3e260c06e1a3e1dedc4620f89417c5d.svg" src="_images/5fcd32d403c69da30dea9e26247e65c3f3e260c06e1a3e1dedc4620f89417c5d.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@30:year
</pre></div>
</div>
<img alt="_images/09b44707f6ced919217083f06665cd148302f4a85522318ec555e6ff6397b2e5.svg" src="_images/09b44707f6ced919217083f06665cd148302f4a85522318ec555e6ff6397b2e5.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_van@40:year
</pre></div>
</div>
<img alt="_images/dd84b034adfbd0fc337e1af20fc5114e420d6f95a9c507ad395dac04b92fb593.svg" src="_images/dd84b034adfbd0fc337e1af20fc5114e420d6f95a9c507ad395dac04b92fb593.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@30:kind
</pre></div>
</div>
<img alt="_images/d6a1f534cf99e7dc5738dfbb392886c1fe95da23c0341c7456c6c4736711c80e.svg" src="_images/d6a1f534cf99e7dc5738dfbb392886c1fe95da23c0341c7456c6c4736711c80e.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@30:company
</pre></div>
</div>
<img alt="_images/d24e873d9ab9979991e9597f0fb28fbfa9c9bdfac4967be2173bdb69ee6a231f.svg" src="_images/d24e873d9ab9979991e9597f0fb28fbfa9c9bdfac4967be2173bdb69ee6a231f.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_van@40:company
</pre></div>
</div>
<img alt="_images/5495c5732be2d54f42285617c92f98ec3a794c3e9c1561e09cdb66bdeafcf81d.svg" src="_images/5495c5732be2d54f42285617c92f98ec3a794c3e9c1561e09cdb66bdeafcf81d.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@30:model
</pre></div>
</div>
<img alt="_images/1b9ee4af98ae54f3835f39ecfd4b2c1e96041e3e309ff5f653d8351fa5a65c30.svg" src="_images/1b9ee4af98ae54f3835f39ecfd4b2c1e96041e3e309ff5f653d8351fa5a65c30.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_van@40:model
</pre></div>
</div>
<img alt="_images/4e6e3e6686b5cb0d97982922a873431d7f42d5fe7f3cbe62db545eb31b8ab4cb.svg" src="_images/4e6e3e6686b5cb0d97982922a873431d7f42d5fe7f3cbe62db545eb31b8ab4cb.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_car@49:year
</pre></div>
</div>
<img alt="_images/263f457f6ae5c30dcf368dd37fb53b591a66af9c6ba371fe6a26df893174c7db.svg" src="_images/263f457f6ae5c30dcf368dd37fb53b591a66af9c6ba371fe6a26df893174c7db.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_car@49:company
</pre></div>
</div>
<img alt="_images/a1c131d94f989585235ad08b92ab43a97ea650f5d80686c4778438be8f043cc3.svg" src="_images/a1c131d94f989585235ad08b92ab43a97ea650f5d80686c4778438be8f043cc3.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_car@49:model
</pre></div>
</div>
<img alt="_images/36eb0dc0792a6fb14ef562adaff2ca8ac36cc136be5ec975fe601815b430b16b.svg" src="_images/36eb0dc0792a6fb14ef562adaff2ca8ac36cc136be5ec975fe601815b430b16b.svg" />
</div>
</div>
<p>We update the <code class="docutils literal notranslate"><span class="pre">update_grammar()</span></code> to use the right tracker and miner.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ScopedGrammarMiner</span><span class="p">(</span><span class="n">ScopedGrammarMiner</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputstr</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_tracker</span><span class="p">(</span><span class="n">inputstr</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_tree_miner</span><span class="p">(</span>
            <span class="n">inputstr</span><span class="p">,</span> <span class="n">at</span><span class="o">.</span><span class="n">my_assignments</span><span class="o">.</span><span class="n">defined_vars</span><span class="p">(</span>
                <span class="n">formatted</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_tree</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_tracker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ScopeTracker</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_tree_miner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ScopeTreeMiner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">recover_grammar()</span></code> uses the right miner, and returns a cleaned grammar.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">recover_grammar</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="n">miner</span> <span class="o">=</span> <span class="n">ScopedGrammarMiner</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">inputstr</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">Tracer</span><span class="p">(</span><span class="n">inputstr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
            <span class="n">fn</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">)</span>
        <span class="n">miner</span><span class="o">.</span><span class="n">update_grammar</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="n">tracer</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">readable</span><span class="p">(</span><span class="n">miner</span><span class="o">.</span><span class="n">clean_grammar</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url_grammar</span> <span class="o">=</span> <span class="n">recover_grammar</span><span class="p">(</span><span class="n">url_parse</span><span class="p">,</span> <span class="n">URLS_X</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;urllib/parse.py&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">syntax_diagram</span><span class="p">(</span><span class="n">url_grammar</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>start
</pre></div>
</div>
<img alt="_images/b06277ac1338f7c428c2b7ceafbcb78edb1bd70411afb4024832ba97d5d34350.svg" src="_images/b06277ac1338f7c428c2b7ceafbcb78edb1bd70411afb4024832ba97d5d34350.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlsplit@469:url
</pre></div>
</div>
<img alt="_images/83886c01d3bacf2ad0eabfffd56eaa1c902a0ad7a0f9da61a33a4e5aa1a43e0b.svg" src="_images/83886c01d3bacf2ad0eabfffd56eaa1c902a0ad7a0f9da61a33a4e5aa1a43e0b.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlparse@396:scheme
</pre></div>
</div>
<img alt="_images/4b0db156a45750f69822d33089f76cf81a73e0a45f8151652b9cbcd0c2af6dba.svg" src="_images/4b0db156a45750f69822d33089f76cf81a73e0a45f8151652b9cbcd0c2af6dba.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>_splitnetloc@413:url
</pre></div>
</div>
<img alt="_images/4842e9cfc5629d48f4dddbd8c5624f98a9a178e979973034ae002572fc0da1a6.svg" src="_images/4842e9cfc5629d48f4dddbd8c5624f98a9a178e979973034ae002572fc0da1a6.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlparse@396:netloc
</pre></div>
</div>
<img alt="_images/44230824aadb05bf7b7a30c3c8796c9c697bf5d43dbac7a93a3ca48978ecd7bc.svg" src="_images/44230824aadb05bf7b7a30c3c8796c9c697bf5d43dbac7a93a3ca48978ecd7bc.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlsplit@511:url
</pre></div>
</div>
<img alt="_images/05bf9e86024f617aa576e3666ce55f0520cea30b0cef206c6ea837d876fba229.svg" src="_images/05bf9e86024f617aa576e3666ce55f0520cea30b0cef206c6ea837d876fba229.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlsplit@518:url
</pre></div>
</div>
<img alt="_images/e3061240e0a85b6c401488c81692b59f76eaab5b55c6512cf37acb776286dca8.svg" src="_images/e3061240e0a85b6c401488c81692b59f76eaab5b55c6512cf37acb776286dca8.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlparse@396:query
</pre></div>
</div>
<img alt="_images/de5ded46744e5b7c67e252ef1e6584905ae59e3a3258135bbbcf6d2489bc30e1.svg" src="_images/de5ded46744e5b7c67e252ef1e6584905ae59e3a3258135bbbcf6d2489bc30e1.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlparse@396:fragment
</pre></div>
</div>
<img alt="_images/b1807127561ada743af29d4ef4cf46599809761428c1f041734488b36269fe20.svg" src="_images/b1807127561ada743af29d4ef4cf46599809761428c1f041734488b36269fe20.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlparse@396:url
</pre></div>
</div>
<img alt="_images/1b3d67af485704bbc0825b2f527a52b29594985a73b8b83974db760124476ea1.svg" src="_images/1b3d67af485704bbc0825b2f527a52b29594985a73b8b83974db760124476ea1.svg" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">url_grammar</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ftp://freebsd.org/
ftp://freebsd.org/?q=path#ref
http://www.fuzzingbook.org/?q=path#ref
https://www.fuzzingbook.org/#News
http://www.fuzzingbook.org/?q=path#ref
ftp://user:pass@www.google.com:80/
ftp://www.cispa.saarland:80/#ref
ftp://user:pass@www.google.com:80/releases/5.8
https://user:pass@www.google.com:80/#ref
https://www.fuzzingbook.org/releases/5.8
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inventory_grammar</span> <span class="o">=</span> <span class="n">recover_grammar</span><span class="p">(</span><span class="n">process_inventory</span><span class="p">,</span> <span class="p">[</span><span class="n">INVENTORY</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">syntax_diagram</span><span class="p">(</span><span class="n">inventory_grammar</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>start
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<img alt="_images/6c056864e9f0af26e9c19761beb74ab9bd60112b23d9108f164c758c404f723d.svg" src="_images/6c056864e9f0af26e9c19761beb74ab9bd60112b23d9108f164c758c404f723d.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_inventory@22:inventory
</pre></div>
</div>
<img alt="_images/ed6ed4edb28cbe61dd3df592ce5a27dc5d2cb006c310317db087a5d18610776f.svg" src="_images/ed6ed4edb28cbe61dd3df592ce5a27dc5d2cb006c310317db087a5d18610776f.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@29:vehicle
</pre></div>
</div>
<img alt="_images/5fcd32d403c69da30dea9e26247e65c3f3e260c06e1a3e1dedc4620f89417c5d.svg" src="_images/5fcd32d403c69da30dea9e26247e65c3f3e260c06e1a3e1dedc4620f89417c5d.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@30:year
</pre></div>
</div>
<img alt="_images/09b44707f6ced919217083f06665cd148302f4a85522318ec555e6ff6397b2e5.svg" src="_images/09b44707f6ced919217083f06665cd148302f4a85522318ec555e6ff6397b2e5.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_van@40:year
</pre></div>
</div>
<img alt="_images/dd84b034adfbd0fc337e1af20fc5114e420d6f95a9c507ad395dac04b92fb593.svg" src="_images/dd84b034adfbd0fc337e1af20fc5114e420d6f95a9c507ad395dac04b92fb593.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@30:kind
</pre></div>
</div>
<img alt="_images/d6a1f534cf99e7dc5738dfbb392886c1fe95da23c0341c7456c6c4736711c80e.svg" src="_images/d6a1f534cf99e7dc5738dfbb392886c1fe95da23c0341c7456c6c4736711c80e.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@30:company
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<img alt="_images/d24e873d9ab9979991e9597f0fb28fbfa9c9bdfac4967be2173bdb69ee6a231f.svg" src="_images/d24e873d9ab9979991e9597f0fb28fbfa9c9bdfac4967be2173bdb69ee6a231f.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_van@40:company
</pre></div>
</div>
<img alt="_images/5495c5732be2d54f42285617c92f98ec3a794c3e9c1561e09cdb66bdeafcf81d.svg" src="_images/5495c5732be2d54f42285617c92f98ec3a794c3e9c1561e09cdb66bdeafcf81d.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@30:model
</pre></div>
</div>
<img alt="_images/1b9ee4af98ae54f3835f39ecfd4b2c1e96041e3e309ff5f653d8351fa5a65c30.svg" src="_images/1b9ee4af98ae54f3835f39ecfd4b2c1e96041e3e309ff5f653d8351fa5a65c30.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_van@40:model
</pre></div>
</div>
<img alt="_images/4e6e3e6686b5cb0d97982922a873431d7f42d5fe7f3cbe62db545eb31b8ab4cb.svg" src="_images/4e6e3e6686b5cb0d97982922a873431d7f42d5fe7f3cbe62db545eb31b8ab4cb.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_car@49:year
</pre></div>
</div>
<img alt="_images/263f457f6ae5c30dcf368dd37fb53b591a66af9c6ba371fe6a26df893174c7db.svg" src="_images/263f457f6ae5c30dcf368dd37fb53b591a66af9c6ba371fe6a26df893174c7db.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_car@49:company
</pre></div>
</div>
<img alt="_images/a1c131d94f989585235ad08b92ab43a97ea650f5d80686c4778438be8f043cc3.svg" src="_images/a1c131d94f989585235ad08b92ab43a97ea650f5d80686c4778438be8f043cc3.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_car@49:model
</pre></div>
</div>
<img alt="_images/36eb0dc0792a6fb14ef562adaff2ca8ac36cc136be5ec975fe601815b430b16b.svg" src="_images/36eb0dc0792a6fb14ef562adaff2ca8ac36cc136be5ec975fe601815b430b16b.svg" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">inventory_grammar</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1997,van,Ford,E350
1997,van,Ford,Venture
1997,car,Ford,E350
2000,car,Chevy,Cougar
1997,van,Ford,E350
2000,van,Chevy,E350
1997,car,Ford,E350
1997,van,Ford,E350
2000,van,Chevy,Cougar
1997,car,Ford,E350
1999,car,Ford,E350
2000,van,Ford,E350
1997,car,Ford,Cougar
2000,van,Chevy,Cougar
1997,van,Mercury,E350
1997,van,Ford,Venture
1999,van,Ford,Venture
1997,van,Ford,E350
1997,van,Ford,Cougar
2000,van,Chevy,Venture
1997,car,Chevy,E350
1997,van,Ford,E350
1997,car,Chevy,Venture
1999,car,Ford,E350
1999,car,Chevy,E350
1999,van,Ford,E350
1997,car,Ford,Cougar
1997,van,Chevy,E350
2000,van,Ford,Venture
1997,van,Ford,Cougar
</pre></div>
</div>
</div>
</div>
<p>We see how tracking scope helps us to extract an even more precise grammar.</p>
<p>Notice that we use <em>String</em> inclusion testing as a way of determining whether a particular string fragment came from the original input string. While this may seem rather error-prone compared to dynamic tainting, we note that numerous tracing tools such as <code class="docutils literal notranslate"><span class="pre">dtrace()</span></code> and <code class="docutils literal notranslate"><span class="pre">ptrace()</span></code> allow one to obtain the information we seek from execution of binaries directly in different platforms. However, methods for obtaining dynamic taints almost always involve instrumenting the binaries before they can be used. Hence, this method of string inclusion can be more generally applied than dynamic tainting approaches. Further, dynamic taints are often lost due to implicit transmission, or at the boundary between <em>Python</em> and <em>C</em> code. String inclusion has not such problems. Hence, our approach can often obtain better results than relying on dynamic tainting.</p>
</section>
</section>
<section id="lessons-learned">
<h2>Lessons Learned<a class="headerlink" href="#lessons-learned" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Given a set of sample inputs for a program, we can learn an input grammar by examining variable values during execution if the program relies on handwritten parsers.</p></li>
<li><p>Simple string inclusion checks are sufficient to obtain reasonably accurate grammars from real world programs.</p></li>
<li><p>The resulting grammars can be directly used for fuzzing, and can have a multiplier effect on any samples you have.</p></li>
</ul>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Learn how to use <a class="reference internal" href="InformationFlow.html"><span class="std std-doc">information flow</span></a> to further improve mapping inputs to states.</p></li>
</ul>
</section>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h2>
<p>Recovering the language from a <em>set of samples</em> (i.e., not taking into account a possible program that might process them) is a well researched topic.  The excellent reference by Higuera \cite{higuera2010grammatical} covers all the classical approaches. The current state of the art in black box grammar mining is described by Clark \cite{clark2013learning}.</p>
<p>Learning an input language from a <em>program</em>, with or without samples, is yet an emerging topic, despite its potential for fuzzing.  The pioneering work in this area was done by Lin et al. \cite{Lin2008} who invented a way to retrieve the parse trees from top down and bottom up parsers. The approach described in this chapter is based directly on the AUTOGRAM work of Hoschele et al. \cite{Hoschele2017}.</p>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<section id="exercise-1-flattening-complex-objects">
<h3>Exercise 1: Flattening complex objects<a class="headerlink" href="#exercise-1-flattening-complex-objects" title="Link to this heading">#</a></h3>
<p>Our grammar miners only check for string fragments. However, programs may often pass containers or custom objects containing input fragments. For example, consider the plausible modification for our inventory processor, where we use a custom object <code class="docutils literal notranslate"><span class="pre">Vehicle</span></code> to carry fragments.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Vehicle</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vehicle</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">year</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">company</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">company</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">year</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">company</span><span class="p">,</span> <span class="n">model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">process_inventory_with_obj</span><span class="p">(</span><span class="n">inventory</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">vehicle</span> <span class="ow">in</span> <span class="n">inventory</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">process_vehicle</span><span class="p">(</span><span class="n">vehicle</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">process_vehicle_with_obj</span><span class="p">(</span><span class="n">vehicle</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">Vehicle</span><span class="p">(</span><span class="n">vehicle</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;van&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">process_van_with_obj</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">v</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;car&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">process_car_with_obj</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid entry&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">process_van_with_obj</span><span class="p">(</span><span class="n">vehicle</span><span class="p">:</span> <span class="n">Vehicle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;We have a </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> van from </span><span class="si">%s</span><span class="s2"> vintage.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">vehicle</span><span class="o">.</span><span class="n">company</span><span class="p">,</span>
                                                  <span class="n">vehicle</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">iyear</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vehicle</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">iyear</span> <span class="o">&gt;</span> <span class="mi">2010</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;It is a recent model!&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;It is an old but reliable model!&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">process_car_with_obj</span><span class="p">(</span><span class="n">vehicle</span><span class="p">:</span> <span class="n">Vehicle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;We have a </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> car from </span><span class="si">%s</span><span class="s2"> vintage.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">vehicle</span><span class="o">.</span><span class="n">company</span><span class="p">,</span>
                                                  <span class="n">vehicle</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">iyear</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vehicle</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">iyear</span> <span class="o">&gt;</span> <span class="mi">2016</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;It is a recent model!&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;It is an old but reliable model!&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>
</pre></div>
</div>
</div>
</div>
<p>We recover the grammar as before.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vehicle_grammar</span> <span class="o">=</span> <span class="n">recover_grammar</span><span class="p">(</span>
    <span class="n">process_inventory_with_obj</span><span class="p">,</span>
    <span class="p">[</span><span class="n">INVENTORY</span><span class="p">],</span>
    <span class="n">methods</span><span class="o">=</span><span class="n">INVENTORY_METHODS</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The new vehicle grammar is missing in details, especially as to the different models and company for a van and car.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">syntax_diagram</span><span class="p">(</span><span class="n">vehicle_grammar</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>start
</pre></div>
</div>
<img alt="_images/ed6ed4edb28cbe61dd3df592ce5a27dc5d2cb006c310317db087a5d18610776f.svg" src="_images/ed6ed4edb28cbe61dd3df592ce5a27dc5d2cb006c310317db087a5d18610776f.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@29:vehicle
</pre></div>
</div>
<img alt="_images/5fcd32d403c69da30dea9e26247e65c3f3e260c06e1a3e1dedc4620f89417c5d.svg" src="_images/5fcd32d403c69da30dea9e26247e65c3f3e260c06e1a3e1dedc4620f89417c5d.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@30:year
</pre></div>
</div>
<img alt="_images/09b44707f6ced919217083f06665cd148302f4a85522318ec555e6ff6397b2e5.svg" src="_images/09b44707f6ced919217083f06665cd148302f4a85522318ec555e6ff6397b2e5.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_van@40:year
</pre></div>
</div>
<img alt="_images/dd84b034adfbd0fc337e1af20fc5114e420d6f95a9c507ad395dac04b92fb593.svg" src="_images/dd84b034adfbd0fc337e1af20fc5114e420d6f95a9c507ad395dac04b92fb593.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@30:kind
</pre></div>
</div>
<img alt="_images/d6a1f534cf99e7dc5738dfbb392886c1fe95da23c0341c7456c6c4736711c80e.svg" src="_images/d6a1f534cf99e7dc5738dfbb392886c1fe95da23c0341c7456c6c4736711c80e.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@30:company
</pre></div>
</div>
<img alt="_images/d24e873d9ab9979991e9597f0fb28fbfa9c9bdfac4967be2173bdb69ee6a231f.svg" src="_images/d24e873d9ab9979991e9597f0fb28fbfa9c9bdfac4967be2173bdb69ee6a231f.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_van@40:company
</pre></div>
</div>
<img alt="_images/5495c5732be2d54f42285617c92f98ec3a794c3e9c1561e09cdb66bdeafcf81d.svg" src="_images/5495c5732be2d54f42285617c92f98ec3a794c3e9c1561e09cdb66bdeafcf81d.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@30:model
</pre></div>
</div>
<img alt="_images/1b9ee4af98ae54f3835f39ecfd4b2c1e96041e3e309ff5f653d8351fa5a65c30.svg" src="_images/1b9ee4af98ae54f3835f39ecfd4b2c1e96041e3e309ff5f653d8351fa5a65c30.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_van@40:model
</pre></div>
</div>
<img alt="_images/4e6e3e6686b5cb0d97982922a873431d7f42d5fe7f3cbe62db545eb31b8ab4cb.svg" src="_images/4e6e3e6686b5cb0d97982922a873431d7f42d5fe7f3cbe62db545eb31b8ab4cb.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_car@49:year
</pre></div>
</div>
<img alt="_images/263f457f6ae5c30dcf368dd37fb53b591a66af9c6ba371fe6a26df893174c7db.svg" src="_images/263f457f6ae5c30dcf368dd37fb53b591a66af9c6ba371fe6a26df893174c7db.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_car@49:company
</pre></div>
</div>
<img alt="_images/a1c131d94f989585235ad08b92ab43a97ea650f5d80686c4778438be8f043cc3.svg" src="_images/a1c131d94f989585235ad08b92ab43a97ea650f5d80686c4778438be8f043cc3.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_car@49:model
</pre></div>
</div>
<img alt="_images/36eb0dc0792a6fb14ef562adaff2ca8ac36cc136be5ec975fe601815b430b16b.svg" src="_images/36eb0dc0792a6fb14ef562adaff2ca8ac36cc136be5ec975fe601815b430b16b.svg" />
</div>
</div>
<p>The problem is that, we are looking specifically for string objects that contain fragments of the input string during tracing. Can you modify our grammar miner to correctly account for the complex objects too?</p>
<p><strong>Solution.</strong></p>
<p>The problem can be understood if we execute the tracer under verbose logging.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Tracer</span><span class="p">(</span><span class="n">INVENTORY</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="n">INVENTORY_METHODS</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">process_inventory</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Traced values:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tracer</span><span class="o">.</span><span class="n">trace</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-&gt; Parser.ipynb:22:process_inventory(inventory)
   Parser.ipynb:23:process_inventory(inventory)
   Parser.ipynb:24:process_inventory(inventory)
   Parser.ipynb:25:process_inventory(inventory)
-&gt; Parser.ipynb:29:process_vehicle(vehicle)
   Parser.ipynb:30:process_vehicle(vehicle)
   Parser.ipynb:31:process_vehicle(vehicle)
   Parser.ipynb:32:process_vehicle(vehicle)
-&gt; Parser.ipynb:40:process_van(year,company,model)
   Parser.ipynb:40:process_van(year,company,model)
   Parser.ipynb:41:process_van(year,company,model)
   Parser.ipynb:42:process_van(year,company,model)
   Parser.ipynb:43:process_van(year,company,model)
   Parser.ipynb:46:process_van(year,company,model)
   Parser.ipynb:47:process_van(year,company,model)
&lt;- Parser.ipynb:47:process_van(year,company,model)
&lt;- Parser.ipynb:32:process_vehicle(vehicle)
   Parser.ipynb:26:process_inventory(inventory)
   Parser.ipynb:24:process_inventory(inventory)
   Parser.ipynb:25:process_inventory(inventory)
-&gt; Parser.ipynb:29:process_vehicle(vehicle)
   Parser.ipynb:30:process_vehicle(vehicle)
   Parser.ipynb:31:process_vehicle(vehicle)
   Parser.ipynb:34:process_vehicle(vehicle)
   Parser.ipynb:35:process_vehicle(vehicle)
-&gt; Parser.ipynb:49:process_car(year,company,model)
   Parser.ipynb:49:process_car(year,company,model)
   Parser.ipynb:50:process_car(year,company,model)
   Parser.ipynb:51:process_car(year,company,model)
   Parser.ipynb:52:process_car(year,company,model)
   Parser.ipynb:55:process_car(year,company,model)
   Parser.ipynb:56:process_car(year,company,model)
&lt;- Parser.ipynb:56:process_car(year,company,model)
&lt;- Parser.ipynb:35:process_vehicle(vehicle)
   Parser.ipynb:26:process_inventory(inventory)
   Parser.ipynb:24:process_inventory(inventory)
   Parser.ipynb:25:process_inventory(inventory)
-&gt; Parser.ipynb:29:process_vehicle(vehicle)
   Parser.ipynb:30:process_vehicle(vehicle)
   Parser.ipynb:31:process_vehicle(vehicle)
   Parser.ipynb:34:process_vehicle(vehicle)
   Parser.ipynb:35:process_vehicle(vehicle)
-&gt; Parser.ipynb:49:process_car(year,company,model)
   Parser.ipynb:49:process_car(year,company,model)
   Parser.ipynb:50:process_car(year,company,model)
   Parser.ipynb:51:process_car(year,company,model)
   Parser.ipynb:52:process_car(year,company,model)
   Parser.ipynb:55:process_car(year,company,model)
   Parser.ipynb:56:process_car(year,company,model)
&lt;- Parser.ipynb:56:process_car(year,company,model)
&lt;- Parser.ipynb:35:process_vehicle(vehicle)
   Parser.ipynb:26:process_inventory(inventory)
   Parser.ipynb:24:process_inventory(inventory)
   Parser.ipynb:27:process_inventory(inventory)
&lt;- Parser.ipynb:27:process_inventory(inventory)

Traced values:
(&#39;call&#39;, None, Parser.ipynb:22:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:23:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:24:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:25:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, &#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;})
(&#39;call&#39;, None, Parser.ipynb:29:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;})
(&#39;line&#39;, None, Parser.ipynb:30:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;})
(&#39;line&#39;, None, Parser.ipynb:31:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;, &#39;year&#39;: &#39;1997&#39;, &#39;kind&#39;: &#39;van&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;})
(&#39;line&#39;, None, Parser.ipynb:32:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;, &#39;year&#39;: &#39;1997&#39;, &#39;kind&#39;: &#39;van&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;})
(&#39;call&#39;, None, Parser.ipynb:40:process_van(year,company,model), {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;})
(&#39;line&#39;, None, Parser.ipynb:40:process_van(year,company,model), {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;})
(&#39;line&#39;, None, Parser.ipynb:41:process_van(year,company,model), {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;})
(&#39;line&#39;, None, Parser.ipynb:42:process_van(year,company,model), {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;})
(&#39;line&#39;, None, Parser.ipynb:43:process_van(year,company,model), {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;})
(&#39;line&#39;, None, Parser.ipynb:46:process_van(year,company,model), {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;})
(&#39;line&#39;, None, Parser.ipynb:47:process_van(year,company,model), {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;})
(&#39;return&#39;, [&#39;We have a Ford E350 van from 1997 vintage.&#39;, &#39;It is an old but reliable model!&#39;], Parser.ipynb:47:process_van(year,company,model), {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;})
(&#39;return&#39;, [&#39;We have a Ford E350 van from 1997 vintage.&#39;, &#39;It is an old but reliable model!&#39;], Parser.ipynb:32:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;, &#39;year&#39;: &#39;1997&#39;, &#39;kind&#39;: &#39;van&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;})
(&#39;line&#39;, None, Parser.ipynb:26:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, &#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;})
(&#39;line&#39;, None, Parser.ipynb:24:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, &#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;})
(&#39;line&#39;, None, Parser.ipynb:25:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, &#39;vehicle&#39;: &#39;2000,car,Mercury,Cougar&#39;})
(&#39;call&#39;, None, Parser.ipynb:29:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;2000,car,Mercury,Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:30:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;2000,car,Mercury,Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:31:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;2000,car,Mercury,Cougar&#39;, &#39;year&#39;: &#39;2000&#39;, &#39;kind&#39;: &#39;car&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:34:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;2000,car,Mercury,Cougar&#39;, &#39;year&#39;: &#39;2000&#39;, &#39;kind&#39;: &#39;car&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:35:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;2000,car,Mercury,Cougar&#39;, &#39;year&#39;: &#39;2000&#39;, &#39;kind&#39;: &#39;car&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;})
(&#39;call&#39;, None, Parser.ipynb:49:process_car(year,company,model), {&#39;year&#39;: &#39;2000&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:49:process_car(year,company,model), {&#39;year&#39;: &#39;2000&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:50:process_car(year,company,model), {&#39;year&#39;: &#39;2000&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:51:process_car(year,company,model), {&#39;year&#39;: &#39;2000&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:52:process_car(year,company,model), {&#39;year&#39;: &#39;2000&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:55:process_car(year,company,model), {&#39;year&#39;: &#39;2000&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:56:process_car(year,company,model), {&#39;year&#39;: &#39;2000&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;})
(&#39;return&#39;, [&#39;We have a Mercury Cougar car from 2000 vintage.&#39;, &#39;It is an old but reliable model!&#39;], Parser.ipynb:56:process_car(year,company,model), {&#39;year&#39;: &#39;2000&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;})
(&#39;return&#39;, [&#39;We have a Mercury Cougar car from 2000 vintage.&#39;, &#39;It is an old but reliable model!&#39;], Parser.ipynb:35:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;2000,car,Mercury,Cougar&#39;, &#39;year&#39;: &#39;2000&#39;, &#39;kind&#39;: &#39;car&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:26:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, &#39;vehicle&#39;: &#39;2000,car,Mercury,Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:24:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, &#39;vehicle&#39;: &#39;2000,car,Mercury,Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:25:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, &#39;vehicle&#39;: &#39;1999,car,Chevy,Venture&#39;})
(&#39;call&#39;, None, Parser.ipynb:29:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;1999,car,Chevy,Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:30:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;1999,car,Chevy,Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:31:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;1999,car,Chevy,Venture&#39;, &#39;year&#39;: &#39;1999&#39;, &#39;kind&#39;: &#39;car&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:34:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;1999,car,Chevy,Venture&#39;, &#39;year&#39;: &#39;1999&#39;, &#39;kind&#39;: &#39;car&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:35:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;1999,car,Chevy,Venture&#39;, &#39;year&#39;: &#39;1999&#39;, &#39;kind&#39;: &#39;car&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;})
(&#39;call&#39;, None, Parser.ipynb:49:process_car(year,company,model), {&#39;year&#39;: &#39;1999&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:49:process_car(year,company,model), {&#39;year&#39;: &#39;1999&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:50:process_car(year,company,model), {&#39;year&#39;: &#39;1999&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:51:process_car(year,company,model), {&#39;year&#39;: &#39;1999&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:52:process_car(year,company,model), {&#39;year&#39;: &#39;1999&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:55:process_car(year,company,model), {&#39;year&#39;: &#39;1999&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:56:process_car(year,company,model), {&#39;year&#39;: &#39;1999&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;})
(&#39;return&#39;, [&#39;We have a Chevy Venture car from 1999 vintage.&#39;, &#39;It is an old but reliable model!&#39;], Parser.ipynb:56:process_car(year,company,model), {&#39;year&#39;: &#39;1999&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;})
(&#39;return&#39;, [&#39;We have a Chevy Venture car from 1999 vintage.&#39;, &#39;It is an old but reliable model!&#39;], Parser.ipynb:35:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;1999,car,Chevy,Venture&#39;, &#39;year&#39;: &#39;1999&#39;, &#39;kind&#39;: &#39;car&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:26:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, &#39;vehicle&#39;: &#39;1999,car,Chevy,Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:24:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, &#39;vehicle&#39;: &#39;1999,car,Chevy,Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:27:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, &#39;vehicle&#39;: &#39;1999,car,Chevy,Venture&#39;})
(&#39;return&#39;, &#39;We have a Ford E350 van from 1997 vintage.\nIt is an old but reliable model!\nWe have a Mercury Cougar car from 2000 vintage.\nIt is an old but reliable model!\nWe have a Chevy Venture car from 1999 vintage.\nIt is an old but reliable model!&#39;, Parser.ipynb:27:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, &#39;vehicle&#39;: &#39;1999,car,Chevy,Venture&#39;})
</pre></div>
</div>
</div>
</div>
<p>You can see that we lose track of string fragments as soon as they are incorporated into the <code class="docutils literal notranslate"><span class="pre">Vehicle</span></code> object. The way out is to trace these variables separately.</p>
<p>For that, we develop the <code class="docutils literal notranslate"><span class="pre">flatten()</span></code> method that given any custom complex object and its key, returns a list of flattened (<em>key</em>, <em>value</em>) pairs that correspond to the object passed in.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">MAX_DEPTH</span></code> parameter controls the maximum flattening limit.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MAX_DEPTH</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">set_flatten_depth</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">MAX_DEPTH</span>
    <span class="n">MAX_DEPTH</span> <span class="o">=</span> <span class="n">depth</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">flatten</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">MAX_DEPTH</span><span class="p">):</span>
    <span class="n">tv</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">depth</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">)):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">range</span><span class="p">)):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">elt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">flatten</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">elt</span><span class="p">,</span> <span class="n">depth</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">[(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">elt</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">flatten</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">elt</span><span class="p">,</span> <span class="n">depth</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">[(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s1">&#39;__dict__&#39;</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">elt</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                  <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">flatten</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">elt</span><span class="p">,</span> <span class="n">depth</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">[(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we hook the <code class="docutils literal notranslate"><span class="pre">flatten()</span></code> into the <code class="docutils literal notranslate"><span class="pre">Context</span></code> class so that the parameters we obtain are flattened.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Context</span><span class="p">(</span><span class="n">Context</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargvalues</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span><span class="o">.</span><span class="n">locals</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k1</span><span class="p">:</span> <span class="n">v1</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">k1</span><span class="p">,</span> <span class="n">v1</span> <span class="ow">in</span> <span class="n">flatten</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_vars</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">check_param</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_names</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">all_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">check_param</span><span class="p">(</span><span class="n">k</span><span class="p">)}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">qualified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_vars</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">all_vars</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</pre></div>
</div>
</div>
</div>
<p>With this change, we have the following trace output.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Tracer</span><span class="p">(</span><span class="n">INVENTORY</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="n">INVENTORY_METHODS</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
    <span class="n">process_inventory</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Traced values:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tracer</span><span class="o">.</span><span class="n">trace</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-&gt; Parser.ipynb:22:process_inventory(inventory)
   Parser.ipynb:23:process_inventory(inventory)
   Parser.ipynb:24:process_inventory(inventory)
   Parser.ipynb:25:process_inventory(inventory)
-&gt; Parser.ipynb:29:process_vehicle(vehicle)
   Parser.ipynb:30:process_vehicle(vehicle)
   Parser.ipynb:31:process_vehicle(vehicle)
   Parser.ipynb:32:process_vehicle(vehicle)
-&gt; Parser.ipynb:40:process_van(year,company,model)
   Parser.ipynb:40:process_van(year,company,model)
   Parser.ipynb:41:process_van(year,company,model)
   Parser.ipynb:42:process_van(year,company,model)
   Parser.ipynb:43:process_van(year,company,model)
   Parser.ipynb:46:process_van(year,company,model)
   Parser.ipynb:47:process_van(year,company,model)
&lt;- Parser.ipynb:47:process_van(year,company,model)
&lt;- Parser.ipynb:32:process_vehicle(vehicle)
   Parser.ipynb:26:process_inventory(inventory)
   Parser.ipynb:24:process_inventory(inventory)
   Parser.ipynb:25:process_inventory(inventory)
-&gt; Parser.ipynb:29:process_vehicle(vehicle)
   Parser.ipynb:30:process_vehicle(vehicle)
   Parser.ipynb:31:process_vehicle(vehicle)
   Parser.ipynb:34:process_vehicle(vehicle)
   Parser.ipynb:35:process_vehicle(vehicle)
-&gt; Parser.ipynb:49:process_car(year,company,model)
   Parser.ipynb:49:process_car(year,company,model)
   Parser.ipynb:50:process_car(year,company,model)
   Parser.ipynb:51:process_car(year,company,model)
   Parser.ipynb:52:process_car(year,company,model)
   Parser.ipynb:55:process_car(year,company,model)
   Parser.ipynb:56:process_car(year,company,model)
&lt;- Parser.ipynb:56:process_car(year,company,model)
&lt;- Parser.ipynb:35:process_vehicle(vehicle)
   Parser.ipynb:26:process_inventory(inventory)
   Parser.ipynb:24:process_inventory(inventory)
   Parser.ipynb:25:process_inventory(inventory)
-&gt; Parser.ipynb:29:process_vehicle(vehicle)
   Parser.ipynb:30:process_vehicle(vehicle)
   Parser.ipynb:31:process_vehicle(vehicle)
   Parser.ipynb:34:process_vehicle(vehicle)
   Parser.ipynb:35:process_vehicle(vehicle)
-&gt; Parser.ipynb:49:process_car(year,company,model)
   Parser.ipynb:49:process_car(year,company,model)
   Parser.ipynb:50:process_car(year,company,model)
   Parser.ipynb:51:process_car(year,company,model)
   Parser.ipynb:52:process_car(year,company,model)
   Parser.ipynb:55:process_car(year,company,model)
   Parser.ipynb:56:process_car(year,company,model)
&lt;- Parser.ipynb:56:process_car(year,company,model)
&lt;- Parser.ipynb:35:process_vehicle(vehicle)
   Parser.ipynb:26:process_inventory(inventory)
   Parser.ipynb:24:process_inventory(inventory)
   Parser.ipynb:27:process_inventory(inventory)
&lt;- Parser.ipynb:27:process_inventory(inventory)

Traced values:
(&#39;call&#39;, None, Parser.ipynb:22:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:23:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:24:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:25:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, &#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;})
(&#39;call&#39;, None, Parser.ipynb:29:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;})
(&#39;line&#39;, None, Parser.ipynb:30:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;})
(&#39;line&#39;, None, Parser.ipynb:31:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;, &#39;year&#39;: &#39;1997&#39;, &#39;kind&#39;: &#39;van&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;})
(&#39;line&#39;, None, Parser.ipynb:32:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;, &#39;year&#39;: &#39;1997&#39;, &#39;kind&#39;: &#39;van&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;})
(&#39;call&#39;, None, Parser.ipynb:40:process_van(year,company,model), {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;})
(&#39;line&#39;, None, Parser.ipynb:40:process_van(year,company,model), {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;})
(&#39;line&#39;, None, Parser.ipynb:41:process_van(year,company,model), {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;})
(&#39;line&#39;, None, Parser.ipynb:42:process_van(year,company,model), {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;})
(&#39;line&#39;, None, Parser.ipynb:43:process_van(year,company,model), {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;})
(&#39;line&#39;, None, Parser.ipynb:46:process_van(year,company,model), {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;})
(&#39;line&#39;, None, Parser.ipynb:47:process_van(year,company,model), {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;})
(&#39;return&#39;, [&#39;We have a Ford E350 van from 1997 vintage.&#39;, &#39;It is an old but reliable model!&#39;], Parser.ipynb:47:process_van(year,company,model), {&#39;year&#39;: &#39;1997&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;})
(&#39;return&#39;, [&#39;We have a Ford E350 van from 1997 vintage.&#39;, &#39;It is an old but reliable model!&#39;], Parser.ipynb:32:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;, &#39;year&#39;: &#39;1997&#39;, &#39;kind&#39;: &#39;van&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;})
(&#39;line&#39;, None, Parser.ipynb:26:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, &#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;})
(&#39;line&#39;, None, Parser.ipynb:24:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, &#39;vehicle&#39;: &#39;1997,van,Ford,E350&#39;})
(&#39;line&#39;, None, Parser.ipynb:25:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, &#39;vehicle&#39;: &#39;2000,car,Mercury,Cougar&#39;})
(&#39;call&#39;, None, Parser.ipynb:29:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;2000,car,Mercury,Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:30:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;2000,car,Mercury,Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:31:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;2000,car,Mercury,Cougar&#39;, &#39;year&#39;: &#39;2000&#39;, &#39;kind&#39;: &#39;car&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:34:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;2000,car,Mercury,Cougar&#39;, &#39;year&#39;: &#39;2000&#39;, &#39;kind&#39;: &#39;car&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:35:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;2000,car,Mercury,Cougar&#39;, &#39;year&#39;: &#39;2000&#39;, &#39;kind&#39;: &#39;car&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;})
(&#39;call&#39;, None, Parser.ipynb:49:process_car(year,company,model), {&#39;year&#39;: &#39;2000&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:49:process_car(year,company,model), {&#39;year&#39;: &#39;2000&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:50:process_car(year,company,model), {&#39;year&#39;: &#39;2000&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:51:process_car(year,company,model), {&#39;year&#39;: &#39;2000&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:52:process_car(year,company,model), {&#39;year&#39;: &#39;2000&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:55:process_car(year,company,model), {&#39;year&#39;: &#39;2000&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:56:process_car(year,company,model), {&#39;year&#39;: &#39;2000&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;})
(&#39;return&#39;, [&#39;We have a Mercury Cougar car from 2000 vintage.&#39;, &#39;It is an old but reliable model!&#39;], Parser.ipynb:56:process_car(year,company,model), {&#39;year&#39;: &#39;2000&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;})
(&#39;return&#39;, [&#39;We have a Mercury Cougar car from 2000 vintage.&#39;, &#39;It is an old but reliable model!&#39;], Parser.ipynb:35:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;2000,car,Mercury,Cougar&#39;, &#39;year&#39;: &#39;2000&#39;, &#39;kind&#39;: &#39;car&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:26:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, &#39;vehicle&#39;: &#39;2000,car,Mercury,Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:24:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, &#39;vehicle&#39;: &#39;2000,car,Mercury,Cougar&#39;})
(&#39;line&#39;, None, Parser.ipynb:25:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, &#39;vehicle&#39;: &#39;1999,car,Chevy,Venture&#39;})
(&#39;call&#39;, None, Parser.ipynb:29:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;1999,car,Chevy,Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:30:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;1999,car,Chevy,Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:31:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;1999,car,Chevy,Venture&#39;, &#39;year&#39;: &#39;1999&#39;, &#39;kind&#39;: &#39;car&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:34:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;1999,car,Chevy,Venture&#39;, &#39;year&#39;: &#39;1999&#39;, &#39;kind&#39;: &#39;car&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:35:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;1999,car,Chevy,Venture&#39;, &#39;year&#39;: &#39;1999&#39;, &#39;kind&#39;: &#39;car&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;})
(&#39;call&#39;, None, Parser.ipynb:49:process_car(year,company,model), {&#39;year&#39;: &#39;1999&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:49:process_car(year,company,model), {&#39;year&#39;: &#39;1999&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:50:process_car(year,company,model), {&#39;year&#39;: &#39;1999&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:51:process_car(year,company,model), {&#39;year&#39;: &#39;1999&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:52:process_car(year,company,model), {&#39;year&#39;: &#39;1999&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:55:process_car(year,company,model), {&#39;year&#39;: &#39;1999&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:56:process_car(year,company,model), {&#39;year&#39;: &#39;1999&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;})
(&#39;return&#39;, [&#39;We have a Chevy Venture car from 1999 vintage.&#39;, &#39;It is an old but reliable model!&#39;], Parser.ipynb:56:process_car(year,company,model), {&#39;year&#39;: &#39;1999&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;})
(&#39;return&#39;, [&#39;We have a Chevy Venture car from 1999 vintage.&#39;, &#39;It is an old but reliable model!&#39;], Parser.ipynb:35:process_vehicle(vehicle), {&#39;vehicle&#39;: &#39;1999,car,Chevy,Venture&#39;, &#39;year&#39;: &#39;1999&#39;, &#39;kind&#39;: &#39;car&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:26:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, &#39;vehicle&#39;: &#39;1999,car,Chevy,Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:24:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, &#39;vehicle&#39;: &#39;1999,car,Chevy,Venture&#39;})
(&#39;line&#39;, None, Parser.ipynb:27:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, &#39;vehicle&#39;: &#39;1999,car,Chevy,Venture&#39;})
(&#39;return&#39;, &#39;We have a Ford E350 van from 1997 vintage.\nIt is an old but reliable model!\nWe have a Mercury Cougar car from 2000 vintage.\nIt is an old but reliable model!\nWe have a Chevy Venture car from 1999 vintage.\nIt is an old but reliable model!&#39;, Parser.ipynb:27:process_inventory(inventory), {&#39;inventory&#39;: &#39;1997,van,Ford,E350\n2000,car,Mercury,Cougar\n1999,car,Chevy,Venture&#39;, &#39;vehicle&#39;: &#39;1999,car,Chevy,Venture&#39;})
</pre></div>
</div>
</div>
</div>
<p>Our change seems to have worked. Let us derive the grammar.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vehicle_grammar</span> <span class="o">=</span> <span class="n">recover_grammar</span><span class="p">(</span>
    <span class="n">process_inventory</span><span class="p">,</span>
    <span class="p">[</span><span class="n">INVENTORY</span><span class="p">],</span>
    <span class="n">methods</span><span class="o">=</span><span class="n">INVENTORY_METHODS</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">syntax_diagram</span><span class="p">(</span><span class="n">vehicle_grammar</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>start
</pre></div>
</div>
<img alt="_images/6c056864e9f0af26e9c19761beb74ab9bd60112b23d9108f164c758c404f723d.svg" src="_images/6c056864e9f0af26e9c19761beb74ab9bd60112b23d9108f164c758c404f723d.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_inventory@22:inventory
</pre></div>
</div>
<img alt="_images/ed6ed4edb28cbe61dd3df592ce5a27dc5d2cb006c310317db087a5d18610776f.svg" src="_images/ed6ed4edb28cbe61dd3df592ce5a27dc5d2cb006c310317db087a5d18610776f.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@29:vehicle
</pre></div>
</div>
<img alt="_images/5fcd32d403c69da30dea9e26247e65c3f3e260c06e1a3e1dedc4620f89417c5d.svg" src="_images/5fcd32d403c69da30dea9e26247e65c3f3e260c06e1a3e1dedc4620f89417c5d.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@30:year
</pre></div>
</div>
<img alt="_images/09b44707f6ced919217083f06665cd148302f4a85522318ec555e6ff6397b2e5.svg" src="_images/09b44707f6ced919217083f06665cd148302f4a85522318ec555e6ff6397b2e5.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_van@40:year
</pre></div>
</div>
<img alt="_images/dd84b034adfbd0fc337e1af20fc5114e420d6f95a9c507ad395dac04b92fb593.svg" src="_images/dd84b034adfbd0fc337e1af20fc5114e420d6f95a9c507ad395dac04b92fb593.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@30:kind
</pre></div>
</div>
<img alt="_images/d6a1f534cf99e7dc5738dfbb392886c1fe95da23c0341c7456c6c4736711c80e.svg" src="_images/d6a1f534cf99e7dc5738dfbb392886c1fe95da23c0341c7456c6c4736711c80e.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@30:company
</pre></div>
</div>
<img alt="_images/d24e873d9ab9979991e9597f0fb28fbfa9c9bdfac4967be2173bdb69ee6a231f.svg" src="_images/d24e873d9ab9979991e9597f0fb28fbfa9c9bdfac4967be2173bdb69ee6a231f.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_van@40:company
</pre></div>
</div>
<img alt="_images/5495c5732be2d54f42285617c92f98ec3a794c3e9c1561e09cdb66bdeafcf81d.svg" src="_images/5495c5732be2d54f42285617c92f98ec3a794c3e9c1561e09cdb66bdeafcf81d.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@30:model
</pre></div>
</div>
<img alt="_images/1b9ee4af98ae54f3835f39ecfd4b2c1e96041e3e309ff5f653d8351fa5a65c30.svg" src="_images/1b9ee4af98ae54f3835f39ecfd4b2c1e96041e3e309ff5f653d8351fa5a65c30.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_van@40:model
</pre></div>
</div>
<img alt="_images/4e6e3e6686b5cb0d97982922a873431d7f42d5fe7f3cbe62db545eb31b8ab4cb.svg" src="_images/4e6e3e6686b5cb0d97982922a873431d7f42d5fe7f3cbe62db545eb31b8ab4cb.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_car@49:year
</pre></div>
</div>
<img alt="_images/263f457f6ae5c30dcf368dd37fb53b591a66af9c6ba371fe6a26df893174c7db.svg" src="_images/263f457f6ae5c30dcf368dd37fb53b591a66af9c6ba371fe6a26df893174c7db.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_car@49:company
</pre></div>
</div>
<img alt="_images/a1c131d94f989585235ad08b92ab43a97ea650f5d80686c4778438be8f043cc3.svg" src="_images/a1c131d94f989585235ad08b92ab43a97ea650f5d80686c4778438be8f043cc3.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_car@49:model
</pre></div>
</div>
<img alt="_images/36eb0dc0792a6fb14ef562adaff2ca8ac36cc136be5ec975fe601815b430b16b.svg" src="_images/36eb0dc0792a6fb14ef562adaff2ca8ac36cc136be5ec975fe601815b430b16b.svg" />
</div>
</div>
<p>The recovered grammar contains all the details that we were able to recover before.</p>
</section>
<section id="exercise-2-incorporating-taints-from-informationflow">
<h3>Exercise 2: Incorporating Taints from InformationFlow<a class="headerlink" href="#exercise-2-incorporating-taints-from-informationflow" title="Link to this heading">#</a></h3>
<p>We have been using <em>string inclusion</em> to check whether a particular fragment came from the input string. This is unsatisfactory as it required us to compromise on the size of the strings tracked, which was limited to those greater than <code class="docutils literal notranslate"><span class="pre">FRAGMENT_LEN</span></code>. Further, it is possible that a single method could process a string where a fragment repeats, but is part of different tokens. For example, an embedded comma in the CSV file would cause our parser to fail. One way to avoid this is to rely on <em>dynamic taints</em>, and check for taint inclusion rather than string inclusion.</p>
<p>The chapter on <a class="reference internal" href="InformationFlow.html"><span class="std std-doc">information flow</span></a> details how to incorporate dynamic taints. Can you update our grammar miner based on scope to use <em>dynamic taints</em> instead?</p>
<p><strong>Solution.</strong></p>
<p>First, we import <code class="docutils literal notranslate"><span class="pre">ostr</span></code> to track the origins of string fragments.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">InformationFlow</span><span class="w"> </span><span class="kn">import</span> <span class="n">ostr</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we define <code class="docutils literal notranslate"><span class="pre">is_fragment()</span></code> to verify that a fragment is from a given input string.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">is_fragment</span><span class="p">(</span><span class="n">fragment</span><span class="p">,</span> <span class="n">original</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">ostr</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fragment</span><span class="p">,</span> <span class="n">ostr</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">fragment</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, all that remains is to hook the tainted fragment check to our grammar miner. This is accomplished by modifying <code class="docutils literal notranslate"><span class="pre">in_current_record()</span></code> and <code class="docutils literal notranslate"><span class="pre">ignored()</span></code> methods in the <code class="docutils literal notranslate"><span class="pre">InputStack</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TaintedInputStack</span><span class="p">(</span><span class="n">InputStack</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">in_current_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">is_fragment</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TaintedInputStack</span><span class="p">(</span><span class="n">TaintedInputStack</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ignored</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ostr</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We then hook in the <code class="docutils literal notranslate"><span class="pre">TaintedInputStack</span></code> to the grammar mining infrastructure.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TaintedScopedVars</span><span class="p">(</span><span class="n">ScopedVars</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_call_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TaintedInputStack</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TaintedScopeTracker</span><span class="p">(</span><span class="n">ScopeTracker</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_assignments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TaintedScopedVars</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TaintedScopeTreeMiner</span><span class="p">(</span><span class="n">ScopeTreeMiner</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">string_part_of_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">part</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">is_fragment</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">partition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">part</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">value</span><span class="p">[:</span><span class="n">begin</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="n">end</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<!-- **Advanced.** The *dynamic taint* approach is limited in that it can not observe implicit flows. For example, consider the fragment below.

```python
if my_fragment == 'begin':
    return 'begin'
```

In this case, we lose track of the string `begin` that is returned even though it is dependent on the value of `my_fragment`. For such cases, a better (but costly) alternative is to rely on concolic execution and capture the constraints as it relates to input characters on each variable.

The chapter on [concolic fuzzing](ConcolicFuzzer.ipynb) details how to incorporate concolic symbolic execution to program execution. Can you update our grammar miner to use *concolic execution* to track taints instead?
--><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TaintedScopedGrammarMiner</span><span class="p">(</span><span class="n">ScopedGrammarMiner</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_tracker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TaintedScopeTracker</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_tree_miner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TaintedScopeTreeMiner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we define <code class="docutils literal notranslate"><span class="pre">recover_grammar_with_taints()</span></code> to recover the grammar.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">recover_grammar_with_taints</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">miner</span> <span class="o">=</span> <span class="n">TaintedScopedGrammarMiner</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">inputstr</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">Tracer</span><span class="p">(</span><span class="n">ostr</span><span class="p">(</span><span class="n">inputstr</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">tracer</span><span class="p">:</span>
            <span class="n">fn</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">)</span>
        <span class="n">miner</span><span class="o">.</span><span class="n">update_grammar</span><span class="p">(</span><span class="n">tracer</span><span class="o">.</span><span class="n">my_input</span><span class="p">,</span> <span class="n">tracer</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">readable</span><span class="p">(</span><span class="n">miner</span><span class="o">.</span><span class="n">clean_grammar</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<p>Here is how one can use it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inventory_grammar</span> <span class="o">=</span> <span class="n">recover_grammar_with_taints</span><span class="p">(</span>
    <span class="n">process_inventory</span><span class="p">,</span> <span class="p">[</span><span class="n">INVENTORY</span><span class="p">],</span>
    <span class="n">methods</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;process_inventory&#39;</span><span class="p">,</span> <span class="s1">&#39;process_vehicle&#39;</span><span class="p">,</span> <span class="s1">&#39;process_car&#39;</span><span class="p">,</span> <span class="s1">&#39;process_van&#39;</span>
    <span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">syntax_diagram</span><span class="p">(</span><span class="n">inventory_grammar</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>start
</pre></div>
</div>
<img alt="_images/6c056864e9f0af26e9c19761beb74ab9bd60112b23d9108f164c758c404f723d.svg" src="_images/6c056864e9f0af26e9c19761beb74ab9bd60112b23d9108f164c758c404f723d.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_inventory@22:inventory
</pre></div>
</div>
<img alt="_images/ed6ed4edb28cbe61dd3df592ce5a27dc5d2cb006c310317db087a5d18610776f.svg" src="_images/ed6ed4edb28cbe61dd3df592ce5a27dc5d2cb006c310317db087a5d18610776f.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@29:vehicle
</pre></div>
</div>
<img alt="_images/5fcd32d403c69da30dea9e26247e65c3f3e260c06e1a3e1dedc4620f89417c5d.svg" src="_images/5fcd32d403c69da30dea9e26247e65c3f3e260c06e1a3e1dedc4620f89417c5d.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@30:year
</pre></div>
</div>
<img alt="_images/09b44707f6ced919217083f06665cd148302f4a85522318ec555e6ff6397b2e5.svg" src="_images/09b44707f6ced919217083f06665cd148302f4a85522318ec555e6ff6397b2e5.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_van@40:year
</pre></div>
</div>
<img alt="_images/dd84b034adfbd0fc337e1af20fc5114e420d6f95a9c507ad395dac04b92fb593.svg" src="_images/dd84b034adfbd0fc337e1af20fc5114e420d6f95a9c507ad395dac04b92fb593.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@30:kind
</pre></div>
</div>
<img alt="_images/d6a1f534cf99e7dc5738dfbb392886c1fe95da23c0341c7456c6c4736711c80e.svg" src="_images/d6a1f534cf99e7dc5738dfbb392886c1fe95da23c0341c7456c6c4736711c80e.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@30:company
</pre></div>
</div>
<img alt="_images/d24e873d9ab9979991e9597f0fb28fbfa9c9bdfac4967be2173bdb69ee6a231f.svg" src="_images/d24e873d9ab9979991e9597f0fb28fbfa9c9bdfac4967be2173bdb69ee6a231f.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_van@40:company
</pre></div>
</div>
<img alt="_images/5495c5732be2d54f42285617c92f98ec3a794c3e9c1561e09cdb66bdeafcf81d.svg" src="_images/5495c5732be2d54f42285617c92f98ec3a794c3e9c1561e09cdb66bdeafcf81d.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_vehicle@30:model
</pre></div>
</div>
<img alt="_images/1b9ee4af98ae54f3835f39ecfd4b2c1e96041e3e309ff5f653d8351fa5a65c30.svg" src="_images/1b9ee4af98ae54f3835f39ecfd4b2c1e96041e3e309ff5f653d8351fa5a65c30.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_van@40:model
</pre></div>
</div>
<img alt="_images/4e6e3e6686b5cb0d97982922a873431d7f42d5fe7f3cbe62db545eb31b8ab4cb.svg" src="_images/4e6e3e6686b5cb0d97982922a873431d7f42d5fe7f3cbe62db545eb31b8ab4cb.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_car@49:year
</pre></div>
</div>
<img alt="_images/263f457f6ae5c30dcf368dd37fb53b591a66af9c6ba371fe6a26df893174c7db.svg" src="_images/263f457f6ae5c30dcf368dd37fb53b591a66af9c6ba371fe6a26df893174c7db.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_car@49:company
</pre></div>
</div>
<img alt="_images/a1c131d94f989585235ad08b92ab43a97ea650f5d80686c4778438be8f043cc3.svg" src="_images/a1c131d94f989585235ad08b92ab43a97ea650f5d80686c4778438be8f043cc3.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>process_car@49:model
</pre></div>
</div>
<img alt="_images/36eb0dc0792a6fb14ef562adaff2ca8ac36cc136be5ec975fe601815b430b16b.svg" src="_images/36eb0dc0792a6fb14ef562adaff2ca8ac36cc136be5ec975fe601815b430b16b.svg" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url_grammar</span> <span class="o">=</span> <span class="n">recover_grammar_with_taints</span><span class="p">(</span>
    <span class="n">url_parse</span><span class="p">,</span> <span class="n">URLS_X</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;ftp://user4:pass1@host4/?key4=value3&#39;</span><span class="p">],</span>
    <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;urlsplit&#39;</span><span class="p">,</span> <span class="s1">&#39;urlparse&#39;</span><span class="p">,</span> <span class="s1">&#39;_splitnetloc&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="FuzzingWithConstraints.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Fuzzing with Constraints</p>
      </div>
    </a>
    <a class="right-next"
       href="InformationFlow.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Tracking Information Flow</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-grammar-challenge">A Grammar Challenge</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-simple-grammar-miner">A Simple Grammar Miner</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tracer">Tracer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#context">Context</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#definetracker">DefineTracker</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assembling-a-derivation-tree">Assembling a Derivation Tree</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#recovering-grammars-from-derivation-trees">Recovering Grammars from Derivation Trees</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-1-recovering-the-inventory-grammar">Example 1. Recovering the Inventory Grammar</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2-recovering-url-grammar">Example 2. Recovering URL Grammar</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fuzzing">Fuzzing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problems-with-the-simple-miner">Problems with the Simple Miner</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#grammar-miner-with-reassignment">Grammar Miner with Reassignment</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tracking-variable-assignment-locations">Tracking variable assignment locations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#callstack">CallStack</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#vars">Vars</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assignmentvars">AssignmentVars</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#assignmenttracker">AssignmentTracker</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#recovering-a-derivation-tree">Recovering a Derivation Tree</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-1-recovering-url-derivation-tree">Example 1: Recovering URL Derivation Tree</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#url-1-derivation-tree">URL 1 derivation tree</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#url-4-derivation-tree">URL 4 derivation tree</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#recover-grammar">Recover Grammar</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2-recovering-inventory-grammar">Example 2: Recovering Inventory Grammar</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#problems-with-the-grammar-miner-with-reassignment">Problems with the Grammar Miner with Reassignment</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-grammar-miner-with-scope">A Grammar Miner with Scope</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#input-stack">Input Stack</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#scopedvars">ScopedVars</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#scope-tracker">Scope Tracker</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Recovering a Derivation Tree</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-1-recovering-url-parse-tree">Example 1: Recovering URL Parse Tree</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2-recovering-inventory-parse-tree">Example 2: Recovering Inventory Parse Tree</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#grammar-mining">Grammar Mining</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-flattening-complex-objects">Exercise 1: Flattening complex objects</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-incorporating-taints-from-informationflow">Exercise 2: Incorporating Taints from InformationFlow</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Andreas Zeller, Rahul Gopinath, Marcel Böhme, Gordon Fraser, and Christian Holler
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <div>
  Copyright &copy; 2021–2025 <a href="https://www.cispa.de/">CISPA Helmholtz Center for Information Security</a>. Copyright &copy; 2018-2020 <a href="https://www.uni-saarland.de/">Saarland University</a>. Copyright &copy; 2018-2025 external contributors.
  The <strong>content</strong> of this project is licensed under the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
  The <strong>source code</strong> that is part of the content, as well as the source code used to format and display that content is licensed under the <a href="https://github.com/uds-se/fuzzingbook/blob/master/LICENSE.md#mit-license">MIT License</a>.
  <br>
  <a href="https://cispa.de/en/impressum">Imprint</a> &middot; <a href="/html/index.html#how-do-i-cite-your-work">Cite</a>
</div>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>