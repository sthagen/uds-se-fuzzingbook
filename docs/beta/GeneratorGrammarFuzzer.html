
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Fuzzing with Generators &#8212; The Fuzzing Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=42e1b1a5" />
    <link rel="stylesheet" type="text/css" href="_static/mastodon-timeline.css?v=f82c2b23" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'GeneratorGrammarFuzzer';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Greybox Fuzzing with Grammars" href="GreyboxGrammarFuzzer.html" />
    <link rel="prev" title="Probabilistic Grammar Fuzzing" href="ProbabilisticGrammarFuzzer.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content"><p>This is a beta version of fuzzingbook.org, currently in development. See the <a href="https://fuzzingbook.org/classic/"  style="color:white!important;">classic site</a> for the 2024 version.</p></div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/fuzzingbook.png" class="logo__image only-light" alt="The Fuzzing Book - Home"/>
    <script>document.write(`<img src="_static/fuzzingbook.png" class="logo__image only-dark" alt="The Fuzzing Book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    The Fuzzing Book
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tours.html">Sitemap</a></li>
<li class="toctree-l1"><a class="reference internal" href="Intro_Testing.html">Introduction to Software Testing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Lexical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Fuzzer.html">Fuzzing: Breaking Things with Random Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Coverage.html">Code Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="MutationFuzzer.html">Mutation-Based Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GreyboxFuzzer.html">Greybox Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="SearchBasedFuzzer.html">Search-Based Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="MutationAnalysis.html">Mutation Analysis</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Syntactical Fuzzing</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Grammars.html">Fuzzing with Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarFuzzer.html">Efficient Grammar Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarCoverageFuzzer.html">Grammar Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="Parser.html">Parsing Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ProbabilisticGrammarFuzzer.html">Probabilistic Grammar Fuzzing</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Fuzzing with Generators</a></li>

<li class="toctree-l1"><a class="reference internal" href="GreyboxGrammarFuzzer.html">Greybox Fuzzing with Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="Reducer.html">Reducing Failure-Inducing Inputs</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Semantical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="FuzzingWithConstraints.html">Fuzzing with Constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarMiner.html">Mining Input Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="InformationFlow.html">Tracking Information Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="ConcolicFuzzer.html">Concolic Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="SymbolicFuzzer.html">Symbolic Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="DynamicInvariants.html">Mining Function Specifications</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Domain-Specific Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ConfigurationFuzzer.html">Testing Configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="APIFuzzer.html">Fuzzing APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Carver.html">Carving Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="PythonFuzzer.html">Testing Compilers</a></li>
<li class="toctree-l1"><a class="reference internal" href="WebFuzzer.html">Testing Web Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="GUIFuzzer.html">Testing Graphical User Interfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Managing Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="FuzzingInTheLarge.html">Fuzzing in the Large</a></li>
<li class="toctree-l1"><a class="reference internal" href="WhenToStopFuzzing.html">When To Stop Fuzzing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Essays</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="AcademicPrototyping.html">Academic Prototyping</a></li>
<li class="toctree-l1"><a class="reference internal" href="PrototypingWithPython.html">Prototyping with Python</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ExpectError.html">Error Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timer.html">Timer</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timeout.html">Timeout</a></li>
<li class="toctree-l1"><a class="reference internal" href="ClassDiagram.html">Class Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="RailroadDiagrams.html">Railroad Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="ControlFlow.html">Control Flow Graph</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About This Book</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ReleaseNotes.html">Fuzzingbook Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="Importing.html">Downloads and Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="Guide_for_Authors.html">Guide for Authors</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/master?urlpath=tree/docs/notebooks/GeneratorGrammarFuzzer.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/uds-se/fuzzingbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/uds-se/fuzzingbook/issues/new?title=Issue%20on%20page%20%2FGeneratorGrammarFuzzer.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
    <li><a href="../code/GeneratorGrammarFuzzer.py" target="_blank"
       class="btn btn-sm btn-download-source-button dropdown-item"
       title="Download Python code"
       data-bs-placement="left" data-bs-toggle="tooltip"
    >
  

    <span class="btn__icon-container">
      <i class="fas fa-file"></i>
      </span>
    <span class="btn__text-container">.py</span>
    </a>
    </li>
    
      
      
      
      <li><a href="_sources/GeneratorGrammarFuzzer.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download notebook"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  
    <li><a href="Importing.html" target="_blank"
       class="btn btn-sm btn-download-source-button dropdown-item"
       title="All downloads"
       data-bs-placement="left" data-bs-toggle="tooltip"
    >
  

    <span class="btn__icon-container">
      <i class="fas fa-file"></i>
      </span>
    <span class="btn__text-container">All downloads</span>
    </a>
    </li>
    </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Fuzzing with Generators</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Fuzzing with Generators</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-test-a-credit-card-system">Example: Test a Credit Card System</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#attaching-functions-to-expansions">Attaching Functions to Expansions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#functions-called-before-expansion">Functions Called Before Expansion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#functions-called-after-expansion">Functions Called After Expansion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-class-for-integrating-constraints">A Class for Integrating Constraints</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-elements-before-expansion">Generating Elements before Expansion</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-numeric-ranges">Example: Numeric Ranges</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-more-numeric-ranges">Example: More Numeric Ranges</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#support-for-python-generators">Support for Python Generators</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-and-repairing-elements-after-expansion">Checking and Repairing Elements after Expansion</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-negative-expressions">Example: Negative Expressions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-matching-xml-tags">Example: Matching XML Tags</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-checksums">Example: Checksums</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#local-checking-and-repairing">Local Checking and Repairing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#definitions-and-uses">Definitions and Uses</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ordering-expansions">Ordering Expansions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#all-together">All Together</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generators-and-probabilistic-fuzzing">Generators and Probabilistic Fuzzing</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#generators-and-grammar-coverage">Generators and Grammar Coverage</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-tree-processing">Exercise 1: Tree Processing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-attribute-grammars">Exercise 2: Attribute Grammars</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="fuzzing-with-generators">
<h1>Fuzzing with Generators<a class="headerlink" href="#fuzzing-with-generators" title="Link to this heading">#</a></h1>
<p>In this chapter, we show how to extend grammars with <em>functions</em> – pieces of code that get executed during grammar expansion, and that can generate, check, or change elements produced.  Adding functions to a grammar allows for very versatile test generation, bringing together the best of grammar generation and programming.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">YouTubeVideo</span>
<span class="n">YouTubeVideo</span><span class="p">(</span><span class="s1">&#39;6Z35ChunpLY&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="640"
            height="360"
            src="https://www.youtube-nocookie.com/embed/6Z35ChunpLY"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<p><strong>Prerequisites</strong></p>
<ul class="simple">
<li><p>As this chapter deeply interacts with the techniques discussed in the <a class="reference internal" href="GrammarFuzzer.html"><span class="std std-doc">chapter on efficient grammar fuzzing</span></a>, a good understanding of the techniques is recommended.</p></li>
</ul>
<section id="synopsis">
<h2>Synopsis<a class="headerlink" href="#synopsis" title="Link to this heading">#</a></h2>
<p>To <a class="reference internal" href="Importing.html"><span class="std std-doc">use the code provided in this chapter</span></a>, write</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">fuzzingbook.GeneratorGrammarFuzzer</span><span class="w"> </span><span class="kn">import</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>and then make use of the following features.</p>
<p><strong>Note</strong>: The examples in this section only work after the rest of the cells have been executed.</p>
<p>To attach a function <code class="docutils literal notranslate"><span class="pre">F</span></code> to an individual expansion <code class="docutils literal notranslate"><span class="pre">S</span></code> in a grammar, replace <code class="docutils literal notranslate"><span class="pre">S</span></code> with a pair</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span><span class="n">pre</span><span class="o">=</span><span class="n">F</span><span class="p">))</span>   <span class="c1"># Set a function to be executed before expansion</span>
</pre></div>
</div>
<p>or</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="n">F</span><span class="p">))</span>  <span class="c1"># Set a function to be executed after expansion</span>
</pre></div>
</div>
<p>Here is an example, To take an area code from a list that is given programmatically, we can write:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">Grammars</span><span class="w"> </span><span class="kn">import</span> <span class="n">US_PHONE_GRAMMAR</span><span class="p">,</span> <span class="n">extend_grammar</span><span class="p">,</span> <span class="n">opts</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">pick_area_code</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s1">&#39;555&#39;</span><span class="p">,</span> <span class="s1">&#39;554&#39;</span><span class="p">,</span> <span class="s1">&#39;553&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PICKED_US_PHONE_GRAMMAR</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">US_PHONE_GRAMMAR</span><span class="p">,</span>
<span class="p">{</span>
    <span class="s2">&quot;&lt;area&gt;&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;&lt;lead-digit&gt;&lt;digit&gt;&lt;digit&gt;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span><span class="n">pre</span><span class="o">=</span><span class="n">pick_area_code</span><span class="p">))]</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">GeneratorGrammarFuzzer</span></code> will extract and interpret these options.  Here is an example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">picked_us_phone_fuzzer</span> <span class="o">=</span> <span class="n">GeneratorGrammarFuzzer</span><span class="p">(</span><span class="n">PICKED_US_PHONE_GRAMMAR</span><span class="p">)</span>
<span class="p">[</span><span class="n">picked_us_phone_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;(554)732-6097&#39;,
 &#39;(555)469-0662&#39;,
 &#39;(553)671-5358&#39;,
 &#39;(555)686-8011&#39;,
 &#39;(554)453-4067&#39;]
</pre></div>
</div>
</div>
</div>
<p>As you can see, the area codes now all stem from <code class="docutils literal notranslate"><span class="pre">pick_area_code()</span></code>.  Such definitions allow  closely tying program code (such as <code class="docutils literal notranslate"><span class="pre">pick_area_code()</span></code>) to grammars.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">PGGCFuzzer</span></code> class incorporates all features from <a class="reference internal" href="GrammarFuzzer.html"><span class="std std-doc">the <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code> class</span></a> and its <a class="reference internal" href="GrammarCoverageFuzzer.html"><span class="std std-doc">coverage-based</span></a>, <a class="reference internal" href="ProbabilisticGrammarFuzzer.html"><span class="std std-doc">probabilistic-based</span></a>, and <a class="reference internal" href="#"><span class="std std-doc">generator-based</span></a> derivatives.</p>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 13.1.2 (20250808.2320)
 -->
<!-- Pages: 1 -->
<svg width="566pt" height="877pt"
 viewBox="0.00 0.00 566.00 877.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 872.75)">
<g id="a_graph0"><a xlink:title="PGGCFuzzer class hierarchy">
<polygon fill="white" stroke="none" points="-4,4 -4,-872.75 561.75,-872.75 561.75,4 -4,4"/>
</a>
</g>
<!-- PGGCFuzzer -->
<g id="node1" class="node">
<title>PGGCFuzzer</title>
<g id="a_node1"><a xlink:href="#" xlink:title="class PGGCFuzzer:&#10;The one grammar&#45;based fuzzer that supports all fuzzingbook features">
<polygon fill="none" stroke="black" points="154.12,-6.5 154.12,-42.5 245.88,-42.5 245.88,-6.5 154.12,-6.5"/>
<text xml:space="preserve" text-anchor="start" x="162.12" y="-21.2" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">PGGCFuzzer</text>
</a>
</g>
</g>
<!-- ProbabilisticGeneratorGrammarCoverageFuzzer -->
<g id="node2" class="node">
<title>ProbabilisticGeneratorGrammarCoverageFuzzer</title>
<g id="a_node2"><a xlink:href="#" xlink:title="class ProbabilisticGeneratorGrammarCoverageFuzzer:&#10;Join the features of `GeneratorGrammarFuzzer`&#10;and `ProbabilisticGrammarCoverageFuzzer`">
<polygon fill="none" stroke="black" points="44.62,-85.5 44.62,-183.25 355.38,-183.25 355.38,-85.5 44.62,-85.5"/>
<text xml:space="preserve" text-anchor="start" x="52.62" y="-166.95" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">ProbabilisticGeneratorGrammarCoverageFuzzer</text>
<polyline fill="none" stroke="black" points="44.62,-157.25 355.38,-157.25"/>
<g id="a_node2_0"><a xlink:href="#" xlink:title="ProbabilisticGeneratorGrammarCoverageFuzzer">
<g id="a_node2_1"><a xlink:href="#" xlink:title="__init__(self, grammar: Dict[str, List[Expansion]], *, replacement_attempts: int = 10, **kwargs) &#45;&gt; None:&#10;Constructor.&#10;`replacement_attempts` &#45; see `GeneratorGrammarFuzzer` constructor.&#10;All other keywords go into `ProbabilisticGrammarFuzzer`.">
<text xml:space="preserve" text-anchor="start" x="143" y="-144.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node2_2"><a xlink:href="#" xlink:title="fuzz_tree(self) &#45;&gt; DerivationTree:&#10;Produce a derivation tree from the grammar.">
<text xml:space="preserve" text-anchor="start" x="143" y="-132" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">fuzz_tree()</text>
</a>
</g>
<g id="a_node2_3"><a xlink:href="#" xlink:title="add_tree_coverage(self, tree: DerivationTree) &#45;&gt; None">
<text xml:space="preserve" text-anchor="start" x="143" y="-118.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">add_tree_coverage()</text>
</a>
</g>
<g id="a_node2_4"><a xlink:href="#" xlink:title="restart_expansion(self) &#45;&gt; None">
<text xml:space="preserve" text-anchor="start" x="143" y="-106.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">restart_expansion()</text>
</a>
</g>
<g id="a_node2_5"><a xlink:href="#" xlink:title="supported_opts(self) &#45;&gt; Set[str]:&#10;Set of supported options. To be overloaded in subclasses.">
<text xml:space="preserve" text-anchor="start" x="143" y="-93.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">supported_opts()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- PGGCFuzzer&#45;&gt;ProbabilisticGeneratorGrammarCoverageFuzzer -->
<g id="edge1" class="edge">
<title>PGGCFuzzer&#45;&gt;ProbabilisticGeneratorGrammarCoverageFuzzer</title>
<path fill="none" stroke="black" d="M200,-42.83C200,-51.5 200,-62.55 200,-73.93"/>
<polygon fill="none" stroke="black" points="196.5,-73.84 200,-83.84 203.5,-73.84 196.5,-73.84"/>
</g>
<!-- GeneratorGrammarFuzzer -->
<g id="node3" class="node">
<title>GeneratorGrammarFuzzer</title>
<g id="a_node3"><a xlink:href="#" xlink:title="class GeneratorGrammarFuzzer:&#10;Produce strings from grammars efficiently, using derivation trees.">
<polygon fill="none" stroke="black" points="0,-366.25 0,-578.75 184,-578.75 184,-366.25 0,-366.25"/>
<text xml:space="preserve" text-anchor="start" x="11.38" y="-562.45" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">GeneratorGrammarFuzzer</text>
<polyline fill="none" stroke="black" points="0,-552.75 184,-552.75"/>
<g id="a_node3_6"><a xlink:href="#" xlink:title="GeneratorGrammarFuzzer">
<g id="a_node3_7"><a xlink:href="#" xlink:title="__init__(self, grammar: Dict[str, List[Expansion]], replacement_attempts: int = 10, **kwargs) &#45;&gt; None:&#10;Produce strings from `grammar`, starting with `start_symbol`.&#10;If `min_nonterminals` or `max_nonterminals` is given, use them as limits&#10;for the number of nonterminals produced.&#10;If `disp` is set, display the intermediate derivation trees.&#10;If `log` is set, show intermediate steps as text on standard output.">
<text xml:space="preserve" text-anchor="start" x="8" y="-540.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node3_8"><a xlink:href="#" xlink:title="fuzz_tree(self) &#45;&gt; DerivationTree:&#10;Produce a derivation tree from the grammar.">
<text xml:space="preserve" text-anchor="start" x="8" y="-527.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">fuzz_tree()</text>
</a>
</g>
<g id="a_node3_9"><a xlink:href="#" xlink:title="apply_result(self, result: Any, children: List[DerivationTree]) &#45;&gt; List[DerivationTree]">
<text xml:space="preserve" text-anchor="start" x="8" y="-513.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">apply_result()</text>
</a>
</g>
<g id="a_node3_10"><a xlink:href="#" xlink:title="choose_tree_expansion(self, tree: DerivationTree, expandable_children: List[DerivationTree]) &#45;&gt; int:&#10;Return index of subtree in `expandable_children`&#10;to be selected for expansion. Defaults to random.">
<text xml:space="preserve" text-anchor="start" x="8" y="-502" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">choose_tree_expansion()</text>
</a>
</g>
<g id="a_node3_11"><a xlink:href="#" xlink:title="eval_function(self, tree, function)">
<text xml:space="preserve" text-anchor="start" x="8" y="-488.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">eval_function()</text>
</a>
</g>
<g id="a_node3_12"><a xlink:href="#" xlink:title="expand_tree_once(self, tree: DerivationTree) &#45;&gt; DerivationTree:&#10;Choose an unexpanded symbol in tree; expand it.&#10;Can be overloaded in subclasses.">
<text xml:space="preserve" text-anchor="start" x="8" y="-476.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">expand_tree_once()</text>
</a>
</g>
<g id="a_node3_13"><a xlink:href="#" xlink:title="find_expansion(self, tree)">
<text xml:space="preserve" text-anchor="start" x="8" y="-462.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">find_expansion()</text>
</a>
</g>
<g id="a_node3_14"><a xlink:href="#" xlink:title="process_chosen_children(self, children: List[DerivationTree], expansion: Expansion) &#45;&gt; List[DerivationTree]:&#10;Process children after selection. &#160;By default, does nothing.">
<text xml:space="preserve" text-anchor="start" x="8" y="-451" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">process_chosen_children()</text>
</a>
</g>
<g id="a_node3_15"><a xlink:href="#" xlink:title="reset_generators(self) &#45;&gt; None">
<text xml:space="preserve" text-anchor="start" x="8" y="-437.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">reset_generators()</text>
</a>
</g>
<g id="a_node3_16"><a xlink:href="#" xlink:title="restart_expansion(self) &#45;&gt; None">
<text xml:space="preserve" text-anchor="start" x="8" y="-425.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">restart_expansion()</text>
</a>
</g>
<g id="a_node3_17"><a xlink:href="#" xlink:title="run_generator(self, expansion: Expansion, function: Callable) &#45;&gt; Iterator">
<text xml:space="preserve" text-anchor="start" x="8" y="-411.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">run_generator()</text>
</a>
</g>
<g id="a_node3_18"><a xlink:href="#" xlink:title="run_post_functions(self, tree: DerivationTree, depth: Union[int, float] = inf) &#45;&gt; Tuple[bool, Optional[List[DerivationTree]]]">
<text xml:space="preserve" text-anchor="start" x="8" y="-399" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">run_post_functions()</text>
</a>
</g>
<g id="a_node3_19"><a xlink:href="#" xlink:title="run_post_functions_locally(self, new_tree: DerivationTree) &#45;&gt; DerivationTree">
<text xml:space="preserve" text-anchor="start" x="8" y="-386.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">run_post_functions_locally()</text>
</a>
</g>
<g id="a_node3_20"><a xlink:href="#" xlink:title="supported_opts(self) &#45;&gt; Set[str]:&#10;Set of supported options. To be overloaded in subclasses.">
<text xml:space="preserve" text-anchor="start" x="8" y="-374.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">supported_opts()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- ProbabilisticGeneratorGrammarCoverageFuzzer&#45;&gt;GeneratorGrammarFuzzer -->
<g id="edge2" class="edge">
<title>ProbabilisticGeneratorGrammarCoverageFuzzer&#45;&gt;GeneratorGrammarFuzzer</title>
<path fill="none" stroke="black" d="M184.53,-183.53C170.2,-228.14 148.31,-296.25 129.42,-355.03"/>
<polygon fill="none" stroke="black" points="126.12,-353.86 126.4,-364.45 132.79,-356 126.12,-353.86"/>
</g>
<!-- ProbabilisticGrammarCoverageFuzzer -->
<g id="node6" class="node">
<title>ProbabilisticGrammarCoverageFuzzer</title>
<g id="a_node6"><a xlink:href="ProbabilisticGrammarFuzzer.ipynb" xlink:title="class ProbabilisticGrammarCoverageFuzzer:&#10;Produce from grammars, aiming for coverage of all expansions.">
<polygon fill="none" stroke="black" points="184.38,-220.25 184.38,-256.25 433.62,-256.25 433.62,-220.25 184.38,-220.25"/>
<text xml:space="preserve" text-anchor="start" x="192.38" y="-234.95" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">ProbabilisticGrammarCoverageFuzzer</text>
</a>
</g>
</g>
<!-- ProbabilisticGeneratorGrammarCoverageFuzzer&#45;&gt;ProbabilisticGrammarCoverageFuzzer -->
<g id="edge5" class="edge">
<title>ProbabilisticGeneratorGrammarCoverageFuzzer&#45;&gt;ProbabilisticGrammarCoverageFuzzer</title>
<path fill="none" stroke="black" d="M251.63,-183.63C262.14,-193.45 272.79,-203.4 282.01,-212.03"/>
<polygon fill="none" stroke="black" points="279.57,-214.53 289.26,-218.8 284.35,-209.42 279.57,-214.53"/>
</g>
<!-- GrammarFuzzer -->
<g id="node4" class="node">
<title>GrammarFuzzer</title>
<g id="a_node4"><a xlink:href="GrammarFuzzer.ipynb" xlink:title="class GrammarFuzzer:&#10;Produce strings from grammars efficiently, using derivation trees.">
<polygon fill="none" stroke="black" points="176.12,-699.5 176.12,-771.75 291.88,-771.75 291.88,-699.5 176.12,-699.5"/>
<text xml:space="preserve" text-anchor="start" x="184.12" y="-755.45" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">GrammarFuzzer</text>
<polyline fill="none" stroke="black" points="176.12,-745.75 291.88,-745.75"/>
<g id="a_node4_21"><a xlink:href="#" xlink:title="GrammarFuzzer">
<g id="a_node4_22"><a xlink:href="GrammarFuzzer.ipynb" xlink:title="__init__(self, grammar: Dict[str, List[Expansion]], start_symbol: str = &#39;&lt;start&gt;&#39;, min_nonterminals: int = 0, max_nonterminals: int = 10, disp: bool = False, log: Union[bool, int] = False) &#45;&gt; None:&#10;Produce strings from `grammar`, starting with `start_symbol`.&#10;If `min_nonterminals` or `max_nonterminals` is given, use them as limits&#10;for the number of nonterminals produced.&#10;If `disp` is set, display the intermediate derivation trees.&#10;If `log` is set, show intermediate steps as text on standard output.">
<text xml:space="preserve" text-anchor="start" x="201" y="-733.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node4_23"><a xlink:href="GrammarFuzzer.ipynb" xlink:title="fuzz(self) &#45;&gt; str:&#10;Produce a string from the grammar.">
<text xml:space="preserve" text-anchor="start" x="201" y="-720.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">fuzz()</text>
</a>
</g>
<g id="a_node4_24"><a xlink:href="GrammarFuzzer.ipynb" xlink:title="fuzz_tree(self) &#45;&gt; DerivationTree:&#10;Produce a derivation tree from the grammar.">
<text xml:space="preserve" text-anchor="start" x="201" y="-707.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">fuzz_tree()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- GeneratorGrammarFuzzer&#45;&gt;GrammarFuzzer -->
<g id="edge3" class="edge">
<title>GeneratorGrammarFuzzer&#45;&gt;GrammarFuzzer</title>
<path fill="none" stroke="black" d="M85.42,-579.11C88.01,-608.15 95.17,-638.39 111,-663 123.98,-683.18 144.82,-698.36 165.67,-709.42"/>
<polygon fill="none" stroke="black" points="164.02,-712.51 174.53,-713.85 167.15,-706.25 164.02,-712.51"/>
</g>
<!-- Fuzzer -->
<g id="node5" class="node">
<title>Fuzzer</title>
<g id="a_node5"><a xlink:href="Fuzzer.ipynb" xlink:title="class Fuzzer:&#10;Base class for fuzzers.">
<polygon fill="none" stroke="black" points="205.38,-808.75 205.38,-868.25 262.62,-868.25 262.62,-808.75 205.38,-808.75"/>
<text xml:space="preserve" text-anchor="start" x="213.38" y="-851.95" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">Fuzzer</text>
<polyline fill="none" stroke="black" points="205.38,-842.25 262.62,-842.25"/>
<g id="a_node5_25"><a xlink:href="#" xlink:title="Fuzzer">
<g id="a_node5_26"><a xlink:href="Fuzzer.ipynb" xlink:title="run(self, runner: Fuzzer.Runner = &lt;Fuzzer.Runner object at 0x1094252b0&gt;) &#45;&gt; Tuple[subprocess.CompletedProcess, str]:&#10;Run `runner` with fuzz input">
<text xml:space="preserve" text-anchor="start" x="216" y="-829.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">run()</text>
</a>
</g>
<g id="a_node5_27"><a xlink:href="Fuzzer.ipynb" xlink:title="runs(self, runner: Fuzzer.Runner = &lt;Fuzzer.PrintRunner object at 0x109425400&gt;, trials: int = 10) &#45;&gt; List[Tuple[subprocess.CompletedProcess, str]]:&#10;Run `runner` with fuzz input, `trials` times">
<text xml:space="preserve" text-anchor="start" x="216" y="-817" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">runs()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- GrammarFuzzer&#45;&gt;Fuzzer -->
<g id="edge4" class="edge">
<title>GrammarFuzzer&#45;&gt;Fuzzer</title>
<path fill="none" stroke="black" d="M234,-772.19C234,-780.29 234,-788.94 234,-797.22"/>
<polygon fill="none" stroke="black" points="230.5,-797.06 234,-807.06 237.5,-797.06 230.5,-797.06"/>
</g>
<!-- GrammarCoverageFuzzer -->
<g id="node7" class="node">
<title>GrammarCoverageFuzzer</title>
<g id="a_node7"><a xlink:href="GrammarCoverageFuzzer.ipynb" xlink:title="class GrammarCoverageFuzzer:&#10;Produce from grammars, aiming for coverage of all expansions.">
<polygon fill="none" stroke="black" points="222.25,-293.25 222.25,-329.25 395.75,-329.25 395.75,-293.25 222.25,-293.25"/>
<text xml:space="preserve" text-anchor="start" x="230.25" y="-307.95" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">GrammarCoverageFuzzer</text>
</a>
</g>
</g>
<!-- ProbabilisticGrammarCoverageFuzzer&#45;&gt;GrammarCoverageFuzzer -->
<g id="edge6" class="edge">
<title>ProbabilisticGrammarCoverageFuzzer&#45;&gt;GrammarCoverageFuzzer</title>
<path fill="none" stroke="black" d="M309,-256.44C309,-264.02 309,-273.15 309,-281.71"/>
<polygon fill="none" stroke="black" points="305.5,-281.71 309,-291.71 312.5,-281.71 305.5,-281.71"/>
</g>
<!-- ProbabilisticGrammarFuzzer -->
<g id="node10" class="node">
<title>ProbabilisticGrammarFuzzer</title>
<g id="a_node10"><a xlink:href="ProbabilisticGrammarFuzzer.ipynb" xlink:title="class ProbabilisticGrammarFuzzer:&#10;A grammar&#45;based fuzzer respecting probabilities in grammars.">
<polygon fill="none" stroke="black" points="366.25,-621.12 366.25,-657.12 557.75,-657.12 557.75,-621.12 366.25,-621.12"/>
<text xml:space="preserve" text-anchor="start" x="374.25" y="-635.83" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">ProbabilisticGrammarFuzzer</text>
</a>
</g>
</g>
<!-- ProbabilisticGrammarCoverageFuzzer&#45;&gt;ProbabilisticGrammarFuzzer -->
<g id="edge10" class="edge">
<title>ProbabilisticGrammarCoverageFuzzer&#45;&gt;ProbabilisticGrammarFuzzer</title>
<path fill="none" stroke="black" d="M356.9,-256.68C374.27,-265.15 392.64,-276.98 405,-292.75 480.03,-388.45 472.59,-545.56 465.77,-609.61"/>
<polygon fill="none" stroke="black" points="462.32,-608.95 464.65,-619.28 469.27,-609.75 462.32,-608.95"/>
</g>
<!-- SimpleGrammarCoverageFuzzer -->
<g id="node8" class="node">
<title>SimpleGrammarCoverageFuzzer</title>
<g id="a_node8"><a xlink:href="GrammarCoverageFuzzer.ipynb" xlink:title="class SimpleGrammarCoverageFuzzer:&#10;When choosing expansions, prefer expansions not covered.">
<polygon fill="none" stroke="black" points="201.62,-454.5 201.62,-490.5 416.38,-490.5 416.38,-454.5 201.62,-454.5"/>
<text xml:space="preserve" text-anchor="start" x="209.62" y="-469.2" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">SimpleGrammarCoverageFuzzer</text>
</a>
</g>
</g>
<!-- GrammarCoverageFuzzer&#45;&gt;SimpleGrammarCoverageFuzzer -->
<g id="edge7" class="edge">
<title>GrammarCoverageFuzzer&#45;&gt;SimpleGrammarCoverageFuzzer</title>
<path fill="none" stroke="black" d="M309,-329.6C309,-356.88 309,-410.1 309,-443.04"/>
<polygon fill="none" stroke="black" points="305.5,-442.66 309,-452.66 312.5,-442.66 305.5,-442.66"/>
</g>
<!-- TrackingGrammarCoverageFuzzer -->
<g id="node9" class="node">
<title>TrackingGrammarCoverageFuzzer</title>
<g id="a_node9"><a xlink:href="GrammarCoverageFuzzer.ipynb" xlink:title="class TrackingGrammarCoverageFuzzer:&#10;Track grammar coverage during production">
<polygon fill="none" stroke="black" points="119.88,-615.75 119.88,-662.5 348.12,-662.5 348.12,-615.75 119.88,-615.75"/>
<text xml:space="preserve" text-anchor="start" x="127.88" y="-646.2" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">TrackingGrammarCoverageFuzzer</text>
<polyline fill="none" stroke="black" points="119.88,-636.5 348.12,-636.5"/>
<g id="a_node9_28"><a xlink:href="#" xlink:title="TrackingGrammarCoverageFuzzer">
<g id="a_node9_29"><a xlink:href="GrammarCoverageFuzzer.ipynb" xlink:title="__init__(self, *args, **kwargs) &#45;&gt; None:&#10;Produce strings from `grammar`, starting with `start_symbol`.&#10;If `min_nonterminals` or `max_nonterminals` is given, use them as limits&#10;for the number of nonterminals produced.&#10;If `disp` is set, display the intermediate derivation trees.&#10;If `log` is set, show intermediate steps as text on standard output.">
<text xml:space="preserve" text-anchor="start" x="204" y="-624" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- SimpleGrammarCoverageFuzzer&#45;&gt;TrackingGrammarCoverageFuzzer -->
<g id="edge8" class="edge">
<title>SimpleGrammarCoverageFuzzer&#45;&gt;TrackingGrammarCoverageFuzzer</title>
<path fill="none" stroke="black" d="M301.12,-490.81C288.78,-517.89 264.7,-570.75 248.99,-605.23"/>
<polygon fill="none" stroke="black" points="245.99,-603.37 245.03,-613.92 252.36,-606.27 245.99,-603.37"/>
</g>
<!-- TrackingGrammarCoverageFuzzer&#45;&gt;GrammarFuzzer -->
<g id="edge9" class="edge">
<title>TrackingGrammarCoverageFuzzer&#45;&gt;GrammarFuzzer</title>
<path fill="none" stroke="black" d="M234,-662.52C234,-670.11 234,-678.9 234,-687.67"/>
<polygon fill="none" stroke="black" points="230.5,-687.58 234,-697.58 237.5,-687.58 230.5,-687.58"/>
</g>
<!-- ProbabilisticGrammarFuzzer&#45;&gt;GrammarFuzzer -->
<g id="edge11" class="edge">
<title>ProbabilisticGrammarFuzzer&#45;&gt;GrammarFuzzer</title>
<path fill="none" stroke="black" d="M419.92,-657.57C387.1,-671.17 340.85,-690.34 302.69,-706.15"/>
<polygon fill="none" stroke="black" points="301.46,-702.88 293.56,-709.94 304.14,-709.34 301.46,-702.88"/>
</g>
<!-- Legend -->
<g id="node11" class="node">
<title>Legend</title>
<text xml:space="preserve" text-anchor="start" x="264.38" y="-40.5" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="10.00" fill="#b03a2e">Legend</text>
<text xml:space="preserve" text-anchor="start" x="264.38" y="-30.5" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text xml:space="preserve" text-anchor="start" x="270.38" y="-30.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="8.00">public_method()</text>
<text xml:space="preserve" text-anchor="start" x="264.38" y="-20.5" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text xml:space="preserve" text-anchor="start" x="270.38" y="-20.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="8.00">private_method()</text>
<text xml:space="preserve" text-anchor="start" x="264.38" y="-10.5" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text xml:space="preserve" text-anchor="start" x="270.38" y="-10.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="8.00">overloaded_method()</text>
<text xml:space="preserve" text-anchor="start" x="264.38" y="-1.45" font-family="Helvetica,sans-Serif" font-size="9.00">Hover over names to see doc</text>
</g>
</g>
</svg>
</div></div>
</div>
</section>
<section id="example-test-a-credit-card-system">
<h2>Example: Test a Credit Card System<a class="headerlink" href="#example-test-a-credit-card-system" title="Link to this heading">#</a></h2>
<p>Suppose you work with a shopping system that – among several other features – allows customers to pay with a credit card.  Your task is to test the payment functionality.</p>
<p>To make things simple, we will assume that we need only two pieces of data – a 16-digit credit card number and an amount to be charged.  Both pieces can be easily generated with grammars, as in the following:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">bookutils.setup</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">cast</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">Fuzzer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fuzzer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">Grammars</span><span class="w"> </span><span class="kn">import</span> <span class="n">EXPR_GRAMMAR</span><span class="p">,</span> <span class="n">is_valid_grammar</span><span class="p">,</span> <span class="n">is_nonterminal</span><span class="p">,</span> <span class="n">extend_grammar</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">Grammars</span><span class="w"> </span><span class="kn">import</span> <span class="n">opts</span><span class="p">,</span> <span class="n">exp_opt</span><span class="p">,</span> <span class="n">exp_string</span><span class="p">,</span> <span class="n">crange</span><span class="p">,</span> <span class="n">Grammar</span><span class="p">,</span> <span class="n">Expansion</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">GrammarFuzzer</span><span class="w"> </span><span class="kn">import</span> <span class="n">DerivationTree</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CHARGE_GRAMMAR</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Charge &lt;amount&gt; to my credit card &lt;credit-card-number&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;amount&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;$&lt;float&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;float&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;integer&gt;.&lt;digit&gt;&lt;digit&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;integer&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;integer&gt;&lt;digit&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">:</span> <span class="n">crange</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">),</span>

    <span class="s2">&quot;&lt;credit-card-number&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;digits&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;digits&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;digit-block&gt;&lt;digit-block&gt;&lt;digit-block&gt;&lt;digit-block&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;digit-block&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;digit&gt;&lt;digit&gt;&lt;digit&gt;&lt;digit&gt;&quot;</span><span class="p">],</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">CHARGE_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>All of this works neatly – we can generate arbitrary amounts and credit card numbers:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">GrammarFuzzer</span><span class="w"> </span><span class="kn">import</span> <span class="n">GrammarFuzzer</span><span class="p">,</span> <span class="n">all_terminals</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">CHARGE_GRAMMAR</span><span class="p">)</span>
<span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;Charge $9.40 to my credit card 7166898575638313&#39;,
 &#39;Charge $8.79 to my credit card 6845418694643271&#39;,
 &#39;Charge $5.64 to my credit card 6655894657077388&#39;,
 &#39;Charge $0.60 to my credit card 2596728464872261&#39;,
 &#39;Charge $8.90 to my credit card 2363769342732142&#39;]
</pre></div>
</div>
</div>
</div>
<p>However, when actually testing our system with this data, we find two problems:</p>
<ol class="arabic simple">
<li><p>We’d like to test <em>specific</em> amounts being charged – for instance, amounts that would excess the credit card limit.</p></li>
<li><p>We find that 9 out of 10 credit card numbers are rejected because of having an incorrect checksum.  This is fine if we want to test rejection of credit card numbers – but if we want to test the actual functionality of processing a charge, we need <em>valid</em> numbers.</p></li>
</ol>
<p>We could go and ignore these issues; after all, eventually, it is only a matter of time until large amounts and valid numbers are generated.  As it comes to the first concern, we could also address it by changing the grammar appropriately – say, to only produce charges that have at least six leading digits.  However, generalizing this to arbitrary ranges of values will be cumbersome.</p>
<p>The second concern, the checksums of credit card numbers, however, runs deeper – at least as far as grammars are concerned, is that a complex arithmetic operation like a checksum cannot be expressed in a grammar alone – at least not in the <em>context-free grammars</em> we use here.  (In principle, one <em>could</em> do this in a <em>context–sensitive</em> grammar, but specifying this would be no fun at all.)  What we want is a mechanism that allows us to <em>attach programmatic computations</em> to our grammars, bringing together the best of both worlds.</p>
</section>
<section id="attaching-functions-to-expansions">
<h2>Attaching Functions to Expansions<a class="headerlink" href="#attaching-functions-to-expansions" title="Link to this heading">#</a></h2>
<p>The key idea of this chapter is to <em>extend</em> grammars such that one can <em>attach Python functions</em> to individual expansions.  These functions can be executed</p>
<ol class="arabic simple">
<li><p><em>before</em> expansion, <em>replacing</em> the element to be expanded by a computed value; or</p></li>
<li><p><em>after</em> expansion, <em>checking</em> generated elements, and possibly also replacing them.</p></li>
</ol>
<p>In both cases, functions are specified using the <code class="docutils literal notranslate"><span class="pre">opts()</span></code> expansion mechanism introduced in the <a class="reference internal" href="Grammars.html"><span class="std std-doc">chapter on grammars</span></a>.  They are thus tied to a specific expansion <span class="math notranslate nohighlight">\(e\)</span> of a symbol <span class="math notranslate nohighlight">\(s\)</span>.</p>
<section id="functions-called-before-expansion">
<h3>Functions Called Before Expansion<a class="headerlink" href="#functions-called-before-expansion" title="Link to this heading">#</a></h3>
<p>A function defined using the <code class="docutils literal notranslate"><span class="pre">pre</span></code> option is invoked <em>before</em> expansion of <span class="math notranslate nohighlight">\(s\)</span> into <span class="math notranslate nohighlight">\(e\)</span>. Its value <em>replaces</em> the expansion <span class="math notranslate nohighlight">\(e\)</span> to be produced.  To generate a value for the credit card example, above, we could define a <em>pre-expansion</em> generator function</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">high_charge</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">10000000</span><span class="p">,</span> <span class="mi">90000000</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100.0</span>
</pre></div>
</div>
</div>
</div>
<p>With <code class="docutils literal notranslate"><span class="pre">opts()</span></code>, we could attach this function to the grammar:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CHARGE_GRAMMAR</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="s2">&quot;&lt;float&gt;&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;&lt;integer&gt;.&lt;digit&gt;&lt;digit&gt;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span><span class="n">pre</span><span class="o">=</span><span class="n">high_charge</span><span class="p">))],</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>with the intention that whenever <code class="docutils literal notranslate"><span class="pre">&lt;float&gt;</span></code> is expanded, the function <code class="docutils literal notranslate"><span class="pre">high_charge</span></code> would be invoked to generate a value for <code class="docutils literal notranslate"><span class="pre">&lt;float&gt;</span></code>.  (The actual expansion in the grammar would still be present for fuzzers that ignore functions, such as <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code>).</p>
<p>Since functions tied to a grammar are frequently very simple, we can also <em>inline</em> them using a <em>lambda</em> expression.  A <em>lambda expression</em> is used for <em>anonymous</em> functions that are limited in scope and functionality.  Here’s an example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">apply_twice</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">apply_twice</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>16
</pre></div>
</div>
</div>
</div>
<p>Here, we don’t have to give the <code class="docutils literal notranslate"><span class="pre">function</span></code> to be applied twice a name (say, <code class="docutils literal notranslate"><span class="pre">square()</span></code>); instead, we apply it inline within the invocation.</p>
<p>Using <code class="docutils literal notranslate"><span class="pre">lambda</span></code>, this is what our grammar looks like:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CHARGE_GRAMMAR</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="s2">&quot;&lt;float&gt;&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;&lt;integer&gt;.&lt;digit&gt;&lt;digit&gt;&quot;</span><span class="p">,</span>
                 <span class="n">opts</span><span class="p">(</span><span class="n">pre</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">10000000</span><span class="p">,</span> <span class="mi">90000000</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">))]</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="functions-called-after-expansion">
<h3>Functions Called After Expansion<a class="headerlink" href="#functions-called-after-expansion" title="Link to this heading">#</a></h3>
<p>A function defined using the <code class="docutils literal notranslate"><span class="pre">post</span></code> option is invoked <em>after</em> expansion of <span class="math notranslate nohighlight">\(s\)</span> into <span class="math notranslate nohighlight">\(e\)</span>, passing the expanded values of the symbols in <span class="math notranslate nohighlight">\(e\)</span> as arguments.  A post-expansion function can serve in two ways:</p>
<ol class="arabic simple">
<li><p>It can serve as a <em>constraint</em> or <em>filter</em> on the expanded values, returning <code class="docutils literal notranslate"><span class="pre">True</span></code> if the expansion is valid, and <code class="docutils literal notranslate"><span class="pre">False</span></code> if not; if it returns <code class="docutils literal notranslate"><span class="pre">False</span></code>, another expansion is attempted.</p></li>
<li><p>It can also serve as a <em>repair</em>, returning a string value; like pre-expansion functions, the returned value replaces the expansion.</p></li>
</ol>
<p>For our credit card example, we can choose both ways.  If we have a function <code class="docutils literal notranslate"><span class="pre">check_credit_card(s)</span></code> which returns <code class="docutils literal notranslate"><span class="pre">True</span></code> for a valid number <code class="docutils literal notranslate"><span class="pre">s</span></code> and <code class="docutils literal notranslate"><span class="pre">False</span></code> for invalid ones, we would go for the first option:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CHARGE_GRAMMAR</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="s2">&quot;&lt;credit-card-number&gt;&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;&lt;digits&gt;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="k">lambda</span> <span class="n">digits</span><span class="p">:</span> <span class="n">check_credit_card</span><span class="p">(</span><span class="n">digits</span><span class="p">)))]</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>With such a filter, only valid credit cards will be produced.  On average, it will still take 10 attempts for each time <code class="docutils literal notranslate"><span class="pre">check_credit_card()</span></code> is satisfied.</p>
<p>If we have a function <code class="docutils literal notranslate"><span class="pre">fix_credit_card(s)</span></code> which changes the number such that the checksum is valid and returns the “fixed” number, we can make use of this one instead:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CHARGE_GRAMMAR</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="s2">&quot;&lt;credit-card-number&gt;&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;&lt;digits&gt;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="k">lambda</span> <span class="n">digits</span><span class="p">:</span> <span class="n">fix_credit_card</span><span class="p">(</span><span class="n">digits</span><span class="p">)))]</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>Here, each number is generated only once and then repaired.  This is very efficient.</p>
<p>The checksum function used for credit cards is the <a class="reference external" href="https://en.wikipedia.org/wiki/Luhn_algorithm">Luhn algorithm</a>, a simple yet effective formula.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">luhn_checksum</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute Luhn&#39;s check digit over a string of digits&quot;&quot;&quot;</span>
    <span class="n">LUHN_ODD_LOOKUP</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
                       <span class="mi">9</span><span class="p">)</span>  <span class="c1"># sum_of_digits (index * 2)</span>

    <span class="n">evens</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">odds</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">LUHN_ODD_LOOKUP</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">::</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">evens</span> <span class="o">+</span> <span class="n">odds</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">valid_luhn_checksum</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check whether the last digit is Luhn&#39;s checksum over the earlier digits&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">luhn_checksum</span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">fix_luhn_checksum</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the given string of digits, with a fixed check digit&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">luhn_checksum</span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">luhn_checksum</span><span class="p">(</span><span class="s2">&quot;123&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fix_luhn_checksum</span><span class="p">(</span><span class="s2">&quot;123x&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;1238&#39;
</pre></div>
</div>
</div>
</div>
<p>We can make use of these functions in our credit card grammar:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">check_credit_card</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_luhn_checksum</span>
<span class="n">fix_credit_card</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">fix_luhn_checksum</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fix_credit_card</span><span class="p">(</span><span class="s2">&quot;1234567890123456&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;1234567890123458&#39;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="a-class-for-integrating-constraints">
<h2>A Class for Integrating Constraints<a class="headerlink" href="#a-class-for-integrating-constraints" title="Link to this heading">#</a></h2>
<p>While it is easy to specify functions, our grammar fuzzer will simply ignore them just as it ignores all extensions.  It will issue a warning, though:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">CHARGE_GRAMMAR</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Charge $4.05 to my credit card 0637034038177393&#39;
</pre></div>
</div>
</div>
</div>
<p>We need to define a special fuzzer that actually invokes the given <code class="docutils literal notranslate"><span class="pre">pre</span></code> and <code class="docutils literal notranslate"><span class="pre">post</span></code> functions and acts accordingly.  We name this a <code class="docutils literal notranslate"><span class="pre">GeneratorGrammarFuzzer</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">GeneratorGrammarFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">supported_opts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">supported_opts</span><span class="p">()</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;pre&quot;</span><span class="p">,</span> <span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="s2">&quot;order&quot;</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>We define custom functions to access the <code class="docutils literal notranslate"><span class="pre">pre</span></code> and <code class="docutils literal notranslate"><span class="pre">post</span></code> options:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">exp_pre_expansion_function</span><span class="p">(</span><span class="n">expansion</span><span class="p">:</span> <span class="n">Expansion</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the specified pre-expansion function, or None if unspecified&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">exp_opt</span><span class="p">(</span><span class="n">expansion</span><span class="p">,</span> <span class="s1">&#39;pre&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">exp_post_expansion_function</span><span class="p">(</span><span class="n">expansion</span><span class="p">:</span> <span class="n">Expansion</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the specified post-expansion function, or None if unspecified&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">exp_opt</span><span class="p">(</span><span class="n">expansion</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">order</span></code> attribute will be used <a class="reference internal" href="#Ordering-Expansions"><span class="xref myst">later in this chapter</span></a>.</p>
</section>
<section id="generating-elements-before-expansion">
<h2>Generating Elements before Expansion<a class="headerlink" href="#generating-elements-before-expansion" title="Link to this heading">#</a></h2>
<p>Our first task will be implementing the pre-expansion functions – that is, the function that would be invoked <em>before</em> expansion to replace the value to be expanded.  To this end, we hook into the <code class="docutils literal notranslate"><span class="pre">process_chosen_children()</span></code> method, which gets the selected children before expansion.  We set it up such that it invokes the given <code class="docutils literal notranslate"><span class="pre">pre</span></code> function and applies its result on the children, possibly replacing them.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">GeneratorGrammarFuzzer</span><span class="p">(</span><span class="n">GeneratorGrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_chosen_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">children</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DerivationTree</span><span class="p">],</span>
                                <span class="n">expansion</span><span class="p">:</span> <span class="n">Expansion</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">DerivationTree</span><span class="p">]:</span>
        <span class="n">function</span> <span class="o">=</span> <span class="n">exp_pre_expansion_function</span><span class="p">(</span><span class="n">expansion</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">children</span>

        <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isgeneratorfunction</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
            <span class="c1"># See &quot;generators&quot;, below</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_generator</span><span class="p">(</span><span class="n">expansion</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">function</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">function</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;()&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_result</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expansion</span><span class="p">:</span> <span class="n">Expansion</span><span class="p">,</span> <span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>
</div>
</div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">apply_result()</span></code> takes the result from the pre-expansion function and applies it on the children.  The exact effect depends on the type of the result:</p>
<ul class="simple">
<li><p>A <em>string</em> <span class="math notranslate nohighlight">\(s\)</span> replaces the entire expansion with <span class="math notranslate nohighlight">\(s\)</span>.</p></li>
<li><p>A <em>list</em> <span class="math notranslate nohighlight">\([x_1, x_2, \dots, x_n]\)</span> replaces the <span class="math notranslate nohighlight">\(i\)</span>-th symbol with <span class="math notranslate nohighlight">\(x_i\)</span> for every <span class="math notranslate nohighlight">\(x_i\)</span> that is not <code class="docutils literal notranslate"><span class="pre">None</span></code>.  Specifying <code class="docutils literal notranslate"><span class="pre">None</span></code> as a list element <span class="math notranslate nohighlight">\(x_i\)</span> is useful to leave that element unchanged.  If <span class="math notranslate nohighlight">\(x_i\)</span> is not a string, it is converted to a string.</p></li>
<li><p>A value of <code class="docutils literal notranslate"><span class="pre">None</span></code> is ignored.  This is useful if one wants to simply call a function upon expansion, with no effect on the expanded strings.</p></li>
<li><p><em>Boolean</em> values are ignored.  This is useful for post-expansion functions, discussed below.</p></li>
<li><p>All <em>other types</em> are converted to strings, replacing the entire expansion.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">GeneratorGrammarFuzzer</span><span class="p">(</span><span class="n">GeneratorGrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
                     <span class="n">children</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DerivationTree</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">DerivationTree</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">children</span> <span class="o">=</span> <span class="p">[(</span><span class="n">result</span><span class="p">,</span> <span class="p">[])]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">symbol_indexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">children</span><span class="p">)</span>
                              <span class="k">if</span> <span class="n">is_nonterminal</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">child_index</span> <span class="o">=</span> <span class="n">symbol_indexes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;Replacing&quot;</span><span class="p">,</span> <span class="n">all_terminals</span><span class="p">(</span>
                                <span class="n">children</span><span class="p">[</span><span class="n">child_index</span><span class="p">]),</span> <span class="s2">&quot;by&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

                    <span class="c1"># children[child_index] = (value, [])</span>
                    <span class="n">child_symbol</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="n">child_index</span><span class="p">]</span>
                    <span class="n">children</span><span class="p">[</span><span class="n">child_index</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">child_symbol</span><span class="p">,</span> <span class="p">[(</span><span class="n">value</span><span class="p">,</span> <span class="p">[])])</span>
        <span class="k">elif</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Replacing&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">all_terminals</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">children</span><span class="p">]),</span> <span class="s2">&quot;by&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

            <span class="n">children</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="p">[])]</span>

        <span class="k">return</span> <span class="n">children</span>
</pre></div>
</div>
</div>
</div>
<section id="example-numeric-ranges">
<h3>Example: Numeric Ranges<a class="headerlink" href="#example-numeric-ranges" title="Link to this heading">#</a></h3>
<p>With the above extensions, we have full support for pre-expansion functions.  Using the augmented <code class="docutils literal notranslate"><span class="pre">CHARGE_GRAMMAR</span></code>, we find that the pre-expansion <code class="docutils literal notranslate"><span class="pre">lambda</span></code> function is actually used:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">charge_fuzzer</span> <span class="o">=</span> <span class="n">GeneratorGrammarFuzzer</span><span class="p">(</span><span class="n">CHARGE_GRAMMAR</span><span class="p">)</span>
<span class="n">charge_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Charge $439383.87 to my credit card 2433506594138520&#39;
</pre></div>
</div>
</div>
</div>
<p>The log reveals a bit more details what happens when the pre-expansion function is called.  We see that the expansion <code class="docutils literal notranslate"><span class="pre">&lt;integer&gt;.&lt;digit&gt;&lt;digit&gt;</span></code> is directly replaced by the computed value:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">amount_fuzzer</span> <span class="o">=</span> <span class="n">GeneratorGrammarFuzzer</span><span class="p">(</span>
    <span class="n">CHARGE_GRAMMAR</span><span class="p">,</span> <span class="n">start_symbol</span><span class="o">=</span><span class="s2">&quot;&lt;amount&gt;&quot;</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">amount_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Tree: &lt;amount&gt;
Expanding &lt;amount&gt; randomly
Tree: $&lt;float&gt;
Expanding &lt;float&gt; randomly
&lt;function &lt;lambda&gt; at 0x10af0a520&gt;() = 382087.72
Replacing &lt;integer&gt;.&lt;digit&gt;&lt;digit&gt; by 382087.72
Tree: $382087.72
&#39;$382087.72&#39;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;$382087.72&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="example-more-numeric-ranges">
<h3>Example: More Numeric Ranges<a class="headerlink" href="#example-more-numeric-ranges" title="Link to this heading">#</a></h3>
<p>We can use such pre-expansion functions in other contexts, too.  Suppose we want to generate arithmetic expressions in which each number is between 100 and 200.  We can extend <code class="docutils literal notranslate"><span class="pre">EXPR_GRAMMAR</span></code> accordingly:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">expr_100_200_grammar</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">,</span>
                                      <span class="p">{</span>
                                          <span class="s2">&quot;&lt;factor&gt;&quot;</span><span class="p">:</span> <span class="p">[</span>
                                              <span class="s2">&quot;+&lt;factor&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;-&lt;factor&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;(&lt;expr&gt;)&quot;</span><span class="p">,</span>

                                              <span class="c1"># Generate only the integer part with a function;</span>
                                              <span class="c1"># the fractional part comes from</span>
                                              <span class="c1"># the grammar</span>
                                              <span class="p">(</span><span class="s2">&quot;&lt;integer&gt;.&lt;integer&gt;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span>
                                                  <span class="n">pre</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span> <span class="kc">None</span><span class="p">])),</span>

                                              <span class="c1"># Generate the entire integer</span>
                                              <span class="c1"># from the function</span>
                                              <span class="p">(</span><span class="s2">&quot;&lt;integer&gt;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span>
                                                  <span class="n">pre</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">))),</span>
                                          <span class="p">],</span>
                                      <span class="p">}</span>
                                      <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">expr_100_200_fuzzer</span> <span class="o">=</span> <span class="n">GeneratorGrammarFuzzer</span><span class="p">(</span><span class="n">expr_100_200_grammar</span><span class="p">)</span>
<span class="n">expr_100_200_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;(108.6 / 155 + 177) / 118 * 120 * 107 + 151 + 195 / -200 - 150 * 188 / 147 + 112&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="support-for-python-generators">
<h3>Support for Python Generators<a class="headerlink" href="#support-for-python-generators" title="Link to this heading">#</a></h3>
<p>The Python language has its own concept of generator functions, which we of course want to support as well.  A <em>generator function in Python</em> is a function that returns a so-called <em>iterator object</em> which we can iterate over, one value at a time.</p>
<p>To create a generator function in Python, one defines a normal function, using the <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement instead of a <code class="docutils literal notranslate"><span class="pre">return</span></code> statement.  While a <code class="docutils literal notranslate"><span class="pre">return</span></code> statement terminates the function, a <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement pauses its execution, saving all of its state, to be resumed later for the next successive calls.</p>
<p>Here is an example of a generator function.  When first invoked, <code class="docutils literal notranslate"><span class="pre">iterate()</span></code> yields the value 1, followed by 2, 3, and so on:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">iterate</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">yield</span> <span class="n">t</span>
</pre></div>
</div>
</div>
</div>
<p>We can use <code class="docutils literal notranslate"><span class="pre">iterate</span></code> in a loop, just like the <code class="docutils literal notranslate"><span class="pre">range()</span></code> function (which also is a generator function):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iterate</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1 2 3 4 5 6 7 8 9 10 
</pre></div>
</div>
</div>
</div>
<p>We can also use <code class="docutils literal notranslate"><span class="pre">iterate()</span></code> as a pre-expansion generator function, ensuring it will create one successive integer after another:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">iterate_grammar</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">,</span>
                                 <span class="p">{</span>
                                     <span class="s2">&quot;&lt;factor&gt;&quot;</span><span class="p">:</span> <span class="p">[</span>
                                         <span class="s2">&quot;+&lt;factor&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;-&lt;factor&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;(&lt;expr&gt;)&quot;</span><span class="p">,</span>
                                         <span class="c1"># &quot;&lt;integer&gt;.&lt;integer&gt;&quot;,</span>

                                         <span class="c1"># Generate one integer after another</span>
                                         <span class="c1"># from the function</span>
                                         <span class="p">(</span><span class="s2">&quot;&lt;integer&gt;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span><span class="n">pre</span><span class="o">=</span><span class="n">iterate</span><span class="p">)),</span>
                                     <span class="p">],</span>
                                 <span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>To support generators, our <code class="docutils literal notranslate"><span class="pre">process_chosen_children()</span></code> method, above, checks whether a function is a generator; if so, it invokes the <code class="docutils literal notranslate"><span class="pre">run_generator()</span></code> method.  When <code class="docutils literal notranslate"><span class="pre">run_generator()</span></code> sees the function for the first time during a <code class="docutils literal notranslate"><span class="pre">fuzz_tree()</span></code> (or <code class="docutils literal notranslate"><span class="pre">fuzz()</span></code>) call, it invokes the function to create a generator object; this is saved in the <code class="docutils literal notranslate"><span class="pre">generators</span></code> attribute, and then called.  Subsequent calls directly go to the generator, preserving state.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">GeneratorGrammarFuzzer</span><span class="p">(</span><span class="n">GeneratorGrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fuzz_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DerivationTree</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_generators</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">fuzz_tree</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset_generators</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generators</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expansion</span><span class="p">:</span> <span class="n">Expansion</span><span class="p">,</span>
                      <span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">((</span><span class="n">expansion</span><span class="p">,</span> <span class="n">function</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generators</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">function</span><span class="p">()</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generators</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Does this work?  Let us run our fuzzer on the above grammar, using <code class="docutils literal notranslate"><span class="pre">iterator()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">iterate_fuzzer</span> <span class="o">=</span> <span class="n">GeneratorGrammarFuzzer</span><span class="p">(</span><span class="n">iterate_grammar</span><span class="p">)</span>
<span class="n">iterate_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;1 * ++++3 / ---+4 - 2 * +--6 / 7 * 10 - (9 - 11) - 5 + (13) * 14 + 8 + 12&#39;
</pre></div>
</div>
</div>
</div>
<p>We see that the expression contains all integers starting with 1.</p>
<p>Instead of specifying our own Python generator function such as <code class="docutils literal notranslate"><span class="pre">iterate()</span></code>, we can also use one of the built-in Python generators such as <code class="docutils literal notranslate"><span class="pre">range()</span></code>.  This will also generate integers starting with 1:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">iterate_grammar</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">,</span>
                                 <span class="p">{</span>
                                     <span class="s2">&quot;&lt;factor&gt;&quot;</span><span class="p">:</span> <span class="p">[</span>
                                         <span class="s2">&quot;+&lt;factor&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;-&lt;factor&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;(&lt;expr&gt;)&quot;</span><span class="p">,</span>
                                         <span class="p">(</span><span class="s2">&quot;&lt;integer&gt;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span><span class="n">pre</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))),</span>
                                     <span class="p">],</span>
                                 <span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>It is also possible to use Python list comprehensions, by adding their generator functions in parentheses:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">iterate_grammar</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">,</span>
                                 <span class="p">{</span>
                                     <span class="s2">&quot;&lt;factor&gt;&quot;</span><span class="p">:</span> <span class="p">[</span>
                                         <span class="s2">&quot;+&lt;factor&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;-&lt;factor&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;(&lt;expr&gt;)&quot;</span><span class="p">,</span>
                                         <span class="p">(</span><span class="s2">&quot;&lt;integer&gt;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span>
                                             <span class="n">pre</span><span class="o">=</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)))),</span>
                                     <span class="p">],</span>
                                 <span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>Note that both above grammars will actually cause the fuzzer to raise an exception when more than 1,000 integers are created, but you will find it very easy to fix this.</p>
<p>Finally, <code class="docutils literal notranslate"><span class="pre">yield</span></code> is actually an expression, not a statement, so it is also possible to have a <code class="docutils literal notranslate"><span class="pre">lambda</span></code> expression <code class="docutils literal notranslate"><span class="pre">yield</span></code> a value.  If you find some reasonable use for this, let us know.</p>
</section>
</section>
<section id="checking-and-repairing-elements-after-expansion">
<h2>Checking and Repairing Elements after Expansion<a class="headerlink" href="#checking-and-repairing-elements-after-expansion" title="Link to this heading">#</a></h2>
<p>Let us now turn to our second set of functions to be supported – namely, post-expansion functions.  The simplest way of using them is to run them once the entire tree is generated, taking care of replacements as with <code class="docutils literal notranslate"><span class="pre">pre</span></code> functions.  If one of them returns <code class="docutils literal notranslate"><span class="pre">False</span></code>, however, we start anew.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">GeneratorGrammarFuzzer</span><span class="p">(</span><span class="n">GeneratorGrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fuzz_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DerivationTree</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">fuzz_tree</span><span class="p">()</span>
            <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span> <span class="o">=</span> <span class="n">tree</span>
            <span class="n">result</span><span class="p">,</span> <span class="n">new_children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_post_functions</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">or</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">new_children</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_expansion</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">restart_expansion</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># To be overloaded in subclasses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_generators</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">run_post_functions()</span></code> is applied recursively on all nodes of the derivation tree.  For each node, it determines the expansion applied, and then runs the function associated with that expansion.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">GeneratorGrammarFuzzer</span><span class="p">(</span><span class="n">GeneratorGrammarFuzzer</span><span class="p">):</span>
    <span class="c1"># Return True iff all constraints of grammar are satisfied in TREE</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_post_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">,</span>
                           <span class="n">depth</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">))</span> \
                               <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">DerivationTree</span><span class="p">]]]:</span>
        <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">tree</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">children</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DerivationTree</span><span class="p">]</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">DerivationTree</span><span class="p">],</span> <span class="n">tree</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">children</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">children</span>  <span class="c1"># Terminal symbol</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">expansion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_expansion</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># Expansion (no longer) found - ignore</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">children</span>

        <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">function</span> <span class="o">=</span> <span class="n">exp_post_expansion_function</span><span class="p">(</span><span class="n">expansion</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_function</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="n">all_terminals</span><span class="p">(</span><span class="n">tree</span><span class="p">),</span>
                        <span class="s2">&quot;did not satisfy&quot;</span><span class="p">,</span>
                        <span class="n">symbol</span><span class="p">,</span>
                        <span class="s2">&quot;constraint&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">children</span>

            <span class="n">children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_result</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
                <span class="n">result</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_post_functions</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">children</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">children</span>
</pre></div>
</div>
</div>
</div>
<p>The helper method <code class="docutils literal notranslate"><span class="pre">find_expansion()</span></code> takes a subtree <code class="docutils literal notranslate"><span class="pre">tree</span></code> and determines the expansion from the grammar that was applied to create the children in <code class="docutils literal notranslate"><span class="pre">tree</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">GeneratorGrammarFuzzer</span><span class="p">(</span><span class="n">GeneratorGrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_expansion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
        <span class="n">symbol</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="n">tree</span>

        <span class="n">applied_expansion</span> <span class="o">=</span> \
            <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">child_symbol</span> <span class="k">for</span> <span class="n">child_symbol</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">children</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">expansion</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="n">symbol</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">exp_string</span><span class="p">(</span><span class="n">expansion</span><span class="p">)</span> <span class="o">==</span> <span class="n">applied_expansion</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">expansion</span>

        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
            <span class="n">symbol</span> <span class="o">+</span>
            <span class="s2">&quot;: did not find expansion &quot;</span> <span class="o">+</span>
            <span class="nb">repr</span><span class="p">(</span><span class="n">applied_expansion</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">eval_function()</span></code> is the one that takes care of actually invoking the post-expansion function.  It creates an argument list containing the expansions of all nonterminal children – that is, one argument for each symbol in the grammar expansion.  It then calls the given function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">GeneratorGrammarFuzzer</span><span class="p">(</span><span class="n">GeneratorGrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">eval_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>
        <span class="n">symbol</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="n">tree</span>

        <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exp</span> <span class="o">!=</span> <span class="p">[]</span> <span class="ow">and</span> <span class="n">exp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">symbol_value</span> <span class="o">=</span> <span class="n">all_terminals</span><span class="p">((</span><span class="n">symbol</span><span class="p">,</span> <span class="n">exp</span><span class="p">))</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">symbol_value</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">function</span><span class="p">)</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="p">)),</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<p>Note that unlike pre-expansion functions, post-expansion functions typically process the values already produced, so we do not support Python generators here.</p>
<section id="example-negative-expressions">
<h3>Example: Negative Expressions<a class="headerlink" href="#example-negative-expressions" title="Link to this heading">#</a></h3>
<p>Let us try out these post-expression functions on an example.  Suppose we want to produce only arithmetic expressions that evaluate to a negative number – for instance, to feed such generated expressions into a compiler or some other external system.  Doing so constructively with <code class="docutils literal notranslate"><span class="pre">pre</span></code> functions would be very difficult. Instead, we can define a constraint that checks for precisely this property, using the Python <code class="docutils literal notranslate"><span class="pre">eval()</span></code> function.</p>
<p>The Python <code class="docutils literal notranslate"><span class="pre">eval()</span></code> function takes a string and evaluates it according to Python rules.  Since the syntax of our generated expressions is slightly different from Python, and since Python can raise arithmetic exceptions during evaluation, we need a means to handle such errors gracefully.  The function <code class="docutils literal notranslate"><span class="pre">eval_with_exception()</span></code> wraps around <code class="docutils literal notranslate"><span class="pre">eval()</span></code>; if an exception occurs during evaluation, it returns False – which causes the production algorithm to produce another value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ExpectError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExpectError</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">eval_with_exception</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="c1"># Use &quot;mute=True&quot; to suppress all messages</span>
    <span class="k">with</span> <span class="n">ExpectError</span><span class="p">(</span><span class="n">print_traceback</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">negative_expr_grammar</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">,</span>
                                       <span class="p">{</span>
                                           <span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;&lt;expr&gt;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">eval_with_exception</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))]</span>
                                       <span class="p">}</span>
                                       <span class="p">)</span>

<span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">negative_expr_grammar</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">negative_expr_fuzzer</span> <span class="o">=</span> <span class="n">GeneratorGrammarFuzzer</span><span class="p">(</span><span class="n">negative_expr_grammar</span><span class="p">)</span>
<span class="n">expr</span> <span class="o">=</span> <span class="n">negative_expr_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
<span class="n">expr</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ZeroDivisionError: division by zero (expected)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;(8.9 / 6 * 4 - 0.2 + -7 - 7 - 8 * 6) * 7 * 15.55 - -945.9&#39;
</pre></div>
</div>
</div>
</div>
<p>The result is indeed negative:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-5178.726666666667
</pre></div>
</div>
</div>
</div>
</section>
<section id="example-matching-xml-tags">
<h3>Example: Matching XML Tags<a class="headerlink" href="#example-matching-xml-tags" title="Link to this heading">#</a></h3>
<p>Post-expansion functions can not only be used to <em>check</em> expansions, but also to repair them.  To this end, we can have them return a string or a list of strings; just like pre-expansion functions, these strings would then replace the entire expansion or individual symbols.</p>
<p>As an example, consider <em>XML documents</em>, which are composed of text within matching <em>XML tags</em>.  For instance, consider the following fragment in HTML, a subset of XML:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTML</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&lt;strong&gt;A bold text&lt;/strong&gt;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><strong>A bold text</strong></div></div>
</div>
<p>This fragment consists of two HTML (XML) tags that surround the text; the tag name (<code class="docutils literal notranslate"><span class="pre">strong</span></code>) is present both in the opening (<code class="docutils literal notranslate"><span class="pre">&lt;strong&gt;</span></code>) as well as in the closing (<code class="docutils literal notranslate"><span class="pre">&lt;/strong&gt;</span></code>) tag.</p>
<p>For a <em>finite</em> set of tags (for instance, the HTML tags <code class="docutils literal notranslate"><span class="pre">&lt;strong&gt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;head&gt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;body&gt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;form&gt;</span></code>, and so on), we could define a context-free grammar that parses it; each pair of tags would make up an individual rule in the grammar.  If the set of tags is <em>infinite</em>, though, as with general XML, we cannot define an appropriate grammar; that is because the constraint that the closing tag must match the opening tag is context-sensitive and thus does not fit context-free grammars.</p>
<p>(Incidentally, if the closing tag had the identifier <em>reversed</em> (<code class="docutils literal notranslate"><span class="pre">&lt;/gnorts&gt;</span></code>), then a context-free grammar could describe it.  Make this a programming exercise.)</p>
<p>We can address this problem by introducing appropriate post-expansion functions that automatically make the closing tag match the opening tag.  Let us start with a simple grammar for producing XML trees:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">XML_GRAMMAR</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;xml-tree&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;xml-tree&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;&lt;id&gt;&gt;&lt;xml-content&gt;&lt;/&lt;id&gt;&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;xml-content&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Text&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;xml-tree&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;id&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;letter&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;id&gt;&lt;letter&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;letter&gt;&quot;</span><span class="p">:</span> <span class="n">crange</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">XML_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>If we fuzz using this grammar, we get non-matching XML tags, as expected:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xml_fuzzer</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">XML_GRAMMAR</span><span class="p">)</span>
<span class="n">xml_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;&lt;t&gt;&lt;qju&gt;Text&lt;/m&gt;&lt;/q&gt;&#39;
</pre></div>
</div>
</div>
</div>
<p>Setting up a post-expansion function that sets the second identifier to the string found in the first solves the problem:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">XML_GRAMMAR</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="s2">&quot;&lt;xml-tree&gt;&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;&lt;&lt;id&gt;&gt;&lt;xml-content&gt;&lt;/&lt;id&gt;&gt;&quot;</span><span class="p">,</span>
                    <span class="n">opts</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="k">lambda</span> <span class="n">id1</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">id2</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">id1</span><span class="p">])</span>
                    <span class="p">)]</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">XML_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xml_fuzzer</span> <span class="o">=</span> <span class="n">GeneratorGrammarFuzzer</span><span class="p">(</span><span class="n">XML_GRAMMAR</span><span class="p">)</span>
<span class="n">xml_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;&lt;u&gt;Text&lt;/u&gt;&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="example-checksums">
<h3>Example: Checksums<a class="headerlink" href="#example-checksums" title="Link to this heading">#</a></h3>
<p>As our last example, let us consider the checksum problem from the introduction.  With our newly defined repair mechanisms, we can now generate credit card numbers that are valid:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">credit_card_fuzzer</span> <span class="o">=</span> <span class="n">GeneratorGrammarFuzzer</span><span class="p">(</span>
    <span class="n">CHARGE_GRAMMAR</span><span class="p">,</span> <span class="n">start_symbol</span><span class="o">=</span><span class="s2">&quot;&lt;credit-card-number&gt;&quot;</span><span class="p">)</span>
<span class="n">credit_card_number</span> <span class="o">=</span> <span class="n">credit_card_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
<span class="n">credit_card_number</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;2967308746680770&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">valid_luhn_checksum</span><span class="p">(</span><span class="n">credit_card_number</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The validity extends to the entire grammar:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">charge_fuzzer</span> <span class="o">=</span> <span class="n">GeneratorGrammarFuzzer</span><span class="p">(</span><span class="n">CHARGE_GRAMMAR</span><span class="p">)</span>
<span class="n">charge_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Charge $818819.97 to my credit card 2817984968014288&#39;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="local-checking-and-repairing">
<h2>Local Checking and Repairing<a class="headerlink" href="#local-checking-and-repairing" title="Link to this heading">#</a></h2>
<p>So far, we have always first generated an entire expression tree, only to check it later for validity.  This can become expensive: If several elements are first generated only to find later that one of them is invalid, we spend a lot of time trying (randomly) to regenerate a matching input.</p>
<p>To demonstrate the issue, let us create an expression grammar in which all digits consist of zeros and ones.  Rather than doing this constructively, though, we filter out all non-conforming expressions after the fact, using a <code class="docutils literal notranslate"><span class="pre">post</span></code> constraint:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">binary_expr_grammar</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">,</span>
                                     <span class="p">{</span>
                                         <span class="s2">&quot;&lt;integer&gt;&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;&lt;digit&gt;&lt;integer&gt;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="k">lambda</span> <span class="n">digit</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">digit</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">])),</span>
                                                       <span class="p">(</span><span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="k">lambda</span> <span class="n">digit</span><span class="p">:</span> <span class="n">digit</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">]))]</span>
                                     <span class="p">}</span>
                                     <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">binary_expr_grammar</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This works, but is very slow; it can take several seconds before a matching expression is found.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">binary_expr_fuzzer</span> <span class="o">=</span> <span class="n">GeneratorGrammarFuzzer</span><span class="p">(</span><span class="n">binary_expr_grammar</span><span class="p">)</span>
<span class="n">binary_expr_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;(-+0)&#39;
</pre></div>
</div>
</div>
</div>
<p>We can address the problem by checking constraints not only for the final subtree, but also for partial subtrees as soon as they are complete.  To this end, we extend the method <code class="docutils literal notranslate"><span class="pre">expand_tree_once()</span></code> such that it invokes the post-expansion function as soon as all symbols in a subtree are expanded.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">RestartExpansionException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">GeneratorGrammarFuzzer</span><span class="p">(</span><span class="n">GeneratorGrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">expand_tree_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DerivationTree</span><span class="p">:</span>
        <span class="c1"># Apply inherited method.  This also calls `expand_tree_once()` on all</span>
        <span class="c1"># subtrees.</span>
        <span class="n">new_tree</span><span class="p">:</span> <span class="n">DerivationTree</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">expand_tree_once</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>

        <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span> <span class="o">=</span> <span class="n">new_tree</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">exp_post_expansion_function</span><span class="p">(</span><span class="n">expansion</span><span class="p">)</span>
                <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">expansion</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="n">symbol</span><span class="p">]]):</span>
            <span class="c1"># No constraints for this symbol</span>
            <span class="k">return</span> <span class="n">new_tree</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">any_possible_expansions</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
            <span class="c1"># Still expanding</span>
            <span class="k">return</span> <span class="n">new_tree</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_post_functions_locally</span><span class="p">(</span><span class="n">new_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The main work takes place in the helper method <code class="docutils literal notranslate"><span class="pre">run_post_functions_locally()</span></code>.  It runs the post-expansion function <span class="math notranslate nohighlight">\(f\)</span> with <code class="docutils literal notranslate"><span class="pre">run_post_functions()</span></code> only on the current node by setting <code class="docutils literal notranslate"><span class="pre">depth</span></code> to zero, as any completed subtrees would have their post-expansion functions ran already.  If <span class="math notranslate nohighlight">\(f\)</span> returns <code class="docutils literal notranslate"><span class="pre">False</span></code>, <code class="docutils literal notranslate"><span class="pre">run_post_functions_locally()</span></code> returns a non-expanded symbol, such that the main driver can try another expansion.  It does so for up to 10 times (configurable via a <code class="docutils literal notranslate"><span class="pre">replacement_attempts</span></code> parameter during construction); after that, it raises a <code class="docutils literal notranslate"><span class="pre">RestartExpansionException</span></code> to restart creating the tree from scratch.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">GeneratorGrammarFuzzer</span><span class="p">(</span><span class="n">GeneratorGrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_post_functions_locally</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_tree</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DerivationTree</span><span class="p">:</span>
        <span class="n">symbol</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">new_tree</span>

        <span class="n">result</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_post_functions</span><span class="p">(</span><span class="n">new_tree</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">or</span> <span class="n">result</span><span class="p">:</span>
            <span class="c1"># No constraints, or constraint satisfied</span>
            <span class="c1"># children = self.apply_result(result, children)</span>
            <span class="n">new_tree</span> <span class="o">=</span> <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new_tree</span>

        <span class="c1"># Replace tree by unexpanded symbol and try again</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">all_terminals</span><span class="p">(</span><span class="n">new_tree</span><span class="p">),</span>
                <span class="s2">&quot;did not satisfy&quot;</span><span class="p">,</span>
                <span class="n">symbol</span><span class="p">,</span>
                <span class="s2">&quot;constraint&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">replacement_attempts_counter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Trying another expansion&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">replacement_attempts_counter</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting from scratch&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">RestartExpansionException</span>
</pre></div>
</div>
</div>
</div>
<p>The class constructor method and <code class="docutils literal notranslate"><span class="pre">fuzz_tree()</span></code> are set up to handle the additional functionality:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">GeneratorGrammarFuzzer</span><span class="p">(</span><span class="n">GeneratorGrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">,</span> <span class="n">replacement_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replacement_attempts</span> <span class="o">=</span> <span class="n">replacement_attempts</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">restart_expansion</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">restart_expansion</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replacement_attempts_counter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replacement_attempts</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fuzz_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DerivationTree</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replacement_attempts_counter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replacement_attempts</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># This is fuzz_tree() as defined above</span>
                <span class="n">tree</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">fuzz_tree</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">tree</span>
            <span class="k">except</span> <span class="n">RestartExpansionException</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">restart_expansion</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">binary_expr_fuzzer</span> <span class="o">=</span> <span class="n">GeneratorGrammarFuzzer</span><span class="p">(</span>
    <span class="n">binary_expr_grammar</span><span class="p">,</span> <span class="n">replacement_attempts</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">binary_expr_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;+0 / +-1 - 1 / +0 * -+0 * 0 * 1 / 1&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="definitions-and-uses">
<h2>Definitions and Uses<a class="headerlink" href="#definitions-and-uses" title="Link to this heading">#</a></h2>
<p>With the above generators and constraints, we can also address complex examples.  The <code class="docutils literal notranslate"><span class="pre">VAR_GRAMMAR</span></code> grammar from <a class="reference internal" href="Parser.html"><span class="std std-doc">the chapter on parsers</span></a> defines a number of variables as arithmetic expressions (which in turn can contain variables, too).  Applying a simple <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code> on the grammar produces plenty of identifiers, but each identifier has a unique name.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">string</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">VAR_GRAMMAR</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;&lt;start&gt;&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&lt;statements&gt;&#39;</span><span class="p">],</span>
    <span class="s1">&#39;&lt;statements&gt;&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&lt;statement&gt;;&lt;statements&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;statement&gt;&#39;</span><span class="p">],</span>
    <span class="s1">&#39;&lt;statement&gt;&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&lt;assignment&gt;&#39;</span><span class="p">],</span>
    <span class="s1">&#39;&lt;assignment&gt;&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&lt;identifier&gt;=&lt;expr&gt;&#39;</span><span class="p">],</span>
    <span class="s1">&#39;&lt;identifier&gt;&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&lt;word&gt;&#39;</span><span class="p">],</span>
    <span class="s1">&#39;&lt;word&gt;&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&lt;alpha&gt;&lt;word&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;alpha&gt;&#39;</span><span class="p">],</span>
    <span class="s1">&#39;&lt;alpha&gt;&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">),</span>
    <span class="s1">&#39;&lt;expr&gt;&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&lt;term&gt;+&lt;expr&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;term&gt;-&lt;expr&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;term&gt;&#39;</span><span class="p">],</span>
    <span class="s1">&#39;&lt;term&gt;&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&lt;factor&gt;*&lt;term&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;factor&gt;/&lt;term&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;factor&gt;&#39;</span><span class="p">],</span>
    <span class="s1">&#39;&lt;factor&gt;&#39;</span><span class="p">:</span>
    <span class="p">[</span><span class="s1">&#39;+&lt;factor&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;-&lt;factor&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;(&lt;expr&gt;)&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;identifier&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;number&gt;&#39;</span><span class="p">],</span>
    <span class="s1">&#39;&lt;number&gt;&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&lt;integer&gt;.&lt;integer&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;integer&gt;&#39;</span><span class="p">],</span>
    <span class="s1">&#39;&lt;integer&gt;&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&lt;digit&gt;&lt;integer&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;digit&gt;&#39;</span><span class="p">],</span>
    <span class="s1">&#39;&lt;digit&gt;&#39;</span><span class="p">:</span> <span class="n">crange</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">VAR_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">VAR_GRAMMAR</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Gc=F/1*Y+M-D-9;N=n/(m)/m*7
a=79.0;W=o-9;v=2;K=u;D=9
o=y-z+y+4;q=5+W;X=T
M=-98.032*5/o
H=IA-5-1;n=3-t;QQ=5-5
Y=-80;d=D-M+M;Z=4.3+1*r-5+b
ZDGSS=(1*Y-4)*54/0*pcO/4;RI=r*5.0
Q=6+z-6;J=6/t/9/i-3-5+k
x=-GT*+-x*6++-93*5
q=da*T/e--v;x=3+g;bk=u
</pre></div>
</div>
</div>
</div>
<p>What we’d like is that within expressions, only identifiers <em>previously defined</em> should be used.  To this end, we introduce a set of functions around a <em>symbol table</em>, which keeps track of all variables already defined.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SYMBOL_TABLE</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">define_id</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">SYMBOL_TABLE</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">use_id</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">SYMBOL_TABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">SYMBOL_TABLE</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">id</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">clear_symbol_table</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">SYMBOL_TABLE</span>
    <span class="n">SYMBOL_TABLE</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>To make use of the symbol table, we attach pre- and post-expansion functions to <code class="docutils literal notranslate"><span class="pre">VAR_GRAMMAR</span></code> that define and lookup identifiers from the symbol table.  We name our extended grammar <code class="docutils literal notranslate"><span class="pre">CONSTRAINED_VAR_GRAMMAR</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CONSTRAINED_VAR_GRAMMAR</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">VAR_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>First, we set up the grammar such that after each time an identifier is defined, we store its name in the symbol table:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CONSTRAINED_VAR_GRAMMAR</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">CONSTRAINED_VAR_GRAMMAR</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;assignment&gt;&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;&lt;identifier&gt;=&lt;expr&gt;&quot;</span><span class="p">,</span>
                      <span class="n">opts</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="k">lambda</span> <span class="nb">id</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="n">define_id</span><span class="p">(</span><span class="nb">id</span><span class="p">)))]</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>Second, we make sure that when an identifier is generated, we pick it from the symbol table, too.  (We use <code class="docutils literal notranslate"><span class="pre">post</span></code> here such that we can return <code class="docutils literal notranslate"><span class="pre">False</span></code> if no identifier is yet available, leading to another expansion being made.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CONSTRAINED_VAR_GRAMMAR</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">CONSTRAINED_VAR_GRAMMAR</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;factor&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;+&lt;factor&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;-&lt;factor&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;(&lt;expr&gt;)&#39;</span><span class="p">,</span>
                 <span class="p">(</span><span class="s2">&quot;&lt;identifier&gt;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">use_id</span><span class="p">())),</span>
                 <span class="s1">&#39;&lt;number&gt;&#39;</span><span class="p">]</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we clear the symbol table each time we (re)start an expansion.  This is helpful as we may occasionally have to restart expansions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CONSTRAINED_VAR_GRAMMAR</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">CONSTRAINED_VAR_GRAMMAR</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;&lt;statements&gt;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span><span class="n">pre</span><span class="o">=</span><span class="n">clear_symbol_table</span><span class="p">))]</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">CONSTRAINED_VAR_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Fuzzing with this grammar ensures that each identifier used is actually defined:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">var_grammar_fuzzer</span> <span class="o">=</span> <span class="n">GeneratorGrammarFuzzer</span><span class="p">(</span><span class="n">CONSTRAINED_VAR_GRAMMAR</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">var_grammar_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DB=+(8/4/7-9+3+3)/2178/+-9
lNIqc=+(1+9-8)/2.9*8/5*0
Sg=(+9/8/6)*++1/(1+7)*8*4
r=+---552
iz=5/7/7;K=1+6*iz*1
q=3-2;MPy=q;p=2*5
zj=+5*-+35.2-+1.5727978+(-(-0/6-7+3))*--+44*1
Tl=((0*9+4-3)-6)/(-3-7*8*8/7)+9
aXZ=-5/-+3*9/3/1-8-+0*0/3+7+4
NA=-(8+a-1)*1.6;g=++7;a=++g*g*g
</pre></div>
</div>
</div>
</div>
</section>
<section id="ordering-expansions">
<h2>Ordering Expansions<a class="headerlink" href="#ordering-expansions" title="Link to this heading">#</a></h2>
<p>While our previous def/use example ensures that each <em>used</em> variable also is a <em>defined</em> variable, it does not take care of the <em>order</em> in which these definitions are made.  In fact, it is possible that first, the term on the right-hand side of a <code class="docutils literal notranslate"><span class="pre">;</span></code> expands, creating an entry in the symbol table, which is then later used in the expression on the left hand side.  We can demonstrate this by actually evaluating the produced variable assignments in Python, using <code class="docutils literal notranslate"><span class="pre">exec()</span></code> to execute the sequence of assignments.  (Little known fact: Python <em>does</em> support <code class="docutils literal notranslate"><span class="pre">;</span></code> as statement separator.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">var_grammar_fuzzer</span> <span class="o">=</span> <span class="n">GeneratorGrammarFuzzer</span><span class="p">(</span><span class="n">CONSTRAINED_VAR_GRAMMAR</span><span class="p">)</span>
<span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">var_grammar_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exec</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{})</span>
        <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
            <span class="k">continue</span>
<span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f=(9)*kOj*kOj-6/7;kOj=(9-8)*7*1
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_23448/3970000697.py&quot;, line 6, in &lt;module&gt;
    exec(s, {}, {})
    ~~~~^^^^^^^^^^^
  File &quot;&lt;string&gt;&quot;, line 1, in &lt;module&gt;
NameError: name &#39;kOj&#39; is not defined (expected)
</pre></div>
</div>
</div>
</div>
<p>To address this issue, we allow explicitly specifying an <em>ordering of expansions</em>.  For our previous fuzzers, such an ordering was inconsequential, as eventually, all symbols would be expanded; if we have expansion functions with side effects, though, having control over the ordering in which expansions are made (and thus over the ordering in which the associated functions are called) can be important.</p>
<p>To specify orderings, we assign a special attribute <code class="docutils literal notranslate"><span class="pre">order</span></code> to individual expansions.  This is a list with a number for each symbol in the expansion stating in which order the expansions are to be made, starting with the smallest one.  As an example, the following rule specifies that the left-hand side of a <code class="docutils literal notranslate"><span class="pre">;</span></code> separator should be expanded first:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CONSTRAINED_VAR_GRAMMAR</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">CONSTRAINED_VAR_GRAMMAR</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;statements&gt;&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;&lt;statement&gt;;&lt;statements&gt;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])),</span>
                     <span class="s2">&quot;&lt;statement&gt;&quot;</span><span class="p">]</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>Likewise, we want the definition of a variable to be produced only <em>after</em> the expression is expanded, since otherwise, the expression might already refer to the defined variable:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CONSTRAINED_VAR_GRAMMAR</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">CONSTRAINED_VAR_GRAMMAR</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;assignment&gt;&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;&lt;identifier&gt;=&lt;expr&gt;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="k">lambda</span> <span class="nb">id</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="n">define_id</span><span class="p">(</span><span class="nb">id</span><span class="p">),</span>
                                                  <span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))],</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>The helper <code class="docutils literal notranslate"><span class="pre">exp_order()</span></code> allows us to retrieve the order:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">exp_order</span><span class="p">(</span><span class="n">expansion</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the specified expansion ordering, or None if unspecified&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">exp_opt</span><span class="p">(</span><span class="n">expansion</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>To control the ordering in which symbols are expanded, we hook into the method <code class="docutils literal notranslate"><span class="pre">choose_tree_expansion()</span></code>, which is specifically set for being extended in subclasses.  It proceeds through the list <code class="docutils literal notranslate"><span class="pre">expandable_children</span></code> of expandable children to choose from and matches them with the nonterminal children from the expansion to determine their order number.  The index <code class="docutils literal notranslate"><span class="pre">min_given_order</span></code> of the expandable child with the lowest order number is then returned, choosing this child for expansion.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">GeneratorGrammarFuzzer</span><span class="p">(</span><span class="n">GeneratorGrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">choose_tree_expansion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">,</span>
                              <span class="n">expandable_children</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DerivationTree</span><span class="p">])</span> \
                              <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return index of subtree in `expandable_children`</span>
<span class="sd">           to be selected for expansion. Defaults to random.&quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">tree_children</span><span class="p">)</span> <span class="o">=</span> <span class="n">tree</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tree_children</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">expandable_children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># No choice</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">choose_tree_expansion</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">expandable_children</span><span class="p">)</span>

        <span class="n">expansion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_expansion</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="n">given_order</span> <span class="o">=</span> <span class="n">exp_order</span><span class="p">(</span><span class="n">expansion</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">given_order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># No order specified</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">choose_tree_expansion</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">expandable_children</span><span class="p">)</span>

        <span class="n">nonterminal_children</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tree_children</span> <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonterminal_children</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">given_order</span><span class="p">),</span> \
            <span class="s2">&quot;Order must have one element for each nonterminal&quot;</span>

        <span class="c1"># Find expandable child with lowest ordering</span>
        <span class="n">min_given_order</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">expandable_child</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">expandable_children</span><span class="p">):</span>
            <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="n">nonterminal_children</span><span class="p">)</span> <span class="ow">and</span> <span class="n">expandable_child</span> <span class="o">!=</span> <span class="n">nonterminal_children</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonterminal_children</span><span class="p">),</span> <span class="s2">&quot;Expandable child not found&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Expandable child #</span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> has order </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">expandable_child</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">given_order</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>

            <span class="k">if</span> <span class="n">min_given_order</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">given_order</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">given_order</span><span class="p">[</span><span class="n">min_given_order</span><span class="p">]:</span>
                <span class="n">min_given_order</span> <span class="o">=</span> <span class="n">k</span>

        <span class="k">assert</span> <span class="n">min_given_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Returning expandable child #</span><span class="si">%d</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="n">min_given_order</span><span class="p">,</span> <span class="n">expandable_children</span><span class="p">[</span><span class="n">min_given_order</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">min_given_order</span>
</pre></div>
</div>
</div>
</div>
<p>With this, our fuzzer can now respect orderings, and all variables are properly defined:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">var_grammar_fuzzer</span> <span class="o">=</span> <span class="n">GeneratorGrammarFuzzer</span><span class="p">(</span><span class="n">CONSTRAINED_VAR_GRAMMAR</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">var_grammar_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{})</span>
    <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
        <span class="k">continue</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a=(1)*0*3/8+0/8-4/8-0
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>r=+0*+8/-4+((9)*2-1-8+6/9)
D=+(2*3+6*0)-(5)/9*0/2;Q=D
C=9*(2-1)*9*0-1.2/6-3*5
G=-25.1
H=+4*4/8.5*4-8*4+(5);D=6
PIF=4841/++(460.1---626)*51755;E=(8)/-PIF+6.8*(7-PIF)*9*PIF;k=8
X=((0)*2/0*6+7*3)/(0-7-9)
x=94.2+25;x=++x/(7)+-9/8/2/x+-1/x;I=x
cBM=51.15;f=81*-+--((2++cBM/cBM*+1*0/0-5+cBM))
</pre></div>
</div>
</div>
</div>
<p>Real programming languages not only have one global scope, but multiple local scopes, frequently nested.  By carefully organizing global and local symbol tables, we can set up a grammar to handle all of these.  However, when fuzzing compilers and interpreters, we typically focus on single functions, for which one single scope is enough to make most inputs valid.</p>
</section>
<section id="all-together">
<h2>All Together<a class="headerlink" href="#all-together" title="Link to this heading">#</a></h2>
<p>Let us close this chapter by integrating our generator features with the other grammar features introduced earlier, in particular <a class="reference internal" href="GrammarCoverageFuzzer.html"><span class="std std-doc">coverage-driven fuzzing</span></a> and <a class="reference internal" href="ProbabilisticGrammarFuzzer.html"><span class="std std-doc">probabilistic grammar fuzzing</span></a>.</p>
<p>The general idea to integrate the individual features is through <em>multiple inheritance</em>, which we already used for <code class="docutils literal notranslate"><span class="pre">ProbabilisticGrammarCoverageFuzzer</span></code>, introduced in the <a class="reference internal" href="ProbabilisticGrammarFuzzer.html"><span class="std std-doc">exercises on probabilistic fuzzing</span></a>.</p>
<section id="generators-and-probabilistic-fuzzing">
<h3>Generators and Probabilistic Fuzzing<a class="headerlink" href="#generators-and-probabilistic-fuzzing" title="Link to this heading">#</a></h3>
<p>Probabilistic fuzzing integrates very easily with generators, as both extend <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code> in different ways.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ProbabilisticGrammarFuzzer</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProbabilisticGrammarFuzzer</span>  <span class="c1"># minor dependency</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">inheritance_conflicts</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inheritance_conflicts</span><span class="p">(</span><span class="n">ProbabilisticGrammarFuzzer</span><span class="p">,</span> <span class="n">GeneratorGrammarFuzzer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;__firstlineno__&#39;, &#39;supported_opts&#39;]
</pre></div>
</div>
</div>
</div>
<p>We have to implement <code class="docutils literal notranslate"><span class="pre">supported_opts()</span></code> as the merger of both superclasses.  At the same time, we also set up the constructor such that it invokes both.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ProbabilisticGeneratorGrammarFuzzer</span><span class="p">(</span><span class="n">GeneratorGrammarFuzzer</span><span class="p">,</span>
                                          <span class="n">ProbabilisticGrammarFuzzer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Join the features of `GeneratorGrammarFuzzer` </span>
<span class="sd">    and `ProbabilisticGrammarFuzzer`&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">supported_opts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">GeneratorGrammarFuzzer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">supported_opts</span><span class="p">()</span> <span class="o">|</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">ProbabilisticGrammarFuzzer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">supported_opts</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">replacement_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor.</span>
<span class="sd">        `replacement_attempts` - see `GeneratorGrammarFuzzer` constructor.</span>
<span class="sd">        All other keywords go into `ProbabilisticGrammarFuzzer`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GeneratorGrammarFuzzer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
                <span class="n">grammar</span><span class="p">,</span>
                <span class="n">replacement_attempts</span><span class="o">=</span><span class="n">replacement_attempts</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ProbabilisticGrammarFuzzer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let us give our joint class a simple test, using probabilities to favor long identifiers:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CONSTRAINED_VAR_GRAMMAR</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="s1">&#39;&lt;word&gt;&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="s1">&#39;&lt;alpha&gt;&lt;word&gt;&#39;</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span><span class="n">prob</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)),</span>
               <span class="s1">&#39;&lt;alpha&gt;&#39;</span><span class="p">],</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pgg_fuzzer</span> <span class="o">=</span> <span class="n">ProbabilisticGeneratorGrammarFuzzer</span><span class="p">(</span><span class="n">CONSTRAINED_VAR_GRAMMAR</span><span class="p">)</span>
<span class="n">pgg_fuzzer</span><span class="o">.</span><span class="n">supported_opts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;order&#39;, &#39;post&#39;, &#39;pre&#39;, &#39;prob&#39;}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pgg_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;a=5+3/8/8+-1/6/9/8;E=6&#39;
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="generators-and-grammar-coverage">
<h1>Generators and Grammar Coverage<a class="headerlink" href="#generators-and-grammar-coverage" title="Link to this heading">#</a></h1>
<p>Fuzzing based on grammar coverage is a bigger challenge.  Not so much for the methods overloaded in both; we can resolve these just as above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ProbabilisticGrammarFuzzer</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProbabilisticGrammarCoverageFuzzer</span>  <span class="c1"># minor dependency</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">GrammarCoverageFuzzer</span><span class="w"> </span><span class="kn">import</span> <span class="n">GrammarCoverageFuzzer</span>  <span class="c1"># minor dependency</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inheritance_conflicts</span><span class="p">(</span><span class="n">ProbabilisticGrammarCoverageFuzzer</span><span class="p">,</span>
                      <span class="n">GeneratorGrammarFuzzer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;__firstlineno__&#39;, &#39;__init__&#39;, &#39;supported_opts&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ProbabilisticGeneratorGrammarCoverageFuzzer</span><span class="p">(</span><span class="n">GeneratorGrammarFuzzer</span><span class="p">,</span>
                                                  <span class="n">ProbabilisticGrammarCoverageFuzzer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Join the features of `GeneratorGrammarFuzzer` </span>
<span class="sd">    and `ProbabilisticGrammarCoverageFuzzer`&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">supported_opts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">GeneratorGrammarFuzzer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">supported_opts</span><span class="p">()</span> <span class="o">|</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">ProbabilisticGrammarCoverageFuzzer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">supported_opts</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                 <span class="n">replacement_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor.</span>
<span class="sd">        `replacement_attempts` - see `GeneratorGrammarFuzzer` constructor.</span>
<span class="sd">        All other keywords go into `ProbabilisticGrammarFuzzer`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GeneratorGrammarFuzzer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
                <span class="n">grammar</span><span class="p">,</span>
                <span class="n">replacement_attempts</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ProbabilisticGrammarCoverageFuzzer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
                <span class="n">grammar</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The problem is that during expansion, we <em>may</em> generate (and cover) expansions that we later drop (for instance, because a <code class="docutils literal notranslate"><span class="pre">post</span></code> function returns <code class="docutils literal notranslate"><span class="pre">False</span></code>).  Hence, we have to <em>remove</em> this coverage which is no longer present in the final production.</p>
<p>We resolve the problem by <em>rebuilding the coverage</em> from the final tree after it is produced.  To this end, we hook into the <code class="docutils literal notranslate"><span class="pre">fuzz_tree()</span></code> method.  We have it save the original coverage before creating the tree, restoring it afterwards.  Then we traverse the resulting tree, adding its coverage back again (<code class="docutils literal notranslate"><span class="pre">add_tree_coverage()</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ProbabilisticGeneratorGrammarCoverageFuzzer</span><span class="p">(</span>
        <span class="n">ProbabilisticGeneratorGrammarCoverageFuzzer</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fuzz_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DerivationTree</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_covered_expansions</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covered_expansions</span><span class="p">)</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">fuzz_tree</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covered_expansions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_covered_expansions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_tree_coverage</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tree</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_tree_coverage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span> <span class="o">=</span> <span class="n">tree</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">flat_children</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DerivationTree</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">child_symbol</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">child_symbol</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">children</span>
            <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_coverage</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">flat_children</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_tree_coverage</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>As a final step, we ensure that if we do have to restart an expansion from scratch, we also restore the previous coverage such that we can start fully anew:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ProbabilisticGeneratorGrammarCoverageFuzzer</span><span class="p">(</span>
        <span class="n">ProbabilisticGeneratorGrammarCoverageFuzzer</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">restart_expansion</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">restart_expansion</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covered_expansions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_covered_expansions</span>
</pre></div>
</div>
</div>
</div>
<p>Let us try this out.  After we have produced a string, we should see its coverage in <code class="docutils literal notranslate"><span class="pre">expansion_coverage()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pggc_fuzzer</span> <span class="o">=</span> <span class="n">ProbabilisticGeneratorGrammarCoverageFuzzer</span><span class="p">(</span>
    <span class="n">CONSTRAINED_VAR_GRAMMAR</span><span class="p">)</span>
<span class="n">pggc_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;H=+-2+7.4*(9)/0-6*8;T=5&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pggc_fuzzer</span><span class="o">.</span><span class="n">expansion_coverage</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&lt;alpha&gt; -&gt; H&#39;,
 &#39;&lt;alpha&gt; -&gt; T&#39;,
 &#39;&lt;assignment&gt; -&gt; &lt;identifier&gt;=&lt;expr&gt;&#39;,
 &#39;&lt;digit&gt; -&gt; 0&#39;,
 &#39;&lt;digit&gt; -&gt; 2&#39;,
 &#39;&lt;digit&gt; -&gt; 4&#39;,
 &#39;&lt;digit&gt; -&gt; 5&#39;,
 &#39;&lt;digit&gt; -&gt; 6&#39;,
 &#39;&lt;digit&gt; -&gt; 7&#39;,
 &#39;&lt;digit&gt; -&gt; 8&#39;,
 &#39;&lt;digit&gt; -&gt; 9&#39;,
 &#39;&lt;expr&gt; -&gt; &lt;term&gt;&#39;,
 &#39;&lt;expr&gt; -&gt; &lt;term&gt;+&lt;expr&gt;&#39;,
 &#39;&lt;expr&gt; -&gt; &lt;term&gt;-&lt;expr&gt;&#39;,
 &#39;&lt;factor&gt; -&gt; (&lt;expr&gt;)&#39;,
 &#39;&lt;factor&gt; -&gt; +&lt;factor&gt;&#39;,
 &#39;&lt;factor&gt; -&gt; -&lt;factor&gt;&#39;,
 &#39;&lt;factor&gt; -&gt; &lt;number&gt;&#39;,
 &#39;&lt;identifier&gt; -&gt; &lt;word&gt;&#39;,
 &#39;&lt;integer&gt; -&gt; &lt;digit&gt;&#39;,
 &#39;&lt;number&gt; -&gt; &lt;integer&gt;&#39;,
 &#39;&lt;number&gt; -&gt; &lt;integer&gt;.&lt;integer&gt;&#39;,
 &#39;&lt;start&gt; -&gt; &lt;statements&gt;&#39;,
 &#39;&lt;statement&gt; -&gt; &lt;assignment&gt;&#39;,
 &#39;&lt;statements&gt; -&gt; &lt;statement&gt;&#39;,
 &#39;&lt;statements&gt; -&gt; &lt;statement&gt;;&lt;statements&gt;&#39;,
 &#39;&lt;term&gt; -&gt; &lt;factor&gt;&#39;,
 &#39;&lt;term&gt; -&gt; &lt;factor&gt;*&lt;term&gt;&#39;,
 &#39;&lt;term&gt; -&gt; &lt;factor&gt;/&lt;term&gt;&#39;,
 &#39;&lt;word&gt; -&gt; &lt;alpha&gt;&#39;}
</pre></div>
</div>
</div>
</div>
<p>Fuzzing again would eventually cover all letters in identifiers:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">pggc_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;llcyzc=3.0*02.3*1&#39;,
 &#39;RfMgRYmd=---2.9&#39;,
 &#39;p=+(7+3/4)*+-4-3.2*((2)-4)/2&#39;,
 &#39;z=1-2/4-3*9+3+5&#39;,
 &#39;v=(2/3)/1/2*8+(3)-7*2-1&#39;,
 &#39;L=9.5/9-(7)/8/1+2-2;c=L&#39;,
 &#39;U=+-91535-1-9-(9)/1;i=U&#39;,
 &#39;g=-8.3*7*5+1*5*9-5;k=1&#39;,
 &#39;J=+-8-(5/6-1)/7-6+7&#39;,
 &#39;p=053/-(8*0*3*2/1);t=p&#39;]
</pre></div>
</div>
</div>
</div>
<p>With <code class="docutils literal notranslate"><span class="pre">ProbabilisticGeneratorGrammarCoverageFuzzer</span></code>, we now have a grammar fuzzer that combines efficient grammar fuzzing with coverage, probabilities, and generator functions.  The only thing that is missing is a shorter name.  <code class="docutils literal notranslate"><span class="pre">PGGCFuzzer</span></code>, maybe?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">PGGCFuzzer</span><span class="p">(</span><span class="n">ProbabilisticGeneratorGrammarCoverageFuzzer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The one grammar-based fuzzer that supports all fuzzingbook features&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<section id="lessons-learned">
<h2>Lessons Learned<a class="headerlink" href="#lessons-learned" title="Link to this heading">#</a></h2>
<p>Functions attached to grammar expansions can serve</p>
<ul class="simple">
<li><p>as <em>generators</em> to efficiently produce a symbol expansion from a function;</p></li>
<li><p>as <em>constraints</em> to check produced strings against (complex) validity conditions; and</p></li>
<li><p>as <em>repairs</em> to apply changes to produced strings, such as checksums and identifiers.</p></li>
</ul>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">#</a></h2>
<p>With this chapter, we have powerful grammars which we can use in a number of domains:</p>
<ul class="simple">
<li><p>In the <a class="reference internal" href="APIFuzzer.html"><span class="std std-doc">chapter on fuzzing APIs</span></a>, we show how to produce complex data structures for testing, making use of <code class="docutils literal notranslate"><span class="pre">GeneratorGrammarFuzzer</span></code> features to combine grammars and generator functions.</p></li>
<li><p>In the <a class="reference internal" href="WebFuzzer.html"><span class="std std-doc">chapter on fuzzing User Interfaces</span></a>, we make use of <code class="docutils literal notranslate"><span class="pre">GeneratorGrammarFuzzer</span></code> to produce complex user interface inputs.</p></li>
</ul>
</section>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h2>
<p>For fuzzing APIs, generator functions are very common.  In the <a class="reference internal" href="APIFuzzer.html"><span class="std std-doc">chapter on API fuzzing</span></a>, we show how to combine them with grammars for even richer test generation.</p>
<p>The combination of generator functions and grammars is mostly possible because we define and make use of grammars in an all-Python environment.  We are not aware of another grammar-based fuzzing system that exhibits similar features.</p>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<section id="exercise-1-tree-processing">
<h3>Exercise 1: Tree Processing<a class="headerlink" href="#exercise-1-tree-processing" title="Link to this heading">#</a></h3>
<p>So far, our <code class="docutils literal notranslate"><span class="pre">pre</span></code> and <code class="docutils literal notranslate"><span class="pre">post</span></code> processing functions all accept and produce strings.  In some circumstances, however, it can be useful to access the <em>derivation trees</em> directly – for instance, to access and check some child element.</p>
<p>Your task is to extend <code class="docutils literal notranslate"><span class="pre">GeneratorGrammarFuzzer</span></code> with pre- and post-processing functions that can accept and return derivation trees.  To this end, proceed as follows:</p>
<ol class="arabic simple">
<li><p>Extend <code class="docutils literal notranslate"><span class="pre">GeneratorGrammarFuzzer</span></code> such that a function can return a derivation tree (a tuple) or a list of derivation trees, which would then replace subtrees in the same way as strings.</p></li>
<li><p>Extend <code class="docutils literal notranslate"><span class="pre">GeneratorGrammarFuzzer</span></code> with a <code class="docutils literal notranslate"><span class="pre">post_tree</span></code> attribute which takes a function just like <code class="docutils literal notranslate"><span class="pre">post</span></code>, except that its arguments would be derivation trees.</p></li>
</ol>
<p><strong>Solution.</strong> Left to the reader at this point.</p>
</section>
<section id="exercise-2-attribute-grammars">
<h3>Exercise 2: Attribute Grammars<a class="headerlink" href="#exercise-2-attribute-grammars" title="Link to this heading">#</a></h3>
<p>Set up a mechanism through which it is possible to attach arbitrary <em>attributes</em> to individual elements in the derivation tree.  Expansion functions could attach such attributes to individual symbols (say, by returning <code class="docutils literal notranslate"><span class="pre">opts()</span></code>), and also access attributes of symbols in later calls.  Here is an example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ATTR_GRAMMAR</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;clause&gt;&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;&lt;xml-open&gt;Text&lt;xml-close&gt;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">x1</span><span class="o">.</span><span class="n">name</span><span class="p">]))],</span>
    <span class="s2">&quot;&lt;xml-open&gt;&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;&lt;&lt;tag&gt;&gt;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tag</span><span class="p">:</span> <span class="n">opts</span><span class="p">(</span><span class="n">name</span><span class="o">=...</span><span class="p">)))],</span>
    <span class="s2">&quot;&lt;xml-close&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;/&lt;tag&gt;&gt;&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Solution.</strong> Left to the reader at this point.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="ProbabilisticGrammarFuzzer.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Probabilistic Grammar Fuzzing</p>
      </div>
    </a>
    <a class="right-next"
       href="GreyboxGrammarFuzzer.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Greybox Fuzzing with Grammars</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Fuzzing with Generators</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-test-a-credit-card-system">Example: Test a Credit Card System</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#attaching-functions-to-expansions">Attaching Functions to Expansions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#functions-called-before-expansion">Functions Called Before Expansion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#functions-called-after-expansion">Functions Called After Expansion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-class-for-integrating-constraints">A Class for Integrating Constraints</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-elements-before-expansion">Generating Elements before Expansion</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-numeric-ranges">Example: Numeric Ranges</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-more-numeric-ranges">Example: More Numeric Ranges</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#support-for-python-generators">Support for Python Generators</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-and-repairing-elements-after-expansion">Checking and Repairing Elements after Expansion</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-negative-expressions">Example: Negative Expressions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-matching-xml-tags">Example: Matching XML Tags</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-checksums">Example: Checksums</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#local-checking-and-repairing">Local Checking and Repairing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#definitions-and-uses">Definitions and Uses</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ordering-expansions">Ordering Expansions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#all-together">All Together</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generators-and-probabilistic-fuzzing">Generators and Probabilistic Fuzzing</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#generators-and-grammar-coverage">Generators and Grammar Coverage</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-tree-processing">Exercise 1: Tree Processing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-attribute-grammars">Exercise 2: Attribute Grammars</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Andreas Zeller, Rahul Gopinath, Marcel Böhme, Gordon Fraser, and Christian Holler
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <div>
  Copyright &copy; 2021–2025 <a href="https://www.cispa.de/">CISPA Helmholtz Center for Information Security</a>. Copyright &copy; 2018-2020 <a href="https://www.uni-saarland.de/">Saarland University</a>. Copyright &copy; 2018-2025 external contributors.
  The <strong>content</strong> of this project is licensed under the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
  The <strong>source code</strong> that is part of the content, as well as the source code used to format and display that content is licensed under the <a href="https://github.com/uds-se/fuzzingbook/blob/master/LICENSE.md#mit-license">MIT License</a>.
  <br>
  <a href="https://cispa.de/en/impressum">Imprint</a> &middot; <a href="/html/index.html#how-do-i-cite-your-work">Cite</a>
</div>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>