
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Code Coverage &#8212; The Fuzzing Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=42e1b1a5" />
    <link rel="stylesheet" type="text/css" href="_static/mastodon-timeline.css?v=f82c2b23" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Coverage';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Mutation-Based Fuzzing" href="MutationFuzzer.html" />
    <link rel="prev" title="Fuzzing: Breaking Things with Random Inputs" href="Fuzzer.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content"><p>This is a beta version of fuzzingbook.org, currently in development. See the <a href="https://fuzzingbook.org/classic/"  style="color:white!important;">classic site</a> for the 2024 version.</p></div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/fuzzingbook.png" class="logo__image only-light" alt="The Fuzzing Book - Home"/>
    <script>document.write(`<img src="_static/fuzzingbook.png" class="logo__image only-dark" alt="The Fuzzing Book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    The Fuzzing Book
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tours.html">Sitemap</a></li>
<li class="toctree-l1"><a class="reference internal" href="Intro_Testing.html">Introduction to Software Testing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Lexical Fuzzing</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Fuzzer.html">Fuzzing: Breaking Things with Random Inputs</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Code Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="MutationFuzzer.html">Mutation-Based Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GreyboxFuzzer.html">Greybox Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="SearchBasedFuzzer.html">Search-Based Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="MutationAnalysis.html">Mutation Analysis</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Syntactical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Grammars.html">Fuzzing with Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarFuzzer.html">Efficient Grammar Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarCoverageFuzzer.html">Grammar Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="Parser.html">Parsing Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ProbabilisticGrammarFuzzer.html">Probabilistic Grammar Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GeneratorGrammarFuzzer.html">Fuzzing with Generators</a></li>

<li class="toctree-l1"><a class="reference internal" href="GreyboxGrammarFuzzer.html">Greybox Fuzzing with Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="Reducer.html">Reducing Failure-Inducing Inputs</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Semantical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="FuzzingWithConstraints.html">Fuzzing with Constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarMiner.html">Mining Input Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="InformationFlow.html">Tracking Information Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="ConcolicFuzzer.html">Concolic Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="SymbolicFuzzer.html">Symbolic Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="DynamicInvariants.html">Mining Function Specifications</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Domain-Specific Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ConfigurationFuzzer.html">Testing Configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="APIFuzzer.html">Fuzzing APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Carver.html">Carving Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="PythonFuzzer.html">Testing Compilers</a></li>
<li class="toctree-l1"><a class="reference internal" href="WebFuzzer.html">Testing Web Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="GUIFuzzer.html">Testing Graphical User Interfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Managing Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="FuzzingInTheLarge.html">Fuzzing in the Large</a></li>
<li class="toctree-l1"><a class="reference internal" href="WhenToStopFuzzing.html">When To Stop Fuzzing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Essays</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="AcademicPrototyping.html">Academic Prototyping</a></li>
<li class="toctree-l1"><a class="reference internal" href="PrototypingWithPython.html">Prototyping with Python</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ExpectError.html">Error Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timer.html">Timer</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timeout.html">Timeout</a></li>
<li class="toctree-l1"><a class="reference internal" href="ClassDiagram.html">Class Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="RailroadDiagrams.html">Railroad Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="ControlFlow.html">Control Flow Graph</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About This Book</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ReleaseNotes.html">Fuzzingbook Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="Importing.html">Downloads and Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="Guide_for_Authors.html">Guide for Authors</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/master?urlpath=tree/docs/notebooks/Coverage.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/uds-se/fuzzingbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/uds-se/fuzzingbook/issues/new?title=Issue%20on%20page%20%2FCoverage.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
    <li><a href="../code/Coverage.py" target="_blank"
       class="btn btn-sm btn-download-source-button dropdown-item"
       title="Download Python code"
       data-bs-placement="left" data-bs-toggle="tooltip"
    >
  

    <span class="btn__icon-container">
      <i class="fas fa-file"></i>
      </span>
    <span class="btn__text-container">.py</span>
    </a>
    </li>
    
      
      
      
      <li><a href="_sources/Coverage.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download notebook"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  
    <li><a href="Importing.html" target="_blank"
       class="btn btn-sm btn-download-source-button dropdown-item"
       title="All downloads"
       data-bs-placement="left" data-bs-toggle="tooltip"
    >
  

    <span class="btn__icon-container">
      <i class="fas fa-file"></i>
      </span>
    <span class="btn__text-container">All downloads</span>
    </a>
    </li>
    </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Code Coverage</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-cgi-decoder">A CGI Decoder</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#black-box-testing">Black-Box Testing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#white-box-testing">White-Box Testing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tracing-executions">Tracing Executions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-coverage-class">A Coverage Class</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-coverage">Comparing Coverage</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#coverage-of-basic-fuzzing">Coverage of Basic Fuzzing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-coverage-from-external-programs">Getting Coverage from External Programs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#finding-errors-with-basic-fuzzing">Finding Errors with Basic Fuzzing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-fixing-cgi-decode">Exercise 1: Fixing <code class="docutils literal notranslate"><span class="pre">cgi_decode()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-branch-coverage">Exercise 2: Branch Coverage</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-compute-branch-coverage">Part 1: Compute branch coverage</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-comparing-statement-coverage-and-branch-coverage">Part 2: Comparing statement coverage and branch coverage</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3-average-coverage">Part 3: Average coverage</a></li>
</ul>
</li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="code-coverage">
<h1>Code Coverage<a class="headerlink" href="#code-coverage" title="Link to this heading">#</a></h1>
<p>In the <a class="reference internal" href="Fuzzer.html"><span class="std std-doc">previous chapter</span></a>, we introduced <em>basic fuzzing</em> – that is, generating random inputs to test programs.  How do we measure the effectiveness of these tests?  One way would be to check the number (and seriousness) of bugs found; but if bugs are scarce, we need a <em>proxy for the likelihood of a test to uncover a bug.</em>  In this chapter, we introduce the concept of <em>code coverage</em>, measuring which parts of a program are actually executed during a test run.  Measuring such coverage is also crucial for test generators that attempt to cover as much code as possible.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">YouTubeVideo</span>
<span class="n">YouTubeVideo</span><span class="p">(</span><span class="s1">&#39;8HxW8j9287A&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="640"
            height="360"
            src="https://www.youtube-nocookie.com/embed/8HxW8j9287A"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<p><strong>Prerequisites</strong></p>
<ul class="simple">
<li><p>You need some understanding of how a program is executed.</p></li>
<li><p>You should have learned about basic fuzzing in the <a class="reference internal" href="Fuzzer.html"><span class="std std-doc">previous chapter</span></a>.</p></li>
</ul>
<section id="synopsis">
<h2>Synopsis<a class="headerlink" href="#synopsis" title="Link to this heading">#</a></h2>
<p>To <a class="reference internal" href="Importing.html"><span class="std std-doc">use the code provided in this chapter</span></a>, write</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">fuzzingbook.Coverage</span><span class="w"> </span><span class="kn">import</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>and then make use of the following features.</p>
<p><strong>Note</strong>: The examples in this section only work after the rest of the cells have been executed.</p>
<p>The typical usage of the <code class="docutils literal notranslate"><span class="pre">Coverage</span></code> class is in conjunction with a <code class="docutils literal notranslate"><span class="pre">with</span></code> clause:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Coverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov</span><span class="p">:</span>
    <span class="n">cgi_decode</span><span class="p">(</span><span class="s2">&quot;a+b&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Printing out a coverage object shows the covered functions, with non-covered lines prefixed with <code class="docutils literal notranslate"><span class="pre">#</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>#  1  def cgi_decode(s: str) -&gt; str:
#  2      &quot;&quot;&quot;Decode the CGI-encoded string `s`:
#  3         * replace &#39;+&#39; by &#39; &#39;
#  4         * replace &quot;%xx&quot; by the character with hex number xx.
#  5         Return the decoded string.  Raise `ValueError` for invalid inputs.&quot;&quot;&quot;
#  6  
#  7      # Mapping of hex digits to their integer values
   8      hex_values = {
   9          &#39;0&#39;: 0, &#39;1&#39;: 1, &#39;2&#39;: 2, &#39;3&#39;: 3, &#39;4&#39;: 4,
  10          &#39;5&#39;: 5, &#39;6&#39;: 6, &#39;7&#39;: 7, &#39;8&#39;: 8, &#39;9&#39;: 9,
  11          &#39;a&#39;: 10, &#39;b&#39;: 11, &#39;c&#39;: 12, &#39;d&#39;: 13, &#39;e&#39;: 14, &#39;f&#39;: 15,
  12          &#39;A&#39;: 10, &#39;B&#39;: 11, &#39;C&#39;: 12, &#39;D&#39;: 13, &#39;E&#39;: 14, &#39;F&#39;: 15,
# 13      }
# 14  
  15      t = &quot;&quot;
  16      i = 0
  17      while i &lt; len(s):
  18          c = s[i]
  19          if c == &#39;+&#39;:
  20              t += &#39; &#39;
  21          elif c == &#39;%&#39;:
# 22              digit_high, digit_low = s[i + 1], s[i + 2]
# 23              i += 2
# 24              if digit_high in hex_values and digit_low in hex_values:
# 25                  v = hex_values[digit_high] * 16 + hex_values[digit_low]
# 26                  t += chr(v)
# 27              else:
# 28                  raise ValueError(&quot;Invalid encoding&quot;)
# 29          else:
  30              t += c
  31          i += 1
  32      return t
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">trace()</span></code> method returns the <em>trace</em> – that is, the list of locations executed in order. Each location comes as a pair (<code class="docutils literal notranslate"><span class="pre">function</span> <span class="pre">name</span></code>, <code class="docutils literal notranslate"><span class="pre">line</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cov</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39;cgi_decode&#39;, 8),
 (&#39;cgi_decode&#39;, 9),
 (&#39;cgi_decode&#39;, 8),
 (&#39;cgi_decode&#39;, 9),
 (&#39;cgi_decode&#39;, 8),
 (&#39;cgi_decode&#39;, 9),
 (&#39;cgi_decode&#39;, 8),
 (&#39;cgi_decode&#39;, 9),
 (&#39;cgi_decode&#39;, 8),
 (&#39;cgi_decode&#39;, 9),
 (&#39;cgi_decode&#39;, 8),
 (&#39;cgi_decode&#39;, 10),
 (&#39;cgi_decode&#39;, 8),
 (&#39;cgi_decode&#39;, 10),
 (&#39;cgi_decode&#39;, 8),
 (&#39;cgi_decode&#39;, 10),
 (&#39;cgi_decode&#39;, 8),
 (&#39;cgi_decode&#39;, 10),
 (&#39;cgi_decode&#39;, 8),
 (&#39;cgi_decode&#39;, 10),
 (&#39;cgi_decode&#39;, 8),
 (&#39;cgi_decode&#39;, 11),
 (&#39;cgi_decode&#39;, 8),
 (&#39;cgi_decode&#39;, 11),
 (&#39;cgi_decode&#39;, 8),
 (&#39;cgi_decode&#39;, 11),
 (&#39;cgi_decode&#39;, 8),
 (&#39;cgi_decode&#39;, 11),
 (&#39;cgi_decode&#39;, 8),
 (&#39;cgi_decode&#39;, 11),
 (&#39;cgi_decode&#39;, 8),
 (&#39;cgi_decode&#39;, 11),
 (&#39;cgi_decode&#39;, 8),
 (&#39;cgi_decode&#39;, 12),
 (&#39;cgi_decode&#39;, 8),
 (&#39;cgi_decode&#39;, 12),
 (&#39;cgi_decode&#39;, 8),
 (&#39;cgi_decode&#39;, 15),
 (&#39;cgi_decode&#39;, 16),
 (&#39;cgi_decode&#39;, 17),
 (&#39;cgi_decode&#39;, 18),
 (&#39;cgi_decode&#39;, 19),
 (&#39;cgi_decode&#39;, 21),
 (&#39;cgi_decode&#39;, 30),
 (&#39;cgi_decode&#39;, 31),
 (&#39;cgi_decode&#39;, 17),
 (&#39;cgi_decode&#39;, 18),
 (&#39;cgi_decode&#39;, 19),
 (&#39;cgi_decode&#39;, 20),
 (&#39;cgi_decode&#39;, 31),
 (&#39;cgi_decode&#39;, 17),
 (&#39;cgi_decode&#39;, 18),
 (&#39;cgi_decode&#39;, 19),
 (&#39;cgi_decode&#39;, 21),
 (&#39;cgi_decode&#39;, 30),
 (&#39;cgi_decode&#39;, 31),
 (&#39;cgi_decode&#39;, 17),
 (&#39;cgi_decode&#39;, 32)]
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">coverage()</span></code> method returns the <em>coverage</em>, that is, the set of locations in the trace executed at least once:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cov</span><span class="o">.</span><span class="n">coverage</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{(&#39;cgi_decode&#39;, 8),
 (&#39;cgi_decode&#39;, 9),
 (&#39;cgi_decode&#39;, 10),
 (&#39;cgi_decode&#39;, 11),
 (&#39;cgi_decode&#39;, 12),
 (&#39;cgi_decode&#39;, 15),
 (&#39;cgi_decode&#39;, 16),
 (&#39;cgi_decode&#39;, 17),
 (&#39;cgi_decode&#39;, 18),
 (&#39;cgi_decode&#39;, 19),
 (&#39;cgi_decode&#39;, 20),
 (&#39;cgi_decode&#39;, 21),
 (&#39;cgi_decode&#39;, 30),
 (&#39;cgi_decode&#39;, 31),
 (&#39;cgi_decode&#39;, 32)}
</pre></div>
</div>
</div>
</div>
<p>Coverage sets can be subject to set operations, such as <em>intersection</em> (which locations are covered in multiple executions) and <em>difference</em> (which locations are covered in run <em>a</em>, but not <em>b</em>).</p>
<p>The chapter also discusses how to obtain such coverage from C programs.</p>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_html"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 13.1.2 (20250808.2320)
 -->
<!-- Pages: 1 -->
<svg width="258pt" height="145pt"
 viewBox="0.00 0.00 258.00 145.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 141)">
<g id="a_graph0"><a xlink:title="Coverage class hierarchy">
<polygon fill="white" stroke="none" points="-4,4 -4,-141 253.62,-141 253.62,4 -4,4"/>
</a>
</g>
<!-- Coverage -->
<g id="node1" class="node">
<title>Coverage</title>
<g id="a_node1"><a xlink:href="#" xlink:title="class Coverage:&#10;Track coverage within a `with` block. Use as&#10;```&#10;with Coverage() as cov:&#10;function_to_be_traced()&#10;c = cov.coverage()&#10;```">
<polygon fill="none" stroke="black" points="0,-0.5 0,-136.5 112,-136.5 112,-0.5 0,-0.5"/>
<text xml:space="preserve" text-anchor="start" x="27.12" y="-120.2" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">Coverage</text>
<polyline fill="none" stroke="black" points="0,-110.5 112,-110.5"/>
<g id="a_node1_0"><a xlink:href="#" xlink:title="Coverage">
<g id="a_node1_1"><a xlink:href="#" xlink:title="__enter__(self) &#45;&gt; Any:&#10;Start of `with` block. Turn on tracing.">
<text xml:space="preserve" text-anchor="start" x="8" y="-98" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__enter__()</text>
</a>
</g>
<g id="a_node1_2"><a xlink:href="#" xlink:title="__exit__(self, exc_type: Type, exc_value: BaseException, tb: traceback) &#45;&gt; Optional[bool]:&#10;End of `with` block. Turn off tracing.">
<text xml:space="preserve" text-anchor="start" x="8" y="-85.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__exit__()</text>
</a>
</g>
<g id="a_node1_3"><a xlink:href="#" xlink:title="__init__(self) &#45;&gt; None:&#10;Constructor">
<text xml:space="preserve" text-anchor="start" x="8" y="-72.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node1_4"><a xlink:href="#" xlink:title="__repr__(self) &#45;&gt; str:&#10;Return a string representation of this object.&#10;Show covered (and uncovered) program code">
<text xml:space="preserve" text-anchor="start" x="8" y="-59.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__repr__()</text>
</a>
</g>
<g id="a_node1_5"><a xlink:href="#" xlink:title="coverage(self) &#45;&gt; Set[Location]:&#10;The set of executed lines, as (function_name, line_number) pairs">
<text xml:space="preserve" text-anchor="start" x="8" y="-47" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">coverage()</text>
</a>
</g>
<g id="a_node1_6"><a xlink:href="#" xlink:title="function_names(self) &#45;&gt; Set[str]:&#10;The set of function names seen">
<text xml:space="preserve" text-anchor="start" x="8" y="-34.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">function_names()</text>
</a>
</g>
<g id="a_node1_7"><a xlink:href="#" xlink:title="trace(self) &#45;&gt; List[Location]:&#10;The list of executed lines, as (function_name, line_number) pairs">
<text xml:space="preserve" text-anchor="start" x="8" y="-21.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">trace()</text>
</a>
</g>
<g id="a_node1_8"><a xlink:href="#" xlink:title="traceit(self, frame: frame, event: str, arg: Any) &#45;&gt; Optional[Callable]:&#10;Tracing function. To be overloaded in subclasses.">
<text xml:space="preserve" text-anchor="start" x="8" y="-8.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">traceit()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- Legend -->
<g id="node2" class="node">
<title>Legend</title>
<text xml:space="preserve" text-anchor="start" x="130.38" y="-84.5" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="10.00" fill="#b03a2e">Legend</text>
<text xml:space="preserve" text-anchor="start" x="130.38" y="-74.5" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text xml:space="preserve" text-anchor="start" x="136.38" y="-74.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="8.00">public_method()</text>
<text xml:space="preserve" text-anchor="start" x="130.38" y="-64.5" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text xml:space="preserve" text-anchor="start" x="136.38" y="-64.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="8.00">private_method()</text>
<text xml:space="preserve" text-anchor="start" x="130.38" y="-54.5" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text xml:space="preserve" text-anchor="start" x="136.38" y="-54.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="8.00">overloaded_method()</text>
<text xml:space="preserve" text-anchor="start" x="130.38" y="-45.45" font-family="Helvetica,sans-Serif" font-size="9.00">Hover over names to see doc</text>
</g>
</g>
</svg>
</div></div>
</div>
</section>
<section id="a-cgi-decoder">
<h2>A CGI Decoder<a class="headerlink" href="#a-cgi-decoder" title="Link to this heading">#</a></h2>
<p>We start by introducing a simple Python function that decodes a CGI-encoded string.  CGI encoding is used in URLs (i.e., Web addresses) to encode characters that would be invalid in a URL, such as blanks and certain punctuation:</p>
<ul class="simple">
<li><p>Blanks are replaced by <code class="docutils literal notranslate"><span class="pre">'+'</span></code></p></li>
<li><p>Other invalid characters are replaced by ‘<code class="docutils literal notranslate"><span class="pre">%xx</span></code>’, where <code class="docutils literal notranslate"><span class="pre">xx</span></code> is the two-digit hexadecimal equivalent.</p></li>
</ul>
<p>In CGI encoding, the string <code class="docutils literal notranslate"><span class="pre">&quot;Hello,</span> <span class="pre">world!&quot;</span></code> would thus become <code class="docutils literal notranslate"><span class="pre">&quot;Hello%2c+world%21&quot;</span></code> where <code class="docutils literal notranslate"><span class="pre">2c</span></code> and <code class="docutils literal notranslate"><span class="pre">21</span></code> are the hexadecimal equivalents of <code class="docutils literal notranslate"><span class="pre">','</span></code> and <code class="docutils literal notranslate"><span class="pre">'!'</span></code>, respectively.</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">cgi_decode()</span></code> takes such an encoded string and decodes it back to its original form.  Our implementation replicates the code from \cite{Pezze2008}.  (It even includes its bugs – but we won’t reveal them at this point.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">cgi_decode</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decode the CGI-encoded string `s`:</span>
<span class="sd">       * replace &#39;+&#39; by &#39; &#39;</span>
<span class="sd">       * replace &quot;%xx&quot; by the character with hex number xx.</span>
<span class="sd">       Return the decoded string.  Raise `ValueError` for invalid inputs.&quot;&quot;&quot;</span>

    <span class="c1"># Mapping of hex digits to their integer values</span>
    <span class="n">hex_values</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;0&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
        <span class="s1">&#39;5&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;8&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
        <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
        <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;%&#39;</span><span class="p">:</span>
            <span class="n">digit_high</span><span class="p">,</span> <span class="n">digit_low</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">digit_high</span> <span class="ow">in</span> <span class="n">hex_values</span> <span class="ow">and</span> <span class="n">digit_low</span> <span class="ow">in</span> <span class="n">hex_values</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">hex_values</span><span class="p">[</span><span class="n">digit_high</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">hex_values</span><span class="p">[</span><span class="n">digit_low</span><span class="p">]</span>
                <span class="n">t</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid encoding&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">c</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">t</span>
</pre></div>
</div>
</div>
</div>
<p>Here is an example of how <code class="docutils literal notranslate"><span class="pre">cgi_decode()</span></code> works:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cgi_decode</span><span class="p">(</span><span class="s2">&quot;Hello+world&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Hello world&#39;
</pre></div>
</div>
</div>
</div>
<p>If we want to systematically test <code class="docutils literal notranslate"><span class="pre">cgi_decode()</span></code>, how would we proceed?</p>
<p>The testing literature distinguishes two ways of deriving tests: <em>Black-box testing</em> and <em>White-box testing.</em></p>
</section>
<section id="black-box-testing">
<h2>Black-Box Testing<a class="headerlink" href="#black-box-testing" title="Link to this heading">#</a></h2>
<p>The idea of <em>black-box testing</em> is to derive tests from the <em>specification</em>.  In the above case, we thus would have to test <code class="docutils literal notranslate"><span class="pre">cgi_decode()</span></code> by the features specified and documented, including</p>
<ul class="simple">
<li><p>testing for correct replacement of <code class="docutils literal notranslate"><span class="pre">'+'</span></code>;</p></li>
<li><p>testing for correct replacement of <code class="docutils literal notranslate"><span class="pre">&quot;%xx&quot;</span></code>;</p></li>
<li><p>testing for non-replacement of other characters; and</p></li>
<li><p>testing for recognition of illegal inputs.</p></li>
</ul>
<p>Here are four assertions (tests) that cover these four features.  We can see that they all pass:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">cgi_decode</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39; &#39;</span>
<span class="k">assert</span> <span class="n">cgi_decode</span><span class="p">(</span><span class="s1">&#39;%20&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39; &#39;</span>
<span class="k">assert</span> <span class="n">cgi_decode</span><span class="p">(</span><span class="s1">&#39;abc&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;abc&#39;</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">cgi_decode</span><span class="p">(</span><span class="s1">&#39;%?a&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="kc">False</span>
<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<p>The advantage of black-box testing is that it finds errors in the <em>specified</em> behavior.  It is independent of a given implementation, and thus allows creating tests even before implementation.  The downside is that <em>implemented</em> behavior typically covers more ground than <em>specified</em> behavior, and thus tests based on specification alone typically do not cover all implementation details.</p>
</section>
<section id="white-box-testing">
<h2>White-Box Testing<a class="headerlink" href="#white-box-testing" title="Link to this heading">#</a></h2>
<p>In contrast to black-box testing, <em>white-box testing</em> derives tests from the <em>implementation</em>, notably the internal structure.  White-Box testing is closely tied to the concept of <em>covering</em> structural features of the code.  If a statement in the code is not executed during testing, for instance, this means that an error in this statement cannot be triggered either.  White-Box testing thus introduces a number of <em>coverage criteria</em> that have to be fulfilled before the test can be said to be sufficient.  The most frequently used coverage criteria are</p>
<ul class="simple">
<li><p><em>Statement coverage</em> – each statement in the code must be executed by at least one test input.</p></li>
<li><p><em>Branch coverage</em> – each branch in the code must be taken by at least one test input.  (This translates to each <code class="docutils literal notranslate"><span class="pre">if</span></code> and <code class="docutils literal notranslate"><span class="pre">while</span></code> decision once being true, and once being false.)</p></li>
</ul>
<p>Besides these, there are far more coverage criteria, including sequences of branches taken, loop iterations taken (zero, one, many), data flows between variable definitions and usages, and many more; \cite{Pezze2008} has a great overview.</p>
<p>Let us consider <code class="docutils literal notranslate"><span class="pre">cgi_decode()</span></code>, above, and reason what we have to do such that each statement of the code is executed at least once.  We’d have to cover</p>
<ul class="simple">
<li><p>The block following <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">c</span> <span class="pre">==</span> <span class="pre">'+'</span></code></p></li>
<li><p>The two blocks following <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">c</span> <span class="pre">==</span> <span class="pre">'%'</span></code> (one for valid input, one for invalid)</p></li>
<li><p>The final <code class="docutils literal notranslate"><span class="pre">else</span></code> case for all other characters.</p></li>
</ul>
<p>This results in the same conditions as with black-box testing, above; again, the assertions above indeed would cover every statement in the code.  Such a correspondence is actually pretty common, since programmers tend to implement different behaviors in different code locations; and thus, covering these locations will lead to test cases that cover the different (specified) behaviors.</p>
<p>The advantage of white-box testing is that it finds errors in <em>implemented</em> behavior.  It can be conducted even in cases where the specification does not provide sufficient details; actually, it helps in identifying (and thus specifying) corner cases in the specification.  The downside is that it may miss <em>non-implemented</em> behavior: If some specified functionality is missing, white-box testing will not find it.</p>
</section>
<section id="tracing-executions">
<h2>Tracing Executions<a class="headerlink" href="#tracing-executions" title="Link to this heading">#</a></h2>
<p>One nice feature of white-box testing is that one can actually automatically assess whether some program feature was covered.  To this end, one <em>instruments</em> the execution of the program such that during execution, a special functionality keeps track of which code was executed.  After testing, this information can be passed to the programmer, who can then focus on writing tests that cover the yet uncovered code.</p>
<p>In most programming languages, it is rather difficult to set up programs such that one can trace their execution.  Not so in Python.  The function <code class="docutils literal notranslate"><span class="pre">sys.settrace(f)</span></code> allows defining a <em>tracing function</em> <code class="docutils literal notranslate"><span class="pre">f()</span></code> that is called for each and every line executed.  Even better, it gets access to the current function and its name, current variable contents, and more.  It is thus an ideal tool for <em>dynamic analysis</em> – that is, the analysis of what actually happens during an execution.</p>
<p>To illustrate how this works, let us again look into a specific execution of <code class="docutils literal notranslate"><span class="pre">cgi_decode()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cgi_decode</span><span class="p">(</span><span class="s2">&quot;a+b&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;a b&#39;
</pre></div>
</div>
</div>
</div>
<p>To track how the execution proceeds through <code class="docutils literal notranslate"><span class="pre">cgi_decode()</span></code>, we make use of <code class="docutils literal notranslate"><span class="pre">sys.settrace()</span></code>.  First, we define the <em>tracing function</em> that will be called for each line.  It has three parameters:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">frame</span></code> parameter gets you the current <em>frame</em>, allowing access to the current location and variables:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">frame.f_code</span></code> is the currently executed code with <code class="docutils literal notranslate"><span class="pre">frame.f_code.co_name</span></code> being the function name;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">frame.f_lineno</span></code> holds the current line number; and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">frame.f_locals</span></code> holds the current local variables and arguments.</p></li>
</ul>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">event</span></code> parameter is a string with values including <code class="docutils literal notranslate"><span class="pre">&quot;line&quot;</span></code> (a new line has been reached) or <code class="docutils literal notranslate"><span class="pre">&quot;call&quot;</span></code> (a function is being called).</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">arg</span></code> parameter is an additional <em>argument</em> for some events; for <code class="docutils literal notranslate"><span class="pre">&quot;return&quot;</span></code> events, for instance, <code class="docutils literal notranslate"><span class="pre">arg</span></code> holds the value being returned.</p></li>
</ul>
<p>We use the tracing function for simply reporting the current line executed, which we access through the <code class="docutils literal notranslate"><span class="pre">frame</span></code> argument.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">types</span><span class="w"> </span><span class="kn">import</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">TracebackType</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coverage</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">traceit</span><span class="p">(</span><span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Trace program execution. To be passed to sys.settrace().&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>
        <span class="k">global</span> <span class="n">coverage</span>
        <span class="n">function_name</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
        <span class="n">lineno</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span>
        <span class="n">coverage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lineno</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">traceit</span>
</pre></div>
</div>
</div>
</div>
<p>We can switch tracing on and off with <code class="docutils literal notranslate"><span class="pre">sys.settrace()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">cgi_decode_traced</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">coverage</span>
    <span class="n">coverage</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="n">traceit</span><span class="p">)</span>  <span class="c1"># Turn on</span>
    <span class="n">cgi_decode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>    <span class="c1"># Turn off</span>
</pre></div>
</div>
</div>
</div>
<p>When we compute <code class="docutils literal notranslate"><span class="pre">cgi_decode(&quot;a+b&quot;)</span></code>, we can now see how the execution progresses through <code class="docutils literal notranslate"><span class="pre">cgi_decode()</span></code>.  After the initialization of <code class="docutils literal notranslate"><span class="pre">hex_values</span></code>, <code class="docutils literal notranslate"><span class="pre">t</span></code>, and <code class="docutils literal notranslate"><span class="pre">i</span></code>, we see that the <code class="docutils literal notranslate"><span class="pre">while</span></code> loop is taken three times – one for every character in the input.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cgi_decode_traced</span><span class="p">(</span><span class="s2">&quot;a+b&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coverage</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[8, 9, 8, 9, 8, 9, 8, 9, 8, 9, 8, 10, 8, 10, 8, 10, 8, 10, 8, 10, 8, 11, 8, 11, 8, 11, 8, 11, 8, 11, 8, 11, 8, 12, 8, 12, 8, 15, 16, 17, 18, 19, 21, 30, 31, 17, 18, 19, 20, 31, 17, 18, 19, 21, 30, 31, 17, 32]
</pre></div>
</div>
</div>
</div>
<p>Which lines are these, actually?  To this end, we get the source code of <code class="docutils literal notranslate"><span class="pre">cgi_decode_code</span></code> and encode it into an array <code class="docutils literal notranslate"><span class="pre">cgi_decode_lines</span></code>, which we will then annotate with coverage information.  First, let us get the source code of <code class="docutils literal notranslate"><span class="pre">cgi_encode</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cgi_decode_code</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">cgi_decode</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">cgi_decode_code</span></code> is a string holding the source code.  We can print it out with Python syntax highlighting:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_content</span><span class="p">,</span> <span class="n">print_file</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_content</span><span class="p">(</span><span class="n">cgi_decode_code</span><span class="p">[:</span><span class="mi">300</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span><span class="p">,</span> <span class="s2">&quot;.py&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">cgi_decode</span>(s: <span class=" -Color -Color-Cyan">str</span>) -&gt; <span class=" -Color -Color-Cyan">str</span>:
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Yellow">&quot;&quot;&quot;Decode the CGI-encoded string `s`:</span>
<span class=" -Color -Color-Yellow">       * replace &#39;+&#39; by &#39; &#39;</span>
<span class=" -Color -Color-Yellow">       * replace &quot;%xx&quot; by the character with hex number xx.</span>
<span class=" -Color -Color-Yellow">       Return the decoded string.  Raise `ValueError` for invalid inputs.&quot;&quot;&quot;</span>

    <span class=" -Color -Color-White"># Mapping of hex digits to their integer values</span>
    hex_v...
</pre></div>
</div>
</div>
</div>
<p>Using <code class="docutils literal notranslate"><span class="pre">splitlines()</span></code>, we split the code into an array of lines, indexed by line number.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cgi_decode_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cgi_decode_code</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">cgi_decode_lines[L]</span></code> is line L of the source code.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cgi_decode_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;def cgi_decode(s: str) -&gt; str:&#39;
</pre></div>
</div>
</div>
</div>
<p>We see that the first line (9) executed is actually the initialization of <code class="docutils literal notranslate"><span class="pre">hex_values</span></code>…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cgi_decode_lines</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">13</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&quot;        &#39;0&#39;: 0, &#39;1&#39;: 1, &#39;2&#39;: 2, &#39;3&#39;: 3, &#39;4&#39;: 4,&quot;,
 &quot;        &#39;5&#39;: 5, &#39;6&#39;: 6, &#39;7&#39;: 7, &#39;8&#39;: 8, &#39;9&#39;: 9,&quot;,
 &quot;        &#39;a&#39;: 10, &#39;b&#39;: 11, &#39;c&#39;: 12, &#39;d&#39;: 13, &#39;e&#39;: 14, &#39;f&#39;: 15,&quot;,
 &quot;        &#39;A&#39;: 10, &#39;B&#39;: 11, &#39;C&#39;: 12, &#39;D&#39;: 13, &#39;E&#39;: 14, &#39;F&#39;: 15,&quot;]
</pre></div>
</div>
</div>
</div>
<p>… followed by the initialization of <code class="docutils literal notranslate"><span class="pre">t</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cgi_decode_lines</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;    t = &quot;&quot;&#39;
</pre></div>
</div>
</div>
</div>
<p>To see which lines actually have been covered at least once, we can convert <code class="docutils literal notranslate"><span class="pre">coverage</span></code> into a set:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">covered_lines</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">coverage</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">covered_lines</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{32, 8, 9, 10, 11, 12, 15, 16, 17, 18, 19, 20, 21, 30, 31}
</pre></div>
</div>
</div>
</div>
<p>Let us print out the full code, annotating lines not covered with <code class="docutils literal notranslate"><span class="pre">#</span></code>.
The idea of such an annotation is to direct developer’s attention to the non-covered lines.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">lineno</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cgi_decode_lines</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">lineno</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">covered_lines</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%2d</span><span class="s2">  &quot;</span> <span class="o">%</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">print_content</span><span class="p">(</span><span class="n">cgi_decode_lines</span><span class="p">[</span><span class="n">lineno</span><span class="p">],</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>#  1  <span class=" -Color -Color-Blue">def</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">cgi_decode</span>(s: <span class=" -Color -Color-Cyan">str</span>) -&gt; <span class=" -Color -Color-Cyan">str</span>:
#  2      <span class=" -Color -Color-Yellow">&quot;&quot;&quot;Decode the CGI-encoded string `s`:</span>
#  3         * replace <span class=" -Color -Color-Yellow">&#39;+&#39;</span> by <span class=" -Color -Color-Yellow">&#39; &#39;</span>
#  4         * replace <span class=" -Color -Color-Yellow">&quot;%xx&quot;</span> by the character <span class=" -Color -Color-Blue">with</span> <span class=" -Color -Color-Cyan">hex</span> number xx.
#  5         Return the decoded string.  Raise `<span class=" -Color -Color-Cyan">ValueError</span>` <span class=" -Color -Color-Blue">for</span> invalid inputs.<span class=" -Color -Color-Yellow">&quot;&quot;&quot;</span>
#  6  
#  7      <span class=" -Color -Color-White"># Mapping of hex digits to their integer values</span>
   8      hex_values = {
   9          <span class=" -Color -Color-Yellow">&#39;0&#39;</span>: <span class=" -Color -Color-Blue">0</span>, <span class=" -Color -Color-Yellow">&#39;1&#39;</span>: <span class=" -Color -Color-Blue">1</span>, <span class=" -Color -Color-Yellow">&#39;2&#39;</span>: <span class=" -Color -Color-Blue">2</span>, <span class=" -Color -Color-Yellow">&#39;3&#39;</span>: <span class=" -Color -Color-Blue">3</span>, <span class=" -Color -Color-Yellow">&#39;4&#39;</span>: <span class=" -Color -Color-Blue">4</span>,
  10          <span class=" -Color -Color-Yellow">&#39;5&#39;</span>: <span class=" -Color -Color-Blue">5</span>, <span class=" -Color -Color-Yellow">&#39;6&#39;</span>: <span class=" -Color -Color-Blue">6</span>, <span class=" -Color -Color-Yellow">&#39;7&#39;</span>: <span class=" -Color -Color-Blue">7</span>, <span class=" -Color -Color-Yellow">&#39;8&#39;</span>: <span class=" -Color -Color-Blue">8</span>, <span class=" -Color -Color-Yellow">&#39;9&#39;</span>: <span class=" -Color -Color-Blue">9</span>,
  11  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>        <span class=" -Color -Color-Yellow">&#39;a&#39;</span>: <span class=" -Color -Color-Blue">10</span>, <span class=" -Color -Color-Yellow">&#39;b&#39;</span>: <span class=" -Color -Color-Blue">11</span>, <span class=" -Color -Color-Yellow">&#39;c&#39;</span>: <span class=" -Color -Color-Blue">12</span>, <span class=" -Color -Color-Yellow">&#39;d&#39;</span>: <span class=" -Color -Color-Blue">13</span>, <span class=" -Color -Color-Yellow">&#39;e&#39;</span>: <span class=" -Color -Color-Blue">14</span>, <span class=" -Color -Color-Yellow">&#39;f&#39;</span>: <span class=" -Color -Color-Blue">15</span>,
  12          <span class=" -Color -Color-Yellow">&#39;A&#39;</span>: <span class=" -Color -Color-Blue">10</span>, <span class=" -Color -Color-Yellow">&#39;B&#39;</span>: <span class=" -Color -Color-Blue">11</span>, <span class=" -Color -Color-Yellow">&#39;C&#39;</span>: <span class=" -Color -Color-Blue">12</span>, <span class=" -Color -Color-Yellow">&#39;D&#39;</span>: <span class=" -Color -Color-Blue">13</span>, <span class=" -Color -Color-Yellow">&#39;E&#39;</span>: <span class=" -Color -Color-Blue">14</span>, <span class=" -Color -Color-Yellow">&#39;F&#39;</span>: <span class=" -Color -Color-Blue">15</span>,
# 13      }
# 14  
  15      t = <span class=" -Color -Color-Yellow">&quot;&quot;</span>
  16      i = <span class=" -Color -Color-Blue">0</span>
  17  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    <span class=" -Color -Color-Blue">while</span> i &lt; <span class=" -Color -Color-Cyan">len</span>(s):
  18          c = s[i]
  19  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>        <span class=" -Color -Color-Blue">if</span> c == <span class=" -Color -Color-Yellow">&#39;+&#39;</span>:
  20              t += <span class=" -Color -Color-Yellow">&#39; &#39;</span>
  21          <span class=" -Color -Color-Blue">elif</span> c == <span class=" -Color -Color-Yellow">&#39;%&#39;</span>:
# 22              digit_high, digit_low = s[i + <span class=" -Color -Color-Blue">1</span>], s[i + <span class=" -Color -Color-Blue">2</span>]
# 23              i += <span class=" -Color -Color-Blue">2</span>
# 24              <span class=" -Color -Color-Blue">if</span> digit_high <span class=" -Color -Color-Magenta">in</span> hex_values <span class=" -Color -Color-Magenta">and</span> digit_low <span class=" -Color -Color-Magenta">in</span> hex_values:
# 25                  v = hex_values[digit_high] * <span class=" -Color -Color-Blue">16</span> + hex_values[digit_low]
# 26                  t += <span class=" -Color -Color-Cyan">chr</span>(v)
# 27              <span class=" -Color -Color-Blue">else</span>:
# 28                  <span class=" -Color -Color-Blue">raise</span> <span class=" -Color -Color-Cyan">ValueError</span>(<span class=" -Color -Color-Yellow">&quot;Invalid encoding&quot;</span>)
# 29  
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>        <span class=" -Color -Color-Blue">else</span>:
  30              t += c
  31          i += <span class=" -Color -Color-Blue">1</span>
  32      <span class=" -Color -Color-Blue">return</span> t
</pre></div>
</div>
</div>
</div>
<p>We see that a number of lines (notably comments) have not been executed (marked with <code class="docutils literal notranslate"><span class="pre">#</span></code>), simply because they are not executable.
However, we also see that the lines under <code class="docutils literal notranslate"><span class="pre">elif</span> <span class="pre">c</span> <span class="pre">==</span> <span class="pre">'%'</span></code> have <em>not</em> been executed yet.
If <code class="docutils literal notranslate"><span class="pre">&quot;a+b&quot;</span></code> were our only test case so far, this missing coverage would now encourage us to create another test case that actually covers these <code class="docutils literal notranslate"><span class="pre">#</span></code>-marked lines.</p>
</section>
<section id="a-coverage-class">
<h2>A Coverage Class<a class="headerlink" href="#a-coverage-class" title="Link to this heading">#</a></h2>
<p>In this book, we will make use of coverage again and again – to <em>measure</em> the effectiveness of different test generation techniques, but also to <em>guide</em> test generation towards code coverage.  Our previous implementation with a global <code class="docutils literal notranslate"><span class="pre">coverage</span></code> variable is a bit cumbersome for that.  We therefore implement some functionality that will help us measure coverage easily.</p>
<p>The key idea of getting coverage is to make use of the Python <code class="docutils literal notranslate"><span class="pre">with</span></code> statement.  The general form</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">OBJECT</span> <span class="p">[</span><span class="k">as</span> <span class="n">VARIABLE</span><span class="p">]:</span>
    <span class="n">BODY</span>
</pre></div>
</div>
<p>executes <code class="docutils literal notranslate"><span class="pre">BODY</span></code> with <code class="docutils literal notranslate"><span class="pre">OBJECT</span></code> being defined (and stored in <code class="docutils literal notranslate"><span class="pre">VARIABLE</span></code>).  The interesting thing is that at the beginning and end of <code class="docutils literal notranslate"><span class="pre">BODY</span></code>, the special methods <code class="docutils literal notranslate"><span class="pre">OBJECT.__enter__()</span></code> and <code class="docutils literal notranslate"><span class="pre">OBJECT.__exit__()</span></code> are automatically invoked; even if <code class="docutils literal notranslate"><span class="pre">BODY</span></code> raises an exception.  This allows us to define a <code class="docutils literal notranslate"><span class="pre">Coverage</span></code> object where <code class="docutils literal notranslate"><span class="pre">Coverage.__enter__()</span></code> automatically turns on tracing and <code class="docutils literal notranslate"><span class="pre">Coverage.__exit__()</span></code> automatically turns off tracing again.  After tracing, we can make use of special methods to access the coverage.  This is what this looks like during usage:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Coverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov</span><span class="p">:</span>
    <span class="n">function_to_be_traced</span><span class="p">()</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">coverage</span><span class="p">()</span>
</pre></div>
</div>
<p>Here, tracing is automatically turned on during <code class="docutils literal notranslate"><span class="pre">function_to_be_traced()</span></code> and turned off again after the <code class="docutils literal notranslate"><span class="pre">with</span></code> block; afterwards, we can access the set of lines executed.</p>
<p>Here’s the full implementation with all its bells and whistles.  You don’t have to get everything; it suffices that you know how to use it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Location</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Coverage</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Track coverage within a `with` block. Use as</span>
<span class="sd">    ```</span>
<span class="sd">    with Coverage() as cov:</span>
<span class="sd">        function_to_be_traced()</span>
<span class="sd">    c = cov.coverage()</span>
<span class="sd">    ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trace</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Location</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Trace function</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">traceit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">FrameType</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tracing function. To be overloaded in subclasses.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_trace_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">original_trace_function</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s2">&quot;line&quot;</span><span class="p">:</span>
            <span class="n">function_name</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
            <span class="n">lineno</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span>
            <span class="k">if</span> <span class="n">function_name</span> <span class="o">!=</span> <span class="s1">&#39;__exit__&#39;</span><span class="p">:</span>  <span class="c1"># avoid tracing ourselves:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_trace</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">function_name</span><span class="p">,</span> <span class="n">lineno</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">traceit</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start of `with` block. Turn on tracing.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_trace_function</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">gettrace</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traceit</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">:</span> <span class="ne">BaseException</span><span class="p">,</span>
                 <span class="n">tb</span><span class="p">:</span> <span class="n">TracebackType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;End of `with` block. Turn off tracing.&quot;&quot;&quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_trace_function</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># default: pass all exceptions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">trace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Location</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The list of executed lines, as (function_name, line_number) pairs&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trace</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">coverage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="n">Location</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The set of executed lines, as (function_name, line_number) pairs&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">function_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The set of function names seen&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">function_name</span> <span class="k">for</span> <span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">line_number</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coverage</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a string representation of this object.</span>
<span class="sd">           Show covered (and uncovered) program code&quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">function_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_names</span><span class="p">():</span>
            <span class="c1"># Similar code as in the example above</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fun</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">continue</span>

            <span class="n">source_lines</span><span class="p">,</span> <span class="n">start_line_number</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">lineno</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_line_number</span><span class="p">,</span> <span class="n">start_line_number</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">source_lines</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">():</span>
                    <span class="n">t</span> <span class="o">+=</span> <span class="s2">&quot;# &quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">t</span> <span class="o">+=</span> <span class="s2">&quot;  &quot;</span>
                <span class="n">t</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%2d</span><span class="s2">  &quot;</span> <span class="o">%</span> <span class="n">lineno</span>
                <span class="n">t</span> <span class="o">+=</span> <span class="n">source_lines</span><span class="p">[</span><span class="n">lineno</span> <span class="o">-</span> <span class="n">start_line_number</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">t</span>
</pre></div>
</div>
</div>
</div>
<p>Let us put this to use:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Coverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov</span><span class="p">:</span>
    <span class="n">cgi_decode</span><span class="p">(</span><span class="s2">&quot;a+b&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">coverage</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{(&#39;cgi_decode&#39;, 8), (&#39;cgi_decode&#39;, 30), (&#39;cgi_decode&#39;, 17), (&#39;cgi_decode&#39;, 20), (&#39;cgi_decode&#39;, 10), (&#39;cgi_decode&#39;, 16), (&#39;cgi_decode&#39;, 19), (&#39;cgi_decode&#39;, 9), (&#39;cgi_decode&#39;, 32), (&#39;cgi_decode&#39;, 12), (&#39;cgi_decode&#39;, 18), (&#39;cgi_decode&#39;, 31), (&#39;cgi_decode&#39;, 15), (&#39;cgi_decode&#39;, 21), (&#39;cgi_decode&#39;, 11)}
</pre></div>
</div>
</div>
</div>
<p>As you can see, the <code class="docutils literal notranslate"><span class="pre">Coverage()</span></code> class not only keeps track of lines executed, but also of function names.  This is useful if you have a program that spans multiple files.</p>
<p>For interactive use, we can simply print the coverage object, and obtain a listing of the code, again with non-covered lines marked as <code class="docutils literal notranslate"><span class="pre">#</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>#  1  def cgi_decode(s: str) -&gt; str:
#  2      &quot;&quot;&quot;Decode the CGI-encoded string `s`:
#  3         * replace &#39;+&#39; by &#39; &#39;
#  4         * replace &quot;%xx&quot; by the character with hex number xx.
#  5         Return the decoded string.  Raise `ValueError` for invalid inputs.&quot;&quot;&quot;
#  6  
#  7      # Mapping of hex digits to their integer values
   8      hex_values = {
   9          &#39;0&#39;: 0, &#39;1&#39;: 1, &#39;2&#39;: 2, &#39;3&#39;: 3, &#39;4&#39;: 4,
  10          &#39;5&#39;: 5, &#39;6&#39;: 6, &#39;7&#39;: 7, &#39;8&#39;: 8, &#39;9&#39;: 9,
  11          &#39;a&#39;: 10, &#39;b&#39;: 11, &#39;c&#39;: 12, &#39;d&#39;: 13, &#39;e&#39;: 14, &#39;f&#39;: 15,
  12          &#39;A&#39;: 10, &#39;B&#39;: 11, &#39;C&#39;: 12, &#39;D&#39;: 13, &#39;E&#39;: 14, &#39;F&#39;: 15,
# 13      }
# 14  
  15      t = &quot;&quot;
  16      i = 0
  17      while i &lt; len(s):
  18          c = s[i]
  19          if c == &#39;+&#39;:
  20              t += &#39; &#39;
  21          elif c == &#39;%&#39;:
# 22              digit_high, digit_low = s[i + 1], s[i + 2]
# 23              i += 2
# 24              if digit_high in hex_values and digit_low in hex_values:
# 25                  v = hex_values[digit_high] * 16 + hex_values[digit_low]
# 26                  t += chr(v)
# 27              else:
# 28                  raise ValueError(&quot;Invalid encoding&quot;)
# 29          else:
  30              t += c
  31          i += 1
  32      return t
</pre></div>
</div>
</div>
</div>
</section>
<section id="comparing-coverage">
<h2>Comparing Coverage<a class="headerlink" href="#comparing-coverage" title="Link to this heading">#</a></h2>
<p>Since we represent coverage as a set of executed lines, we can also apply <em>set operations</em> on these.  For instance, we can find out which lines are covered by individual test cases, but not others:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Coverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov_plus</span><span class="p">:</span>
    <span class="n">cgi_decode</span><span class="p">(</span><span class="s2">&quot;a+b&quot;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">Coverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov_standard</span><span class="p">:</span>
    <span class="n">cgi_decode</span><span class="p">(</span><span class="s2">&quot;abc&quot;</span><span class="p">)</span>

<span class="n">cov_plus</span><span class="o">.</span><span class="n">coverage</span><span class="p">()</span> <span class="o">-</span> <span class="n">cov_standard</span><span class="o">.</span><span class="n">coverage</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{(&#39;cgi_decode&#39;, 20)}
</pre></div>
</div>
</div>
</div>
<p>This is the single line in the code that is executed only in the <code class="docutils literal notranslate"><span class="pre">'a+b'</span></code> input.</p>
<p>We can also compare sets to find out which lines still need to be covered.  Let us define <code class="docutils literal notranslate"><span class="pre">cov_max</span></code> as the maximum coverage we can achieve. (Here, we do this by executing the “good” test cases we already have.  In practice, one would statically analyze code structure, which we introduce in <a class="reference internal" href="SymbolicFuzzer.html"><span class="std std-doc">the chapter on symbolic testing</span></a>.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Coverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov_max</span><span class="p">:</span>
    <span class="n">cgi_decode</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
    <span class="n">cgi_decode</span><span class="p">(</span><span class="s1">&#39;%20&#39;</span><span class="p">)</span>
    <span class="n">cgi_decode</span><span class="p">(</span><span class="s1">&#39;abc&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cgi_decode</span><span class="p">(</span><span class="s1">&#39;%?a&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<p>Then, we can easily see which lines are <em>not</em> yet covered by a test case:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cov_max</span><span class="o">.</span><span class="n">coverage</span><span class="p">()</span> <span class="o">-</span> <span class="n">cov_plus</span><span class="o">.</span><span class="n">coverage</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{(&#39;cgi_decode&#39;, 22),
 (&#39;cgi_decode&#39;, 23),
 (&#39;cgi_decode&#39;, 24),
 (&#39;cgi_decode&#39;, 25),
 (&#39;cgi_decode&#39;, 26),
 (&#39;cgi_decode&#39;, 28)}
</pre></div>
</div>
</div>
</div>
<p>Again, these would be the lines handling <code class="docutils literal notranslate"><span class="pre">&quot;%xx&quot;</span></code>, which we have not yet had in the input.</p>
</section>
<section id="coverage-of-basic-fuzzing">
<h2>Coverage of Basic Fuzzing<a class="headerlink" href="#coverage-of-basic-fuzzing" title="Link to this heading">#</a></h2>
<p>We can now use our coverage tracing to assess the <em>effectiveness</em> of testing methods – in particular, of course, test <em>generation</em> methods.  Our challenge is to achieve maximum coverage in <code class="docutils literal notranslate"><span class="pre">cgi_decode()</span></code> just with random inputs.  In principle, we should <em>eventually</em> get there, as eventually, we will have produced every possible string in the universe – but exactly how long is this?  To this end, let us run just one fuzzing iteration on <code class="docutils literal notranslate"><span class="pre">cgi_decode()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">Fuzzer</span><span class="w"> </span><span class="kn">import</span> <span class="n">fuzzer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample</span> <span class="o">=</span> <span class="n">fuzzer</span><span class="p">()</span>
<span class="n">sample</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;!7#%&quot;*#0=)$;%6*;&gt;638:*&gt;80&quot;=&lt;/&gt;(/*:-(2&lt;4 !:5*6856&amp;?&quot;&quot;11&lt;7+%&lt;%7,4.8,*+&amp;,,$,.&quot;&#39;
</pre></div>
</div>
</div>
</div>
<p>Here’s the invocation and the coverage we achieve.  We wrap <code class="docutils literal notranslate"><span class="pre">cgi_decode()</span></code> in a <code class="docutils literal notranslate"><span class="pre">try...except</span></code> block such that we can ignore <code class="docutils literal notranslate"><span class="pre">ValueError</span></code> exceptions raised by illegal <code class="docutils literal notranslate"><span class="pre">%xx</span></code> formats.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Coverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov_fuzz</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cgi_decode</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
<span class="n">cov_fuzz</span><span class="o">.</span><span class="n">coverage</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{(&#39;cgi_decode&#39;, 8),
 (&#39;cgi_decode&#39;, 9),
 (&#39;cgi_decode&#39;, 10),
 (&#39;cgi_decode&#39;, 11),
 (&#39;cgi_decode&#39;, 12),
 (&#39;cgi_decode&#39;, 15),
 (&#39;cgi_decode&#39;, 16),
 (&#39;cgi_decode&#39;, 17),
 (&#39;cgi_decode&#39;, 18),
 (&#39;cgi_decode&#39;, 19),
 (&#39;cgi_decode&#39;, 21),
 (&#39;cgi_decode&#39;, 22),
 (&#39;cgi_decode&#39;, 23),
 (&#39;cgi_decode&#39;, 24),
 (&#39;cgi_decode&#39;, 28),
 (&#39;cgi_decode&#39;, 30),
 (&#39;cgi_decode&#39;, 31)}
</pre></div>
</div>
</div>
</div>
<p>Is this already the maximum coverage?  Apparently, there are still lines missing:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cov_max</span><span class="o">.</span><span class="n">coverage</span><span class="p">()</span> <span class="o">-</span> <span class="n">cov_fuzz</span><span class="o">.</span><span class="n">coverage</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{(&#39;cgi_decode&#39;, 20),
 (&#39;cgi_decode&#39;, 25),
 (&#39;cgi_decode&#39;, 26),
 (&#39;cgi_decode&#39;, 32)}
</pre></div>
</div>
</div>
</div>
<p>Let us try again, increasing coverage over 100 random inputs.  We use an array <code class="docutils literal notranslate"><span class="pre">cumulative_coverage</span></code> to store the coverage achieved over time; <code class="docutils literal notranslate"><span class="pre">cumulative_coverage[0]</span></code> is the total number of lines covered after input 1,
<code class="docutils literal notranslate"><span class="pre">cumulative_coverage[1]</span></code> is the number of lines covered after inputs 1–2, and so on.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trials</span> <span class="o">=</span> <span class="mi">100</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">population_coverage</span><span class="p">(</span><span class="n">population</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> \
        <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="n">Location</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="n">cumulative_coverage</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_coverage</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">Location</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">population</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">Coverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">function</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">all_coverage</span> <span class="o">|=</span> <span class="n">cov</span><span class="o">.</span><span class="n">coverage</span><span class="p">()</span>
        <span class="n">cumulative_coverage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_coverage</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">all_coverage</span><span class="p">,</span> <span class="n">cumulative_coverage</span>
</pre></div>
</div>
</div>
</div>
<p>Let us create a hundred inputs to determine how coverage increases:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">hundred_inputs</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">population</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trials</span><span class="p">):</span>
        <span class="n">population</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fuzzer</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">population</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s how the coverage increases with each input:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_coverage</span><span class="p">,</span> <span class="n">cumulative_coverage</span> <span class="o">=</span> \
    <span class="n">population_coverage</span><span class="p">(</span><span class="n">hundred_inputs</span><span class="p">(),</span> <span class="n">cgi_decode</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cumulative_coverage</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Coverage of cgi_decode() with random inputs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;# of inputs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;lines covered&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;lines covered&#39;)
</pre></div>
</div>
<img alt="_images/afc386639fee166d15ddd9c8bac6db8e93b9c0b86b08696bcd0ef609af0fe05f.png" src="_images/afc386639fee166d15ddd9c8bac6db8e93b9c0b86b08696bcd0ef609af0fe05f.png" />
</div>
</div>
<p>This is just <em>one</em> run, of course; so let’s repeat this a number of times and plot the averages.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">runs</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># Create an array with TRIALS elements, all zero</span>
<span class="n">sum_coverage</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">trials</span>

<span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">runs</span><span class="p">):</span>
    <span class="n">all_coverage</span><span class="p">,</span> <span class="n">coverage</span> <span class="o">=</span> <span class="n">population_coverage</span><span class="p">(</span><span class="n">hundred_inputs</span><span class="p">(),</span> <span class="n">cgi_decode</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">coverage</span><span class="p">)</span> <span class="o">==</span> <span class="n">trials</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trials</span><span class="p">):</span>
        <span class="n">sum_coverage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">coverage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="n">average_coverage</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trials</span><span class="p">):</span>
    <span class="n">average_coverage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sum_coverage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">runs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">average_coverage</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Average coverage of cgi_decode() with random inputs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;# of inputs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;lines covered&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;lines covered&#39;)
</pre></div>
</div>
<img alt="_images/a52f82b895139d920b395ded30b6a096d2d14f5af2d74f10657d2f4dbe6a54d8.png" src="_images/a52f82b895139d920b395ded30b6a096d2d14f5af2d74f10657d2f4dbe6a54d8.png" />
</div>
</div>
<p>We see that on average, we get full coverage after 40–60 fuzzing inputs.</p>
</section>
<section id="getting-coverage-from-external-programs">
<h2>Getting Coverage from External Programs<a class="headerlink" href="#getting-coverage-from-external-programs" title="Link to this heading">#</a></h2>
<p>Of course, not all the world is programming in Python.  The good news is that the problem of obtaining coverage is ubiquitous, and almost every programming language has some facility to measure coverage.  Just as an example, let us therefore demonstrate how to obtain coverage for a C program.</p>
<p>Our C program (again) implements <code class="docutils literal notranslate"><span class="pre">cgi_decode</span></code>; this time as a program to be executed from the command line:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>./cgi_decode<span class="w"> </span><span class="s1">&#39;Hello+World&#39;</span>
Hello<span class="w"> </span>World
</pre></div>
</div>
<p>Here comes the C code, first as a Python string.  We start with the usual C includes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cgi_c_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">/* CGI decoding as C program */</span>

<span class="s2">#include &lt;stdlib.h&gt;</span>
<span class="s2">#include &lt;string.h&gt;</span>
<span class="s2">#include &lt;stdio.h&gt;</span>

<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>Here comes the initialization of <code class="docutils literal notranslate"><span class="pre">hex_values</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cgi_c_code</span> <span class="o">+=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">int hex_values[256];</span>

<span class="s2">void init_hex_values() {</span>
<span class="s2">    for (int i = 0; i &lt; sizeof(hex_values) / sizeof(int); i++) {</span>
<span class="s2">        hex_values[i] = -1;</span>
<span class="s2">    }</span>
<span class="s2">    hex_values[&#39;0&#39;] = 0; hex_values[&#39;1&#39;] = 1; hex_values[&#39;2&#39;] = 2; hex_values[&#39;3&#39;] = 3;</span>
<span class="s2">    hex_values[&#39;4&#39;] = 4; hex_values[&#39;5&#39;] = 5; hex_values[&#39;6&#39;] = 6; hex_values[&#39;7&#39;] = 7;</span>
<span class="s2">    hex_values[&#39;8&#39;] = 8; hex_values[&#39;9&#39;] = 9;</span>

<span class="s2">    hex_values[&#39;a&#39;] = 10; hex_values[&#39;b&#39;] = 11; hex_values[&#39;c&#39;] = 12; hex_values[&#39;d&#39;] = 13;</span>
<span class="s2">    hex_values[&#39;e&#39;] = 14; hex_values[&#39;f&#39;] = 15;</span>

<span class="s2">    hex_values[&#39;A&#39;] = 10; hex_values[&#39;B&#39;] = 11; hex_values[&#39;C&#39;] = 12; hex_values[&#39;D&#39;] = 13;</span>
<span class="s2">    hex_values[&#39;E&#39;] = 14; hex_values[&#39;F&#39;] = 15;</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s the actual implementation of <code class="docutils literal notranslate"><span class="pre">cgi_decode()</span></code>, using pointers for input source (<code class="docutils literal notranslate"><span class="pre">s</span></code>) and output target (<code class="docutils literal notranslate"><span class="pre">t</span></code>):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cgi_c_code</span> <span class="o">+=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">int cgi_decode(char *s, char *t) {</span>
<span class="s2">    while (*s != &#39;\0&#39;) {</span>
<span class="s2">        if (*s == &#39;+&#39;)</span>
<span class="s2">            *t++ = &#39; &#39;;</span>
<span class="s2">        else if (*s == &#39;%&#39;) {</span>
<span class="s2">            int digit_high = *++s;</span>
<span class="s2">            int digit_low = *++s;</span>
<span class="s2">            if (hex_values[digit_high] &gt;= 0 &amp;&amp; hex_values[digit_low] &gt;= 0) {</span>
<span class="s2">                *t++ = hex_values[digit_high] * 16 + hex_values[digit_low];</span>
<span class="s2">            }</span>
<span class="s2">            else</span>
<span class="s2">                return -1;</span>
<span class="s2">        }</span>
<span class="s2">        else</span>
<span class="s2">            *t++ = *s;</span>
<span class="s2">        s++;</span>
<span class="s2">    }</span>
<span class="s2">    *t = &#39;\0&#39;;</span>
<span class="s2">    return 0;</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, here’s a driver which takes the first argument and invokes <code class="docutils literal notranslate"><span class="pre">cgi_decode</span></code> with it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cgi_c_code</span> <span class="o">+=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">int main(int argc, char *argv[]) {</span>
<span class="s2">    init_hex_values();</span>

<span class="s2">    if (argc &gt;= 2) {</span>
<span class="s2">        char *s = argv[1];</span>
<span class="s2">        char *t = malloc(strlen(s) + 1); /* output is at most as long as input */</span>
<span class="s2">        int ret = cgi_decode(s, t);</span>
<span class="s2">        printf(&quot;</span><span class="si">%s</span><span class="s2">\n&quot;, t);</span>
<span class="s2">        return ret;</span>
<span class="s2">    }</span>
<span class="s2">    else</span>
<span class="s2">    {</span>
<span class="s2">        printf(&quot;cgi_decode: usage: cgi_decode STRING\n&quot;);</span>
<span class="s2">        return 1;</span>
<span class="s2">    }</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>Let us create the C source code: (Note that the following commands will overwrite the file <code class="docutils literal notranslate"><span class="pre">cgi_decode.c</span></code>, if it already exists in the current working directory. Be aware of this, if you downloaded the notebooks and are working locally.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;cgi_decode.c&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cgi_c_code</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And here we have the C code with its syntax highlighted:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bookutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_file</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_file</span><span class="p">(</span><span class="s2">&quot;cgi_decode.c&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-White">/* CGI decoding as C program */</span>

<span class=" -Color -Color-Cyan">#include</span><span class=" -Color -Color-White"> &lt;stdlib.h&gt;</span>
<span class=" -Color -Color-Cyan">#include</span><span class=" -Color -Color-White"> &lt;string.h&gt;</span>
<span class=" -Color -Color-Cyan">#include</span><span class=" -Color -Color-White"> &lt;stdio.h&gt;</span>


<span class=" -Color -Color-Cyan">int</span><span class=" -Color -Color-White"> </span>hex_values[<span class=" -Color -Color-Blue">256</span>];

<span class=" -Color -Color-Cyan">void</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">init_hex_values</span>()<span class=" -Color -Color-White"> </span>{
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Blue">for</span><span class=" -Color -Color-White"> </span>(<span class=" -Color -Color-Cyan">int</span><span class=" -Color -Color-White"> </span>i<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">0</span>;<span class=" -Color -Color-White"> </span>i<span class=" -Color -Color-White"> </span>&lt;<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">sizeof</span>(hex_values)<span class=" -Color -Color-White"> </span>/<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">sizeof</span>(<span class=" -Color -Color-Cyan">int</span>);<span class=" -Color -Color-White"> </span>i++)<span class=" -Color -Color-White"> </span>{
<span class=" -Color -Color-White">        </span>hex_values[i]<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">-1</span>;
<span class=" -Color -Color-White">    </span>}
<span class=" -Color -Color-White">    </span>hex_values[<span class=" -Color -Color-Yellow">&#39;0&#39;</span>]<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">0</span>;<span class=" -Color -Color-White"> </span>hex_values[<span class=" -Color -Color-Yellow">&#39;1&#39;</span>]<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>;<span class=" -Color -Color-White"> </span>hex_values[<span class=" -Color -Color-Yellow">&#39;2&#39;</span>]<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">2</span>;<span class=" -Color -Color-White"> </span>hex_values[<span class=" -Color -Color-Yellow">&#39;3&#39;</span>]<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">3</span>;
<span class=" -Color -Color-White">    </span>hex_values[<span class=" -Color -Color-Yellow">&#39;4&#39;</span>]<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">4</span>;<span class=" -Color -Color-White"> </span>hex_values[<span class=" -Color -Color-Yellow">&#39;5&#39;</span>]<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">5</span>;<span class=" -Color -Color-White"> </span>hex_values[<span class=" -Color -Color-Yellow">&#39;6&#39;</span>]<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">6</span>;<span class=" -Color -Color-White"> </span>hex_values[<span class=" -Color -Color-Yellow">&#39;7&#39;</span>]<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">7</span>;
<span class=" -Color -Color-White">    </span>hex_values[<span class=" -Color -Color-Yellow">&#39;8&#39;</span>]<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">8</span>;<span class=" -Color -Color-White"> </span>hex_values[<span class=" -Color -Color-Yellow">&#39;9&#39;</span>]<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">9</span>;

<span class=" -Color -Color-White">    </span>hex_values[<span class=" -Color -Color-Yellow">&#39;a&#39;</span>]<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">10</span>;<span class=" -Color -Color-White"> </span>hex_values[<span class=" -Color -Color-Yellow">&#39;b&#39;</span>]<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">11</span>;<span class=" -Color -Color-White"> </span>hex_values[<span class=" -Color -Color-Yellow">&#39;c&#39;</span>]<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">12</span>;<span class=" -Color -Color-White"> </span>hex_values[<span class=" -Color -Color-Yellow">&#39;d&#39;</span>]<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">13</span>;
<span class=" -Color -Color-White">    </span>hex_values[<span class=" -Color -Color-Yellow">&#39;e&#39;</span>]<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">14</span>;<span class=" -Color -Color-White"> </span>hex_values[<span class=" -Color -Color-Yellow">&#39;f&#39;</span>]<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">15</span>;

<span class=" -Color -Color-White">    </span>hex_values[<span class=" -Color -Color-Yellow">&#39;A&#39;</span>]<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">10</span>;<span class=" -Color -Color-White"> </span>hex_values[<span class=" -Color -Color-Yellow">&#39;B&#39;</span>]<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">11</span>;<span class=" -Color -Color-White"> </span>hex_values[<span class=" -Color -Color-Yellow">&#39;C&#39;</span>]<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">12</span>;<span class=" -Color -Color-White"> </span>hex_values[<span class=" -Color -Color-Yellow">&#39;D&#39;</span>]<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">13</span>;
<span class=" -Color -Color-White">    </span>hex_values[<span class=" -Color -Color-Yellow">&#39;E&#39;</span>]<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">14</span>;<span class=" -Color -Color-White"> </span>hex_values[<span class=" -Color -Color-Yellow">&#39;F&#39;</span>]<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">15</span>;
}

<span class=" -Color -Color-Cyan">int</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">cgi_decode</span>(<span class=" -Color -Color-Cyan">char</span><span class=" -Color -Color-White"> </span>*s,<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Cyan">char</span><span class=" -Color -Color-White"> </span>*t)<span class=" -Color -Color-White"> </span>{
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Blue">while</span><span class=" -Color -Color-White"> </span>(*s<span class=" -Color -Color-White"> </span>!=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&#39;\0&#39;</span>)<span class=" -Color -Color-White"> </span>{
<span class=" -Color -Color-White">        </span><span class=" -Color -Color-Blue">if</span><span class=" -Color -Color-White"> </span>(*s<span class=" -Color -Color-White"> </span>==<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&#39;+&#39;</span>)
<span class=" -Color -Color-White">            </span>*t++<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&#39; &#39;</span>;
<span class=" -Color -Color-White">        </span><span class=" -Color -Color-Blue">else</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">if</span><span class=" -Color -Color-White"> </span>(*s<span class=" -Color -Color-White"> </span>==<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&#39;%&#39;</span>)<span class=" -Color -Color-White"> </span>{
<span class=" -Color -Color-White">            </span><span class=" -Color -Color-Cyan">int</span><span class=" -Color -Color-White"> </span>digit_high<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span>*++s;
<span class=" -Color -Color-White">            </span><span class=" -Color -Color-Cyan">int</span><span class=" -Color -Color-White"> </span>digit_low<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span>*++s;
<span class=" -Color -Color-White">            </span><span class=" -Color -Color-Blue">if</span><span class=" -Color -Color-White"> </span>(hex_values[digit_high]<span class=" -Color -Color-White"> </span>&gt;=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">0</span><span class=" -Color -Color-White"> </span>&amp;&amp;<span class=" -Color -Color-White"> </span>hex_values[digit_low]<span class=" -Color -Color-White"> </span>&gt;=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">0</span>)<span class=" -Color -Color-White"> </span>{
<span class=" -Color -Color-White">                </span>*t++<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span>hex_values[digit_high]<span class=" -Color -Color-White"> </span>*<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">16</span><span class=" -Color -Color-White"> </span>+<span class=" -Color -Color-White"> </span>hex_values[digit_low];
<span class=" -Color -Color-White">            </span>}
<span class=" -Color -Color-White">            </span><span class=" -Color -Color-Blue">else</span>
<span class=" -Color -Color-White">                </span><span class=" -Color -Color-Blue">return</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">-1</span>;
<span class=" -Color -Color-White">        </span>}
<span class=" -Color -Color-White">        </span><span class=" -Color -Color-Blue">else</span>
<span class=" -Color -Color-White">            </span>*t++<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span>*s;
<span class=" -Color -Color-White">        </span>s++;
<span class=" -Color -Color-White">    </span>}
<span class=" -Color -Color-White">    </span>*t<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Yellow">&#39;\0&#39;</span>;
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Blue">return</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">0</span>;
}

<span class=" -Color -Color-Cyan">int</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Green">main</span>(<span class=" -Color -Color-Cyan">int</span><span class=" -Color -Color-White"> </span>argc,<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Cyan">char</span><span class=" -Color -Color-White"> </span>*argv[])<span class=" -Color -Color-White"> </span>{
<span class=" -Color -Color-White">    </span>init_hex_values();

<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Blue">if</span><span class=" -Color -Color-White"> </span>(argc<span class=" -Color -Color-White"> </span>&gt;=<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">2</span>)<span class=" -Color -Color-White"> </span>{
<span class=" -Color -Color-White">        </span><span class=" -Color -Color-Cyan">char</span><span class=" -Color -Color-White"> </span>*s<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span>argv[<span class=" -Color -Color-Blue">1</span>];
<span class=" -Color -Color-White">        </span><span class=" -Color -Color-Cyan">char</span><span class=" -Color -Color-White"> </span>*t<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span>malloc(strlen(s)<span class=" -Color -Color-White"> </span>+<span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>);<span class=" -Color -Color-White"> /* output is at most as long as input */</span>
<span class=" -Color -Color-White">        </span><span class=" -Color -Color-Cyan">int</span><span class=" -Color -Color-White"> </span>ret<span class=" -Color -Color-White"> </span>=<span class=" -Color -Color-White"> </span>cgi_decode(s,<span class=" -Color -Color-White"> </span>t);
<span class=" -Color -Color-White">        </span>printf(<span class=" -Color -Color-Yellow">&quot;%s\n&quot;</span>,<span class=" -Color -Color-White"> </span>t);
<span class=" -Color -Color-White">        </span><span class=" -Color -Color-Blue">return</span><span class=" -Color -Color-White"> </span>ret;
<span class=" -Color -Color-White">    </span>}
<span class=" -Color -Color-White">    </span><span class=" -Color -Color-Blue">else</span>
<span class=" -Color -Color-White">    </span>{
<span class=" -Color -Color-White">        </span>printf(<span class=" -Color -Color-Yellow">&quot;cgi_decode: usage: cgi_decode STRING\n&quot;</span>);
<span class=" -Color -Color-White">        </span><span class=" -Color -Color-Blue">return</span><span class=" -Color -Color-White"> </span><span class=" -Color -Color-Blue">1</span>;
<span class=" -Color -Color-White">    </span>}
}
</pre></div>
</div>
</div>
</div>
<p>We can now compile the C code into an executable.  The <code class="docutils literal notranslate"><span class="pre">--coverage</span></code> option instructs the C compiler to instrument the code such that at runtime, coverage information will be collected.  (The exact options vary from compiler to compiler.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>cc<span class="w"> </span>--coverage<span class="w"> </span>-o<span class="w"> </span>cgi_decode<span class="w"> </span>cgi_decode.c
</pre></div>
</div>
</div>
</div>
<p>When we now execute the program, coverage information will automatically be collected and stored in auxiliary files:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>./cgi_decode<span class="w"> </span><span class="s1">&#39;Send+mail+to+me%40fuzzingbook.org&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Send mail to me@fuzzingbook.org
</pre></div>
</div>
</div>
</div>
<p>The coverage information is collected by the <code class="docutils literal notranslate"><span class="pre">gcov</span></code> program.  For every source file given, it produces a new <code class="docutils literal notranslate"><span class="pre">.gcov</span></code> file with coverage information. This is either stored in <code class="docutils literal notranslate"><span class="pre">cgi_decode...</span></code> or in <code class="docutils literal notranslate"><span class="pre">cgi_decode-cgi_decode...</span></code> files.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>gcov<span class="w"> </span>cgi_decode<span class="w"> </span>cgi_decode-cgi_decode
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>cgi_decode.gcno: No such file or directory
File &#39;cgi_decode.c&#39;
Lines executed:92.50% of 40
Creating &#39;cgi_decode.c.gcov&#39;
</pre></div>
</div>
</div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">.gcov</span></code> file, each line is prefixed with the number of times it was called (<code class="docutils literal notranslate"><span class="pre">-</span></code> stands for a non-executable line, <code class="docutils literal notranslate"><span class="pre">#####</span></code> stands for zero) as well as the line number.  We can take a look at <code class="docutils literal notranslate"><span class="pre">cgi_decode()</span></code>, for instance, and see that the only code not executed yet is the <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">-1</span></code> for an illegal input.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;cgi_decode.c.gcov&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">50</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>        1:   26:int cgi_decode(char *s, char *t) {
       32:   27:    while (*s != &#39;\0&#39;) {
       31:   28:        if (*s == &#39;+&#39;)
        3:   29:            *t++ = &#39; &#39;;
       28:   30:        else if (*s == &#39;%&#39;) {
        1:   31:            int digit_high = *++s;
        1:   32:            int digit_low = *++s;
        1:   33:            if (hex_values[digit_high] &gt;= 0 &amp;&amp; hex_values[digit_low] &gt;= 0) {
        1:   34:                *t++ = hex_values[digit_high] * 16 + hex_values[digit_low];
        1:   35:            }
        -:   36:            else
    #####:   37:                return -1;
        1:   38:        }
        -:   39:        else
       27:   40:            *t++ = *s;
       31:   41:        s++;
        -:   42:    }
        1:   43:    *t = &#39;\0&#39;;
        1:   44:    return 0;
        1:   45:}
</pre></div>
</div>
</div>
</div>
<p>Let us read in this file to obtain a coverage set:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">read_gcov_coverage</span><span class="p">(</span><span class="n">c_file</span><span class="p">):</span>
    <span class="n">gcov_file</span> <span class="o">=</span> <span class="n">c_file</span> <span class="o">+</span> <span class="s2">&quot;.gcov&quot;</span>
    <span class="n">coverage</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">gcov_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="n">elems</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">covered</span> <span class="o">=</span> <span class="n">elems</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">line_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">elems</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">covered</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">covered</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">coverage</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">c_file</span><span class="p">,</span> <span class="n">line_number</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">coverage</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coverage</span> <span class="o">=</span> <span class="n">read_gcov_coverage</span><span class="p">(</span><span class="s1">&#39;cgi_decode.c&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="n">coverage</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39;cgi_decode.c&#39;, 20),
 (&#39;cgi_decode.c&#39;, 26),
 (&#39;cgi_decode.c&#39;, 23),
 (&#39;cgi_decode.c&#39;, 29),
 (&#39;cgi_decode.c&#39;, 32)]
</pre></div>
</div>
</div>
</div>
<p>With this set, we can now do the same coverage computations as with our Python programs.</p>
</section>
<section id="finding-errors-with-basic-fuzzing">
<h2>Finding Errors with Basic Fuzzing<a class="headerlink" href="#finding-errors-with-basic-fuzzing" title="Link to this heading">#</a></h2>
<p>Given sufficient time, we can indeed cover each and every line within <code class="docutils literal notranslate"><span class="pre">cgi_decode()</span></code>, whatever the programming language would be.  This does not mean that they would be error-free, though.  Since we do not check the result of <code class="docutils literal notranslate"><span class="pre">cgi_decode()</span></code>, the function could return any value without us checking or noticing.  To catch such errors, we would have to set up a <em>results checker</em> (commonly called an <em>oracle</em>) that would verify test results.  In our case, we could compare the C and Python implementations of <code class="docutils literal notranslate"><span class="pre">cgi_decode()</span></code> and see whether both produce the same results.</p>
<p>Where fuzzing is great at, though, is in finding <em>internal errors</em> that can be detected even without checking the result.  Actually, if one runs our <code class="docutils literal notranslate"><span class="pre">fuzzer()</span></code> on <code class="docutils literal notranslate"><span class="pre">cgi_decode()</span></code>, one quickly finds such an error, as the following code shows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ExpectError</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExpectError</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trials</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">fuzzer</span><span class="p">()</span>
            <span class="n">cgi_decode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_20400/2238772797.py&quot;, line 5, in &lt;module&gt;
    cgi_decode(s)
    ~~~~~~~~~~^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_20400/1071239422.py&quot;, line 22, in cgi_decode
    digit_high, digit_low = s[i + 1], s[i + 2]
                                      ~^^^^^^^
IndexError: string index out of range (expected)
</pre></div>
</div>
</div>
</div>
<p>So, it is possible to cause <code class="docutils literal notranslate"><span class="pre">cgi_decode()</span></code> to crash.  Why is that?  Let’s take a look at its input:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;82 202*&amp;&lt;1&amp;($34\&#39;&quot;/\&#39;.&lt;5/!8&quot;\&#39;5:!4))%;&#39;
</pre></div>
</div>
</div>
</div>
<p>The problem here is at the end of the string.  After a <code class="docutils literal notranslate"><span class="pre">'%'</span></code> character, our implementation will always attempt to access two more (hexadecimal) characters, but if these are not there, we will get an <code class="docutils literal notranslate"><span class="pre">IndexError</span></code> exception.</p>
<p>This problem is also present in our C variant, which inherits it from the original implementation \cite{Pezze2008}:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">digit_high</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*++</span><span class="n">s</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">digit_low</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*++</span><span class="n">s</span><span class="p">;</span>
</pre></div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">s</span></code> is a pointer to the character to be read; <code class="docutils literal notranslate"><span class="pre">++</span></code> increments it by one character.
In the C implementation, the problem is actually much worse.  If the <code class="docutils literal notranslate"><span class="pre">'%'</span></code> character is at the end of the string, the above code will first read a terminating character (<code class="docutils literal notranslate"><span class="pre">'\0'</span></code> in C strings) and then the following character, which may be any memory content after the string, and which thus may cause the program to fail uncontrollably.  The somewhat good news is that <code class="docutils literal notranslate"><span class="pre">'\0'</span></code> is not a valid hexadecimal character, and thus, the C version will “only” read one character beyond the end of the string.</p>
<p>Interestingly enough, none of the manual tests we had designed earlier would trigger this bug.  Actually, neither statement nor branch coverage, nor any of the coverage criteria commonly discussed in literature would find it.  However, a simple fuzzing run can identify the error with a few runs – <em>if</em> appropriate run-time checks are in place that find such overflows.  This definitely calls for more fuzzing!</p>
</section>
<section id="lessons-learned">
<h2>Lessons Learned<a class="headerlink" href="#lessons-learned" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Coverage metrics are a simple and fully automated means to approximate how much functionality of a program is actually executed during a test run.</p></li>
<li><p>A number of coverage metrics exist, the most important ones being statement coverage and branch coverage.</p></li>
<li><p>In Python, it is very easy to access the program state during execution, including the currently executed code.</p></li>
</ul>
<p>At the end of the day, let’s clean up: (Note that the following commands will delete all files in the current working directory that fit the pattern <code class="docutils literal notranslate"><span class="pre">cgi_decode.*</span></code>. Be aware of this, if you downloaded the notebooks and are working locally.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;cgi_decode&quot;</span><span class="p">)</span> <span class="o">+</span> 
             <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;cgi_decode.*&quot;</span><span class="p">)</span> <span class="o">+</span> 
             <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;cgi_decode-*&quot;</span><span class="p">)):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">#</a></h2>
<p>Coverage is not only a tool to <em>measure</em> test effectiveness, but also a great tool to <em>guide</em> test generation towards specific goals – in particular uncovered code.  We use coverage to</p>
<ul class="simple">
<li><p><a class="reference internal" href="MutationFuzzer.html"><span class="std std-doc">guide <em>mutations</em> of existing inputs towards better coverage in the chapter on mutation fuzzing</span></a></p></li>
</ul>
</section>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h2>
<p>Coverage is a central concept in systematic software testing.  For discussions, see the books in the <a class="reference internal" href="Intro_Testing.html"><span class="std std-doc">Introduction to Testing</span></a>.</p>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<section id="exercise-1-fixing-cgi-decode">
<h3>Exercise 1: Fixing <code class="docutils literal notranslate"><span class="pre">cgi_decode()</span></code><a class="headerlink" href="#exercise-1-fixing-cgi-decode" title="Link to this heading">#</a></h3>
<p>Create an appropriate test to reproduce the <code class="docutils literal notranslate"><span class="pre">IndexError</span></code> discussed above.  Fix <code class="docutils literal notranslate"><span class="pre">cgi_decode()</span></code> to prevent the bug.  Show that your test (and additional <code class="docutils literal notranslate"><span class="pre">fuzzer()</span></code> runs) no longer expose the bug.  Do the same for the C variant.</p>
<p><strong>Solution.</strong>  Here’s a test case:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">cgi_decode</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;%&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_20400/1102034435.py&quot;, line 2, in &lt;module&gt;
    assert cgi_decode(&#39;%&#39;) == &#39;%&#39;
           ~~~~~~~~~~^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_20400/1071239422.py&quot;, line 22, in cgi_decode
    digit_high, digit_low = s[i + 1], s[i + 2]
                            ~^^^^^^^
IndexError: string index out of range (expected)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">cgi_decode</span><span class="p">(</span><span class="s1">&#39;%4&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;%4&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_20400/2291699482.py&quot;, line 2, in &lt;module&gt;
    assert cgi_decode(&#39;%4&#39;) == &#39;%4&#39;
           ~~~~~~~~~~^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_20400/1071239422.py&quot;, line 22, in cgi_decode
    digit_high, digit_low = s[i + 1], s[i + 2]
                                      ~^^^^^^^
IndexError: string index out of range (expected)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">cgi_decode</span><span class="p">(</span><span class="s1">&#39;%40&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;@&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s a fix:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">fixed_cgi_decode</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decode the CGI-encoded string `s`:</span>
<span class="sd">       * replace &quot;+&quot; by &quot; &quot;</span>
<span class="sd">       * replace &quot;%xx&quot; by the character with hex number xx.</span>
<span class="sd">       Return the decoded string.  Raise `ValueError` for invalid inputs.&quot;&quot;&quot;</span>

    <span class="c1"># Mapping of hex digits to their integer values</span>
    <span class="n">hex_values</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;0&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
        <span class="s1">&#39;5&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;8&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
        <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
        <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;%&#39;</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>  <span class="c1"># &lt;--- *** FIX ***</span>
            <span class="n">digit_high</span><span class="p">,</span> <span class="n">digit_low</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">digit_high</span> <span class="ow">in</span> <span class="n">hex_values</span> <span class="ow">and</span> <span class="n">digit_low</span> <span class="ow">in</span> <span class="n">hex_values</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">hex_values</span><span class="p">[</span><span class="n">digit_high</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">hex_values</span><span class="p">[</span><span class="n">digit_low</span><span class="p">]</span>
                <span class="n">t</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid encoding&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">c</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">t</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">fixed_cgi_decode</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;%&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">fixed_cgi_decode</span><span class="p">(</span><span class="s1">&#39;%4&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;%4&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">fixed_cgi_decode</span><span class="p">(</span><span class="s1">&#39;%40&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;@&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s the test:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trials</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">fuzzer</span><span class="p">()</span>
        <span class="n">fixed_cgi_decode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<p>For the C variant, the following will do:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cgi_c_code</span> <span class="o">=</span> <span class="n">cgi_c_code</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
    <span class="sa">r</span><span class="s2">&quot;if (*s == &#39;%&#39;)&quot;</span><span class="p">,</span>  <span class="c1"># old code</span>
    <span class="sa">r</span><span class="s2">&quot;if (*s == &#39;%&#39; &amp;&amp; s[1] != &#39;\0&#39; &amp;&amp; s[2] != &#39;\0&#39;)&quot;</span>  <span class="c1"># new code</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Go back to the above compilation commands and recompile <code class="docutils literal notranslate"><span class="pre">cgi_decode</span></code>.</p>
</section>
<section id="exercise-2-branch-coverage">
<h3>Exercise 2: Branch Coverage<a class="headerlink" href="#exercise-2-branch-coverage" title="Link to this heading">#</a></h3>
<p>Besides statement coverage, <em>branch coverage</em> is one of the most frequently used criteria to determine the quality of a test.  In a nutshell, branch coverage measures how many <em>control decisions</em> are made in code.  In the statement</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">CONDITION</span><span class="p">:</span>
    <span class="n">do_a</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">do_b</span><span class="p">()</span>
</pre></div>
</div>
<p>for instance, both the cases where <code class="docutils literal notranslate"><span class="pre">CONDITION</span></code> is true (branching to <code class="docutils literal notranslate"><span class="pre">do_a()</span></code>) and where <code class="docutils literal notranslate"><span class="pre">CONDITION</span></code> is false (branching to <code class="docutils literal notranslate"><span class="pre">do_b()</span></code>) have to be covered.  This holds for all control statements with a condition (<code class="docutils literal notranslate"><span class="pre">if</span></code>, <code class="docutils literal notranslate"><span class="pre">while</span></code>, etc.).</p>
<p>How is branch coverage different from statement coverage?  In the above example, there is actually no difference.  In this one, though, there is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">CONDITION</span><span class="p">:</span>
    <span class="n">do_a</span><span class="p">()</span>
<span class="n">something_else</span><span class="p">()</span>
</pre></div>
</div>
<p>Using statement coverage, a single test case where <code class="docutils literal notranslate"><span class="pre">CONDITION</span></code> is true suffices to cover the call to <code class="docutils literal notranslate"><span class="pre">do_a()</span></code>.  Using branch coverage, however, we would also have to create a test case where <code class="docutils literal notranslate"><span class="pre">do_a()</span></code> is <em>not</em> invoked.</p>
<p>Using our <code class="docutils literal notranslate"><span class="pre">Coverage</span></code> infrastructure, we can simulate branch coverage by considering <em>pairs of subsequent lines executed</em>.  The <code class="docutils literal notranslate"><span class="pre">trace()</span></code> method gives us the list of lines executed one after the other:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Coverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov</span><span class="p">:</span>
    <span class="n">cgi_decode</span><span class="p">(</span><span class="s2">&quot;a+b&quot;</span><span class="p">)</span>
<span class="n">trace</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>
<span class="n">trace</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39;cgi_decode&#39;, 8),
 (&#39;cgi_decode&#39;, 9),
 (&#39;cgi_decode&#39;, 8),
 (&#39;cgi_decode&#39;, 9),
 (&#39;cgi_decode&#39;, 8)]
</pre></div>
</div>
</div>
</div>
<section id="part-1-compute-branch-coverage">
<h4>Part 1: Compute branch coverage<a class="headerlink" href="#part-1-compute-branch-coverage" title="Link to this heading">#</a></h4>
<p>Define a function <code class="docutils literal notranslate"><span class="pre">branch_coverage()</span></code> that takes a trace and returns the set of pairs of subsequent lines in a trace – in the above example, this would be</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span><span class="p">(</span>
<span class="p">((</span><span class="s1">&#39;cgi_decode&#39;</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;cgi_decode&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)),</span>
<span class="p">((</span><span class="s1">&#39;cgi_decode&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;cgi_decode&#39;</span><span class="p">,</span> <span class="mi">11</span><span class="p">)),</span>
<span class="c1"># more_pairs</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Bonus for advanced Python programmers: Define <code class="docutils literal notranslate"><span class="pre">BranchCoverage</span></code> as a subclass of <code class="docutils literal notranslate"><span class="pre">Coverage</span></code> and make <code class="docutils literal notranslate"><span class="pre">branch_coverage()</span></code> as above a <code class="docutils literal notranslate"><span class="pre">coverage()</span></code> method of <code class="docutils literal notranslate"><span class="pre">BranchCoverage</span></code>.</p>
<p><strong>Solution.</strong>  Here’s a simple definition of <code class="docutils literal notranslate"><span class="pre">branch_coverage()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">branch_coverage</span><span class="p">(</span><span class="n">trace</span><span class="p">):</span>
    <span class="n">coverage</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">past_line</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">trace</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">past_line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">coverage</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">past_line</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
        <span class="n">past_line</span> <span class="o">=</span> <span class="n">line</span>

    <span class="k">return</span> <span class="n">coverage</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">branch_coverage</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{((&#39;cgi_decode&#39;, 8), (&#39;cgi_decode&#39;, 9)),
 ((&#39;cgi_decode&#39;, 8), (&#39;cgi_decode&#39;, 10)),
 ((&#39;cgi_decode&#39;, 8), (&#39;cgi_decode&#39;, 11)),
 ((&#39;cgi_decode&#39;, 8), (&#39;cgi_decode&#39;, 12)),
 ((&#39;cgi_decode&#39;, 8), (&#39;cgi_decode&#39;, 15)),
 ((&#39;cgi_decode&#39;, 9), (&#39;cgi_decode&#39;, 8)),
 ((&#39;cgi_decode&#39;, 10), (&#39;cgi_decode&#39;, 8)),
 ((&#39;cgi_decode&#39;, 11), (&#39;cgi_decode&#39;, 8)),
 ((&#39;cgi_decode&#39;, 12), (&#39;cgi_decode&#39;, 8)),
 ((&#39;cgi_decode&#39;, 15), (&#39;cgi_decode&#39;, 16)),
 ((&#39;cgi_decode&#39;, 16), (&#39;cgi_decode&#39;, 17)),
 ((&#39;cgi_decode&#39;, 17), (&#39;cgi_decode&#39;, 18)),
 ((&#39;cgi_decode&#39;, 17), (&#39;cgi_decode&#39;, 32)),
 ((&#39;cgi_decode&#39;, 18), (&#39;cgi_decode&#39;, 19)),
 ((&#39;cgi_decode&#39;, 19), (&#39;cgi_decode&#39;, 20)),
 ((&#39;cgi_decode&#39;, 19), (&#39;cgi_decode&#39;, 21)),
 ((&#39;cgi_decode&#39;, 20), (&#39;cgi_decode&#39;, 31)),
 ((&#39;cgi_decode&#39;, 21), (&#39;cgi_decode&#39;, 30)),
 ((&#39;cgi_decode&#39;, 30), (&#39;cgi_decode&#39;, 31)),
 ((&#39;cgi_decode&#39;, 31), (&#39;cgi_decode&#39;, 17))}
</pre></div>
</div>
</div>
</div>
<p>Here’s a definition as a class:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">BranchCoverage</span><span class="p">(</span><span class="n">Coverage</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">coverage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The set of executed line pairs&quot;&quot;&quot;</span>
        <span class="n">coverage</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">past_line</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">past_line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">coverage</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">past_line</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
            <span class="n">past_line</span> <span class="o">=</span> <span class="n">line</span>

        <span class="k">return</span> <span class="n">coverage</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="part-2-comparing-statement-coverage-and-branch-coverage">
<h4>Part 2: Comparing statement coverage and branch coverage<a class="headerlink" href="#part-2-comparing-statement-coverage-and-branch-coverage" title="Link to this heading">#</a></h4>
<p>Use <code class="docutils literal notranslate"><span class="pre">branch_coverage()</span></code> to repeat the experiments in this chapter with branch coverage rather than statement coverage.  Do the manually written test cases cover all branches?</p>
<p><strong>Solution.</strong> Let’s repeat the above experiments with <code class="docutils literal notranslate"><span class="pre">BranchCoverage</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">BranchCoverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov</span><span class="p">:</span>
    <span class="n">cgi_decode</span><span class="p">(</span><span class="s2">&quot;a+b&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">cov</span><span class="o">.</span><span class="n">coverage</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{((&#39;cgi_decode&#39;, 16), (&#39;cgi_decode&#39;, 17)), ((&#39;cgi_decode&#39;, 15), (&#39;cgi_decode&#39;, 16)), ((&#39;cgi_decode&#39;, 20), (&#39;cgi_decode&#39;, 31)), ((&#39;cgi_decode&#39;, 19), (&#39;cgi_decode&#39;, 21)), ((&#39;cgi_decode&#39;, 31), (&#39;cgi_decode&#39;, 17)), ((&#39;cgi_decode&#39;, 8), (&#39;cgi_decode&#39;, 9)), ((&#39;cgi_decode&#39;, 8), (&#39;cgi_decode&#39;, 15)), ((&#39;cgi_decode&#39;, 12), (&#39;cgi_decode&#39;, 8)), ((&#39;cgi_decode&#39;, 8), (&#39;cgi_decode&#39;, 10)), ((&#39;cgi_decode&#39;, 18), (&#39;cgi_decode&#39;, 19)), ((&#39;cgi_decode&#39;, 11), (&#39;cgi_decode&#39;, 8)), ((&#39;cgi_decode&#39;, 8), (&#39;cgi_decode&#39;, 11)), ((&#39;cgi_decode&#39;, 17), (&#39;cgi_decode&#39;, 32)), ((&#39;cgi_decode&#39;, 8), (&#39;cgi_decode&#39;, 12)), ((&#39;cgi_decode&#39;, 9), (&#39;cgi_decode&#39;, 8)), ((&#39;cgi_decode&#39;, 19), (&#39;cgi_decode&#39;, 20)), ((&#39;cgi_decode&#39;, 17), (&#39;cgi_decode&#39;, 18)), ((&#39;cgi_decode&#39;, 30), (&#39;cgi_decode&#39;, 31)), ((&#39;cgi_decode&#39;, 21), (&#39;cgi_decode&#39;, 30)), ((&#39;cgi_decode&#39;, 10), (&#39;cgi_decode&#39;, 8))}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">BranchCoverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov_plus</span><span class="p">:</span>
    <span class="n">cgi_decode</span><span class="p">(</span><span class="s2">&quot;a+b&quot;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">BranchCoverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov_standard</span><span class="p">:</span>
    <span class="n">cgi_decode</span><span class="p">(</span><span class="s2">&quot;abc&quot;</span><span class="p">)</span>

<span class="n">cov_plus</span><span class="o">.</span><span class="n">coverage</span><span class="p">()</span> <span class="o">-</span> <span class="n">cov_standard</span><span class="o">.</span><span class="n">coverage</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{((&#39;cgi_decode&#39;, 19), (&#39;cgi_decode&#39;, 20)),
 ((&#39;cgi_decode&#39;, 20), (&#39;cgi_decode&#39;, 31))}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">BranchCoverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov_max</span><span class="p">:</span>
    <span class="n">cgi_decode</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
    <span class="n">cgi_decode</span><span class="p">(</span><span class="s1">&#39;%20&#39;</span><span class="p">)</span>
    <span class="n">cgi_decode</span><span class="p">(</span><span class="s1">&#39;abc&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cgi_decode</span><span class="p">(</span><span class="s1">&#39;%?a&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cov_max</span><span class="o">.</span><span class="n">coverage</span><span class="p">()</span> <span class="o">-</span> <span class="n">cov_plus</span><span class="o">.</span><span class="n">coverage</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{((&#39;cgi_decode&#39;, 21), (&#39;cgi_decode&#39;, 22)),
 ((&#39;cgi_decode&#39;, 22), (&#39;cgi_decode&#39;, 23)),
 ((&#39;cgi_decode&#39;, 23), (&#39;cgi_decode&#39;, 24)),
 ((&#39;cgi_decode&#39;, 24), (&#39;cgi_decode&#39;, 25)),
 ((&#39;cgi_decode&#39;, 24), (&#39;cgi_decode&#39;, 28)),
 ((&#39;cgi_decode&#39;, 25), (&#39;cgi_decode&#39;, 26)),
 ((&#39;cgi_decode&#39;, 26), (&#39;cgi_decode&#39;, 31)),
 ((&#39;cgi_decode&#39;, 32), (&#39;cgi_decode&#39;, 8))}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;!7#%&quot;*#0=)$;%6*;&gt;638:*&gt;80&quot;=&lt;/&gt;(/*:-(2&lt;4 !:5*6856&amp;?&quot;&quot;11&lt;7+%&lt;%7,4.8,*+&amp;,,$,.&quot;&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">BranchCoverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov_fuzz</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cgi_decode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
<span class="n">cov_fuzz</span><span class="o">.</span><span class="n">coverage</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{((&#39;cgi_decode&#39;, 8), (&#39;cgi_decode&#39;, 9)),
 ((&#39;cgi_decode&#39;, 8), (&#39;cgi_decode&#39;, 10)),
 ((&#39;cgi_decode&#39;, 8), (&#39;cgi_decode&#39;, 11)),
 ((&#39;cgi_decode&#39;, 8), (&#39;cgi_decode&#39;, 12)),
 ((&#39;cgi_decode&#39;, 8), (&#39;cgi_decode&#39;, 15)),
 ((&#39;cgi_decode&#39;, 9), (&#39;cgi_decode&#39;, 8)),
 ((&#39;cgi_decode&#39;, 10), (&#39;cgi_decode&#39;, 8)),
 ((&#39;cgi_decode&#39;, 11), (&#39;cgi_decode&#39;, 8)),
 ((&#39;cgi_decode&#39;, 12), (&#39;cgi_decode&#39;, 8)),
 ((&#39;cgi_decode&#39;, 15), (&#39;cgi_decode&#39;, 16)),
 ((&#39;cgi_decode&#39;, 16), (&#39;cgi_decode&#39;, 17)),
 ((&#39;cgi_decode&#39;, 17), (&#39;cgi_decode&#39;, 18)),
 ((&#39;cgi_decode&#39;, 18), (&#39;cgi_decode&#39;, 19)),
 ((&#39;cgi_decode&#39;, 19), (&#39;cgi_decode&#39;, 20)),
 ((&#39;cgi_decode&#39;, 19), (&#39;cgi_decode&#39;, 21)),
 ((&#39;cgi_decode&#39;, 20), (&#39;cgi_decode&#39;, 31)),
 ((&#39;cgi_decode&#39;, 21), (&#39;cgi_decode&#39;, 22)),
 ((&#39;cgi_decode&#39;, 21), (&#39;cgi_decode&#39;, 30)),
 ((&#39;cgi_decode&#39;, 22), (&#39;cgi_decode&#39;, 23)),
 ((&#39;cgi_decode&#39;, 23), (&#39;cgi_decode&#39;, 24)),
 ((&#39;cgi_decode&#39;, 24), (&#39;cgi_decode&#39;, 28)),
 ((&#39;cgi_decode&#39;, 30), (&#39;cgi_decode&#39;, 31)),
 ((&#39;cgi_decode&#39;, 31), (&#39;cgi_decode&#39;, 17))}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cov_max</span><span class="o">.</span><span class="n">coverage</span><span class="p">()</span> <span class="o">-</span> <span class="n">cov_fuzz</span><span class="o">.</span><span class="n">coverage</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{((&#39;cgi_decode&#39;, 17), (&#39;cgi_decode&#39;, 32)),
 ((&#39;cgi_decode&#39;, 24), (&#39;cgi_decode&#39;, 25)),
 ((&#39;cgi_decode&#39;, 25), (&#39;cgi_decode&#39;, 26)),
 ((&#39;cgi_decode&#39;, 26), (&#39;cgi_decode&#39;, 31)),
 ((&#39;cgi_decode&#39;, 32), (&#39;cgi_decode&#39;, 8))}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">population_branch_coverage</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>
    <span class="n">cumulative_coverage</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_coverage</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">population</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">BranchCoverage</span><span class="p">()</span> <span class="k">as</span> <span class="n">cov</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">function</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">all_coverage</span> <span class="o">|=</span> <span class="n">cov</span><span class="o">.</span><span class="n">coverage</span><span class="p">()</span>
        <span class="n">cumulative_coverage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_coverage</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">all_coverage</span><span class="p">,</span> <span class="n">cumulative_coverage</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_branch_coverage</span><span class="p">,</span> <span class="n">cumulative_branch_coverage</span> <span class="o">=</span> <span class="n">population_branch_coverage</span><span class="p">(</span>
    <span class="n">hundred_inputs</span><span class="p">(),</span> <span class="n">cgi_decode</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cumulative_branch_coverage</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Branch coverage of cgi_decode() with random inputs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;# of inputs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;line pairs covered&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;line pairs covered&#39;)
</pre></div>
</div>
<img alt="_images/22a05e9790bd3a9f8d119c418761aa3b6b327fd256ab138783beba674612da85.png" src="_images/22a05e9790bd3a9f8d119c418761aa3b6b327fd256ab138783beba674612da85.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">cov_max</span><span class="o">.</span><span class="n">coverage</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>28
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_branch_coverage</span> <span class="o">-</span> <span class="n">cov_max</span><span class="o">.</span><span class="n">coverage</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>set()
</pre></div>
</div>
</div>
</div>
<p>The additional coverage comes from the exception raised via an illegal input (say, <code class="docutils literal notranslate"><span class="pre">%g</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cov_max</span><span class="o">.</span><span class="n">coverage</span><span class="p">()</span> <span class="o">-</span> <span class="n">all_branch_coverage</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{((&#39;cgi_decode&#39;, 32), (&#39;cgi_decode&#39;, 8))}
</pre></div>
</div>
</div>
</div>
<p>This is an artifact coming from the subsequent execution of <code class="docutils literal notranslate"><span class="pre">cgi_decode()</span></code> when computing <code class="docutils literal notranslate"><span class="pre">cov_max</span></code>.</p>
</section>
<section id="part-3-average-coverage">
<h4>Part 3: Average coverage<a class="headerlink" href="#part-3-average-coverage" title="Link to this heading">#</a></h4>
<p>Again, repeat the above experiments with branch coverage.  Does <code class="docutils literal notranslate"><span class="pre">fuzzer()</span></code> cover all branches, and if so, how many tests does it take on average?</p>
<p><strong>Solution.</strong> We repeat the experiments we ran with line coverage with branch coverage.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">runs</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># Create an array with TRIALS elements, all zero</span>
<span class="n">sum_coverage</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">trials</span>

<span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">runs</span><span class="p">):</span>
    <span class="n">all_branch_coverage</span><span class="p">,</span> <span class="n">coverage</span> <span class="o">=</span> <span class="n">population_branch_coverage</span><span class="p">(</span>
        <span class="n">hundred_inputs</span><span class="p">(),</span> <span class="n">cgi_decode</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">coverage</span><span class="p">)</span> <span class="o">==</span> <span class="n">trials</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trials</span><span class="p">):</span>
        <span class="n">sum_coverage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">coverage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="n">average_coverage</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trials</span><span class="p">):</span>
    <span class="n">average_coverage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sum_coverage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">runs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">average_coverage</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Average branch coverage of cgi_decode() with random inputs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;# of inputs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;line pairs covered&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;line pairs covered&#39;)
</pre></div>
</div>
<img alt="_images/31d48af6efcb062df8f3de23a2c32583c2d9fffc331e63f1bda6b45342ab510f.png" src="_images/31d48af6efcb062df8f3de23a2c32583c2d9fffc331e63f1bda6b45342ab510f.png" />
</div>
</div>
<p>We see that achieving branch coverage takes longer than statement coverage; it simply is a more difficult criterion to satisfy with random inputs.</p>
</section>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Fuzzer.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Fuzzing: Breaking Things with Random Inputs</p>
      </div>
    </a>
    <a class="right-next"
       href="MutationFuzzer.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Mutation-Based Fuzzing</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-cgi-decoder">A CGI Decoder</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#black-box-testing">Black-Box Testing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#white-box-testing">White-Box Testing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tracing-executions">Tracing Executions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-coverage-class">A Coverage Class</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-coverage">Comparing Coverage</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#coverage-of-basic-fuzzing">Coverage of Basic Fuzzing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-coverage-from-external-programs">Getting Coverage from External Programs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#finding-errors-with-basic-fuzzing">Finding Errors with Basic Fuzzing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-fixing-cgi-decode">Exercise 1: Fixing <code class="docutils literal notranslate"><span class="pre">cgi_decode()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-branch-coverage">Exercise 2: Branch Coverage</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-compute-branch-coverage">Part 1: Compute branch coverage</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-comparing-statement-coverage-and-branch-coverage">Part 2: Comparing statement coverage and branch coverage</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3-average-coverage">Part 3: Average coverage</a></li>
</ul>
</li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Andreas Zeller, Rahul Gopinath, Marcel Böhme, Gordon Fraser, and Christian Holler
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <div>
  Copyright &copy; 2021–2025 <a href="https://www.cispa.de/">CISPA Helmholtz Center for Information Security</a>. Copyright &copy; 2018-2020 <a href="https://www.uni-saarland.de/">Saarland University</a>. Copyright &copy; 2018-2025 external contributors.
  The <strong>content</strong> of this project is licensed under the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
  The <strong>source code</strong> that is part of the content, as well as the source code used to format and display that content is licensed under the <a href="https://github.com/uds-se/fuzzingbook/blob/master/LICENSE.md#mit-license">MIT License</a>.
  <br>
  <a href="https://cispa.de/en/impressum">Imprint</a> &middot; <a href="/html/index.html#how-do-i-cite-your-work">Cite</a>
</div>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>