
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Tracking Information Flow &#8212; The Fuzzing Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=42e1b1a5" />
    <link rel="stylesheet" type="text/css" href="_static/mastodon-timeline.css?v=f82c2b23" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'InformationFlow';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Concolic Fuzzing" href="ConcolicFuzzer.html" />
    <link rel="prev" title="Mining Input Grammars" href="GrammarMiner.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content"><p>This is a beta version of fuzzingbook.org, currently in development. See the <a href="https://fuzzingbook.org/"  style="color:white!important;">classic site</a> for resources.</p></div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/fuzzingbook.png" class="logo__image only-light" alt="The Fuzzing Book - Home"/>
    <script>document.write(`<img src="_static/fuzzingbook.png" class="logo__image only-dark" alt="The Fuzzing Book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    The Fuzzing Book
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tours.html">Tours through the Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="Intro_Testing.html">Introduction to Software Testing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Lexical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Fuzzer.html">Fuzzing: Breaking Things with Random Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Coverage.html">Code Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="MutationFuzzer.html">Mutation-Based Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GreyboxFuzzer.html">Greybox Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="SearchBasedFuzzer.html">Search-Based Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="MutationAnalysis.html">Mutation Analysis</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Syntactical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Grammars.html">Fuzzing with Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarFuzzer.html">Efficient Grammar Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarCoverageFuzzer.html">Grammar Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="Parser.html">Parsing Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ProbabilisticGrammarFuzzer.html">Probabilistic Grammar Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GeneratorGrammarFuzzer.html">Fuzzing with Generators</a></li>

<li class="toctree-l1"><a class="reference internal" href="GreyboxGrammarFuzzer.html">Greybox Fuzzing with Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="Reducer.html">Reducing Failure-Inducing Inputs</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Semantical Fuzzing</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="FuzzingWithConstraints.html">Fuzzing with Constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarMiner.html">Mining Input Grammars</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Tracking Information Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="ConcolicFuzzer.html">Concolic Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="SymbolicFuzzer.html">Symbolic Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="DynamicInvariants.html">Mining Function Specifications</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Domain-Specific Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ConfigurationFuzzer.html">Testing Configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="APIFuzzer.html">Fuzzing APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Carver.html">Carving Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="PythonFuzzer.html">Testing Compilers</a></li>
<li class="toctree-l1"><a class="reference internal" href="WebFuzzer.html">Testing Web Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="GUIFuzzer.html">Testing Graphical User Interfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Managing Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="FuzzingInTheLarge.html">Fuzzing in the Large</a></li>
<li class="toctree-l1"><a class="reference internal" href="WhenToStopFuzzing.html">When To Stop Fuzzing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="AcademicPrototyping.html">Academic Prototyping</a></li>
<li class="toctree-l1"><a class="reference internal" href="PrototypingWithPython.html">Prototyping with Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="ExpectError.html">Error Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timer.html">Timer</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timeout.html">Timeout</a></li>
<li class="toctree-l1"><a class="reference internal" href="ClassDiagram.html">Class Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="RailroadDiagrams.html">Railroad Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="ControlFlow.html">Control Flow Graph</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About This Book</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ReleaseNotes.html">Fuzzingbook Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="Importing.html">Using Fuzzingbook Code in your own Programs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Guide_for_Authors.html">Guide for Authors</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/master?urlpath=tree/docs/notebooks/InformationFlow.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/uds-se/fuzzingbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/uds-se/fuzzingbook/issues/new?title=Issue%20on%20page%20%2FInformationFlow.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/InformationFlow.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Tracking Information Flow</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tracking-string-taints">Tracking String Taints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tracking-character-origins">Tracking Character Origins</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-vulnerable-database">A Vulnerable Database</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#representing-tables">Representing Tables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#executing-sql-statements">Executing SQL Statements</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-sql-statements">Excursion: Implementing SQL Statements</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#selecting-data">Selecting Data</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#inserting-data">Inserting Data</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#updating-data">Updating Data</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#deleting-data">Deleting Data</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#end-of-excursion">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fuzzing-sql">Fuzzing SQL</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-defining-a-sql-grammar">Excursion: Defining a SQL grammar</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-evil-of-eval">The Evil of Eval</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Tracking String Taints</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-class-for-tainted-strings">A Class for Tainted Strings</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#string-operators">String Operators</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tracking-untrusted-input">Tracking Untrusted Input</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#taint-aware-fuzzing">Taint Aware Fuzzing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tainteddb">TaintedDB</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preventing-privacy-leaks">Preventing Privacy Leaks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tracking-individual-characters">Tracking Individual Characters</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-class-for-tracking-character-origins">A Class for Tracking Character Origins</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-string-methods">Excursion: Implementing String Methods</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create">Create</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#index">Index</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#slices">Slices</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#splits">Splits</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#concatenation">Concatenation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-origin-string">Extract Origin String</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#replace">Replace</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#split">Split</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#strip">Strip</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#expand-tabs">Expand Tabs</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#partitions">Partitions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#justify">Justify</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#mod">mod</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#string-methods-that-do-not-change-origin">String methods that do not change origin</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#general-wrappers">General wrappers</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#methods-yet-to-be-translated">Methods yet to be translated</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-origins">Checking Origins</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#privacy-leaks-revisited">Privacy Leaks Revisited</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#taint-directed-fuzzing">Taint-Directed Fuzzing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#trackingdb">TrackingDB</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#taintedgrammarfuzzer">TaintedGrammarFuzzer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-limits-of-taint-tracking">The Limits of Taint Tracking</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#conversions">Conversions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#internal-c-libraries">Internal C libraries</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#implicit-information-flow">Implicit Information Flow</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#enforcing-tainting">Enforcing Tainting</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Synopsis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Tracking String Taints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Tracking Character Origins</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-tainted-numbers">Exercise 1: Tainted Numbers</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-creation">Part 1: Creation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-arithmetic-expressions">Part 2: Arithmetic expressions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3-passing-taints-from-integers-to-strings">Part 3: Passing taints from integers to strings</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-4-passing-taints-from-strings-to-integers">Part 4: Passing taints from strings to integers</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-information-flow-testing">Exercise 2: Information Flow Testing</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="tracking-information-flow">
<h1>Tracking Information Flow<a class="headerlink" href="#tracking-information-flow" title="Link to this heading">#</a></h1>
<p>We have explored how one could generate better inputs that can penetrate deeper into the program in question. While doing so, we have relied on program crashes to tell us that we have succeeded in finding problems in the program. However, that is rather simplistic. What if the behavior of the program is simply incorrect, but does not lead to a crash? Can one do better?</p>
<p>In this chapter, we explore in depth how to track information flows in Python, and how these flows can be used to determine whether a program behaved as expected.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bookutils</span> <span class="kn">import</span> <span class="n">YouTubeVideo</span>
<span class="n">YouTubeVideo</span><span class="p">(</span><span class="s1">&#39;WZi0dTvJ2Ug&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="640"
            height="360"
            src="https://www.youtube-nocookie.com/embed/WZi0dTvJ2Ug"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<p><strong>Prerequisites</strong></p>
<ul class="simple">
<li><p>You should have read the <a class="reference internal" href="Coverage.html"><span class="std std-doc">chapter on coverage</span></a>.</p></li>
<li><p>You should have read the <a class="reference internal" href="ProbabilisticGrammarFuzzer.html"><span class="std std-doc">chapter on probabilistic fuzzing</span></a>.</p></li>
</ul>
<p>We first set up our infrastructure so that we can make use of previously defined functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bookutils.setup</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
</pre></div>
</div>
</div>
</div>
<section id="synopsis">
<h2>Synopsis<a class="headerlink" href="#synopsis" title="Link to this heading">#</a></h2>
<!-- Automatically generated. Do not edit. -->
<p>To <a class="reference internal" href="Importing.html"><span class="std std-doc">use the code provided in this chapter</span></a>, write</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fuzzingbook.InformationFlow</span> <span class="kn">import</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>and then make use of the following features.</p>
<p>This chapter provides two wrappers to Python <em>strings</em> that allow one to track various properties. These include information on the security properties of the input, and information on originating indexes of the input string.</p>
<section id="tracking-string-taints">
<h3>Tracking String Taints<a class="headerlink" href="#tracking-string-taints" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">tstr</span></code> objects are replacements for Python strings that allows tracking and checking <em>taints</em> – that is, information on from where a string originated. For instance, one can mark strings that originate from third party input with a taint of “LOW”, meaning that they have a low security level. The taint is passed in the constructor of a <code class="docutils literal notranslate"><span class="pre">tstr</span></code> object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">thello</span> <span class="o">=</span> <span class="n">tstr</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;LOW&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">tstr</span></code> object is fully compatible with original Python strings. For instance, we can index it and access substrings:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">thello</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
<span class="go">&#39;hell&#39;</span>
</pre></div>
</div>
<p>However, the <code class="docutils literal notranslate"><span class="pre">tstr</span></code> object also stores the taint, which can be accessed using the <code class="docutils literal notranslate"><span class="pre">taint</span></code> attribute:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">thello</span><span class="o">.</span><span class="n">taint</span>
<span class="go">&#39;LOW&#39;</span>
</pre></div>
</div>
<p>The neat thing about taints is that they propagate to all strings derived from the original tainted string.
Indeed, any operation from a  <code class="docutils literal notranslate"><span class="pre">tstr</span></code> string that results in a string fragment produces another <code class="docutils literal notranslate"><span class="pre">tstr</span></code> object that includes the original taint. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">thello</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">taint</span>  <span class="c1"># type: ignore</span>
<span class="go">&#39;LOW&#39;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">tstr</span></code> objects duplicate most <code class="docutils literal notranslate"><span class="pre">str</span></code> methods, as indicated in the class diagram:</p>
<p><img alt="" src="_images/InformationFlow-synopsis-1.svg" /></p>
</section>
<section id="tracking-character-origins">
<h3>Tracking Character Origins<a class="headerlink" href="#tracking-character-origins" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">ostr</span></code> objects extend <code class="docutils literal notranslate"><span class="pre">tstr</span></code> objects by not only tracking a taint, but also the originating <em>indexes</em> from the input string, This allows you to exactly track where individual characters came from. Assume you have a long string, which at index 100 contains the password <code class="docutils literal notranslate"><span class="pre">&quot;joshua1234&quot;</span></code>. Then you can save this origin information using an <code class="docutils literal notranslate"><span class="pre">ostr</span></code> as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">secret</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">&quot;joshua1234&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;SECRET&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">origin</span></code> attribute of an <code class="docutils literal notranslate"><span class="pre">ostr</span></code> provides access to a list of indexes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">secret</span><span class="o">.</span><span class="n">origin</span>
<span class="go">[100, 101, 102, 103, 104, 105, 106, 107, 108, 109]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">secret</span><span class="o">.</span><span class="n">taint</span>
<span class="go">&#39;SECRET&#39;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ostr</span></code> objects are compatible with Python strings, except that string operations return <code class="docutils literal notranslate"><span class="pre">ostr</span></code> objects (together with the saved origin an index information). An index of <code class="docutils literal notranslate"><span class="pre">-1</span></code> indicates that the corresponding character has no origin as supplied to the <code class="docutils literal notranslate"><span class="pre">ostr()</span></code> constructor:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">secret_substr</span> <span class="o">=</span> <span class="p">(</span><span class="n">secret</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">secret</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">secret_substr</span><span class="o">.</span><span class="n">taint</span>
<span class="go">&#39;SECRET&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">secret_substr</span><span class="o">.</span><span class="n">origin</span>
<span class="go">[100, 101, 102, 103, -1, 106, 107, 108, 109]</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ostr</span></code> objects duplicate most <code class="docutils literal notranslate"><span class="pre">str</span></code> methods, as indicated in the class diagram:</p>
<p><img alt="" src="_images/InformationFlow-synopsis-2.svg" /></p>
</section>
</section>
<section id="a-vulnerable-database">
<h2>A Vulnerable Database<a class="headerlink" href="#a-vulnerable-database" title="Link to this heading">#</a></h2>
<p>Say we want to implement an <em>in-memory database</em> service in Python. Here is a rather flimsy attempt. We use the following dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">INVENTORY</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">1997,van,Ford,E350</span>
<span class="s2">2000,car,Mercury,Cougar</span>
<span class="s2">1999,car,Chevy,Venture</span><span class="se">\</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">VEHICLES</span> <span class="o">=</span> <span class="n">INVENTORY</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Our DB is a Python class that parses its arguments and throws <code class="docutils literal notranslate"><span class="pre">SQLException</span></code> which is defined below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SQLException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<p>The database is simply a Python <code class="docutils literal notranslate"><span class="pre">dict</span></code> that is exposed only through SQL queries.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DB</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="p">{}):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="representing-tables">
<h3>Representing Tables<a class="headerlink" href="#representing-tables" title="Link to this heading">#</a></h3>
<p>The database contains tables, which are created by a method call <code class="docutils literal notranslate"><span class="pre">create_table()</span></code>. Each table data structure is a pair of values. The first one is the meta data containing column names and types. The second value is a list of values in the table.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">defs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">defs</span><span class="p">,</span> <span class="p">[])</span>
</pre></div>
</div>
</div>
</div>
<p>The table can be retrieved using the name using the <code class="docutils literal notranslate"><span class="pre">table()</span></code> method call.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">t_name</span><span class="p">]</span>
        <span class="k">raise</span> <span class="n">SQLException</span><span class="p">(</span><span class="s1">&#39;Table (</span><span class="si">%s</span><span class="s1">) was not found&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">t_name</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Here is an example of how to use both.  We fill a table <code class="docutils literal notranslate"><span class="pre">inventory</span></code> with four columns: <code class="docutils literal notranslate"><span class="pre">year</span></code>, <code class="docutils literal notranslate"><span class="pre">kind</span></code>, <code class="docutils literal notranslate"><span class="pre">company</span></code>, and <code class="docutils literal notranslate"><span class="pre">model</span></code>.  Initially, our table is empty.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sample_db</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DB</span><span class="p">()</span>
    <span class="n">inventory_def</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;company&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">}</span>
    <span class="n">db</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="s1">&#39;inventory&#39;</span><span class="p">,</span> <span class="n">inventory_def</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">db</span>
</pre></div>
</div>
</div>
</div>
<p>Using <code class="docutils literal notranslate"><span class="pre">table()</span></code>, we can retrieve the table definition as well as its contents.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">sample_db</span><span class="p">()</span>
<span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;inventory&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>({&#39;year&#39;: int, &#39;kind&#39;: str, &#39;company&#39;: str, &#39;model&#39;: str}, [])
</pre></div>
</div>
</div>
</div>
<p>We also define <code class="docutils literal notranslate"><span class="pre">column()</span></code> for retrieving the column definition from a table declaration.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_decl</span><span class="p">,</span> <span class="n">c_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">c_name</span> <span class="ow">in</span> <span class="n">table_decl</span><span class="p">:</span> 
            <span class="k">return</span> <span class="n">table_decl</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span>
        <span class="k">raise</span> <span class="n">SQLException</span><span class="p">(</span><span class="s1">&#39;Column (</span><span class="si">%s</span><span class="s1">) was not found&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">c_name</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">sample_db</span><span class="p">()</span>
<span class="n">decl</span><span class="p">,</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;inventory&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="n">decl</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>int
</pre></div>
</div>
</div>
</div>
</section>
<section id="executing-sql-statements">
<h3>Executing SQL Statements<a class="headerlink" href="#executing-sql-statements" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">sql()</span></code> method of <code class="docutils literal notranslate"><span class="pre">DB</span></code> executes SQL statements.  It inspects its arguments, and dispatches the query based on the kind of SQL statement to be executed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">do_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">do_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">do_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;select &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_select</span><span class="p">),</span>
                   <span class="p">(</span><span class="s1">&#39;update &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_update</span><span class="p">),</span>
                   <span class="p">(</span><span class="s1">&#39;insert into &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_insert</span><span class="p">),</span>
                   <span class="p">(</span><span class="s1">&#39;delete from&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_delete</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="n">query</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">):])</span>
        <span class="k">raise</span> <span class="n">SQLException</span><span class="p">(</span><span class="s1">&#39;Unknown SQL (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">query</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s an example of how to use the <code class="docutils literal notranslate"><span class="pre">DB</span></code> class:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">some_db</span> <span class="o">=</span> <span class="n">DB</span><span class="p">()</span>
<span class="n">some_db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;select year from inventory&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>However, at this point, the individual methods for handling SQL statements are not yet defined. Let us do this in the next steps.</p>
</section>
<section id="excursion-implementing-sql-statements">
<h3>Excursion: Implementing SQL Statements<a class="headerlink" href="#excursion-implementing-sql-statements" title="Link to this heading">#</a></h3>
<section id="selecting-data">
<h4>Selecting Data<a class="headerlink" href="#selecting-data" title="Link to this heading">#</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">do_select()</span></code> method handles SQL <code class="docutils literal notranslate"><span class="pre">select</span></code> statements to retrieve data from a table.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">FROM</span><span class="p">,</span> <span class="n">WHERE</span> <span class="o">=</span> <span class="s1">&#39; from &#39;</span><span class="p">,</span> <span class="s1">&#39; where &#39;</span>
        <span class="n">table_start</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">FROM</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">table_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SQLException</span><span class="p">(</span><span class="s1">&#39;no table specified&#39;</span><span class="p">)</span>

        <span class="n">where_start</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">WHERE</span><span class="p">)</span>
        <span class="n">select</span> <span class="o">=</span> <span class="n">query</span><span class="p">[:</span><span class="n">table_start</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">where_start</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">t_name</span> <span class="o">=</span> <span class="n">query</span><span class="p">[</span><span class="n">table_start</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">FROM</span><span class="p">):</span><span class="n">where_start</span><span class="p">]</span>
            <span class="n">where</span> <span class="o">=</span> <span class="n">query</span><span class="p">[</span><span class="n">where_start</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">WHERE</span><span class="p">):]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t_name</span> <span class="o">=</span> <span class="n">query</span><span class="p">[</span><span class="n">table_start</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">FROM</span><span class="p">):]</span>
            <span class="n">where</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">t_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">where</span><span class="p">:</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression_clause</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">where</span><span class="p">)</span>
            <span class="n">selected_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">hm</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">hm</span> <span class="ow">in</span> <span class="n">selected</span> <span class="k">if</span> <span class="n">data</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">selected_rows</span> <span class="o">=</span> <span class="n">table</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression_clause</span><span class="p">(</span><span class="n">selected_rows</span><span class="p">,</span> <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">select</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">data</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">hm</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">expression_clause()</span></code> method is used for two purposes:</p>
<ol class="arabic simple">
<li><p>In the form <code class="docutils literal notranslate"><span class="pre">select</span></code> <span class="math notranslate nohighlight">\(x\)</span>, <span class="math notranslate nohighlight">\(y\)</span>, <span class="math notranslate nohighlight">\(z\)</span> <code class="docutils literal notranslate"><span class="pre">from</span></code> <span class="math notranslate nohighlight">\(t\)</span>, it <em>evaluates</em> (and returns) the expressions <span class="math notranslate nohighlight">\(x\)</span>, <span class="math notranslate nohighlight">\(y\)</span>, <span class="math notranslate nohighlight">\(z\)</span> in the contexts of the selected rows.</p></li>
<li><p>If a clause <code class="docutils literal notranslate"><span class="pre">where</span></code> <span class="math notranslate nohighlight">\(p\)</span> is given, it also evaluates <span class="math notranslate nohighlight">\(p\)</span> in the context of the rows and includes the rows in the selection only if <span class="math notranslate nohighlight">\(p\)</span> holds.</p></li>
</ol>
<p>To evaluate expressions like <span class="math notranslate nohighlight">\(x\)</span>, <span class="math notranslate nohighlight">\(y\)</span>, <span class="math notranslate nohighlight">\(z\)</span> or <span class="math notranslate nohighlight">\(p\)</span>, the method <code class="docutils literal notranslate"><span class="pre">expression_clause()</span></code> makes use of the Python <code class="docutils literal notranslate"><span class="pre">eval()</span></code> evaluation function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">expression_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">statement</span><span class="p">):</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">hm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
            <span class="n">selected</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_eval</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="p">{},</span> <span class="n">hm</span><span class="p">),</span> <span class="n">hm</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">selected</span>
</pre></div>
</div>
</div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">eval()</span></code> fails for whatever reason, we raise an exception:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">my_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SQLException</span><span class="p">(</span><span class="s1">&#39;Invalid WHERE (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">statement</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Note:</strong> Using <code class="docutils literal notranslate"><span class="pre">eval()</span></code> here introduces some important security issues, which we will discuss later in this chapter.</p>
<p>Here’s how we can use <code class="docutils literal notranslate"><span class="pre">sql()</span></code> to issue a query.  Note that the table is yet empty.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">sample_db</span><span class="p">()</span>
<span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;select year from inventory&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">sample_db</span><span class="p">()</span>
<span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;select year from inventory where year == 2018&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
</section>
<section id="inserting-data">
<h4>Inserting Data<a class="headerlink" href="#inserting-data" title="Link to this heading">#</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">do_insert()</span></code> method handles SQL <code class="docutils literal notranslate"><span class="pre">insert</span></code> statements.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">VALUES</span> <span class="o">=</span> <span class="s1">&#39; values &#39;</span>
        <span class="n">table_end</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span>
        <span class="n">t_name</span> <span class="o">=</span> <span class="n">query</span><span class="p">[:</span><span class="n">table_end</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">names_end</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
        <span class="n">decls</span><span class="p">,</span> <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">t_name</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">query</span><span class="p">[</span><span class="n">table_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">names_end</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>

        <span class="c1"># verify columns exist</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="n">decls</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

        <span class="n">values_start</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">VALUES</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">values_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SQLException</span><span class="p">(</span><span class="s1">&#39;Invalid INSERT (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>

        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">query</span><span class="p">[</span><span class="n">values_start</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">VALUES</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SQLException</span><span class="p">(</span>
                <span class="s1">&#39;names(</span><span class="si">%s</span><span class="s1">) != values(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">names</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">values</span><span class="p">)))</span>

        <span class="c1"># dict lookups happen in C code, so we can&#39;t use that</span>
        <span class="n">kvs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">kval</span> <span class="ow">in</span> <span class="n">decls</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">kvs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">kval</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kvs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>In SQL, a column can come in any supported data type.  To ensure it is stored using the type originally declared, we need the ability to convert the values to specific types which is provided by <code class="docutils literal notranslate"><span class="pre">convert()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ast</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cast</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SQLException</span><span class="p">(</span><span class="s1">&#39;Invalid Conversion </span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cast</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Here is an example of how to use the SQL <code class="docutils literal notranslate"><span class="pre">insert</span></code> command:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">sample_db</span><span class="p">()</span>
<span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;insert into inventory (year, kind, company, model) values (1997, &quot;van&quot;, &quot;Ford&quot;, &quot;E350&quot;)&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;inventory&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>({&#39;year&#39;: int, &#39;kind&#39;: str, &#39;company&#39;: str, &#39;model&#39;: str},
 [{&#39;year&#39;: 1997, &#39;kind&#39;: &#39;van&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;}])
</pre></div>
</div>
</div>
</div>
<p>With the database filled, we can also run more complex queries:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;select year + 1, kind from inventory&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(1998, &#39;van&#39;)]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;select year, kind from inventory where year == 1997&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(1997, &#39;van&#39;)]
</pre></div>
</div>
</div>
</div>
</section>
<section id="updating-data">
<h4>Updating Data<a class="headerlink" href="#updating-data" title="Link to this heading">#</a></h4>
<p>Similarly, <code class="docutils literal notranslate"><span class="pre">do_update()</span></code> handles SQL <code class="docutils literal notranslate"><span class="pre">update</span></code> statements.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">SET</span><span class="p">,</span> <span class="n">WHERE</span> <span class="o">=</span> <span class="s1">&#39; set &#39;</span><span class="p">,</span> <span class="s1">&#39; where &#39;</span>
        <span class="n">table_end</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">SET</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">table_end</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SQLException</span><span class="p">(</span><span class="s1">&#39;Invalid UPDATE (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>

        <span class="n">set_end</span> <span class="o">=</span> <span class="n">table_end</span> <span class="o">+</span> <span class="mi">5</span>
        <span class="n">t_name</span> <span class="o">=</span> <span class="n">query</span><span class="p">[:</span><span class="n">table_end</span><span class="p">]</span>
        <span class="n">decls</span><span class="p">,</span> <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">t_name</span><span class="p">)</span>
        <span class="n">names_end</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">WHERE</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">names_end</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">query</span><span class="p">[</span><span class="n">set_end</span><span class="p">:</span><span class="n">names_end</span><span class="p">]</span>
            <span class="n">where</span> <span class="o">=</span> <span class="n">query</span><span class="p">[</span><span class="n">names_end</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">WHERE</span><span class="p">):]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">query</span><span class="p">[</span><span class="n">set_end</span><span class="p">:]</span>
            <span class="n">where</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">sets</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>

        <span class="c1"># verify columns exist</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sets</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="n">decls</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">where</span><span class="p">:</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression_clause</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">where</span><span class="p">)</span>
            <span class="n">updated</span> <span class="o">=</span> <span class="p">[</span><span class="n">hm</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">hm</span> <span class="ow">in</span> <span class="n">selected</span> <span class="k">if</span> <span class="n">d</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">updated</span> <span class="o">=</span> <span class="n">table</span>

        <span class="k">for</span> <span class="n">hm</span> <span class="ow">in</span> <span class="n">updated</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sets</span><span class="p">:</span>
                <span class="c1"># we can not do dict lookups because it is implemented in C.</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">kval</span> <span class="ow">in</span> <span class="n">decls</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">k</span><span class="p">:</span>
                        <span class="n">hm</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">kval</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> records were updated&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">updated</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here is an example.  Let us first fill the database again with values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">sample_db</span><span class="p">()</span>
<span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;insert into inventory (year, kind, company, model) values (1997, &quot;van&quot;, &quot;Ford&quot;, &quot;E350&quot;)&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;select year from inventory&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1997]
</pre></div>
</div>
</div>
</div>
<p>Now we can update things:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;update inventory set year = 1998 where year == 1997&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;select year from inventory&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1998]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;inventory&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>({&#39;year&#39;: int, &#39;kind&#39;: str, &#39;company&#39;: str, &#39;model&#39;: str},
 [{&#39;year&#39;: 1998, &#39;kind&#39;: &#39;van&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;}])
</pre></div>
</div>
</div>
</div>
</section>
<section id="deleting-data">
<h4>Deleting Data<a class="headerlink" href="#deleting-data" title="Link to this heading">#</a></h4>
<p>Finally, SQL <code class="docutils literal notranslate"><span class="pre">delete</span></code> statements are handled by <code class="docutils literal notranslate"><span class="pre">do_delete()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">WHERE</span> <span class="o">=</span> <span class="s1">&#39; where &#39;</span>
        <span class="n">table_end</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">WHERE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">table_end</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SQLException</span><span class="p">(</span><span class="s1">&#39;Invalid DELETE (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">query</span><span class="p">)</span>

        <span class="n">t_name</span> <span class="o">=</span> <span class="n">query</span><span class="p">[:</span><span class="n">table_end</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">t_name</span><span class="p">)</span>
        <span class="n">where</span> <span class="o">=</span> <span class="n">query</span><span class="p">[</span><span class="n">table_end</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">WHERE</span><span class="p">):]</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression_clause</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">where</span><span class="p">)</span>
        <span class="n">deleted</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">hm</span> <span class="ow">in</span> <span class="n">selected</span> <span class="k">if</span> <span class="n">d</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">deleted</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> records were deleted&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">deleted</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here is an example.  Let us first fill the database again with values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">sample_db</span><span class="p">()</span>
<span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;insert into inventory (year, kind, company, model) values (1997, &quot;van&quot;, &quot;Ford&quot;, &quot;E350&quot;)&#39;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;select year from inventory&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1997]
</pre></div>
</div>
</div>
</div>
<p>Now we can delete data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;delete from inventory where company == &quot;Ford&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;1 records were deleted&#39;
</pre></div>
</div>
</div>
</div>
<p>Our database is now empty:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;select year from inventory&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="end-of-excursion">
<h3>End of Excursion<a class="headerlink" href="#end-of-excursion" title="Link to this heading">#</a></h3>
<p>Here is how our database can be used.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DB</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We first create a table in our database with the correct data types.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inventory_def</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;company&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">}</span>
<span class="n">db</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="s1">&#39;inventory&#39;</span><span class="p">,</span> <span class="n">inventory_def</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here is a simple convenience function to update the table using our dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">update_inventory</span><span class="p">(</span><span class="n">sqldb</span><span class="p">,</span> <span class="n">vehicle</span><span class="p">):</span>
    <span class="n">inventory_def</span> <span class="o">=</span> <span class="n">sqldb</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s1">&#39;inventory&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">inventory_def</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="k">for</span> <span class="n">cast</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))]</span>
    <span class="n">sqldb</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;insert into inventory (</span><span class="si">%s</span><span class="s1">) values (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">k</span><span class="p">),</span>
                                                          <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">V</span> <span class="ow">in</span> <span class="n">VEHICLES</span><span class="p">:</span>
    <span class="n">update_inventory</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Our database now contains the same dataset as <code class="docutils literal notranslate"><span class="pre">VEHICLES</span></code> under <code class="docutils literal notranslate"><span class="pre">INVENTORY</span></code> table.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">db</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;inventory&#39;: ({&#39;year&#39;: int, &#39;kind&#39;: str, &#39;company&#39;: str, &#39;model&#39;: str},
  [{&#39;year&#39;: 1997, &#39;kind&#39;: &#39;van&#39;, &#39;company&#39;: &#39;Ford&#39;, &#39;model&#39;: &#39;E350&#39;},
   {&#39;year&#39;: 2000, &#39;kind&#39;: &#39;car&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;},
   {&#39;year&#39;: 1999, &#39;kind&#39;: &#39;car&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;}])}
</pre></div>
</div>
</div>
</div>
<p>Here is a sample select statement.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;select year,kind from inventory&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(1997, &#39;van&#39;), (2000, &#39;car&#39;), (1999, &#39;car&#39;)]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;select company,model from inventory where kind == &#39;car&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39;Mercury&#39;, &#39;Cougar&#39;), (&#39;Chevy&#39;, &#39;Venture&#39;)]
</pre></div>
</div>
</div>
</div>
<p>We can run updates on it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;update inventory set year = 1998, company = &#39;Suzuki&#39; where kind == &#39;van&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;1 records were updated&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">db</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;inventory&#39;: ({&#39;year&#39;: int, &#39;kind&#39;: str, &#39;company&#39;: str, &#39;model&#39;: str},
  [{&#39;year&#39;: 1998, &#39;kind&#39;: &#39;van&#39;, &#39;company&#39;: &#39;Suzuki&#39;, &#39;model&#39;: &#39;E350&#39;},
   {&#39;year&#39;: 2000, &#39;kind&#39;: &#39;car&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;},
   {&#39;year&#39;: 1999, &#39;kind&#39;: &#39;car&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;}])}
</pre></div>
</div>
</div>
</div>
<p>It can even do mathematics on the fly!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;select int(year)+10 from inventory&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[2008, 2010, 2009]
</pre></div>
</div>
</div>
</div>
<p>Adding a new row to our table.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;insert into inventory (year, kind, company, model) values (1, &#39;charriot&#39;, &#39;Rome&#39;, &#39;Quadriga&#39;)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">db</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;inventory&#39;: ({&#39;year&#39;: int, &#39;kind&#39;: str, &#39;company&#39;: str, &#39;model&#39;: str},
  [{&#39;year&#39;: 1998, &#39;kind&#39;: &#39;van&#39;, &#39;company&#39;: &#39;Suzuki&#39;, &#39;model&#39;: &#39;E350&#39;},
   {&#39;year&#39;: 2000, &#39;kind&#39;: &#39;car&#39;, &#39;company&#39;: &#39;Mercury&#39;, &#39;model&#39;: &#39;Cougar&#39;},
   {&#39;year&#39;: 1999, &#39;kind&#39;: &#39;car&#39;, &#39;company&#39;: &#39;Chevy&#39;, &#39;model&#39;: &#39;Venture&#39;},
   {&#39;year&#39;: 1, &#39;kind&#39;: &#39;charriot&#39;, &#39;company&#39;: &#39;Rome&#39;, &#39;model&#39;: &#39;Quadriga&#39;}])}
</pre></div>
</div>
</div>
</div>
<p>Which we then delete.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;delete from inventory where year &lt; 1900&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;1 records were deleted&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="fuzzing-sql">
<h3>Fuzzing SQL<a class="headerlink" href="#fuzzing-sql" title="Link to this heading">#</a></h3>
<p>To verify that everything is OK, let us fuzz. First we define our grammar.</p>
<section id="excursion-defining-a-sql-grammar">
<h4>Excursion: Defining a SQL grammar<a class="headerlink" href="#excursion-defining-a-sql-grammar" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">string</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Grammars</span> <span class="kn">import</span> <span class="n">START_SYMBOL</span><span class="p">,</span> <span class="n">Grammar</span><span class="p">,</span> <span class="n">Expansion</span><span class="p">,</span> \
    <span class="n">is_valid_grammar</span><span class="p">,</span> <span class="n">extend_grammar</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EXPR_GRAMMAR</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;expr&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;expr&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;bexpr&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;aexpr&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;(&lt;expr&gt;)&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;term&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;bexpr&gt;&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;&lt;aexpr&gt;&lt;lt&gt;&lt;aexpr&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;aexpr&gt;&lt;gt&gt;&lt;aexpr&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;expr&gt;==&lt;expr&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;expr&gt;!=&lt;expr&gt;&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s2">&quot;&lt;aexpr&gt;&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;&lt;aexpr&gt;+&lt;aexpr&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;aexpr&gt;-&lt;aexpr&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;aexpr&gt;*&lt;aexpr&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;aexpr&gt;/&lt;aexpr&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;word&gt;(&lt;exprs&gt;)&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;expr&gt;&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;&lt;exprs&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;expr&gt;,&lt;exprs&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;expr&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;lt&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;gt&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;term&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;number&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;word&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;number&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;integer&gt;.&lt;integer&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;integer&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;-&lt;number&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;integer&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;digit&gt;&lt;integer&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;word&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;word&gt;&lt;letter&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;word&gt;&lt;digit&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;letter&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">:</span>
    <span class="nb">list</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">),</span>
    <span class="s2">&quot;&lt;letter&gt;&quot;</span><span class="p">:</span>
    <span class="nb">list</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="s1">&#39;_:.&#39;</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PRINTABLE_CHARS</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">printable</span> 
                                    <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s2">&quot;&lt;&gt;&#39;</span><span class="se">\&quot;\t\n\r\x0b\x0c\x00</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&lt;lt&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;gt&gt;&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">INVENTORY_GRAMMAR</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s1">&#39;&lt;start&gt;&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&lt;query&gt;&#39;</span><span class="p">],</span>
        <span class="s1">&#39;&lt;query&gt;&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;select &lt;exprs&gt; from &lt;table&gt;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;select &lt;exprs&gt; from &lt;table&gt; where &lt;bexpr&gt;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;insert into &lt;table&gt; (&lt;names&gt;) values (&lt;literals&gt;)&#39;</span><span class="p">,</span>
            <span class="s1">&#39;update &lt;table&gt; set &lt;assignments&gt; where &lt;bexpr&gt;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;delete from &lt;table&gt; where &lt;bexpr&gt;&#39;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s1">&#39;&lt;table&gt;&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&lt;word&gt;&#39;</span><span class="p">],</span>
        <span class="s1">&#39;&lt;names&gt;&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&lt;column&gt;,&lt;names&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;column&gt;&#39;</span><span class="p">],</span>
        <span class="s1">&#39;&lt;column&gt;&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&lt;word&gt;&#39;</span><span class="p">],</span>
        <span class="s1">&#39;&lt;literals&gt;&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&lt;literal&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;literal&gt;,&lt;literals&gt;&#39;</span><span class="p">],</span>
        <span class="s1">&#39;&lt;literal&gt;&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&lt;number&gt;&#39;</span><span class="p">,</span> <span class="s2">&quot;&#39;&lt;chars&gt;&#39;&quot;</span><span class="p">],</span>
        <span class="s1">&#39;&lt;assignments&gt;&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&lt;kvp&gt;,&lt;assignments&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;kvp&gt;&#39;</span><span class="p">],</span>
        <span class="s1">&#39;&lt;kvp&gt;&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&lt;column&gt;=&lt;value&gt;&#39;</span><span class="p">],</span>
        <span class="s1">&#39;&lt;value&gt;&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&lt;word&gt;&#39;</span><span class="p">],</span>
        <span class="s1">&#39;&lt;chars&gt;&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&lt;char&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;char&gt;&lt;chars&gt;&#39;</span><span class="p">],</span>
        <span class="s1">&#39;&lt;char&gt;&#39;</span><span class="p">:</span> <span class="n">PRINTABLE_CHARS</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
    <span class="p">})</span>

<span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">INVENTORY_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>As can be seen from the source of our database, the functions always check whether the table name is correct. Hence, we modify the grammar to choose our particular table so that it will have a better chance of reaching deeper. We will see in the later sections how this can be done automatically.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">INVENTORY_GRAMMAR_F</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">INVENTORY_GRAMMAR</span><span class="p">,</span> 
                                     <span class="p">{</span><span class="s1">&#39;&lt;table&gt;&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;inventory&#39;</span><span class="p">]})</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id1">
<h4>End of Excursion<a class="headerlink" href="#id1" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">GrammarFuzzer</span> <span class="kn">import</span> <span class="n">GrammarFuzzer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gf</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">INVENTORY_GRAMMAR_F</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">SQLException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt; &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">pass</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">break</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;select O6fo,-977091.1,-36.46 from inventory&#39;
&gt;  Invalid WHERE (&#39;(O6fo,-977091.1,-36.46)&#39;)

&#39;select g3 from inventory where -3.0!=V/g/b+Q*M*G&#39;
&gt;  Invalid WHERE (&#39;(-3.0!=V/g/b+Q*M*G)&#39;)

&#39;update inventory set z=a,x=F_,Q=K where p(M)&lt;_*S&#39;
&gt;  Column (&#39;z&#39;) was not found

&#39;update inventory set R=L5pk where e*l*y-u&gt;K+U(:)&#39;
&gt;  Column (&#39;R&#39;) was not found

&#39;select _/d*Q+H/d(k)&lt;t+M-A+P from inventory&#39;
&gt;  Invalid WHERE (&#39;(_/d*Q+H/d(k)&lt;t+M-A+P)&#39;)

&#39;select F5 from inventory&#39;
&gt;  Invalid WHERE (&#39;(F5)&#39;)

&#39;update inventory set jWh.=a6 where wcY(M)&gt;IB7(i)&#39;
&gt;  Column (&#39;jWh.&#39;) was not found

&#39;update inventory set U=y where L(W&lt;c,(U!=W))&lt;V(((q)==m&lt;F),O,l)&#39;
&gt;  Column (&#39;U&#39;) was not found

&#39;delete from inventory where M/b-O*h*E&lt;H-W&gt;e(Y)-P&#39;
&gt;  Invalid WHERE (&#39;M/b-O*h*E&lt;H-W&gt;e(Y)-P&#39;)

&#39;select ((kP(86)+b*S+J/Z/U+i(U))) from inventory&#39;
&gt;  Invalid WHERE (&#39;(((kP(86)+b*S+J/Z/U+i(U))))&#39;)
</pre></div>
</div>
</div>
</div>
<p>Fuzzing does not seem to have triggered any crashes.  However, are crashes the only errors that we should be worried about?</p>
</section>
</section>
<section id="the-evil-of-eval">
<h3>The Evil of Eval<a class="headerlink" href="#the-evil-of-eval" title="Link to this heading">#</a></h3>
<p>In our database implementation – notably in the <code class="docutils literal notranslate"><span class="pre">expression_clause()</span></code> method -, we have made use of <code class="docutils literal notranslate"><span class="pre">eval()</span></code> to evaluate expressions using the Python interpreter.  This allows us to unleash the full power of Python expressions within our SQL statements.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;select year from inventory where year &lt; 2000&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1998, 1999]
</pre></div>
</div>
</div>
</div>
<p>In the above query, the clause <code class="docutils literal notranslate"><span class="pre">year</span> <span class="pre">&lt;</span> <span class="pre">2000</span></code> is evaluated using <code class="docutils literal notranslate"><span class="pre">expression_clause()</span></code> using Python in the context of each row; hence, <code class="docutils literal notranslate"><span class="pre">year</span> <span class="pre">&lt;</span> <span class="pre">2000</span></code> evaluates to either <code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p>
<p>The same holds for the expressions being <code class="docutils literal notranslate"><span class="pre">select</span></code>ed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;select year - 1900 if year &lt; 2000 else year - 2000 from inventory&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[98, 0, 99]
</pre></div>
</div>
</div>
</div>
<p>This works because <code class="docutils literal notranslate"><span class="pre">year</span> <span class="pre">-</span> <span class="pre">1900</span> <span class="pre">if</span> <span class="pre">year</span> <span class="pre">&lt;</span> <span class="pre">2000</span> <span class="pre">else</span> <span class="pre">year</span> <span class="pre">-</span> <span class="pre">2000</span></code> is a valid Python expression.  (It is not a valid SQL expression, though.)</p>
<p>The problem with the above is that there is <em>no limitation</em> to what the Python expression can do.  What if the user tries the following?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">&#39;select __import__(&quot;os&quot;).popen(&quot;pwd&quot;).read() from inventory&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;/Users/zeller/Projects/fuzzingbook/notebooks\n&#39;,
 &#39;/Users/zeller/Projects/fuzzingbook/notebooks\n&#39;,
 &#39;/Users/zeller/Projects/fuzzingbook/notebooks\n&#39;]
</pre></div>
</div>
</div>
</div>
<p>The above statement effectively reads from the users’ file system.  Instead of <code class="docutils literal notranslate"><span class="pre">os.popen(&quot;pwd&quot;).read()</span></code>, it could execute arbitrary Python commands – to access data, install software, run a background process.  This is where “the full power of Python expressions” turns back on us.</p>
<p>What we want is to allow our <em>program</em> to make full use of its power; yet, the <em>user</em> (or any third party) should not be entrusted to do the same.  Hence, we need to differentiate between (trusted) <em>input from the program</em> and (untrusted) <em>input from the user</em>.</p>
<p>One method that allows such differentiation is that of <em>dynamic taint analysis</em>. The idea is to identify the functions that accept user input as <em>sources</em> that <em>taint</em> any string that comes in through them, and those functions that perform dangerous operations as <em>sinks</em>. Finally, we bless certain functions as <em>taint sanitizers</em>. The idea is that an input from the source should never reach the sink without undergoing sanitization first. This allows us to use a stronger oracle than simply checking for crashes.</p>
</section>
</section>
<section id="id2">
<h2>Tracking String Taints<a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<p>There are various levels of taint tracking that one can perform. The simplest is to track that a string fragment originated in a specific environment, and has not undergone a taint removal process. For this, we simply need to wrap the original string with an environment identifier (the <em>taint</em>) with <code class="docutils literal notranslate"><span class="pre">tstr</span></code>, and produce <code class="docutils literal notranslate"><span class="pre">tstr</span></code> instances on each operation that results in another string fragment.  The attribute <code class="docutils literal notranslate"><span class="pre">taint</span></code> holds a label identifying the environment this instance was derived.</p>
<section id="a-class-for-tainted-strings">
<h3>A Class for Tainted Strings<a class="headerlink" href="#a-class-for-tainted-strings" title="Link to this heading">#</a></h3>
<p>For capturing information flows we need a new string class. The idea is to use the new tainted string class <code class="docutils literal notranslate"><span class="pre">tstr</span></code> as a wrapper on the original <code class="docutils literal notranslate"><span class="pre">str</span></code> class. However, <code class="docutils literal notranslate"><span class="pre">str</span></code> is an <em>immutable</em> class. Hence, it does not call its <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> method after being constructed. This means that any subclasses of <code class="docutils literal notranslate"><span class="pre">str</span></code> also will not get the <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> method called. If we want to get our initialization routine called, we need to <a class="reference external" href="https://docs.python.org/3/reference/datamodel.html#basic-customization">hook into <code class="docutils literal notranslate"><span class="pre">__new__()</span></code></a> and return an instance of our own class.  We combine this with our initialization code in <code class="docutils literal notranslate"><span class="pre">__init__()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">tstr</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrapper for strings, saving taint information&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a tstr() instance. Used internally.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">taint</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor.</span>
<span class="sd">        `value` is the string value the `tstr` object is to be constructed from.</span>
<span class="sd">        `taint` is an (optional) taint to be propagated to derived strings.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taint</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">taint</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">tstr</span><span class="p">(</span><span class="n">tstr</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tstr</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">tstr</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">taint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taint</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">tstr</span><span class="p">(</span><span class="n">tstr</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert to string&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>For example, if we wrap <code class="docutils literal notranslate"><span class="pre">&quot;hello&quot;</span></code> in <code class="docutils literal notranslate"><span class="pre">tstr</span></code>, then we should be able to access its taint:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thello</span><span class="p">:</span> <span class="n">tstr</span> <span class="o">=</span> <span class="n">tstr</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;LOW&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thello</span><span class="o">.</span><span class="n">taint</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;LOW&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">repr</span><span class="p">(</span><span class="n">thello</span><span class="p">)</span><span class="o">.</span><span class="n">taint</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;LOW&#39;
</pre></div>
</div>
</div>
</div>
<p>By default, when we wrap a string, it is tainted. Hence, we also need a way to clear the taint in the string. One way is to simply return a <code class="docutils literal notranslate"><span class="pre">str</span></code> instance as above. However, one may sometimes wish to remove the taint from an existing instance. This is accomplished with <code class="docutils literal notranslate"><span class="pre">clear_taint()</span></code>. During <code class="docutils literal notranslate"><span class="pre">clear_taint()</span></code>, we simply set the taint to <code class="docutils literal notranslate"><span class="pre">None</span></code>. This method comes with a paired method <code class="docutils literal notranslate"><span class="pre">has_taint()</span></code> which checks whether a <code class="docutils literal notranslate"><span class="pre">tstr</span></code> instance has a taint.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">tstr</span><span class="p">(</span><span class="n">tstr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">clear_taint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove taint&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taint</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">has_taint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if taint is present&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">taint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="string-operators">
<h3>String Operators<a class="headerlink" href="#string-operators" title="Link to this heading">#</a></h3>
<p>To propagate the taint, we have to extend string functions, such as operators.  We can do so in one single big step, overloading all string methods and operators.</p>
<p>When we create a new string from an existing tainted string, we propagate its taint.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">tstr</span><span class="p">(</span><span class="n">tstr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tstr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taint</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">make_str_wrapper()</span></code> function creates a wrapper around an existing string method which attaches the taint to the result of the method:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">tstr</span><span class="p">(</span><span class="n">tstr</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">make_str_wrapper</span><span class="p">(</span><span class="n">fun</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make `fun` (a `str` method) a method in `tstr`&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="s1">&#39;__doc__&#39;</span><span class="p">):</span>
            <span class="c1"># Copy docstring</span>
            <span class="n">proxy</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">fun</span><span class="o">.</span><span class="vm">__doc__</span>

        <span class="k">return</span> <span class="n">proxy</span>
</pre></div>
</div>
</div>
</div>
<p>We do this for all string methods that return a string:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">informationflow_init_1</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;__format__&#39;</span><span class="p">,</span> <span class="s1">&#39;__mod__&#39;</span><span class="p">,</span> <span class="s1">&#39;__rmod__&#39;</span><span class="p">,</span> <span class="s1">&#39;__getitem__&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;__add__&#39;</span><span class="p">,</span> <span class="s1">&#39;__mul__&#39;</span><span class="p">,</span> <span class="s1">&#39;__rmul__&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;capitalize&#39;</span><span class="p">,</span> <span class="s1">&#39;casefold&#39;</span><span class="p">,</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="s1">&#39;encode&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;expandtabs&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="s1">&#39;format_map&#39;</span><span class="p">,</span> <span class="s1">&#39;join&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;ljust&#39;</span><span class="p">,</span> <span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="s1">&#39;lstrip&#39;</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;rjust&#39;</span><span class="p">,</span> <span class="s1">&#39;rstrip&#39;</span><span class="p">,</span> <span class="s1">&#39;strip&#39;</span><span class="p">,</span> <span class="s1">&#39;swapcase&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;translate&#39;</span><span class="p">,</span> <span class="s1">&#39;upper&#39;</span><span class="p">]:</span>
        <span class="n">fun</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">tstr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tstr</span><span class="o">.</span><span class="n">make_str_wrapper</span><span class="p">(</span><span class="n">fun</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">informationflow_init_1</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">INITIALIZER_LIST</span> <span class="o">=</span> <span class="p">[</span><span class="n">informationflow_init_1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">initialize</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">INITIALIZER_LIST</span><span class="p">:</span>
        <span class="n">fn</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The one missing operator is <code class="docutils literal notranslate"><span class="pre">+</span></code> with a regular string on the left side and a tainted string on the right side.  Python supports a <code class="docutils literal notranslate"><span class="pre">__radd__()</span></code> method which is invoked if the associated object is used on the right side of an addition.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">tstr</span><span class="p">(</span><span class="n">tstr</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return value + self, as a `tstr` object&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">value</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>With this, we are already done.  Let us create a string <code class="docutils literal notranslate"><span class="pre">thello</span></code> with a taint <code class="docutils literal notranslate"><span class="pre">LOW</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thello</span> <span class="o">=</span> <span class="n">tstr</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;LOW&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, any substring will also be tainted:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thello</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">taint</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;LOW&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thello</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">taint</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;LOW&#39;
</pre></div>
</div>
</div>
</div>
<p>String additions will return a <code class="docutils literal notranslate"><span class="pre">tstr</span></code> object with the taint:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">tstr</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;HIGH&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">taint</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;HIGH&#39;
</pre></div>
</div>
</div>
</div>
<p>Our <code class="docutils literal notranslate"><span class="pre">__radd__()</span></code> method ensures this also works if the <code class="docutils literal notranslate"><span class="pre">tstr</span></code> occurs on the right side of a string addition:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s1">&#39;foo&#39;</span> <span class="o">+</span> <span class="n">tstr</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;HIGH&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">taint</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;HIGH&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thello</span> <span class="o">+=</span> <span class="s1">&#39;, world&#39;</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thello</span><span class="o">.</span><span class="n">taint</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;LOW&#39;
</pre></div>
</div>
</div>
</div>
<p>Other operators such as multiplication also work:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">thello</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">taint</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;LOW&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s1">&#39;hw </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">thello</span><span class="p">)</span><span class="o">.</span><span class="n">taint</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;LOW&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">tstr</span><span class="p">(</span><span class="s1">&#39;hello </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;HIGH&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="s1">&#39;world&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">taint</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;HIGH&#39;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="tracking-untrusted-input">
<h2>Tracking Untrusted Input<a class="headerlink" href="#tracking-untrusted-input" title="Link to this heading">#</a></h2>
<p>So, what can one do with tainted strings?  We reconsider the <code class="docutils literal notranslate"><span class="pre">DB</span></code> example.  We define a “better” <code class="docutils literal notranslate"><span class="pre">TrustedDB</span></code> which only accepts strings tainted as <code class="docutils literal notranslate"><span class="pre">&quot;TRUSTED&quot;</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TrustedDB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">tstr</span><span class="p">),</span> <span class="s2">&quot;Need a tainted string&quot;</span>
        <span class="k">assert</span> <span class="n">s</span><span class="o">.</span><span class="n">taint</span> <span class="o">==</span> <span class="s1">&#39;TRUSTED&#39;</span><span class="p">,</span> <span class="s2">&quot;Need a string with trusted taint&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Feeding a string with an “unknown” (i.e., non-existing) trust level will cause <code class="docutils literal notranslate"><span class="pre">TrustedDB</span></code> to fail:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bdb</span> <span class="o">=</span> <span class="n">TrustedDB</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ExpectError</span> <span class="kn">import</span> <span class="n">ExpectError</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">bdb</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;select year from INVENTORY&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/3935989889.py&quot;, line 2, in &lt;module&gt;
    bdb.sql(&quot;select year from INVENTORY&quot;)
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/995123203.py&quot;, line 3, in sql
    assert isinstance(s, tstr), &quot;Need a tainted string&quot;
           ^^^^^^^^^^^^^^^^^^^
AssertionError: Need a tainted string (expected)
</pre></div>
</div>
</div>
</div>
<p>Additionally, any user input would be originally tagged with <code class="docutils literal notranslate"><span class="pre">&quot;UNTRUSTED&quot;</span></code> as taint.  If we place an untrusted string into our better calculator, it will also fail:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bad_user_input</span> <span class="o">=</span> <span class="n">tstr</span><span class="p">(</span><span class="s1">&#39;__import__(&quot;os&quot;).popen(&quot;ls&quot;).read()&#39;</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;UNTRUSTED&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">bdb</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">bad_user_input</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/3307042773.py&quot;, line 3, in &lt;module&gt;
    bdb.sql(bad_user_input)
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/995123203.py&quot;, line 4, in sql
    assert s.taint == &#39;TRUSTED&#39;, &quot;Need a string with trusted taint&quot;
           ^^^^^^^^^^^^^^^^^^^^
AssertionError: Need a string with trusted taint (expected)
</pre></div>
</div>
</div>
</div>
<p>Hence, somewhere along the computation, we have to turn the “untrusted” inputs into “trusted” strings.  This process is called <em>sanitization</em>.  A simple sanitization function for our purposes could ensure that the input consists only of few allowed characters (not including letters or quotes); if this is the case, then the input gets a new <code class="docutils literal notranslate"><span class="pre">&quot;TRUSTED&quot;</span></code> taint.  If not, we turn the string into an (untrusted) empty string; other alternatives would be to raise an error or to escape or delete “untrusted” characters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sanitize</span><span class="p">(</span><span class="n">user_input</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_input</span><span class="p">,</span> <span class="n">tstr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
            <span class="sa">r</span><span class="s1">&#39;^select +[-a-zA-Z0-9_, ()]+ from +[-a-zA-Z0-9_, ()]+$&#39;</span><span class="p">,</span> <span class="n">user_input</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tstr</span><span class="p">(</span><span class="n">user_input</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;TRUSTED&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tstr</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;UNTRUSTED&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">good_user_input</span> <span class="o">=</span> <span class="n">tstr</span><span class="p">(</span><span class="s2">&quot;select year,model from inventory&quot;</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;UNTRUSTED&#39;</span><span class="p">)</span>
<span class="n">sanitized_input</span> <span class="o">=</span> <span class="n">sanitize</span><span class="p">(</span><span class="n">good_user_input</span><span class="p">)</span>
<span class="n">sanitized_input</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;select year,model from inventory&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sanitized_input</span><span class="o">.</span><span class="n">taint</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;TRUSTED&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bdb</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">sanitized_input</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(1998, &#39;E350&#39;), (2000, &#39;Cougar&#39;), (1999, &#39;Venture&#39;)]
</pre></div>
</div>
</div>
</div>
<p>Let us now try out our untrusted input:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sanitized_input</span> <span class="o">=</span> <span class="n">sanitize</span><span class="p">(</span><span class="n">bad_user_input</span><span class="p">)</span>
<span class="n">sanitized_input</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sanitized_input</span><span class="o">.</span><span class="n">taint</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;UNTRUSTED&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">bdb</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">sanitized_input</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/249000876.py&quot;, line 2, in &lt;module&gt;
    bdb.sql(sanitized_input)
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/995123203.py&quot;, line 4, in sql
    assert s.taint == &#39;TRUSTED&#39;, &quot;Need a string with trusted taint&quot;
           ^^^^^^^^^^^^^^^^^^^^
AssertionError: Need a string with trusted taint (expected)
</pre></div>
</div>
</div>
</div>
<p>Similarly, we can prevent SQL and code injections discussed in <a class="reference internal" href="WebFuzzer.html"><span class="std std-doc">the chapter on Web fuzzing</span></a>.</p>
</section>
<section id="taint-aware-fuzzing">
<h2>Taint Aware Fuzzing<a class="headerlink" href="#taint-aware-fuzzing" title="Link to this heading">#</a></h2>
<p>We can also use tainting to <em>direct fuzzing to those grammar rules that are likely to generate dangerous inputs.</em> The idea here is to identify inputs generated by our fuzzer that lead to untrusted execution. First we define the exception to be thrown when a tainted value reaches a dangerous operation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Tainted</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Tainted[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span>
</pre></div>
</div>
</div>
</div>
<section id="tainteddb">
<h3>TaintedDB<a class="headerlink" href="#tainteddb" title="Link to this heading">#</a></h3>
<p>Next, since <code class="docutils literal notranslate"><span class="pre">my_eval()</span></code> is the most dangerous operation in the <code class="docutils literal notranslate"><span class="pre">DB</span></code> class, we define a new class <code class="docutils literal notranslate"><span class="pre">TaintedDB</span></code> that overrides the <code class="docutils literal notranslate"><span class="pre">my_eval()</span></code> to throw an exception whenever an untrusted string reaches this part.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TaintedDB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">my_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">statement</span><span class="o">.</span><span class="n">taint</span> <span class="o">!=</span> <span class="s1">&#39;TRUSTED&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Tainted</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SQLException</span><span class="p">(</span><span class="s1">&#39;Invalid SQL (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">statement</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>We initialize an instance of <code class="docutils literal notranslate"><span class="pre">TaintedDB</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tdb</span> <span class="o">=</span> <span class="n">TaintedDB</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tdb</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">db</span>
</pre></div>
</div>
</div>
</div>
<p>Then we start fuzzing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">traceback</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">tdb</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">tstr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;UNTRUSTED&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">SQLException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">except</span> <span class="n">Tainted</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt; &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">break</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;delete from inventory where y/u-l+f/y&lt;Y(c)/A-H*q&#39;
&gt;  Tainted[y/u-l+f/y&lt;Y(c)/A-H*q]

&quot;insert into inventory (G,Wmp,sl3hku3) values (&#39;&lt;&#39;,&#39;?&#39;)&quot;

&quot;insert into inventory (d0) values (&#39;,_G&#39;)&quot;

&#39;select P*Q-w/x from inventory where X&lt;j==:==j*r-f&#39;
&gt;  Tainted[(X&lt;j==:==j*r-f)]

&#39;select a&gt;F*i from inventory where Q/I-_+P*j&gt;.&#39;
&gt;  Tainted[(Q/I-_+P*j&gt;.)]

&#39;select (V-i&lt;T/g) from inventory where T/r/G&lt;FK(m)/(i)&#39;
&gt;  Tainted[(T/r/G&lt;FK(m)/(i))]

&#39;select (((i))),_(S,_)/L-k&lt;H(Sv,R,n,W,Y) from inventory&#39;
&gt;  Tainted[((((i))),_(S,_)/L-k&lt;H(Sv,R,n,W,Y))]

&#39;select (N==c*U/P/y),i-e/n*y,T!=w,u from inventory&#39;
&gt;  Tainted[((N==c*U/P/y),i-e/n*y,T!=w,u)]

&#39;update inventory set _=B,n=v where o-p*k-J&gt;T&#39;

&#39;select s from inventory where w4g4&lt;.m(_)/_&gt;t&#39;
&gt;  Tainted[(w4g4&lt;.m(_)/_&gt;t)]
</pre></div>
</div>
</div>
</div>
<p>One can see that <code class="docutils literal notranslate"><span class="pre">insert</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code>, <code class="docutils literal notranslate"><span class="pre">select</span></code> and <code class="docutils literal notranslate"><span class="pre">delete</span></code> statements on an existing table lead to taint exceptions. We can now focus on these specific kinds of inputs. However, this is not the only thing we can do. We will see how we can identify specific portions of input that reached tainted execution using character origins in the later sections. But before that, we explore other uses of taints.</p>
</section>
</section>
<section id="preventing-privacy-leaks">
<h2>Preventing Privacy Leaks<a class="headerlink" href="#preventing-privacy-leaks" title="Link to this heading">#</a></h2>
<p>Using taints, we can also ensure that secret information does not leak out.  We can assign a special taint <code class="docutils literal notranslate"><span class="pre">&quot;SECRET&quot;</span></code> to strings whose information must not leak out:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">secrets</span> <span class="o">=</span> <span class="n">tstr</span><span class="p">(</span><span class="s1">&#39;&lt;Plenty of secret keys&gt;&#39;</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;SECRET&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Accessing any substring of <code class="docutils literal notranslate"><span class="pre">secrets</span></code> will propagate the taint:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">secrets</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">taint</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;SECRET&#39;
</pre></div>
</div>
</div>
</div>
<p>Consider the <em>heartbeat</em> security leak from <a class="reference internal" href="Fuzzer.html"><span class="std std-doc">the chapter on Fuzzing</span></a>, in which a server would accidentally reply not only the user input sent to it, but also secret memory.  If the reply consists only of the user input, there is no taint associated with it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">user_input</span> <span class="o">=</span> <span class="s2">&quot;hello&quot;</span>
<span class="n">reply</span> <span class="o">=</span> <span class="n">user_input</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">isinstance</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="n">tstr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False
</pre></div>
</div>
</div>
</div>
<p>If, however, the reply contains <em>any</em> part of the secret, the reply will be tainted:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reply</span> <span class="o">=</span> <span class="n">user_input</span> <span class="o">+</span> <span class="n">secrets</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reply</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;hello&lt;Plen&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reply</span><span class="o">.</span><span class="n">taint</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;SECRET&#39;
</pre></div>
</div>
</div>
</div>
<p>The output function of our server would now ensure that the data sent back does not contain any secret information:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">send_back</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">tstr</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">taint</span> <span class="o">==</span> <span class="s1">&#39;SECRET&#39;</span>  <span class="c1"># type: ignore</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">send_back</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/3747050841.py&quot;, line 2, in &lt;module&gt;
    send_back(reply)
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/3158733057.py&quot;, line 2, in send_back
    assert not isinstance(s, tstr) and not s.taint == &#39;SECRET&#39;  # type: ignore
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError (expected)
</pre></div>
</div>
</div>
</div>
<p>Our <code class="docutils literal notranslate"><span class="pre">tstr</span></code> solution can help to identify information leaks – but it is by no means complete.  If we actually take the <code class="docutils literal notranslate"><span class="pre">heartbeat()</span></code> implementation from <a class="reference internal" href="Fuzzer.html"><span class="std std-doc">the chapter on Fuzzing</span></a>, we will see that <em>any</em> reply is marked as <code class="docutils literal notranslate"><span class="pre">SECRET</span></code> – even those not even accessing secret memory:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Fuzzer</span> <span class="kn">import</span> <span class="n">heartbeat</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reply</span> <span class="o">=</span> <span class="n">heartbeat</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">secrets</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reply</span><span class="o">.</span><span class="n">taint</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;SECRET&#39;
</pre></div>
</div>
</div>
</div>
<p>Why is this?  If we look into the implementation of <code class="docutils literal notranslate"><span class="pre">heartbeat()</span></code>, we will see that it first builds a long string <code class="docutils literal notranslate"><span class="pre">memory</span></code> from the (non-secret) reply and the (secret) memory, before returning the first characters from <code class="docutils literal notranslate"><span class="pre">memory</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="c1"># Store reply in memory</span>
    <span class="n">memory</span> <span class="o">=</span> <span class="n">reply</span> <span class="o">+</span> <span class="n">memory</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">reply</span><span class="p">):]</span>
</pre></div>
</div>
<p>At this point, the whole memory still is tainted as <code class="docutils literal notranslate"><span class="pre">SECRET</span></code>, <em>including</em> the non-secret part from <code class="docutils literal notranslate"><span class="pre">reply</span></code>.</p>
<p>We may be able to circumvent the issue by tagging the <code class="docutils literal notranslate"><span class="pre">reply</span></code> as <code class="docutils literal notranslate"><span class="pre">PUBLIC</span></code> – but then, this taint would be in conflict with the <code class="docutils literal notranslate"><span class="pre">SECRET</span></code> tag of <code class="docutils literal notranslate"><span class="pre">memory</span></code>.  What happens if we compose a string from two differently tainted strings?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thilo</span> <span class="o">=</span> <span class="n">tstr</span><span class="p">(</span><span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;HIGH&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">tstr</span><span class="p">(</span><span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;LOW&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>It turns out that in this case, the <code class="docutils literal notranslate"><span class="pre">__add__()</span></code> method takes precedence over the <code class="docutils literal notranslate"><span class="pre">__radd__()</span></code> method, which means that the right-hand <code class="docutils literal notranslate"><span class="pre">&quot;Low&quot;</span></code> string is treated as a regular (non-tainted) string.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thilo</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;HighLow&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thilo</span><span class="o">.</span><span class="n">taint</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;HIGH&#39;
</pre></div>
</div>
</div>
</div>
<p>We could set up the <code class="docutils literal notranslate"><span class="pre">__add__()</span></code> and other methods with special handling for conflicting taints.  However, the way this conflict should be resolved would be highly <em>application-dependent</em>:</p>
<ul class="simple">
<li><p>If we use taints to indicate <em>privacy levels</em>, <code class="docutils literal notranslate"><span class="pre">SECRET</span></code> privacy should take precedence over <code class="docutils literal notranslate"><span class="pre">PUBLIC</span></code> privacy.  Any combination of a <code class="docutils literal notranslate"><span class="pre">SECRET</span></code>-tainted string and a <code class="docutils literal notranslate"><span class="pre">PUBLIC</span></code>-tainted string thus should have a <code class="docutils literal notranslate"><span class="pre">SECRET</span></code> taint.</p></li>
<li><p>If we use taints to indicate <em>origins</em> of information, an <code class="docutils literal notranslate"><span class="pre">UNTRUSTED</span></code> origin should take precedence over a <code class="docutils literal notranslate"><span class="pre">TRUSTED</span></code> origin.  Any combination of an <code class="docutils literal notranslate"><span class="pre">UNTRUSTED</span></code>-tainted string and a <code class="docutils literal notranslate"><span class="pre">TRUSTED</span></code>-tainted string thus should have an <code class="docutils literal notranslate"><span class="pre">UNTRUSTED</span></code> taint.</p></li>
</ul>
<p>Of course, such conflict resolutions can be implemented.  But even so, they will not help us in the <code class="docutils literal notranslate"><span class="pre">heartbeat()</span></code> example differentiating secret from non-secret output data.</p>
</section>
<section id="tracking-individual-characters">
<h2>Tracking Individual Characters<a class="headerlink" href="#tracking-individual-characters" title="Link to this heading">#</a></h2>
<p>Fortunately, there is a better, more generic way to solve the above problems.  The key to composition of differently tainted strings is to assign taints not only to strings, but actually to every bit of information – in our case, characters.  If every character has a taint on its own, a new composition of characters will simply inherit this very taint <em>per character</em>.  To this end, we introduce a second bit of information named <em>origin</em>.</p>
<p>Distinguishing various untrusted sources may be accomplished by originating each instance as separate instance (called <em>colors</em> in dynamic origin research). You will see an instance of this technique in the chapter on <a class="reference internal" href="GrammarMiner.html"><span class="std std-doc">Grammar Mining</span></a>.</p>
<p>In this section, we carry <em>character level</em> origins. That is, given a fragment that resulted from a portion of the original originated string, one will be able to tell which portion of the input string the fragment was taken from. In essence, each input character index from an originated source gets its own color.</p>
<p>More complex originating such as <em>bitmap origins</em> are possible where a single character may result from multiple origined character indexes (such as <em>checksum</em> operations on strings). We do not consider these in this chapter.</p>
<section id="a-class-for-tracking-character-origins">
<h3>A Class for Tracking Character Origins<a class="headerlink" href="#a-class-for-tracking-character-origins" title="Link to this heading">#</a></h3>
<p>Let us introduce a class <code class="docutils literal notranslate"><span class="pre">ostr</span></code> which, like <code class="docutils literal notranslate"><span class="pre">tstr</span></code>, carries a taint for each string, and additionally an <em>origin</em> for each character that indicates its source.  It is a consecutive number in a particular range (by default, starting with zero) indicating its <em>position</em> within a specific origin.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrapper for strings, saving taint and origin information&quot;&quot;&quot;</span>
    <span class="n">DEFAULT_ORIGIN</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an ostr() instance. Used internally.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">taint</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">origin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor.</span>
<span class="sd">        `value` is the string value the `ostr` object is to be constructed from.</span>
<span class="sd">        `taint` is an (optional) taint to be propagated to derived strings.</span>
<span class="sd">        `origin` (optional) is either</span>
<span class="sd">        - an integer denoting the index of the first character in `value`, or</span>
<span class="sd">        - a list of integers denoting the origins of the characters in `value`,</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taint</span> <span class="o">=</span> <span class="n">taint</span>

        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">ostr</span><span class="o">.</span><span class="n">DEFAULT_ORIGIN</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">origin</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>As with <code class="docutils literal notranslate"><span class="pre">tstr</span></code>, above, we implement methods for conversion into (regular) Python strings:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ostr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taint</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="n">UNKNOWN_ORIGIN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># handle escaped chars</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="p">[</span><span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">):</span>
            <span class="n">origin</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">o</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>

        <span class="n">origin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ostr</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">taint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taint</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>By default, character origins start with <code class="docutils literal notranslate"><span class="pre">0</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">othello</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">othello</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We can also specify the starting origin as below – <code class="docutils literal notranslate"><span class="pre">6..10</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tworld</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">tworld</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">&quot;hello</span><span class="se">\t</span><span class="s2">world&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">repr</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">origin</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[-1, 0, 1, 2, 3, 4, 5, 5, 6, 7, 8, 9, 10, -1]
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">str()</span></code> returns a <code class="docutils literal notranslate"><span class="pre">str</span></code> instance without origin or taint information:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">othello</span><span class="p">))</span> <span class="o">==</span> <span class="nb">str</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">repr()</span></code>, however, keeps the origin information for the original string:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">repr</span><span class="p">(</span><span class="n">othello</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&quot;&#39;hello&#39;&quot;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">repr</span><span class="p">(</span><span class="n">othello</span><span class="p">)</span><span class="o">.</span><span class="n">origin</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[-1, 0, 1, 2, 3, 4, -1]
</pre></div>
</div>
</div>
</div>
<p>Just as with taints, we can clear origins and check whether an origin is present:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">clear_taint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taint</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">has_taint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">taint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">clear_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">has_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">origin</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span> <span class="k">for</span> <span class="n">origin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">othello</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">&#39;Hello&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">othello</span><span class="o">.</span><span class="n">has_origin</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">othello</span><span class="o">.</span><span class="n">clear_origin</span><span class="p">()</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="n">othello</span><span class="o">.</span><span class="n">has_origin</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>In the remainder of this section, we re-implement various string methods such that they also keep track of origins.  If this is too tedious for you, jump right <a class="reference internal" href="#Checking-Origins"><span class="xref myst">to the next section</span></a> which gives a number of usage examples.</p>
</section>
<section id="excursion-implementing-string-methods">
<h3>Excursion: Implementing String Methods<a class="headerlink" href="#excursion-implementing-string-methods" title="Link to this heading">#</a></h3>
<section id="create">
<h4>Create<a class="headerlink" href="#create" title="Link to this heading">#</a></h4>
<p>We need to create new substrings that are wrapped in <code class="docutils literal notranslate"><span class="pre">ostr</span></code> objects. However, we also want to allow our subclasses to create their own instances. Hence, we again provide a <code class="docutils literal notranslate"><span class="pre">create()</span></code> method that produces a new <code class="docutils literal notranslate"><span class="pre">ostr</span></code> instance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ostr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taint</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">othello</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;HIGH&#39;</span><span class="p">)</span>
<span class="n">otworld</span> <span class="o">=</span> <span class="n">othello</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">otworld</span><span class="o">.</span><span class="n">origin</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[6, 7, 8, 9, 10]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">otworld</span><span class="o">.</span><span class="n">taint</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;HIGH&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="p">(</span><span class="n">othello</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">otworld</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="index">
<h4>Index<a class="headerlink" href="#index" title="Link to this heading">#</a></h4>
<p>In Python, indexing is provided through <code class="docutils literal notranslate"><span class="pre">__getitem__()</span></code>. Indexing on positive integers is simple enough. However, it has two additional wrinkles. The first is that, if the index is negative, that many characters are counted from the end of the string which lies just after the last character. That is, the last character has a negative index <code class="docutils literal notranslate"><span class="pre">-1</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="n">key</span> <span class="k">if</span> <span class="n">key</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">key</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="n">key</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ohello</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;HIGH&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="p">(</span><span class="n">ohello</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ohello</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">ohello</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">taint</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;HIGH&#39;
</pre></div>
</div>
</div>
</div>
<p>The other wrinkle is that <code class="docutils literal notranslate"><span class="pre">__getitem__()</span></code> can accept a slice. We discuss this next.</p>
</section>
<section id="slices">
<h4>Slices<a class="headerlink" href="#slices" title="Link to this heading">#</a></h4>
<p>The Python <code class="docutils literal notranslate"><span class="pre">slice</span></code> operator <code class="docutils literal notranslate"><span class="pre">[n:m]</span></code> relies on the object being an <code class="docutils literal notranslate"><span class="pre">iterator</span></code>. Hence, we define the <code class="docutils literal notranslate"><span class="pre">__iter__()</span></code> method, which returns a custom <code class="docutils literal notranslate"><span class="pre">iterator</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ostr_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">__iter__()</span></code> method requires a supporting <code class="docutils literal notranslate"><span class="pre">iterator</span></code> object. The <code class="docutils literal notranslate"><span class="pre">iterator</span></code> is used to save the state of the current iteration, which it does by keeping a reference to the original <code class="docutils literal notranslate"><span class="pre">ostr</span></code>, and the current index of iteration <code class="docutils literal notranslate"><span class="pre">_str_idx</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ostr_iterator</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ostr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ostr</span> <span class="o">=</span> <span class="n">ostr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_str_idx</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str_idx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ostr</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="c1"># calls ostr getitem should be ostr</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ostr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_str_idx</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ostr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_str_idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">c</span>
</pre></div>
</div>
</div>
</div>
<p>Bringing all these together:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thw</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">&#39;hello world&#39;</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;HIGH&#39;</span><span class="p">)</span>
<span class="n">thw</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;hello&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">thw</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">has_taint</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">thw</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">has_origin</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thw</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">taint</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;HIGH&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thw</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">origin</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0, 1, 2, 3, 4]
</pre></div>
</div>
</div>
</div>
</section>
<section id="splits">
<h4>Splits<a class="headerlink" href="#splits" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_split_wrapper</span><span class="p">(</span><span class="n">fun</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">proxy</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;split&#39;</span><span class="p">,</span> <span class="s1">&#39;rsplit&#39;</span><span class="p">,</span> <span class="s1">&#39;splitlines&#39;</span><span class="p">]:</span>
    <span class="n">fun</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">ostr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">make_split_wrapper</span><span class="p">(</span><span class="n">fun</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">othello</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">&#39;hello world&#39;</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;LOW&#39;</span><span class="p">)</span>
<span class="n">othello</span> <span class="o">==</span> <span class="s1">&#39;hello world&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">othello</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">taint</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;LOW&#39;
</pre></div>
</div>
</div>
</div>
<p>(Exercise for the reader: handle <em>partitions</em>, i.e., splitting a string by substrings)</p>
</section>
<section id="concatenation">
<h4>Concatenation<a class="headerlink" href="#concatenation" title="Link to this heading">#</a></h4>
<p>If two origined strings are concatenated together, it may be desirable to transfer the origins from each to the corresponding portion of the resulting string. The concatenation of strings is accomplished by overriding <code class="docutils literal notranslate"><span class="pre">__add__()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ostr</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">),</span>
                               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">origin</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">),</span>
                               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">other</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">othello</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
<span class="n">otworld</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">&quot;world&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">othw</span> <span class="o">=</span> <span class="n">othello</span> <span class="o">+</span> <span class="n">otworld</span>
<span class="k">assert</span> <span class="n">othw</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
</div>
<p>What if a <code class="docutils literal notranslate"><span class="pre">ostr</span></code> is concatenated with a <code class="docutils literal notranslate"><span class="pre">str</span></code>?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">space</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
<span class="n">th_w</span> <span class="o">=</span> <span class="n">othello</span> <span class="o">+</span> <span class="n">space</span> <span class="o">+</span> <span class="n">otworld</span>
<span class="k">assert</span> <span class="n">th_w</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="p">[</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">,</span>
    <span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>One wrinkle here is that when adding a <code class="docutils literal notranslate"><span class="pre">ostr</span></code> and a <code class="docutils literal notranslate"><span class="pre">str</span></code>, the user may place the <code class="docutils literal notranslate"><span class="pre">str</span></code> first, in which case, the <code class="docutils literal notranslate"><span class="pre">__add__()</span></code> method will be called on the <code class="docutils literal notranslate"><span class="pre">str</span></code> instance. Not on the <code class="docutils literal notranslate"><span class="pre">ostr</span></code> instance. However, Python provides a solution. If one defines <code class="docutils literal notranslate"><span class="pre">__radd__()</span></code> on the <code class="docutils literal notranslate"><span class="pre">ostr</span></code> instance, that method will be called rather than <code class="docutils literal notranslate"><span class="pre">str.__add__()</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">origin</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ostr</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">other</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="p">),</span> <span class="p">(</span><span class="n">origin</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>We test it out:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shello</span> <span class="o">=</span> <span class="s2">&quot;hello&quot;</span>
<span class="n">otworld</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">&quot;world&quot;</span><span class="p">)</span>
<span class="n">thw</span> <span class="o">=</span> <span class="n">shello</span> <span class="o">+</span> <span class="n">otworld</span>
<span class="k">assert</span> <span class="n">thw</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="p">[</span><span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">shello</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
</div>
<p>These methods: <code class="docutils literal notranslate"><span class="pre">slicing</span></code> and <code class="docutils literal notranslate"><span class="pre">concatenation</span></code> is sufficient to implement other string methods that result in a string, and does not change the character underneath (i.e. no case change). Hence, we look at a helper method next.</p>
</section>
<section id="extract-origin-string">
<h4>Extract Origin String<a class="headerlink" href="#extract-origin-string" title="Link to this heading">#</a></h4>
<p>Given a specific input index, the method <code class="docutils literal notranslate"><span class="pre">x()</span></code> extracts the corresponding originated portion from a <code class="docutils literal notranslate"><span class="pre">ostr</span></code>. As a convenience it supports <code class="docutils literal notranslate"><span class="pre">slices</span></code> along with <code class="docutils literal notranslate"><span class="pre">ints</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">TaintException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract substring at index/slice `i`&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">origin</span><span class="o">.</span><span class="n">TaintException</span><span class="p">(</span><span class="s1">&#39;Invalid request idx&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">i</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">start</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">stop</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">i</span><span class="o">.</span><span class="n">step</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">r</span><span class="p">]]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thw</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">&#39;hello world&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">thw</span><span class="o">.</span><span class="n">x</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;e&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">thw</span><span class="o">.</span><span class="n">x</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="mi">101</span><span class="p">,</span> <span class="mi">105</span><span class="p">))</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="replace">
<h4>Replace<a class="headerlink" href="#replace" title="Link to this heading">#</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">replace()</span></code> method replaces a portion of the string with another.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">old_origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span>
        <span class="n">b_origin</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">origin</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">b</span><span class="p">,</span> <span class="n">ostr</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">mystr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">mystr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="n">mystr</span> <span class="o">=</span> <span class="n">mystr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">partA</span><span class="p">,</span> <span class="n">partB</span> <span class="o">=</span> <span class="n">old_origin</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">idx</span><span class="p">],</span> <span class="n">old_origin</span><span class="p">[</span><span class="n">last</span><span class="p">:]</span>
            <span class="n">old_origin</span> <span class="o">=</span> <span class="n">partA</span> <span class="o">+</span> <span class="n">b_origin</span> <span class="o">+</span> <span class="n">partB</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">mystr</span><span class="p">,</span> <span class="n">old_origin</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_str</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">&quot;aa cde aa&quot;</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">my_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;aa&#39;</span><span class="p">,</span> <span class="s1">&#39;bb&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">res</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;bb&#39;</span><span class="p">,</span> <span class="s1">&#39;cde&#39;</span><span class="p">,</span> <span class="s1">&#39;bb&#39;</span><span class="p">,</span>
                           <span class="p">[</span><span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">,</span> <span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">,</span>
                            <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>
                            <span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">,</span> <span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_str</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">&quot;aa cde aa&quot;</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">my_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;aa&#39;</span><span class="p">,</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">&#39;bb&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span>
<span class="k">assert</span> <span class="p">(</span>
    <span class="n">res</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;bb cde bb&#39;</span><span class="p">),</span> <span class="p">[</span>
            <span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="split">
<h4>Split<a class="headerlink" href="#split" title="Link to this heading">#</a></h4>
<p>We essentially have to re-implement split operations, and split by space is slightly different from other splits.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_split_helper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">splitted</span><span class="p">):</span>
        <span class="n">result_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">last_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">first_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sep_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">splitted</span><span class="p">:</span>
            <span class="n">last_idx</span> <span class="o">=</span> <span class="n">first_idx</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">first_idx</span><span class="p">:</span><span class="n">last_idx</span><span class="p">]</span>
            <span class="n">result_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">first_idx</span> <span class="o">=</span> <span class="n">last_idx</span> <span class="o">+</span> <span class="n">sep_len</span>
        <span class="k">return</span> <span class="n">result_list</span>

    <span class="k">def</span> <span class="nf">_split_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">splitted</span><span class="p">):</span>
        <span class="n">result_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">last_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">first_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sep_len</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">splitted</span><span class="p">:</span>
            <span class="n">last_idx</span> <span class="o">=</span> <span class="n">first_idx</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">first_idx</span><span class="p">:</span><span class="n">last_idx</span><span class="p">]</span>
            <span class="n">result_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">last_idx</span><span class="p">:])</span>
            <span class="n">sep_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
            <span class="n">first_idx</span> <span class="o">=</span> <span class="n">last_idx</span> <span class="o">+</span> <span class="n">sep_len</span>
        <span class="k">return</span> <span class="n">result_list</span>

    <span class="k">def</span> <span class="nf">rsplit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">splitted</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">maxsplit</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sep</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_space</span><span class="p">(</span><span class="n">splitted</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_helper</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">splitted</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">splitted</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">maxsplit</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sep</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_space</span><span class="p">(</span><span class="n">splitted</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_helper</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">splitted</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_str</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">&#39;ab cdef ghij kl&#39;</span><span class="p">)</span>
<span class="n">ab</span><span class="p">,</span> <span class="n">cdef</span><span class="p">,</span> <span class="n">ghij</span><span class="p">,</span> <span class="n">kl</span> <span class="o">=</span> <span class="n">my_str</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="p">(</span><span class="n">ab</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">cdef</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">ghij</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span>
        <span class="n">kl</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">],</span> <span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">])</span>

<span class="n">my_str</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">&#39;ab cdef ghij kl&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">)))</span>
<span class="n">ab</span><span class="p">,</span> <span class="n">cdef</span><span class="p">,</span> <span class="n">ghij</span><span class="p">,</span> <span class="n">kl</span> <span class="o">=</span> <span class="n">my_str</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<span class="k">assert</span><span class="p">(</span><span class="n">ab</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">cdef</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">kl</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_str</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">&#39;ab   cdef ghij    kl&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;HIGH&#39;</span><span class="p">)</span>
<span class="n">ab</span><span class="p">,</span> <span class="n">cdef</span><span class="p">,</span> <span class="n">ghij</span><span class="p">,</span> <span class="n">kl</span> <span class="o">=</span> <span class="n">my_str</span><span class="o">.</span><span class="n">rsplit</span><span class="p">()</span>
<span class="k">assert</span> <span class="p">(</span><span class="n">ab</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">cdef</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">ghij</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span>
        <span class="n">kl</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">],</span> <span class="p">[</span><span class="mi">105</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">108</span><span class="p">],</span> <span class="p">[</span><span class="mi">110</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">113</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">118</span><span class="p">,</span> <span class="mi">119</span><span class="p">])</span>

<span class="n">my_str</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">&#39;ab   cdef ghij    kl&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)),</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;HIGH&#39;</span><span class="p">)</span>
<span class="n">ab</span><span class="p">,</span> <span class="n">cdef</span><span class="p">,</span> <span class="n">ghij</span><span class="p">,</span> <span class="n">kl</span> <span class="o">=</span> <span class="n">my_str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="k">assert</span> <span class="p">(</span><span class="n">ab</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">cdef</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">kl</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">ab</span><span class="o">.</span><span class="n">taint</span> <span class="o">==</span> <span class="s1">&#39;HIGH&#39;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="strip">
<h4>Strip<a class="headerlink" href="#strip" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">strip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cl</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">lstrip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cl</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>

    <span class="k">def</span> <span class="nf">rstrip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cl</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_str1</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">&quot;  abc  &quot;</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">my_str1</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;abc&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_str1</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">&quot;  abc  &quot;</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">my_str1</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
<span class="k">assert</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;abc  &#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_str1</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">&quot;  abc  &quot;</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">my_str1</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
<span class="k">assert</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;  abc&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="expand-tabs">
<h4>Expand Tabs<a class="headerlink" href="#expand-tabs" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">expandtabs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">expandtabs</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">all_parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
            <span class="n">all_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_parts</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span>
                <span class="n">all_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="n">l</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">all_parts</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;ab</span><span class="se">\t</span><span class="s2">cd&quot;</span><span class="p">)</span>
<span class="n">my_ostr</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">&quot;ab</span><span class="se">\t</span><span class="s2">cd&quot;</span><span class="p">)</span>
<span class="n">v1</span> <span class="o">=</span> <span class="n">my_s</span><span class="o">.</span><span class="n">expandtabs</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">v2</span> <span class="o">=</span> <span class="n">my_ostr</span><span class="o">.</span><span class="n">expandtabs</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
<span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v1</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span> <span class="n">v2</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;&#39;ab  cd&#39;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
        <span class="n">mystr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">myorigin</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sep_origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
            <span class="n">sorigin</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">origin</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ostr</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">myorigin</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sorigin</span><span class="p">)</span>
            <span class="n">mystr</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">myorigin</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sep_origin</span><span class="p">)</span>
                <span class="n">mystr</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">mystr</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">myorigin</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_str</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">&quot;ab cd&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">),</span> <span class="n">v3</span> <span class="o">=</span> <span class="n">my_str</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="s1">&#39;ef&#39;</span>
<span class="k">assert</span> <span class="p">(</span><span class="n">v1</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">v2</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">],</span> <span class="p">[</span><span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">])</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">v4</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">,</span> <span class="n">v1</span><span class="p">])</span>
<span class="k">assert</span> <span class="p">(</span>
    <span class="n">v4</span><span class="p">,</span> <span class="n">v4</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span>
        <span class="s1">&#39;cdefab&#39;</span><span class="p">,</span> <span class="p">[</span>
            <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">,</span> <span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_str</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">&quot;ab cd&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">),</span> <span class="n">v3</span> <span class="o">=</span> <span class="n">my_str</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="s1">&#39;ef&#39;</span>
<span class="k">assert</span> <span class="p">(</span><span class="n">v1</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">v2</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">],</span> <span class="p">[</span><span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">])</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">v4</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">,</span> <span class="n">v1</span><span class="p">])</span>
<span class="k">assert</span> <span class="p">(</span><span class="n">v4</span><span class="p">,</span> <span class="n">v4</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;cd,ef,ab&#39;</span><span class="p">,</span>
                           <span class="p">[</span><span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">,</span> <span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">])</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="partitions">
<h4>Partitions<a class="headerlink" href="#partitions" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">partition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sep</span><span class="p">):</span>
        <span class="n">partA</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">partB</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">partA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">partA</span><span class="p">)]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">partA</span><span class="p">):</span><span class="nb">len</span><span class="p">(</span><span class="n">partA</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">sep</span><span class="p">)]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">partB</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">partA</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">sep</span><span class="p">):]))</span>

    <span class="k">def</span> <span class="nf">rpartition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sep</span><span class="p">):</span>
        <span class="n">partA</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">partB</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">partA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">partA</span><span class="p">)]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">partA</span><span class="p">):</span><span class="nb">len</span><span class="p">(</span><span class="n">partA</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">sep</span><span class="p">)]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">partB</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">partA</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">sep</span><span class="p">):]))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="justify">
<h4>Justify<a class="headerlink" href="#justify" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">ljust</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">fillchar</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">fillchar</span><span class="p">)</span>
        <span class="n">initial</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fillchar</span><span class="p">,</span> <span class="n">tstr</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">fillchar</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="n">initial</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">rjust</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">fillchar</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">fillchar</span><span class="p">)</span>
        <span class="n">final</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fillchar</span><span class="p">,</span> <span class="n">tstr</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">fillchar</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">+</span> <span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="n">final</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="mod">
<h4>mod<a class="headerlink" href="#mod" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__mod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="c1"># nothing else implemented for the time being</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">s_origin</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">origin</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">ostr</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__mod__</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">r_origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[:]</span>
        <span class="n">r_origin</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_origin</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">r_origin</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__rmod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="c1"># nothing else implemented for the time being</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">r_origin</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">origin</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">ostr</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__rmod__</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">s_origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[:]</span>
        <span class="n">r_origin</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_origin</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">r_origin</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">&#39;hello </span><span class="si">%s</span><span class="s1"> world&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;hello %s world&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">a</span> <span class="o">%</span> <span class="s1">&#39;good&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">origin</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[100, 101, 102, 103, 104, 105, -1, -1, -1, -1, 108, 109, 110, 111, 112, 113]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="s1">&#39;hello </span><span class="si">%s</span><span class="s1"> world&#39;</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">&#39;bad&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="p">(</span><span class="n">b</span> <span class="o">%</span> <span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">origin</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[-1, -1, -1, -1, -1, -1, 10, 11, 12, -1, -1, -1, -1, -1, -1]
</pre></div>
</div>
</div>
</div>
</section>
<section id="string-methods-that-do-not-change-origin">
<h4>String methods that do not change origin<a class="headerlink" href="#string-methods-that-do-not-change-origin" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">swapcase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">swapcase</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">upper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">lower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">capitalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">&#39;aa&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">origin</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;AA&#39;, [100, 101])
</pre></div>
</div>
</div>
</div>
</section>
<section id="general-wrappers">
<h4>General wrappers<a class="headerlink" href="#general-wrappers" title="Link to this heading">#</a></h4>
<p>These are not strictly needed for operation, but can be useful for tracing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_basic_str_wrapper</span><span class="p">(</span><span class="n">fun</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
    <span class="k">def</span> <span class="nf">proxy</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="k">return</span> <span class="n">proxy</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">inspect</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">types</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">informationflow_init_2</span><span class="p">():</span>
    <span class="n">ostr_members</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">ostr</span><span class="p">,</span> <span class="nb">callable</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__qualname__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ostr&#39;</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">callable</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;__class__&#39;</span><span class="p">,</span> <span class="s1">&#39;__new__&#39;</span><span class="p">,</span> <span class="s1">&#39;__str__&#39;</span><span class="p">,</span> <span class="s1">&#39;__init__&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;__repr__&#39;</span><span class="p">,</span> <span class="s1">&#39;__getattribute__&#39;</span><span class="p">])</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">ostr_members</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">ostr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">make_basic_str_wrapper</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">informationflow_init_2</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">INITIALIZER_LIST</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">informationflow_init_2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="methods-yet-to-be-translated">
<h4>Methods yet to be translated<a class="headerlink" href="#methods-yet-to-be-translated" title="Link to this heading">#</a></h4>
<p>These methods generate strings from other strings. However, we do not have the right implementations for any of these. Hence these are marked as dangerous until we can generate the right translations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_str_abort_wrapper</span><span class="p">(</span><span class="n">fun</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">proxy</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ostr</span><span class="o">.</span><span class="n">TaintException</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Not implemented in `ostr`&#39;</span> <span class="o">%</span>
            <span class="n">fun</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">proxy</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">informationflow_init_3</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">callable</span><span class="p">):</span>
        <span class="c1"># Omitted &#39;splitlines&#39; as this is needed for formatting output in</span>
        <span class="c1"># IPython/Jupyter</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;__format__&#39;</span><span class="p">,</span> <span class="s1">&#39;format_map&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;__mul__&#39;</span><span class="p">,</span> <span class="s1">&#39;__rmul__&#39;</span><span class="p">,</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="s1">&#39;zfill&#39;</span><span class="p">,</span> <span class="s1">&#39;decode&#39;</span><span class="p">,</span> <span class="s1">&#39;encode&#39;</span><span class="p">]:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">ostr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">make_str_abort_wrapper</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">informationflow_init_3</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">INITIALIZER_LIST</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">informationflow_init_3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>While generating proxy wrappers for string operations can handle most common cases of transmission of information flow, some operations involving strings can not be overridden. For example, consider the following.</p>
</section>
</section>
<section id="id3">
<h3>End of Excursion<a class="headerlink" href="#id3" title="Link to this heading">#</a></h3>
</section>
<section id="checking-origins">
<h3>Checking Origins<a class="headerlink" href="#checking-origins" title="Link to this heading">#</a></h3>
<p>With all this implemented, we now have full-fledged <code class="docutils literal notranslate"><span class="pre">ostr</span></code> strings where we can easily check the origin of each and every character.</p>
<p>To check whether a string originates from another string, we can convert the origin to a set and resort to standard set operations:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;e&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">origin</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[101]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">&quot;world&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">u</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="s2">&quot;!&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">u</span><span class="o">.</span><span class="n">origin</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[100, 101, 102, 103, 104, 200, 201, 202, 203, 204, -1]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">origin</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
</section>
<section id="privacy-leaks-revisited">
<h3>Privacy Leaks Revisited<a class="headerlink" href="#privacy-leaks-revisited" title="Link to this heading">#</a></h3>
<p>Let us apply it to see whether we can come up with a satisfactory solution for checking the <code class="docutils literal notranslate"><span class="pre">heartbeat()</span></code> function against information leakage.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SECRET_ORIGIN</span> <span class="o">=</span> <span class="mi">1000</span>
</pre></div>
</div>
</div>
</div>
<p>We define a “secret” that must not leak out:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">secret</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">&#39;&lt;again, some super-secret input&gt;&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">SECRET_ORIGIN</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Each and every character in <code class="docutils literal notranslate"><span class="pre">secret</span></code> has an origin starting with <code class="docutils literal notranslate"><span class="pre">SECRET_ORIGIN</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">secret</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1000, 1001, 1002, 1003, 1004, 1005, 1006, 1007, 1008, 1009, 1010, 1011, 1012, 1013, 1014, 1015, 1016, 1017, 1018, 1019, 1020, 1021, 1022, 1023, 1024, 1025, 1026, 1027, 1028, 1029, 1030, 1031]
</pre></div>
</div>
</div>
</div>
<p>If we now invoke <code class="docutils literal notranslate"><span class="pre">heartbeat()</span></code> with a given string, the origin of the reply should all be <code class="docutils literal notranslate"><span class="pre">UNKNOWN_ORIGIN</span></code> (from the input), and none of the characters should have a <code class="docutils literal notranslate"><span class="pre">SECRET_ORIGIN</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hello_s</span> <span class="o">=</span> <span class="n">heartbeat</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">secret</span><span class="p">)</span>
<span class="n">hello_s</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;hello&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hello_s</span><span class="p">,</span> <span class="n">ostr</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">hello_s</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[-1, -1, -1, -1, -1]
</pre></div>
</div>
</div>
</div>
<p>We can verify that the secret did not leak out by formulating appropriate assertions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">hello_s</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="p">[</span><span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">hello_s</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">origin</span> <span class="o">==</span> <span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span> <span class="k">for</span> <span class="n">origin</span> <span class="ow">in</span> <span class="n">hello_s</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">origin</span> <span class="o">&gt;=</span> <span class="n">SECRET_ORIGIN</span> <span class="k">for</span> <span class="n">origin</span> <span class="ow">in</span> <span class="n">hello_s</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>All assertions pass, again confirming that no secret leaked out.</p>
<p>Let us now go and exploit <code class="docutils literal notranslate"><span class="pre">heartbeat()</span></code> to reveal its secrets.  As <code class="docutils literal notranslate"><span class="pre">heartbeat()</span></code> is unchanged, it is as vulnerable as it was:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hello_s</span> <span class="o">=</span> <span class="n">heartbeat</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">secret</span><span class="p">)</span>
<span class="n">hello_s</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;hellon, some super-secret input&gt;&#39;
</pre></div>
</div>
</div>
</div>
<p>Now, however, the reply <em>does</em> contain secret information:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hello_s</span><span class="p">,</span> <span class="n">ostr</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">hello_s</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[-1, -1, -1, -1, -1, 1005, 1006, 1007, 1008, 1009, 1010, 1011, 1012, 1013, 1014, 1015, 1016, 1017, 1018, 1019, 1020, 1021, 1022, 1023, 1024, 1025, 1026, 1027, 1028, 1029, 1030, 1031]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">hello_s</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="p">[</span><span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">hello_s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/2698516187.py&quot;, line 2, in &lt;module&gt;
    assert hello_s.origin == [ostr.UNKNOWN_ORIGIN] * len(hello_s)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError (expected)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">origin</span> <span class="o">==</span> <span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span> <span class="k">for</span> <span class="n">origin</span> <span class="ow">in</span> <span class="n">hello_s</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/1358366226.py&quot;, line 2, in &lt;module&gt;
    assert all(origin == ostr.UNKNOWN_ORIGIN for origin in hello_s.origin)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError (expected)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">origin</span> <span class="o">&gt;=</span> <span class="n">SECRET_ORIGIN</span> <span class="k">for</span> <span class="n">origin</span> <span class="ow">in</span> <span class="n">hello_s</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/1577803914.py&quot;, line 2, in &lt;module&gt;
    assert not any(origin &gt;= SECRET_ORIGIN for origin in hello_s.origin)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError (expected)
</pre></div>
</div>
</div>
</div>
<p>We can now integrate these assertions into the <code class="docutils literal notranslate"><span class="pre">heartbeat()</span></code> function, causing it to fail before leaking information.  Additionally (or alternatively?), we can also rewrite our output functions not to give out any secret information.  We will leave these two exercises for the reader.</p>
</section>
</section>
<section id="taint-directed-fuzzing">
<h2>Taint-Directed Fuzzing<a class="headerlink" href="#taint-directed-fuzzing" title="Link to this heading">#</a></h2>
<p>The previous <em>Taint Aware Fuzzing</em> was a bit unsatisfactory in that we could not focus on the specific parts of the grammar that led to dangerous operations. We fix that with <em>taint directed fuzzing</em> using <code class="docutils literal notranslate"><span class="pre">TrackingDB</span></code>.</p>
<p>The idea here is to track the origins of each character that reaches <code class="docutils literal notranslate"><span class="pre">eval</span></code>. Then, track it back to the grammar nodes that generated it, and increase the probability of using those nodes again.</p>
<section id="trackingdb">
<h3>TrackingDB<a class="headerlink" href="#trackingdb" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">TrackingDB</span></code> is similar to <code class="docutils literal notranslate"><span class="pre">TaintedDB</span></code>. The difference is that, if we find that the execution has reached the <code class="docutils literal notranslate"><span class="pre">my_eval</span></code>, we simply raise the <code class="docutils literal notranslate"><span class="pre">Tainted</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TrackingDB</span><span class="p">(</span><span class="n">TaintedDB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">my_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">statement</span><span class="o">.</span><span class="n">origin</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Tainted</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SQLException</span><span class="p">(</span><span class="s1">&#39;Invalid SQL (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">statement</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we need a specially crafted fuzzer that preserves the taints.</p>
</section>
<section id="taintedgrammarfuzzer">
<h3>TaintedGrammarFuzzer<a class="headerlink" href="#taintedgrammarfuzzer" title="Link to this heading">#</a></h3>
<p>We define a <code class="docutils literal notranslate"><span class="pre">TaintedGrammarFuzzer</span></code> class that ensures that the taints propagate to the derivation tree. This is similar to the <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code> from the <a class="reference internal" href="GrammarFuzzer.html"><span class="std std-doc">chapter on grammar fuzzers</span></a> except that the origins and taints are preserved.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">GrammarFuzzer</span> <span class="kn">import</span> <span class="n">GrammarFuzzer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Parser</span> <span class="kn">import</span> <span class="n">canonical</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TaintedGrammarFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">grammar</span><span class="p">,</span>
                 <span class="n">start_symbol</span><span class="o">=</span><span class="n">START_SYMBOL</span><span class="p">,</span>
                 <span class="n">expansion_switch</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tainted_start_symbol</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span>
            <span class="n">start_symbol</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_symbol</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expansion_switch</span> <span class="o">=</span> <span class="n">expansion_switch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="o">=</span> <span class="n">grammar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_grammar</span> <span class="o">=</span> <span class="n">canonical</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_tainted_grammar</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">expansion_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expansion</span><span class="p">,</span> <span class="n">seen</span><span class="o">=</span><span class="nb">set</span><span class="p">()):</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">expansion</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_grammar</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">s</span> <span class="ow">in</span> <span class="n">seen</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol_cost</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">seen</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">fuzz_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tainted_start_symbol</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">nt_leaves</span> <span class="o">=</span> <span class="p">[</span><span class="n">tree</span><span class="p">]</span>
        <span class="n">expansion_trials</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">nt_leaves</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nt_leaves</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="n">nt_leaves</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">expansions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ct_grammar</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">expansion_trials</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">expansion_switch</span><span class="p">:</span>
                <span class="n">expansion</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">expansions</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">costs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">expansion_cost</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">expansions</span><span class="p">]</span>
                <span class="n">m</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">costs</span><span class="p">)</span>
                <span class="n">all_min</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">costs</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">m</span><span class="p">]</span>
                <span class="n">expansion</span> <span class="o">=</span> <span class="n">expansions</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">all_min</span><span class="p">)]</span>

            <span class="n">new_leaves</span> <span class="o">=</span> <span class="p">[(</span><span class="n">token</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">expansion</span><span class="p">]</span>
            <span class="n">new_nt_leaves</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">new_leaves</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ct_grammar</span><span class="p">]</span>
            <span class="n">children</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">new_leaves</span>
            <span class="n">nt_leaves</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_nt_leaves</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%-40s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot; -&gt; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">expansion</span><span class="p">)))</span>
            <span class="n">expansion_trials</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">tree</span>

    <span class="k">def</span> <span class="nf">fuzz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">derivation_tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fuzz_tree</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_to_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We use a specially prepared tainted grammar for fuzzing. We mark each individual definition, each individual rule, and each individual token with a separate origin (we chose a token boundary of 10 here, after inspecting the grammar). This allows us to track exactly which parts of the grammar were involved in the operations we are interested in.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TaintedGrammarFuzzer</span><span class="p">(</span><span class="n">TaintedGrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">init_tainted_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">key_increment</span><span class="p">,</span> <span class="n">alt_increment</span><span class="p">,</span> <span class="n">token_increment</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span>
        <span class="n">key_origin</span> <span class="o">=</span> <span class="n">key_increment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ct_grammar</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_grammar</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">key_origin</span> <span class="o">+=</span> <span class="n">key_increment</span>
            <span class="n">os</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">key_origin</span> <span class="o">+=</span> <span class="n">alt_increment</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">nt</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">key_origin</span><span class="p">)</span>
                    <span class="n">key_origin</span> <span class="o">+=</span> <span class="n">token_increment</span>
                    <span class="n">ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nt</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ct_grammar</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span>

        <span class="c1"># a use tracking grammar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctp_grammar</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ct_grammar</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ctp_grammar</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">use</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>As before, we initialize the <code class="docutils literal notranslate"><span class="pre">TrackingDB</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trdb</span> <span class="o">=</span> <span class="n">TrackingDB</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we need to ensure that the taints are preserved, when the tree is converted back to a string. For this, we define the <code class="docutils literal notranslate"><span class="pre">tainted_tree_to_string()</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TaintedGrammarFuzzer</span><span class="p">(</span><span class="n">TaintedGrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">tree_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
        <span class="n">symbol</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">tree</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">children</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_to_string</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">children</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">e</span> <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_grammar</span> <span class="k">else</span> <span class="n">symbol</span>
</pre></div>
</div>
</div>
</div>
<p>We define <code class="docutils literal notranslate"><span class="pre">update_grammar()</span></code> that accepts a set of origins that reached the dangerous operations and the derivation tree of the original string used for fuzzing to update the enhanced grammar.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TaintedGrammarFuzzer</span><span class="p">(</span><span class="n">TaintedGrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">update_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">dtree</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">update_tree</span><span class="p">(</span><span class="n">dtree</span><span class="p">,</span> <span class="n">origin</span><span class="p">):</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="n">dtree</span>
            <span class="k">if</span> <span class="n">children</span><span class="p">:</span>
                <span class="n">updated_children</span> <span class="o">=</span> <span class="p">[</span><span class="n">update_tree</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">children</span><span class="p">]</span>
                <span class="n">corigin</span> <span class="o">=</span> <span class="nb">set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
                    <span class="o">*</span><span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span> <span class="ow">in</span> <span class="n">updated_children</span><span class="p">])</span>
                <span class="n">corigin</span> <span class="o">=</span> <span class="n">corigin</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">origin</span><span class="p">))</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="n">corigin</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">my_origin</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[],</span> <span class="n">my_origin</span><span class="p">)</span>

        <span class="n">key</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="n">oset</span> <span class="o">=</span> <span class="n">update_tree</span><span class="p">(</span><span class="n">dtree</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">origin</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">alts</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctp_grammar</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">alt</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">alts</span><span class="p">:</span>
                <span class="n">alt_origins</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">alt</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">token</span><span class="o">.</span><span class="n">origin</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">alt_origins</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">oset</span><span class="p">):</span>
                    <span class="n">o</span><span class="p">[</span><span class="s1">&#39;use&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<p>With these, we are now ready to fuzz.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">tree_type</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
    <span class="n">key</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="n">tree</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">key</span><span class="p">,</span> <span class="p">[</span><span class="n">tree_type</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">children</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tgf</span> <span class="o">=</span> <span class="n">TaintedGrammarFuzzer</span><span class="p">(</span><span class="n">INVENTORY_GRAMMAR_F</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">qtree</span> <span class="o">=</span> <span class="n">tgf</span><span class="o">.</span><span class="n">fuzz_tree</span><span class="p">()</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">tgf</span><span class="o">.</span><span class="n">tree_to_string</span><span class="p">(</span><span class="n">qtree</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">ostr</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">trdb</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">SQLException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Tainted</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">origin</span>
        <span class="n">tgf</span><span class="o">.</span><span class="n">update_grammar</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">qtree</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">break</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;select (g!=(9)!=((:)==2==9)!=J)==-7 from inventory&#39;
Tainted[((g!=(9)!=((:)==2==9)!=J)==-7)]

&#39;delete from inventory where ((c)==T)!=5==(8!=Y)!=-5&#39;
Tainted[((c)==T)!=5==(8!=Y)!=-5]

&#39;select (((w==(((X!=------8)))))) from inventory&#39;
Tainted[((((w==(((X!=------8)))))))]

&#39;delete from inventory where ((.==(-3)!=(((-3))))!=(S==(((n))==Y))!=--2!=N==-----0==--0)!=(((((R))))==((v)))!=((((((------2==Q==-8!=(q)!=(((.!=2))==J)!=(1)!=(((-4!=--5==J!=(((A==.)))))!=(((((0==(P!=((R))!=(((j)))!=7))))==O==K))==(q))==--1==((H)==(t)==s!=-6==((y))==R)!=((H))!=W==--4==(P==(u)==-0)!=O==((-5==-------2!=4!=U))!=-1==((((((R!=-6))))))!=1!=Z)))==(((I)!=((S))!=(-4==s)==(7!=(A))==(s)==p==((_)!=(C))==((w)))))))&#39;
Tainted[((.==(-3)!=(((-3))))!=(S==(((n))==Y))!=--2!=N==-----0==--0)!=(((((R))))==((v)))!=((((((------2==Q==-8!=(q)!=(((.!=2))==J)!=(1)!=(((-4!=--5==J!=(((A==.)))))!=(((((0==(P!=((R))!=(((j)))!=7))))==O==K))==(q))==--1==((H)==(t)==s!=-6==((y))==R)!=((H))!=W==--4==(P==(u)==-0)!=O==((-5==-------2!=4!=U))!=-1==((((((R!=-6))))))!=1!=Z)))==(((I)!=((S))!=(-4==s)==(7!=(A))==(s)==p==((_)!=(C))==((w)))))))]

&#39;delete from inventory where ((2)==T!=-1)==N==(P)==((((((6==a)))))!=8)==(3)!=((---7))&#39;
Tainted[((2)==T!=-1)==N==(P)==((((((6==a)))))!=8)==(3)!=((---7))]

&#39;delete from inventory where o!=2==---5==3!=t&#39;
Tainted[o!=2==---5==3!=t]

&#39;select (2) from inventory&#39;
Tainted[((2))]

&#39;select _ from inventory&#39;
Tainted[(_)]

&#39;select L!=(((1!=(Z)==C)!=C))==(((-0==-5==Q!=((--2!=(-0)==((0))==M)==(A))!=(X)!=e==(K==((b)))!=b==9==((((l)!=-7!=4)!=s==G))!=6==((((5==(((v==(((((((a!=d))==0!=4!=(4)==--1==(h)==-8!=(9)==-4)))))!=I!=-4))==v!=(Y==b)))==(a))!=((7)))))))==((4)) from inventory&#39;
Tainted[(L!=(((1!=(Z)==C)!=C))==(((-0==-5==Q!=((--2!=(-0)==((0))==M)==(A))!=(X)!=e==(K==((b)))!=b==9==((((l)!=-7!=4)!=s==G))!=6==((((5==(((v==(((((((a!=d))==0!=4!=(4)==--1==(h)==-8!=(9)==-4)))))!=I!=-4))==v!=(Y==b)))==(a))!=((7)))))))==((4)))]

&#39;delete from inventory where _==(7==(9)!=(---5)==1)==-8&#39;
Tainted[_==(7==(9)!=(---5)==1)==-8]
</pre></div>
</div>
</div>
</div>
<p>We can now inspect our enhanced grammar to see how many times each rule was used.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tgf</span><span class="o">.</span><span class="n">ctp_grammar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&lt;start&gt;&#39;: [([&#39;&lt;query&gt;&#39;], {&#39;use&#39;: 10})],
 &#39;&lt;expr&gt;&#39;: [([&#39;&lt;bexpr&gt;&#39;], {&#39;use&#39;: 8}),
  ([&#39;&lt;aexpr&gt;&#39;], {&#39;use&#39;: 8}),
  ([&#39;(&#39;, &#39;&lt;expr&gt;&#39;, &#39;)&#39;], {&#39;use&#39;: 8}),
  ([&#39;&lt;term&gt;&#39;], {&#39;use&#39;: 10})],
 &#39;&lt;bexpr&gt;&#39;: [([&#39;&lt;aexpr&gt;&#39;, &#39;&lt;lt&gt;&#39;, &#39;&lt;aexpr&gt;&#39;], {&#39;use&#39;: 0}),
  ([&#39;&lt;aexpr&gt;&#39;, &#39;&lt;gt&gt;&#39;, &#39;&lt;aexpr&gt;&#39;], {&#39;use&#39;: 0}),
  ([&#39;&lt;expr&gt;&#39;, &#39;==&#39;, &#39;&lt;expr&gt;&#39;], {&#39;use&#39;: 8}),
  ([&#39;&lt;expr&gt;&#39;, &#39;!=&#39;, &#39;&lt;expr&gt;&#39;], {&#39;use&#39;: 8})],
 &#39;&lt;aexpr&gt;&#39;: [([&#39;&lt;aexpr&gt;&#39;, &#39;+&#39;, &#39;&lt;aexpr&gt;&#39;], {&#39;use&#39;: 0}),
  ([&#39;&lt;aexpr&gt;&#39;, &#39;-&#39;, &#39;&lt;aexpr&gt;&#39;], {&#39;use&#39;: 0}),
  ([&#39;&lt;aexpr&gt;&#39;, &#39;*&#39;, &#39;&lt;aexpr&gt;&#39;], {&#39;use&#39;: 0}),
  ([&#39;&lt;aexpr&gt;&#39;, &#39;/&#39;, &#39;&lt;aexpr&gt;&#39;], {&#39;use&#39;: 0}),
  ([&#39;&lt;word&gt;&#39;, &#39;(&#39;, &#39;&lt;exprs&gt;&#39;, &#39;)&#39;], {&#39;use&#39;: 0}),
  ([&#39;&lt;expr&gt;&#39;], {&#39;use&#39;: 8})],
 &#39;&lt;exprs&gt;&#39;: [([&#39;&lt;expr&gt;&#39;, &#39;,&#39;, &#39;&lt;exprs&gt;&#39;], {&#39;use&#39;: 0}),
  ([&#39;&lt;expr&gt;&#39;], {&#39;use&#39;: 5})],
 &#39;&lt;lt&gt;&#39;: [([&#39;&lt;&#39;], {&#39;use&#39;: 0})],
 &#39;&lt;gt&gt;&#39;: [([&#39;&gt;&#39;], {&#39;use&#39;: 0})],
 &#39;&lt;term&gt;&#39;: [([&#39;&lt;number&gt;&#39;], {&#39;use&#39;: 9}), ([&#39;&lt;word&gt;&#39;], {&#39;use&#39;: 9})],
 &#39;&lt;number&gt;&#39;: [([&#39;&lt;integer&gt;&#39;, &#39;.&#39;, &#39;&lt;integer&gt;&#39;], {&#39;use&#39;: 0}),
  ([&#39;&lt;integer&gt;&#39;], {&#39;use&#39;: 9}),
  ([&#39;-&#39;, &#39;&lt;number&gt;&#39;], {&#39;use&#39;: 8})],
 &#39;&lt;integer&gt;&#39;: [([&#39;&lt;digit&gt;&#39;, &#39;&lt;integer&gt;&#39;], {&#39;use&#39;: 0}),
  ([&#39;&lt;digit&gt;&#39;], {&#39;use&#39;: 9})],
 &#39;&lt;word&gt;&#39;: [([&#39;&lt;word&gt;&#39;, &#39;&lt;letter&gt;&#39;], {&#39;use&#39;: 0}),
  ([&#39;&lt;word&gt;&#39;, &#39;&lt;digit&gt;&#39;], {&#39;use&#39;: 0}),
  ([&#39;&lt;letter&gt;&#39;], {&#39;use&#39;: 9})],
 &#39;&lt;digit&gt;&#39;: [([&#39;0&#39;], {&#39;use&#39;: 2}),
  ([&#39;1&#39;], {&#39;use&#39;: 4}),
  ([&#39;2&#39;], {&#39;use&#39;: 6}),
  ([&#39;3&#39;], {&#39;use&#39;: 3}),
  ([&#39;4&#39;], {&#39;use&#39;: 2}),
  ([&#39;5&#39;], {&#39;use&#39;: 5}),
  ([&#39;6&#39;], {&#39;use&#39;: 3}),
  ([&#39;7&#39;], {&#39;use&#39;: 5}),
  ([&#39;8&#39;], {&#39;use&#39;: 6}),
  ([&#39;9&#39;], {&#39;use&#39;: 3})],
 &#39;&lt;letter&gt;&#39;: [([&#39;a&#39;], {&#39;use&#39;: 2}),
  ([&#39;b&#39;], {&#39;use&#39;: 1}),
  ([&#39;c&#39;], {&#39;use&#39;: 1}),
  ([&#39;d&#39;], {&#39;use&#39;: 1}),
  ([&#39;e&#39;], {&#39;use&#39;: 1}),
  ([&#39;f&#39;], {&#39;use&#39;: 0}),
  ([&#39;g&#39;], {&#39;use&#39;: 1}),
  ([&#39;h&#39;], {&#39;use&#39;: 1}),
  ([&#39;i&#39;], {&#39;use&#39;: 0}),
  ([&#39;j&#39;], {&#39;use&#39;: 1}),
  ([&#39;k&#39;], {&#39;use&#39;: 0}),
  ([&#39;l&#39;], {&#39;use&#39;: 1}),
  ([&#39;m&#39;], {&#39;use&#39;: 0}),
  ([&#39;n&#39;], {&#39;use&#39;: 1}),
  ([&#39;o&#39;], {&#39;use&#39;: 1}),
  ([&#39;p&#39;], {&#39;use&#39;: 1}),
  ([&#39;q&#39;], {&#39;use&#39;: 1}),
  ([&#39;r&#39;], {&#39;use&#39;: 0}),
  ([&#39;s&#39;], {&#39;use&#39;: 2}),
  ([&#39;t&#39;], {&#39;use&#39;: 2}),
  ([&#39;u&#39;], {&#39;use&#39;: 1}),
  ([&#39;v&#39;], {&#39;use&#39;: 2}),
  ([&#39;w&#39;], {&#39;use&#39;: 2}),
  ([&#39;x&#39;], {&#39;use&#39;: 0}),
  ([&#39;y&#39;], {&#39;use&#39;: 1}),
  ([&#39;z&#39;], {&#39;use&#39;: 0}),
  ([&#39;A&#39;], {&#39;use&#39;: 2}),
  ([&#39;B&#39;], {&#39;use&#39;: 0}),
  ([&#39;C&#39;], {&#39;use&#39;: 2}),
  ([&#39;D&#39;], {&#39;use&#39;: 0}),
  ([&#39;E&#39;], {&#39;use&#39;: 0}),
  ([&#39;F&#39;], {&#39;use&#39;: 0}),
  ([&#39;G&#39;], {&#39;use&#39;: 1}),
  ([&#39;H&#39;], {&#39;use&#39;: 1}),
  ([&#39;I&#39;], {&#39;use&#39;: 2}),
  ([&#39;J&#39;], {&#39;use&#39;: 2}),
  ([&#39;K&#39;], {&#39;use&#39;: 2}),
  ([&#39;L&#39;], {&#39;use&#39;: 1}),
  ([&#39;M&#39;], {&#39;use&#39;: 1}),
  ([&#39;N&#39;], {&#39;use&#39;: 2}),
  ([&#39;O&#39;], {&#39;use&#39;: 1}),
  ([&#39;P&#39;], {&#39;use&#39;: 2}),
  ([&#39;Q&#39;], {&#39;use&#39;: 2}),
  ([&#39;R&#39;], {&#39;use&#39;: 1}),
  ([&#39;S&#39;], {&#39;use&#39;: 1}),
  ([&#39;T&#39;], {&#39;use&#39;: 2}),
  ([&#39;U&#39;], {&#39;use&#39;: 1}),
  ([&#39;V&#39;], {&#39;use&#39;: 0}),
  ([&#39;W&#39;], {&#39;use&#39;: 1}),
  ([&#39;X&#39;], {&#39;use&#39;: 2}),
  ([&#39;Y&#39;], {&#39;use&#39;: 3}),
  ([&#39;Z&#39;], {&#39;use&#39;: 2}),
  ([&#39;_&#39;], {&#39;use&#39;: 3}),
  ([&#39;:&#39;], {&#39;use&#39;: 1}),
  ([&#39;.&#39;], {&#39;use&#39;: 1})],
 &#39;&lt;query&gt;&#39;: [([&#39;select &#39;, &#39;&lt;exprs&gt;&#39;, &#39; from &#39;, &#39;&lt;table&gt;&#39;], {&#39;use&#39;: 5}),
  ([&#39;select &#39;, &#39;&lt;exprs&gt;&#39;, &#39; from &#39;, &#39;&lt;table&gt;&#39;, &#39; where &#39;, &#39;&lt;bexpr&gt;&#39;],
   {&#39;use&#39;: 0}),
  ([&#39;insert into &#39;,
    &#39;&lt;table&gt;&#39;,
    &#39; (&#39;,
    &#39;&lt;names&gt;&#39;,
    &#39;) values (&#39;,
    &#39;&lt;literals&gt;&#39;,
    &#39;)&#39;],
   {&#39;use&#39;: 0}),
  ([&#39;update &#39;, &#39;&lt;table&gt;&#39;, &#39; set &#39;, &#39;&lt;assignments&gt;&#39;, &#39; where &#39;, &#39;&lt;bexpr&gt;&#39;],
   {&#39;use&#39;: 0}),
  ([&#39;delete from &#39;, &#39;&lt;table&gt;&#39;, &#39; where &#39;, &#39;&lt;bexpr&gt;&#39;], {&#39;use&#39;: 5})],
 &#39;&lt;table&gt;&#39;: [([&#39;inventory&#39;], {&#39;use&#39;: 0})],
 &#39;&lt;names&gt;&#39;: [([&#39;&lt;column&gt;&#39;, &#39;,&#39;, &#39;&lt;names&gt;&#39;], {&#39;use&#39;: 0}),
  ([&#39;&lt;column&gt;&#39;], {&#39;use&#39;: 0})],
 &#39;&lt;column&gt;&#39;: [([&#39;&lt;word&gt;&#39;], {&#39;use&#39;: 0})],
 &#39;&lt;literals&gt;&#39;: [([&#39;&lt;literal&gt;&#39;], {&#39;use&#39;: 0}),
  ([&#39;&lt;literal&gt;&#39;, &#39;,&#39;, &#39;&lt;literals&gt;&#39;], {&#39;use&#39;: 0})],
 &#39;&lt;literal&gt;&#39;: [([&#39;&lt;number&gt;&#39;], {&#39;use&#39;: 0}),
  ([&quot;&#39;&quot;, &#39;&lt;chars&gt;&#39;, &quot;&#39;&quot;], {&#39;use&#39;: 0})],
 &#39;&lt;assignments&gt;&#39;: [([&#39;&lt;kvp&gt;&#39;, &#39;,&#39;, &#39;&lt;assignments&gt;&#39;], {&#39;use&#39;: 0}),
  ([&#39;&lt;kvp&gt;&#39;], {&#39;use&#39;: 0})],
 &#39;&lt;kvp&gt;&#39;: [([&#39;&lt;column&gt;&#39;, &#39;=&#39;, &#39;&lt;value&gt;&#39;], {&#39;use&#39;: 0})],
 &#39;&lt;value&gt;&#39;: [([&#39;&lt;word&gt;&#39;], {&#39;use&#39;: 0})],
 &#39;&lt;chars&gt;&#39;: [([&#39;&lt;char&gt;&#39;], {&#39;use&#39;: 0}), ([&#39;&lt;char&gt;&#39;, &#39;&lt;chars&gt;&#39;], {&#39;use&#39;: 0})],
 &#39;&lt;char&gt;&#39;: [([&#39;0&#39;], {&#39;use&#39;: 0}),
  ([&#39;1&#39;], {&#39;use&#39;: 0}),
  ([&#39;2&#39;], {&#39;use&#39;: 0}),
  ([&#39;3&#39;], {&#39;use&#39;: 0}),
  ([&#39;4&#39;], {&#39;use&#39;: 0}),
  ([&#39;5&#39;], {&#39;use&#39;: 0}),
  ([&#39;6&#39;], {&#39;use&#39;: 0}),
  ([&#39;7&#39;], {&#39;use&#39;: 0}),
  ([&#39;8&#39;], {&#39;use&#39;: 0}),
  ([&#39;9&#39;], {&#39;use&#39;: 0}),
  ([&#39;a&#39;], {&#39;use&#39;: 0}),
  ([&#39;b&#39;], {&#39;use&#39;: 0}),
  ([&#39;c&#39;], {&#39;use&#39;: 0}),
  ([&#39;d&#39;], {&#39;use&#39;: 0}),
  ([&#39;e&#39;], {&#39;use&#39;: 0}),
  ([&#39;f&#39;], {&#39;use&#39;: 0}),
  ([&#39;g&#39;], {&#39;use&#39;: 0}),
  ([&#39;h&#39;], {&#39;use&#39;: 0}),
  ([&#39;i&#39;], {&#39;use&#39;: 0}),
  ([&#39;j&#39;], {&#39;use&#39;: 0}),
  ([&#39;k&#39;], {&#39;use&#39;: 0}),
  ([&#39;l&#39;], {&#39;use&#39;: 0}),
  ([&#39;m&#39;], {&#39;use&#39;: 0}),
  ([&#39;n&#39;], {&#39;use&#39;: 0}),
  ([&#39;o&#39;], {&#39;use&#39;: 0}),
  ([&#39;p&#39;], {&#39;use&#39;: 0}),
  ([&#39;q&#39;], {&#39;use&#39;: 0}),
  ([&#39;r&#39;], {&#39;use&#39;: 0}),
  ([&#39;s&#39;], {&#39;use&#39;: 0}),
  ([&#39;t&#39;], {&#39;use&#39;: 0}),
  ([&#39;u&#39;], {&#39;use&#39;: 0}),
  ([&#39;v&#39;], {&#39;use&#39;: 0}),
  ([&#39;w&#39;], {&#39;use&#39;: 0}),
  ([&#39;x&#39;], {&#39;use&#39;: 0}),
  ([&#39;y&#39;], {&#39;use&#39;: 0}),
  ([&#39;z&#39;], {&#39;use&#39;: 0}),
  ([&#39;A&#39;], {&#39;use&#39;: 0}),
  ([&#39;B&#39;], {&#39;use&#39;: 0}),
  ([&#39;C&#39;], {&#39;use&#39;: 0}),
  ([&#39;D&#39;], {&#39;use&#39;: 0}),
  ([&#39;E&#39;], {&#39;use&#39;: 0}),
  ([&#39;F&#39;], {&#39;use&#39;: 0}),
  ([&#39;G&#39;], {&#39;use&#39;: 0}),
  ([&#39;H&#39;], {&#39;use&#39;: 0}),
  ([&#39;I&#39;], {&#39;use&#39;: 0}),
  ([&#39;J&#39;], {&#39;use&#39;: 0}),
  ([&#39;K&#39;], {&#39;use&#39;: 0}),
  ([&#39;L&#39;], {&#39;use&#39;: 0}),
  ([&#39;M&#39;], {&#39;use&#39;: 0}),
  ([&#39;N&#39;], {&#39;use&#39;: 0}),
  ([&#39;O&#39;], {&#39;use&#39;: 0}),
  ([&#39;P&#39;], {&#39;use&#39;: 0}),
  ([&#39;Q&#39;], {&#39;use&#39;: 0}),
  ([&#39;R&#39;], {&#39;use&#39;: 0}),
  ([&#39;S&#39;], {&#39;use&#39;: 0}),
  ([&#39;T&#39;], {&#39;use&#39;: 0}),
  ([&#39;U&#39;], {&#39;use&#39;: 0}),
  ([&#39;V&#39;], {&#39;use&#39;: 0}),
  ([&#39;W&#39;], {&#39;use&#39;: 0}),
  ([&#39;X&#39;], {&#39;use&#39;: 0}),
  ([&#39;Y&#39;], {&#39;use&#39;: 0}),
  ([&#39;Z&#39;], {&#39;use&#39;: 0}),
  ([&#39;!&#39;], {&#39;use&#39;: 0}),
  ([&#39;#&#39;], {&#39;use&#39;: 0}),
  ([&#39;$&#39;], {&#39;use&#39;: 0}),
  ([&#39;%&#39;], {&#39;use&#39;: 0}),
  ([&#39;&amp;&#39;], {&#39;use&#39;: 0}),
  ([&#39;(&#39;], {&#39;use&#39;: 0}),
  ([&#39;)&#39;], {&#39;use&#39;: 0}),
  ([&#39;*&#39;], {&#39;use&#39;: 0}),
  ([&#39;+&#39;], {&#39;use&#39;: 0}),
  ([&#39;,&#39;], {&#39;use&#39;: 0}),
  ([&#39;-&#39;], {&#39;use&#39;: 0}),
  ([&#39;.&#39;], {&#39;use&#39;: 0}),
  ([&#39;/&#39;], {&#39;use&#39;: 0}),
  ([&#39;:&#39;], {&#39;use&#39;: 0}),
  ([&#39;;&#39;], {&#39;use&#39;: 0}),
  ([&#39;=&#39;], {&#39;use&#39;: 0}),
  ([&#39;?&#39;], {&#39;use&#39;: 0}),
  ([&#39;@&#39;], {&#39;use&#39;: 0}),
  ([&#39;[&#39;], {&#39;use&#39;: 0}),
  ([&#39;\\&#39;], {&#39;use&#39;: 0}),
  ([&#39;]&#39;], {&#39;use&#39;: 0}),
  ([&#39;^&#39;], {&#39;use&#39;: 0}),
  ([&#39;_&#39;], {&#39;use&#39;: 0}),
  ([&#39;`&#39;], {&#39;use&#39;: 0}),
  ([&#39;{&#39;], {&#39;use&#39;: 0}),
  ([&#39;|&#39;], {&#39;use&#39;: 0}),
  ([&#39;}&#39;], {&#39;use&#39;: 0}),
  ([&#39;~&#39;], {&#39;use&#39;: 0}),
  ([&#39; &#39;], {&#39;use&#39;: 0}),
  ([&#39;&lt;lt&gt;&#39;], {&#39;use&#39;: 0}),
  ([&#39;&lt;gt&gt;&#39;], {&#39;use&#39;: 0})]}
</pre></div>
</div>
</div>
</div>
<p>From here, the idea is to focus on the rules that reached dangerous operations more often, and increase the probability of the values of that kind.</p>
</section>
<section id="the-limits-of-taint-tracking">
<h3>The Limits of Taint Tracking<a class="headerlink" href="#the-limits-of-taint-tracking" title="Link to this heading">#</a></h3>
<p>While our framework can detect information leakage, it is by no means perfect.  There are several ways in which taints can get lost and information thus may still leak out.</p>
<section id="conversions">
<h4>Conversions<a class="headerlink" href="#conversions" title="Link to this heading">#</a></h4>
<p>We only track taints and origins through <em>strings</em> and <em>characters</em>.  If we convert these to numbers (or other data), the information is lost.</p>
<p>As an example, consider this function, converting individual characters to numbers and back:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">strip_all_info</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">t</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">othello</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">&quot;Secret&quot;</span><span class="p">)</span>
<span class="n">othello</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Secret&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">othello</span><span class="o">.</span><span class="n">origin</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0, 1, 2, 3, 4, 5]
</pre></div>
</div>
</div>
</div>
<p>The taints and origins will not propagate through the number conversion:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thello_stripped</span> <span class="o">=</span> <span class="n">strip_all_info</span><span class="p">(</span><span class="n">thello</span><span class="p">)</span>
<span class="n">thello_stripped</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;hello, world&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">thello_stripped</span><span class="o">.</span><span class="n">origin</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/588526133.py&quot;, line 2, in &lt;module&gt;
    thello_stripped.origin
AttributeError: &#39;str&#39; object has no attribute &#39;origin&#39; (expected)
</pre></div>
</div>
</div>
</div>
<p>This issue could be addressed by extending numbers with taints and origins, just as we did for strings.  At some point, however, this will still break down, because as soon as an internal C function in the Python library is reached, the taint will not propagate into and across the C function.  (Unless one starts implementing dynamic taints for these, that is.)</p>
</section>
<section id="internal-c-libraries">
<h4>Internal C libraries<a class="headerlink" href="#internal-c-libraries" title="Link to this heading">#</a></h4>
<p>As we mentioned before, calls to <em>internal</em> C libraries do not propagate taints. For example, while the following preserves the taints,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hello</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">world</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="p">(</span><span class="n">hello</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">world</span><span class="p">)</span><span class="o">.</span><span class="n">origin</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[100, 101, 102, 103, 104, -1, 200, 201, 202, 203, 204]
</pre></div>
</div>
</div>
</div>
<p>a call to a <code class="docutils literal notranslate"><span class="pre">join</span></code> that should be equivalent will fail.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">hello</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">world</span><span class="p">])</span><span class="o">.</span><span class="n">origin</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/2341342688.py&quot;, line 2, in &lt;module&gt;
    &#39;&#39;.join([hello, &#39; &#39;, world]).origin  # type: ignore
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: &#39;str&#39; object has no attribute &#39;origin&#39; (expected)
</pre></div>
</div>
</div>
</div>
</section>
<section id="implicit-information-flow">
<h4>Implicit Information Flow<a class="headerlink" href="#implicit-information-flow" title="Link to this heading">#</a></h4>
<p>Even if one could taint all data in a program, there still would be means to break information flow – notably by turning explicit flow into <em>implicit</em> flow, or data flow into <em>control flow</em>.  Here is an example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">strip_all_info_again</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="s1">&#39;a&#39;</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="s1">&#39;b&#39;</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="s1">&#39;c&#39;</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
</div>
<p>With such a function, there is no explicit data flow between the characters in <code class="docutils literal notranslate"><span class="pre">s</span></code> and the characters in <code class="docutils literal notranslate"><span class="pre">t</span></code>; yet, the strings would be identical.  This problem frequently occurs in programs that process and manipulate external input.</p>
</section>
<section id="enforcing-tainting">
<h4>Enforcing Tainting<a class="headerlink" href="#enforcing-tainting" title="Link to this heading">#</a></h4>
<p>Both, conversions and implicit information flow are one of several possibilities how taint and origin information get lost.  To address the problem, the best solution is to <em>always assume the worst from untainted strings</em>:</p>
<ul class="simple">
<li><p>As it comes to trust, an untainted string should be treated as <em>possibly untrusted</em>, and hence not relied upon unless sanitized.</p></li>
<li><p>As it comes to privacy, an untainted string should be treated as <em>possibly secret</em>, and hence not leaked out.</p></li>
</ul>
<p>As a consequence, your program should always have two kinds of taints: one for explicitly trusted (or secret) and one for explicitly untrusted (or non-secret).  If a taint gets lost along the way, you may have to restore it from its sources – not unlike the string methods discussed above.  The benefit is a trusted application, in which each and every information flow can be checked at runtime, with violations quickly discovered through automated tests.</p>
</section>
</section>
</section>
<section id="id4">
<h2>Synopsis<a class="headerlink" href="#id4" title="Link to this heading">#</a></h2>
<p>This chapter provides two wrappers to Python <em>strings</em> that allow one to track various properties. These include information on the security properties of the input, and information on originating indexes of the input string.</p>
<section id="id5">
<h3>Tracking String Taints<a class="headerlink" href="#id5" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">tstr</span></code> objects are replacements for Python strings that allows tracking and checking <em>taints</em> – that is, information on from where a string originated. For instance, one can mark strings that originate from third party input with a taint of “LOW”, meaning that they have a low security level. The taint is passed in the constructor of a <code class="docutils literal notranslate"><span class="pre">tstr</span></code> object:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thello</span> <span class="o">=</span> <span class="n">tstr</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;LOW&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">tstr</span></code> object is fully compatible with original Python strings. For instance, we can index it and access substrings:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thello</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;hell&#39;
</pre></div>
</div>
</div>
</div>
<p>However, the <code class="docutils literal notranslate"><span class="pre">tstr</span></code> object also stores the taint, which can be accessed using the <code class="docutils literal notranslate"><span class="pre">taint</span></code> attribute:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thello</span><span class="o">.</span><span class="n">taint</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;LOW&#39;
</pre></div>
</div>
</div>
</div>
<p>The neat thing about taints is that they propagate to all strings derived from the original tainted string.
Indeed, any operation from a  <code class="docutils literal notranslate"><span class="pre">tstr</span></code> string that results in a string fragment produces another <code class="docutils literal notranslate"><span class="pre">tstr</span></code> object that includes the original taint. For example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thello</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">taint</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;LOW&#39;
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">tstr</span></code> objects duplicate most <code class="docutils literal notranslate"><span class="pre">str</span></code> methods, as indicated in the class diagram:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="kn">from</span> <span class="nn">ClassDiagram</span> <span class="kn">import</span> <span class="n">display_class_hierarchy</span>
<span class="n">display_class_hierarchy</span><span class="p">(</span><span class="n">tstr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (20241206.2353)
 -->
<!-- Pages: 1 -->
<svg width="270pt" height="562pt"
 viewBox="0.00 0.00 269.62 562.25" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 558.25)">
<g id="a_graph0"><a xlink:title="tstr class hierarchy">
<polygon fill="white" stroke="none" points="-4,4 -4,-558.25 265.62,-558.25 265.62,4 -4,4"/>
</a>
</g>
<!-- tstr -->
<g id="node1" class="node">
<title>tstr</title>
<g id="a_node1"><a xlink:href="#" xlink:title="class tstr:&#10;Wrapper for strings, saving taint information">
<polygon fill="none" stroke="black" points="0,-0.5 0,-480.75 124,-480.75 124,-0.5 0,-0.5"/>
<text text-anchor="start" x="51.12" y="-464.45" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">tstr</text>
<polyline fill="none" stroke="black" points="0,-454.75 124,-454.75"/>
<g id="a_node1_0"><a xlink:href="#" xlink:title="tstr">
<g id="a_node1_1"><a xlink:href="#" xlink:title="__add__(self, *args, **kwargs):&#10;Return self+value.">
<text text-anchor="start" x="8" y="-442.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__add__()</text>
</a>
</g>
<g id="a_node1_2"><a xlink:href="#" xlink:title="__format__(self, *args, **kwargs):&#10;Return a formatted version of the string as described by format_spec.">
<text text-anchor="start" x="8" y="-429.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__format__()</text>
</a>
</g>
<g id="a_node1_3"><a xlink:href="#" xlink:title="__getitem__(self, *args, **kwargs):&#10;Return self[key].">
<text text-anchor="start" x="8" y="-416.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__getitem__()</text>
</a>
</g>
<g id="a_node1_4"><a xlink:href="#" xlink:title="__init__(self, value: Any, taint: Any = None, **kwargs) &#45;&gt; None:&#10;Constructor.&#10;`value` is the string value the `tstr` object is to be constructed from.&#10;`taint` is an (optional) taint to be propagated to derived strings.">
<text text-anchor="start" x="8" y="-404" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node1_5"><a xlink:href="#" xlink:title="__mod__(self, *args, **kwargs):&#10;Return self%value.">
<text text-anchor="start" x="8" y="-391.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__mod__()</text>
</a>
</g>
<g id="a_node1_6"><a xlink:href="#" xlink:title="__mul__(self, *args, **kwargs):&#10;Return self*value.">
<text text-anchor="start" x="8" y="-378.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__mul__()</text>
</a>
</g>
<g id="a_node1_7"><a xlink:href="#" xlink:title="__new__(cls, value, *args, **kw):&#10;Create a tstr() instance. Used internally.">
<text text-anchor="start" x="8" y="-365.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__new__()</text>
</a>
</g>
<g id="a_node1_8"><a xlink:href="#" xlink:title="__radd__(self, value):&#10;Return value + self, as a `tstr` object">
<text text-anchor="start" x="8" y="-353" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__radd__()</text>
</a>
</g>
<g id="a_node1_9"><a xlink:href="#" xlink:title="__repr__(self) &#45;&gt; tstr:&#10;Return a representation.">
<text text-anchor="start" x="8" y="-340.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__repr__()</text>
</a>
</g>
<g id="a_node1_10"><a xlink:href="#" xlink:title="__rmod__(self, *args, **kwargs):&#10;Return value%self.">
<text text-anchor="start" x="8" y="-327.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__rmod__()</text>
</a>
</g>
<g id="a_node1_11"><a xlink:href="#" xlink:title="__rmul__(self, *args, **kwargs):&#10;Return value*self.">
<text text-anchor="start" x="8" y="-314.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__rmul__()</text>
</a>
</g>
<g id="a_node1_12"><a xlink:href="#" xlink:title="__str__(self) &#45;&gt; str:&#10;Convert to string">
<text text-anchor="start" x="8" y="-302" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__str__()</text>
</a>
</g>
<g id="a_node1_13"><a xlink:href="#" xlink:title="capitalize(self, *args, **kwargs):&#10;Return a capitalized version of the string.&#10;&#10;More specifically, make the first character have upper case and the rest lower&#10;case.">
<text text-anchor="start" x="8" y="-289.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">capitalize()</text>
</a>
</g>
<g id="a_node1_14"><a xlink:href="#" xlink:title="casefold(self, *args, **kwargs):&#10;Return a version of the string suitable for caseless comparisons.">
<text text-anchor="start" x="8" y="-276.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">casefold()</text>
</a>
</g>
<g id="a_node1_15"><a xlink:href="#" xlink:title="center(self, *args, **kwargs):&#10;Return a centered string of length width.&#10;&#10;Padding is done using the specified fill character (default is a space).">
<text text-anchor="start" x="8" y="-263.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">center()</text>
</a>
</g>
<g id="a_node1_16"><a xlink:href="#" xlink:title="clear_taint(self):&#10;Remove taint">
<text text-anchor="start" x="8" y="-251" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">clear_taint()</text>
</a>
</g>
<g id="a_node1_17"><a xlink:href="#" xlink:title="encode(self, *args, **kwargs):&#10;Encode the string using the codec registered for encoding.&#10;&#10;encoding&#10;The encoding in which to encode the string.&#10;errors&#10;The error handling scheme to use for encoding errors.&#10;The default is &#39;strict&#39; meaning that encoding errors raise a&#10;UnicodeEncodeError. &#160;Other possible values are &#39;ignore&#39;, &#39;replace&#39; and&#10;&#39;xmlcharrefreplace&#39; as well as any other name registered with&#10;codecs.register_error that can handle UnicodeEncodeErrors.">
<text text-anchor="start" x="8" y="-238.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">encode()</text>
</a>
</g>
<g id="a_node1_18"><a xlink:href="#" xlink:title="expandtabs(self, *args, **kwargs):&#10;Return a copy where all tab characters are expanded using spaces.&#10;&#10;If tabsize is not given, a tab size of 8 characters is assumed.">
<text text-anchor="start" x="8" y="-225.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">expandtabs()</text>
</a>
</g>
<g id="a_node1_19"><a xlink:href="#" xlink:title="format(self, *args, **kwargs):&#10;S.format(*args, **kwargs) &#45;&gt; str&#10;&#10;Return a formatted version of S, using substitutions from args and kwargs.&#10;The substitutions are identified by braces (&#39;{&#39; and &#39;}&#39;).">
<text text-anchor="start" x="8" y="-212.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">format()</text>
</a>
</g>
<g id="a_node1_20"><a xlink:href="#" xlink:title="format_map(self, *args, **kwargs):&#10;S.format_map(mapping) &#45;&gt; str&#10;&#10;Return a formatted version of S, using substitutions from mapping.&#10;The substitutions are identified by braces (&#39;{&#39; and &#39;}&#39;).">
<text text-anchor="start" x="8" y="-200" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">format_map()</text>
</a>
</g>
<g id="a_node1_21"><a xlink:href="#" xlink:title="has_taint(self):&#10;Check if taint is present">
<text text-anchor="start" x="8" y="-187.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">has_taint()</text>
</a>
</g>
<g id="a_node1_22"><a xlink:href="#" xlink:title="join(self, *args, **kwargs):&#10;Concatenate any number of strings.&#10;&#10;The string whose method is called is inserted in between each given string.&#10;The result is returned as a new string.&#10;&#10;Example: &#39;.&#39;.join([&#39;ab&#39;, &#39;pq&#39;, &#39;rs&#39;]) &#45;&gt; &#39;ab.pq.rs&#39;">
<text text-anchor="start" x="8" y="-174.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">join()</text>
</a>
</g>
<g id="a_node1_23"><a xlink:href="#" xlink:title="ljust(self, *args, **kwargs):&#10;Return a left&#45;justified string of length width.&#10;&#10;Padding is done using the specified fill character (default is a space).">
<text text-anchor="start" x="8" y="-161.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">ljust()</text>
</a>
</g>
<g id="a_node1_24"><a xlink:href="#" xlink:title="lower(self, *args, **kwargs):&#10;Return a copy of the string converted to lowercase.">
<text text-anchor="start" x="8" y="-149" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">lower()</text>
</a>
</g>
<g id="a_node1_25"><a xlink:href="#" xlink:title="lstrip(self, *args, **kwargs):&#10;Return a copy of the string with leading whitespace removed.&#10;&#10;If chars is given and not None, remove characters in chars instead.">
<text text-anchor="start" x="8" y="-136.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">lstrip()</text>
</a>
</g>
<g id="a_node1_26"><a xlink:href="#" xlink:title="make_str_wrapper(fun):&#10;Make `fun` (a `str` method) a method in `tstr`">
<text text-anchor="start" x="8" y="-123.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">make_str_wrapper()</text>
</a>
</g>
<g id="a_node1_27"><a xlink:href="#" xlink:title="replace(self, *args, **kwargs):&#10;Return a copy with all occurrences of substring old replaced by new.&#10;&#10;count&#10;Maximum number of occurrences to replace.&#10;&#45;1 (the default value) means replace all occurrences.&#10;&#10;If the optional argument count is given, only the first count occurrences are&#10;replaced.">
<text text-anchor="start" x="8" y="-110.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">replace()</text>
</a>
</g>
<g id="a_node1_28"><a xlink:href="#" xlink:title="rjust(self, *args, **kwargs):&#10;Return a right&#45;justified string of length width.&#10;&#10;Padding is done using the specified fill character (default is a space).">
<text text-anchor="start" x="8" y="-98" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">rjust()</text>
</a>
</g>
<g id="a_node1_29"><a xlink:href="#" xlink:title="rstrip(self, *args, **kwargs):&#10;Return a copy of the string with trailing whitespace removed.&#10;&#10;If chars is given and not None, remove characters in chars instead.">
<text text-anchor="start" x="8" y="-85.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">rstrip()</text>
</a>
</g>
<g id="a_node1_30"><a xlink:href="#" xlink:title="strip(self, *args, **kwargs):&#10;Return a copy of the string with leading and trailing whitespace removed.&#10;&#10;If chars is given and not None, remove characters in chars instead.">
<text text-anchor="start" x="8" y="-72.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">strip()</text>
</a>
</g>
<g id="a_node1_31"><a xlink:href="#" xlink:title="swapcase(self, *args, **kwargs):&#10;Convert uppercase characters to lowercase and lowercase characters to uppercase.">
<text text-anchor="start" x="8" y="-59.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">swapcase()</text>
</a>
</g>
<g id="a_node1_32"><a xlink:href="#" xlink:title="title(self, *args, **kwargs):&#10;Return a version of the string where each word is titlecased.&#10;&#10;More specifically, words start with uppercased characters and all remaining&#10;cased characters have lower case.">
<text text-anchor="start" x="8" y="-47" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">title()</text>
</a>
</g>
<g id="a_node1_33"><a xlink:href="#" xlink:title="translate(self, *args, **kwargs):&#10;Replace each character in the string using the given translation table.&#10;&#10;table&#10;Translation table, which must be a mapping of Unicode ordinals to&#10;Unicode ordinals, strings, or None.&#10;&#10;The table must implement lookup/indexing via __getitem__, for instance a&#10;dictionary or list. &#160;If this operation raises LookupError, the character is&#10;left untouched. &#160;Characters mapped to None are deleted.">
<text text-anchor="start" x="8" y="-34.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">translate()</text>
</a>
</g>
<g id="a_node1_34"><a xlink:href="#" xlink:title="upper(self, *args, **kwargs):&#10;Return a copy of the string converted to uppercase.">
<text text-anchor="start" x="8" y="-21.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">upper()</text>
</a>
</g>
<g id="a_node1_35"><a xlink:href="#" xlink:title="create(self, s)">
<text text-anchor="start" x="8" y="-7.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">create()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- str -->
<g id="node2" class="node">
<title>str</title>
<g id="a_node2"><a xlink:href="builtins.ipynb" xlink:title="class str:&#10;str(object=&#39;&#39;) &#45;&gt; str&#10;str(bytes_or_buffer[, encoding[, errors]]) &#45;&gt; str&#10;&#10;Create a new string object from the given object. If encoding or&#10;errors is specified, then the object must expose a data buffer&#10;that will be decoded using the given encoding and error handler.&#10;Otherwise, returns the result of object.__str__() (if defined)&#10;or repr(object).&#10;encoding defaults to sys.getdefaultencoding().&#10;errors defaults to &#39;strict&#39;.">
<polygon fill="none" stroke="black" points="35,-517.75 35,-553.75 89,-553.75 89,-517.75 35,-517.75"/>
<text text-anchor="start" x="53.5" y="-532.45" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">str</text>
</a>
</g>
</g>
<!-- tstr&#45;&gt;str -->
<g id="edge1" class="edge">
<title>tstr&#45;&gt;str</title>
<path fill="none" stroke="black" d="M62,-480.99C62,-490.28 62,-498.72 62,-506.02"/>
<polygon fill="none" stroke="black" points="58.5,-506.01 62,-516.01 65.5,-506.01 58.5,-506.01"/>
</g>
<!-- Legend -->
<g id="node3" class="node">
<title>Legend</title>
<text text-anchor="start" x="142.38" y="-256.62" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="10.00" fill="#b03a2e">Legend</text>
<text text-anchor="start" x="142.38" y="-246.62" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="148.38" y="-246.62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="8.00">public_method()</text>
<text text-anchor="start" x="142.38" y="-236.62" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="148.38" y="-236.62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="8.00">private_method()</text>
<text text-anchor="start" x="142.38" y="-226.62" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="148.38" y="-226.62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="8.00">overloaded_method()</text>
<text text-anchor="start" x="142.38" y="-217.57" font-family="Helvetica,sans-Serif" font-size="9.00">Hover over names to see doc</text>
</g>
</g>
</svg>
</div></div>
</div>
</section>
<section id="id6">
<h3>Tracking Character Origins<a class="headerlink" href="#id6" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">ostr</span></code> objects extend <code class="docutils literal notranslate"><span class="pre">tstr</span></code> objects by not only tracking a taint, but also the originating <em>indexes</em> from the input string, This allows you to exactly track where individual characters came from. Assume you have a long string, which at index 100 contains the password <code class="docutils literal notranslate"><span class="pre">&quot;joshua1234&quot;</span></code>. Then you can save this origin information using an <code class="docutils literal notranslate"><span class="pre">ostr</span></code> as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">secret</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">&quot;joshua1234&quot;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;SECRET&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">origin</span></code> attribute of an <code class="docutils literal notranslate"><span class="pre">ostr</span></code> provides access to a list of indexes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">secret</span><span class="o">.</span><span class="n">origin</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[100, 101, 102, 103, 104, 105, 106, 107, 108, 109]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">secret</span><span class="o">.</span><span class="n">taint</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;SECRET&#39;
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ostr</span></code> objects are compatible with Python strings, except that string operations return <code class="docutils literal notranslate"><span class="pre">ostr</span></code> objects (together with the saved origin an index information). An index of <code class="docutils literal notranslate"><span class="pre">-1</span></code> indicates that the corresponding character has no origin as supplied to the <code class="docutils literal notranslate"><span class="pre">ostr()</span></code> constructor:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">secret_substr</span> <span class="o">=</span> <span class="p">(</span><span class="n">secret</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">secret</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>
<span class="n">secret_substr</span><span class="o">.</span><span class="n">taint</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;SECRET&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">secret_substr</span><span class="o">.</span><span class="n">origin</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[100, 101, 102, 103, -1, 106, 107, 108, 109]
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ostr</span></code> objects duplicate most <code class="docutils literal notranslate"><span class="pre">str</span></code> methods, as indicated in the class diagram:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="n">display_class_hierarchy</span><span class="p">(</span><span class="n">ostr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (20241206.2353)
 -->
<!-- Pages: 1 -->
<svg width="252pt" height="596pt"
 viewBox="0.00 0.00 251.62 595.75" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 591.75)">
<g id="a_graph0"><a xlink:title="ostr class hierarchy">
<polygon fill="white" stroke="none" points="-4,4 -4,-591.75 247.62,-591.75 247.62,4 -4,4"/>
</a>
</g>
<!-- ostr -->
<g id="node1" class="node">
<title>ostr</title>
<g id="a_node1"><a xlink:href="#" xlink:title="class ostr:&#10;Wrapper for strings, saving taint and origin information">
<polygon fill="none" stroke="black" points="0,-0.5 0,-514.25 106,-514.25 106,-0.5 0,-0.5"/>
<text text-anchor="start" x="41" y="-497.95" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">ostr</text>
<polyline fill="none" stroke="black" points="0,-488.25 106,-488.25"/>
<g id="a_node1_0"><a xlink:href="#" xlink:title="ostr">
<g id="a_node1_1"><a xlink:href="#" xlink:title="DEFAULT_ORIGIN = 0">
<text text-anchor="start" x="11" y="-474.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">DEFAULT_ORIGIN</text>
</a>
</g>
<g id="a_node1_2"><a xlink:href="#" xlink:title="UNKNOWN_ORIGIN = &#45;1">
<text text-anchor="start" x="11" y="-462" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">UNKNOWN_ORIGIN</text>
</a>
</g>
</a>
</g>
<polyline fill="none" stroke="black" points="0,-454.75 106,-454.75"/>
<g id="a_node1_3"><a xlink:href="#" xlink:title="ostr">
<g id="a_node1_4"><a xlink:href="#" xlink:title="__add__(self, other):&#10;Return self+value.">
<text text-anchor="start" x="8" y="-442.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__add__()</text>
</a>
</g>
<g id="a_node1_5"><a xlink:href="#" xlink:title="__getitem__(self, key):&#10;Return self[key].">
<text text-anchor="start" x="8" y="-429.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__getitem__()</text>
</a>
</g>
<g id="a_node1_6"><a xlink:href="#" xlink:title="__init__(self, value: Any, taint: Any = None, origin: Union[int, List[int], NoneType] = None, **kwargs) &#45;&gt; None:&#10;Constructor.&#10;`value` is the string value the `ostr` object is to be constructed from.&#10;`taint` is an (optional) taint to be propagated to derived strings.&#10;`origin` (optional) is either&#10;&#45; an integer denoting the index of the first character in `value`, or&#10;&#45; a list of integers denoting the origins of the characters in `value`,">
<text text-anchor="start" x="8" y="-416.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node1_7"><a xlink:href="#" xlink:title="__iter__(self):&#10;Implement iter(self).">
<text text-anchor="start" x="8" y="-404" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__iter__()</text>
</a>
</g>
<g id="a_node1_8"><a xlink:href="#" xlink:title="__mod__(self, s):&#10;Return self%value.">
<text text-anchor="start" x="8" y="-391.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__mod__()</text>
</a>
</g>
<g id="a_node1_9"><a xlink:href="#" xlink:title="__new__(cls, value, *args, **kw):&#10;Create an ostr() instance. Used internally.">
<text text-anchor="start" x="8" y="-378.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__new__()</text>
</a>
</g>
<g id="a_node1_10"><a xlink:href="#" xlink:title="__repr__(self):&#10;Return repr(self).">
<text text-anchor="start" x="8" y="-365.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__repr__()</text>
</a>
</g>
<g id="a_node1_11"><a xlink:href="#" xlink:title="__rmod__(self, s):&#10;Return value%self.">
<text text-anchor="start" x="8" y="-353" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__rmod__()</text>
</a>
</g>
<g id="a_node1_12"><a xlink:href="#" xlink:title="__str__(self):&#10;Return str(self).">
<text text-anchor="start" x="8" y="-340.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__str__()</text>
</a>
</g>
<g id="a_node1_13"><a xlink:href="#" xlink:title="capitalize(self):&#10;Return a capitalized version of the string.&#10;&#10;More specifically, make the first character have upper case and the rest lower&#10;case.">
<text text-anchor="start" x="8" y="-327.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">capitalize()</text>
</a>
</g>
<g id="a_node1_14"><a xlink:href="#" xlink:title="expandtabs(self, n=8):&#10;Return a copy where all tab characters are expanded using spaces.&#10;&#10;If tabsize is not given, a tab size of 8 characters is assumed.">
<text text-anchor="start" x="8" y="-314.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">expandtabs()</text>
</a>
</g>
<g id="a_node1_15"><a xlink:href="#" xlink:title="join(self, iterable):&#10;Concatenate any number of strings.&#10;&#10;The string whose method is called is inserted in between each given string.&#10;The result is returned as a new string.&#10;&#10;Example: &#39;.&#39;.join([&#39;ab&#39;, &#39;pq&#39;, &#39;rs&#39;]) &#45;&gt; &#39;ab.pq.rs&#39;">
<text text-anchor="start" x="8" y="-302" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">join()</text>
</a>
</g>
<g id="a_node1_16"><a xlink:href="#" xlink:title="ljust(self, width, fillchar=&#39; &#39;):&#10;Return a left&#45;justified string of length width.&#10;&#10;Padding is done using the specified fill character (default is a space).">
<text text-anchor="start" x="8" y="-289.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">ljust()</text>
</a>
</g>
<g id="a_node1_17"><a xlink:href="#" xlink:title="lower(self):&#10;Return a copy of the string converted to lowercase.">
<text text-anchor="start" x="8" y="-276.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">lower()</text>
</a>
</g>
<g id="a_node1_18"><a xlink:href="#" xlink:title="lstrip(self, cl=None):&#10;Return a copy of the string with leading whitespace removed.&#10;&#10;If chars is given and not None, remove characters in chars instead.">
<text text-anchor="start" x="8" y="-263.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">lstrip()</text>
</a>
</g>
<g id="a_node1_19"><a xlink:href="#" xlink:title="partition(self, sep):&#10;Partition the string into three parts using the given separator.&#10;&#10;This will search for the separator in the string. &#160;If the separator is found,&#10;returns a 3&#45;tuple containing the part before the separator, the separator&#10;itself, and the part after it.&#10;&#10;If the separator is not found, returns a 3&#45;tuple containing the original string&#10;and two empty strings.">
<text text-anchor="start" x="8" y="-251" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">partition()</text>
</a>
</g>
<g id="a_node1_20"><a xlink:href="#" xlink:title="replace(self, a, b, n=None):&#10;Return a copy with all occurrences of substring old replaced by new.&#10;&#10;count&#10;Maximum number of occurrences to replace.&#10;&#45;1 (the default value) means replace all occurrences.&#10;&#10;If the optional argument count is given, only the first count occurrences are&#10;replaced.">
<text text-anchor="start" x="8" y="-238.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">replace()</text>
</a>
</g>
<g id="a_node1_21"><a xlink:href="#" xlink:title="rjust(self, width, fillchar=&#39; &#39;):&#10;Return a right&#45;justified string of length width.&#10;&#10;Padding is done using the specified fill character (default is a space).">
<text text-anchor="start" x="8" y="-225.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">rjust()</text>
</a>
</g>
<g id="a_node1_22"><a xlink:href="#" xlink:title="rpartition(self, sep):&#10;Partition the string into three parts using the given separator.&#10;&#10;This will search for the separator in the string, starting at the end. If&#10;the separator is found, returns a 3&#45;tuple containing the part before the&#10;separator, the separator itself, and the part after it.&#10;&#10;If the separator is not found, returns a 3&#45;tuple containing two empty strings&#10;and the original string.">
<text text-anchor="start" x="8" y="-212.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">rpartition()</text>
</a>
</g>
<g id="a_node1_23"><a xlink:href="#" xlink:title="rsplit(self, sep=None, maxsplit=&#45;1):&#10;Return a list of the substrings in the string, using sep as the separator string.&#10;&#10;sep&#10;The separator used to split the string.&#10;&#10;When set to None (the default value), will split on any whitespace&#10;character (including \n \r \t \f and spaces) and will discard&#10;empty strings from the result.&#10;maxsplit&#10;Maximum number of splits.&#10;&#45;1 (the default value) means no limit.&#10;&#10;Splitting starts at the end of the string and works to the front.">
<text text-anchor="start" x="8" y="-200" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">rsplit()</text>
</a>
</g>
<g id="a_node1_24"><a xlink:href="#" xlink:title="rstrip(self, cl=None):&#10;Return a copy of the string with trailing whitespace removed.&#10;&#10;If chars is given and not None, remove characters in chars instead.">
<text text-anchor="start" x="8" y="-187.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">rstrip()</text>
</a>
</g>
<g id="a_node1_25"><a xlink:href="#" xlink:title="split(self, sep=None, maxsplit=&#45;1):&#10;Return a list of the substrings in the string, using sep as the separator string.&#10;&#10;sep&#10;The separator used to split the string.&#10;&#10;When set to None (the default value), will split on any whitespace&#10;character (including \n \r \t \f and spaces) and will discard&#10;empty strings from the result.&#10;maxsplit&#10;Maximum number of splits.&#10;&#45;1 (the default value) means no limit.&#10;&#10;Splitting starts at the front of the string and works to the end.&#10;&#10;Note, str.split() is mainly useful for data that has been intentionally&#10;delimited. &#160;With natural text that includes punctuation, consider using&#10;the regular expression module.">
<text text-anchor="start" x="8" y="-174.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">split()</text>
</a>
</g>
<g id="a_node1_26"><a xlink:href="#" xlink:title="strip(self, cl=None):&#10;Return a copy of the string with leading and trailing whitespace removed.&#10;&#10;If chars is given and not None, remove characters in chars instead.">
<text text-anchor="start" x="8" y="-161.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">strip()</text>
</a>
</g>
<g id="a_node1_27"><a xlink:href="#" xlink:title="swapcase(self):&#10;Convert uppercase characters to lowercase and lowercase characters to uppercase.">
<text text-anchor="start" x="8" y="-149" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">swapcase()</text>
</a>
</g>
<g id="a_node1_28"><a xlink:href="#" xlink:title="title(self):&#10;Return a version of the string where each word is titlecased.&#10;&#10;More specifically, words start with uppercased characters and all remaining&#10;cased characters have lower case.">
<text text-anchor="start" x="8" y="-136.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">title()</text>
</a>
</g>
<g id="a_node1_29"><a xlink:href="#" xlink:title="upper(self):&#10;Return a copy of the string converted to uppercase.">
<text text-anchor="start" x="8" y="-123.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">upper()</text>
</a>
</g>
<g id="a_node1_30"><a xlink:href="#" xlink:title="x(self, i=0):&#10;Extract substring at index/slice `i`">
<text text-anchor="start" x="8" y="-110.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">x()</text>
</a>
</g>
<g id="a_node1_31"><a xlink:href="#" xlink:title="__radd__(self, other)">
<text text-anchor="start" x="8" y="-97" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">__radd__()</text>
</a>
</g>
<g id="a_node1_32"><a xlink:href="#" xlink:title="_split_helper(self, sep, splitted)">
<text text-anchor="start" x="8" y="-84.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">_split_helper()</text>
</a>
</g>
<g id="a_node1_33"><a xlink:href="#" xlink:title="_split_space(self, splitted)">
<text text-anchor="start" x="8" y="-71.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">_split_space()</text>
</a>
</g>
<g id="a_node1_34"><a xlink:href="#" xlink:title="clear_origin(self)">
<text text-anchor="start" x="8" y="-58.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">clear_origin()</text>
</a>
</g>
<g id="a_node1_35"><a xlink:href="#" xlink:title="clear_taint(self)">
<text text-anchor="start" x="8" y="-46" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">clear_taint()</text>
</a>
</g>
<g id="a_node1_36"><a xlink:href="#" xlink:title="create(self, res, origin=None)">
<text text-anchor="start" x="8" y="-33.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">create()</text>
</a>
</g>
<g id="a_node1_37"><a xlink:href="#" xlink:title="has_origin(self)">
<text text-anchor="start" x="8" y="-20.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">has_origin()</text>
</a>
</g>
<g id="a_node1_38"><a xlink:href="#" xlink:title="has_taint(self)">
<text text-anchor="start" x="8" y="-7.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">has_taint()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- str -->
<g id="node2" class="node">
<title>str</title>
<g id="a_node2"><a xlink:href="builtins.ipynb" xlink:title="class str:&#10;str(object=&#39;&#39;) &#45;&gt; str&#10;str(bytes_or_buffer[, encoding[, errors]]) &#45;&gt; str&#10;&#10;Create a new string object from the given object. If encoding or&#10;errors is specified, then the object must expose a data buffer&#10;that will be decoded using the given encoding and error handler.&#10;Otherwise, returns the result of object.__str__() (if defined)&#10;or repr(object).&#10;encoding defaults to sys.getdefaultencoding().&#10;errors defaults to &#39;strict&#39;.">
<polygon fill="none" stroke="black" points="26,-551.25 26,-587.25 80,-587.25 80,-551.25 26,-551.25"/>
<text text-anchor="start" x="44.5" y="-565.95" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">str</text>
</a>
</g>
</g>
<!-- ostr&#45;&gt;str -->
<g id="edge1" class="edge">
<title>ostr&#45;&gt;str</title>
<path fill="none" stroke="black" d="M53,-514.63C53,-523.94 53,-532.38 53,-539.67"/>
<polygon fill="none" stroke="black" points="49.5,-539.62 53,-549.62 56.5,-539.62 49.5,-539.62"/>
</g>
<!-- Legend -->
<g id="node3" class="node">
<title>Legend</title>
<text text-anchor="start" x="124.38" y="-273.38" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="10.00" fill="#b03a2e">Legend</text>
<text text-anchor="start" x="124.38" y="-263.38" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="130.38" y="-263.38" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="8.00">public_method()</text>
<text text-anchor="start" x="124.38" y="-253.38" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="130.38" y="-253.38" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="8.00">private_method()</text>
<text text-anchor="start" x="124.38" y="-243.38" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="130.38" y="-243.38" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="8.00">overloaded_method()</text>
<text text-anchor="start" x="124.38" y="-234.32" font-family="Helvetica,sans-Serif" font-size="9.00">Hover over names to see doc</text>
</g>
</g>
</svg>
</div></div>
</div>
</section>
</section>
<section id="lessons-learned">
<h2>Lessons Learned<a class="headerlink" href="#lessons-learned" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>String-based and character-based taints allow dynamically tracking the information flow from input to the internals of a system and back to the output.</p></li>
<li><p>Checking taints allows discovering untrusted inputs and information leakage at runtime.</p></li>
<li><p>Data conversions and implicit data flow may strip taint information; the resulting untainted strings should be treated as having the worst possible taint.</p></li>
<li><p>Taints can be used in conjunction with fuzzing to provide a more robust indication of incorrect behavior than to simply rely on program crashes.</p></li>
</ul>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">#</a></h2>
<p>An even better alternative to our taint-directed fuzzing is to make use of <em>symbolic</em> techniques that take the semantics of the program under test into account.  The chapter on <a class="reference internal" href="#FlowFuzzer.ipynb"><span class="xref myst">flow fuzzing</span></a> introduces these symbolic techniques for the purpose of exploring information flows; the subsequent chapter on <a class="reference internal" href="SymbolicFuzzer.html"><span class="std std-doc">symbolic fuzzing</span></a> then shows how to make full-fledged use of symbolic execution for covering code.  Similarly, <a class="reference internal" href="SearchBasedFuzzer.html"><span class="std std-doc">search based fuzzing</span></a> can often provide a cheaper exploration strategy.</p>
</section>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h2>
<p>Taint analysis on Python using a library approach as we implemented in this chapter was discussed by Conti et al. \cite{Conti2010}.</p>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<section id="exercise-1-tainted-numbers">
<h3>Exercise 1: Tainted Numbers<a class="headerlink" href="#exercise-1-tainted-numbers" title="Link to this heading">#</a></h3>
<p>Introduce a class <code class="docutils literal notranslate"><span class="pre">tint</span></code> (for tainted integer) that, like <code class="docutils literal notranslate"><span class="pre">tstr</span></code>, has a taint attribute that gets passed on from <code class="docutils literal notranslate"><span class="pre">tint</span></code> to <code class="docutils literal notranslate"><span class="pre">tint</span></code>.</p>
<section id="part-1-creation">
<h4>Part 1: Creation<a class="headerlink" href="#part-1-creation" title="Link to this heading">#</a></h4>
<p>Implement the <code class="docutils literal notranslate"><span class="pre">tint</span></code> class such that taints are set:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">tint</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;SECRET&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">taint</span> <span class="o">==</span> <span class="s1">&#39;SECRET&#39;</span>
</pre></div>
</div>
<p><strong>Solution.</strong> This is pretty straightforward, as we can apply the same scheme as for <code class="docutils literal notranslate"><span class="pre">tstr</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">tint</span><span class="p">(</span><span class="nb">int</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taint</span> <span class="o">=</span> <span class="n">taint</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">tint</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;SECRET&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">taint</span> <span class="o">==</span> <span class="s1">&#39;SECRET&#39;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="part-2-arithmetic-expressions">
<h4>Part 2: Arithmetic expressions<a class="headerlink" href="#part-2-arithmetic-expressions" title="Link to this heading">#</a></h4>
<p>Ensure that taints get passed along arithmetic expressions; support addition, subtraction, multiplication, and division operators.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
<span class="k">assert</span> <span class="n">y</span><span class="o">.</span><span class="n">taint</span> <span class="o">==</span> <span class="s1">&#39;SECRET&#39;</span>
</pre></div>
</div>
<p><strong>Solution.</strong> As with <code class="docutils literal notranslate"><span class="pre">tstr</span></code>, we implement a <code class="docutils literal notranslate"><span class="pre">create()</span></code> method and a convenience function to quickly define all arithmetic operations:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">tint</span><span class="p">(</span><span class="n">tint</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="c1"># print(&quot;New tint from&quot;, n)</span>
        <span class="k">return</span> <span class="n">tint</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taint</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">make_int_wrapper()</span></code> function creates a wrapper around an existing <code class="docutils literal notranslate"><span class="pre">int</span></code> method which attaches the taint to the result of the method:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_int_wrapper</span><span class="p">(</span><span class="n">fun</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># print(fun, args, kwargs, &quot;=&quot;, repr(res))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">proxy</span>
</pre></div>
</div>
</div>
</div>
<p>We do this for all arithmetic operators:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;__add__&#39;</span><span class="p">,</span> <span class="s1">&#39;__radd__&#39;</span><span class="p">,</span> <span class="s1">&#39;__mul__&#39;</span><span class="p">,</span> <span class="s1">&#39;__rmul__&#39;</span><span class="p">,</span> <span class="s1">&#39;__sub__&#39;</span><span class="p">,</span>
             <span class="s1">&#39;__floordiv__&#39;</span><span class="p">,</span> <span class="s1">&#39;__truediv__&#39;</span><span class="p">]:</span>
    <span class="n">fun</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">tint</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">make_int_wrapper</span><span class="p">(</span><span class="n">fun</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">tint</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;SECRET&#39;</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">y</span><span class="o">.</span><span class="n">taint</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;SECRET&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="part-3-passing-taints-from-integers-to-strings">
<h4>Part 3: Passing taints from integers to strings<a class="headerlink" href="#part-3-passing-taints-from-integers-to-strings" title="Link to this heading">#</a></h4>
<p>Converting a tainted integer into a string (using <code class="docutils literal notranslate"><span class="pre">repr()</span></code>) should yield a tainted string:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x_s</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x_s</span><span class="o">.</span><span class="n">taint</span> <span class="o">==</span> <span class="s1">&#39;SECRET&#39;</span>
</pre></div>
</div>
<p><strong>Solution.</strong> We define the string conversion functions such that they return a tainted string (<code class="docutils literal notranslate"><span class="pre">tstr</span></code>):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">tint</span><span class="p">(</span><span class="n">tint</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tstr</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tstr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taint</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">tint</span><span class="p">(</span><span class="n">tint</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tstr</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tstr</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">taint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taint</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">tint</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;SECRET&#39;</span><span class="p">)</span>
<span class="n">x_s</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_s</span><span class="p">,</span> <span class="n">tstr</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x_s</span><span class="o">.</span><span class="n">taint</span> <span class="o">==</span> <span class="s1">&#39;SECRET&#39;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="part-4-passing-taints-from-strings-to-integers">
<h4>Part 4: Passing taints from strings to integers<a class="headerlink" href="#part-4-passing-taints-from-strings-to-integers" title="Link to this heading">#</a></h4>
<p>Converting a tainted object (with a <code class="docutils literal notranslate"><span class="pre">taint</span></code> attribute) to an integer should pass that taint:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">password</span> <span class="o">=</span> <span class="n">tstr</span><span class="p">(</span><span class="s1">&#39;1234&#39;</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;NOT_EXACTLY_SECRET&#39;</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tint</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1234</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">taint</span> <span class="o">==</span> <span class="s1">&#39;NOT_EXACTLY_SECRET&#39;</span>
</pre></div>
</div>
<p><strong>Solution.</strong> This can be done by having the <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> constructor check for a <code class="docutils literal notranslate"><span class="pre">taint</span></code> attribute:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">tint</span><span class="p">(</span><span class="n">tint</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">taint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">taint</span> <span class="o">=</span> <span class="n">taint</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">taint</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;taint&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">password</span> <span class="o">=</span> <span class="n">tstr</span><span class="p">(</span><span class="s1">&#39;1234&#39;</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">&#39;NOT_EXACTLY_SECRET&#39;</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tint</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1234</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">taint</span> <span class="o">==</span> <span class="s1">&#39;NOT_EXACTLY_SECRET&#39;</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="exercise-2-information-flow-testing">
<h3>Exercise 2: Information Flow Testing<a class="headerlink" href="#exercise-2-information-flow-testing" title="Link to this heading">#</a></h3>
<p>Generate tests that ensure a <em>maximum</em> of information flow, propagating specific taints as much as possible.  Implement an appropriate fitness function for <a class="reference internal" href="SearchBasedFuzzer.html"><span class="std std-doc">search-based testing</span></a> and let the search-based fuzzer search for solutions.</p>
<p><strong>Solution.</strong> This will become a section on its own; as of now, it is an exercise for the reader.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="GrammarMiner.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Mining Input Grammars</p>
      </div>
    </a>
    <a class="right-next"
       href="ConcolicFuzzer.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Concolic Fuzzing</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tracking-string-taints">Tracking String Taints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tracking-character-origins">Tracking Character Origins</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-vulnerable-database">A Vulnerable Database</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#representing-tables">Representing Tables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#executing-sql-statements">Executing SQL Statements</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-sql-statements">Excursion: Implementing SQL Statements</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#selecting-data">Selecting Data</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#inserting-data">Inserting Data</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#updating-data">Updating Data</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#deleting-data">Deleting Data</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#end-of-excursion">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fuzzing-sql">Fuzzing SQL</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-defining-a-sql-grammar">Excursion: Defining a SQL grammar</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-evil-of-eval">The Evil of Eval</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Tracking String Taints</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-class-for-tainted-strings">A Class for Tainted Strings</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#string-operators">String Operators</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tracking-untrusted-input">Tracking Untrusted Input</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#taint-aware-fuzzing">Taint Aware Fuzzing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tainteddb">TaintedDB</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preventing-privacy-leaks">Preventing Privacy Leaks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tracking-individual-characters">Tracking Individual Characters</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-class-for-tracking-character-origins">A Class for Tracking Character Origins</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-string-methods">Excursion: Implementing String Methods</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create">Create</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#index">Index</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#slices">Slices</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#splits">Splits</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#concatenation">Concatenation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-origin-string">Extract Origin String</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#replace">Replace</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#split">Split</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#strip">Strip</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#expand-tabs">Expand Tabs</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#partitions">Partitions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#justify">Justify</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#mod">mod</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#string-methods-that-do-not-change-origin">String methods that do not change origin</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#general-wrappers">General wrappers</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#methods-yet-to-be-translated">Methods yet to be translated</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-origins">Checking Origins</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#privacy-leaks-revisited">Privacy Leaks Revisited</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#taint-directed-fuzzing">Taint-Directed Fuzzing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#trackingdb">TrackingDB</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#taintedgrammarfuzzer">TaintedGrammarFuzzer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-limits-of-taint-tracking">The Limits of Taint Tracking</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#conversions">Conversions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#internal-c-libraries">Internal C libraries</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#implicit-information-flow">Implicit Information Flow</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#enforcing-tainting">Enforcing Tainting</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Synopsis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Tracking String Taints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Tracking Character Origins</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-tainted-numbers">Exercise 1: Tainted Numbers</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-creation">Part 1: Creation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-arithmetic-expressions">Part 2: Arithmetic expressions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3-passing-taints-from-integers-to-strings">Part 3: Passing taints from integers to strings</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-4-passing-taints-from-strings-to-integers">Part 4: Passing taints from strings to integers</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-information-flow-testing">Exercise 2: Information Flow Testing</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Andreas Zeller, Rahul Gopinath, Marcel Böhme, Gordon Fraser, and Christian Holler
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2021-2025 CISPA Helmholtz Center for Information Security (www.cispa.de); © Copyright 2018-2020 Saarland University, authors, and contributors. All Rights Reserved.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>