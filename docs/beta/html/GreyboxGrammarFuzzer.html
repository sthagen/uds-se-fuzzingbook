
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Greybox Fuzzing with Grammars &#8212; The Fuzzing Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=42e1b1a5" />
    <link rel="stylesheet" type="text/css" href="_static/mastodon-timeline.css?v=f82c2b23" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'GreyboxGrammarFuzzer';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Reducing Failure-Inducing Inputs" href="Reducer.html" />
    <link rel="prev" title="Fuzzing with Generators" href="GeneratorGrammarFuzzer.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content"><p>This is a beta version of fuzzingbook.org, currently in development. See the <a href="https://fuzzingbook.org/"  style="color:white!important;">classic site</a> for resources.</p></div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/fuzzingbook.png" class="logo__image only-light" alt="The Fuzzing Book - Home"/>
    <script>document.write(`<img src="_static/fuzzingbook.png" class="logo__image only-dark" alt="The Fuzzing Book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    The Fuzzing Book
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tours.html">Tours through the Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="Intro_Testing.html">Introduction to Software Testing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Lexical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Fuzzer.html">Fuzzing: Breaking Things with Random Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Coverage.html">Code Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="MutationFuzzer.html">Mutation-Based Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GreyboxFuzzer.html">Greybox Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="SearchBasedFuzzer.html">Search-Based Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="MutationAnalysis.html">Mutation Analysis</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Syntactical Fuzzing</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Grammars.html">Fuzzing with Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarFuzzer.html">Efficient Grammar Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarCoverageFuzzer.html">Grammar Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="Parser.html">Parsing Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ProbabilisticGrammarFuzzer.html">Probabilistic Grammar Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GeneratorGrammarFuzzer.html">Fuzzing with Generators</a></li>

<li class="toctree-l1 current active"><a class="current reference internal" href="#">Greybox Fuzzing with Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="Reducer.html">Reducing Failure-Inducing Inputs</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Semantical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="FuzzingWithConstraints.html">Fuzzing with Constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarMiner.html">Mining Input Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="InformationFlow.html">Tracking Information Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="ConcolicFuzzer.html">Concolic Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="SymbolicFuzzer.html">Symbolic Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="DynamicInvariants.html">Mining Function Specifications</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Domain-Specific Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ConfigurationFuzzer.html">Testing Configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="APIFuzzer.html">Fuzzing APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Carver.html">Carving Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="PythonFuzzer.html">Testing Compilers</a></li>
<li class="toctree-l1"><a class="reference internal" href="WebFuzzer.html">Testing Web Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="GUIFuzzer.html">Testing Graphical User Interfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Managing Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="FuzzingInTheLarge.html">Fuzzing in the Large</a></li>
<li class="toctree-l1"><a class="reference internal" href="WhenToStopFuzzing.html">When To Stop Fuzzing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="AcademicPrototyping.html">Academic Prototyping</a></li>
<li class="toctree-l1"><a class="reference internal" href="PrototypingWithPython.html">Prototyping with Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="ExpectError.html">Error Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timer.html">Timer</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timeout.html">Timeout</a></li>
<li class="toctree-l1"><a class="reference internal" href="ClassDiagram.html">Class Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="RailroadDiagrams.html">Railroad Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="ControlFlow.html">Control Flow Graph</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About This Book</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ReleaseNotes.html">Fuzzingbook Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="Importing.html">Using Fuzzingbook Code in your own Programs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Guide_for_Authors.html">Guide for Authors</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/master?urlpath=tree/docs/notebooks/GreyboxGrammarFuzzer.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/uds-se/fuzzingbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/uds-se/fuzzingbook/issues/new?title=Issue%20on%20page%20%2FGreyboxGrammarFuzzer.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/GreyboxGrammarFuzzer.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Greybox Fuzzing with Grammars</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fuzzing-with-dictionaries">Fuzzing with Dictionaries</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fuzzing-with-input-fragments">Fuzzing with Input Fragments</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fuzzing-with-input-regions">Fuzzing with Input Regions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Fuzzing with Dictionaries</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Fuzzing with Input Fragments</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parsing-and-recombining-javascript-or-how-to-make-50-000-usd-in-four-weeks">Parsing and Recombining JavaScript, or How to Make 50,000 USD in Four Weeks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parsing-and-recombining-html">Parsing and Recombining HTML</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#building-the-fragment-pool">Building the Fragment Pool</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fragment-based-mutation">Fragment-Based Mutation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fragment-based-fuzzing">Fragment-Based Fuzzing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#integration-with-greybox-fuzzing">Integration with Greybox Fuzzing</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Fuzzing with Input Regions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#determining-symbol-regions">Determining Symbol Regions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#region-based-mutation">Region-Based Mutation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Integration with Greybox Fuzzing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#focusing-on-valid-seeds">Focusing on Valid Seeds</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mining-seeds">Mining Seeds</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Synopsis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Fuzzing with Dictionaries</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">Fuzzing with Input Fragments</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">Fuzzing with Input Regions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-the-big-greybox-fuzzer-shoot-out">Exercise 1: The Big Greybox Fuzzer Shoot-Out</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="greybox-fuzzing-with-grammars">
<h1>Greybox Fuzzing with Grammars<a class="headerlink" href="#greybox-fuzzing-with-grammars" title="Link to this heading">#</a></h1>
<p>In this chapter, we introduce important extensions to our syntactic fuzzing techniques, all leveraging <em>syntactic</em> parts of <em>existing inputs</em>.</p>
<ol class="arabic simple">
<li><p>We show how to leverage <em>dictionaries</em> of input fragments during fuzzing. The idea is to integrate such dictionaries into a <em>mutator</em>, which would then inject these fragments (typically keywords and other items of importance) into population.</p></li>
<li><p>We show how to combine <a class="reference internal" href="Parser.html"><span class="std std-doc">parsing</span></a> and <a class="reference internal" href="GrammarFuzzer.html"><span class="std std-doc">fuzzing</span></a> with grammars.  This allows <em>mutating</em> existing inputs while preserving syntactical correctness, and to <em>reuse</em> fragments from existing inputs while generating new ones.  The combination of language-based parsing and generating, as demonstrated in this chapter, has been highly successful in practice: The <em>LangFuzz</em> fuzzer for JavaScript has found more than 2,600 bugs in JavaScript interpreters this way.</p></li>
<li><p>In the previous chapters, we have used grammars in a <em>black-box</em> manner – that is, we have used them to generate inputs regardless of the program being tested.  In this chapter, we introduce mutational <em>greybox fuzzing with grammars</em>: Techniques that make use of <em>feedback from the program under test</em> to guide test generations towards specific goals.  As in <a class="reference internal" href="GreyboxFuzzer.html"><span class="std std-doc">lexical greybox fuzzing</span></a>, this feedback is mostly <em>coverage</em>, allowing us to direct grammar-based testing towards uncovered code parts. This part is inspired by the <em>AFLSmart</em> fuzzer, which combines parsing and mutational fuzzing.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bookutils</span> <span class="kn">import</span> <span class="n">YouTubeVideo</span>
<span class="n">YouTubeVideo</span><span class="p">(</span><span class="s1">&#39;hSGzcjUj7Vs&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="640"
            height="360"
            src="https://www.youtube-nocookie.com/embed/hSGzcjUj7Vs"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<p><strong>Prerequisites</strong></p>
<ul class="simple">
<li><p>We build on several concepts from <a class="reference internal" href="GreyboxFuzzer.html"><span class="std std-doc">the chapter on greybox fuzzing (without grammars)</span></a>.</p></li>
<li><p>As the title suggests, you should know how to fuzz with grammars <a class="reference internal" href="Grammars.html"><span class="std std-doc">from the chapter on grammars</span></a>.</p></li>
</ul>
<section id="synopsis">
<h2>Synopsis<a class="headerlink" href="#synopsis" title="Link to this heading">#</a></h2>
<!-- Automatically generated. Do not edit. -->
<p>To <a class="reference internal" href="Importing.html"><span class="std std-doc">use the code provided in this chapter</span></a>, write</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fuzzingbook.GreyboxGrammarFuzzer</span> <span class="kn">import</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>and then make use of the following features.</p>
<p>This chapter introduces advanced methods for language-based grey-box fuzzing inspired by the <em>LangFuzz</em> and <em>AFLSmart</em> fuzzers.</p>
<section id="fuzzing-with-dictionaries">
<h3>Fuzzing with Dictionaries<a class="headerlink" href="#fuzzing-with-dictionaries" title="Link to this heading">#</a></h3>
<p>Rather than mutating strings randomly, the <code class="docutils literal notranslate"><span class="pre">DictMutator</span></code> class allows inserting tokens from a dictionary, thus increasing fuzzer performance. The dictionary comes as a list of strings, out of which random elements are picked and inserted - in addition to the given mutations such as deleting or inserting individual bytes.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">dict_mutator</span> <span class="o">=</span> <span class="n">DictMutator</span><span class="p">([</span><span class="s2">&quot;&lt;a&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;/a&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;a/&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;=&#39;a&#39;&quot;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">seeds</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="nb">print</span><span class="p">(</span><span class="n">dict_mutator</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">seeds</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="go">&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&gt;&gt;/body&gt;&lt;/html&gt;</span>
<span class="go">&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/ht7ml&gt;</span>
<span class="go">&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/hgad&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;</span>
<span class="go">&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&lt;a/&gt;&gt;&lt;/body&gt;&lt;/html&gt;</span>
<span class="go">&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br+&gt;&lt;/body&gt;&lt;/html&gt;</span>
<span class="go">&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/qhead&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;</span>
<span class="go">&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br=&#39;a&#39;/&gt;&lt;/body&gt;&lt;/html&gt;</span>
<span class="go">&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;Wormd&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;</span>
<span class="go">&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;Wyorld&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;</span>
<span class="go">&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;&lt;/a&gt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;</span>

</pre></div>
</div>
<p>This <code class="docutils literal notranslate"><span class="pre">DictMutator</span></code> can be used as an argument to <code class="docutils literal notranslate"><span class="pre">GreyboxFuzzer</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">runner</span> <span class="o">=</span> <span class="n">FunctionCoverageRunner</span><span class="p">(</span><span class="n">my_parser</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dict_fuzzer</span> <span class="o">=</span> <span class="n">GreyboxFuzzer</span><span class="p">(</span><span class="n">seeds</span><span class="p">,</span> <span class="n">dict_mutator</span><span class="p">,</span> <span class="n">PowerSchedule</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dict_fuzzer_outcome</span> <span class="o">=</span> <span class="n">dict_fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">trials</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="" src="_images/GreyboxGrammarFuzzer-synopsis-1.svg" /></p>
</section>
<section id="fuzzing-with-input-fragments">
<h3>Fuzzing with Input Fragments<a class="headerlink" href="#fuzzing-with-input-fragments" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">LangFuzzer</span></code> class introduces a <em>language-aware</em> fuzzer that can recombine fragments from existing inputs – inspired by the highly effective <code class="docutils literal notranslate"><span class="pre">LangFuzz</span></code> fuzzer. At its core is a <code class="docutils literal notranslate"><span class="pre">FragmentMutator</span></code> class that that takes a <a class="reference internal" href="Parser.html"><span class="std std-doc"><em>parser</em></span></a> as argument:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">parser</span> <span class="o">=</span> <span class="n">EarleyParser</span><span class="p">(</span><span class="n">XML_GRAMMAR</span><span class="p">,</span> <span class="n">tokens</span><span class="o">=</span><span class="n">XML_TOKENS</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mutator</span> <span class="o">=</span> <span class="n">FragmentMutator</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
</pre></div>
</div>
<p>The fuzzer itself is initialized with a list of seeds, the above <code class="docutils literal notranslate"><span class="pre">FragmentMutator</span></code>, and a power schedule:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">seeds</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">schedule</span> <span class="o">=</span> <span class="n">PowerSchedule</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">lang_fuzzer</span> <span class="o">=</span> <span class="n">LangFuzzer</span><span class="p">(</span><span class="n">seeds</span><span class="p">,</span> <span class="n">mutator</span><span class="p">,</span> <span class="n">schedule</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="nb">print</span><span class="p">(</span><span class="n">lang_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
<span class="go">&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;</span>
<span class="go">&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;</span>
<span class="go">&lt;html&gt;World&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;</span>
<span class="go">&lt;html&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;title&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;</span>
<span class="go">&lt;html&gt;&lt;head&gt;&lt;title&gt;&lt;head&gt;World&lt;/head&gt;&lt;/title&gt;&lt;/head&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;</span>
<span class="go">&lt;html&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;</span>

<span class="go">Exception ignored in: &lt;bound method IPythonKernel._clean_thread_parent_frames of &lt;ipykernel.ipkernel.IPythonKernel object at 0x103912720&gt;&gt;</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;/Users/zeller/.local/lib/python3.12/site-packages/ipykernel/ipkernel.py&quot;</span>, line <span class="m">775</span>, in <span class="n">_clean_thread_parent_frames</span>
<span class="w">    </span><span class="k">def</span> <span class="nf">_clean_thread_parent_frames</span><span class="p">(</span>

  File <span class="nb">&quot;Timeout.ipynb&quot;</span>, line <span class="m">43</span>, in <span class="n">timeout_handler</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>  
<span class="x">TimeoutError: </span>

<span class="x">&lt;html&gt;&lt;body&gt;WorldHello&lt;/body&gt;</span>

<span class="x">Exception ignored in: &lt;bound method IPythonKernel._clean_thread_parent_frames of &lt;ipykernel.ipkernel.IPythonKernel object at 0x103912720&gt;&gt;</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;/Users/zeller/.local/lib/python3.12/site-packages/ipykernel/ipkernel.py&quot;</span>, line <span class="m">775</span>, in <span class="n">_clean_thread_parent_frames</span>
<span class="w">    </span><span class="k">def</span> <span class="nf">_clean_thread_parent_frames</span><span class="p">(</span>

  File <span class="nb">&quot;Timeout.ipynb&quot;</span>, line <span class="m">43</span>, in <span class="n">timeout_handler</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>  
<span class="x">TimeoutError: </span>

<span class="x">&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;head&gt;&lt;head&gt;World&lt;/head&gt;&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;</span>
<span class="x">&lt;html&gt;&lt;head&gt;&lt;title&gt;&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;</span>
<span class="x">&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;head&gt;&lt;title&gt;&lt;head&gt;World&lt;/head&gt;&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;br/&gt;&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;</span>

</pre></div>
</div>
<p><img alt="" src="_images/GreyboxGrammarFuzzer-synopsis-2.svg" /></p>
</section>
<section id="fuzzing-with-input-regions">
<h3>Fuzzing with Input Regions<a class="headerlink" href="#fuzzing-with-input-regions" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">GreyboxGrammarFuzzer</span></code> class uses two mutators:</p>
<ul class="simple">
<li><p>a <em>tree mutator</em> (a <code class="docutils literal notranslate"><span class="pre">RegionMutator</span></code> object) that can parse existing strings to identify <em>regions</em> in that string to be swapped or deleted.</p></li>
<li><p>a <em>byte mutator</em> to apply bit- and character-level mutations.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">tree_mutator</span> <span class="o">=</span> <span class="n">RegionMutator</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">byte_mutator</span> <span class="o">=</span> <span class="n">Mutator</span><span class="p">()</span>
</pre></div>
</div>
<p>The <em>schedule</em> for the <code class="docutils literal notranslate"><span class="pre">GreyboxGrammarFuzzer</span></code> class can be a regular <code class="docutils literal notranslate"><span class="pre">PowerSchedule</span></code> object. However, a more sophisticated schedule is provided by <code class="docutils literal notranslate"><span class="pre">AFLSmartSchedule</span></code>, which assigns more <a class="reference internal" href="GreyboxFuzzer.html#Power-Schedules"><span class="std std-ref">energy</span></a> to seeds that have a higher degree of validity.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">schedule</span> <span class="o">=</span> <span class="n">AFLSmartSchedule</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">GreyboxGrammarFuzzer</span></code> constructor takes a set of seeds as well as the two mutators and the schedule:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">aflsmart_fuzzer</span> <span class="o">=</span> <span class="n">GreyboxGrammarFuzzer</span><span class="p">(</span><span class="n">seeds</span><span class="p">,</span> <span class="n">byte_mutator</span><span class="p">,</span> <span class="n">tree_mutator</span><span class="p">,</span> <span class="n">schedule</span><span class="p">)</span>
</pre></div>
</div>
<p>As it relies on code coverage, it is typically combined with a <code class="docutils literal notranslate"><span class="pre">FunctionCoverageRunner</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">runner</span> <span class="o">=</span> <span class="n">FunctionCoverageRunner</span><span class="p">(</span><span class="n">my_parser</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">aflsmart_outcome</span> <span class="o">=</span> <span class="n">aflsmart_fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">trials</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="" src="_images/GreyboxGrammarFuzzer-synopsis-3.svg" /></p>
</section>
</section>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h2>
<p>First, we <a class="reference internal" href="GreyboxFuzzer.html#Ingredients-for-Greybox-Fuzzing"><span class="std std-ref">recall</span></a> a few basic ingredients for mutational fuzzers.</p>
<ul class="simple">
<li><p><strong>Seed</strong>. A <em>seed</em> is an input that is used by the fuzzer to generate new inputs by applying a sequence of mutations.</p></li>
<li><p><strong>Mutator</strong>. A <em>mutator</em> implements a set of mutation operators that applied to an input produce a slightly modified input.</p></li>
<li><p><strong>PowerSchedule</strong>. A <em>power schedule</em> assigns <em>energy</em> to a seed. A seed with higher energy is fuzzed more often throughout the fuzzing campaign.</p></li>
<li><p><strong>AdvancedMutationFuzzer</strong>. Our <em>mutational blackbox fuzzer</em> generates inputs by mutating seeds in an initial population of inputs.</p></li>
<li><p><strong>GreyboxFuzzer</strong>. Our <em>greybox fuzzer</em> dynamically adds inputs to the population of seeds that increased coverage.</p></li>
<li><p><strong>FunctionCoverageRunner</strong>. Our <em>function coverage runner</em> collects coverage information for the execution of a given Python function.</p></li>
</ul>
<p>Let’s try to get a feeling for these concepts.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bookutils.setup</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">cast</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Fuzzer</span> <span class="kn">import</span> <span class="n">Fuzzer</span>
<span class="kn">from</span> <span class="nn">GreyboxFuzzer</span> <span class="kn">import</span> <span class="n">Mutator</span><span class="p">,</span> <span class="n">Seed</span><span class="p">,</span> <span class="n">PowerSchedule</span>
<span class="kn">from</span> <span class="nn">GreyboxFuzzer</span> <span class="kn">import</span> <span class="n">AdvancedMutationFuzzer</span><span class="p">,</span> <span class="n">GreyboxFuzzer</span>
<span class="kn">from</span> <span class="nn">MutationFuzzer</span> <span class="kn">import</span> <span class="n">FunctionCoverageRunner</span>
</pre></div>
</div>
</div>
</div>
<p>The following command applies a mutation to the input “Hello World”.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Mutator</span><span class="p">()</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="s2">&quot;Hello World&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Lello World&#39;
</pre></div>
</div>
</div>
</div>
<p>The default power schedule assigns energy uniformly across all seeds. Let’s check whether this works.</p>
<p>We choose 10k times from a population of three seeds.  As we see in the <code class="docutils literal notranslate"><span class="pre">hits</span></code> counter, each seed is chosen about a third of the time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">population</span> <span class="o">=</span> <span class="p">[</span><span class="n">Seed</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">),</span> <span class="n">Seed</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">),</span> <span class="n">Seed</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">)]</span>
<span class="n">schedule</span> <span class="o">=</span> <span class="n">PowerSchedule</span><span class="p">()</span>
<span class="n">hits</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="n">schedule</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>
    <span class="n">hits</span><span class="p">[</span><span class="n">seed</span><span class="o">.</span><span class="n">data</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">hits</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;A&#39;: 3387, &#39;B&#39;: 3255, &#39;C&#39;: 3358}
</pre></div>
</div>
</div>
</div>
<p>Before explaining the function coverage runner, lets import Python’s HTML parser as example…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">html.parser</span> <span class="kn">import</span> <span class="n">HTMLParser</span>
</pre></div>
</div>
</div>
</div>
<p>… and create a <em>wrapper function</em> that passes each input into a new parser object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_parser</span><span class="p">(</span><span class="n">inp</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">HTMLParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">FunctionCoverageRunner</span></code> constructor takes a Python <code class="docutils literal notranslate"><span class="pre">function</span></code> to execute. The function <code class="docutils literal notranslate"><span class="pre">run()</span></code> takes an input, passes it on to the Python <code class="docutils literal notranslate"><span class="pre">function</span></code>, and collects the coverage information for this execution. The function <code class="docutils literal notranslate"><span class="pre">coverage()</span></code> returns a list of tuples <code class="docutils literal notranslate"><span class="pre">(function</span> <span class="pre">name,</span> <span class="pre">line</span> <span class="pre">number)</span></code> for each statement that has been covered in the Python <code class="docutils literal notranslate"><span class="pre">function</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">runner</span> <span class="o">=</span> <span class="n">FunctionCoverageRunner</span><span class="p">(</span><span class="n">my_parser</span><span class="p">)</span>
<span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;Hello World&quot;</span><span class="p">)</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">coverage</span><span class="p">()</span>

<span class="nb">list</span><span class="p">(</span><span class="n">cov</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>  <span class="c1"># Print 5 statements covered in HTMLParser</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39;my_parser&#39;, 3),
 (&#39;goahead&#39;, 163),
 (&#39;updatepos&#39;, 47),
 (&#39;goahead&#39;, 245),
 (&#39;reset&#39;, 100)]
</pre></div>
</div>
</div>
</div>
<p>Our greybox fuzzer takes a seed population, mutator, and power schedule. Let’s generate 5000 fuzz inputs starting with an “empty” seed corpus.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">seed_input</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>  <span class="c1"># empty seed</span>
<span class="n">runner</span> <span class="o">=</span> <span class="n">FunctionCoverageRunner</span><span class="p">(</span><span class="n">my_parser</span><span class="p">)</span>
<span class="n">fuzzer</span> <span class="o">=</span> <span class="n">GreyboxFuzzer</span><span class="p">([</span><span class="n">seed_input</span><span class="p">],</span> <span class="n">Mutator</span><span class="p">(),</span> <span class="n">PowerSchedule</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">trials</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;It took the fuzzer </span><span class="si">%0.2f</span><span class="s2"> seconds to generate and execute </span><span class="si">%d</span><span class="s2"> inputs.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;It took the fuzzer 0.98 seconds to generate and execute 5000 inputs.&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;During this fuzzing campaign, we covered </span><span class="si">%d</span><span class="s2"> statements.&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">coverage</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;During this fuzzing campaign, we covered 79 statements.&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="id1">
<h2>Fuzzing with Dictionaries<a class="headerlink" href="#id1" title="Link to this heading">#</a></h2>
<p>To fuzz our HTML parser, it may be useful to inform a mutational fuzzer about important keywords in the input – that is, important HTML keywords. The general idea is to have a <em>dictionary</em> of pre-defined useful inputs that could then be inserted as such when mutating an input.</p>
<p>This concept is illustrated in the following diagram. When mutating an input, we may insert given keywords from the dictionary (in red).</p>
<img src="PICS/GreyboxGrammarFuzzer-Dict.gif"><p>To implement this concept, we extend our mutator to consider keywords from a dictionary.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DictMutator</span><span class="p">(</span><span class="n">Mutator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mutate strings using keywords from a dictionary&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor. `dictionary` is the list of keywords to use.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span> <span class="o">=</span> <span class="n">dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">insert_from_dictionary</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">insert_from_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns s with a keyword from the dictionary inserted&quot;&quot;&quot;</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="n">random_keyword</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dictionary</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">[:</span><span class="n">pos</span><span class="p">]</span> <span class="o">+</span> <span class="n">random_keyword</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">pos</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s try to add a few HTML tags and attributes and see whether the coverage with <code class="docutils literal notranslate"><span class="pre">DictMutator</span></code> increases.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">runner</span> <span class="o">=</span> <span class="n">FunctionCoverageRunner</span><span class="p">(</span><span class="n">my_parser</span><span class="p">)</span>
<span class="n">dict_mutator</span> <span class="o">=</span> <span class="n">DictMutator</span><span class="p">([</span><span class="s2">&quot;&lt;a&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;/a&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;a/&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;=&#39;a&#39;&quot;</span><span class="p">])</span>
<span class="n">dict_fuzzer</span> <span class="o">=</span> <span class="n">GreyboxFuzzer</span><span class="p">([</span><span class="n">seed_input</span><span class="p">],</span> <span class="n">dict_mutator</span><span class="p">,</span> <span class="n">PowerSchedule</span><span class="p">())</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">dict_fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">trials</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="s2">&quot;It took the fuzzer </span><span class="si">%0.2f</span><span class="s2"> seconds to generate and execute </span><span class="si">%d</span><span class="s2"> inputs.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;It took the fuzzer 2.78 seconds to generate and execute 5000 inputs.&#39;
</pre></div>
</div>
</div>
</div>
<p>Clearly, it takes longer. In our experience, this means more code is covered:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;During this fuzzing campaign, we covered </span><span class="si">%d</span><span class="s2"> statements.&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">coverage</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;During this fuzzing campaign, we covered 108 statements.&#39;
</pre></div>
</div>
</div>
</div>
<p>How do the fuzzers compare in terms of coverage over time?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Coverage</span> <span class="kn">import</span> <span class="n">population_coverage</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">dict_cov</span> <span class="o">=</span> <span class="n">population_coverage</span><span class="p">(</span><span class="n">dict_fuzzer</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">my_parser</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">fuzz_cov</span> <span class="o">=</span> <span class="n">population_coverage</span><span class="p">(</span><span class="n">fuzzer</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">my_parser</span><span class="p">)</span>
<span class="n">line_dict</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dict_cov</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;With Dictionary&quot;</span><span class="p">)</span>
<span class="n">line_fuzz</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fuzz_cov</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Without Dictionary&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">line_dict</span><span class="p">,</span> <span class="n">line_fuzz</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Coverage over time&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;# of inputs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;lines covered&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ac0061e2a94f2954e005e644035bdfc5967a15fe64d0fed3739fc52a73eee218.png" src="_images/ac0061e2a94f2954e005e644035bdfc5967a15fe64d0fed3739fc52a73eee218.png" />
</div>
</div>
<!-- \todo{Andreas: Section on mining keywords using parser-directed fuzzing or AUTOGRAM?} -->
<p><em><strong>Summary.</strong></em> Informing the fuzzer about important keywords already goes a long way towards achieving lots of coverage quickly.</p>
<p><em><strong>Try it.</strong></em> Open this chapter as Jupyter notebook and add other HTML-related keywords to the dictionary in order to see whether the difference in coverage actually increases (given the same budget of 5k generated test inputs).</p>
<p><em><strong>Read up.</strong></em> Michał Zalewski, author of AFL, wrote several great blog posts on <a class="reference external" href="https://lcamtuf.blogspot.com/2015/01/afl-fuzz-making-up-grammar-with.html">making up grammars with a dictionary in hand</a> and <a class="reference external" href="https://lcamtuf.blogspot.com/2014/11/pulling-jpegs-out-of-thin-air.html">pulling JPEGs out of thin air</a>!</p>
</section>
<section id="id2">
<h2>Fuzzing with Input Fragments<a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<p>While dictionaries are helpful to inject important keywords into seed inputs, they do not allow maintaining the structural integrity of the generated inputs. Instead, we need to make the fuzzer aware of the <em>input structure</em>. We can do this using <a class="reference internal" href="Grammars.html"><span class="std std-doc">grammars</span></a>. Our first approach</p>
<ol class="arabic simple">
<li><p><a class="reference internal" href="Parser.html"><span class="std std-doc">parses</span></a> the seed inputs,</p></li>
<li><p>disassembles them into input fragments, and</p></li>
<li><p>generates new files by reassembling these fragments according to the rules of the grammar.</p></li>
</ol>
<p>This combination of <em>parsing</em> and <em>fuzzing</em> can be very powerful. For instance, we can <em>swap</em> existing substructures in an input:</p>
<img src="PICS/GreyboxGrammarFuzzer-Swap.gif"><p>We can also <em>replace</em> existing substructures by newly generated ones:</p>
<img src="PICS/GreyboxGrammarFuzzer-Gen.gif"><p>All these operations take place on <a class="reference internal" href="GrammarFuzzer.html"><span class="std std-doc">derivation trees</span></a>, which can be parsed from and produced into strings at any time.</p>
<section id="parsing-and-recombining-javascript-or-how-to-make-50-000-usd-in-four-weeks">
<h3>Parsing and Recombining JavaScript, or How to Make 50,000 USD in Four Weeks<a class="headerlink" href="#parsing-and-recombining-javascript-or-how-to-make-50-000-usd-in-four-weeks" title="Link to this heading">#</a></h3>
<p>In “Fuzzing with Code Fragments” \cite{Holler2012}, Holler, Herzig, and Zeller apply these steps to fuzz a JavaScript interpreter.  They use a JavaScript grammar to</p>
<ol class="arabic simple">
<li><p><em>parse</em> (valid) JavaScript inputs into parse trees,</p></li>
<li><p><em>disassemble</em> them into fragments (subtrees),</p></li>
<li><p><em>recombine</em> these fragments into valid JavaScript programs again, and</p></li>
<li><p><em>feed</em> these programs into a JavaScript interpreter for execution.</p></li>
</ol>
<p>As in most fuzzing scenarios, the aim is to cause the JavaScript interpreter to crash.  Here is an example of LangFuzz-generated JavaScript code (from \cite{Holler2012}) that caused a crash in the Mozilla JavaScript interpreter:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">haystack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;foo&quot;</span><span class="p">;</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">re_text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;^foo&quot;</span><span class="p">;</span>
<span class="nx">haystack</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s2">&quot;x&quot;</span><span class="p">;</span>
<span class="nx">re_text</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s2">&quot;(x)&quot;</span><span class="p">;</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">re</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">RegExp</span><span class="p">(</span><span class="nx">re_text</span><span class="p">);</span>
<span class="nx">re</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">haystack</span><span class="p">);</span>
<span class="nb">RegExp</span><span class="p">.</span><span class="nx">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">();</span>
<span class="nx">print</span><span class="p">(</span><span class="nb">RegExp</span><span class="p">.</span><span class="nx">$1</span><span class="p">);</span>
</pre></div>
</div>
<p>From a crash of the JavaScript interpreter, it is frequently possible to construct an <em>exploit</em> that will not only crash the interpreter, but instead have it execute code under the attacker’s control.  Therefore, such crashes are serious flaws, which is why you get a bug bounty if you report them.</p>
<p>In the first four weeks of running his <em>LangFuzz</em> tool, Christian Holler, first author of that paper, netted <em>more than USD 50,000 in bug bounties</em>.  To date, LangFuzz has found more than 2,600 bugs in the JavaScript browsers of Mozilla Firefox, Google Chrome, and Microsoft Edge.  If you use any of these browsers (say, on your Android phone), the combination of parsing and fuzzing has contributed significantly in making your browsing session secure.</p>
<p>(Note that these are the same Holler and Zeller who are co-authors of this book.  If you ever wondered why we devote a couple of chapters on grammar-based fuzzing, that’s because we have had some great experience with it.)</p>
</section>
<section id="parsing-and-recombining-html">
<h3>Parsing and Recombining HTML<a class="headerlink" href="#parsing-and-recombining-html" title="Link to this heading">#</a></h3>
<p>In this book, let us stay with HTML input for a while.  To generate valid HTML inputs for our Python <code class="docutils literal notranslate"><span class="pre">HTMLParser</span></code>, we should first define a simple grammar. It allows defining HTML tags with attributes. Our context-free grammar does not require that opening and closing tags must match. However, we will see that such context-sensitive features can be maintained in the derived input fragments, and thus in the generated inputs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">string</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Grammars</span> <span class="kn">import</span> <span class="n">is_valid_grammar</span><span class="p">,</span> <span class="n">srange</span><span class="p">,</span> <span class="n">Grammar</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">XML_TOKENS</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;&lt;id&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;text&gt;&quot;</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">XML_GRAMMAR</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;xml-tree&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;xml-tree&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;text&gt;&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;&lt;xml-open-tag&gt;&lt;xml-tree&gt;&lt;xml-close-tag&gt;&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;&lt;xml-openclose-tag&gt;&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;&lt;xml-tree&gt;&lt;xml-tree&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;xml-open-tag&gt;&quot;</span><span class="p">:</span>      <span class="p">[</span><span class="s2">&quot;&lt;&lt;id&gt;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;&lt;id&gt; &lt;xml-attribute&gt;&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;xml-openclose-tag&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;&lt;id&gt;/&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;&lt;id&gt; &lt;xml-attribute&gt;/&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;xml-close-tag&gt;&quot;</span><span class="p">:</span>     <span class="p">[</span><span class="s2">&quot;&lt;/&lt;id&gt;&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;xml-attribute&gt;&quot;</span><span class="p">:</span>     <span class="p">[</span><span class="s2">&quot;&lt;id&gt;=&lt;id&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;xml-attribute&gt; &lt;xml-attribute&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;id&gt;&quot;</span><span class="p">:</span>                <span class="p">[</span><span class="s2">&quot;&lt;letter&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;id&gt;&lt;letter&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;text&gt;&quot;</span><span class="p">:</span>              <span class="p">[</span><span class="s2">&quot;&lt;text&gt;&lt;letter_space&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;letter_space&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;letter&gt;&quot;</span><span class="p">:</span>            <span class="n">srange</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span>
                                  <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">),</span>
    <span class="s2">&quot;&lt;letter_space&gt;&quot;</span><span class="p">:</span>      <span class="n">srange</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span>
                                  <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">),</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">XML_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>In order to parse an input into a derivation tree, we use the <a class="reference internal" href="Parser.html#Parsing-Context-Free-Grammars"><span class="std std-ref">Earley parser</span></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Parser</span> <span class="kn">import</span> <span class="n">EarleyParser</span><span class="p">,</span> <span class="n">Parser</span>
<span class="kn">from</span> <span class="nn">GrammarFuzzer</span> <span class="kn">import</span> <span class="n">display_tree</span><span class="p">,</span> <span class="n">DerivationTree</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s run the parser on a simple HTML input and display all possible parse trees. A <em>parse tree</em> represents the input structure according to the given grammar.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">parser</span> <span class="o">=</span> <span class="n">EarleyParser</span><span class="p">(</span><span class="n">XML_GRAMMAR</span><span class="p">,</span> <span class="n">tokens</span><span class="o">=</span><span class="n">XML_TOKENS</span><span class="p">)</span>

<span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;&lt;html&gt;Text&lt;/html&gt;&quot;</span><span class="p">):</span>
    <span class="n">display</span><span class="p">(</span><span class="n">display_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/fd1dfba493d58136834fb2c0b5f5e9a1fa553dcc1790720f06c1db054e704f34.svg" src="_images/fd1dfba493d58136834fb2c0b5f5e9a1fa553dcc1790720f06c1db054e704f34.svg" />
<img alt="_images/2e7846e97382f01b7d1dfd24ed656767db37a892f6a8003ad3830338af70f2be.svg" src="_images/2e7846e97382f01b7d1dfd24ed656767db37a892f6a8003ad3830338af70f2be.svg" />
<img alt="_images/3d4a3fbe7382c7388801e088eadd1089e48f5084b61060b77add204ae5e600da.svg" src="_images/3d4a3fbe7382c7388801e088eadd1089e48f5084b61060b77add204ae5e600da.svg" />
<img alt="_images/af2883338de0391ae1697a5be4305003dd20a0deca5a42d2f2fa94fd38f0e116.svg" src="_images/af2883338de0391ae1697a5be4305003dd20a0deca5a42d2f2fa94fd38f0e116.svg" />
<img alt="_images/67cfc01e5192ed21039346615b227b9440ee56687c55ba0654badf738527dd77.svg" src="_images/67cfc01e5192ed21039346615b227b9440ee56687c55ba0654badf738527dd77.svg" />
<img alt="_images/8ebdf43a5901d3cf1a411ec160d023c54dd3562b71920e88261b58eaed0e4e46.svg" src="_images/8ebdf43a5901d3cf1a411ec160d023c54dd3562b71920e88261b58eaed0e4e46.svg" />
<img alt="_images/ae9478417d5eac2ee8d9c61dc59492d0dbf67d63d1898e16eb4bcd9f6f171b19.svg" src="_images/ae9478417d5eac2ee8d9c61dc59492d0dbf67d63d1898e16eb4bcd9f6f171b19.svg" />
<img alt="_images/3bb91b6d0b6fb986ffc031091e32bcdfd24b5886d3dc7763608263bd99bebb6a.svg" src="_images/3bb91b6d0b6fb986ffc031091e32bcdfd24b5886d3dc7763608263bd99bebb6a.svg" />
<img alt="_images/3bc75499bca7240a0d65ec67f67a86b05e32e1ccd094838754352daccc45b6eb.svg" src="_images/3bc75499bca7240a0d65ec67f67a86b05e32e1ccd094838754352daccc45b6eb.svg" />
<img alt="_images/90f2e817ca0500fc96efb39453539e86a86f9a7df46469e3542fb6869d8635e7.svg" src="_images/90f2e817ca0500fc96efb39453539e86a86f9a7df46469e3542fb6869d8635e7.svg" />
<img alt="_images/7477bb076f47520ca7ab22023d5e1b714b4c59f6a21bc3bba30703bb457d0036.svg" src="_images/7477bb076f47520ca7ab22023d5e1b714b4c59f6a21bc3bba30703bb457d0036.svg" />
<img alt="_images/50bd92e9d31f3e6a4f23e0066e454c3dc694451c3c296b3367f1eb9df9ed4e24.svg" src="_images/50bd92e9d31f3e6a4f23e0066e454c3dc694451c3c296b3367f1eb9df9ed4e24.svg" />
<img alt="_images/063882ada70ebac71612aec8364d087ada27aed96fdc0e93110fff1605edff30.svg" src="_images/063882ada70ebac71612aec8364d087ada27aed96fdc0e93110fff1605edff30.svg" />
<img alt="_images/da97e215ec5d697833a15b7aa1ebc58c5ebb26ffb6adb034c5bf451e143fbcc0.svg" src="_images/da97e215ec5d697833a15b7aa1ebc58c5ebb26ffb6adb034c5bf451e143fbcc0.svg" />
<img alt="_images/915eb99e5083e347529814589764bd8678f72246dab3ffdacf00386e5f611494.svg" src="_images/915eb99e5083e347529814589764bd8678f72246dab3ffdacf00386e5f611494.svg" />
</div>
</div>
<p>As we can see, the input starts with an opening tag, contains some text, and ends with a closing tag. Excellent. This is a structure that we can work with.</p>
</section>
<section id="building-the-fragment-pool">
<h3>Building the Fragment Pool<a class="headerlink" href="#building-the-fragment-pool" title="Link to this heading">#</a></h3>
<p>We are now ready to implement our first input-structure-aware mutator. Let’s initialize the mutator with the dictionary <code class="docutils literal notranslate"><span class="pre">fragments</span></code> representing the empty fragment pool. It contains a key for each symbol in the grammar (and the empty set as value).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FragmentMutator</span><span class="p">(</span><span class="n">Mutator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mutate inputs with input fragments from a pool&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">:</span> <span class="n">EarleyParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize empty fragment pool and add parser&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">parser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">DerivationTree</span><span class="p">]]</span> <span class="o">=</span> \
            <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">cgrammar</span><span class="p">}</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">FragmentMutator</span></code> adds fragments recursively. A <em>fragment</em> is a subtree in the parse tree and consists of the symbol of the current node and child nodes (i.e., descendant fragments). We can exclude fragments starting with symbols that are tokens, terminals, or not part of the grammar.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Parser</span> <span class="kn">import</span> <span class="n">terminals</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FragmentMutator</span><span class="p">(</span><span class="n">FragmentMutator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">add_fragment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fragment</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Recursively adds fragments to the fragment pool&quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span> <span class="o">=</span> <span class="n">fragment</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_excluded</span><span class="p">(</span><span class="n">symbol</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fragment</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">children</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">subfragment</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_fragment</span><span class="p">(</span><span class="n">subfragment</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_excluded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns true if a fragment starting with a specific</span>
<span class="sd">           symbol and all its decendents can be excluded&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">grammar</span><span class="p">()</span> <span class="ow">or</span>
                <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">tokens</span> <span class="ow">or</span>
                <span class="n">symbol</span> <span class="ow">in</span> <span class="n">terminals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">grammar</span><span class="p">()))</span>
</pre></div>
</div>
</div>
</div>
<p>Parsing can take a long time, particularly if there is too much ambiguity during the parsing. In order to maintain the efficiency of mutational fuzzing, we will limit the parsing time to 200ms.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Timeout</span> <span class="kn">import</span> <span class="n">Timeout</span>
</pre></div>
</div>
</div>
</div>
<p>The function <code class="docutils literal notranslate"><span class="pre">add_to_fragment_pool()</span></code> parses a seed (no longer than 200ms) and adds all its fragments to the fragment pool. If the parsing of the <code class="docutils literal notranslate"><span class="pre">seed</span></code> was successful, the attribute <code class="docutils literal notranslate"><span class="pre">seed.has_structure</span></code> is set to <code class="docutils literal notranslate"><span class="pre">True</span></code>. Otherwise, it is set to <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SeedWithStructure</span><span class="p">(</span><span class="n">Seed</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Seeds augmented with structure info&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_structure</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">:</span> <span class="n">DerivationTree</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&lt;empty&gt;&quot;</span><span class="p">,</span> <span class="p">[])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FragmentMutator</span><span class="p">(</span><span class="n">FragmentMutator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">add_to_fragment_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="n">SeedWithStructure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds all fragments of a seed to the fragment pool&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>  <span class="c1"># only allow quick parsing of 200ms max</span>
            <span class="k">with</span> <span class="n">Timeout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">):</span>
                <span class="n">seed</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_fragment</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
            <span class="n">seed</span><span class="o">.</span><span class="n">has_structure</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">SyntaxError</span><span class="p">,</span> <span class="ne">TimeoutError</span><span class="p">):</span>
            <span class="n">seed</span><span class="o">.</span><span class="n">has_structure</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s see how <code class="docutils literal notranslate"><span class="pre">FragmentMutator</span></code> fills the fragment pool for a simple HTML seed input. We initialize mutator with the <code class="docutils literal notranslate"><span class="pre">EarleyParser</span></code> which itself is initialized with our <code class="docutils literal notranslate"><span class="pre">XML_GRAMMAR</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">GrammarFuzzer</span> <span class="kn">import</span> <span class="n">tree_to_string</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">valid_seed</span> <span class="o">=</span> <span class="n">SeedWithStructure</span><span class="p">(</span>
    <span class="s2">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">)</span>
<span class="n">fragment_mutator</span> <span class="o">=</span> <span class="n">FragmentMutator</span><span class="p">(</span><span class="n">EarleyParser</span><span class="p">(</span><span class="n">XML_GRAMMAR</span><span class="p">,</span> <span class="n">tokens</span><span class="o">=</span><span class="n">XML_TOKENS</span><span class="p">))</span>
<span class="n">fragment_mutator</span><span class="o">.</span><span class="n">add_to_fragment_pool</span><span class="p">(</span><span class="n">valid_seed</span><span class="p">)</span>

<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">fragment_mutator</span><span class="o">.</span><span class="n">fragments</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fragment_mutator</span><span class="o">.</span><span class="n">fragments</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;|-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">tree_to_string</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;start&gt;
|-&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;
&lt;xml-tree&gt;
|-&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;
|-&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;
|-&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;
|-&lt;title&gt;Hello&lt;/title&gt;
|-Hello
|-&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;
|-World&lt;br/&gt;
|-World
|-&lt;br/&gt;
&lt;xml-open-tag&gt;
|-&lt;html&gt;
|-&lt;head&gt;
|-&lt;title&gt;
|-&lt;body&gt;
&lt;xml-openclose-tag&gt;
|-&lt;br/&gt;
&lt;xml-close-tag&gt;
|-&lt;/title&gt;
|-&lt;/head&gt;
|-&lt;/body&gt;
|-&lt;/html&gt;
&lt;xml-attribute&gt;
&lt;id&gt;
&lt;text&gt;
&lt;letter&gt;
&lt;letter_space&gt;
</pre></div>
</div>
</div>
</div>
<p>For many symbols in the grammar, we have collected a number of fragments. There are several open and closing tags and several interesting fragments starting with the <code class="docutils literal notranslate"><span class="pre">xml-tree</span></code> symbol.</p>
<p><em><strong>Summary</strong></em>. For each interesting symbol in the grammar, the <code class="docutils literal notranslate"><span class="pre">FragmentMutator</span></code> has a set of fragments. These fragments are extracted by first parsing the inputs to be mutated.</p>
</section>
<section id="fragment-based-mutation">
<h3>Fragment-Based Mutation<a class="headerlink" href="#fragment-based-mutation" title="Link to this heading">#</a></h3>
<p>We can use the fragments in the fragment pool to generate new inputs. Every seed that is being mutated is disassembled into fragments, and memoized – i.e., disassembled only the first time around.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FragmentMutator</span><span class="p">(</span><span class="n">FragmentMutator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">:</span> <span class="n">EarleyParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize mutators&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen_seeds</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SeedWithStructure</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">mutate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="n">SeedWithStructure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SeedWithStructure</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Implement structure-aware mutation. Memoize seeds.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen_seeds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seen_seeds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_to_fragment_pool</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Our first structural mutation operator is <code class="docutils literal notranslate"><span class="pre">swap_fragments()</span></code>, which choses a random fragment in the given seed and substitutes it with a random fragment from the pool. We make sure that both fragments start with the same symbol. For instance, we may swap a closing tag in the seed HTML by another closing tag from the fragment pool.</p>
<p>In order to choose a random fragment, the mutator counts all fragments (<code class="docutils literal notranslate"><span class="pre">n_count</span></code>) below the root fragment associated with the start-symbol.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FragmentMutator</span><span class="p">(</span><span class="n">FragmentMutator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">count_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fragment</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the number of nodes in the fragment&quot;&quot;&quot;</span>
        <span class="n">symbol</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="n">fragment</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_excluded</span><span class="p">(</span><span class="n">symbol</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">assert</span> <span class="n">children</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">count_nodes</span><span class="p">,</span> <span class="n">children</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>In order to swap the chosen fragment – identified using the “global” variable <code class="docutils literal notranslate"><span class="pre">self.to_swap</span></code> – the seed’s parse tree is traversed recursively.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FragmentMutator</span><span class="p">(</span><span class="n">FragmentMutator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">recursive_swap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fragment</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DerivationTree</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Recursively finds the fragment to swap.&quot;&quot;&quot;</span>
        <span class="n">symbol</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="n">fragment</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_excluded</span><span class="p">(</span><span class="n">symbol</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">children</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">to_swap</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_swap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
            <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">[</span><span class="n">symbol</span><span class="p">]))</span>

        <span class="k">assert</span> <span class="n">children</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">symbol</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recursive_swap</span><span class="p">,</span> <span class="n">children</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Our structural mutator chooses a random number between 2 (i.e., excluding the <code class="docutils literal notranslate"><span class="pre">start</span></code> symbol) and the total number of fragments (<code class="docutils literal notranslate"><span class="pre">n_count</span></code>) and uses the recursive swapping to generate the new fragment. The new fragment is serialized as string and returned as new seed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FragmentMutator</span><span class="p">(</span><span class="n">FragmentMutator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">:</span> <span class="n">EarleyParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutators</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">swap_fragment</span><span class="p">]</span>  <span class="c1"># type: ignore</span>

    <span class="k">def</span> <span class="nf">swap_fragment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="n">SeedWithStructure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SeedWithStructure</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Substitutes a random fragment with another with the same symbol&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">seed</span><span class="o">.</span><span class="n">has_structure</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
            <span class="n">n_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_nodes</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">to_swap</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_nodes</span><span class="p">)</span>
            <span class="n">new_structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recursive_swap</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>

            <span class="n">new_seed</span> <span class="o">=</span> <span class="n">SeedWithStructure</span><span class="p">(</span><span class="n">tree_to_string</span><span class="p">(</span><span class="n">new_structure</span><span class="p">))</span>
            <span class="n">new_seed</span><span class="o">.</span><span class="n">has_structure</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">new_seed</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">new_structure</span>
            <span class="k">return</span> <span class="n">new_seed</span>

        <span class="k">return</span> <span class="n">seed</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">valid_seed</span> <span class="o">=</span> <span class="n">SeedWithStructure</span><span class="p">(</span>
    <span class="s2">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">)</span>
<span class="n">lf_mutator</span> <span class="o">=</span> <span class="n">FragmentMutator</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">valid_seed</span><span class="p">)</span>
<span class="n">lf_mutator</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">valid_seed</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;title&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;
</pre></div>
</div>
</div>
</div>
<p>As we can see, one fragment has been substituted by another.</p>
<p>We can use a similar recursive traversal to <em>remove</em> a random fragment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FragmentMutator</span><span class="p">(</span><span class="n">FragmentMutator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">recursive_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fragment</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DerivationTree</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Recursively finds the fragment to delete&quot;&quot;&quot;</span>
        <span class="n">symbol</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="n">fragment</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_excluded</span><span class="p">(</span><span class="n">symbol</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">children</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">to_delete</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_delete</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">symbol</span><span class="p">,</span> <span class="p">[]</span>

        <span class="k">assert</span> <span class="n">children</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">symbol</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recursive_delete</span><span class="p">,</span> <span class="n">children</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>We should also define the corresponding structural deletion operator, as well.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FragmentMutator</span><span class="p">(</span><span class="n">FragmentMutator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delete_fragment</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete_fragment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="n">SeedWithStructure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SeedWithStructure</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete a random fragment&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">seed</span><span class="o">.</span><span class="n">has_structure</span><span class="p">:</span>
            <span class="n">n_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_nodes</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">to_delete</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_nodes</span><span class="p">)</span>
            <span class="n">new_structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recursive_delete</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>

            <span class="n">new_seed</span> <span class="o">=</span> <span class="n">SeedWithStructure</span><span class="p">(</span><span class="n">tree_to_string</span><span class="p">(</span><span class="n">new_structure</span><span class="p">))</span>
            <span class="n">new_seed</span><span class="o">.</span><span class="n">has_structure</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">new_seed</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">new_structure</span>
            <span class="c1"># do not return an empty new_seed</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">new_seed</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">seed</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">new_seed</span>

        <span class="k">return</span> <span class="n">seed</span>
</pre></div>
</div>
</div>
</div>
<p><em><strong>Summary</strong></em>. We now have all ingredients for structure-aware fuzzing. Our mutator disassembles all seeds into fragments, which are then added to the fragment pool. Our mutator swaps random fragments in a given seed with fragments of the same type. And our mutator deletes random fragments in a given seed. This allows maintaining a high degree of validity for the generated inputs w.r.t. the given grammar.</p>
<p><em><strong>Try it</strong></em>. Try adding other structural mutation operators. How would an <em>add-operator</em> know the position in a given seed file, where it is okay to add a fragment starting with a certain symbol?</p>
</section>
<section id="fragment-based-fuzzing">
<h3>Fragment-Based Fuzzing<a class="headerlink" href="#fragment-based-fuzzing" title="Link to this heading">#</a></h3>
<p>We can now define an input-structure aware fuzzer as pioneered in LangFuzz. To implement LangFuzz, we modify our <a class="reference internal" href="GreyboxFuzzer.html#Blackbox-Mutation-based-Fuzzer"><span class="std std-ref">blackbox mutational fuzzer</span></a> to stack up to four structural mutations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LangFuzzer</span><span class="p">(</span><span class="n">AdvancedMutationFuzzer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Blackbox fuzzer mutating input fragments. Roughly based on `LangFuzz`.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">create_candidate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Seed</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns an input generated by fuzzing a seed in the population&quot;&quot;&quot;</span>
        <span class="n">candidate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">)</span>
        <span class="n">trials</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trials</span><span class="p">):</span>
            <span class="n">candidate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mutator</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">candidate</span>
</pre></div>
</div>
</div>
</div>
<p>Okay, let’s take our first input-structure aware fuzzer for a spin. Being careful, we set n=300 for now.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">300</span>
<span class="n">runner</span> <span class="o">=</span> <span class="n">FunctionCoverageRunner</span><span class="p">(</span><span class="n">my_parser</span><span class="p">)</span>
<span class="n">mutator</span> <span class="o">=</span> <span class="n">FragmentMutator</span><span class="p">(</span><span class="n">EarleyParser</span><span class="p">(</span><span class="n">XML_GRAMMAR</span><span class="p">,</span> <span class="n">tokens</span><span class="o">=</span><span class="n">XML_TOKENS</span><span class="p">))</span>
<span class="n">schedule</span> <span class="o">=</span> <span class="n">PowerSchedule</span><span class="p">()</span>

<span class="n">lang_fuzzer</span> <span class="o">=</span> <span class="n">LangFuzzer</span><span class="p">([</span><span class="n">valid_seed</span><span class="o">.</span><span class="n">data</span><span class="p">],</span> <span class="n">mutator</span><span class="p">,</span> <span class="n">schedule</span><span class="p">)</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">lang_fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">trials</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="s2">&quot;It took LangFuzzer </span><span class="si">%0.2f</span><span class="s2"> seconds to generate and execute </span><span class="si">%d</span><span class="s2"> inputs.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Exception ignored in: &lt;bound method IPythonKernel._clean_thread_parent_frames of &lt;ipykernel.ipkernel.IPythonKernel object at 0x103912720&gt;&gt;
Traceback (most recent call last):
  File &quot;/Users/zeller/.local/lib/python3.12/site-packages/ipykernel/ipkernel.py&quot;, line 775, in _clean_thread_parent_frames
    def _clean_thread_parent_frames(

  File &quot;Timeout.ipynb&quot;, line 43, in timeout_handler
    }
      
TimeoutError: 
Exception ignored in: &lt;bound method IPythonKernel._clean_thread_parent_frames of &lt;ipykernel.ipkernel.IPythonKernel object at 0x103912720&gt;&gt;
Traceback (most recent call last):
  File &quot;/Users/zeller/.local/lib/python3.12/site-packages/ipykernel/ipkernel.py&quot;, line 775, in _clean_thread_parent_frames
    def _clean_thread_parent_frames(

  File &quot;Timeout.ipynb&quot;, line 43, in timeout_handler
    }
      
TimeoutError: 
Exception ignored in: &lt;bound method IPythonKernel._clean_thread_parent_frames of &lt;ipykernel.ipkernel.IPythonKernel object at 0x103912720&gt;&gt;
Traceback (most recent call last):
  File &quot;/Users/zeller/.local/lib/python3.12/site-packages/ipykernel/ipkernel.py&quot;, line 775, in _clean_thread_parent_frames
    def _clean_thread_parent_frames(

  File &quot;Timeout.ipynb&quot;, line 43, in timeout_handler
    }
      
TimeoutError: 
Exception ignored in: &lt;bound method IPythonKernel._clean_thread_parent_frames of &lt;ipykernel.ipkernel.IPythonKernel object at 0x103912720&gt;&gt;
Traceback (most recent call last):
  File &quot;/Users/zeller/.local/lib/python3.12/site-packages/ipykernel/ipkernel.py&quot;, line 775, in _clean_thread_parent_frames
    def _clean_thread_parent_frames(

  File &quot;Timeout.ipynb&quot;, line 43, in timeout_handler
    }
      
TimeoutError: 
Exception ignored in: &lt;bound method IPythonKernel._clean_thread_parent_frames of &lt;ipykernel.ipkernel.IPythonKernel object at 0x103912720&gt;&gt;
Traceback (most recent call last):
  File &quot;/Users/zeller/.local/lib/python3.12/site-packages/ipykernel/ipkernel.py&quot;, line 775, in _clean_thread_parent_frames
    def _clean_thread_parent_frames(

  File &quot;Timeout.ipynb&quot;, line 43, in timeout_handler
    }
      
TimeoutError: 
Exception ignored in: &lt;bound method IPythonKernel._clean_thread_parent_frames of &lt;ipykernel.ipkernel.IPythonKernel object at 0x103912720&gt;&gt;
Traceback (most recent call last):
  File &quot;/Users/zeller/.local/lib/python3.12/site-packages/ipykernel/ipkernel.py&quot;, line 775, in _clean_thread_parent_frames
    def _clean_thread_parent_frames(

  File &quot;Timeout.ipynb&quot;, line 43, in timeout_handler
    }
      
TimeoutError: 
Exception ignored in: &lt;bound method IPythonKernel._clean_thread_parent_frames of &lt;ipykernel.ipkernel.IPythonKernel object at 0x103912720&gt;&gt;
Traceback (most recent call last):
  File &quot;/Users/zeller/.local/lib/python3.12/site-packages/ipykernel/ipkernel.py&quot;, line 775, in _clean_thread_parent_frames
    def _clean_thread_parent_frames(

  File &quot;Timeout.ipynb&quot;, line 43, in timeout_handler
    }
      
TimeoutError: 
Exception ignored in: &lt;bound method IPythonKernel._clean_thread_parent_frames of &lt;ipykernel.ipkernel.IPythonKernel object at 0x103912720&gt;&gt;
Traceback (most recent call last):
  File &quot;/Users/zeller/.local/lib/python3.12/site-packages/ipykernel/ipkernel.py&quot;, line 775, in _clean_thread_parent_frames
    def _clean_thread_parent_frames(

  File &quot;Timeout.ipynb&quot;, line 43, in timeout_handler
    }
      
TimeoutError: 
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;It took LangFuzzer 94.94 seconds to generate and execute 300 inputs.&#39;
</pre></div>
</div>
</div>
</div>
<p>We observe that structural mutation is <em>sooo very slow</em>. This is despite our time budget of 200ms for parsing. In contrast, our blackbox fuzzer alone can generate about 10k inputs per second!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">runner</span> <span class="o">=</span> <span class="n">FunctionCoverageRunner</span><span class="p">(</span><span class="n">my_parser</span><span class="p">)</span>
<span class="n">mutator</span> <span class="o">=</span> <span class="n">Mutator</span><span class="p">()</span>
<span class="n">schedule</span> <span class="o">=</span> <span class="n">PowerSchedule</span><span class="p">()</span>

<span class="n">blackFuzzer</span> <span class="o">=</span> <span class="n">AdvancedMutationFuzzer</span><span class="p">([</span><span class="n">valid_seed</span><span class="o">.</span><span class="n">data</span><span class="p">],</span> <span class="n">mutator</span><span class="p">,</span> <span class="n">schedule</span><span class="p">)</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">blackFuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">trials</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="s2">&quot;It took a blackbox fuzzer </span><span class="si">%0.2f</span><span class="s2"> seconds to generate and execute </span><span class="si">%d</span><span class="s2"> inputs.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;It took a blackbox fuzzer 0.10 seconds to generate and execute 300 inputs.&#39;
</pre></div>
</div>
</div>
</div>
<p>Indeed, our blackbox fuzzer is done in the blink of an eye.</p>
<p><em><strong>Try it</strong></em>. We can deal with this overhead using <a class="reference external" href="https://arxiv.org/abs/1811.09447">deferred parsing</a>. Instead of wasting time in the beginning of the fuzzing campaign when a byte-level mutator would make efficient progress, deferred parsing suggests to invest time in structural mutation only later in the fuzzing campaign when it becomes viable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">blackbox_coverage</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">coverage</span><span class="p">())</span>
<span class="s2">&quot;During this fuzzing campaign, the blackbox fuzzer covered </span><span class="si">%d</span><span class="s2"> statements.&quot;</span> <span class="o">%</span> <span class="n">blackbox_coverage</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;During this fuzzing campaign, the blackbox fuzzer covered 94 statements.&#39;
</pre></div>
</div>
</div>
</div>
<p>Let’s print some stats for our fuzzing campaigns. Since we’ll need to print stats more often later, we should wrap this into a function. In order to measure coverage, we import the <a class="reference internal" href="Coverage.html#Coverage-of-Basic-Fuzzing"><span class="std std-ref">population_coverage</span></a> function. It takes a set of inputs and a Python function, executes the inputs on that function and collects coverage information. Specifically, it returns a tuple <code class="docutils literal notranslate"><span class="pre">(all_coverage,</span> <span class="pre">cumulative_coverage)</span></code> where <code class="docutils literal notranslate"><span class="pre">all_coverage</span></code> is the set of statements covered by all inputs, and <code class="docutils literal notranslate"><span class="pre">cumulative_coverage</span></code> is the number of statements covered as the number of executed inputs increases. We are just interested in the latter to plot coverage over time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Coverage</span> <span class="kn">import</span> <span class="n">population_coverage</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">print_stats</span><span class="p">(</span><span class="n">fuzzer</span><span class="p">,</span> <span class="n">parser</span><span class="p">:</span> <span class="n">Parser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">coverage</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">population_coverage</span><span class="p">(</span><span class="n">fuzzer</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">my_parser</span><span class="p">)</span>

    <span class="n">has_structure</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">fuzzer</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
        <span class="c1"># reuse memoized information</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="s2">&quot;has_structure&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">seed</span><span class="o">.</span><span class="n">has_structure</span><span class="p">:</span> 
                <span class="n">has_structure</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">seed</span> <span class="o">=</span> <span class="n">Seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">Timeout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">):</span>
                    <span class="nb">next</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
                <span class="n">has_structure</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">SyntaxError</span><span class="p">,</span> <span class="ne">TimeoutError</span><span class="p">):</span>
                <span class="k">pass</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;From the </span><span class="si">%d</span><span class="s2"> generated inputs, </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%0.2f%%</span><span class="s2">) can be parsed.</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="s2">&quot;In total, </span><span class="si">%d</span><span class="s2"> statements are covered.&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">fuzzer</span><span class="o">.</span><span class="n">inputs</span><span class="p">),</span>
            <span class="n">has_structure</span><span class="p">,</span>
            <span class="mi">100</span> <span class="o">*</span> <span class="n">has_structure</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">fuzzer</span><span class="o">.</span><span class="n">inputs</span><span class="p">),</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">coverage</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<p>For LangFuzzer, let’s see how many of the inputs generated by LangFuzz are valid (i.e., parsable) and how many statements were covered.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_stats</span><span class="p">(</span><span class="n">lang_fuzzer</span><span class="p">,</span> <span class="n">EarleyParser</span><span class="p">(</span><span class="n">XML_GRAMMAR</span><span class="p">,</span> <span class="n">tokens</span><span class="o">=</span><span class="n">XML_TOKENS</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>From the 300 generated inputs, 172 (57.33%) can be parsed.
In total, 93 statements are covered.
</pre></div>
</div>
</div>
</div>
<p>What are the stats for the mutational fuzzer that uses only byte-level mutation (and no grammars)?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_stats</span><span class="p">(</span><span class="n">blackFuzzer</span><span class="p">,</span> <span class="n">EarleyParser</span><span class="p">(</span><span class="n">XML_GRAMMAR</span><span class="p">,</span> <span class="n">tokens</span><span class="o">=</span><span class="n">XML_TOKENS</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Exception ignored in: &lt;bound method IPythonKernel._clean_thread_parent_frames of &lt;ipykernel.ipkernel.IPythonKernel object at 0x103912720&gt;&gt;
Traceback (most recent call last):
  File &quot;/Users/zeller/.local/lib/python3.12/site-packages/ipykernel/ipkernel.py&quot;, line 775, in _clean_thread_parent_frames
    def _clean_thread_parent_frames(

  File &quot;Timeout.ipynb&quot;, line 43, in timeout_handler
    }
      
TimeoutError: 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>From the 300 generated inputs, 34 (11.33%) can be parsed.
In total, 167 statements are covered.
</pre></div>
</div>
</div>
</div>
<p><em><strong>Summary</strong></em>. Our fragment-level blackbox fuzzer (LangFuzzer) generates <em>more valid inputs</em> but achieves <em>less code coverage</em> than a fuzzer with our byte-level fuzzer. So, there is some value in generating inputs that do not stick to the provided grammar.</p>
</section>
<section id="integration-with-greybox-fuzzing">
<h3>Integration with Greybox Fuzzing<a class="headerlink" href="#integration-with-greybox-fuzzing" title="Link to this heading">#</a></h3>
<p>In the following we integrate fragment-level blackbox fuzzing (LangFuzz-style) with <a class="reference internal" href="GreyboxFuzzer.html#Greybox-Mutation-based-Fuzzer"><span class="std std-ref">byte-level greybox fuzzing</span></a> (AFL-style). The additional coverage-feedback might allow us to increase code coverage more quickly.</p>
<p>A <a class="reference internal" href="GreyboxFuzzer.html#Greybox-Mutation-based-Fuzzer"><span class="std std-ref">greybox fuzzer</span></a> adds to the seed population all generated inputs which increase code coverage. Inputs are generated in two stages, stacking up to four structural mutations and up to 32 byte-level mutations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GreyboxGrammarFuzzer</span><span class="p">(</span><span class="n">GreyboxFuzzer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Greybox fuzzer using grammars.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seeds</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                 <span class="n">byte_mutator</span><span class="p">:</span> <span class="n">Mutator</span><span class="p">,</span> <span class="n">tree_mutator</span><span class="p">:</span> <span class="n">FragmentMutator</span><span class="p">,</span>
                 <span class="n">schedule</span><span class="p">:</span> <span class="n">PowerSchedule</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor.</span>
<span class="sd">        `seeds` - set of inputs to mutate.</span>
<span class="sd">        `byte_mutator` - a byte-level mutator.</span>
<span class="sd">        `tree_mutator` = a tree-level mutator.</span>
<span class="sd">        `schedule` - a power schedule.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">seeds</span><span class="p">,</span> <span class="n">byte_mutator</span><span class="p">,</span> <span class="n">schedule</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_mutator</span> <span class="o">=</span> <span class="n">tree_mutator</span>

    <span class="k">def</span> <span class="nf">create_candidate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns an input generated by structural mutation </span>
<span class="sd">           of a seed in the population&quot;&quot;&quot;</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">SeedWithStructure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="p">))</span>

        <span class="c1"># Structural mutation</span>
        <span class="n">trials</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trials</span><span class="p">):</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_mutator</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

        <span class="c1"># Byte-level mutation</span>
        <span class="n">candidate</span> <span class="o">=</span> <span class="n">seed</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="n">trials</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">seed</span><span class="o">.</span><span class="n">has_structure</span> <span class="ow">or</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dumb_trials</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dumb_trials</span><span class="p">):</span>
                <span class="n">candidate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mutator</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">candidate</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s run our integrated fuzzer with the <a class="reference internal" href="GreyboxFuzzer.html#Mutator-and-Seed"><span class="std std-ref">standard byte-level mutator</span></a> and our <a class="reference internal" href="#Fragment-based-Mutation"><span class="xref myst">fragment-based structural mutator</span></a> that was introduced above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">runner</span> <span class="o">=</span> <span class="n">FunctionCoverageRunner</span><span class="p">(</span><span class="n">my_parser</span><span class="p">)</span>
<span class="n">byte_mutator</span> <span class="o">=</span> <span class="n">Mutator</span><span class="p">()</span>
<span class="n">tree_mutator</span> <span class="o">=</span> <span class="n">FragmentMutator</span><span class="p">(</span><span class="n">EarleyParser</span><span class="p">(</span><span class="n">XML_GRAMMAR</span><span class="p">,</span> <span class="n">tokens</span><span class="o">=</span><span class="n">XML_TOKENS</span><span class="p">))</span>
<span class="n">schedule</span> <span class="o">=</span> <span class="n">PowerSchedule</span><span class="p">()</span>

<span class="n">gg_fuzzer</span> <span class="o">=</span> <span class="n">GreyboxGrammarFuzzer</span><span class="p">([</span><span class="n">valid_seed</span><span class="o">.</span><span class="n">data</span><span class="p">],</span> <span class="n">byte_mutator</span><span class="p">,</span> <span class="n">tree_mutator</span><span class="p">,</span> <span class="n">schedule</span><span class="p">)</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">gg_fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">trials</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="s2">&quot;It took the greybox grammar fuzzer </span><span class="si">%0.2f</span><span class="s2"> seconds to generate and execute </span><span class="si">%d</span><span class="s2"> inputs.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;It took the greybox grammar fuzzer 0.69 seconds to generate and execute 300 inputs.&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_stats</span><span class="p">(</span><span class="n">gg_fuzzer</span><span class="p">,</span> <span class="n">EarleyParser</span><span class="p">(</span><span class="n">XML_GRAMMAR</span><span class="p">,</span> <span class="n">tokens</span><span class="o">=</span><span class="n">XML_TOKENS</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>From the 300 generated inputs, 2 (0.67%) can be parsed.
In total, 171 statements are covered.
</pre></div>
</div>
</div>
</div>
<p><em><strong>Summary</strong></em>. Our structural greybox fuzzer</p>
<ul class="simple">
<li><p>runs faster than the fragment-based LangFuzzer,</p></li>
<li><p>achieves more coverage than both the fragment-based LangFuzzer and the vanilla blackbox mutational fuzzer, and</p></li>
<li><p>generates fewer valid inputs than even the vanilla blackbox mutational fuzzer.</p></li>
</ul>
</section>
</section>
<section id="id3">
<h2>Fuzzing with Input Regions<a class="headerlink" href="#id3" title="Link to this heading">#</a></h2>
<p>In the previous section, we have seen that most inputs that are added as seeds are <em>invalid</em> w.r.t. our given grammar. Yet, in order to apply our fragment-based mutators, we need it to parse the seed successfully. Otherwise, the entire fragment-based approach becomes useless.  The question arises: <em>How can we derive structure from (invalid) seeds that cannot be parsed successfully?</em></p>
<p>To this end, we introduce the idea of <em>region-based mutation</em>, first explored with the <a class="reference external" href="https://github.com/aflsmart/aflsmart">AFLSmart</a> structural greybox fuzzer \cite{Pham2018aflsmart}. AFLSmart implements byte-level, fragment-based, and region-based mutation as well as validity-based power schedules. We define <em>region-based mutators</em>, where a <em>region</em> is a consecutive sequence of bytes in the input that can be associated with a symbol in the grammar.</p>
<p>The basic idea of fuzzing with input regions is shown in the following diagram. After <em>parsing</em> an input (into a derivation tree), we can identify <em>regions</em> associated with specific subtrees of the derivation tree. These regions can then be deleted or swapped.</p>
<img src="PICS/GreyboxGrammarFuzzer-Regions.gif"><p>Such regions can also be determined even if the input is incomplete or invalid, allowing for robust parsing.</p>
<section id="determining-symbol-regions">
<h3>Determining Symbol Regions<a class="headerlink" href="#determining-symbol-regions" title="Link to this heading">#</a></h3>
<p>How can we obtain regions for a given input? The function <code class="docutils literal notranslate"><span class="pre">chart_parse()</span></code> of the <a class="reference internal" href="Parser.html#The-Parsing-Algorithm"><span class="std std-ref">Earley parser</span></a> produces a <em>parse table</em> for a string. For each letter in the string, this table gives the potential symbol and a <em>region</em> of neighboring letters that might belong to the same symbol.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">invalid_seed</span> <span class="o">=</span> <span class="n">Seed</span><span class="p">(</span><span class="s2">&quot;&lt;html&gt;&lt;body&gt;&lt;i&gt;World&lt;/i&gt;&lt;br/&gt;&gt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">)</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">EarleyParser</span><span class="p">(</span><span class="n">XML_GRAMMAR</span><span class="p">,</span> <span class="n">tokens</span><span class="o">=</span><span class="n">XML_TOKENS</span><span class="p">)</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">chart_parse</span><span class="p">(</span><span class="n">invalid_seed</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">parser</span><span class="o">.</span><span class="n">start_symbol</span><span class="p">())</span>
<span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>None chart[0]

---
&lt; chart[1]

---
h chart[2]
&lt;letter&gt;:= h |(1,2)
&lt;id&gt;:= &lt;letter&gt; |(1,2)
---
t chart[3]
&lt;letter&gt;:= t |(2,3)
&lt;id&gt;:= &lt;id&gt; &lt;letter&gt; |(1,3)
---
m chart[4]
&lt;letter&gt;:= m |(3,4)
&lt;id&gt;:= &lt;id&gt; &lt;letter&gt; |(1,4)
---
l chart[5]
&lt;letter&gt;:= l |(4,5)
&lt;id&gt;:= &lt;id&gt; &lt;letter&gt; |(1,5)
---
&gt; chart[6]
&lt;xml-open-tag&gt;:= &lt; &lt;id&gt; &gt; |(0,6)
---
&lt; chart[7]

---
b chart[8]
&lt;letter&gt;:= b |(7,8)
&lt;id&gt;:= &lt;letter&gt; |(7,8)
---
o chart[9]
&lt;letter&gt;:= o |(8,9)
&lt;id&gt;:= &lt;id&gt; &lt;letter&gt; |(7,9)
---
d chart[10]
&lt;letter&gt;:= d |(9,10)
&lt;id&gt;:= &lt;id&gt; &lt;letter&gt; |(7,10)
---
y chart[11]
&lt;letter&gt;:= y |(10,11)
&lt;id&gt;:= &lt;id&gt; &lt;letter&gt; |(7,11)
---
&gt; chart[12]
&lt;xml-open-tag&gt;:= &lt; &lt;id&gt; &gt; |(6,12)
---
&lt; chart[13]

---
i chart[14]
&lt;letter&gt;:= i |(13,14)
&lt;id&gt;:= &lt;letter&gt; |(13,14)
---
&gt; chart[15]
&lt;xml-open-tag&gt;:= &lt; &lt;id&gt; &gt; |(12,15)
---
W chart[16]
&lt;letter_space&gt;:= W |(15,16)
&lt;text&gt;:= &lt;letter_space&gt; |(15,16)
&lt;xml-tree&gt;:= &lt;text&gt; |(15,16)
---
o chart[17]
&lt;letter_space&gt;:= o |(16,17)
&lt;text&gt;:= &lt;text&gt; &lt;letter_space&gt; |(15,17)
&lt;text&gt;:= &lt;letter_space&gt; |(16,17)
&lt;xml-tree&gt;:= &lt;text&gt; |(15,17)
&lt;xml-tree&gt;:= &lt;text&gt; |(16,17)
&lt;xml-tree&gt;:= &lt;xml-tree&gt; &lt;xml-tree&gt; |(15,17)
---
r chart[18]
&lt;letter_space&gt;:= r |(17,18)
&lt;text&gt;:= &lt;text&gt; &lt;letter_space&gt; |(15,18)
&lt;text&gt;:= &lt;text&gt; &lt;letter_space&gt; |(16,18)
&lt;text&gt;:= &lt;letter_space&gt; |(17,18)
&lt;xml-tree&gt;:= &lt;text&gt; |(15,18)
&lt;xml-tree&gt;:= &lt;text&gt; |(16,18)
&lt;xml-tree&gt;:= &lt;text&gt; |(17,18)
&lt;xml-tree&gt;:= &lt;xml-tree&gt; &lt;xml-tree&gt; |(15,18)
&lt;xml-tree&gt;:= &lt;xml-tree&gt; &lt;xml-tree&gt; |(16,18)
---
l chart[19]
&lt;letter_space&gt;:= l |(18,19)
&lt;text&gt;:= &lt;text&gt; &lt;letter_space&gt; |(15,19)
&lt;text&gt;:= &lt;text&gt; &lt;letter_space&gt; |(16,19)
&lt;text&gt;:= &lt;text&gt; &lt;letter_space&gt; |(17,19)
&lt;text&gt;:= &lt;letter_space&gt; |(18,19)
&lt;xml-tree&gt;:= &lt;text&gt; |(15,19)
&lt;xml-tree&gt;:= &lt;text&gt; |(16,19)
&lt;xml-tree&gt;:= &lt;text&gt; |(17,19)
&lt;xml-tree&gt;:= &lt;text&gt; |(18,19)
&lt;xml-tree&gt;:= &lt;xml-tree&gt; &lt;xml-tree&gt; |(15,19)
&lt;xml-tree&gt;:= &lt;xml-tree&gt; &lt;xml-tree&gt; |(16,19)
&lt;xml-tree&gt;:= &lt;xml-tree&gt; &lt;xml-tree&gt; |(17,19)
---
d chart[20]
&lt;letter_space&gt;:= d |(19,20)
&lt;text&gt;:= &lt;text&gt; &lt;letter_space&gt; |(15,20)
&lt;text&gt;:= &lt;text&gt; &lt;letter_space&gt; |(16,20)
&lt;text&gt;:= &lt;text&gt; &lt;letter_space&gt; |(17,20)
&lt;text&gt;:= &lt;text&gt; &lt;letter_space&gt; |(18,20)
&lt;text&gt;:= &lt;letter_space&gt; |(19,20)
&lt;xml-tree&gt;:= &lt;text&gt; |(15,20)
&lt;xml-tree&gt;:= &lt;text&gt; |(16,20)
&lt;xml-tree&gt;:= &lt;text&gt; |(17,20)
&lt;xml-tree&gt;:= &lt;text&gt; |(18,20)
&lt;xml-tree&gt;:= &lt;text&gt; |(19,20)
&lt;xml-tree&gt;:= &lt;xml-tree&gt; &lt;xml-tree&gt; |(15,20)
&lt;xml-tree&gt;:= &lt;xml-tree&gt; &lt;xml-tree&gt; |(16,20)
&lt;xml-tree&gt;:= &lt;xml-tree&gt; &lt;xml-tree&gt; |(17,20)
&lt;xml-tree&gt;:= &lt;xml-tree&gt; &lt;xml-tree&gt; |(18,20)
---
&lt; chart[21]

---
/ chart[22]

---
i chart[23]
&lt;letter&gt;:= i |(22,23)
&lt;id&gt;:= &lt;letter&gt; |(22,23)
---
&gt; chart[24]
&lt;xml-close-tag&gt;:= &lt; / &lt;id&gt; &gt; |(20,24)
&lt;xml-tree&gt;:= &lt;xml-open-tag&gt; &lt;xml-tree&gt; &lt;xml-close-tag&gt; |(12,24)
---
&lt; chart[25]

---
b chart[26]
&lt;letter&gt;:= b |(25,26)
&lt;id&gt;:= &lt;letter&gt; |(25,26)
---
r chart[27]
&lt;letter&gt;:= r |(26,27)
&lt;id&gt;:= &lt;id&gt; &lt;letter&gt; |(25,27)
---
/ chart[28]

---
&gt; chart[29]
&lt;xml-openclose-tag&gt;:= &lt; &lt;id&gt; / &gt; |(24,29)
&lt;xml-tree&gt;:= &lt;xml-openclose-tag&gt; |(24,29)
&lt;xml-tree&gt;:= &lt;xml-tree&gt; &lt;xml-tree&gt; |(12,29)
---
&gt; chart[30]

---
/ chart[31]

---
b chart[32]

---
o chart[33]

---
d chart[34]

---
y chart[35]

---
&gt; chart[36]

---
&lt; chart[37]

---
/ chart[38]

---
h chart[39]

---
t chart[40]

---
m chart[41]

---
l chart[42]

---
&gt; chart[43]

---
</pre></div>
</div>
</div>
</div>
<p>The number of columns in this table that are associated with potential symbols correspond to the number of letters that could be parsed successfully. In other words, we can use this table to compute the longest parsable substring.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">states</span><span class="p">]</span>
<span class="n">parsable</span> <span class="o">=</span> <span class="n">invalid_seed</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">invalid_seed</span><span class="p">)</span>
<span class="n">parsable</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;&lt;html&gt;&lt;body&gt;&lt;i&gt;World&lt;/i&gt;&lt;br/&gt;&gt;/body&gt;&lt;/html&gt;&#39;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;&lt;html&gt;&lt;body&gt;&lt;i&gt;World&lt;/i&gt;&lt;br/&gt;&#39;
</pre></div>
</div>
</div>
</div>
<p>From this, we can compute the <em>degree of validity</em> for an input.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">validity</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">parsable</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid_seed</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="s2">&quot;</span><span class="si">%0.1f%%</span><span class="s2"> of the string can be parsed successfully.&quot;</span> <span class="o">%</span> <span class="n">validity</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;67.4% of the string can be parsed successfully.&#39;
</pre></div>
</div>
</div>
</div>
<p><em><strong>Summary</strong></em>. Unlike input fragments, input regions can be derived even if the parser fails to generate the entire parse tree.</p>
</section>
<section id="region-based-mutation">
<h3>Region-Based Mutation<a class="headerlink" href="#region-based-mutation" title="Link to this heading">#</a></h3>
<p>To fuzz invalid seeds, the region-based mutator associates symbols from the grammar with regions (i.e., indexed substrings) in the seed. The <a class="reference internal" href="#Building-the-Fragment-Pool"><span class="xref myst">overridden</span></a> method <code class="docutils literal notranslate"><span class="pre">add_to_fragment_pool()</span></code> first tries to mine the fragments from the seed. If this fails, the region mutator uses <a class="reference internal" href="Parser.html#The-Parsing-Algorithm"><span class="std std-ref">Earley parser</span></a> to derive the parse table. For each column (i.e., letter), it extracts the symbols and corresponding regions. This allows the mutator to store the set of regions with each symbol.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SeedWithRegions</span><span class="p">(</span><span class="n">SeedWithStructure</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Seeds augmented with structure info&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_regions</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Set</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RegionMutator</span><span class="p">(</span><span class="n">FragmentMutator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">add_to_fragment_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="n">SeedWithRegions</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mark fragments and regions in a seed file&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_to_fragment_pool</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">seed</span><span class="o">.</span><span class="n">has_structure</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">Timeout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">):</span>
                    <span class="n">seed</span><span class="o">.</span><span class="n">regions</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">cgrammar</span><span class="p">}</span>
                    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">chart_parse</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">start_symbol</span><span class="p">()):</span>
                        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">column</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_excluded</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span>
                                    <span class="n">state</span><span class="o">.</span><span class="n">e_col</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">state</span><span class="o">.</span><span class="n">s_col</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span>
                                    <span class="n">state</span><span class="o">.</span><span class="n">finished</span><span class="p">()):</span>
                                <span class="n">seed</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">state</span><span class="o">.</span><span class="n">s_col</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                                                              <span class="n">state</span><span class="o">.</span><span class="n">e_col</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
                <span class="n">seed</span><span class="o">.</span><span class="n">has_regions</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                <span class="n">seed</span><span class="o">.</span><span class="n">has_regions</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">seed</span><span class="o">.</span><span class="n">has_regions</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<p>This is how these regions look like for our invalid seed. A region consists of a start and end index in the seed string.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">invalid_seed</span> <span class="o">=</span> <span class="n">SeedWithRegions</span><span class="p">(</span><span class="s2">&quot;&lt;html&gt;&lt;body&gt;&lt;i&gt;World&lt;/i&gt;&lt;br/&gt;&gt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">)</span>
<span class="n">mutator</span> <span class="o">=</span> <span class="n">RegionMutator</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
<span class="n">mutator</span><span class="o">.</span><span class="n">add_to_fragment_pool</span><span class="p">(</span><span class="n">invalid_seed</span><span class="p">)</span>
<span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">invalid_seed</span><span class="o">.</span><span class="n">regions</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="ow">in</span> <span class="n">invalid_seed</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="n">symbol</span><span class="p">]:</span>  <span class="c1"># type: ignore</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;|-(</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">) : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">invalid_seed</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;start&gt;
&lt;xml-tree&gt;
|-(16,20) : orld
|-(12,24) : &lt;i&gt;World&lt;/i&gt;
|-(17,20) : rld
|-(18,20) : ld
|-(16,19) : orl
|-(15,17) : Wo
|-(12,29) : &lt;i&gt;World&lt;/i&gt;&lt;br/&gt;
|-(17,19) : rl
|-(15,20) : World
|-(24,29) : &lt;br/&gt;
|-(15,19) : Worl
|-(16,18) : or
|-(15,18) : Wor
&lt;xml-open-tag&gt;
|-(6,12) : &lt;body&gt;
|-(12,15) : &lt;i&gt;
|-(0,6) : &lt;html&gt;
&lt;xml-openclose-tag&gt;
|-(24,29) : &lt;br/&gt;
&lt;xml-close-tag&gt;
|-(20,24) : &lt;/i&gt;
&lt;xml-attribute&gt;
&lt;id&gt;
&lt;text&gt;
&lt;letter&gt;
&lt;letter_space&gt;
</pre></div>
</div>
</div>
</div>
<p>Now that we know which regions in the seed belong to which symbol, we can define region-based swap and delete operators.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RegionMutator</span><span class="p">(</span><span class="n">RegionMutator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">swap_fragment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="n">SeedWithRegions</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SeedWithRegions</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Chooses a random region and swaps it with a fragment</span>
<span class="sd">           that starts with the same symbol&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">seed</span><span class="o">.</span><span class="n">has_structure</span> <span class="ow">and</span> <span class="n">seed</span><span class="o">.</span><span class="n">has_regions</span><span class="p">:</span>
            <span class="n">regions</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">seed</span><span class="o">.</span><span class="n">regions</span>
                       <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="n">r</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
                           <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">[</span><span class="n">r</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">seed</span>

            <span class="n">key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">regions</span><span class="p">))</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
            <span class="n">swap_structure</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragments</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="n">swap_string</span> <span class="o">=</span> <span class="n">tree_to_string</span><span class="p">(</span><span class="n">swap_structure</span><span class="p">)</span>
            <span class="n">new_seed</span> <span class="o">=</span> <span class="n">SeedWithRegions</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="n">s</span><span class="p">]</span> <span class="o">+</span> <span class="n">swap_string</span> <span class="o">+</span> <span class="n">seed</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">e</span><span class="p">:])</span>
            <span class="n">new_seed</span><span class="o">.</span><span class="n">has_structure</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">new_seed</span><span class="o">.</span><span class="n">has_regions</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="n">new_seed</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">swap_fragment</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RegionMutator</span><span class="p">(</span><span class="n">RegionMutator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">delete_fragment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="n">SeedWithRegions</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SeedWithRegions</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deletes a random region&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">seed</span><span class="o">.</span><span class="n">has_structure</span> <span class="ow">and</span> <span class="n">seed</span><span class="o">.</span><span class="n">has_regions</span><span class="p">:</span>
            <span class="n">regions</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">seed</span><span class="o">.</span><span class="n">regions</span>
                       <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="n">r</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">seed</span>

            <span class="n">key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">regions</span><span class="p">))</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>

            <span class="n">new_seed</span> <span class="o">=</span> <span class="n">SeedWithRegions</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="n">s</span><span class="p">]</span> <span class="o">+</span> <span class="n">seed</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">e</span><span class="p">:])</span>
            <span class="n">new_seed</span><span class="o">.</span><span class="n">has_structure</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">new_seed</span><span class="o">.</span><span class="n">has_regions</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="n">new_seed</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">delete_fragment</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s try our new region-based mutator. We add a simple, valid seed to the fragment pool and attempt to mutate the invalid seed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">simple_seed</span> <span class="o">=</span> <span class="n">SeedWithRegions</span><span class="p">(</span><span class="s2">&quot;&lt;b&gt;Text&lt;/b&gt;&quot;</span><span class="p">)</span>
<span class="n">mutator</span> <span class="o">=</span> <span class="n">RegionMutator</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
<span class="n">mutator</span><span class="o">.</span><span class="n">add_to_fragment_pool</span><span class="p">(</span><span class="n">simple_seed</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">invalid_seed</span><span class="p">)</span>
<span class="n">mutator</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">invalid_seed</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;html&gt;&lt;body&gt;&lt;i&gt;World&lt;/i&gt;&lt;br/&gt;&gt;/body&gt;&lt;/html&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;html&gt;&lt;body&gt;&gt;/body&gt;&lt;/html&gt;
</pre></div>
</div>
</div>
</div>
<p><em><strong>Summary</strong></em>. We can use the Earley parser to generate a parse table and assign regions in the input to symbols in the grammar. Our region mutators can substitute these regions with fragments from the fragment pool that start with the same symbol, or delete these regions entirely.</p>
<p><em><strong>Try it</strong></em>. Implement a region pool (similar to the fragment pool) and a <code class="docutils literal notranslate"><span class="pre">swap_region()</span></code> mutator.
You can execute your own code by opening this chapter as Jupyter notebook.</p>
</section>
<section id="id4">
<h3>Integration with Greybox Fuzzing<a class="headerlink" href="#id4" title="Link to this heading">#</a></h3>
<p>Let’s try our shiny new region mutator by integrating it with our <a class="reference internal" href="#Integration-with-Greybox-Fuzzing"><span class="xref myst">structure-aware greybox fuzzer</span></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">runner</span> <span class="o">=</span> <span class="n">FunctionCoverageRunner</span><span class="p">(</span><span class="n">my_parser</span><span class="p">)</span>
<span class="n">byte_mutator</span> <span class="o">=</span> <span class="n">Mutator</span><span class="p">()</span>
<span class="n">tree_mutator</span> <span class="o">=</span> <span class="n">RegionMutator</span><span class="p">(</span><span class="n">EarleyParser</span><span class="p">(</span><span class="n">XML_GRAMMAR</span><span class="p">,</span> <span class="n">tokens</span><span class="o">=</span><span class="n">XML_TOKENS</span><span class="p">))</span>
<span class="n">schedule</span> <span class="o">=</span> <span class="n">PowerSchedule</span><span class="p">()</span>

<span class="n">regionFuzzer</span> <span class="o">=</span> <span class="n">GreyboxGrammarFuzzer</span><span class="p">([</span><span class="n">valid_seed</span><span class="o">.</span><span class="n">data</span><span class="p">],</span> <span class="n">byte_mutator</span><span class="p">,</span> <span class="n">tree_mutator</span><span class="p">,</span> <span class="n">schedule</span><span class="p">)</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">regionFuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">trials</span> <span class="o">=</span> <span class="n">n</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">It took the structural greybox fuzzer with region mutator</span>
<span class="sd">%0.2f seconds to generate and execute %d inputs.</span>
<span class="sd">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;\nIt took the structural greybox fuzzer with region mutator\n6.83 seconds to generate and execute 300 inputs.\n&#39;
</pre></div>
</div>
</div>
</div>
<p>We can see that the structural greybox fuzzer with region-based mutator is slower than the <a class="reference internal" href="#Fragment-based-Fuzzing"><span class="xref myst">fragment-based mutator alone</span></a>. This is because region-based structural mutation is applicable for <em>all seeds</em>. In contrast, fragment-based mutators were applicable only for tiny number of parsable seeds. Otherwise, only (very efficient) byte-level mutators were applied.</p>
<p>Let’s also print the average degree of validity for the seeds in the population.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">print_more_stats</span><span class="p">(</span><span class="n">fuzzer</span><span class="p">:</span> <span class="n">GreyboxGrammarFuzzer</span><span class="p">,</span> <span class="n">parser</span><span class="p">:</span> <span class="n">EarleyParser</span><span class="p">):</span>
    <span class="n">print_stats</span><span class="p">(</span><span class="n">fuzzer</span><span class="p">,</span> <span class="n">parser</span><span class="p">)</span>
    <span class="n">validity</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">fuzzer</span><span class="o">.</span><span class="n">population</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">seed</span><span class="o">.</span><span class="n">data</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">chart_parse</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">parser</span><span class="o">.</span><span class="n">start_symbol</span><span class="p">())</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">states</span><span class="p">]</span>
        <span class="n">parsable</span> <span class="o">=</span> <span class="n">invalid_seed</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">validity</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parsable</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;On average, </span><span class="si">%0.1f%%</span><span class="s2"> of a seed in the population can be successfully parsed.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">validity</span> <span class="o">/</span> <span class="n">total</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_more_stats</span><span class="p">(</span><span class="n">regionFuzzer</span><span class="p">,</span> <span class="n">parser</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>From the 300 generated inputs, 11 (3.67%) can be parsed.
In total, 168 statements are covered.
On average, 18.2% of a seed in the population can be successfully parsed.
</pre></div>
</div>
</div>
</div>
<p><em><strong>Summary</strong></em>. Compared to fragment-based mutation, a greybox fuzzer with region-based mutation achieves <em>higher coverage</em> but generates a <em>smaller number of valid inputs</em>. The higher coverage is explained by leveraging at least <em>some</em> structure for seeds that cannot be parsed successfully.</p>
</section>
<section id="focusing-on-valid-seeds">
<h3>Focusing on Valid Seeds<a class="headerlink" href="#focusing-on-valid-seeds" title="Link to this heading">#</a></h3>
<p>In the previous section, we have a problem: The low (degree of) validity.  To address this problem, a <em>validity-based power schedule</em> assigns more <a class="reference internal" href="GreyboxFuzzer.html#Power-Schedules"><span class="std std-ref">energy</span></a> to seeds that have a higher degree of validity.  In other words, the fuzzer <em>spends more time fuzzing seeds that are more valid</em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AFLSmartSchedule</span><span class="p">(</span><span class="n">PowerSchedule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">:</span> <span class="n">EarleyParser</span><span class="p">,</span> <span class="n">exponent</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">parser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exponent</span> <span class="o">=</span> <span class="n">exponent</span>

    <span class="k">def</span> <span class="nf">parsable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="n">Seed</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the substring that is parsable&quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">chart_parse</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">start_symbol</span><span class="p">())</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">states</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">seed</span><span class="o">.</span><span class="n">data</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">degree_of_validity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="n">Seed</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the proportion of a seed that is parsable&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="s1">&#39;validity&#39;</span><span class="p">):</span>
            <span class="n">seed</span><span class="o">.</span><span class="n">validity</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parsable</span><span class="p">(</span><span class="n">seed</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                             <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">seed</span><span class="o">.</span><span class="n">validity</span>  <span class="c1"># type: ignore</span>

    <span class="k">def</span> <span class="nf">assignEnergy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Seed</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assign exponential energy proportional to degree of validity&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="n">population</span><span class="p">:</span>
            <span class="n">seed</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">degree_of_validity</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">data</span><span class="p">)))</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">exponent</span>
                           <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seed</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s play with the degree of validity by passing in a valid seed …</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">smart_schedule</span> <span class="o">=</span> <span class="n">AFLSmartSchedule</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%11s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;Entire seed&quot;</span><span class="p">,</span> <span class="n">simple_seed</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%11s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;Parsable&quot;</span><span class="p">,</span> <span class="n">smart_schedule</span><span class="o">.</span><span class="n">parsable</span><span class="p">(</span><span class="n">simple_seed</span><span class="p">)))</span>

<span class="s2">&quot;Degree of validity: </span><span class="si">%0.2f%%</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">smart_schedule</span><span class="o">.</span><span class="n">degree_of_validity</span><span class="p">(</span><span class="n">simple_seed</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Entire seed: &lt;b&gt;Text&lt;/b&gt;
   Parsable: &lt;b&gt;Text&lt;/b&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Degree of validity: 100.00%&#39;
</pre></div>
</div>
</div>
</div>
<p>… and an invalid seed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%11s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;Entire seed&quot;</span><span class="p">,</span> <span class="n">invalid_seed</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%11s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;Parsable&quot;</span><span class="p">,</span> <span class="n">smart_schedule</span><span class="o">.</span><span class="n">parsable</span><span class="p">(</span><span class="n">invalid_seed</span><span class="p">)))</span>

<span class="s2">&quot;Degree of validity: </span><span class="si">%0.2f%%</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">smart_schedule</span><span class="o">.</span><span class="n">degree_of_validity</span><span class="p">(</span><span class="n">invalid_seed</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Entire seed: &lt;html&gt;&lt;body&gt;&lt;i&gt;World&lt;/i&gt;&lt;br/&gt;&gt;/body&gt;&lt;/html&gt;
   Parsable: &lt;html&gt;&lt;body&gt;&lt;i&gt;World&lt;/i&gt;&lt;br/&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Degree of validity: 67.44%&#39;
</pre></div>
</div>
</div>
</div>
<p>Excellent. We can compute the degree of validity as the proportion of the string that can be parsed.</p>
<p>Let’s plug the validity-based power schedule into the structure-aware greybox fuzzer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">runner</span> <span class="o">=</span> <span class="n">FunctionCoverageRunner</span><span class="p">(</span><span class="n">my_parser</span><span class="p">)</span>
<span class="n">byte_mutator</span> <span class="o">=</span> <span class="n">Mutator</span><span class="p">()</span>
<span class="n">tree_mutator</span> <span class="o">=</span> <span class="n">RegionMutator</span><span class="p">(</span><span class="n">EarleyParser</span><span class="p">(</span><span class="n">XML_GRAMMAR</span><span class="p">,</span> <span class="n">tokens</span><span class="o">=</span><span class="n">XML_TOKENS</span><span class="p">))</span>
<span class="n">schedule</span> <span class="o">=</span> <span class="n">AFLSmartSchedule</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>

<span class="n">aflsmart_fuzzer</span> <span class="o">=</span> <span class="n">GreyboxGrammarFuzzer</span><span class="p">([</span><span class="n">valid_seed</span><span class="o">.</span><span class="n">data</span><span class="p">],</span> <span class="n">byte_mutator</span><span class="p">,</span> 
                                       <span class="n">tree_mutator</span><span class="p">,</span> <span class="n">schedule</span><span class="p">)</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">aflsmart_fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">trials</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="s2">&quot;It took AFLSmart </span><span class="si">%0.2f</span><span class="s2"> seconds to generate and execute </span><span class="si">%d</span><span class="s2"> inputs.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Exception ignored in: &lt;bound method IPythonKernel._clean_thread_parent_frames of &lt;ipykernel.ipkernel.IPythonKernel object at 0x103912720&gt;&gt;
Traceback (most recent call last):
  File &quot;/Users/zeller/.local/lib/python3.12/site-packages/ipykernel/ipkernel.py&quot;, line 775, in _clean_thread_parent_frames
    def _clean_thread_parent_frames(

  File &quot;Timeout.ipynb&quot;, line 43, in timeout_handler
    }
      
TimeoutError: 
Exception ignored in: &lt;bound method IPythonKernel._clean_thread_parent_frames of &lt;ipykernel.ipkernel.IPythonKernel object at 0x103912720&gt;&gt;
Traceback (most recent call last):
  File &quot;/Users/zeller/.local/lib/python3.12/site-packages/ipykernel/ipkernel.py&quot;, line 775, in _clean_thread_parent_frames
    def _clean_thread_parent_frames(

  File &quot;Timeout.ipynb&quot;, line 43, in timeout_handler
    }
      
TimeoutError: 
Exception ignored in: &lt;bound method IPythonKernel._clean_thread_parent_frames of &lt;ipykernel.ipkernel.IPythonKernel object at 0x103912720&gt;&gt;
Traceback (most recent call last):
  File &quot;/Users/zeller/.local/lib/python3.12/site-packages/ipykernel/ipkernel.py&quot;, line 775, in _clean_thread_parent_frames
    def _clean_thread_parent_frames(

  File &quot;Timeout.ipynb&quot;, line 43, in timeout_handler
    }
      
TimeoutError: 
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;It took AFLSmart 26.16 seconds to generate and execute 300 inputs.&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">print_more_stats</span><span class="p">(</span><span class="n">aflsmart_fuzzer</span><span class="p">,</span> <span class="n">parser</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>From the 300 generated inputs, 9 (3.00%) can be parsed.
In total, 159 statements are covered.
On average, 22.6% of a seed in the population can be successfully parsed.
</pre></div>
</div>
</div>
</div>
<p><em><strong>Summary</strong></em>. Indeed, by spending more time fuzzing seeds with a higher degree of validity, we also generate inputs with a higher degree of validity. More inputs are entirely valid w.r.t. the given grammar.</p>
<p><em><strong>Read up</strong></em>. Learn more about region-based fuzzing, deferred parsing, and validity-based schedules in the original AFLSmart paper: “<a class="reference external" href="https://arxiv.org/abs/1811.09447">Smart Greybox Fuzzing</a>” by Pham and co-authors. Download and improve AFLSmart: <a class="github reference external" href="https://github.com/aflsmart/aflsmart">aflsmart/aflsmart</a>.</p>
</section>
</section>
<section id="mining-seeds">
<h2>Mining Seeds<a class="headerlink" href="#mining-seeds" title="Link to this heading">#</a></h2>
<p>By now, it should have become clear that the <em>choice of seeds</em> can very much influence the success of fuzzing.  One aspect is <em>variability</em> – our seeds should cover as many different features as possible in order to increase coverage.  Another aspect, however, is the <em>likelihood of a seed to induce errors</em> – that is, if a seed was involved in causing a failure before, then a mutation of this very seed may be likely to induce failures again.  This is because fixes for past failures typically are successful in letting the concrete failure no longer occur, but sometimes may fail to capture all conditions under which a failure may occur.  Hence, even if the original failure is fixed, the likelihood of an error in the <em>surroundings</em> of the original failure-inducing input is still higher.  It thus pays off to use as seeds <em>inputs that are known to have caused failures before</em>.</p>
<p>To put things in context, Holler’s <em>LangFuzz</em> fuzzer used as seeds JavaScript inputs from CVE reports.  These were published as failure-inducing inputs at a time when the error already had been fixed; thus they could do no harm anymore.  Yet, by using such inputs as seeds, LangFuzz would create plenty of mutations and recombinations of all their features, many of which would (and do) find errors again and again.</p>
</section>
<section id="lessons-learned">
<h2>Lessons Learned<a class="headerlink" href="#lessons-learned" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>A <strong>dictionary</strong> is useful to inject important keywords into the generated inputs.</p></li>
<li><p><strong>Fragment-based mutation</strong> first disassembles seeds into fragments, and reassembles these fragments to generate new inputs. A <em>fragment</em> is a subtree in the seed’s parse tree. However, fragment-based mutation requires that the seeds can be parsed successfully, which may not be true for seeds discovered by a coverage-based greybox fuzzer.</p></li>
<li><p><strong>Region-based mutation</strong> marks regions in the input as belonging to a certain symbol in the grammar. For instance, it may identify a substring ‘</a>’ as closing tag. These regions can then be deleted or substituted by fragments or regions belonging to the same symbol. Unlike fragment-based mutation, region-based mutation is applicable to <em>all</em> seeds - even those that can be parsed only partially. However, the degree of validity is still quite low for the generated inputs.</p></li>
<li><p>A <strong>validity-based power schedule</strong> invests more energy into seeds with a higher degree of validity. The inputs that are generated also have a higher degree of validity.</p></li>
<li><p><strong>Mining seeds</strong> from repositories of previous failure-inducing inputs results in input fragments associated with past failures, raising the likelihood to find more failures in the vicinity.</p></li>
</ul>
</section>
<section id="id5">
<h2>Background<a class="headerlink" href="#id5" title="Link to this heading">#</a></h2>
<p>This chapter builds on the following two works:</p>
<ul class="simple">
<li><p>The <em>LangFuzz</em> fuzzer \cite{Holler2012} is an efficient (and effective!) grammar-based fuzzer for (mostly) JavaScript.  It uses the grammar for parsing seeds and recombining their inputs with generated parts and found 2,600 bugs in JavaScript interpreters to date.</p></li>
<li><p>Smart greybox fuzzing (<a class="reference external" href="https://github.com/aflsmart/aflsmart">AFLSmart</a>) brings together coverage-based fuzzing and grammar-based (structural) fuzzing, as described in \cite{Pham2018aflsmart}.  The resulting AFLSMART tool has discovered 42 zero-day vulnerabilities in widely-used, well-tested tools and libraries; so far 17 CVEs were assigned.</p></li>
</ul>
<p>Recent fuzzing work also brings together grammar-based fuzzing and coverage.</p>
<ul class="simple">
<li><p><em>Superion</em> \cite{Wang2019superion} is equivalent to our section “Integration with Greybox Fuzzing”, as above – that is, a combination of LangFuzz and Greybox Fuzzing, but no AFL-style byte-level mutation.  Superion can improve the code coverage (i.e., 16.7% and 8.8% in line and function coverage) and bug-finding capability over AFL and jsfunfuzz.  According to the authors, they found 30 new bugs, among which they discovered 21 new vulnerabilities with 16 CVEs assigned and 3.2K USD bug bounty rewards received.</p></li>
<li><p><em>Nautilus</em> \cite{Aschermann2019nautilus} also combines grammar-based fuzzing with coverage feedback.  It maintains the parse tree for all seeds and generated inputs. To allow AFL-style byte-level mutations, it “collapses” subtrees back to byte-level representations.  This has the advantage of not having to re-parse generated seeds; however, over time, Nautilus degenerates to structure-unaware greybox fuzzing because it does not re-parse collapsed subtrees to reconstitute input structure for later seeds where most of the parse tree is collapsed.  Nautilus identified bugs in mruby, PHP, ChakraCore, and in Lua; reporting these bugs was awarded with a sum of 2600 USD and 6 CVEs were assigned.</p></li>
<li><p><a class="reference external" href="https://uds-se.github.io/FormatFuzzer/">FormatFuzzer</a> is a framework for high-efficiency, high-quality generation and parsing of binary inputs. It takes a binary template that describes the format of a binary input and generates an executable that produces and parses the given binary format. From a binary template for GIF, for instance, FormatFuzzer produces a GIF generator - also known as GIF fuzzer. Generators produced by FormatFuzzer are highly efficient, producing thousands of valid test inputs per second. FormatFuzzer operates in black-box settings, but can also integrate with AFL to produce valid inputs that also aim for maximum coverage.</p></li>
</ul>
</section>
<section id="id6">
<h2>Synopsis<a class="headerlink" href="#id6" title="Link to this heading">#</a></h2>
<p>This chapter introduces advanced methods for language-based grey-box fuzzing inspired by the <em>LangFuzz</em> and <em>AFLSmart</em> fuzzers.</p>
<section id="id7">
<h3>Fuzzing with Dictionaries<a class="headerlink" href="#id7" title="Link to this heading">#</a></h3>
<p>Rather than mutating strings randomly, the <code class="docutils literal notranslate"><span class="pre">DictMutator</span></code> class allows inserting tokens from a dictionary, thus increasing fuzzer performance. The dictionary comes as a list of strings, out of which random elements are picked and inserted - in addition to the given mutations such as deleting or inserting individual bytes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dict_mutator</span> <span class="o">=</span> <span class="n">DictMutator</span><span class="p">([</span><span class="s2">&quot;&lt;a&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;/a&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;a/&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;=&#39;a&#39;&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seeds</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">dict_mutator</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">seeds</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&gt;&gt;/body&gt;&lt;/html&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/ht7ml&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/hgad&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&lt;a/&gt;&gt;&lt;/body&gt;&lt;/html&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br+&gt;&lt;/body&gt;&lt;/html&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/qhead&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br=&#39;a&#39;/&gt;&lt;/body&gt;&lt;/html&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;Wormd&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;Wyorld&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;&lt;/a&gt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;
</pre></div>
</div>
</div>
</div>
<p>This <code class="docutils literal notranslate"><span class="pre">DictMutator</span></code> can be used as an argument to <code class="docutils literal notranslate"><span class="pre">GreyboxFuzzer</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">runner</span> <span class="o">=</span> <span class="n">FunctionCoverageRunner</span><span class="p">(</span><span class="n">my_parser</span><span class="p">)</span>
<span class="n">dict_fuzzer</span> <span class="o">=</span> <span class="n">GreyboxFuzzer</span><span class="p">(</span><span class="n">seeds</span><span class="p">,</span> <span class="n">dict_mutator</span><span class="p">,</span> <span class="n">PowerSchedule</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dict_fuzzer_outcome</span> <span class="o">=</span> <span class="n">dict_fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">trials</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="kn">from</span> <span class="nn">ClassDiagram</span> <span class="kn">import</span> <span class="n">display_class_hierarchy</span>
<span class="kn">from</span> <span class="nn">Coverage</span> <span class="kn">import</span> <span class="n">Location</span>  <span class="c1"># minor dependency</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="n">display_class_hierarchy</span><span class="p">([</span><span class="n">DictMutator</span><span class="p">],</span>
                        <span class="n">public_methods</span><span class="o">=</span><span class="p">[</span>
                            <span class="n">Mutator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">DictMutator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                        <span class="p">],</span>
                        <span class="n">types</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;DerivationTree&#39;</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">,</span>
                               <span class="s1">&#39;Location&#39;</span><span class="p">:</span> <span class="n">Location</span><span class="p">},</span>
                        <span class="n">project</span><span class="o">=</span><span class="s1">&#39;fuzzingbook&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (20241206.2353)
 -->
<!-- Pages: 1 -->
<svg width="306pt" height="152pt"
 viewBox="0.00 0.00 305.62 152.25" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 148.25)">
<g id="a_graph0"><a xlink:title="DictMutator class hierarchy">
<polygon fill="white" stroke="none" points="-4,4 -4,-148.25 301.62,-148.25 301.62,4 -4,4"/>
</a>
</g>
<!-- DictMutator -->
<g id="node1" class="node">
<title>DictMutator</title>
<g id="a_node1"><a xlink:href="#" xlink:title="class DictMutator:&#10;Mutate strings using keywords from a dictionary">
<polygon fill="none" stroke="black" points="0,-0.5 0,-60 160,-60 160,-0.5 0,-0.5"/>
<text text-anchor="start" x="42.12" y="-43.7" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">DictMutator</text>
<polyline fill="none" stroke="black" points="0,-34 160,-34"/>
<g id="a_node1_0"><a xlink:href="#" xlink:title="DictMutator">
<g id="a_node1_1"><a xlink:href="#" xlink:title="__init__(self, dictionary: List[str]) &#45;&gt; None:&#10;Constructor. `dictionary` is the list of keywords to use.">
<text text-anchor="start" x="8" y="-21.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node1_2"><a xlink:href="#" xlink:title="insert_from_dictionary(self, s: str) &#45;&gt; str:&#10;Returns s with a keyword from the dictionary inserted">
<text text-anchor="start" x="8" y="-7.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">insert_from_dictionary()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- Mutator -->
<g id="node2" class="node">
<title>Mutator</title>
<g id="a_node2"><a xlink:href="GreyboxFuzzer.ipynb" xlink:title="class Mutator:&#10;Mutate strings">
<polygon fill="none" stroke="black" points="42,-97 42,-143.75 118,-143.75 118,-97 42,-97"/>
<text text-anchor="start" x="54.12" y="-127.45" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">Mutator</text>
<polyline fill="none" stroke="black" points="42,-117.75 118,-117.75"/>
<g id="a_node2_3"><a xlink:href="#" xlink:title="Mutator">
<g id="a_node2_4"><a xlink:href="GreyboxFuzzer.ipynb" xlink:title="__init__(self) &#45;&gt; None:&#10;Constructor">
<text text-anchor="start" x="50" y="-105.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- DictMutator&#45;&gt;Mutator -->
<g id="edge1" class="edge">
<title>DictMutator&#45;&gt;Mutator</title>
<path fill="none" stroke="black" d="M80,-60.11C80,-68.16 80,-76.98 80,-85.3"/>
<polygon fill="none" stroke="black" points="76.5,-85.09 80,-95.09 83.5,-85.09 76.5,-85.09"/>
</g>
<!-- Legend -->
<g id="node3" class="node">
<title>Legend</title>
<text text-anchor="start" x="178.38" y="-46.25" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="10.00" fill="#b03a2e">Legend</text>
<text text-anchor="start" x="178.38" y="-36.25" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="184.38" y="-36.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="8.00">public_method()</text>
<text text-anchor="start" x="178.38" y="-26.25" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="184.38" y="-26.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="8.00">private_method()</text>
<text text-anchor="start" x="178.38" y="-16.25" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="184.38" y="-16.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="8.00">overloaded_method()</text>
<text text-anchor="start" x="178.38" y="-7.2" font-family="Helvetica,sans-Serif" font-size="9.00">Hover over names to see doc</text>
</g>
</g>
</svg>
</div></div>
</div>
</section>
<section id="id8">
<h3>Fuzzing with Input Fragments<a class="headerlink" href="#id8" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">LangFuzzer</span></code> class introduces a <em>language-aware</em> fuzzer that can recombine fragments from existing inputs – inspired by the highly effective <code class="docutils literal notranslate"><span class="pre">LangFuzz</span></code> fuzzer. At its core is a <code class="docutils literal notranslate"><span class="pre">FragmentMutator</span></code> class that that takes a <a class="reference internal" href="Parser.html"><span class="std std-doc"><em>parser</em></span></a> as argument:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">parser</span> <span class="o">=</span> <span class="n">EarleyParser</span><span class="p">(</span><span class="n">XML_GRAMMAR</span><span class="p">,</span> <span class="n">tokens</span><span class="o">=</span><span class="n">XML_TOKENS</span><span class="p">)</span>
<span class="n">mutator</span> <span class="o">=</span> <span class="n">FragmentMutator</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The fuzzer itself is initialized with a list of seeds, the above <code class="docutils literal notranslate"><span class="pre">FragmentMutator</span></code>, and a power schedule:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seeds</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">]</span>
<span class="n">schedule</span> <span class="o">=</span> <span class="n">PowerSchedule</span><span class="p">()</span>
<span class="n">lang_fuzzer</span> <span class="o">=</span> <span class="n">LangFuzzer</span><span class="p">(</span><span class="n">seeds</span><span class="p">,</span> <span class="n">mutator</span><span class="p">,</span> <span class="n">schedule</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">lang_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;
&lt;html&gt;World&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;
&lt;html&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;title&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;&lt;head&gt;World&lt;/head&gt;&lt;/title&gt;&lt;/head&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;
&lt;html&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Exception ignored in: &lt;bound method IPythonKernel._clean_thread_parent_frames of &lt;ipykernel.ipkernel.IPythonKernel object at 0x103912720&gt;&gt;
Traceback (most recent call last):
  File &quot;/Users/zeller/.local/lib/python3.12/site-packages/ipykernel/ipkernel.py&quot;, line 775, in _clean_thread_parent_frames
    def _clean_thread_parent_frames(

  File &quot;Timeout.ipynb&quot;, line 43, in timeout_handler
    }
      
TimeoutError: 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;html&gt;&lt;body&gt;WorldHello&lt;/body&gt;
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Exception ignored in: &lt;bound method IPythonKernel._clean_thread_parent_frames of &lt;ipykernel.ipkernel.IPythonKernel object at 0x103912720&gt;&gt;
Traceback (most recent call last):
  File &quot;/Users/zeller/.local/lib/python3.12/site-packages/ipykernel/ipkernel.py&quot;, line 775, in _clean_thread_parent_frames
    def _clean_thread_parent_frames(

  File &quot;Timeout.ipynb&quot;, line 43, in timeout_handler
    }
      
TimeoutError: 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;head&gt;&lt;head&gt;World&lt;/head&gt;&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;head&gt;&lt;title&gt;&lt;head&gt;World&lt;/head&gt;&lt;/title&gt;&lt;/head&gt;&lt;body&gt;World&lt;br/&gt;&lt;/body&gt;&lt;br/&gt;&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="n">display_class_hierarchy</span><span class="p">([</span><span class="n">LangFuzzer</span><span class="p">,</span> <span class="n">FragmentMutator</span><span class="p">],</span>
                        <span class="n">public_methods</span><span class="o">=</span><span class="p">[</span>
                            <span class="n">Fuzzer</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">Fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">,</span>
                            <span class="n">Fuzzer</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
                            <span class="n">Fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">,</span>
                            <span class="n">AdvancedMutationFuzzer</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">AdvancedMutationFuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">,</span>
                            <span class="n">GreyboxFuzzer</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
                            <span class="n">Mutator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">FragmentMutator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">FragmentMutator</span><span class="o">.</span><span class="n">add_to_fragment_pool</span><span class="p">,</span>
                        <span class="p">],</span>
                        <span class="n">types</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;DerivationTree&#39;</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">,</span>
                               <span class="s1">&#39;Location&#39;</span><span class="p">:</span> <span class="n">Location</span><span class="p">},</span>
                        <span class="n">project</span><span class="o">=</span><span class="s1">&#39;fuzzingbook&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (20241206.2353)
 -->
<!-- Pages: 1 -->
<svg width="462pt" height="389pt"
 viewBox="0.00 0.00 461.88 389.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 385)">
<g id="a_graph0"><a xlink:title="LangFuzzer class hierarchy">
<polygon fill="white" stroke="none" points="-4,4 -4,-385 457.88,-385 457.88,4 -4,4"/>
</a>
</g>
<!-- LangFuzzer -->
<g id="node1" class="node">
<title>LangFuzzer</title>
<g id="a_node1"><a xlink:href="#" xlink:title="class LangFuzzer:&#10;Blackbox fuzzer mutating input fragments. Roughly based on `LangFuzz`.">
<polygon fill="none" stroke="black" points="26.25,-57.88 26.25,-104.62 150.25,-104.62 150.25,-57.88 26.25,-57.88"/>
<text text-anchor="start" x="52.62" y="-88.33" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">LangFuzzer</text>
<polyline fill="none" stroke="black" points="26.25,-78.62 150.25,-78.62"/>
<g id="a_node1_0"><a xlink:href="#" xlink:title="LangFuzzer">
<g id="a_node1_1"><a xlink:href="#" xlink:title="create_candidate(self) &#45;&gt; GreyboxFuzzer.Seed:&#10;Returns an input generated by fuzzing a seed in the population">
<text text-anchor="start" x="34.25" y="-66.12" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">create_candidate()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- AdvancedMutationFuzzer -->
<g id="node2" class="node">
<title>AdvancedMutationFuzzer</title>
<g id="a_node2"><a xlink:href="GreyboxFuzzer.ipynb" xlink:title="class AdvancedMutationFuzzer:&#10;Base class for mutation&#45;based fuzzing.">
<polygon fill="none" stroke="black" points="0,-199 0,-258.5 176.5,-258.5 176.5,-199 0,-199"/>
<text text-anchor="start" x="8" y="-242.2" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">AdvancedMutationFuzzer</text>
<polyline fill="none" stroke="black" points="0,-232.5 176.5,-232.5"/>
<g id="a_node2_2"><a xlink:href="#" xlink:title="AdvancedMutationFuzzer">
<g id="a_node2_3"><a xlink:href="GreyboxFuzzer.ipynb" xlink:title="__init__(self, seeds: List[str], mutator: GreyboxFuzzer.Mutator, schedule: GreyboxFuzzer.PowerSchedule) &#45;&gt; None:&#10;Constructor.&#10;`seeds` &#45; a list of (input) strings to mutate.&#10;`mutator` &#45; the mutator to apply.&#10;`schedule` &#45; the power schedule to apply.">
<text text-anchor="start" x="58.25" y="-220" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node2_4"><a xlink:href="GreyboxFuzzer.ipynb" xlink:title="fuzz(self) &#45;&gt; str:&#10;Returns first each seed once and then generates new inputs">
<text text-anchor="start" x="58.25" y="-207.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">fuzz()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- LangFuzzer&#45;&gt;AdvancedMutationFuzzer -->
<g id="edge1" class="edge">
<title>LangFuzzer&#45;&gt;AdvancedMutationFuzzer</title>
<path fill="none" stroke="black" d="M88.25,-104.98C88.25,-126.99 88.25,-160.81 88.25,-187.39"/>
<polygon fill="none" stroke="black" points="84.75,-187.14 88.25,-197.14 91.75,-187.14 84.75,-187.14"/>
</g>
<!-- Fuzzer -->
<g id="node3" class="node">
<title>Fuzzer</title>
<g id="a_node3"><a xlink:href="Fuzzer.ipynb" xlink:title="class Fuzzer:&#10;Base class for fuzzers.">
<polygon fill="none" stroke="black" points="50.25,-295.5 50.25,-380.5 126.25,-380.5 126.25,-295.5 50.25,-295.5"/>
<text text-anchor="start" x="67.62" y="-364.2" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">Fuzzer</text>
<polyline fill="none" stroke="black" points="50.25,-354.5 126.25,-354.5"/>
<g id="a_node3_5"><a xlink:href="#" xlink:title="Fuzzer">
<g id="a_node3_6"><a xlink:href="Fuzzer.ipynb" xlink:title="__init__(self) &#45;&gt; None:&#10;Constructor">
<text text-anchor="start" x="58.25" y="-342" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node3_7"><a xlink:href="Fuzzer.ipynb" xlink:title="fuzz(self) &#45;&gt; str:&#10;Return fuzz input">
<text text-anchor="start" x="58.25" y="-329.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">fuzz()</text>
</a>
</g>
<g id="a_node3_8"><a xlink:href="Fuzzer.ipynb" xlink:title="run(self, runner: Fuzzer.Runner = &lt;Fuzzer.Runner object at 0x1045bb110&gt;) &#45;&gt; Tuple[subprocess.CompletedProcess, str]:&#10;Run `runner` with fuzz input">
<text text-anchor="start" x="58.25" y="-316.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">run()</text>
</a>
</g>
<g id="a_node3_9"><a xlink:href="Fuzzer.ipynb" xlink:title="runs(self, runner: Fuzzer.Runner = &lt;Fuzzer.PrintRunner object at 0x1045bad80&gt;, trials: int = 10) &#45;&gt; List[Tuple[subprocess.CompletedProcess, str]]:&#10;Run `runner` with fuzz input, `trials` times">
<text text-anchor="start" x="58.25" y="-303.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">runs()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- AdvancedMutationFuzzer&#45;&gt;Fuzzer -->
<g id="edge2" class="edge">
<title>AdvancedMutationFuzzer&#45;&gt;Fuzzer</title>
<path fill="none" stroke="black" d="M88.25,-258.77C88.25,-266.54 88.25,-275.18 88.25,-283.81"/>
<polygon fill="none" stroke="black" points="84.75,-283.55 88.25,-293.55 91.75,-283.55 84.75,-283.55"/>
</g>
<!-- FragmentMutator -->
<g id="node4" class="node">
<title>FragmentMutator</title>
<g id="a_node4"><a xlink:href="#" xlink:title="class FragmentMutator:&#10;Mutate inputs with input fragments from a pool">
<polygon fill="none" stroke="black" points="168.25,-0.5 168.25,-162 316.25,-162 316.25,-0.5 168.25,-0.5"/>
<text text-anchor="start" x="186.38" y="-145.7" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">FragmentMutator</text>
<polyline fill="none" stroke="black" points="168.25,-136 316.25,-136"/>
<g id="a_node4_10"><a xlink:href="#" xlink:title="FragmentMutator">
<g id="a_node4_11"><a xlink:href="#" xlink:title="__init__(self, parser):&#10;Initialize mutators">
<text text-anchor="start" x="176.25" y="-123.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node4_12"><a xlink:href="#" xlink:title="add_to_fragment_pool(self, seed: SeedWithStructure) &#45;&gt; None:&#10;Adds all fragments of a seed to the fragment pool">
<text text-anchor="start" x="176.25" y="-110.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">add_to_fragment_pool()</text>
</a>
</g>
<g id="a_node4_13"><a xlink:href="#" xlink:title="add_fragment(self, fragment: DerivationTree) &#45;&gt; None:&#10;Recursively adds fragments to the fragment pool">
<text text-anchor="start" x="176.25" y="-97" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">add_fragment()</text>
</a>
</g>
<g id="a_node4_14"><a xlink:href="#" xlink:title="count_nodes(self, fragment: DerivationTree) &#45;&gt; int:&#10;Returns the number of nodes in the fragment">
<text text-anchor="start" x="176.25" y="-84.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">count_nodes()</text>
</a>
</g>
<g id="a_node4_15"><a xlink:href="#" xlink:title="delete_fragment(self, seed: SeedWithStructure) &#45;&gt; SeedWithStructure:&#10;Delete a random fragment">
<text text-anchor="start" x="176.25" y="-71.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">delete_fragment()</text>
</a>
</g>
<g id="a_node4_16"><a xlink:href="#" xlink:title="is_excluded(self, symbol: str) &#45;&gt; bool:&#10;Returns true if a fragment starting with a specific&#10;symbol and all its decendents can be excluded">
<text text-anchor="start" x="176.25" y="-58.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">is_excluded()</text>
</a>
</g>
<g id="a_node4_17"><a xlink:href="#" xlink:title="mutate(self, seed: SeedWithStructure) &#45;&gt; SeedWithStructure:&#10;Implement structure&#45;aware mutation. Memoize seeds.">
<text text-anchor="start" x="176.25" y="-47" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">mutate()</text>
</a>
</g>
<g id="a_node4_18"><a xlink:href="#" xlink:title="recursive_delete(self, fragment: DerivationTree) &#45;&gt; DerivationTree:&#10;Recursively finds the fragment to delete">
<text text-anchor="start" x="176.25" y="-33.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">recursive_delete()</text>
</a>
</g>
<g id="a_node4_19"><a xlink:href="#" xlink:title="recursive_swap(self, fragment: DerivationTree) &#45;&gt; DerivationTree:&#10;Recursively finds the fragment to swap.">
<text text-anchor="start" x="176.25" y="-20.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">recursive_swap()</text>
</a>
</g>
<g id="a_node4_20"><a xlink:href="#" xlink:title="swap_fragment(self, seed: SeedWithStructure) &#45;&gt; SeedWithStructure:&#10;Substitutes a random fragment with another with the same symbol">
<text text-anchor="start" x="176.25" y="-7.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">swap_fragment()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- Mutator -->
<g id="node5" class="node">
<title>Mutator</title>
<g id="a_node5"><a xlink:href="GreyboxFuzzer.ipynb" xlink:title="class Mutator:&#10;Mutate strings">
<polygon fill="none" stroke="black" points="204.25,-205.38 204.25,-252.12 280.25,-252.12 280.25,-205.38 204.25,-205.38"/>
<text text-anchor="start" x="216.38" y="-235.82" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">Mutator</text>
<polyline fill="none" stroke="black" points="204.25,-226.12 280.25,-226.12"/>
<g id="a_node5_21"><a xlink:href="#" xlink:title="Mutator">
<g id="a_node5_22"><a xlink:href="GreyboxFuzzer.ipynb" xlink:title="__init__(self) &#45;&gt; None:&#10;Constructor">
<text text-anchor="start" x="212.25" y="-213.62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- FragmentMutator&#45;&gt;Mutator -->
<g id="edge3" class="edge">
<title>FragmentMutator&#45;&gt;Mutator</title>
<path fill="none" stroke="black" d="M242.25,-162.24C242.25,-173.29 242.25,-184.11 242.25,-193.68"/>
<polygon fill="none" stroke="black" points="238.75,-193.53 242.25,-203.53 245.75,-193.53 238.75,-193.53"/>
</g>
<!-- Legend -->
<g id="node6" class="node">
<title>Legend</title>
<text text-anchor="start" x="334.62" y="-97.25" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="10.00" fill="#b03a2e">Legend</text>
<text text-anchor="start" x="334.62" y="-87.25" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="340.62" y="-87.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="8.00">public_method()</text>
<text text-anchor="start" x="334.62" y="-77.25" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="340.62" y="-77.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="8.00">private_method()</text>
<text text-anchor="start" x="334.62" y="-67.25" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="340.62" y="-67.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="8.00">overloaded_method()</text>
<text text-anchor="start" x="334.62" y="-58.2" font-family="Helvetica,sans-Serif" font-size="9.00">Hover over names to see doc</text>
</g>
</g>
</svg>
</div></div>
</div>
</section>
<section id="id9">
<h3>Fuzzing with Input Regions<a class="headerlink" href="#id9" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">GreyboxGrammarFuzzer</span></code> class uses two mutators:</p>
<ul class="simple">
<li><p>a <em>tree mutator</em> (a <code class="docutils literal notranslate"><span class="pre">RegionMutator</span></code> object) that can parse existing strings to identify <em>regions</em> in that string to be swapped or deleted.</p></li>
<li><p>a <em>byte mutator</em> to apply bit- and character-level mutations.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tree_mutator</span> <span class="o">=</span> <span class="n">RegionMutator</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
<span class="n">byte_mutator</span> <span class="o">=</span> <span class="n">Mutator</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The <em>schedule</em> for the <code class="docutils literal notranslate"><span class="pre">GreyboxGrammarFuzzer</span></code> class can be a regular <code class="docutils literal notranslate"><span class="pre">PowerSchedule</span></code> object. However, a more sophisticated schedule is provided by <code class="docutils literal notranslate"><span class="pre">AFLSmartSchedule</span></code>, which assigns more <a class="reference internal" href="GreyboxFuzzer.html#Power-Schedules"><span class="std std-ref">energy</span></a> to seeds that have a higher degree of validity.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">schedule</span> <span class="o">=</span> <span class="n">AFLSmartSchedule</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">GreyboxGrammarFuzzer</span></code> constructor takes a set of seeds as well as the two mutators and the schedule:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">aflsmart_fuzzer</span> <span class="o">=</span> <span class="n">GreyboxGrammarFuzzer</span><span class="p">(</span><span class="n">seeds</span><span class="p">,</span> <span class="n">byte_mutator</span><span class="p">,</span> <span class="n">tree_mutator</span><span class="p">,</span> <span class="n">schedule</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>As it relies on code coverage, it is typically combined with a <code class="docutils literal notranslate"><span class="pre">FunctionCoverageRunner</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">runner</span> <span class="o">=</span> <span class="n">FunctionCoverageRunner</span><span class="p">(</span><span class="n">my_parser</span><span class="p">)</span>
<span class="n">aflsmart_outcome</span> <span class="o">=</span> <span class="n">aflsmart_fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">(</span><span class="n">runner</span><span class="p">,</span> <span class="n">trials</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="n">display_class_hierarchy</span><span class="p">([</span><span class="n">GreyboxGrammarFuzzer</span><span class="p">,</span> <span class="n">AFLSmartSchedule</span><span class="p">,</span> <span class="n">RegionMutator</span><span class="p">],</span>
                        <span class="n">public_methods</span><span class="o">=</span><span class="p">[</span>
                            <span class="n">Fuzzer</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">Fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">,</span>
                            <span class="n">Fuzzer</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
                            <span class="n">Fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">,</span>
                            <span class="n">AdvancedMutationFuzzer</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">AdvancedMutationFuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">,</span>
                            <span class="n">GreyboxFuzzer</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
                            <span class="n">GreyboxGrammarFuzzer</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">GreyboxGrammarFuzzer</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
                            <span class="n">AFLSmartSchedule</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">PowerSchedule</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">Mutator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">FragmentMutator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">FragmentMutator</span><span class="o">.</span><span class="n">add_to_fragment_pool</span><span class="p">,</span>
                            <span class="n">RegionMutator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                        <span class="p">],</span>
                        <span class="n">types</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;DerivationTree&#39;</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">,</span>
                               <span class="s1">&#39;Location&#39;</span><span class="p">:</span> <span class="n">Location</span><span class="p">},</span>
                        <span class="n">project</span><span class="o">=</span><span class="s1">&#39;fuzzingbook&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (20241206.2353)
 -->
<!-- Pages: 1 -->
<svg width="638pt" height="511pt"
 viewBox="0.00 0.00 637.88 511.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 507)">
<g id="a_graph0"><a xlink:title="GreyboxGrammarFuzzer class hierarchy">
<polygon fill="white" stroke="none" points="-4,4 -4,-507 633.88,-507 633.88,4 -4,4"/>
</a>
</g>
<!-- GreyboxGrammarFuzzer -->
<g id="node1" class="node">
<title>GreyboxGrammarFuzzer</title>
<g id="a_node1"><a xlink:href="#" xlink:title="class GreyboxGrammarFuzzer:&#10;Greybox fuzzer using grammars.">
<polygon fill="none" stroke="black" points="4.5,-13.25 4.5,-72.75 172,-72.75 172,-13.25 4.5,-13.25"/>
<text text-anchor="start" x="12.5" y="-56.45" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">GreyboxGrammarFuzzer</text>
<polyline fill="none" stroke="black" points="4.5,-46.75 172,-46.75"/>
<g id="a_node1_0"><a xlink:href="#" xlink:title="GreyboxGrammarFuzzer">
<g id="a_node1_1"><a xlink:href="#" xlink:title="__init__(self, seeds: List[str], byte_mutator: GreyboxFuzzer.Mutator, tree_mutator: FragmentMutator, schedule: GreyboxFuzzer.PowerSchedule) &#45;&gt; None:&#10;Constructor.&#10;`seeds` &#45; set of inputs to mutate.&#10;`byte_mutator` &#45; a byte&#45;level mutator.&#10;`tree_mutator` = a tree&#45;level mutator.&#10;`schedule` &#45; a power schedule.">
<text text-anchor="start" x="34.25" y="-34.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node1_2"><a xlink:href="#" xlink:title="create_candidate(self) &#45;&gt; str:&#10;Returns an input generated by structural mutation&#10;of a seed in the population">
<text text-anchor="start" x="34.25" y="-21.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">create_candidate()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- GreyboxFuzzer -->
<g id="node2" class="node">
<title>GreyboxFuzzer</title>
<g id="a_node2"><a xlink:href="GreyboxFuzzer.ipynb" xlink:title="class GreyboxFuzzer:&#10;Coverage&#45;guided mutational fuzzing.">
<polygon fill="none" stroke="black" points="33.75,-179.88 33.75,-226.62 142.75,-226.62 142.75,-179.88 33.75,-179.88"/>
<text text-anchor="start" x="41.75" y="-210.32" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">GreyboxFuzzer</text>
<polyline fill="none" stroke="black" points="33.75,-200.62 142.75,-200.62"/>
<g id="a_node2_3"><a xlink:href="#" xlink:title="GreyboxFuzzer">
<g id="a_node2_4"><a xlink:href="GreyboxFuzzer.ipynb" xlink:title="run(self, runner: MutationFuzzer.FunctionCoverageRunner) &#45;&gt; Tuple[Any, str]:&#10;Run function(inp) while tracking coverage.&#10;If we reach new coverage,&#10;add inp to population and its coverage to population_coverage">
<text text-anchor="start" x="73.25" y="-188.12" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">run()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- GreyboxGrammarFuzzer&#45;&gt;GreyboxFuzzer -->
<g id="edge1" class="edge">
<title>GreyboxGrammarFuzzer&#45;&gt;GreyboxFuzzer</title>
<path fill="none" stroke="black" d="M88.25,-73.03C88.25,-99.88 88.25,-139.82 88.25,-168.18"/>
<polygon fill="none" stroke="black" points="84.75,-168.04 88.25,-178.04 91.75,-168.04 84.75,-168.04"/>
</g>
<!-- AdvancedMutationFuzzer -->
<g id="node3" class="node">
<title>AdvancedMutationFuzzer</title>
<g id="a_node3"><a xlink:href="GreyboxFuzzer.ipynb" xlink:title="class AdvancedMutationFuzzer:&#10;Base class for mutation&#45;based fuzzing.">
<polygon fill="none" stroke="black" points="0,-321 0,-380.5 176.5,-380.5 176.5,-321 0,-321"/>
<text text-anchor="start" x="8" y="-364.2" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">AdvancedMutationFuzzer</text>
<polyline fill="none" stroke="black" points="0,-354.5 176.5,-354.5"/>
<g id="a_node3_5"><a xlink:href="#" xlink:title="AdvancedMutationFuzzer">
<g id="a_node3_6"><a xlink:href="GreyboxFuzzer.ipynb" xlink:title="__init__(self, seeds: List[str], mutator: GreyboxFuzzer.Mutator, schedule: GreyboxFuzzer.PowerSchedule) &#45;&gt; None:&#10;Constructor.&#10;`seeds` &#45; a list of (input) strings to mutate.&#10;`mutator` &#45; the mutator to apply.&#10;`schedule` &#45; the power schedule to apply.">
<text text-anchor="start" x="58.25" y="-342" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node3_7"><a xlink:href="GreyboxFuzzer.ipynb" xlink:title="fuzz(self) &#45;&gt; str:&#10;Returns first each seed once and then generates new inputs">
<text text-anchor="start" x="58.25" y="-329.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">fuzz()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- GreyboxFuzzer&#45;&gt;AdvancedMutationFuzzer -->
<g id="edge2" class="edge">
<title>GreyboxFuzzer&#45;&gt;AdvancedMutationFuzzer</title>
<path fill="none" stroke="black" d="M88.25,-226.98C88.25,-248.99 88.25,-282.81 88.25,-309.39"/>
<polygon fill="none" stroke="black" points="84.75,-309.14 88.25,-319.14 91.75,-309.14 84.75,-309.14"/>
</g>
<!-- Fuzzer -->
<g id="node4" class="node">
<title>Fuzzer</title>
<g id="a_node4"><a xlink:href="Fuzzer.ipynb" xlink:title="class Fuzzer:&#10;Base class for fuzzers.">
<polygon fill="none" stroke="black" points="50.25,-417.5 50.25,-502.5 126.25,-502.5 126.25,-417.5 50.25,-417.5"/>
<text text-anchor="start" x="67.62" y="-486.2" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">Fuzzer</text>
<polyline fill="none" stroke="black" points="50.25,-476.5 126.25,-476.5"/>
<g id="a_node4_8"><a xlink:href="#" xlink:title="Fuzzer">
<g id="a_node4_9"><a xlink:href="Fuzzer.ipynb" xlink:title="__init__(self) &#45;&gt; None:&#10;Constructor">
<text text-anchor="start" x="58.25" y="-464" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node4_10"><a xlink:href="Fuzzer.ipynb" xlink:title="fuzz(self) &#45;&gt; str:&#10;Return fuzz input">
<text text-anchor="start" x="58.25" y="-451.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">fuzz()</text>
</a>
</g>
<g id="a_node4_11"><a xlink:href="Fuzzer.ipynb" xlink:title="run(self, runner: Fuzzer.Runner = &lt;Fuzzer.Runner object at 0x1045bb110&gt;) &#45;&gt; Tuple[subprocess.CompletedProcess, str]:&#10;Run `runner` with fuzz input">
<text text-anchor="start" x="58.25" y="-438.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">run()</text>
</a>
</g>
<g id="a_node4_12"><a xlink:href="Fuzzer.ipynb" xlink:title="runs(self, runner: Fuzzer.Runner = &lt;Fuzzer.PrintRunner object at 0x1045bad80&gt;, trials: int = 10) &#45;&gt; List[Tuple[subprocess.CompletedProcess, str]]:&#10;Run `runner` with fuzz input, `trials` times">
<text text-anchor="start" x="58.25" y="-425.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">runs()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- AdvancedMutationFuzzer&#45;&gt;Fuzzer -->
<g id="edge3" class="edge">
<title>AdvancedMutationFuzzer&#45;&gt;Fuzzer</title>
<path fill="none" stroke="black" d="M88.25,-380.77C88.25,-388.54 88.25,-397.18 88.25,-405.81"/>
<polygon fill="none" stroke="black" points="84.75,-405.55 88.25,-415.55 91.75,-405.55 84.75,-405.55"/>
</g>
<!-- AFLSmartSchedule -->
<g id="node5" class="node">
<title>AFLSmartSchedule</title>
<g id="a_node5"><a xlink:href="#" xlink:title="class AFLSmartSchedule:&#10;Define how fuzzing time should be distributed across the population.">
<polygon fill="none" stroke="black" points="190.25,-0.5 190.25,-85.5 326.25,-85.5 326.25,-0.5 190.25,-0.5"/>
<text text-anchor="start" x="200.5" y="-69.2" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">AFLSmartSchedule</text>
<polyline fill="none" stroke="black" points="190.25,-59.5 326.25,-59.5"/>
<g id="a_node5_13"><a xlink:href="#" xlink:title="AFLSmartSchedule">
<g id="a_node5_14"><a xlink:href="#" xlink:title="__init__(self, parser: Parser.EarleyParser, exponent: float = 1.0):&#10;Constructor">
<text text-anchor="start" x="198.25" y="-47" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node5_15"><a xlink:href="#" xlink:title="assignEnergy(self, population: Sequence[GreyboxFuzzer.Seed]):&#10;Assign exponential energy proportional to degree of validity">
<text text-anchor="start" x="198.25" y="-34.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">assignEnergy()</text>
</a>
</g>
<g id="a_node5_16"><a xlink:href="#" xlink:title="degree_of_validity(self, seed: GreyboxFuzzer.Seed) &#45;&gt; float:&#10;Returns the proportion of a seed that is parsable">
<text text-anchor="start" x="198.25" y="-20.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">degree_of_validity()</text>
</a>
</g>
<g id="a_node5_17"><a xlink:href="#" xlink:title="parsable(self, seed: GreyboxFuzzer.Seed) &#45;&gt; str:&#10;Returns the substring that is parsable">
<text text-anchor="start" x="198.25" y="-7.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">parsable()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- PowerSchedule -->
<g id="node6" class="node">
<title>PowerSchedule</title>
<g id="a_node6"><a xlink:href="GreyboxFuzzer.ipynb" xlink:title="class PowerSchedule:&#10;Define how fuzzing time should be distributed across the population.">
<polygon fill="none" stroke="black" points="203.38,-179.88 203.38,-226.62 313.12,-226.62 313.12,-179.88 203.38,-179.88"/>
<text text-anchor="start" x="211.38" y="-210.32" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">PowerSchedule</text>
<polyline fill="none" stroke="black" points="203.38,-200.62 313.12,-200.62"/>
<g id="a_node6_18"><a xlink:href="#" xlink:title="PowerSchedule">
<g id="a_node6_19"><a xlink:href="GreyboxFuzzer.ipynb" xlink:title="__init__(self) &#45;&gt; None:&#10;Constructor">
<text text-anchor="start" x="228.25" y="-188.12" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- AFLSmartSchedule&#45;&gt;PowerSchedule -->
<g id="edge4" class="edge">
<title>AFLSmartSchedule&#45;&gt;PowerSchedule</title>
<path fill="none" stroke="black" d="M258.25,-85.99C258.25,-111.69 258.25,-144.13 258.25,-168.22"/>
<polygon fill="none" stroke="black" points="254.75,-168.12 258.25,-178.12 261.75,-168.12 254.75,-168.12"/>
</g>
<!-- RegionMutator -->
<g id="node7" class="node">
<title>RegionMutator</title>
<g id="a_node7"><a xlink:href="#" xlink:title="class RegionMutator:&#10;Mutate inputs with input fragments from a pool">
<polygon fill="none" stroke="black" points="344.25,-6.88 344.25,-79.12 492.25,-79.12 492.25,-6.88 344.25,-6.88"/>
<text text-anchor="start" x="371" y="-62.83" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">RegionMutator</text>
<polyline fill="none" stroke="black" points="344.25,-53.12 492.25,-53.12"/>
<g id="a_node7_20"><a xlink:href="#" xlink:title="RegionMutator">
<g id="a_node7_21"><a xlink:href="#" xlink:title="add_to_fragment_pool(self, seed: SeedWithRegions) &#45;&gt; None:&#10;Mark fragments and regions in a seed file">
<text text-anchor="start" x="352.25" y="-40.62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">add_to_fragment_pool()</text>
</a>
</g>
<g id="a_node7_22"><a xlink:href="#" xlink:title="delete_fragment(self, seed: SeedWithRegions) &#45;&gt; SeedWithRegions:&#10;Deletes a random region">
<text text-anchor="start" x="352.25" y="-27.88" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">delete_fragment()</text>
</a>
</g>
<g id="a_node7_23"><a xlink:href="#" xlink:title="swap_fragment(self, seed: SeedWithRegions) &#45;&gt; SeedWithRegions:&#10;Chooses a random region and swaps it with a fragment&#10;that starts with the same symbol">
<text text-anchor="start" x="352.25" y="-15.12" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">swap_fragment()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- FragmentMutator -->
<g id="node8" class="node">
<title>FragmentMutator</title>
<g id="a_node8"><a xlink:href="#" xlink:title="class FragmentMutator:&#10;Mutate inputs with input fragments from a pool">
<polygon fill="none" stroke="black" points="344.25,-122.5 344.25,-284 492.25,-284 492.25,-122.5 344.25,-122.5"/>
<text text-anchor="start" x="362.38" y="-267.7" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">FragmentMutator</text>
<polyline fill="none" stroke="black" points="344.25,-258 492.25,-258"/>
<g id="a_node8_24"><a xlink:href="#" xlink:title="FragmentMutator">
<g id="a_node8_25"><a xlink:href="#" xlink:title="__init__(self, parser):&#10;Initialize mutators">
<text text-anchor="start" x="352.25" y="-245.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node8_26"><a xlink:href="#" xlink:title="add_to_fragment_pool(self, seed: SeedWithStructure) &#45;&gt; None:&#10;Adds all fragments of a seed to the fragment pool">
<text text-anchor="start" x="352.25" y="-232.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">add_to_fragment_pool()</text>
</a>
</g>
<g id="a_node8_27"><a xlink:href="#" xlink:title="add_fragment(self, fragment: DerivationTree) &#45;&gt; None:&#10;Recursively adds fragments to the fragment pool">
<text text-anchor="start" x="352.25" y="-219" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">add_fragment()</text>
</a>
</g>
<g id="a_node8_28"><a xlink:href="#" xlink:title="count_nodes(self, fragment: DerivationTree) &#45;&gt; int:&#10;Returns the number of nodes in the fragment">
<text text-anchor="start" x="352.25" y="-206.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">count_nodes()</text>
</a>
</g>
<g id="a_node8_29"><a xlink:href="#" xlink:title="delete_fragment(self, seed: SeedWithStructure) &#45;&gt; SeedWithStructure:&#10;Delete a random fragment">
<text text-anchor="start" x="352.25" y="-194.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">delete_fragment()</text>
</a>
</g>
<g id="a_node8_30"><a xlink:href="#" xlink:title="is_excluded(self, symbol: str) &#45;&gt; bool:&#10;Returns true if a fragment starting with a specific&#10;symbol and all its decendents can be excluded">
<text text-anchor="start" x="352.25" y="-180.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">is_excluded()</text>
</a>
</g>
<g id="a_node8_31"><a xlink:href="#" xlink:title="mutate(self, seed: SeedWithStructure) &#45;&gt; SeedWithStructure:&#10;Implement structure&#45;aware mutation. Memoize seeds.">
<text text-anchor="start" x="352.25" y="-169" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">mutate()</text>
</a>
</g>
<g id="a_node8_32"><a xlink:href="#" xlink:title="recursive_delete(self, fragment: DerivationTree) &#45;&gt; DerivationTree:&#10;Recursively finds the fragment to delete">
<text text-anchor="start" x="352.25" y="-155.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">recursive_delete()</text>
</a>
</g>
<g id="a_node8_33"><a xlink:href="#" xlink:title="recursive_swap(self, fragment: DerivationTree) &#45;&gt; DerivationTree:&#10;Recursively finds the fragment to swap.">
<text text-anchor="start" x="352.25" y="-142.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">recursive_swap()</text>
</a>
</g>
<g id="a_node8_34"><a xlink:href="#" xlink:title="swap_fragment(self, seed: SeedWithStructure) &#45;&gt; SeedWithStructure:&#10;Substitutes a random fragment with another with the same symbol">
<text text-anchor="start" x="352.25" y="-130.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">swap_fragment()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- RegionMutator&#45;&gt;FragmentMutator -->
<g id="edge5" class="edge">
<title>RegionMutator&#45;&gt;FragmentMutator</title>
<path fill="none" stroke="black" d="M418.25,-79.51C418.25,-89.08 418.25,-99.89 418.25,-111.02"/>
<polygon fill="none" stroke="black" points="414.75,-110.72 418.25,-120.72 421.75,-110.72 414.75,-110.72"/>
</g>
<!-- Mutator -->
<g id="node9" class="node">
<title>Mutator</title>
<g id="a_node9"><a xlink:href="GreyboxFuzzer.ipynb" xlink:title="class Mutator:&#10;Mutate strings">
<polygon fill="none" stroke="black" points="380.25,-327.38 380.25,-374.12 456.25,-374.12 456.25,-327.38 380.25,-327.38"/>
<text text-anchor="start" x="392.38" y="-357.82" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">Mutator</text>
<polyline fill="none" stroke="black" points="380.25,-348.12 456.25,-348.12"/>
<g id="a_node9_35"><a xlink:href="#" xlink:title="Mutator">
<g id="a_node9_36"><a xlink:href="GreyboxFuzzer.ipynb" xlink:title="__init__(self) &#45;&gt; None:&#10;Constructor">
<text text-anchor="start" x="388.25" y="-335.62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- FragmentMutator&#45;&gt;Mutator -->
<g id="edge6" class="edge">
<title>FragmentMutator&#45;&gt;Mutator</title>
<path fill="none" stroke="black" d="M418.25,-284.24C418.25,-295.29 418.25,-306.11 418.25,-315.68"/>
<polygon fill="none" stroke="black" points="414.75,-315.53 418.25,-325.53 421.75,-315.53 414.75,-315.53"/>
</g>
<!-- Legend -->
<g id="node10" class="node">
<title>Legend</title>
<text text-anchor="start" x="510.62" y="-59" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="10.00" fill="#b03a2e">Legend</text>
<text text-anchor="start" x="510.62" y="-49" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="516.62" y="-49" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="8.00">public_method()</text>
<text text-anchor="start" x="510.62" y="-39" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="516.62" y="-39" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="8.00">private_method()</text>
<text text-anchor="start" x="510.62" y="-29" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="516.62" y="-29" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="8.00">overloaded_method()</text>
<text text-anchor="start" x="510.62" y="-19.95" font-family="Helvetica,sans-Serif" font-size="9.00">Hover over names to see doc</text>
</g>
</g>
</svg>
</div></div>
</div>
</section>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">#</a></h2>
<p>This chapter closes our discussion of syntactic fuzzing techniques.</p>
<ul class="simple">
<li><p>In the <a class="reference internal" href="Reducer.html"><span class="std std-doc">next chapter</span></a>, we discuss how to <em>reduce failure-inducing inputs</em> after a failure, keeping only those portions of the input that are necessary for reproducing the failure.</p></li>
<li><p>The <a class="reference internal" href="04_Semantical_Fuzzing.html"><span class="std std-doc">next part</span></a> will go from syntactical to <em>semantical</em> fuzzing, considering code semantics for targeted test generation.</p></li>
</ul>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<section id="exercise-1-the-big-greybox-fuzzer-shoot-out">
<h3>Exercise 1: The Big Greybox Fuzzer Shoot-Out<a class="headerlink" href="#exercise-1-the-big-greybox-fuzzer-shoot-out" title="Link to this heading">#</a></h3>
<p>Use our implementations of greybox techniques and evaluate them on a benchmark.  Which technique (and which sub-technique) has which impact and why?  Also take into account the specific approaches of Superion \cite{Wang2019superion} and Nautilus \cite{Aschermann2019nautilus}, possibly even on the benchmarks used by these approaches.</p>
<p><strong>Solution.</strong>  To be added.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="GeneratorGrammarFuzzer.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Fuzzing with Generators</p>
      </div>
    </a>
    <a class="right-next"
       href="Reducer.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Reducing Failure-Inducing Inputs</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fuzzing-with-dictionaries">Fuzzing with Dictionaries</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fuzzing-with-input-fragments">Fuzzing with Input Fragments</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fuzzing-with-input-regions">Fuzzing with Input Regions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Fuzzing with Dictionaries</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Fuzzing with Input Fragments</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parsing-and-recombining-javascript-or-how-to-make-50-000-usd-in-four-weeks">Parsing and Recombining JavaScript, or How to Make 50,000 USD in Four Weeks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parsing-and-recombining-html">Parsing and Recombining HTML</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#building-the-fragment-pool">Building the Fragment Pool</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fragment-based-mutation">Fragment-Based Mutation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fragment-based-fuzzing">Fragment-Based Fuzzing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#integration-with-greybox-fuzzing">Integration with Greybox Fuzzing</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Fuzzing with Input Regions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#determining-symbol-regions">Determining Symbol Regions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#region-based-mutation">Region-Based Mutation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Integration with Greybox Fuzzing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#focusing-on-valid-seeds">Focusing on Valid Seeds</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mining-seeds">Mining Seeds</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Synopsis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Fuzzing with Dictionaries</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">Fuzzing with Input Fragments</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">Fuzzing with Input Regions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-the-big-greybox-fuzzer-shoot-out">Exercise 1: The Big Greybox Fuzzer Shoot-Out</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Andreas Zeller, Rahul Gopinath, Marcel Böhme, Gordon Fraser, and Christian Holler
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2021-2025 CISPA Helmholtz Center for Information Security (www.cispa.de); © Copyright 2018-2020 Saarland University, authors, and contributors. All Rights Reserved.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>