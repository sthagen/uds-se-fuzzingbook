
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Fuzzing with Grammars &#8212; The Fuzzing Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=42e1b1a5" />
    <link rel="stylesheet" type="text/css" href="_static/mastodon-timeline.css?v=f82c2b23" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Grammars';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Efficient Grammar Fuzzing" href="GrammarFuzzer.html" />
    <link rel="prev" title="Mutation Analysis" href="MutationAnalysis.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content"><p>This is a beta version of fuzzingbook.org, currently in development. See the <a href="https://fuzzingbook.org/"  style="color:white!important;">classic site</a> for resources.</p></div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/fuzzingbook.png" class="logo__image only-light" alt="The Fuzzing Book - Home"/>
    <script>document.write(`<img src="_static/fuzzingbook.png" class="logo__image only-dark" alt="The Fuzzing Book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    The Fuzzing Book
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tours.html">Tours through the Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="Intro_Testing.html">Introduction to Software Testing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Lexical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Fuzzer.html">Fuzzing: Breaking Things with Random Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Coverage.html">Code Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="MutationFuzzer.html">Mutation-Based Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GreyboxFuzzer.html">Greybox Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="SearchBasedFuzzer.html">Search-Based Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="MutationAnalysis.html">Mutation Analysis</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Syntactical Fuzzing</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Fuzzing with Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarFuzzer.html">Efficient Grammar Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarCoverageFuzzer.html">Grammar Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="Parser.html">Parsing Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ProbabilisticGrammarFuzzer.html">Probabilistic Grammar Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GeneratorGrammarFuzzer.html">Fuzzing with Generators</a></li>

<li class="toctree-l1"><a class="reference internal" href="GreyboxGrammarFuzzer.html">Greybox Fuzzing with Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="Reducer.html">Reducing Failure-Inducing Inputs</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Semantical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="FuzzingWithConstraints.html">Fuzzing with Constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarMiner.html">Mining Input Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="InformationFlow.html">Tracking Information Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="ConcolicFuzzer.html">Concolic Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="SymbolicFuzzer.html">Symbolic Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="DynamicInvariants.html">Mining Function Specifications</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Domain-Specific Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ConfigurationFuzzer.html">Testing Configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="APIFuzzer.html">Fuzzing APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Carver.html">Carving Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="PythonFuzzer.html">Testing Compilers</a></li>
<li class="toctree-l1"><a class="reference internal" href="WebFuzzer.html">Testing Web Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="GUIFuzzer.html">Testing Graphical User Interfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Managing Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="FuzzingInTheLarge.html">Fuzzing in the Large</a></li>
<li class="toctree-l1"><a class="reference internal" href="WhenToStopFuzzing.html">When To Stop Fuzzing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="AcademicPrototyping.html">Academic Prototyping</a></li>
<li class="toctree-l1"><a class="reference internal" href="PrototypingWithPython.html">Prototyping with Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="ExpectError.html">Error Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timer.html">Timer</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timeout.html">Timeout</a></li>
<li class="toctree-l1"><a class="reference internal" href="ClassDiagram.html">Class Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="RailroadDiagrams.html">Railroad Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="ControlFlow.html">Control Flow Graph</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About This Book</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ReleaseNotes.html">Fuzzingbook Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="Importing.html">Using Fuzzingbook Code in your own Programs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Guide_for_Authors.html">Guide for Authors</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/master?urlpath=tree/docs/notebooks/Grammars.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/uds-se/fuzzingbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/uds-se/fuzzingbook/issues/new?title=Issue%20on%20page%20%2FGrammars.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/Grammars.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Fuzzing with Grammars</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#input-languages">Input Languages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#grammars">Grammars</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rules-and-expansions">Rules and Expansions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#arithmetic-expressions">Arithmetic Expressions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#representing-grammars-in-python">Representing Grammars in Python</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-a-grammar-type">Excursion: A <code class="docutils literal notranslate"><span class="pre">Grammar</span></code> Type</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#end-of-excursion">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#some-definitions">Some Definitions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-simple-grammar-fuzzer">A Simple Grammar Fuzzer</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-grammars-as-railroad-diagrams">Visualizing Grammars as Railroad Diagrams</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-syntax-diagram">Excursion: Implementing <code class="docutils literal notranslate"><span class="pre">syntax_diagram()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#some-grammars">Some Grammars</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-cgi-grammar">A CGI Grammar</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-url-grammar">A URL Grammar</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-natural-language-grammar">A Natural Language Grammar</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#grammars-as-mutation-seeds">Grammars as Mutation Seeds</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-grammar-toolbox">A Grammar Toolbox</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#escapes">Escapes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extending-grammars">Extending Grammars</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#character-classes">Character Classes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#grammar-shortcuts">Grammar Shortcuts</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-convert-ebnf-grammar">Excursion: Implementing <code class="docutils literal notranslate"><span class="pre">convert_ebnf_grammar()</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-new-symbols">Creating New Symbols</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#expanding-parenthesized-expressions">Expanding Parenthesized Expressions</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#expanding-operators">Expanding Operators</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#all-together">All Together</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#grammar-extensions">Grammar Extensions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-opts">Excursion: Implementing <code class="docutils literal notranslate"><span class="pre">opts()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">End of Excursion</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-grammars">Checking Grammars</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-is-valid-grammar">Excursion: Implementing <code class="docutils literal notranslate"><span class="pre">is_valid_grammar()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-a-json-grammar">Exercise 1: A JSON Grammar</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-finding-bugs">Exercise 2: Finding Bugs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-grammars-with-regular-expressions">Exercise 3: Grammars with Regular Expressions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-convert-regular-expressions">Part 1: Convert regular expressions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-identify-and-expand-regular-expressions">Part 2: Identify and expand regular expressions</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-4-defining-grammars-as-functions-advanced">Exercise 4: Defining Grammars as Functions (Advanced)</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-a-one-single-function">Part 1 (a): One Single Function</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-b-alternative-representations">Part 1 (b): Alternative representations</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-extended-grammars">Part 2: Extended Grammars</a></li>
</ul>
</li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="fuzzing-with-grammars">
<h1>Fuzzing with Grammars<a class="headerlink" href="#fuzzing-with-grammars" title="Link to this heading">#</a></h1>
<p>In the chapter on <a class="reference internal" href="MutationFuzzer.html"><span class="std std-doc">“Mutation-Based Fuzzing”</span></a>, we have seen how to use extra hints – such as sample input files – to speed up test generation.  In this chapter, we take this idea one step further, by providing a <em>specification</em> of the legal inputs to a program.  Specifying inputs via a <em>grammar</em> allows for very systematic and efficient test generation, in particular for complex input formats.  Grammars also serve as the base for configuration fuzzing, API fuzzing, GUI fuzzing, and many more.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bookutils</span> <span class="kn">import</span> <span class="n">YouTubeVideo</span>
<span class="n">YouTubeVideo</span><span class="p">(</span><span class="s1">&#39;Jc8Whz0W41o&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="640"
            height="360"
            src="https://www.youtube-nocookie.com/embed/Jc8Whz0W41o"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<p><strong>Prerequisites</strong></p>
<ul class="simple">
<li><p>You should know how basic fuzzing works, e.g. from the <a class="reference internal" href="Fuzzer.html"><span class="std std-doc">Chapter introducing fuzzing</span></a>.</p></li>
<li><p>Knowledge on <a class="reference internal" href="MutationFuzzer.html"><span class="std std-doc">mutation-based fuzzing</span></a> and <a class="reference internal" href="Coverage.html"><span class="std std-doc">coverage</span></a> is <em>not</em> required yet, but still recommended.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bookutils.setup</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">Fuzzer</span>
</pre></div>
</div>
</div>
</div>
<section id="synopsis">
<h2>Synopsis<a class="headerlink" href="#synopsis" title="Link to this heading">#</a></h2>
<!-- Automatically generated. Do not edit. -->
<p>To <a class="reference internal" href="Importing.html"><span class="std std-doc">use the code provided in this chapter</span></a>, write</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fuzzingbook.Grammars</span> <span class="kn">import</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>and then make use of the following features.</p>
<p>This chapter introduces <em>grammars</em> as a simple means to specify input languages, and to use them for testing programs with syntactically valid inputs.  A grammar is defined as a mapping of nonterminal symbols to lists of alternative expansions, as in the following example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">US_PHONE_GRAMMAR</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;phone-number&gt;&quot;</span><span class="p">],</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="s2">&quot;&lt;phone-number&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;(&lt;area&gt;)&lt;exchange&gt;-&lt;line&gt;&quot;</span><span class="p">],</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="s2">&quot;&lt;area&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;lead-digit&gt;&lt;digit&gt;&lt;digit&gt;&quot;</span><span class="p">],</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="s2">&quot;&lt;exchange&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;lead-digit&gt;&lt;digit&gt;&lt;digit&gt;&quot;</span><span class="p">],</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="s2">&quot;&lt;line&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;digit&gt;&lt;digit&gt;&lt;digit&gt;&lt;digit&gt;&quot;</span><span class="p">],</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="s2">&quot;&lt;lead-digit&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="s2">&quot;6&quot;</span><span class="p">,</span> <span class="s2">&quot;7&quot;</span><span class="p">,</span> <span class="s2">&quot;8&quot;</span><span class="p">,</span> <span class="s2">&quot;9&quot;</span><span class="p">],</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="s2">&quot;6&quot;</span><span class="p">,</span> <span class="s2">&quot;7&quot;</span><span class="p">,</span> <span class="s2">&quot;8&quot;</span><span class="p">,</span> <span class="s2">&quot;9&quot;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">US_PHONE_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
<p>Nonterminal symbols are enclosed in angle brackets (say, <code class="docutils literal notranslate"><span class="pre">&lt;digit&gt;</span></code>).  To generate an input string from a grammar, a <em>producer</em> starts with the start symbol (<code class="docutils literal notranslate"><span class="pre">&lt;start&gt;</span></code>) and randomly chooses a random expansion for this symbol.  It continues the process until all nonterminal symbols are expanded.  The function <code class="docutils literal notranslate"><span class="pre">simple_grammar_fuzzer()</span></code> does just that:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">simple_grammar_fuzzer</span><span class="p">(</span><span class="n">US_PHONE_GRAMMAR</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
<span class="go">[&#39;(692)449-5179&#39;,</span>
<span class="go"> &#39;(519)230-7422&#39;,</span>
<span class="go"> &#39;(613)761-0853&#39;,</span>
<span class="go"> &#39;(979)881-3858&#39;,</span>
<span class="go"> &#39;(810)914-5475&#39;]</span>
</pre></div>
</div>
<p>In practice, though, instead of <code class="docutils literal notranslate"><span class="pre">simple_grammar_fuzzer()</span></code>, you should use <a class="reference internal" href="GrammarFuzzer.html"><span class="std std-doc">the <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code> class</span></a> or one of its <a class="reference internal" href="GrammarCoverageFuzzer.html"><span class="std std-doc">coverage-based</span></a>, <a class="reference internal" href="ProbabilisticGrammarFuzzer.html"><span class="std std-doc">probabilistic-based</span></a>, or <a class="reference internal" href="GeneratorGrammarFuzzer.html"><span class="std std-doc">generator-based</span></a> derivatives; these are more efficient, protect against infinite growth, and provide several additional features.</p>
<p>This chapter also introduces a <a class="reference internal" href="#A-Grammar-Toolbox"><span class="xref myst">grammar toolbox</span></a> with several helper functions that ease the writing of grammars, such as using shortcut notations for character classes and repetitions, or extending grammars</p>
</section>
<section id="input-languages">
<h2>Input Languages<a class="headerlink" href="#input-languages" title="Link to this heading">#</a></h2>
<p>All possible behaviors of a program can be triggered by its input.  “Input” here can be a wide range of possible sources: We are talking about data that is read from files, from the environment, or over the network, data input by the user, or data acquired from interaction with other resources.  The set of all these inputs determines how the program will behave – including its failures.  When testing, it is thus very helpful to think about possible input sources, how to get them under control, and <em>how to systematically test them</em>.</p>
<p>For the sake of simplicity, we will assume for now that the program has only one source of inputs; this is the same assumption we have been using in the previous chapters, too.  The set of valid inputs to a program is called a <em>language</em>.  Languages range from the simple to the complex: the CSV language denotes the set of valid comma-separated inputs, whereas the Python language denotes the set of valid Python programs.  We commonly separate data languages and programming languages, although any program can also be treated as input data (say, to a compiler).  The <a class="reference external" href="https://en.wikipedia.org/wiki/List_of_file_formats">Wikipedia page on file formats</a> lists more than 1,000 different file formats, each of which is its own language.</p>
<p>To formally describe languages, the field of <em>formal languages</em> has devised a number of <em>language specifications</em> that describe a language.  <em>Regular expressions</em> represent the simplest class of these languages to denote sets of strings: The regular expression <code class="docutils literal notranslate"><span class="pre">[a-z]*</span></code>, for instance, denotes a (possibly empty) sequence of lowercase letters.  <em>Automata theory</em> connects these languages to automata that accept these inputs; <em>finite state machines</em>, for instance, can be used to specify the language of regular expressions.</p>
<p>Regular expressions are great for not-too-complex input formats, and the associated finite state machines have many properties that make them great for reasoning.  To specify more complex inputs, though, they quickly encounter limitations.  At the other end of the language spectrum, we have <em>universal grammars</em> that denote the language accepted by <em>Turing machines</em>.  A Turing machine can compute anything that can be computed; and with Python being Turing-complete, this means that we can also use a Python program <span class="math notranslate nohighlight">\(p\)</span> to specify or even enumerate legal inputs.  But then, computer science theory also tells us that each such testing program has to be written specifically for the program to be tested, which is not the level of automation we want.</p>
</section>
<section id="grammars">
<h2>Grammars<a class="headerlink" href="#grammars" title="Link to this heading">#</a></h2>
<p>The middle ground between regular expressions and Turing machines is covered by <em>grammars</em>.  Grammars are among the most popular (and best understood) formalisms to formally specify input languages.  Using a grammar, one can express a wide range of the properties of an input language.  Grammars are particularly great for expressing the <em>syntactical structure</em> of an input, and are the formalism of choice to express nested or recursive inputs.  The grammars we use are so-called <em>context-free grammars</em>, one of the easiest and most popular grammar formalisms.</p>
<section id="rules-and-expansions">
<h3>Rules and Expansions<a class="headerlink" href="#rules-and-expansions" title="Link to this heading">#</a></h3>
<p>A grammar consists of a <em>start symbol</em> and a set of <em>expansion rules</em> (or simply <em>rules</em>) which indicate how the start symbol (and other symbols) can be expanded.  As an example, consider the following grammar, denoting a sequence of two digits:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">start</span><span class="o">&gt;</span> <span class="p">:</span><span class="o">:=</span> <span class="o">&lt;</span><span class="n">digit</span><span class="o">&gt;&lt;</span><span class="n">digit</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">digit</span><span class="o">&gt;</span> <span class="p">:</span><span class="o">:=</span> <span class="mi">0</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">|</span> <span class="mi">2</span> <span class="o">|</span> <span class="mi">3</span> <span class="o">|</span> <span class="mi">4</span> <span class="o">|</span> <span class="mi">5</span> <span class="o">|</span> <span class="mi">6</span> <span class="o">|</span> <span class="mi">7</span> <span class="o">|</span> <span class="mi">8</span> <span class="o">|</span> <span class="mi">9</span>
</pre></div>
</div>
<p>To read such a grammar, start with the start symbol (<code class="docutils literal notranslate"><span class="pre">&lt;start&gt;</span></code>).  An expansion rule <code class="docutils literal notranslate"><span class="pre">&lt;A&gt;</span> <span class="pre">::=</span> <span class="pre">&lt;B&gt;</span></code> means that the symbol on the left side (<code class="docutils literal notranslate"><span class="pre">&lt;A&gt;</span></code>) can be replaced by the string on the right side (<code class="docutils literal notranslate"><span class="pre">&lt;B&gt;</span></code>).  In the above grammar, <code class="docutils literal notranslate"><span class="pre">&lt;start&gt;</span></code> would be replaced by <code class="docutils literal notranslate"><span class="pre">&lt;digit&gt;&lt;digit&gt;</span></code>.</p>
<p>In this string again, <code class="docutils literal notranslate"><span class="pre">&lt;digit&gt;</span></code> would be replaced by the string on the right side of the <code class="docutils literal notranslate"><span class="pre">&lt;digit&gt;</span></code> rule.  The special operator <code class="docutils literal notranslate"><span class="pre">|</span></code> denotes <em>expansion alternatives</em> (or simply <em>alternatives</em>), meaning that any of the digits can be chosen for an expansion.  Each <code class="docutils literal notranslate"><span class="pre">&lt;digit&gt;</span></code> thus would be expanded into one of the given digits, eventually yielding a string between <code class="docutils literal notranslate"><span class="pre">00</span></code> and <code class="docutils literal notranslate"><span class="pre">99</span></code>.  There are no further expansions for <code class="docutils literal notranslate"><span class="pre">0</span></code> to <code class="docutils literal notranslate"><span class="pre">9</span></code>, so we are all set.</p>
<p>The interesting thing about grammars is that they can be <em>recursive</em>. That is, expansions can make use of symbols expanded earlier – which would then be expanded again.  As an example, consider a grammar that describes integers:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">start</span><span class="o">&gt;</span>  <span class="p">:</span><span class="o">:=</span> <span class="o">&lt;</span><span class="n">integer</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">integer</span><span class="o">&gt;</span> <span class="p">:</span><span class="o">:=</span> <span class="o">&lt;</span><span class="n">digit</span><span class="o">&gt;</span> <span class="o">|</span> <span class="o">&lt;</span><span class="n">digit</span><span class="o">&gt;&lt;</span><span class="n">integer</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">digit</span><span class="o">&gt;</span>   <span class="p">:</span><span class="o">:=</span> <span class="mi">0</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">|</span> <span class="mi">2</span> <span class="o">|</span> <span class="mi">3</span> <span class="o">|</span> <span class="mi">4</span> <span class="o">|</span> <span class="mi">5</span> <span class="o">|</span> <span class="mi">6</span> <span class="o">|</span> <span class="mi">7</span> <span class="o">|</span> <span class="mi">8</span> <span class="o">|</span> <span class="mi">9</span>
</pre></div>
</div>
<p>Here, a <code class="docutils literal notranslate"><span class="pre">&lt;integer&gt;</span></code> is either a single digit, or a digit followed by another integer.  The number <code class="docutils literal notranslate"><span class="pre">1234</span></code> thus would be represented as a single digit <code class="docutils literal notranslate"><span class="pre">1</span></code>, followed by the integer <code class="docutils literal notranslate"><span class="pre">234</span></code>, which in turn is a digit <code class="docutils literal notranslate"><span class="pre">2</span></code>, followed by the integer <code class="docutils literal notranslate"><span class="pre">34</span></code>.</p>
<p>If we wanted to express that an integer can be preceded by a sign (<code class="docutils literal notranslate"><span class="pre">+</span></code> or <code class="docutils literal notranslate"><span class="pre">-</span></code>), we would write the grammar as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">start</span><span class="o">&gt;</span>   <span class="p">:</span><span class="o">:=</span> <span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">number</span><span class="o">&gt;</span>  <span class="p">:</span><span class="o">:=</span> <span class="o">&lt;</span><span class="n">integer</span><span class="o">&gt;</span> <span class="o">|</span> <span class="o">+&lt;</span><span class="n">integer</span><span class="o">&gt;</span> <span class="o">|</span> <span class="o">-&lt;</span><span class="n">integer</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">integer</span><span class="o">&gt;</span> <span class="p">:</span><span class="o">:=</span> <span class="o">&lt;</span><span class="n">digit</span><span class="o">&gt;</span> <span class="o">|</span> <span class="o">&lt;</span><span class="n">digit</span><span class="o">&gt;&lt;</span><span class="n">integer</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">digit</span><span class="o">&gt;</span>   <span class="p">:</span><span class="o">:=</span> <span class="mi">0</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">|</span> <span class="mi">2</span> <span class="o">|</span> <span class="mi">3</span> <span class="o">|</span> <span class="mi">4</span> <span class="o">|</span> <span class="mi">5</span> <span class="o">|</span> <span class="mi">6</span> <span class="o">|</span> <span class="mi">7</span> <span class="o">|</span> <span class="mi">8</span> <span class="o">|</span> <span class="mi">9</span>
</pre></div>
</div>
<p>These rules formally define the language: Anything that can be derived from the start symbol is part of the language; anything that cannot is not.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bookutils</span> <span class="kn">import</span> <span class="n">quiz</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">quiz</span><span class="p">(</span><span class="s2">&quot;Which of these strings cannot be produced &quot;</span>
     <span class="s2">&quot;from the above `&lt;start&gt;` symbol?&quot;</span><span class="p">,</span>
     <span class="p">[</span>
         <span class="s2">&quot;`007`&quot;</span><span class="p">,</span>
         <span class="s2">&quot;`-42`&quot;</span><span class="p">,</span>
         <span class="s2">&quot;`++1`&quot;</span><span class="p">,</span>
         <span class="s2">&quot;`3.14`&quot;</span>
     <span class="p">],</span> <span class="s2">&quot;[27 ** (1/3), 256 ** (1/4)]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">Which of these strings cannot be produced from the above <code>&lt;start&gt;</code> symbol?</div>
    </p>
    <p>
    <div class="quiz_options" title="Check all that apply.">
    
        <input type="checkbox" name="e1424af2-d3ed-11ef-9634-6298cf1a5790" id="e1424af2-d3ed-11ef-9634-6298cf1a5790-1" onclick="clear_selection('e1424af2-d3ed-11ef-9634-6298cf1a5790')">
        <label id="e1424af2-d3ed-11ef-9634-6298cf1a5790-1-label" for="e1424af2-d3ed-11ef-9634-6298cf1a5790-1"><code>007</code></label><br>
    
        <input type="checkbox" name="e1424af2-d3ed-11ef-9634-6298cf1a5790" id="e1424af2-d3ed-11ef-9634-6298cf1a5790-2" onclick="clear_selection('e1424af2-d3ed-11ef-9634-6298cf1a5790')">
        <label id="e1424af2-d3ed-11ef-9634-6298cf1a5790-2-label" for="e1424af2-d3ed-11ef-9634-6298cf1a5790-2"><code>-42</code></label><br>
    
        <input type="checkbox" name="e1424af2-d3ed-11ef-9634-6298cf1a5790" id="e1424af2-d3ed-11ef-9634-6298cf1a5790-3" onclick="clear_selection('e1424af2-d3ed-11ef-9634-6298cf1a5790')">
        <label id="e1424af2-d3ed-11ef-9634-6298cf1a5790-3-label" for="e1424af2-d3ed-11ef-9634-6298cf1a5790-3"><code>++1</code></label><br>
    
        <input type="checkbox" name="e1424af2-d3ed-11ef-9634-6298cf1a5790" id="e1424af2-d3ed-11ef-9634-6298cf1a5790-4" onclick="clear_selection('e1424af2-d3ed-11ef-9634-6298cf1a5790')">
        <label id="e1424af2-d3ed-11ef-9634-6298cf1a5790-4-label" for="e1424af2-d3ed-11ef-9634-6298cf1a5790-4"><code>3.14</code></label><br>
    
    </div>
    </p>
    <input id="e1424af2-d3ed-11ef-9634-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('e1424af2-d3ed-11ef-9634-6298cf1a5790', 24, 1, '[27 ** (1/3), 256 ** (1/4)]')">
    <span class="quiz_hint" id="e1424af2-d3ed-11ef-9634-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
</section>
<section id="arithmetic-expressions">
<h3>Arithmetic Expressions<a class="headerlink" href="#arithmetic-expressions" title="Link to this heading">#</a></h3>
<p>Let us expand our grammar to cover full <em>arithmetic expressions</em> – a poster child example for a grammar.  We see that an expression (<code class="docutils literal notranslate"><span class="pre">&lt;expr&gt;</span></code>) is either a sum, or a difference, or a term; a term is either a product or a division, or a factor; and a factor is either a number or a parenthesized expression.  Almost all rules can have recursion, and thus allow arbitrary complex expressions such as <code class="docutils literal notranslate"><span class="pre">(1</span> <span class="pre">+</span> <span class="pre">2)</span> <span class="pre">*</span> <span class="pre">(3.4</span> <span class="pre">/</span> <span class="pre">5.6</span> <span class="pre">-</span> <span class="pre">789)</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">start</span><span class="o">&gt;</span>   <span class="p">:</span><span class="o">:=</span> <span class="o">&lt;</span><span class="n">expr</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">expr</span><span class="o">&gt;</span>    <span class="p">:</span><span class="o">:=</span> <span class="o">&lt;</span><span class="n">term</span><span class="o">&gt;</span> <span class="o">+</span> <span class="o">&lt;</span><span class="n">expr</span><span class="o">&gt;</span> <span class="o">|</span> <span class="o">&lt;</span><span class="n">term</span><span class="o">&gt;</span> <span class="o">-</span> <span class="o">&lt;</span><span class="n">expr</span><span class="o">&gt;</span> <span class="o">|</span> <span class="o">&lt;</span><span class="n">term</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">term</span><span class="o">&gt;</span>    <span class="p">:</span><span class="o">:=</span> <span class="o">&lt;</span><span class="n">term</span><span class="o">&gt;</span> <span class="o">*</span> <span class="o">&lt;</span><span class="n">factor</span><span class="o">&gt;</span> <span class="o">|</span> <span class="o">&lt;</span><span class="n">term</span><span class="o">&gt;</span> <span class="o">/</span> <span class="o">&lt;</span><span class="n">factor</span><span class="o">&gt;</span> <span class="o">|</span> <span class="o">&lt;</span><span class="n">factor</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">factor</span><span class="o">&gt;</span>  <span class="p">:</span><span class="o">:=</span> <span class="o">+&lt;</span><span class="n">factor</span><span class="o">&gt;</span> <span class="o">|</span> <span class="o">-&lt;</span><span class="n">factor</span><span class="o">&gt;</span> <span class="o">|</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">expr</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">|</span> <span class="o">&lt;</span><span class="n">integer</span><span class="o">&gt;</span> <span class="o">|</span> <span class="o">&lt;</span><span class="n">integer</span><span class="o">&gt;.&lt;</span><span class="n">integer</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">integer</span><span class="o">&gt;</span> <span class="p">:</span><span class="o">:=</span> <span class="o">&lt;</span><span class="n">digit</span><span class="o">&gt;&lt;</span><span class="n">integer</span><span class="o">&gt;</span> <span class="o">|</span> <span class="o">&lt;</span><span class="n">digit</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">digit</span><span class="o">&gt;</span>   <span class="p">:</span><span class="o">:=</span> <span class="mi">0</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">|</span> <span class="mi">2</span> <span class="o">|</span> <span class="mi">3</span> <span class="o">|</span> <span class="mi">4</span> <span class="o">|</span> <span class="mi">5</span> <span class="o">|</span> <span class="mi">6</span> <span class="o">|</span> <span class="mi">7</span> <span class="o">|</span> <span class="mi">8</span> <span class="o">|</span> <span class="mi">9</span>
</pre></div>
</div>
<p>In such a grammar, if we start with <code class="docutils literal notranslate"><span class="pre">&lt;start&gt;</span></code> and then expand one symbol after another, randomly choosing alternatives, we can quickly produce one valid arithmetic expression after another.  Such <em>grammar fuzzing</em> is highly effective as it comes to produce complex inputs, and this is what we will implement in this chapter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">quiz</span><span class="p">(</span><span class="s2">&quot;Which of these strings cannot be produced &quot;</span>
     <span class="s2">&quot;from the above `&lt;start&gt;` symbol?&quot;</span><span class="p">,</span>
     <span class="p">[</span>
         <span class="s2">&quot;`1 + 1`&quot;</span><span class="p">,</span>
         <span class="s2">&quot;`1+1`&quot;</span><span class="p">,</span>
         <span class="s2">&quot;`+1`&quot;</span><span class="p">,</span>
         <span class="s2">&quot;`+(1)`&quot;</span><span class="p">,</span>
     <span class="p">],</span> <span class="s2">&quot;4 ** 0.5&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">Which of these strings cannot be produced from the above <code>&lt;start&gt;</code> symbol?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="e1433cfa-d3ed-11ef-9634-6298cf1a5790" id="e1433cfa-d3ed-11ef-9634-6298cf1a5790-1" onclick="clear_selection('e1433cfa-d3ed-11ef-9634-6298cf1a5790')">
        <label id="e1433cfa-d3ed-11ef-9634-6298cf1a5790-1-label" for="e1433cfa-d3ed-11ef-9634-6298cf1a5790-1"><code>1 + 1</code></label><br>
    
        <input type="radio" name="e1433cfa-d3ed-11ef-9634-6298cf1a5790" id="e1433cfa-d3ed-11ef-9634-6298cf1a5790-2" onclick="clear_selection('e1433cfa-d3ed-11ef-9634-6298cf1a5790')">
        <label id="e1433cfa-d3ed-11ef-9634-6298cf1a5790-2-label" for="e1433cfa-d3ed-11ef-9634-6298cf1a5790-2"><code>1+1</code></label><br>
    
        <input type="radio" name="e1433cfa-d3ed-11ef-9634-6298cf1a5790" id="e1433cfa-d3ed-11ef-9634-6298cf1a5790-3" onclick="clear_selection('e1433cfa-d3ed-11ef-9634-6298cf1a5790')">
        <label id="e1433cfa-d3ed-11ef-9634-6298cf1a5790-3-label" for="e1433cfa-d3ed-11ef-9634-6298cf1a5790-3"><code>+1</code></label><br>
    
        <input type="radio" name="e1433cfa-d3ed-11ef-9634-6298cf1a5790" id="e1433cfa-d3ed-11ef-9634-6298cf1a5790-4" onclick="clear_selection('e1433cfa-d3ed-11ef-9634-6298cf1a5790')">
        <label id="e1433cfa-d3ed-11ef-9634-6298cf1a5790-4-label" for="e1433cfa-d3ed-11ef-9634-6298cf1a5790-4"><code>+(1)</code></label><br>
    
    </div>
    </p>
    <input id="e1433cfa-d3ed-11ef-9634-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('e1433cfa-d3ed-11ef-9634-6298cf1a5790', 4, 0, '4 ** 0.5')">
    <span class="quiz_hint" id="e1433cfa-d3ed-11ef-9634-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
</section>
</section>
<section id="representing-grammars-in-python">
<h2>Representing Grammars in Python<a class="headerlink" href="#representing-grammars-in-python" title="Link to this heading">#</a></h2>
<p>Our first step in building a grammar fuzzer is to find an appropriate format for grammars.  To make the writing of grammars as simple as possible, we use a format that is based on strings and lists.  Our grammars in Python take the format of a <em>mapping</em> between symbol names and expansions, where expansions are <em>lists</em> of alternatives.  A one-rule grammar for digits thus takes the form</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DIGIT_GRAMMAR</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="s2">&quot;6&quot;</span><span class="p">,</span> <span class="s2">&quot;7&quot;</span><span class="p">,</span> <span class="s2">&quot;8&quot;</span><span class="p">,</span> <span class="s2">&quot;9&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<section id="excursion-a-grammar-type">
<h3>Excursion: A <code class="docutils literal notranslate"><span class="pre">Grammar</span></code> Type<a class="headerlink" href="#excursion-a-grammar-type" title="Link to this heading">#</a></h3>
<p>Let us define a type for grammars, such that we can check grammar types statically.</p>
<p>A first attempt at a grammar type would be that each symbol (a string) is mapped to a list of expansions (strings):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SimpleGrammar</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
</pre></div>
</div>
</div>
</div>
<p>However, our <code class="docutils literal notranslate"><span class="pre">opts()</span></code> feature for adding optional attributes, which we will introduce later in this chapter, also allows expansions to be <em>pairs</em> that consist of strings and options, where options are mappings of strings to values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Option</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Hence, an expansion is either a string – or a pair of a string and an option.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Expansion</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Option</span><span class="p">]]</span>
</pre></div>
</div>
</div>
</div>
<p>With this, we can now define a <code class="docutils literal notranslate"><span class="pre">Grammar</span></code> as a mapping of strings to <code class="docutils literal notranslate"><span class="pre">Expansion</span></code> lists.</p>
</section>
<section id="end-of-excursion">
<h3>End of Excursion<a class="headerlink" href="#end-of-excursion" title="Link to this heading">#</a></h3>
<p>We can capture the grammar structure in a <em><code class="docutils literal notranslate"><span class="pre">Grammar</span></code></em> type, in which each symbol (a string) is mapped to a list of expansions (strings):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Grammar</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Expansion</span><span class="p">]]</span>
</pre></div>
</div>
</div>
</div>
<p>With this <code class="docutils literal notranslate"><span class="pre">Grammar</span></code> type, the full grammar for arithmetic expressions looks like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EXPR_GRAMMAR</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;expr&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;expr&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;term&gt; + &lt;expr&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;term&gt; - &lt;expr&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;term&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;term&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;factor&gt; * &lt;term&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;factor&gt; / &lt;term&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;factor&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;factor&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;+&lt;factor&gt;&quot;</span><span class="p">,</span>
         <span class="s2">&quot;-&lt;factor&gt;&quot;</span><span class="p">,</span>
         <span class="s2">&quot;(&lt;expr&gt;)&quot;</span><span class="p">,</span>
         <span class="s2">&quot;&lt;integer&gt;.&lt;integer&gt;&quot;</span><span class="p">,</span>
         <span class="s2">&quot;&lt;integer&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;integer&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;digit&gt;&lt;integer&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="s2">&quot;6&quot;</span><span class="p">,</span> <span class="s2">&quot;7&quot;</span><span class="p">,</span> <span class="s2">&quot;8&quot;</span><span class="p">,</span> <span class="s2">&quot;9&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>In the grammar, every symbol can be defined exactly once.  We can access any rule by its symbol…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EXPR_GRAMMAR</span><span class="p">[</span><span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;]
</pre></div>
</div>
</div>
</div>
<p>…and we can check whether a symbol is in the grammar:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;&lt;identifier&gt;&quot;</span> <span class="ow">in</span> <span class="n">EXPR_GRAMMAR</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False
</pre></div>
</div>
</div>
</div>
<p>Note that we assume that on the left-hand side of a rule (i.e., the key in the mapping) is always a single symbol.  This is the property that gives our grammars the characterization of <em>context-free</em>.</p>
</section>
</section>
<section id="some-definitions">
<h2>Some Definitions<a class="headerlink" href="#some-definitions" title="Link to this heading">#</a></h2>
<p>We assume that the canonical start symbol is <code class="docutils literal notranslate"><span class="pre">&lt;start&gt;</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">START_SYMBOL</span> <span class="o">=</span> <span class="s2">&quot;&lt;start&gt;&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>The handy <code class="docutils literal notranslate"><span class="pre">nonterminals()</span></code> function extracts the list of nonterminal symbols (i.e., anything between <code class="docutils literal notranslate"><span class="pre">&lt;</span></code> and <code class="docutils literal notranslate"><span class="pre">&gt;</span></code>, except spaces) from an expansion.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RE_NONTERMINAL</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(&lt;[^&lt;&gt; ]*&gt;)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">nonterminals</span><span class="p">(</span><span class="n">expansion</span><span class="p">):</span>
    <span class="c1"># In later chapters, we allow expansions to be tuples,</span>
    <span class="c1"># with the expansion being the first element</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expansion</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">expansion</span> <span class="o">=</span> <span class="n">expansion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">RE_NONTERMINAL</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">expansion</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">nonterminals</span><span class="p">(</span><span class="s2">&quot;&lt;term&gt; * &lt;factor&gt;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;&lt;term&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;factor&gt;&quot;</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">nonterminals</span><span class="p">(</span><span class="s2">&quot;&lt;digit&gt;&lt;integer&gt;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;integer&gt;&quot;</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">nonterminals</span><span class="p">(</span><span class="s2">&quot;1 &lt; 3 &gt; 2&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[]</span>
<span class="k">assert</span> <span class="n">nonterminals</span><span class="p">(</span><span class="s2">&quot;1 &lt;3&gt; 2&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;&lt;3&gt;&quot;</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">nonterminals</span><span class="p">(</span><span class="s2">&quot;1 + 2&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[]</span>
<span class="k">assert</span> <span class="n">nonterminals</span><span class="p">((</span><span class="s2">&quot;&lt;1&gt;&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">}))</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;&lt;1&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Likewise, <code class="docutils literal notranslate"><span class="pre">is_nonterminal()</span></code> checks whether some symbol is a nonterminal:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">is_nonterminal</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">RE_NONTERMINAL</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">is_nonterminal</span><span class="p">(</span><span class="s2">&quot;&lt;abc&gt;&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">is_nonterminal</span><span class="p">(</span><span class="s2">&quot;&lt;symbol-1&gt;&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="n">is_nonterminal</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="a-simple-grammar-fuzzer">
<h2>A Simple Grammar Fuzzer<a class="headerlink" href="#a-simple-grammar-fuzzer" title="Link to this heading">#</a></h2>
<p>Let us now put the above grammars to use.  We will build a very simple grammar fuzzer that starts with a start symbol (<code class="docutils literal notranslate"><span class="pre">&lt;start&gt;</span></code>) and then keeps on expanding it.  To avoid expansion to infinite inputs, we place a limit (<code class="docutils literal notranslate"><span class="pre">max_nonterminals</span></code>) on the number of nonterminals.  Furthermore, to avoid being stuck in a situation where we cannot reduce the number of symbols any further, we also limit the total number of expansion steps.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ExpansionError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">simple_grammar_fuzzer</span><span class="p">(</span><span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">,</span> 
                          <span class="n">start_symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">START_SYMBOL</span><span class="p">,</span>
                          <span class="n">max_nonterminals</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                          <span class="n">max_expansion_trials</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                          <span class="n">log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Produce a string from `grammar`.</span>
<span class="sd">       `start_symbol`: use a start symbol other than `&lt;start&gt;` (default).</span>
<span class="sd">       `max_nonterminals`: the maximum number of nonterminals </span>
<span class="sd">         still left for expansion</span>
<span class="sd">       `max_expansion_trials`: maximum # of attempts to produce a string</span>
<span class="sd">       `log`: print expansion progress if True&quot;&quot;&quot;</span>

    <span class="n">term</span> <span class="o">=</span> <span class="n">start_symbol</span>
    <span class="n">expansion_trials</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonterminals</span><span class="p">(</span><span class="n">term</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">symbol_to_expand</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">nonterminals</span><span class="p">(</span><span class="n">term</span><span class="p">))</span>
        <span class="n">expansions</span> <span class="o">=</span> <span class="n">grammar</span><span class="p">[</span><span class="n">symbol_to_expand</span><span class="p">]</span>
        <span class="n">expansion</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">expansions</span><span class="p">)</span>
        <span class="c1"># In later chapters, we allow expansions to be tuples,</span>
        <span class="c1"># with the expansion being the first element</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expansion</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">expansion</span> <span class="o">=</span> <span class="n">expansion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">new_term</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">symbol_to_expand</span><span class="p">,</span> <span class="n">expansion</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonterminals</span><span class="p">(</span><span class="n">new_term</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">max_nonterminals</span><span class="p">:</span>
            <span class="n">term</span> <span class="o">=</span> <span class="n">new_term</span>
            <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%-40s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">symbol_to_expand</span> <span class="o">+</span> <span class="s2">&quot; -&gt; &quot;</span> <span class="o">+</span> <span class="n">expansion</span><span class="p">),</span> <span class="n">term</span><span class="p">)</span>
            <span class="n">expansion_trials</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expansion_trials</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">expansion_trials</span> <span class="o">&gt;=</span> <span class="n">max_expansion_trials</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ExpansionError</span><span class="p">(</span><span class="s2">&quot;Cannot expand &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">term</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">term</span>
</pre></div>
</div>
</div>
</div>
<p>Let us see how this simple grammar fuzzer obtains an arithmetic expression from the start symbol:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">simple_grammar_fuzzer</span><span class="p">(</span><span class="n">grammar</span><span class="o">=</span><span class="n">EXPR_GRAMMAR</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;start&gt; -&gt; &lt;expr&gt;                        &lt;expr&gt;
&lt;expr&gt; -&gt; &lt;term&gt; + &lt;expr&gt;                &lt;term&gt; + &lt;expr&gt;
&lt;term&gt; -&gt; &lt;factor&gt;                       &lt;factor&gt; + &lt;expr&gt;
&lt;factor&gt; -&gt; &lt;integer&gt;                    &lt;integer&gt; + &lt;expr&gt;
&lt;integer&gt; -&gt; &lt;digit&gt;                     &lt;digit&gt; + &lt;expr&gt;
&lt;digit&gt; -&gt; 6                             6 + &lt;expr&gt;
&lt;expr&gt; -&gt; &lt;term&gt; - &lt;expr&gt;                6 + &lt;term&gt; - &lt;expr&gt;
&lt;expr&gt; -&gt; &lt;term&gt;                         6 + &lt;term&gt; - &lt;term&gt;
&lt;term&gt; -&gt; &lt;factor&gt;                       6 + &lt;factor&gt; - &lt;term&gt;
&lt;factor&gt; -&gt; -&lt;factor&gt;                    6 + -&lt;factor&gt; - &lt;term&gt;
&lt;term&gt; -&gt; &lt;factor&gt;                       6 + -&lt;factor&gt; - &lt;factor&gt;
&lt;factor&gt; -&gt; (&lt;expr&gt;)                     6 + -(&lt;expr&gt;) - &lt;factor&gt;
&lt;factor&gt; -&gt; (&lt;expr&gt;)                     6 + -(&lt;expr&gt;) - (&lt;expr&gt;)
&lt;expr&gt; -&gt; &lt;term&gt;                         6 + -(&lt;term&gt;) - (&lt;expr&gt;)
&lt;expr&gt; -&gt; &lt;term&gt;                         6 + -(&lt;term&gt;) - (&lt;term&gt;)
&lt;term&gt; -&gt; &lt;factor&gt;                       6 + -(&lt;factor&gt;) - (&lt;term&gt;)
&lt;factor&gt; -&gt; +&lt;factor&gt;                    6 + -(+&lt;factor&gt;) - (&lt;term&gt;)
&lt;factor&gt; -&gt; +&lt;factor&gt;                    6 + -(++&lt;factor&gt;) - (&lt;term&gt;)
&lt;term&gt; -&gt; &lt;factor&gt;                       6 + -(++&lt;factor&gt;) - (&lt;factor&gt;)
&lt;factor&gt; -&gt; (&lt;expr&gt;)                     6 + -(++(&lt;expr&gt;)) - (&lt;factor&gt;)
&lt;factor&gt; -&gt; &lt;integer&gt;                    6 + -(++(&lt;expr&gt;)) - (&lt;integer&gt;)
&lt;expr&gt; -&gt; &lt;term&gt;                         6 + -(++(&lt;term&gt;)) - (&lt;integer&gt;)
&lt;integer&gt; -&gt; &lt;digit&gt;                     6 + -(++(&lt;term&gt;)) - (&lt;digit&gt;)
&lt;digit&gt; -&gt; 9                             6 + -(++(&lt;term&gt;)) - (9)
&lt;term&gt; -&gt; &lt;factor&gt; * &lt;term&gt;              6 + -(++(&lt;factor&gt; * &lt;term&gt;)) - (9)
&lt;term&gt; -&gt; &lt;factor&gt;                       6 + -(++(&lt;factor&gt; * &lt;factor&gt;)) - (9)
&lt;factor&gt; -&gt; &lt;integer&gt;                    6 + -(++(&lt;integer&gt; * &lt;factor&gt;)) - (9)
&lt;integer&gt; -&gt; &lt;digit&gt;                     6 + -(++(&lt;digit&gt; * &lt;factor&gt;)) - (9)
&lt;digit&gt; -&gt; 2                             6 + -(++(2 * &lt;factor&gt;)) - (9)
&lt;factor&gt; -&gt; +&lt;factor&gt;                    6 + -(++(2 * +&lt;factor&gt;)) - (9)
&lt;factor&gt; -&gt; -&lt;factor&gt;                    6 + -(++(2 * +-&lt;factor&gt;)) - (9)
&lt;factor&gt; -&gt; -&lt;factor&gt;                    6 + -(++(2 * +--&lt;factor&gt;)) - (9)
&lt;factor&gt; -&gt; -&lt;factor&gt;                    6 + -(++(2 * +---&lt;factor&gt;)) - (9)
&lt;factor&gt; -&gt; -&lt;factor&gt;                    6 + -(++(2 * +----&lt;factor&gt;)) - (9)
&lt;factor&gt; -&gt; &lt;integer&gt;.&lt;integer&gt;          6 + -(++(2 * +----&lt;integer&gt;.&lt;integer&gt;)) - (9)
&lt;integer&gt; -&gt; &lt;digit&gt;                     6 + -(++(2 * +----&lt;digit&gt;.&lt;integer&gt;)) - (9)
&lt;integer&gt; -&gt; &lt;digit&gt;                     6 + -(++(2 * +----&lt;digit&gt;.&lt;digit&gt;)) - (9)
&lt;digit&gt; -&gt; 1                             6 + -(++(2 * +----1.&lt;digit&gt;)) - (9)
&lt;digit&gt; -&gt; 7                             6 + -(++(2 * +----1.7)) - (9)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;6 + -(++(2 * +----1.7)) - (9)&#39;
</pre></div>
</div>
</div>
</div>
<p>By increasing the limit of nonterminals, we can quickly get much longer productions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">simple_grammar_fuzzer</span><span class="p">(</span><span class="n">grammar</span><span class="o">=</span><span class="n">EXPR_GRAMMAR</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7 / +48.5
-5.9 / 9 - 4 * +-(-+++((1 + (+7 - (-1 * (++-+7.7 - -+-4.0))))) * +--4 - -(6) + 64)
8.2 - 27 - -9 / +((+9 * --2 + --+-+-((-1 * +(8 - 5 - 6)) * (-((-+(((+(4))))) - ++4) / +(-+---((5.6 - --(3 * -1.8 * +(6 * +-(((-(-6) * ---+6)) / +--(+-+-7 * (-0 * (+(((((2)) + 8 - 3 - ++9.0 + ---(--+7 / (1 / +++6.37) + (1) / 482) / +++-+0)))) * -+5 + 7.513)))) - (+1 / ++((-84)))))))) * ++5 / +-(--2 - -++-9.0)))) / 5 * --++090
1 - -3 * 7 - 28 / 9
(+9) * +-5 * ++-926.2 - (+9.03 / -+(-(-6) / 2 * +(-+--(8) / -(+1.0) - 5 + 4)) * 3.5)
8 + -(9.6 - 3 - -+-4 * +77)
-(((((++((((+((++++-((+-37))))))))))))) / ++(-(+++(+6)) * -++-(+(++(---6 * (((7)) * (1) / (-7.6 * 535338) + +256) * 0) * 0))) - 4 + +1
5.43
(9 / -405 / -23 - +-((+-(2 * (13))))) + +6 - +8 - 934
-++2 - (--+715769550) / 8 / (1)
</pre></div>
</div>
</div>
</div>
<p>Note that while our fuzzer does the job in most cases, it has a number of drawbacks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">quiz</span><span class="p">(</span><span class="s2">&quot;What drawbacks does `simple_grammar_fuzzer()` have?&quot;</span><span class="p">,</span>
     <span class="p">[</span>
         <span class="s2">&quot;It has a large number of string search and replace operations&quot;</span><span class="p">,</span>
         <span class="s2">&quot;It may fail to produce a string (`ExpansionError`)&quot;</span><span class="p">,</span>
         <span class="s2">&quot;It often picks some symbol to expand &quot;</span>
         <span class="s2">&quot;that does not even occur in the string&quot;</span><span class="p">,</span>
         <span class="s2">&quot;All of the above&quot;</span>
     <span class="p">],</span> <span class="s2">&quot;1 &lt;&lt; 2&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">What drawbacks does <code>simple_grammar_fuzzer()</code> have?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="e1505106-d3ed-11ef-9634-6298cf1a5790" id="e1505106-d3ed-11ef-9634-6298cf1a5790-1" onclick="clear_selection('e1505106-d3ed-11ef-9634-6298cf1a5790')">
        <label id="e1505106-d3ed-11ef-9634-6298cf1a5790-1-label" for="e1505106-d3ed-11ef-9634-6298cf1a5790-1">It has a large number of string search and replace operations</label><br>
    
        <input type="radio" name="e1505106-d3ed-11ef-9634-6298cf1a5790" id="e1505106-d3ed-11ef-9634-6298cf1a5790-2" onclick="clear_selection('e1505106-d3ed-11ef-9634-6298cf1a5790')">
        <label id="e1505106-d3ed-11ef-9634-6298cf1a5790-2-label" for="e1505106-d3ed-11ef-9634-6298cf1a5790-2">It may fail to produce a string (<code>ExpansionError</code>)</label><br>
    
        <input type="radio" name="e1505106-d3ed-11ef-9634-6298cf1a5790" id="e1505106-d3ed-11ef-9634-6298cf1a5790-3" onclick="clear_selection('e1505106-d3ed-11ef-9634-6298cf1a5790')">
        <label id="e1505106-d3ed-11ef-9634-6298cf1a5790-3-label" for="e1505106-d3ed-11ef-9634-6298cf1a5790-3">It often picks some symbol to expand that does not even occur in the string</label><br>
    
        <input type="radio" name="e1505106-d3ed-11ef-9634-6298cf1a5790" id="e1505106-d3ed-11ef-9634-6298cf1a5790-4" onclick="clear_selection('e1505106-d3ed-11ef-9634-6298cf1a5790')">
        <label id="e1505106-d3ed-11ef-9634-6298cf1a5790-4-label" for="e1505106-d3ed-11ef-9634-6298cf1a5790-4">All of the above</label><br>
    
    </div>
    </p>
    <input id="e1505106-d3ed-11ef-9634-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('e1505106-d3ed-11ef-9634-6298cf1a5790', 16, 0, '1 &lt;&lt; 2')">
    <span class="quiz_hint" id="e1505106-d3ed-11ef-9634-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>Indeed, <code class="docutils literal notranslate"><span class="pre">simple_grammar_fuzzer()</span></code> is rather inefficient due to the large number of search and replace operations, and it may even fail to produce a string. On the other hand, the implementation is straightforward and does the job in most cases. For this chapter, we’ll stick to it; in the <a class="reference internal" href="GrammarFuzzer.html"><span class="std std-doc">next chapter</span></a>, we’ll show how to build a more efficient one.</p>
</section>
<section id="visualizing-grammars-as-railroad-diagrams">
<h2>Visualizing Grammars as Railroad Diagrams<a class="headerlink" href="#visualizing-grammars-as-railroad-diagrams" title="Link to this heading">#</a></h2>
<p>With grammars, we can easily specify the format for several of the examples we discussed earlier.  The above arithmetic expressions, for instance, can be directly sent into <code class="docutils literal notranslate"><span class="pre">bc</span></code> (or any other program that takes arithmetic expressions).  Before we introduce a few additional grammars, let us give a means to <em>visualize</em> them, giving an alternate view to aid their understanding.</p>
<p><em>Railroad diagrams</em>, also called <em>syntax diagrams</em>, are a graphical representation of context-free grammars.  They are read left to right, following possible “rail” tracks; the sequence of symbols encountered on the track defines the language. To produce railroad diagrams, we implement a function <code class="docutils literal notranslate"><span class="pre">syntax_diagram()</span></code>.</p>
<section id="excursion-implementing-syntax-diagram">
<h3>Excursion: Implementing <code class="docutils literal notranslate"><span class="pre">syntax_diagram()</span></code><a class="headerlink" href="#excursion-implementing-syntax-diagram" title="Link to this heading">#</a></h3>
<p>We use <a class="reference internal" href="RailroadDiagrams.html"><span class="std std-doc">RailroadDiagrams</span></a>, an external library for visualization.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">RailroadDiagrams</span> <span class="kn">import</span> <span class="n">NonTerminal</span><span class="p">,</span> <span class="n">Terminal</span><span class="p">,</span> <span class="n">Choice</span><span class="p">,</span> <span class="n">HorizontalChoice</span><span class="p">,</span> <span class="n">Sequence</span>
<span class="kn">from</span> <span class="nn">RailroadDiagrams</span> <span class="kn">import</span> <span class="n">show_diagram</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">SVG</span>
</pre></div>
</div>
</div>
</div>
<p>We first define the method <code class="docutils literal notranslate"><span class="pre">syntax_diagram_symbol()</span></code> to visualize a given symbol.  Terminal symbols are denoted as ovals, whereas nonterminal symbols (such as <code class="docutils literal notranslate"><span class="pre">&lt;term&gt;</span></code>) are denoted as rectangles.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">syntax_diagram_symbol</span><span class="p">(</span><span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">is_nonterminal</span><span class="p">(</span><span class="n">symbol</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">NonTerminal</span><span class="p">(</span><span class="n">symbol</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Terminal</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SVG</span><span class="p">(</span><span class="n">show_diagram</span><span class="p">(</span><span class="n">syntax_diagram_symbol</span><span class="p">(</span><span class="s1">&#39;&lt;term&gt;&#39;</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/4ac81cee3f8949db7796d4454818f54295ba9c8fcab1c864936a9c3c49411882.svg" src="_images/4ac81cee3f8949db7796d4454818f54295ba9c8fcab1c864936a9c3c49411882.svg" />
</div>
</div>
<p>We define <code class="docutils literal notranslate"><span class="pre">syntax_diagram_expr()</span></code> to visualize expansion alternatives.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">syntax_diagram_expr</span><span class="p">(</span><span class="n">expansion</span><span class="p">:</span> <span class="n">Expansion</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="c1"># In later chapters, we allow expansions to be tuples,</span>
    <span class="c1"># with the expansion being the first element</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expansion</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">expansion</span> <span class="o">=</span> <span class="n">expansion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">symbols</span> <span class="o">=</span> <span class="p">[</span><span class="n">sym</span> <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">RE_NONTERMINAL</span><span class="p">,</span> <span class="n">expansion</span><span class="p">)</span> <span class="k">if</span> <span class="n">sym</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>  <span class="c1"># special case: empty expansion</span>

    <span class="k">return</span> <span class="n">Sequence</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">syntax_diagram_symbol</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span> <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SVG</span><span class="p">(</span><span class="n">show_diagram</span><span class="p">(</span><span class="n">syntax_diagram_expr</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">[</span><span class="s1">&#39;&lt;term&gt;&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/98387a5c81048f5b0fd29fb536547e009024bbdb27e740604ee510f367b701ea.svg" src="_images/98387a5c81048f5b0fd29fb536547e009024bbdb27e740604ee510f367b701ea.svg" />
</div>
</div>
<p>This is the first alternative of <code class="docutils literal notranslate"><span class="pre">&lt;term&gt;</span></code> – a <code class="docutils literal notranslate"><span class="pre">&lt;factor&gt;</span></code> followed by <code class="docutils literal notranslate"><span class="pre">*</span></code> and a <code class="docutils literal notranslate"><span class="pre">&lt;term&gt;</span></code>.</p>
<p>Next, we define <code class="docutils literal notranslate"><span class="pre">syntax_diagram_alt()</span></code> for displaying alternate expressions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">zip_longest</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">syntax_diagram_alt</span><span class="p">(</span><span class="n">alt</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Expansion</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="n">max_len</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">alt_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">alt_len</span> <span class="o">&gt;</span> <span class="n">max_len</span><span class="p">:</span>
        <span class="n">iter_len</span> <span class="o">=</span> <span class="n">alt_len</span> <span class="o">//</span> <span class="n">max_len</span>
        <span class="n">alts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">zip_longest</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">alt</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">iter_len</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iter_len</span><span class="p">)]))</span>
        <span class="n">exprs</span> <span class="o">=</span> <span class="p">[[</span><span class="n">syntax_diagram_expr</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">alt</span>
                  <span class="k">if</span> <span class="n">expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span> <span class="k">for</span> <span class="n">alt</span> <span class="ow">in</span> <span class="n">alts</span><span class="p">]</span>
        <span class="n">choices</span> <span class="o">=</span> <span class="p">[</span><span class="n">Choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="o">*</span><span class="n">expr</span><span class="p">)</span> <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">exprs</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">HorizontalChoice</span><span class="p">(</span><span class="o">*</span><span class="n">choices</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Choice</span><span class="p">(</span><span class="n">alt_len</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="n">syntax_diagram_expr</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">alt</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SVG</span><span class="p">(</span><span class="n">show_diagram</span><span class="p">(</span><span class="n">syntax_diagram_alt</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">[</span><span class="s1">&#39;&lt;digit&gt;&#39;</span><span class="p">])))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/831527e2b2231b00574fb7a68ba1dce71a738444df89dc5f1c870b2354eef828.svg" src="_images/831527e2b2231b00574fb7a68ba1dce71a738444df89dc5f1c870b2354eef828.svg" />
</div>
</div>
<p>We see that a <code class="docutils literal notranslate"><span class="pre">&lt;digit&gt;</span></code> can be any single digit from <code class="docutils literal notranslate"><span class="pre">0</span></code> to <code class="docutils literal notranslate"><span class="pre">9</span></code>.</p>
<p>Finally, we define <code class="docutils literal notranslate"><span class="pre">syntax_diagram()</span></code> which given a grammar, displays the syntax diagram of its rules.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">syntax_diagram</span><span class="p">(</span><span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">SVG</span><span class="p">,</span> <span class="n">display</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">grammar</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">display</span><span class="p">(</span><span class="n">SVG</span><span class="p">(</span><span class="n">show_diagram</span><span class="p">(</span><span class="n">syntax_diagram_alt</span><span class="p">(</span><span class="n">grammar</span><span class="p">[</span><span class="n">key</span><span class="p">]))))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id1">
<h3>End of Excursion<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<p>Let us use <code class="docutils literal notranslate"><span class="pre">syntax_diagram()</span></code> to produce a railroad diagram of our expression grammar:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">syntax_diagram</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>start
</pre></div>
</div>
<img alt="_images/5075a5956aae4dc2e0239c51c12deb0ef7c80ca60417bce66eafeaf6e015a249.svg" src="_images/5075a5956aae4dc2e0239c51c12deb0ef7c80ca60417bce66eafeaf6e015a249.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>expr
</pre></div>
</div>
<img alt="_images/c229495947bd0a56f9893d572e4727b5a44c844b4e31cc0c13a4ad3792d2975c.svg" src="_images/c229495947bd0a56f9893d572e4727b5a44c844b4e31cc0c13a4ad3792d2975c.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>term
</pre></div>
</div>
<img alt="_images/a7aa1ca558958ee7ff69dc4d7f9e3417212e8c53eeb5695c5d3f21b1d27894b2.svg" src="_images/a7aa1ca558958ee7ff69dc4d7f9e3417212e8c53eeb5695c5d3f21b1d27894b2.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>factor
</pre></div>
</div>
<img alt="_images/c52dcecbcb981e9aa842a2ab08796c39819d7da092a892b1ebd19effc0c313b3.svg" src="_images/c52dcecbcb981e9aa842a2ab08796c39819d7da092a892b1ebd19effc0c313b3.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>integer
</pre></div>
</div>
<img alt="_images/5a75993e5ed69c1b52c21d919b3e1c6d999e993369f42728385683101967b614.svg" src="_images/5a75993e5ed69c1b52c21d919b3e1c6d999e993369f42728385683101967b614.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>digit
</pre></div>
</div>
<img alt="_images/831527e2b2231b00574fb7a68ba1dce71a738444df89dc5f1c870b2354eef828.svg" src="_images/831527e2b2231b00574fb7a68ba1dce71a738444df89dc5f1c870b2354eef828.svg" />
</div>
</div>
<p>This railroad representation will come in handy as it comes to visualizing the structure of grammars – especially for more complex grammars.</p>
</section>
</section>
<section id="some-grammars">
<h2>Some Grammars<a class="headerlink" href="#some-grammars" title="Link to this heading">#</a></h2>
<p>Let us create (and visualize) some more grammars and use them for fuzzing.</p>
<section id="a-cgi-grammar">
<h3>A CGI Grammar<a class="headerlink" href="#a-cgi-grammar" title="Link to this heading">#</a></h3>
<p>Here’s a grammar for <code class="docutils literal notranslate"><span class="pre">cgi_decode()</span></code> introduced in the <a class="reference internal" href="Coverage.html"><span class="std std-doc">chapter on coverage</span></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CGI_GRAMMAR</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;string&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;string&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;letter&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;letter&gt;&lt;string&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;letter&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;plus&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;percent&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;other&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;plus&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;percent&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;%&lt;hexdigit&gt;&lt;hexdigit&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;hexdigit&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="s2">&quot;6&quot;</span><span class="p">,</span> <span class="s2">&quot;7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;8&quot;</span><span class="p">,</span> <span class="s2">&quot;9&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;other&gt;&quot;</span><span class="p">:</span>  <span class="c1"># Actually, could be _all_ letters</span>
        <span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">],</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">syntax_diagram</span><span class="p">(</span><span class="n">CGI_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>start
</pre></div>
</div>
<img alt="_images/4f93162aae009bf7133764bdd6818c14ddb93a61e5f285515ebdf606266d8b54.svg" src="_images/4f93162aae009bf7133764bdd6818c14ddb93a61e5f285515ebdf606266d8b54.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>string
</pre></div>
</div>
<img alt="_images/258a4b27f4bbeaca691f24fadbf535caf9b00e8ec22f86e06d3cd11750a8bb28.svg" src="_images/258a4b27f4bbeaca691f24fadbf535caf9b00e8ec22f86e06d3cd11750a8bb28.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>letter
</pre></div>
</div>
<img alt="_images/0ba6980e60a7947bcd3bfb4594c1e1bf929b56c3a62e714ce86448509aa2d57b.svg" src="_images/0ba6980e60a7947bcd3bfb4594c1e1bf929b56c3a62e714ce86448509aa2d57b.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>plus
</pre></div>
</div>
<img alt="_images/61d1bb01e21ba9c28e5dd611f3c471aaf2cddde28eb3bc6e08e36fac73d61086.svg" src="_images/61d1bb01e21ba9c28e5dd611f3c471aaf2cddde28eb3bc6e08e36fac73d61086.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>percent
</pre></div>
</div>
<img alt="_images/38061b301b33e8a9477b5381a68f8d2164a3f4c4520dd89eefe34725e9de29d7.svg" src="_images/38061b301b33e8a9477b5381a68f8d2164a3f4c4520dd89eefe34725e9de29d7.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>hexdigit
</pre></div>
</div>
<img alt="_images/add4954944d97ae7e01b764f8c05724242a66ae1a45190a40fc699629371e981.svg" src="_images/add4954944d97ae7e01b764f8c05724242a66ae1a45190a40fc699629371e981.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>other
</pre></div>
</div>
<img alt="_images/701e5637811acdcb51ea61e693bb16f29cfdff0f11022383beb0dc625ceaa6f1.svg" src="_images/701e5637811acdcb51ea61e693bb16f29cfdff0f11022383beb0dc625ceaa6f1.svg" />
</div>
</div>
<p>In contrast to <a class="reference internal" href="Fuzzer.html"><span class="std std-doc">basic fuzzing</span></a> or <a class="reference internal" href="MutationFuzzer.html"><span class="std std-doc">mutation-based fuzzing</span></a>, the grammar quickly produces all sorts of combinations:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">simple_grammar_fuzzer</span><span class="p">(</span><span class="n">grammar</span><span class="o">=</span><span class="n">CGI_GRAMMAR</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+%9a
+++%ce+
+_
+%c6c
++
+%cd+5
1%ee
%b9%d5
%96
%57d%42
</pre></div>
</div>
</div>
</div>
</section>
<section id="a-url-grammar">
<h3>A URL Grammar<a class="headerlink" href="#a-url-grammar" title="Link to this heading">#</a></h3>
<p>The same properties we have seen for CGI input also hold for more complex inputs.  Let us use a grammar to produce numerous valid URLs:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">URL_GRAMMAR</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;url&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;url&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;scheme&gt;://&lt;authority&gt;&lt;path&gt;&lt;query&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;scheme&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;https&quot;</span><span class="p">,</span> <span class="s2">&quot;ftp&quot;</span><span class="p">,</span> <span class="s2">&quot;ftps&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;authority&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;host&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;host&gt;:&lt;port&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;userinfo&gt;@&lt;host&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;userinfo&gt;@&lt;host&gt;:&lt;port&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;host&gt;&quot;</span><span class="p">:</span>  <span class="c1"># Just a few</span>
        <span class="p">[</span><span class="s2">&quot;cispa.saarland&quot;</span><span class="p">,</span> <span class="s2">&quot;www.google.com&quot;</span><span class="p">,</span> <span class="s2">&quot;fuzzingbook.com&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;port&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;80&quot;</span><span class="p">,</span> <span class="s2">&quot;8080&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;nat&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;nat&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;digit&gt;&lt;digit&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="s2">&quot;6&quot;</span><span class="p">,</span> <span class="s2">&quot;7&quot;</span><span class="p">,</span> <span class="s2">&quot;8&quot;</span><span class="p">,</span> <span class="s2">&quot;9&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;userinfo&gt;&quot;</span><span class="p">:</span>  <span class="c1"># Just one</span>
        <span class="p">[</span><span class="s2">&quot;user:password&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;path&gt;&quot;</span><span class="p">:</span>  <span class="c1"># Just a few</span>
        <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;/&lt;id&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;id&gt;&quot;</span><span class="p">:</span>  <span class="c1"># Just a few</span>
        <span class="p">[</span><span class="s2">&quot;abc&quot;</span><span class="p">,</span> <span class="s2">&quot;def&quot;</span><span class="p">,</span> <span class="s2">&quot;x&lt;digit&gt;&lt;digit&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;query&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;?&lt;params&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;params&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;param&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;param&gt;&amp;&lt;params&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;param&gt;&quot;</span><span class="p">:</span>  <span class="c1"># Just a few</span>
        <span class="p">[</span><span class="s2">&quot;&lt;id&gt;=&lt;id&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;id&gt;=&lt;nat&gt;&quot;</span><span class="p">],</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">syntax_diagram</span><span class="p">(</span><span class="n">URL_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>start
</pre></div>
</div>
<img alt="_images/5008ab6664beaa41645000b660b94b148ebf68edd3538e65026fa2e55b104831.svg" src="_images/5008ab6664beaa41645000b660b94b148ebf68edd3538e65026fa2e55b104831.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>url
</pre></div>
</div>
<img alt="_images/ffc7f1323effc356b066479da7cbdcbbb8bd59ef9cf2bb062dfe8e07af5da0b0.svg" src="_images/ffc7f1323effc356b066479da7cbdcbbb8bd59ef9cf2bb062dfe8e07af5da0b0.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>scheme
</pre></div>
</div>
<img alt="_images/ba306b7497c352d963f5df64e984ac1e5a198feddbe2dad5e907a0c6e530d59b.svg" src="_images/ba306b7497c352d963f5df64e984ac1e5a198feddbe2dad5e907a0c6e530d59b.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>authority
</pre></div>
</div>
<img alt="_images/3ae09e759ff55b3623107ff38090ccf88a744c7106527112a2254802c4ac179c.svg" src="_images/3ae09e759ff55b3623107ff38090ccf88a744c7106527112a2254802c4ac179c.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>host
</pre></div>
</div>
<img alt="_images/c72d595cf85624c2a1d9899b68fa0cb1b2064889f730c99760c8da1abd041aa3.svg" src="_images/c72d595cf85624c2a1d9899b68fa0cb1b2064889f730c99760c8da1abd041aa3.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>port
</pre></div>
</div>
<img alt="_images/b5b19131b6ccafeaada3b9c2a3e199790055240260d3345540bba13109437d72.svg" src="_images/b5b19131b6ccafeaada3b9c2a3e199790055240260d3345540bba13109437d72.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>nat
</pre></div>
</div>
<img alt="_images/02991c73cdee9c7c5d83c70ab2cf7c1535bfe99c93e5342632e3b8efede9da28.svg" src="_images/02991c73cdee9c7c5d83c70ab2cf7c1535bfe99c93e5342632e3b8efede9da28.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>digit
</pre></div>
</div>
<img alt="_images/831527e2b2231b00574fb7a68ba1dce71a738444df89dc5f1c870b2354eef828.svg" src="_images/831527e2b2231b00574fb7a68ba1dce71a738444df89dc5f1c870b2354eef828.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>userinfo
</pre></div>
</div>
<img alt="_images/cf0a3bb02c389fe9b15e082a0526c076dd8122246c1f5040b6f5e9b98380ea36.svg" src="_images/cf0a3bb02c389fe9b15e082a0526c076dd8122246c1f5040b6f5e9b98380ea36.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>path
</pre></div>
</div>
<img alt="_images/1a104eee4b7f1546a4df5d0e444748e062034353caef27211e254c2241ef83e7.svg" src="_images/1a104eee4b7f1546a4df5d0e444748e062034353caef27211e254c2241ef83e7.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>id
</pre></div>
</div>
<img alt="_images/1c293363ff3bf1b96e0d7e03681bb3da5c096e2a42d3c27ffd557ea691335106.svg" src="_images/1c293363ff3bf1b96e0d7e03681bb3da5c096e2a42d3c27ffd557ea691335106.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>query
</pre></div>
</div>
<img alt="_images/ec721eadcfe19d86ad14293effbb69ae0fc6aa307eaaa19e32e9b89608ab76b9.svg" src="_images/ec721eadcfe19d86ad14293effbb69ae0fc6aa307eaaa19e32e9b89608ab76b9.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>params
</pre></div>
</div>
<img alt="_images/5ff12ef614101318b1a0a6cc94488b13b8626b69d7c784f37af93686d4a80d78.svg" src="_images/5ff12ef614101318b1a0a6cc94488b13b8626b69d7c784f37af93686d4a80d78.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>param
</pre></div>
</div>
<img alt="_images/ee7265d3a5bda243e2255c20ade102acf47fa01c20565b66fe681a541f6ea1d4.svg" src="_images/ee7265d3a5bda243e2255c20ade102acf47fa01c20565b66fe681a541f6ea1d4.svg" />
</div>
</div>
<p>Again, within milliseconds, we can produce plenty of valid inputs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">simple_grammar_fuzzer</span><span class="p">(</span><span class="n">grammar</span><span class="o">=</span><span class="n">URL_GRAMMAR</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>https://user:password@cispa.saarland:80/
http://fuzzingbook.com?def=56&amp;x89=3&amp;x46=48&amp;def=def
ftp://cispa.saarland/?x71=5&amp;x35=90&amp;def=abc
https://cispa.saarland:80/def?def=7&amp;x23=abc
https://fuzzingbook.com:80/
https://fuzzingbook.com:80/abc?def=abc&amp;abc=x14&amp;def=abc&amp;abc=2&amp;def=38
ftps://fuzzingbook.com/x87
https://user:password@fuzzingbook.com:6?def=54&amp;x44=abc
http://fuzzingbook.com:80?x33=25&amp;def=8
http://fuzzingbook.com:8080/def
</pre></div>
</div>
</div>
</div>
</section>
<section id="a-natural-language-grammar">
<h3>A Natural Language Grammar<a class="headerlink" href="#a-natural-language-grammar" title="Link to this heading">#</a></h3>
<p>Finally, grammars are not limited to <em>formal languages</em> such as computer inputs, but can also be used to produce <em>natural language</em>.  This is the grammar we used to pick a title for this book:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TITLE_GRAMMAR</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;title&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;title&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;topic&gt;: &lt;subtopic&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;topic&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Generating Software Tests&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;fuzzing-prefix&gt;Fuzzing&quot;</span><span class="p">,</span> <span class="s2">&quot;The Fuzzing Book&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;fuzzing-prefix&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;The Art of &quot;</span><span class="p">,</span> <span class="s2">&quot;The Joy of &quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;subtopic&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;subtopic-main&gt;&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;&lt;subtopic-prefix&gt;&lt;subtopic-main&gt;&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;&lt;subtopic-main&gt;&lt;subtopic-suffix&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;subtopic-main&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Breaking Software&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Generating Software Tests&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Principles, Techniques and Tools&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;subtopic-prefix&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Tools and Techniques for &quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;subtopic-suffix&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot; for &lt;reader-property&gt; and &lt;reader-property&gt;&quot;</span><span class="p">,</span>
                          <span class="s2">&quot; for &lt;software-property&gt; and &lt;software-property&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;reader-property&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Fun&quot;</span><span class="p">,</span> <span class="s2">&quot;Profit&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;software-property&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Robustness&quot;</span><span class="p">,</span> <span class="s2">&quot;Reliability&quot;</span><span class="p">,</span> <span class="s2">&quot;Security&quot;</span><span class="p">],</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">syntax_diagram</span><span class="p">(</span><span class="n">TITLE_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>start
</pre></div>
</div>
<img alt="_images/447d7f96101130cf59f98104239e3a330a6c98ea1cfddd5b7ffe3792f890d6a4.svg" src="_images/447d7f96101130cf59f98104239e3a330a6c98ea1cfddd5b7ffe3792f890d6a4.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>title
</pre></div>
</div>
<img alt="_images/cf384900d3cb364e91c6022e5396ad035b75fb655ef82e60535865bb2e26a88f.svg" src="_images/cf384900d3cb364e91c6022e5396ad035b75fb655ef82e60535865bb2e26a88f.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>topic
</pre></div>
</div>
<img alt="_images/c5c9d3b9325e6709187d32a018b035ce27b29fc9750476b4146dd417c52683f6.svg" src="_images/c5c9d3b9325e6709187d32a018b035ce27b29fc9750476b4146dd417c52683f6.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fuzzing-prefix
</pre></div>
</div>
<img alt="_images/0ab6e52974bc7f533bca47453c7929681b76dd11cff5ba5ea06f89e9bdb51fb6.svg" src="_images/0ab6e52974bc7f533bca47453c7929681b76dd11cff5ba5ea06f89e9bdb51fb6.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>subtopic
</pre></div>
</div>
<img alt="_images/59c7c6276c860d41003ff58ffc643bf3d1258ea1a18e4f96c9a2497b6db9fa1c.svg" src="_images/59c7c6276c860d41003ff58ffc643bf3d1258ea1a18e4f96c9a2497b6db9fa1c.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>subtopic-main
</pre></div>
</div>
<img alt="_images/77f70a97cb05274a70ff114dc04730a9dd98c870eb789c315370791c16922901.svg" src="_images/77f70a97cb05274a70ff114dc04730a9dd98c870eb789c315370791c16922901.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>subtopic-prefix
</pre></div>
</div>
<img alt="_images/218052c87e1c08b03e57e7092c42422e17ae30d555f10749836dd2f7e3b5ab5a.svg" src="_images/218052c87e1c08b03e57e7092c42422e17ae30d555f10749836dd2f7e3b5ab5a.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>subtopic-suffix
</pre></div>
</div>
<img alt="_images/f05b4efa3ebcb1100645aaa82c737b1f59023b874cf0a7e8f2d2c8619369d1c0.svg" src="_images/f05b4efa3ebcb1100645aaa82c737b1f59023b874cf0a7e8f2d2c8619369d1c0.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>reader-property
</pre></div>
</div>
<img alt="_images/b75e31950f75e530646198b32f24d4f4ac633adf0ddc3a540c1e289f27a758f8.svg" src="_images/b75e31950f75e530646198b32f24d4f4ac633adf0ddc3a540c1e289f27a758f8.svg" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>software-property
</pre></div>
</div>
<img alt="_images/bc33413edb618782aa035a3e0bd340059d99a9d7fe360dee30fc8ee6a089242d.svg" src="_images/bc33413edb618782aa035a3e0bd340059d99a9d7fe360dee30fc8ee6a089242d.svg" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Set</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">titles</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">titles</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
    <span class="n">titles</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">simple_grammar_fuzzer</span><span class="p">(</span>
        <span class="n">grammar</span><span class="o">=</span><span class="n">TITLE_GRAMMAR</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="n">titles</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;Fuzzing: Generating Software Tests&#39;,
 &#39;Fuzzing: Principles, Techniques and Tools&#39;,
 &#39;Generating Software Tests: Breaking Software&#39;,
 &#39;Generating Software Tests: Breaking Software for Robustness and Robustness&#39;,
 &#39;Generating Software Tests: Principles, Techniques and Tools&#39;,
 &#39;Generating Software Tests: Principles, Techniques and Tools for Profit and Fun&#39;,
 &#39;Generating Software Tests: Tools and Techniques for Principles, Techniques and Tools&#39;,
 &#39;The Fuzzing Book: Breaking Software&#39;,
 &#39;The Fuzzing Book: Generating Software Tests for Profit and Profit&#39;,
 &#39;The Fuzzing Book: Generating Software Tests for Robustness and Robustness&#39;}
</pre></div>
</div>
</div>
</div>
<p>(If you find that there is redundancy (“Robustness and Robustness”) in here: In <a class="reference internal" href="GrammarCoverageFuzzer.html"><span class="std std-doc">our chapter on coverage-based fuzzing</span></a>, we will show how to cover each expansion only once.  And if you like some alternatives more than others, <a class="reference internal" href="ProbabilisticGrammarFuzzer.html"><span class="std std-doc">probabilistic grammar fuzzing</span></a> will be there for you.)</p>
</section>
</section>
<section id="grammars-as-mutation-seeds">
<h2>Grammars as Mutation Seeds<a class="headerlink" href="#grammars-as-mutation-seeds" title="Link to this heading">#</a></h2>
<p>One very useful property of grammars is that they produce mostly valid inputs.  From a syntactical standpoint, the inputs are actually <em>always</em> valid, as they satisfy the constraints of the given grammar.  (Of course, one needs a valid grammar in the first place.)  However, there are also <em>semantic</em> properties that cannot be easily expressed in a grammar.  If, say, for a URL, the port range is supposed to be between 1024 and 2048, this is hard to write in a grammar.  If one has to satisfy more complex constraints, one quickly reaches the limits of what a grammar can express.</p>
<p>One way around this is to attach constraints to grammars, as we will discuss <a class="reference internal" href="FuzzingWithConstraints.html"><span class="std std-doc">later in this book</span></a>.  Another possibility is to put together the strengths of grammar-based fuzzing and <a class="reference internal" href="MutationFuzzer.html"><span class="std std-doc">mutation-based fuzzing</span></a>.  The idea is to use the grammar-generated inputs as <em>seeds</em> for further mutation-based fuzzing.  This way, we can explore not only <em>valid</em> inputs, but also check out the <em>boundaries</em> between valid and invalid inputs.  This is particularly interesting as  slightly invalid inputs allow finding parser errors (which are often abundant).  As with fuzzing in general, it is the unexpected which reveals errors in programs.</p>
<p>To use our generated inputs as seeds, we can feed them directly into the mutation fuzzers introduced earlier:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">MutationFuzzer</span> <span class="kn">import</span> <span class="n">MutationFuzzer</span>  <span class="c1"># minor dependency</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">number_of_seeds</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">seeds</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">simple_grammar_fuzzer</span><span class="p">(</span>
        <span class="n">grammar</span><span class="o">=</span><span class="n">URL_GRAMMAR</span><span class="p">,</span>
        <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_seeds</span><span class="p">)]</span>
<span class="n">seeds</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;ftps://user:password@www.google.com:80&#39;,
 &#39;http://cispa.saarland/&#39;,
 &#39;ftp://www.google.com:42/&#39;,
 &#39;ftps://user:password@fuzzingbook.com:39?abc=abc&#39;,
 &#39;https://www.google.com?x33=1&amp;x06=1&#39;,
 &#39;http://www.google.com:02/&#39;,
 &#39;https://user:password@www.google.com/&#39;,
 &#39;ftp://cispa.saarland:8080/?abc=abc&amp;def=def&amp;abc=5&#39;,
 &#39;http://www.google.com:80/def?def=abc&#39;,
 &#39;http://user:password@cispa.saarland/&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">MutationFuzzer</span><span class="p">(</span><span class="n">seeds</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;ftps://user:password@www.google.com:80&#39;,
 &#39;http://cispa.saarland/&#39;,
 &#39;ftp://www.google.com:42/&#39;,
 &#39;ftps://user:password@fuzzingbook.com:39?abc=abc&#39;,
 &#39;https://www.google.com?x33=1&amp;x06=1&#39;,
 &#39;http://www.google.com:02/&#39;,
 &#39;https://user:password@www.google.com/&#39;,
 &#39;ftp://cispa.saarland:8080/?abc=abc&amp;def=def&amp;abc=5&#39;,
 &#39;http://www.google.com:80/def?def=abc&#39;,
 &#39;http://user:password@cispa.saarland/&#39;,
 &#39;Eh4tp:www.coogle.com:80/def?d%f=abc&#39;,
 &#39;ftps://}ser:passwod@fuzzingbook.com:9?abc=abc&#39;,
 &#39;uftp//cispa.sRaarland:808&amp;0?abc=abc&amp;def=defabc=5&#39;,
 &#39;http://user:paswor9d@cispar.saarland/v&#39;,
 &#39;ftp://Www.g\x7fogle.cAom:42/&#39;,
 &#39;hht://userC:qassMword@cispy.csaarland/&#39;,
 &#39;httx://ww.googlecom:80defde`f=ac&#39;,
 &#39;htt://cispq.waarlnd/&#39;,
 &#39;htFtp\t://cmspa./saarna(md/&#39;,
 &#39;ft:/www.google.com:42\x0f&#39;]
</pre></div>
</div>
</div>
</div>
<p>While the first 10 <code class="docutils literal notranslate"><span class="pre">fuzz()</span></code> calls return the seeded inputs (as designed), the later ones again create arbitrary mutations.  Using <code class="docutils literal notranslate"><span class="pre">MutationCoverageFuzzer</span></code> instead of <code class="docutils literal notranslate"><span class="pre">MutationFuzzer</span></code>, we could again have our search guided by coverage – and thus bring together the best of multiple worlds.</p>
</section>
<section id="a-grammar-toolbox">
<h2>A Grammar Toolbox<a class="headerlink" href="#a-grammar-toolbox" title="Link to this heading">#</a></h2>
<p>Let us now introduce a few techniques that help us writing grammars.</p>
<section id="escapes">
<h3>Escapes<a class="headerlink" href="#escapes" title="Link to this heading">#</a></h3>
<p>With <code class="docutils literal notranslate"><span class="pre">&lt;</span></code> and <code class="docutils literal notranslate"><span class="pre">&gt;</span></code> delimiting nonterminals in our grammars, how can we actually express that some input should contain <code class="docutils literal notranslate"><span class="pre">&lt;</span></code> and <code class="docutils literal notranslate"><span class="pre">&gt;</span></code>?  The answer is simple: Just introduce a symbol for them.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">simple_nonterminal_grammar</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;nonterminal&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;nonterminal&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;left-angle&gt;&lt;identifier&gt;&lt;right-angle&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;left-angle&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;right-angle&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;identifier&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>  <span class="c1"># for now</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>In <code class="docutils literal notranslate"><span class="pre">simple_nonterminal_grammar</span></code>, neither the expansion for <code class="docutils literal notranslate"><span class="pre">&lt;left-angle&gt;</span></code> nor the expansion for <code class="docutils literal notranslate"><span class="pre">&lt;right-angle&gt;</span></code> can be mistaken for a nonterminal. Hence, we can produce as many as we want.</p>
<p>(Note that this does not work with <code class="docutils literal notranslate"><span class="pre">simple_grammar_fuzzer()</span></code>, but rather with the <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code> class we’ll introduce in the next chapter.)</p>
</section>
<section id="extending-grammars">
<h3>Extending Grammars<a class="headerlink" href="#extending-grammars" title="Link to this heading">#</a></h3>
<p>In the course of this book, we frequently run into the issue of creating a grammar by <em>extending</em> an existing grammar with new features.  Such an extension is very much like subclassing in object-oriented programming.</p>
<p>To create a new grammar <span class="math notranslate nohighlight">\(g'\)</span> from an existing grammar <span class="math notranslate nohighlight">\(g\)</span>, we first copy <span class="math notranslate nohighlight">\(g\)</span> into <span class="math notranslate nohighlight">\(g'\)</span>, and then go and extend existing rules with new alternatives and/or add new symbols.  Here’s an example, extending the above <code class="docutils literal notranslate"><span class="pre">nonterminal</span></code> grammar with a better rule for identifiers:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">copy</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nonterminal_grammar</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">simple_nonterminal_grammar</span><span class="p">)</span>
<span class="n">nonterminal_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;identifier&gt;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&lt;idchar&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;identifier&gt;&lt;idchar&gt;&quot;</span><span class="p">]</span>
<span class="n">nonterminal_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;idchar&gt;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">]</span>  <span class="c1"># for now</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nonterminal_grammar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&lt;start&gt;&#39;: [&#39;&lt;nonterminal&gt;&#39;],
 &#39;&lt;nonterminal&gt;&#39;: [&#39;&lt;left-angle&gt;&lt;identifier&gt;&lt;right-angle&gt;&#39;],
 &#39;&lt;left-angle&gt;&#39;: [&#39;&lt;&#39;],
 &#39;&lt;right-angle&gt;&#39;: [&#39;&gt;&#39;],
 &#39;&lt;identifier&gt;&#39;: [&#39;&lt;idchar&gt;&#39;, &#39;&lt;identifier&gt;&lt;idchar&gt;&#39;],
 &#39;&lt;idchar&gt;&#39;: [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;]}
</pre></div>
</div>
</div>
</div>
<p>Since such an extension of grammars is a common operation, we introduce a custom function <code class="docutils literal notranslate"><span class="pre">extend_grammar()</span></code> which first copies the given grammar and then updates it from a dictionary, using the Python dictionary <code class="docutils literal notranslate"><span class="pre">update()</span></code> method:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">extend_grammar</span><span class="p">(</span><span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">,</span> <span class="n">extension</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="p">{})</span> <span class="o">-&gt;</span> <span class="n">Grammar</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a copy of `grammar`, updated with `extension`.&quot;&quot;&quot;</span>
    <span class="n">new_grammar</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>
    <span class="n">new_grammar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extension</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_grammar</span>
</pre></div>
</div>
</div>
</div>
<p>This call to <code class="docutils literal notranslate"><span class="pre">extend_grammar()</span></code> extends <code class="docutils literal notranslate"><span class="pre">simple_nonterminal_grammar</span></code> to <code class="docutils literal notranslate"><span class="pre">nonterminal_grammar</span></code> just like the “manual” example above:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nonterminal_grammar</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">simple_nonterminal_grammar</span><span class="p">,</span>
                                     <span class="p">{</span>
                                         <span class="s2">&quot;&lt;identifier&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;idchar&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;identifier&gt;&lt;idchar&gt;&quot;</span><span class="p">],</span>
                                         <span class="c1"># for now</span>
                                         <span class="s2">&quot;&lt;idchar&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">]</span>
                                     <span class="p">}</span>
                                     <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="character-classes">
<h3>Character Classes<a class="headerlink" href="#character-classes" title="Link to this heading">#</a></h3>
<p>In the above <code class="docutils literal notranslate"><span class="pre">nonterminal_grammar</span></code>, we have enumerated only the first few letters; indeed, enumerating all letters or digits in a grammar manually, as in <code class="docutils literal notranslate"><span class="pre">&lt;idchar&gt;</span> <span class="pre">::=</span> <span class="pre">'a'</span> <span class="pre">|</span> <span class="pre">'b'</span> <span class="pre">|</span> <span class="pre">'c'</span> <span class="pre">...</span></code> is a bit painful.</p>
<p>However, remember that grammars are part of a program, and can thus also be constructed programmatically.  We introduce a function <code class="docutils literal notranslate"><span class="pre">srange()</span></code> which constructs a list of characters in a string:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">string</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">srange</span><span class="p">(</span><span class="n">characters</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Expansion</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct a list with all characters in the string&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">characters</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>If we pass it the constant <code class="docutils literal notranslate"><span class="pre">string.ascii_letters</span></code>, which holds all ASCII letters, <code class="docutils literal notranslate"><span class="pre">srange()</span></code> returns a list of all ASCII letters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">srange</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39;, &#39;f&#39;, &#39;g&#39;, &#39;h&#39;, &#39;i&#39;, &#39;j&#39;]
</pre></div>
</div>
</div>
</div>
<p>We can use such constants in our grammar to quickly define identifiers:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nonterminal_grammar</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">nonterminal_grammar</span><span class="p">,</span>
                                     <span class="p">{</span>
                                         <span class="s2">&quot;&lt;idchar&gt;&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">srange</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">)</span> <span class="o">+</span> 
                                                      <span class="n">srange</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span> <span class="o">+</span> 
                                                      <span class="n">srange</span><span class="p">(</span><span class="s2">&quot;-_&quot;</span><span class="p">))</span>
                                     <span class="p">}</span>
                                     <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">simple_grammar_fuzzer</span><span class="p">(</span><span class="n">nonterminal_grammar</span><span class="p">,</span> <span class="s2">&quot;&lt;identifier&gt;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;b&#39;, &#39;d&#39;, &#39;V9&#39;, &#39;x4c&#39;, &#39;YdiEWj&#39;, &#39;c&#39;, &#39;xd&#39;, &#39;7&#39;, &#39;vIU&#39;, &#39;QhKD&#39;]
</pre></div>
</div>
</div>
</div>
<p>The shortcut <code class="docutils literal notranslate"><span class="pre">crange(start,</span> <span class="pre">end)</span></code> returns a list of all characters in the ASCII range of <code class="docutils literal notranslate"><span class="pre">start</span></code> to (including) <code class="docutils literal notranslate"><span class="pre">end</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">crange</span><span class="p">(</span><span class="n">character_start</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">character_end</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Expansion</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">character_start</span><span class="p">),</span> <span class="nb">ord</span><span class="p">(</span><span class="n">character_end</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>We can use this to express ranges of characters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crange</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">crange</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">srange</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="grammar-shortcuts">
<h3>Grammar Shortcuts<a class="headerlink" href="#grammar-shortcuts" title="Link to this heading">#</a></h3>
<p>In the above <code class="docutils literal notranslate"><span class="pre">nonterminal_grammar</span></code>, as in other grammars, we have to express repetitions of characters using <em>recursion</em>, that is, by referring to the original definition:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nonterminal_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;identifier&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;&lt;idchar&gt;&#39;, &#39;&lt;identifier&gt;&lt;idchar&gt;&#39;]
</pre></div>
</div>
</div>
</div>
<p>It could be a bit easier if we simply could state that a nonterminal should be a non-empty sequence of letters – for instance, as in</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">idchar</span><span class="o">&gt;+</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">+</span></code> denotes a non-empty repetition of the symbol it follows.</p>
<p>Operators such as <code class="docutils literal notranslate"><span class="pre">+</span></code> are frequently introduced as handy <em>shortcuts</em> in grammars.  Formally, our grammars come in the so-called <a class="reference external" href="https://en.wikipedia.org/wiki/Backus-Naur_form">Backus-Naur form</a>, or <em>BNF</em> for short.  Operators <em>extend</em> BNF to so-called _extended BNF*, or <em>EBNF</em> for short:</p>
<ul class="simple">
<li><p>The form <code class="docutils literal notranslate"><span class="pre">&lt;symbol&gt;?</span></code> indicates that <code class="docutils literal notranslate"><span class="pre">&lt;symbol&gt;</span></code> is optional – that is, it can occur 0 or 1 times.</p></li>
<li><p>The form <code class="docutils literal notranslate"><span class="pre">&lt;symbol&gt;+</span></code> indicates that <code class="docutils literal notranslate"><span class="pre">&lt;symbol&gt;</span></code> can occur 1 or more times repeatedly.</p></li>
<li><p>The form <code class="docutils literal notranslate"><span class="pre">&lt;symbol&gt;*</span></code> indicates that <code class="docutils literal notranslate"><span class="pre">&lt;symbol&gt;</span></code> can occur 0 or more times.  (In other words, it is an optional repetition.)</p></li>
</ul>
<p>To make matters even more interesting, we would like to use <em>parentheses</em> with the above shortcuts.  Thus, <code class="docutils literal notranslate"><span class="pre">(&lt;foo&gt;&lt;bar&gt;)?</span></code> indicates that the sequence of <code class="docutils literal notranslate"><span class="pre">&lt;foo&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">&lt;bar&gt;</span></code> is optional.</p>
<p>Using such operators, we can define the identifier rule in a simpler way.  To this end, let us create a copy of the original grammar and modify the <code class="docutils literal notranslate"><span class="pre">&lt;identifier&gt;</span></code> rule:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nonterminal_ebnf_grammar</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">nonterminal_grammar</span><span class="p">,</span>
                                          <span class="p">{</span>
                                              <span class="s2">&quot;&lt;identifier&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;idchar&gt;+&quot;</span><span class="p">]</span>
                                          <span class="p">}</span>
                                          <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Likewise, we can simplify the expression grammar.  Consider how signs are optional, and how integers can be expressed as sequences of digits.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EXPR_EBNF_GRAMMAR</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;expr&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;expr&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;term&gt; + &lt;expr&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;term&gt; - &lt;expr&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;term&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;term&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;factor&gt; * &lt;term&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;factor&gt; / &lt;term&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;factor&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;factor&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;sign&gt;?&lt;factor&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;(&lt;expr&gt;)&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;integer&gt;(.&lt;integer&gt;)?&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;sign&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;integer&gt;&quot;</span><span class="p">:</span>
        <span class="p">[</span><span class="s2">&quot;&lt;digit&gt;+&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">:</span>
        <span class="n">srange</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Let us implement a function <code class="docutils literal notranslate"><span class="pre">convert_ebnf_grammar()</span></code> that takes such an EBNF grammar and automatically translates it into a BNF grammar.</p>
<section id="excursion-implementing-convert-ebnf-grammar">
<h4>Excursion: Implementing <code class="docutils literal notranslate"><span class="pre">convert_ebnf_grammar()</span></code><a class="headerlink" href="#excursion-implementing-convert-ebnf-grammar" title="Link to this heading">#</a></h4>
<p>Our aim is to convert EBNF grammars such as the ones above into a regular BNF grammar.  This is done by four rules:</p>
<ol class="arabic simple">
<li><p>An expression <code class="docutils literal notranslate"><span class="pre">(content)op</span></code>, where <code class="docutils literal notranslate"><span class="pre">op</span></code> is one of <code class="docutils literal notranslate"><span class="pre">?</span></code>, <code class="docutils literal notranslate"><span class="pre">+</span></code>, <code class="docutils literal notranslate"><span class="pre">*</span></code>, becomes <code class="docutils literal notranslate"><span class="pre">&lt;new-symbol&gt;op</span></code>, with a new rule <code class="docutils literal notranslate"><span class="pre">&lt;new-symbol&gt;</span> <span class="pre">::=</span> <span class="pre">content</span></code>.</p></li>
<li><p>An expression <code class="docutils literal notranslate"><span class="pre">&lt;symbol&gt;?</span></code> becomes <code class="docutils literal notranslate"><span class="pre">&lt;new-symbol&gt;</span></code>, where <code class="docutils literal notranslate"><span class="pre">&lt;new-symbol&gt;</span> <span class="pre">::=</span> <span class="pre">&lt;empty&gt;</span> <span class="pre">|</span> <span class="pre">&lt;symbol&gt;</span></code>.</p></li>
<li><p>An expression <code class="docutils literal notranslate"><span class="pre">&lt;symbol&gt;+</span></code> becomes <code class="docutils literal notranslate"><span class="pre">&lt;new-symbol&gt;</span></code>, where <code class="docutils literal notranslate"><span class="pre">&lt;new-symbol&gt;</span> <span class="pre">::=</span> <span class="pre">&lt;symbol&gt;</span> <span class="pre">|</span> <span class="pre">&lt;symbol&gt;&lt;new-symbol&gt;</span></code>.</p></li>
<li><p>An expression <code class="docutils literal notranslate"><span class="pre">&lt;symbol&gt;*</span></code> becomes <code class="docutils literal notranslate"><span class="pre">&lt;new-symbol&gt;</span></code>, where <code class="docutils literal notranslate"><span class="pre">&lt;new-symbol&gt;</span> <span class="pre">::=</span> <span class="pre">&lt;empty&gt;</span> <span class="pre">|</span> <span class="pre">&lt;symbol&gt;&lt;new-symbol&gt;</span></code>.</p></li>
</ol>
<p>Here, <code class="docutils literal notranslate"><span class="pre">&lt;empty&gt;</span></code> expands to the empty string, as in <code class="docutils literal notranslate"><span class="pre">&lt;empty&gt;</span> <span class="pre">::=</span> </code>.  (This is also called an <em>epsilon expansion</em>.)</p>
<p>If these operators remind you of <em>regular expressions</em>, this is not by accident: Actually, any basic regular expression can be converted into a grammar using the above rules (and character classes with <code class="docutils literal notranslate"><span class="pre">crange()</span></code>, as defined above).</p>
<p>Applying these rules on the examples above yields the following results:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;idchar&gt;+</span></code> becomes <code class="docutils literal notranslate"><span class="pre">&lt;idchar&gt;&lt;new-symbol&gt;</span></code> with <code class="docutils literal notranslate"><span class="pre">&lt;new-symbol&gt;</span> <span class="pre">::=</span> <span class="pre">&lt;idchar&gt;</span> <span class="pre">|</span> <span class="pre">&lt;idchar&gt;&lt;new-symbol&gt;</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;integer&gt;(.&lt;integer&gt;)?</span></code> becomes <code class="docutils literal notranslate"><span class="pre">&lt;integer&gt;&lt;new-symbol&gt;</span></code> with <code class="docutils literal notranslate"><span class="pre">&lt;new-symbol&gt;</span> <span class="pre">::=</span> <span class="pre">&lt;empty&gt;</span> <span class="pre">|</span> <span class="pre">.&lt;integer&gt;</span></code>.</p></li>
</ul>
<p>Let us implement these rules in three steps.</p>
<section id="creating-new-symbols">
<h5>Creating New Symbols<a class="headerlink" href="#creating-new-symbols" title="Link to this heading">#</a></h5>
<p>First, we need a mechanism to create new symbols.  This is fairly straightforward.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">new_symbol</span><span class="p">(</span><span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">,</span> <span class="n">symbol_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&lt;symbol&gt;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a new symbol for `grammar` based on `symbol_name`&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">symbol_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grammar</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">symbol_name</span>

    <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">tentative_symbol_name</span> <span class="o">=</span> <span class="n">symbol_name</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span>
        <span class="k">if</span> <span class="n">tentative_symbol_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grammar</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tentative_symbol_name</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">new_symbol</span><span class="p">(</span><span class="n">EXPR_EBNF_GRAMMAR</span><span class="p">,</span> <span class="s1">&#39;&lt;expr&gt;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&lt;expr-1&gt;&#39;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="expanding-parenthesized-expressions">
<h5>Expanding Parenthesized Expressions<a class="headerlink" href="#expanding-parenthesized-expressions" title="Link to this heading">#</a></h5>
<p>Next, we need a means to extract parenthesized expressions from our expansions and expand them according to the rules above.  Let’s start with extracting expressions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RE_PARENTHESIZED_EXPR</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\([^()]*\)[?+*]&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">parenthesized_expressions</span><span class="p">(</span><span class="n">expansion</span><span class="p">:</span> <span class="n">Expansion</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="c1"># In later chapters, we allow expansions to be tuples,</span>
    <span class="c1"># with the expansion being the first element</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expansion</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">expansion</span> <span class="o">=</span> <span class="n">expansion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">RE_PARENTHESIZED_EXPR</span><span class="p">,</span> <span class="n">expansion</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">parenthesized_expressions</span><span class="p">(</span><span class="s2">&quot;(&lt;foo&gt;)* (&lt;foo&gt;&lt;bar&gt;)+ (+&lt;foo&gt;)? &lt;integer&gt;(.&lt;integer&gt;)?&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span>
    <span class="s1">&#39;(&lt;foo&gt;)*&#39;</span><span class="p">,</span> <span class="s1">&#39;(&lt;foo&gt;&lt;bar&gt;)+&#39;</span><span class="p">,</span> <span class="s1">&#39;(+&lt;foo&gt;)?&#39;</span><span class="p">,</span> <span class="s1">&#39;(.&lt;integer&gt;)?&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We can now use these to apply rule number 1, above, introducing new symbols for expressions in parentheses.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">convert_ebnf_parentheses</span><span class="p">(</span><span class="n">ebnf_grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Grammar</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a grammar in extended BNF to BNF&quot;&quot;&quot;</span>
    <span class="n">grammar</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">ebnf_grammar</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">nonterminal</span> <span class="ow">in</span> <span class="n">ebnf_grammar</span><span class="p">:</span>
        <span class="n">expansions</span> <span class="o">=</span> <span class="n">ebnf_grammar</span><span class="p">[</span><span class="n">nonterminal</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">expansions</span><span class="p">)):</span>
            <span class="n">expansion</span> <span class="o">=</span> <span class="n">expansions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expansion</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">expansion</span> <span class="o">=</span> <span class="n">expansion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">parenthesized_exprs</span> <span class="o">=</span> <span class="n">parenthesized_expressions</span><span class="p">(</span><span class="n">expansion</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parenthesized_exprs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">parenthesized_exprs</span><span class="p">:</span>
                    <span class="n">operator</span> <span class="o">=</span> <span class="n">expr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="n">contents</span> <span class="o">=</span> <span class="n">expr</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

                    <span class="n">new_sym</span> <span class="o">=</span> <span class="n">new_symbol</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>

                    <span class="n">exp</span> <span class="o">=</span> <span class="n">grammar</span><span class="p">[</span><span class="n">nonterminal</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">opts</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                        <span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span> <span class="o">=</span> <span class="n">exp</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

                    <span class="n">expansion</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">new_sym</span> <span class="o">+</span> <span class="n">operator</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">opts</span><span class="p">:</span>
                        <span class="n">grammar</span><span class="p">[</span><span class="n">nonterminal</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">expansion</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">grammar</span><span class="p">[</span><span class="n">nonterminal</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">expansion</span>

                    <span class="n">grammar</span><span class="p">[</span><span class="n">new_sym</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">contents</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">grammar</span>
</pre></div>
</div>
</div>
</div>
<p>This does the conversion as sketched above:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">convert_ebnf_parentheses</span><span class="p">({</span><span class="s2">&quot;&lt;number&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;integer&gt;(.&lt;integer&gt;)?&quot;</span><span class="p">]})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&lt;number&gt;&#39;: [&#39;&lt;integer&gt;&lt;symbol&gt;?&#39;], &#39;&lt;symbol&gt;&#39;: [&#39;.&lt;integer&gt;&#39;]}
</pre></div>
</div>
</div>
</div>
<p>It even works for nested parenthesized expressions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">convert_ebnf_parentheses</span><span class="p">({</span><span class="s2">&quot;&lt;foo&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;((&lt;foo&gt;)?)+&quot;</span><span class="p">]})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&lt;foo&gt;&#39;: [&#39;&lt;symbol-1&gt;+&#39;], &#39;&lt;symbol&gt;&#39;: [&#39;&lt;foo&gt;&#39;], &#39;&lt;symbol-1&gt;&#39;: [&#39;&lt;symbol&gt;?&#39;]}
</pre></div>
</div>
</div>
</div>
</section>
<section id="expanding-operators">
<h5>Expanding Operators<a class="headerlink" href="#expanding-operators" title="Link to this heading">#</a></h5>
<p>After expanding parenthesized expressions, we now need to take care of symbols followed by operators (<code class="docutils literal notranslate"><span class="pre">?</span></code>, <code class="docutils literal notranslate"><span class="pre">*</span></code>, <code class="docutils literal notranslate"><span class="pre">+</span></code>).  As with <code class="docutils literal notranslate"><span class="pre">convert_ebnf_parentheses()</span></code>, above, we first extract all symbols followed by an operator.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RE_EXTENDED_NONTERMINAL</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(&lt;[^&lt;&gt; ]*&gt;[?+*])&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">extended_nonterminals</span><span class="p">(</span><span class="n">expansion</span><span class="p">:</span> <span class="n">Expansion</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="c1"># In later chapters, we allow expansions to be tuples,</span>
    <span class="c1"># with the expansion being the first element</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expansion</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">expansion</span> <span class="o">=</span> <span class="n">expansion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">RE_EXTENDED_NONTERMINAL</span><span class="p">,</span> <span class="n">expansion</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">extended_nonterminals</span><span class="p">(</span>
    <span class="s2">&quot;&lt;foo&gt;* &lt;bar&gt;+ &lt;elem&gt;? &lt;none&gt;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;&lt;foo&gt;*&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;bar&gt;+&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;elem&gt;?&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Our converter extracts the symbol and the operator, and adds new symbols according to the rules laid out above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">convert_ebnf_operators</span><span class="p">(</span><span class="n">ebnf_grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Grammar</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a grammar in extended BNF to BNF&quot;&quot;&quot;</span>
    <span class="n">grammar</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">ebnf_grammar</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">nonterminal</span> <span class="ow">in</span> <span class="n">ebnf_grammar</span><span class="p">:</span>
        <span class="n">expansions</span> <span class="o">=</span> <span class="n">ebnf_grammar</span><span class="p">[</span><span class="n">nonterminal</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">expansions</span><span class="p">)):</span>
            <span class="n">expansion</span> <span class="o">=</span> <span class="n">expansions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">extended_symbols</span> <span class="o">=</span> <span class="n">extended_nonterminals</span><span class="p">(</span><span class="n">expansion</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">extended_symbol</span> <span class="ow">in</span> <span class="n">extended_symbols</span><span class="p">:</span>
                <span class="n">operator</span> <span class="o">=</span> <span class="n">extended_symbol</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">original_symbol</span> <span class="o">=</span> <span class="n">extended_symbol</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">assert</span> <span class="n">original_symbol</span> <span class="ow">in</span> <span class="n">ebnf_grammar</span><span class="p">,</span> \
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">original_symbol</span><span class="si">}</span><span class="s2"> is not defined in grammar&quot;</span>

                <span class="n">new_sym</span> <span class="o">=</span> <span class="n">new_symbol</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span> <span class="n">original_symbol</span><span class="p">)</span>

                <span class="n">exp</span> <span class="o">=</span> <span class="n">grammar</span><span class="p">[</span><span class="n">nonterminal</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">opts</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span> <span class="o">=</span> <span class="n">exp</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

                <span class="n">new_exp</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">extended_symbol</span><span class="p">,</span> <span class="n">new_sym</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">opts</span><span class="p">:</span>
                    <span class="n">grammar</span><span class="p">[</span><span class="n">nonterminal</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_exp</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">grammar</span><span class="p">[</span><span class="n">nonterminal</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_exp</span>

                <span class="k">if</span> <span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;?&#39;</span><span class="p">:</span>
                    <span class="n">grammar</span><span class="p">[</span><span class="n">new_sym</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">original_symbol</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
                    <span class="n">grammar</span><span class="p">[</span><span class="n">new_sym</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">original_symbol</span> <span class="o">+</span> <span class="n">new_sym</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                    <span class="n">grammar</span><span class="p">[</span><span class="n">new_sym</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">original_symbol</span><span class="p">,</span> <span class="n">original_symbol</span> <span class="o">+</span> <span class="n">new_sym</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">grammar</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">convert_ebnf_operators</span><span class="p">({</span><span class="s2">&quot;&lt;integer&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;digit&gt;+&quot;</span><span class="p">],</span> <span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">]})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&lt;integer&gt;&#39;: [&#39;&lt;digit-1&gt;&#39;],
 &#39;&lt;digit&gt;&#39;: [&#39;0&#39;],
 &#39;&lt;digit-1&gt;&#39;: [&#39;&lt;digit&gt;&#39;, &#39;&lt;digit&gt;&lt;digit-1&gt;&#39;]}
</pre></div>
</div>
</div>
</div>
</section>
<section id="all-together">
<h5>All Together<a class="headerlink" href="#all-together" title="Link to this heading">#</a></h5>
<p>We can combine the two, first extending parentheses and then operators:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">convert_ebnf_grammar</span><span class="p">(</span><span class="n">ebnf_grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Grammar</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">convert_ebnf_operators</span><span class="p">(</span><span class="n">convert_ebnf_parentheses</span><span class="p">(</span><span class="n">ebnf_grammar</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id2">
<h4>End of Excursion<a class="headerlink" href="#id2" title="Link to this heading">#</a></h4>
<p>Here’s an example of using <code class="docutils literal notranslate"><span class="pre">convert_ebnf_grammar()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">convert_ebnf_grammar</span><span class="p">({</span><span class="s2">&quot;&lt;authority&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;(&lt;userinfo&gt;@)?&lt;host&gt;(:&lt;port&gt;)?&quot;</span><span class="p">]})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&lt;authority&gt;&#39;: [&#39;&lt;symbol-2&gt;&lt;host&gt;&lt;symbol-1-1&gt;&#39;],
 &#39;&lt;symbol&gt;&#39;: [&#39;&lt;userinfo&gt;@&#39;],
 &#39;&lt;symbol-1&gt;&#39;: [&#39;:&lt;port&gt;&#39;],
 &#39;&lt;symbol-2&gt;&#39;: [&#39;&#39;, &#39;&lt;symbol&gt;&#39;],
 &#39;&lt;symbol-1-1&gt;&#39;: [&#39;&#39;, &#39;&lt;symbol-1&gt;&#39;]}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">expr_grammar</span> <span class="o">=</span> <span class="n">convert_ebnf_grammar</span><span class="p">(</span><span class="n">EXPR_EBNF_GRAMMAR</span><span class="p">)</span>
<span class="n">expr_grammar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&lt;start&gt;&#39;: [&#39;&lt;expr&gt;&#39;],
 &#39;&lt;expr&gt;&#39;: [&#39;&lt;term&gt; + &lt;expr&gt;&#39;, &#39;&lt;term&gt; - &lt;expr&gt;&#39;, &#39;&lt;term&gt;&#39;],
 &#39;&lt;term&gt;&#39;: [&#39;&lt;factor&gt; * &lt;term&gt;&#39;, &#39;&lt;factor&gt; / &lt;term&gt;&#39;, &#39;&lt;factor&gt;&#39;],
 &#39;&lt;factor&gt;&#39;: [&#39;&lt;sign-1&gt;&lt;factor&gt;&#39;, &#39;(&lt;expr&gt;)&#39;, &#39;&lt;integer&gt;&lt;symbol-1&gt;&#39;],
 &#39;&lt;sign&gt;&#39;: [&#39;+&#39;, &#39;-&#39;],
 &#39;&lt;integer&gt;&#39;: [&#39;&lt;digit-1&gt;&#39;],
 &#39;&lt;digit&gt;&#39;: [&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;],
 &#39;&lt;symbol&gt;&#39;: [&#39;.&lt;integer&gt;&#39;],
 &#39;&lt;sign-1&gt;&#39;: [&#39;&#39;, &#39;&lt;sign&gt;&#39;],
 &#39;&lt;symbol-1&gt;&#39;: [&#39;&#39;, &#39;&lt;symbol&gt;&#39;],
 &#39;&lt;digit-1&gt;&#39;: [&#39;&lt;digit&gt;&#39;, &#39;&lt;digit&gt;&lt;digit-1&gt;&#39;]}
</pre></div>
</div>
</div>
</div>
<p>Success! We have nicely converted the EBNF grammar into BNF.</p>
<p>With character classes and EBNF grammar conversion, we have two powerful tools that make the writing of grammars easier.  We will use these again and again as it comes to working with grammars.</p>
</section>
</section>
<section id="grammar-extensions">
<h3>Grammar Extensions<a class="headerlink" href="#grammar-extensions" title="Link to this heading">#</a></h3>
<p>During the course of this book, we frequently want to specify <em>additional information</em> for grammars, such as <a class="reference internal" href="ProbabilisticGrammarFuzzer.html"><span class="std std-doc"><em>probabilities</em></span></a> or <a class="reference internal" href="GeneratorGrammarFuzzer.html"><span class="std std-doc"><em>constraints</em></span></a>.  To support these extensions, as well as possibly others, we define an <em>annotation</em> mechanism.</p>
<p>Our concept for annotating grammars is to add <em>annotations</em> to individual expansions.  To this end, we allow that an expansion cannot only be a string, but also a <em>pair</em> of a string and a set of attributes, as in</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="s2">&quot;&lt;expr&gt;&quot;</span><span class="p">:</span>
        <span class="p">[(</span><span class="s2">&quot;&lt;term&gt; + &lt;expr&gt;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span><span class="n">min_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">)),</span>
         <span class="p">(</span><span class="s2">&quot;&lt;term&gt; - &lt;expr&gt;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">2</span><span class="p">)),</span>
         <span class="s2">&quot;&lt;term&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>Here, the <code class="docutils literal notranslate"><span class="pre">opts()</span></code> function would allow us to express annotations that apply to the individual expansions; in this case, the addition would be annotated with a <code class="docutils literal notranslate"><span class="pre">min_depth</span></code> value of 10, and the subtraction with a <code class="docutils literal notranslate"><span class="pre">max_depth</span></code> value of 2.  The meaning of these annotations is left to the individual algorithms dealing with the grammars; the general idea, though, is that they can be ignored.</p>
<section id="excursion-implementing-opts">
<h4>Excursion: Implementing <code class="docutils literal notranslate"><span class="pre">opts()</span></code><a class="headerlink" href="#excursion-implementing-opts" title="Link to this heading">#</a></h4>
<p>Our <code class="docutils literal notranslate"><span class="pre">opts()</span></code> helper function returns a mapping of its arguments to values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">opts</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">kwargs</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">opts</span><span class="p">(</span><span class="n">min_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;min_depth&#39;: 10}
</pre></div>
</div>
</div>
</div>
<p>To deal with both expansion strings and pairs of expansions and annotations, we access the expansion string and the associated annotations via designated helper functions, <code class="docutils literal notranslate"><span class="pre">exp_string()</span></code> and <code class="docutils literal notranslate"><span class="pre">exp_opts()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">exp_string</span><span class="p">(</span><span class="n">expansion</span><span class="p">:</span> <span class="n">Expansion</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the string to be expanded&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expansion</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">expansion</span>
    <span class="k">return</span> <span class="n">expansion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exp_string</span><span class="p">((</span><span class="s2">&quot;&lt;term&gt; + &lt;expr&gt;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span><span class="n">min_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;&lt;term&gt; + &lt;expr&gt;&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">exp_opts</span><span class="p">(</span><span class="n">expansion</span><span class="p">:</span> <span class="n">Expansion</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the options of an expansion.  If options are not defined, return {}&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expansion</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="n">expansion</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">exp_opt</span><span class="p">(</span><span class="n">expansion</span><span class="p">:</span> <span class="n">Expansion</span><span class="p">,</span> <span class="n">attribute</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the given attribution of an expansion.</span>
<span class="sd">    If attribute is not defined, return None&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">exp_opts</span><span class="p">(</span><span class="n">expansion</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exp_opts</span><span class="p">((</span><span class="s2">&quot;&lt;term&gt; + &lt;expr&gt;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span><span class="n">min_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;min_depth&#39;: 10}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exp_opt</span><span class="p">((</span><span class="s2">&quot;&lt;term&gt; - &lt;expr&gt;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">2</span><span class="p">)),</span> <span class="s1">&#39;max_depth&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2
</pre></div>
</div>
</div>
</div>
<p>Finally, we define a helper function that sets a particular option:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">set_opts</span><span class="p">(</span><span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expansion</span><span class="p">:</span> <span class="n">Expansion</span><span class="p">,</span> 
             <span class="n">opts</span><span class="p">:</span> <span class="n">Option</span> <span class="o">=</span> <span class="p">{})</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the options of the given expansion of grammar[symbol] to opts&quot;&quot;&quot;</span>
    <span class="n">expansions</span> <span class="o">=</span> <span class="n">grammar</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">exp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">expansions</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exp_string</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">exp_string</span><span class="p">(</span><span class="n">expansion</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">new_opts</span> <span class="o">=</span> <span class="n">exp_opts</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">opts</span> <span class="o">==</span> <span class="p">{}</span> <span class="ow">or</span> <span class="n">new_opts</span> <span class="o">==</span> <span class="p">{}:</span>
            <span class="n">new_opts</span> <span class="o">=</span> <span class="n">opts</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
                <span class="n">new_opts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">opts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">new_opts</span> <span class="o">==</span> <span class="p">{}:</span>
            <span class="n">grammar</span><span class="p">[</span><span class="n">symbol</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp_string</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grammar</span><span class="p">[</span><span class="n">symbol</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">exp_string</span><span class="p">(</span><span class="n">exp</span><span class="p">),</span> <span class="n">new_opts</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
        <span class="s2">&quot;no expansion &quot;</span> <span class="o">+</span>
        <span class="nb">repr</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span> <span class="o">+</span>
        <span class="s2">&quot; -&gt; &quot;</span> <span class="o">+</span>
        <span class="nb">repr</span><span class="p">(</span>
            <span class="n">exp_string</span><span class="p">(</span><span class="n">expansion</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id3">
<h4>End of Excursion<a class="headerlink" href="#id3" title="Link to this heading">#</a></h4>
</section>
</section>
</section>
<section id="checking-grammars">
<h2>Checking Grammars<a class="headerlink" href="#checking-grammars" title="Link to this heading">#</a></h2>
<p>Since grammars are represented as strings, it is fairly easy to introduce errors.  So let us introduce a helper function that checks a grammar for consistency.</p>
<p>The helper function <code class="docutils literal notranslate"><span class="pre">is_valid_grammar()</span></code> iterates over a grammar to check whether all used symbols are defined, and vice versa, which is very useful for debugging; it also checks whether all symbols are reachable from the start symbol.  You don’t have to delve into details here, but as always, it is important to get the input data straight before we make use of it.</p>
<section id="excursion-implementing-is-valid-grammar">
<h3>Excursion: Implementing <code class="docutils literal notranslate"><span class="pre">is_valid_grammar()</span></code><a class="headerlink" href="#excursion-implementing-is-valid-grammar" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">def_used_nonterminals</span><span class="p">(</span><span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">,</span> <span class="n">start_symbol</span><span class="p">:</span> 
                          <span class="nb">str</span> <span class="o">=</span> <span class="n">START_SYMBOL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> 
                                                       <span class="n">Optional</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a pair (`defined_nonterminals`, `used_nonterminals`) in `grammar`.</span>
<span class="sd">    In case of error, return (`None`, `None`).&quot;&quot;&quot;</span>

    <span class="n">defined_nonterminals</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">used_nonterminals</span> <span class="o">=</span> <span class="p">{</span><span class="n">start_symbol</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">defined_nonterminal</span> <span class="ow">in</span> <span class="n">grammar</span><span class="p">:</span>
        <span class="n">defined_nonterminals</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">defined_nonterminal</span><span class="p">)</span>
        <span class="n">expansions</span> <span class="o">=</span> <span class="n">grammar</span><span class="p">[</span><span class="n">defined_nonterminal</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expansions</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">defined_nonterminal</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: expansion is not a list&quot;</span><span class="p">,</span>
                  <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">expansions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">defined_nonterminal</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: expansion list empty&quot;</span><span class="p">,</span>
                  <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">expansion</span> <span class="ow">in</span> <span class="n">expansions</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expansion</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">expansion</span> <span class="o">=</span> <span class="n">expansion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expansion</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">defined_nonterminal</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span>
                      <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">expansion</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: not a string&quot;</span><span class="p">,</span>
                      <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">used_nonterminal</span> <span class="ow">in</span> <span class="n">nonterminals</span><span class="p">(</span><span class="n">expansion</span><span class="p">):</span>
                <span class="n">used_nonterminals</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">used_nonterminal</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">defined_nonterminals</span><span class="p">,</span> <span class="n">used_nonterminals</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">reachable_nonterminals</span><span class="p">(</span><span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">,</span>
                           <span class="n">start_symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">START_SYMBOL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">reachable</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_find_reachable_nonterminals</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">reachable</span>
        <span class="n">reachable</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expansion</span> <span class="ow">in</span> <span class="n">grammar</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">for</span> <span class="n">nonterminal</span> <span class="ow">in</span> <span class="n">nonterminals</span><span class="p">(</span><span class="n">expansion</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">nonterminal</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reachable</span><span class="p">:</span>
                    <span class="n">_find_reachable_nonterminals</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span> <span class="n">nonterminal</span><span class="p">)</span>

    <span class="n">_find_reachable_nonterminals</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span> <span class="n">start_symbol</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">reachable</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">unreachable_nonterminals</span><span class="p">(</span><span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">,</span>
                             <span class="n">start_symbol</span><span class="o">=</span><span class="n">START_SYMBOL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">grammar</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">-</span> <span class="n">reachable_nonterminals</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span> <span class="n">start_symbol</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">opts_used</span><span class="p">(</span><span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">used_opts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">grammar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">expansion</span> <span class="ow">in</span> <span class="n">grammar</span><span class="p">[</span><span class="n">symbol</span><span class="p">]:</span>
            <span class="n">used_opts</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">exp_opts</span><span class="p">(</span><span class="n">expansion</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">used_opts</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">is_valid_grammar</span><span class="p">(</span><span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">,</span>
                     <span class="n">start_symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">START_SYMBOL</span><span class="p">,</span> 
                     <span class="n">supported_opts</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the given `grammar` is valid.</span>
<span class="sd">       `start_symbol`: optional start symbol (default: `&lt;start&gt;`)</span>
<span class="sd">       `supported_opts`: options supported (default: none)&quot;&quot;&quot;</span>

    <span class="n">defined_nonterminals</span><span class="p">,</span> <span class="n">used_nonterminals</span> <span class="o">=</span> \
        <span class="n">def_used_nonterminals</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span> <span class="n">start_symbol</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">defined_nonterminals</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">used_nonterminals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Do not complain about &#39;&lt;start&gt;&#39; being not used,</span>
    <span class="c1"># even if start_symbol is different</span>
    <span class="k">if</span> <span class="n">START_SYMBOL</span> <span class="ow">in</span> <span class="n">grammar</span><span class="p">:</span>
        <span class="n">used_nonterminals</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">START_SYMBOL</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">unused_nonterminal</span> <span class="ow">in</span> <span class="n">defined_nonterminals</span> <span class="o">-</span> <span class="n">used_nonterminals</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">unused_nonterminal</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: defined, but not used. Consider applying trim_grammar() on the grammar&quot;</span><span class="p">,</span>
              <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">undefined_nonterminal</span> <span class="ow">in</span> <span class="n">used_nonterminals</span> <span class="o">-</span> <span class="n">defined_nonterminals</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">undefined_nonterminal</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: used, but not defined&quot;</span><span class="p">,</span>
              <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

    <span class="c1"># Symbols must be reachable either from &lt;start&gt; or given start symbol</span>
    <span class="n">unreachable</span> <span class="o">=</span> <span class="n">unreachable_nonterminals</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span> <span class="n">start_symbol</span><span class="p">)</span>
    <span class="n">msg_start_symbol</span> <span class="o">=</span> <span class="n">start_symbol</span>

    <span class="k">if</span> <span class="n">START_SYMBOL</span> <span class="ow">in</span> <span class="n">grammar</span><span class="p">:</span>
        <span class="n">unreachable</span> <span class="o">=</span> <span class="n">unreachable</span> <span class="o">-</span> \
            <span class="n">reachable_nonterminals</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span> <span class="n">START_SYMBOL</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start_symbol</span> <span class="o">!=</span> <span class="n">START_SYMBOL</span><span class="p">:</span>
            <span class="n">msg_start_symbol</span> <span class="o">+=</span> <span class="s2">&quot; or &quot;</span> <span class="o">+</span> <span class="n">START_SYMBOL</span>

    <span class="k">for</span> <span class="n">unreachable_nonterminal</span> <span class="ow">in</span> <span class="n">unreachable</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">unreachable_nonterminal</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: unreachable from &quot;</span> <span class="o">+</span> <span class="n">msg_start_symbol</span> <span class="o">+</span> <span class="s2">&quot;. Consider applying trim_grammar() on the grammar&quot;</span><span class="p">,</span>
              <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

    <span class="n">used_but_not_supported_opts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">supported_opts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">used_but_not_supported_opts</span> <span class="o">=</span> <span class="n">opts_used</span><span class="p">(</span>
            <span class="n">grammar</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">supported_opts</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">used_but_not_supported_opts</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;warning: option &quot;</span> <span class="o">+</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot; is not supported&quot;</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">used_nonterminals</span> <span class="o">==</span> <span class="n">defined_nonterminals</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">unreachable</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<p>To make a grammar suitable for <code class="docutils literal notranslate"><span class="pre">is_valid_grammar()</span></code>, the following function may be useful.
The function <code class="docutils literal notranslate"><span class="pre">trim_grammar()</span></code> automatically <em>removes</em> rules for nonterminals that are no longer needed.
This is useful if you have added new rules that <em>remove</em> some extensions, rendering some nonterminals obsolete.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">trim_grammar</span><span class="p">(</span><span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">,</span> <span class="n">start_symbol</span><span class="o">=</span><span class="n">START_SYMBOL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Grammar</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a copy of `grammar` where all unused and unreachable nonterminals are removed.&quot;&quot;&quot;</span>
    <span class="n">new_grammar</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>
    <span class="n">defined_nonterminals</span><span class="p">,</span> <span class="n">used_nonterminals</span> <span class="o">=</span> \
        <span class="n">def_used_nonterminals</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span> <span class="n">start_symbol</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">defined_nonterminals</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">used_nonterminals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_grammar</span>

    <span class="n">unused</span> <span class="o">=</span> <span class="n">defined_nonterminals</span> <span class="o">-</span> <span class="n">used_nonterminals</span>
    <span class="n">unreachable</span> <span class="o">=</span> <span class="n">unreachable_nonterminals</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span> <span class="n">start_symbol</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">nonterminal</span> <span class="ow">in</span> <span class="n">unused</span> <span class="o">|</span> <span class="n">unreachable</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">new_grammar</span><span class="p">[</span><span class="n">nonterminal</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">new_grammar</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id4">
<h3>End of Excursion<a class="headerlink" href="#id4" title="Link to this heading">#</a></h3>
<p>Let us make use of <code class="docutils literal notranslate"><span class="pre">is_valid_grammar()</span></code>. Our grammars defined above pass the test:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">CGI_GRAMMAR</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">URL_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The check can also be applied to EBNF grammars:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">EXPR_EBNF_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>These do not pass the test, though:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="ow">not</span> <span class="n">is_valid_grammar</span><span class="p">({</span><span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;x&gt;&quot;</span><span class="p">],</span> <span class="s2">&quot;&lt;y&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">]})</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;&lt;y&gt;&#39;: defined, but not used. Consider applying trim_grammar() on the grammar
&#39;&lt;x&gt;&#39;: used, but not defined
&#39;&lt;y&gt;&#39;: unreachable from &lt;start&gt;. Consider applying trim_grammar() on the grammar
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="ow">not</span> <span class="n">is_valid_grammar</span><span class="p">({</span><span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span> <span class="s2">&quot;123&quot;</span><span class="p">})</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;&lt;start&gt;&#39;: expansion is not a list
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="ow">not</span> <span class="n">is_valid_grammar</span><span class="p">({</span><span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span> <span class="p">[]})</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;&lt;start&gt;&#39;: expansion list empty
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="ow">not</span> <span class="n">is_valid_grammar</span><span class="p">({</span><span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]})</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;&lt;start&gt;&#39;: 1: not a string
</pre></div>
</div>
</div>
</div>
<p>(The <code class="docutils literal notranslate"><span class="pre">#type:</span> <span class="pre">ignore</span></code> annotations avoid static checkers flagging the above as errors).</p>
<p>From here on, we will always use <code class="docutils literal notranslate"><span class="pre">is_valid_grammar()</span></code> when defining a grammar.</p>
</section>
</section>
<section id="id5">
<h2>Synopsis<a class="headerlink" href="#id5" title="Link to this heading">#</a></h2>
<p>This chapter introduces <em>grammars</em> as a simple means to specify input languages, and to use them for testing programs with syntactically valid inputs.  A grammar is defined as a mapping of nonterminal symbols to lists of alternative expansions, as in the following example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">US_PHONE_GRAMMAR</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;phone-number&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;phone-number&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;(&lt;area&gt;)&lt;exchange&gt;-&lt;line&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;area&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;lead-digit&gt;&lt;digit&gt;&lt;digit&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;exchange&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;lead-digit&gt;&lt;digit&gt;&lt;digit&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;line&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;digit&gt;&lt;digit&gt;&lt;digit&gt;&lt;digit&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;lead-digit&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="s2">&quot;6&quot;</span><span class="p">,</span> <span class="s2">&quot;7&quot;</span><span class="p">,</span> <span class="s2">&quot;8&quot;</span><span class="p">,</span> <span class="s2">&quot;9&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="s2">&quot;6&quot;</span><span class="p">,</span> <span class="s2">&quot;7&quot;</span><span class="p">,</span> <span class="s2">&quot;8&quot;</span><span class="p">,</span> <span class="s2">&quot;9&quot;</span><span class="p">]</span>
<span class="p">}</span>

<span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">US_PHONE_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Nonterminal symbols are enclosed in angle brackets (say, <code class="docutils literal notranslate"><span class="pre">&lt;digit&gt;</span></code>).  To generate an input string from a grammar, a <em>producer</em> starts with the start symbol (<code class="docutils literal notranslate"><span class="pre">&lt;start&gt;</span></code>) and randomly chooses a random expansion for this symbol.  It continues the process until all nonterminal symbols are expanded.  The function <code class="docutils literal notranslate"><span class="pre">simple_grammar_fuzzer()</span></code> does just that:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">simple_grammar_fuzzer</span><span class="p">(</span><span class="n">US_PHONE_GRAMMAR</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;(692)449-5179&#39;,
 &#39;(519)230-7422&#39;,
 &#39;(613)761-0853&#39;,
 &#39;(979)881-3858&#39;,
 &#39;(810)914-5475&#39;]
</pre></div>
</div>
</div>
</div>
<p>In practice, though, instead of <code class="docutils literal notranslate"><span class="pre">simple_grammar_fuzzer()</span></code>, you should use <a class="reference internal" href="GrammarFuzzer.html"><span class="std std-doc">the <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code> class</span></a> or one of its <a class="reference internal" href="GrammarCoverageFuzzer.html"><span class="std std-doc">coverage-based</span></a>, <a class="reference internal" href="ProbabilisticGrammarFuzzer.html"><span class="std std-doc">probabilistic-based</span></a>, or <a class="reference internal" href="GeneratorGrammarFuzzer.html"><span class="std std-doc">generator-based</span></a> derivatives; these are more efficient, protect against infinite growth, and provide several additional features.</p>
<p>This chapter also introduces a <a class="reference internal" href="#A-Grammar-Toolbox"><span class="xref myst">grammar toolbox</span></a> with several helper functions that ease the writing of grammars, such as using shortcut notations for character classes and repetitions, or extending grammars</p>
</section>
<section id="lessons-learned">
<h2>Lessons Learned<a class="headerlink" href="#lessons-learned" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Grammars are powerful tools to express and produce syntactically valid inputs.</p></li>
<li><p>Inputs produced from grammars can be used as is, or used as seeds for mutation-based fuzzing.</p></li>
<li><p>Grammars can be extended with character classes and operators to make writing easier.</p></li>
</ul>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">#</a></h2>
<p>As they make a great foundation for generating software tests, we use grammars again and again in this book.  As a sneak preview, we can use grammars to <a class="reference internal" href="ConfigurationFuzzer.html"><span class="std std-doc">fuzz configurations</span></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">options</span><span class="o">&gt;</span> <span class="p">:</span><span class="o">:=</span> <span class="o">&lt;</span><span class="n">option</span><span class="o">&gt;*</span>
<span class="o">&lt;</span><span class="n">option</span><span class="o">&gt;</span> <span class="p">:</span><span class="o">:=</span> <span class="o">-</span><span class="n">h</span> <span class="o">|</span> <span class="o">--</span><span class="n">version</span> <span class="o">|</span> <span class="o">-</span><span class="n">v</span> <span class="o">|</span> <span class="o">-</span><span class="n">d</span> <span class="o">|</span> <span class="o">-</span><span class="n">i</span> <span class="o">|</span> <span class="o">--</span><span class="k">global</span><span class="o">-</span><span class="n">config</span> <span class="o">&lt;</span><span class="n">filename</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>We can use grammars for <a class="reference internal" href="APIFuzzer.html"><span class="std std-doc">fuzzing functions and APIs</span></a> and <a class="reference internal" href="WebFuzzer.html"><span class="std std-doc">fuzzing graphical user interfaces</span></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">call</span><span class="o">-</span><span class="n">sequence</span><span class="o">&gt;</span> <span class="p">:</span><span class="o">:=</span> <span class="o">&lt;</span><span class="n">call</span><span class="o">&gt;*</span>
<span class="o">&lt;</span><span class="n">call</span><span class="o">&gt;</span> <span class="p">:</span><span class="o">:=</span> <span class="n">urlparse</span><span class="p">(</span><span class="o">&lt;</span><span class="n">url</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">|</span> <span class="n">urlsplit</span><span class="p">(</span><span class="o">&lt;</span><span class="n">url</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>
</div>
<p>We can assign <a class="reference internal" href="ProbabilisticGrammarFuzzer.html"><span class="std std-doc">probabilities</span></a> and <a class="reference internal" href="GeneratorGrammarFuzzer.html"><span class="std std-doc">constraints</span></a> to individual expansions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">term</span><span class="o">&gt;</span><span class="p">:</span> <span class="mi">50</span><span class="o">%</span> <span class="o">&lt;</span><span class="n">factor</span><span class="o">&gt;</span> <span class="o">*</span> <span class="o">&lt;</span><span class="n">term</span><span class="o">&gt;</span> <span class="o">|</span>  <span class="mi">30</span><span class="o">%</span> <span class="o">&lt;</span><span class="n">factor</span><span class="o">&gt;</span> <span class="o">/</span> <span class="o">&lt;</span><span class="n">term</span><span class="o">&gt;</span> <span class="o">|</span> <span class="mi">20</span><span class="o">%</span> <span class="o">&lt;</span><span class="n">factor</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">integer</span><span class="o">&gt;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">digit</span><span class="o">&gt;+</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">integer</span><span class="o">&gt;</span> <span class="o">&gt;=</span> <span class="mi">100</span> <span class="p">}</span>
</pre></div>
</div>
<p>All these extras become especially valuable as we can</p>
<ol class="arabic simple">
<li><p><em>infer grammars automatically</em>, dropping the need to specify them manually, and</p></li>
<li><p><em>guide them towards specific goals</em> such as coverage or critical functions;</p></li>
</ol>
<p>which we also discuss for all techniques in this book.</p>
<p>To get there, however, we still have a bit of homework to do.  In particular, we first have to learn how to</p>
<ul class="simple">
<li><p><a class="reference internal" href="GrammarFuzzer.html"><span class="std std-doc">create an efficient grammar fuzzer</span></a></p></li>
</ul>
</section>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h2>
<p>As one of the foundations of human language, grammars have been around as long as human language existed.  The first <em>formalization</em> of generative grammars was by Dakṣiputra Pāṇini in 350 BC \cite{Panini350bce}.  As a general means to express formal languages for both data and programs, their role in computer science cannot be overstated.  The seminal work by Chomsky \cite{Chomsky1956} introduced the central models of regular languages, context-free grammars, context-sensitive grammars, and universal grammars as they are used (and taught) in computer science as a means to specify input and programming languages ever since.</p>
<p>The use of grammars for <em>producing</em> test inputs goes back to Burkhardt \cite{Burkhardt1967}, to be later rediscovered and applied by Hanford \cite{Hanford1970} and Purdom \cite{Purdom1972}.  The most important use of grammar testing since then has been <em>compiler testing</em>.  Actually, grammar-based testing is one important reason why compilers and Web browsers work as they should:</p>
<ul class="simple">
<li><p>The <a class="reference external" href="https://embed.cs.utah.edu/csmith/">CSmith</a> tool \cite{Yang2011} specifically targets C programs, starting with a C grammar and then applying additional steps, such as referring to variables and functions defined earlier or ensuring integer and type safety.  Their authors have used it “to find and report more than 400 previously unknown compiler bugs.”</p></li>
<li><p>The <a class="reference external" href="http://issta2016.cispa.saarland/interview-with-christian-holler/">LangFuzz</a> work \cite{Holler2012}, which shares two authors with this book, uses a generic grammar to produce outputs, and is used day and night to generate JavaScript programs and test their interpreters; as of today, it has found more than 2,600 bugs in browsers such as Mozilla Firefox, Google Chrome, and Microsoft Edge.</p></li>
<li><p>The <a class="reference external" href="http://web.cs.ucdavis.edu/~su/emi-project/">EMI Project</a> \cite{Le2014} uses grammars to stress-test C compilers, transforming known tests into alternative programs that should be semantically equivalent over all inputs.  Again, this has led to more than 100 bugs in C compilers being fixed.</p></li>
<li><p><a class="reference external" href="https://github.com/renatahodovan/grammarinator">Grammarinator</a> \cite{Hodovan2018} is an open-source grammar fuzzer (written in Python!), using the popular ANTLR format as grammar specification.  Like LangFuzz, it uses the grammar for both parsing and producing, and has found more than 100 issues in the <em>JerryScript</em> lightweight JavaScript engine and an associated platform.</p></li>
<li><p><a class="reference external" href="https://github.com/googleprojectzero/domato">Domato</a> is a generic grammar generation engine that is specifically used for fuzzing DOM input.  It has revealed a number of security issues in popular Web browsers.</p></li>
</ul>
<p>Compilers and Web browsers, of course, are not only domains where grammars are needed for testing, but also domains where grammars are well-known.  Our claim in this book is that grammars can be used to generate almost <em>any</em> input, and our aim is to empower you to do precisely that.</p>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<section id="exercise-1-a-json-grammar">
<h3>Exercise 1: A JSON Grammar<a class="headerlink" href="#exercise-1-a-json-grammar" title="Link to this heading">#</a></h3>
<p>Take a look at the <a class="reference external" href="http://www.json.org">JSON specification</a> and derive a grammar from it:</p>
<ul class="simple">
<li><p>Use <em>character classes</em> to express valid characters</p></li>
<li><p>Use EBNF to express repetitions and optional parts</p></li>
<li><p>Assume that</p>
<ul>
<li><p>a string is a sequence of digits, ASCII letters, punctuation and space characters without quotes or escapes</p></li>
<li><p>whitespace is just a single space.</p></li>
</ul>
</li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">is_valid_grammar()</span></code> to ensure the grammar is valid.</p></li>
</ul>
<p>Feed the grammar into <code class="docutils literal notranslate"><span class="pre">simple_grammar_fuzzer()</span></code>.  Do you encounter any errors, and why?</p>
<p><strong>Solution.</strong> This is a fairly straightforward translation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">CHARACTERS_WITHOUT_QUOTE</span> <span class="o">=</span> <span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">digits</span>
                            <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span>
                            <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                            <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">JSON_EBNF_GRAMMAR</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;json&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;json&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;element&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;element&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;ws&gt;&lt;value&gt;&lt;ws&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;value&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;object&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;array&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;string&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;number&gt;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;; DROP TABLE STUDENTS&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;object&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;{&lt;ws&gt;}&quot;</span><span class="p">,</span> <span class="s2">&quot;{&lt;members&gt;}&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;members&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;member&gt;(,&lt;members&gt;)*&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;member&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;ws&gt;&lt;string&gt;&lt;ws&gt;:&lt;element&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;array&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;[&lt;ws&gt;]&quot;</span><span class="p">,</span> <span class="s2">&quot;[&lt;elements&gt;]&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;elements&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;element&gt;(,&lt;elements&gt;)*&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;element&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;ws&gt;&lt;value&gt;&lt;ws&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;string&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="s2">&quot;&lt;characters&gt;&quot;</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">],</span>
    
    <span class="s2">&quot;&lt;characters&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;character&gt;*&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;character&gt;&quot;</span><span class="p">:</span> <span class="n">srange</span><span class="p">(</span><span class="n">CHARACTERS_WITHOUT_QUOTE</span><span class="p">),</span>

    <span class="s2">&quot;&lt;number&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;int&gt;&lt;frac&gt;&lt;exp&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;int&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;onenine&gt;&lt;digits&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;-&lt;digit&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;-&lt;onenine&gt;&lt;digits&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;digits&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;digit&gt;+&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s2">&quot;&lt;onenine&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;onenine&gt;&quot;</span><span class="p">:</span> <span class="n">crange</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">),</span>

    <span class="s2">&quot;&lt;frac&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;.&lt;digits&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;exp&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;E&lt;sign&gt;&lt;digits&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;e&lt;sign&gt;&lt;digits&gt;&quot;</span><span class="p">],</span>

    <span class="s2">&quot;&lt;sign&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">],</span>

    <span class="c1"># &quot;&lt;ws&gt;&quot;: srange(string.whitespace)</span>

    <span class="s2">&quot;&lt;ws&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot; &quot;</span><span class="p">]</span>
<span class="p">}</span>

<span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">JSON_EBNF_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">JSON_GRAMMAR</span> <span class="o">=</span> <span class="n">convert_ebnf_grammar</span><span class="p">(</span><span class="n">JSON_EBNF_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ExpectError</span> <span class="kn">import</span> <span class="n">ExpectError</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">simple_grammar_fuzzer</span><span class="p">(</span><span class="n">JSON_GRAMMAR</span><span class="p">,</span> <span class="s1">&#39;&lt;object&gt;&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{ &quot;&quot; : &#39;; DROP TABLE STUDENTS , &quot;/h?O &quot; : [ ] , &quot;&quot; : &quot;&quot; , &quot;x&quot; : false , &quot;&quot; : null }
{ }
{ }
{ }
{ }
{ }
{ }
{ }
{ }
{ &quot;&quot; : &quot;.qF&quot; , &quot;&quot; : &#39;; DROP TABLE STUDENTS , &quot;&quot; : 47 }
{ }
{ &quot;7&quot; : { &quot;y&quot; : &quot;&quot; } , &quot;&quot; : false , &quot;X&quot; : &quot;N7|:&quot; , &quot;&quot; : [ true ] , &quot;&quot; : [ ] , &quot;&quot; : { } }
{ &quot;Hm&quot; : false }
{ }
{ &quot;&quot; : [ ] }
{ &quot;&quot; : [ ] , &quot;9z6}l&quot; : null }
{ }
{ &quot;#&quot; : false , &quot;D&quot; : { &quot;&quot; : true } , &quot;t&quot; : 90 , &quot;g&quot; : [ &#39;; DROP TABLE STUDENTS ] , &quot;&quot; : [ false ] , &quot;=R5&quot; : [ ] , &quot; &quot; : &#39;; DROP TABLE STUDENTS , &quot;`l&quot; : { &quot;&quot; : &quot;?&#39;L&quot; , &quot;E&quot; : null , &quot;&quot; : [ 70.3076998940e6 ] , &quot;Ju&quot; : true } }
{ }
{ &quot;&quot; : true , &quot;&quot; : &quot;%7y&quot; , &quot;!&quot; : false , &quot;&quot; : true , &quot;&quot; : { &quot;&quot; : [ ] , &quot;&quot; : -0E+0 , &quot;U&quot; : -65E+0 } }
{ &quot;4?&quot; : { &quot;&quot; : { &quot;&quot; : 21 , &quot;&quot; : &#39;; DROP TABLE STUDENTS } , &quot;&quot; : [ ] , &quot;&quot; : true , &quot;&quot; : { &quot;7n&quot; : &quot;&quot; } , &quot;o&quot; : { &quot;&quot; : [ ] } } }
{ }
{ }
{ &quot;8g&quot; : 1.8 }
{ &quot;]&quot; : false }
{ &quot;Oo&quot; : &quot;&quot; , &quot;&quot; : { } , &quot;&quot; : true }
{ &quot;&quot; : 0.40 , &quot;w&quot; : null , &quot;&quot; : [ true ] , &quot;r&quot; : &#39;; DROP TABLE STUDENTS , &quot;z&quot; : true , &quot;Dj2&quot; : true , &quot;&quot; : [ ] , &quot;&quot; : -66120.09 }
{ }
{ }
{ }
{ &quot;&quot; : &#39;; DROP TABLE STUDENTS }
{ &quot;rg:&quot; : { } , &quot;Ui&quot; : -40.1e+0 , &quot;&quot; : null , &quot;&quot; : { } , &quot;?&quot; : true }
{ &quot;)&quot; : &quot;&quot; }
{ }
{ }
{ &quot;&quot; : { &quot;8&quot; : true , &quot;v&quot; : [ -7.086006 ] , &quot;&quot; : &#39;; DROP TABLE STUDENTS , &quot;&quot; : &quot;Z&gt;]&gt;&quot; , &quot;3&quot; : &#39;; DROP TABLE STUDENTS } }
{ }
{ }
{ }
{ }
{ &quot;&quot; : 66E91 , &quot;&quot; : true , &quot;&quot; : { &quot;U[=2zs&quot; : &quot;&quot; } }
{ }
{ }
{ &quot;&quot; : true }
{ }
{ &quot;ru&quot; : -1.2009e-000 }
{ }
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_8783/1615368770.py&quot;, line 3, in &lt;module&gt;
    print(simple_grammar_fuzzer(JSON_GRAMMAR, &#39;&lt;object&gt;&#39;))
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_8783/2839760968.py&quot;, line 35, in simple_grammar_fuzzer
    raise ExpansionError(&quot;Cannot expand &quot; + repr(term))
ExpansionError: Cannot expand &#39;{ &quot;&quot; : [&lt;element&gt;,&lt;element&gt;,&lt;element&gt;,&lt;element&gt;,&lt;element&gt;,&lt;element&gt;] ,&lt;member&gt;,&lt;member&gt;}&#39; (expected)
Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_8783/1615368770.py&quot;, line 3, in &lt;module&gt;
    print(simple_grammar_fuzzer(JSON_GRAMMAR, &#39;&lt;object&gt;&#39;))
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_8783/2839760968.py&quot;, line 35, in simple_grammar_fuzzer
    raise ExpansionError(&quot;Cannot expand &quot; + repr(term))
ExpansionError: Cannot expand &#39;{ &quot;&quot; : [ ] , &quot;O2jR&quot; : [ ] ,&lt;member&gt;,&lt;member&gt;,&lt;member&gt;,&lt;member&gt;,&lt;member&gt;,&lt;member&gt;,&lt;member&gt;}&#39; (expected)
Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_8783/1615368770.py&quot;, line 3, in &lt;module&gt;
    print(simple_grammar_fuzzer(JSON_GRAMMAR, &#39;&lt;object&gt;&#39;))
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_8783/2839760968.py&quot;, line 35, in simple_grammar_fuzzer
    raise ExpansionError(&quot;Cannot expand &quot; + repr(term))
ExpansionError: Cannot expand &#39;{ &quot;&quot; : \&#39;; DROP TABLE STUDENTS , &quot;&quot; : \&#39;; DROP TABLE STUDENTS , &quot;&quot; : { &quot;&quot; : 20.5160 } , &quot;&quot; : { &quot;&quot; : 0 , &quot;&quot; :&lt;element&gt;,&lt;member&gt;,&lt;member&gt;,&lt;member&gt;,&lt;member&gt;,&lt;member&gt;,&lt;member&gt;,&lt;member&gt;} }&#39; (expected)
</pre></div>
</div>
</div>
</div>
<p>We get these errors because <code class="docutils literal notranslate"><span class="pre">simple_grammar_fuzzer()</span></code> first expands to a maximum number of elements, and then is limited because every further expansion would <em>increase</em> the number of nonterminals, even though these may eventually reduce the string length.  This issue is addressed in the <a class="reference internal" href="GrammarFuzzer.html"><span class="std std-doc">next chapter</span></a>, introducing a more solid algorithm for producing strings from grammars.</p>
</section>
<section id="exercise-2-finding-bugs">
<h3>Exercise 2: Finding Bugs<a class="headerlink" href="#exercise-2-finding-bugs" title="Link to this heading">#</a></h3>
<p>The name <code class="docutils literal notranslate"><span class="pre">simple_grammar_fuzzer()</span></code> does not come by accident: The way it expands grammars is limited in several ways.  What happens if you apply <code class="docutils literal notranslate"><span class="pre">simple_grammar_fuzzer()</span></code> on <code class="docutils literal notranslate"><span class="pre">nonterminal_grammar</span></code> and <code class="docutils literal notranslate"><span class="pre">expr_grammar</span></code>, as defined above, and why?</p>
<p><strong>Solution</strong>.  <code class="docutils literal notranslate"><span class="pre">nonterminal_grammar</span></code> does not work because <code class="docutils literal notranslate"><span class="pre">simple_grammar_fuzzer()</span></code> eventually tries to expand the just generated nonterminal:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ExpectError</span> <span class="kn">import</span> <span class="n">ExpectError</span><span class="p">,</span> <span class="n">ExpectTimeout</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">simple_grammar_fuzzer</span><span class="p">(</span><span class="n">nonterminal_grammar</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;start&gt; -&gt; &lt;nonterminal&gt;                 &lt;nonterminal&gt;
&lt;nonterminal&gt; -&gt; &lt;left-angle&gt;&lt;identifier&gt;&lt;right-angle&gt; &lt;left-angle&gt;&lt;identifier&gt;&lt;right-angle&gt;
&lt;identifier&gt; -&gt; &lt;idchar&gt;                 &lt;left-angle&gt;&lt;idchar&gt;&lt;right-angle&gt;
&lt;right-angle&gt; -&gt; &gt;                       &lt;left-angle&gt;&lt;idchar&gt;&gt;
&lt;left-angle&gt; -&gt; &lt;                        &lt;&lt;idchar&gt;&gt;
&lt;idchar&gt; -&gt; j                            &lt;j&gt;
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_8783/3478216411.py&quot;, line 2, in &lt;module&gt;
    simple_grammar_fuzzer(nonterminal_grammar, log=True)
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_8783/2839760968.py&quot;, line 18, in simple_grammar_fuzzer
    expansions = grammar[symbol_to_expand]
                 ~~~~~~~^^^^^^^^^^^^^^^^^^
KeyError: &#39;&lt;j&gt;&#39; (expected)
</pre></div>
</div>
</div>
</div>
<p>For <code class="docutils literal notranslate"><span class="pre">expr_grammar</span></code>, things are even worse, as <code class="docutils literal notranslate"><span class="pre">simple_grammar_fuzzer()</span></code> can start a series of infinite expansions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectTimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">simple_grammar_fuzzer</span><span class="p">(</span><span class="n">expr_grammar</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_8783/557333580.py&quot;, line 3, in &lt;module&gt;
    print(simple_grammar_fuzzer(expr_grammar))
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_8783/2839760968.py&quot;, line 16, in simple_grammar_fuzzer
    while len(nonterminals(term)) &gt; 0:
              ^^^^^^^^^^^^^^^^^^
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_8783/2431549160.py&quot;, line 7, in nonterminals
    return RE_NONTERMINAL.findall(expansion)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;Timeout.ipynb&quot;, line 43, in timeout_handler
    raise TimeoutError()
TimeoutError (expected)
</pre></div>
</div>
</div>
</div>
<p>Both issues are addressed and discussed in the <a class="reference internal" href="GrammarFuzzer.html"><span class="std std-doc">next chapter</span></a>, introducing a more solid algorithm for producing strings from grammars.</p>
</section>
<section id="exercise-3-grammars-with-regular-expressions">
<h3>Exercise 3: Grammars with Regular Expressions<a class="headerlink" href="#exercise-3-grammars-with-regular-expressions" title="Link to this heading">#</a></h3>
<p>In a <em>grammar extended with regular expressions</em>, we can use the special form</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">regex</span><span class="o">/</span>
</pre></div>
</div>
<p>to include regular expressions in expansions.  For instance, we can have a rule</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;integer&gt; ::= /[+-]?[0-9]+/
</pre></div>
</div>
<p>to quickly express that an integer is an optional sign, followed by a sequence of digits.</p>
<section id="part-1-convert-regular-expressions">
<h4>Part 1: Convert regular expressions<a class="headerlink" href="#part-1-convert-regular-expressions" title="Link to this heading">#</a></h4>
<p>Write a converter <code class="docutils literal notranslate"><span class="pre">convert_regex(r)</span></code> that takes a regular expression <code class="docutils literal notranslate"><span class="pre">r</span></code> and creates an equivalent grammar.  Support the following regular expression constructs:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">*</span></code>, <code class="docutils literal notranslate"><span class="pre">+</span></code>, <code class="docutils literal notranslate"><span class="pre">?</span></code>, <code class="docutils literal notranslate"><span class="pre">()</span></code> should work just in EBNFs, above.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">a|b</span></code> should translate into a list of alternatives <code class="docutils literal notranslate"><span class="pre">[a,</span> <span class="pre">b]</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.</span></code> should match any character except newline.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">[abc]</span></code> should translate into <code class="docutils literal notranslate"><span class="pre">srange(&quot;abc&quot;)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">[^abc]</span></code> should translate into the set of ASCII characters <em>except</em> <code class="docutils literal notranslate"><span class="pre">srange(&quot;abc&quot;)</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">[a-b]</span></code> should translate into <code class="docutils literal notranslate"><span class="pre">crange(a,</span> <span class="pre">b)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">[^a-b]</span></code> should translate into the set of ASCII characters <em>except</em> <code class="docutils literal notranslate"><span class="pre">crange(a,</span> <span class="pre">b)</span></code>.</p></li>
</ul>
<p>Example: <code class="docutils literal notranslate"><span class="pre">convert_regex(r&quot;[0-9]+&quot;)</span></code> should yield a grammar such as</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;s1&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;s1&gt;&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;&lt;s2&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;s1&gt;&lt;s2&gt;&quot;</span> <span class="p">],</span>
    <span class="s2">&quot;&lt;s2&gt;&quot;</span><span class="p">:</span> <span class="n">crange</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Solution.</strong> Left as exercise to the reader.</p>
</section>
<section id="part-2-identify-and-expand-regular-expressions">
<h4>Part 2: Identify and expand regular expressions<a class="headerlink" href="#part-2-identify-and-expand-regular-expressions" title="Link to this heading">#</a></h4>
<p>Write a converter <code class="docutils literal notranslate"><span class="pre">convert_regex_grammar(g)</span></code> that takes a EBNF grammar <code class="docutils literal notranslate"><span class="pre">g</span></code> containing regular expressions in the form <code class="docutils literal notranslate"><span class="pre">/.../</span></code> and creates an equivalent BNF grammar.  Support the regular expression constructs as above.</p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">convert_regex_grammar({</span> <span class="pre">&quot;&lt;integer&gt;&quot;</span> <span class="pre">:</span> <span class="pre">&quot;/[+-]?[0-9]+/&quot;</span> <span class="pre">})</span></code> should yield a grammar such as</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;&lt;integer&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;s1&gt;&lt;s3&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;s1&gt;&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;s2&gt;&quot;</span> <span class="p">],</span>
    <span class="s2">&quot;&lt;s2&gt;&quot;</span><span class="p">:</span> <span class="n">srange</span><span class="p">(</span><span class="s2">&quot;+-&quot;</span><span class="p">),</span>
    <span class="s2">&quot;&lt;s3&gt;&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;&lt;s4&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;s4&gt;&lt;s3&gt;&quot;</span> <span class="p">],</span>
    <span class="s2">&quot;&lt;s4&gt;&quot;</span><span class="p">:</span> <span class="n">crange</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Optional: Support <em>escapes</em> in regular expressions: <code class="docutils literal notranslate"><span class="pre">\c</span></code> translates to the literal character <code class="docutils literal notranslate"><span class="pre">c</span></code>; <code class="docutils literal notranslate"><span class="pre">\/</span></code> translates to <code class="docutils literal notranslate"><span class="pre">/</span></code> (and thus does not end the regular expression); <code class="docutils literal notranslate"><span class="pre">\\</span></code> translates to <code class="docutils literal notranslate"><span class="pre">\</span></code>.</p>
<p><strong>Solution.</strong> Left as exercise to the reader.</p>
</section>
</section>
<section id="exercise-4-defining-grammars-as-functions-advanced">
<h3>Exercise 4: Defining Grammars as Functions (Advanced)<a class="headerlink" href="#exercise-4-defining-grammars-as-functions-advanced" title="Link to this heading">#</a></h3>
<p>To obtain a nicer syntax for specifying grammars, one can make use of Python constructs which then will be <em>parsed</em> by an additional function.  For instance, we can imagine a grammar definition which uses <code class="docutils literal notranslate"><span class="pre">|</span></code> as a means to separate alternatives:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">expression_grammar_fn</span><span class="p">():</span>
    <span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;&lt;expr&gt;&quot;</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="s2">&quot;&lt;term&gt; + &lt;expr&gt;&quot;</span> <span class="o">|</span> <span class="s2">&quot;&lt;term&gt; - &lt;expr&gt;&quot;</span>
    <span class="n">term</span> <span class="o">=</span> <span class="s2">&quot;&lt;factor&gt; * &lt;term&gt;&quot;</span> <span class="o">|</span> <span class="s2">&quot;&lt;factor&gt; / &lt;term&gt;&quot;</span> <span class="o">|</span> <span class="s2">&quot;&lt;factor&gt;&quot;</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="s2">&quot;+&lt;factor&gt;&quot;</span> <span class="o">|</span> <span class="s2">&quot;-&lt;factor&gt;&quot;</span> <span class="o">|</span> <span class="s2">&quot;(&lt;expr&gt;)&quot;</span> <span class="o">|</span> <span class="s2">&quot;&lt;integer&gt;.&lt;integer&gt;&quot;</span> <span class="o">|</span> <span class="s2">&quot;&lt;integer&gt;&quot;</span>
    <span class="n">integer</span> <span class="o">=</span> <span class="s2">&quot;&lt;digit&gt;&lt;integer&gt;&quot;</span> <span class="o">|</span> <span class="s2">&quot;&lt;digit&gt;&quot;</span>
    <span class="n">digit</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="o">|</span> <span class="s1">&#39;1&#39;</span> <span class="o">|</span> <span class="s1">&#39;2&#39;</span> <span class="o">|</span> <span class="s1">&#39;3&#39;</span> <span class="o">|</span> <span class="s1">&#39;4&#39;</span> <span class="o">|</span> <span class="s1">&#39;5&#39;</span> <span class="o">|</span> <span class="s1">&#39;6&#39;</span> <span class="o">|</span> <span class="s1">&#39;7&#39;</span> <span class="o">|</span> <span class="s1">&#39;8&#39;</span> <span class="o">|</span> <span class="s1">&#39;9&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>If we execute <code class="docutils literal notranslate"><span class="pre">expression_grammar_fn()</span></code>, this will yield an error.  Yet, the purpose of <code class="docutils literal notranslate"><span class="pre">expression_grammar_fn()</span></code> is not to be executed, but to be used as <em>data</em> from which the grammar will be constructed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">expression_grammar_fn</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_8783/1271268731.py&quot;, line 2, in &lt;module&gt;
    expression_grammar_fn()
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_8783/3029408019.py&quot;, line 3, in expression_grammar_fn
    expr = &quot;&lt;term&gt; + &lt;expr&gt;&quot; | &quot;&lt;term&gt; - &lt;expr&gt;&quot;
           ~~~~~~~~~~~~~~~~~~^~~~~~~~~~~~~~~~~~~
TypeError: unsupported operand type(s) for |: &#39;str&#39; and &#39;str&#39; (expected)
</pre></div>
</div>
</div>
</div>
<p>To this end, we make use of the <code class="docutils literal notranslate"><span class="pre">ast</span></code> (abstract syntax tree) and <code class="docutils literal notranslate"><span class="pre">inspect</span></code> (code inspection) modules.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">inspect</span>
</pre></div>
</div>
</div>
</div>
<p>First, we obtain the source code of <code class="docutils literal notranslate"><span class="pre">expression_grammar_fn()</span></code>…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">expression_grammar_fn</span><span class="p">)</span>
<span class="n">source</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;def expression_grammar_fn():\n    start = &quot;&lt;expr&gt;&quot;\n    expr = &quot;&lt;term&gt; + &lt;expr&gt;&quot; | &quot;&lt;term&gt; - &lt;expr&gt;&quot;\n    term = &quot;&lt;factor&gt; * &lt;term&gt;&quot; | &quot;&lt;factor&gt; / &lt;term&gt;&quot; | &quot;&lt;factor&gt;&quot;\n    factor = &quot;+&lt;factor&gt;&quot; | &quot;-&lt;factor&gt;&quot; | &quot;(&lt;expr&gt;)&quot; | &quot;&lt;integer&gt;.&lt;integer&gt;&quot; | &quot;&lt;integer&gt;&quot;\n    integer = &quot;&lt;digit&gt;&lt;integer&gt;&quot; | &quot;&lt;digit&gt;&quot;\n    digit = \&#39;0\&#39; | \&#39;1\&#39; | \&#39;2\&#39; | \&#39;3\&#39; | \&#39;4\&#39; | \&#39;5\&#39; | \&#39;6\&#39; | \&#39;7\&#39; | \&#39;8\&#39; | \&#39;9\&#39;\n&#39;
</pre></div>
</div>
</div>
</div>
<p>… which we then parse into an abstract syntax tree:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can now parse the tree to find operators and alternatives.  <code class="docutils literal notranslate"><span class="pre">get_alternatives()</span></code> iterates over all nodes <code class="docutils literal notranslate"><span class="pre">op</span></code> of the tree; If the node looks like a binary <em>or</em> (<code class="docutils literal notranslate"><span class="pre">|</span></code>) operation, we drill deeper and recurse. If not, we have reached a single production, and we try to get the expression from the production. We define the <code class="docutils literal notranslate"><span class="pre">to_expr</span></code> parameter depending on how we want to represent the production. In this case, we represent a single production by a single string.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_alternatives</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">to_expr</span><span class="o">=</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">o</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">BinOp</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">BitOr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_alternatives</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">to_expr</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">to_expr</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">right</span><span class="p">)]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">to_expr</span><span class="p">(</span><span class="n">op</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">funct_parser()</span></code> takes the abstract syntax tree of a function (say, <code class="docutils literal notranslate"><span class="pre">expression_grammar_fn()</span></code>) and iterates over all assignments:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">funct_parser</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">to_expr</span><span class="o">=</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">o</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">assign</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">get_alternatives</span><span class="p">(</span><span class="n">assign</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">to_expr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">assign</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">body</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>The result is a grammar in our regular format:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grammar</span> <span class="o">=</span> <span class="n">funct_parser</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
<span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">grammar</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="s2">&quot;::=&quot;</span><span class="p">,</span> <span class="n">grammar</span><span class="p">[</span><span class="n">symbol</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>start ::= [&#39;&lt;expr&gt;&#39;]
expr ::= [&#39;&lt;term&gt; + &lt;expr&gt;&#39;, &#39;&lt;term&gt; - &lt;expr&gt;&#39;]
term ::= [&#39;&lt;factor&gt; * &lt;term&gt;&#39;, &#39;&lt;factor&gt; / &lt;term&gt;&#39;, &#39;&lt;factor&gt;&#39;]
factor ::= [&#39;+&lt;factor&gt;&#39;, &#39;-&lt;factor&gt;&#39;, &#39;(&lt;expr&gt;)&#39;, &#39;&lt;integer&gt;.&lt;integer&gt;&#39;, &#39;&lt;integer&gt;&#39;]
integer ::= [&#39;&lt;digit&gt;&lt;integer&gt;&#39;, &#39;&lt;digit&gt;&#39;]
digit ::= [&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_8783/1939255217.py:1: DeprecationWarning: Attribute s is deprecated and will be removed in Python 3.14; use value instead
  def funct_parser(tree, to_expr=lambda o: o.s):
</pre></div>
</div>
</div>
</div>
<section id="part-1-a-one-single-function">
<h4>Part 1 (a): One Single Function<a class="headerlink" href="#part-1-a-one-single-function" title="Link to this heading">#</a></h4>
<p>Write a single function <code class="docutils literal notranslate"><span class="pre">define_grammar(fn)</span></code> that takes a grammar defined as function (such as <code class="docutils literal notranslate"><span class="pre">expression_grammar_fn()</span></code>) and returns a regular grammar.</p>
<p><strong>Solution</strong>.  This is straightforward:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">define_grammar</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">to_expr</span><span class="o">=</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">o</span><span class="o">.</span><span class="n">s</span><span class="p">):</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">grammar</span> <span class="o">=</span> <span class="n">funct_parser</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">to_expr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">grammar</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">define_grammar</span><span class="p">(</span><span class="n">expression_grammar_fn</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_8783/205615455.py:1: DeprecationWarning: Attribute s is deprecated and will be removed in Python 3.14; use value instead
  def define_grammar(fn, to_expr=lambda o: o.s):
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;start&#39;: [&#39;&lt;expr&gt;&#39;],
 &#39;expr&#39;: [&#39;&lt;term&gt; + &lt;expr&gt;&#39;, &#39;&lt;term&gt; - &lt;expr&gt;&#39;],
 &#39;term&#39;: [&#39;&lt;factor&gt; * &lt;term&gt;&#39;, &#39;&lt;factor&gt; / &lt;term&gt;&#39;, &#39;&lt;factor&gt;&#39;],
 &#39;factor&#39;: [&#39;+&lt;factor&gt;&#39;,
  &#39;-&lt;factor&gt;&#39;,
  &#39;(&lt;expr&gt;)&#39;,
  &#39;&lt;integer&gt;.&lt;integer&gt;&#39;,
  &#39;&lt;integer&gt;&#39;],
 &#39;integer&#39;: [&#39;&lt;digit&gt;&lt;integer&gt;&#39;, &#39;&lt;digit&gt;&#39;],
 &#39;digit&#39;: [&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;]}
</pre></div>
</div>
</div>
</div>
<p><strong>Note.</strong> Python allows us to directly bind the generated grammar to the name <code class="docutils literal notranslate"><span class="pre">expression_grammar_fn</span></code> using function decorators. This can be used to ensure that we do not have a faulty function lying around:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@define_grammar</span>
<span class="k">def</span> <span class="nf">expression_grammar</span><span class="p">():</span>
    <span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;&lt;expr&gt;&quot;</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="s2">&quot;&lt;term&gt; + &lt;expr&gt;&quot;</span> <span class="o">|</span> <span class="s2">&quot;&lt;term&gt; - &lt;expr&gt;&quot;</span>
    <span class="c1">#...</span>
</pre></div>
</div>
</section>
<section id="part-1-b-alternative-representations">
<h4>Part 1 (b): Alternative representations<a class="headerlink" href="#part-1-b-alternative-representations" title="Link to this heading">#</a></h4>
<p>We note that the grammar representation we designed previously does not allow simple generation of alternatives such as <code class="docutils literal notranslate"><span class="pre">srange()</span></code> and <code class="docutils literal notranslate"><span class="pre">crange()</span></code>. Further, one may find the string representation of expressions limiting.  It turns out that it is simple to extend our grammar definition to support grammars such as below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">define_name</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="k">else</span> <span class="n">o</span><span class="o">.</span><span class="n">s</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">define_expr</span><span class="p">(</span><span class="n">op</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">BinOp</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Add</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">define_expr</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">left</span><span class="p">),</span> <span class="n">define_name</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">right</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">define_name</span><span class="p">(</span><span class="n">op</span><span class="p">),)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">define_ex_grammar</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">define_grammar</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">define_expr</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The grammar:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@define_ex_grammar</span>
<span class="k">def</span> <span class="nf">expression_grammar</span><span class="p">():</span>
    <span class="n">start</span>   <span class="o">=</span> <span class="n">expr</span>
    <span class="n">expr</span>    <span class="o">=</span> <span class="p">(</span><span class="n">term</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span> <span class="o">+</span> <span class="n">expr</span>
            <span class="o">|</span>  <span class="n">term</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">expr</span><span class="p">)</span>
    <span class="n">term</span>    <span class="o">=</span> <span class="p">(</span><span class="n">factor</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span> <span class="n">term</span>
            <span class="o">|</span>  <span class="n">factor</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">term</span>
            <span class="o">|</span>  <span class="n">factor</span><span class="p">)</span>
    <span class="n">factor</span>  <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;+&#39;</span> <span class="o">+</span> <span class="n">factor</span>
            <span class="o">|</span>  <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">factor</span>
            <span class="o">|</span>  <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">expr</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
            <span class="o">|</span>  <span class="n">integer</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">integer</span>
            <span class="o">|</span>  <span class="n">integer</span><span class="p">)</span>
    <span class="n">integer</span> <span class="o">=</span> <span class="p">(</span><span class="n">digit</span> <span class="o">+</span> <span class="n">integer</span>
            <span class="o">|</span>  <span class="n">digit</span><span class="p">)</span>
    <span class="n">digit</span>   <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="o">|</span> <span class="s1">&#39;1&#39;</span> <span class="o">|</span> <span class="s1">&#39;2&#39;</span> <span class="o">|</span> <span class="s1">&#39;3&#39;</span> <span class="o">|</span> <span class="s1">&#39;4&#39;</span> <span class="o">|</span> <span class="s1">&#39;5&#39;</span> <span class="o">|</span> <span class="s1">&#39;6&#39;</span> <span class="o">|</span> <span class="s1">&#39;7&#39;</span> <span class="o">|</span> <span class="s1">&#39;8&#39;</span> <span class="o">|</span> <span class="s1">&#39;9&#39;</span>
    
<span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">expression_grammar</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="s2">&quot;::=&quot;</span><span class="p">,</span> <span class="n">expression_grammar</span><span class="p">[</span><span class="n">symbol</span><span class="p">])</span>
</pre></div>
</div>
<p><strong>Note.</strong> The grammar data structure thus obtained is a little more detailed than the standard data structure. It represents each production as a tuple.</p>
<p>We note that we have not enabled <code class="docutils literal notranslate"><span class="pre">srange()</span></code> or <code class="docutils literal notranslate"><span class="pre">crange()</span></code> in the above grammar. How would you go about adding these? (<em>Hint:</em> wrap <code class="docutils literal notranslate"><span class="pre">define_expr()</span></code> to look for <code class="docutils literal notranslate"><span class="pre">ast.Call</span></code>)</p>
</section>
<section id="part-2-extended-grammars">
<h4>Part 2: Extended Grammars<a class="headerlink" href="#part-2-extended-grammars" title="Link to this heading">#</a></h4>
<p>Introduce an operator <code class="docutils literal notranslate"><span class="pre">*</span></code> that takes a pair <code class="docutils literal notranslate"><span class="pre">(min,</span> <span class="pre">max)</span></code> where <code class="docutils literal notranslate"><span class="pre">min</span></code> and <code class="docutils literal notranslate"><span class="pre">max</span></code> are the minimum and maximum number of repetitions, respectively.  A missing value <code class="docutils literal notranslate"><span class="pre">min</span></code> stands for zero; a missing value <code class="docutils literal notranslate"><span class="pre">max</span></code> for infinity.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">identifier_grammar_fn</span><span class="p">():</span>
    <span class="n">identifier</span> <span class="o">=</span> <span class="n">idchar</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
</pre></div>
</div>
</div>
</div>
<p>With the <code class="docutils literal notranslate"><span class="pre">*</span></code> operator, we can generalize the EBNF operators – <code class="docutils literal notranslate"><span class="pre">?</span></code> becomes (0,1), <code class="docutils literal notranslate"><span class="pre">*</span></code> becomes (0,), and <code class="docutils literal notranslate"><span class="pre">+</span></code> becomes (1,).  Write a converter that takes an extended grammar defined using <code class="docutils literal notranslate"><span class="pre">*</span></code>, parse it, and convert it into BNF.</p>
<p><strong>Solution.</strong> No solution yet :-)</p>
</section>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="MutationAnalysis.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Mutation Analysis</p>
      </div>
    </a>
    <a class="right-next"
       href="GrammarFuzzer.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Efficient Grammar Fuzzing</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#input-languages">Input Languages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#grammars">Grammars</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rules-and-expansions">Rules and Expansions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#arithmetic-expressions">Arithmetic Expressions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#representing-grammars-in-python">Representing Grammars in Python</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-a-grammar-type">Excursion: A <code class="docutils literal notranslate"><span class="pre">Grammar</span></code> Type</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#end-of-excursion">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#some-definitions">Some Definitions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-simple-grammar-fuzzer">A Simple Grammar Fuzzer</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-grammars-as-railroad-diagrams">Visualizing Grammars as Railroad Diagrams</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-syntax-diagram">Excursion: Implementing <code class="docutils literal notranslate"><span class="pre">syntax_diagram()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#some-grammars">Some Grammars</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-cgi-grammar">A CGI Grammar</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-url-grammar">A URL Grammar</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-natural-language-grammar">A Natural Language Grammar</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#grammars-as-mutation-seeds">Grammars as Mutation Seeds</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-grammar-toolbox">A Grammar Toolbox</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#escapes">Escapes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extending-grammars">Extending Grammars</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#character-classes">Character Classes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#grammar-shortcuts">Grammar Shortcuts</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-convert-ebnf-grammar">Excursion: Implementing <code class="docutils literal notranslate"><span class="pre">convert_ebnf_grammar()</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-new-symbols">Creating New Symbols</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#expanding-parenthesized-expressions">Expanding Parenthesized Expressions</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#expanding-operators">Expanding Operators</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#all-together">All Together</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#grammar-extensions">Grammar Extensions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-opts">Excursion: Implementing <code class="docutils literal notranslate"><span class="pre">opts()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">End of Excursion</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-grammars">Checking Grammars</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-is-valid-grammar">Excursion: Implementing <code class="docutils literal notranslate"><span class="pre">is_valid_grammar()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-a-json-grammar">Exercise 1: A JSON Grammar</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-finding-bugs">Exercise 2: Finding Bugs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-grammars-with-regular-expressions">Exercise 3: Grammars with Regular Expressions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-convert-regular-expressions">Part 1: Convert regular expressions</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-identify-and-expand-regular-expressions">Part 2: Identify and expand regular expressions</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-4-defining-grammars-as-functions-advanced">Exercise 4: Defining Grammars as Functions (Advanced)</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-a-one-single-function">Part 1 (a): One Single Function</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-b-alternative-representations">Part 1 (b): Alternative representations</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-extended-grammars">Part 2: Extended Grammars</a></li>
</ul>
</li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Andreas Zeller, Rahul Gopinath, Marcel Böhme, Gordon Fraser, and Christian Holler
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2021-2025 CISPA Helmholtz Center for Information Security (www.cispa.de); © Copyright 2018-2020 Saarland University, authors, and contributors. All Rights Reserved.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>