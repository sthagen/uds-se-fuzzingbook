
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Efficient Grammar Fuzzing &#8212; The Fuzzing Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=42e1b1a5" />
    <link rel="stylesheet" type="text/css" href="_static/mastodon-timeline.css?v=f82c2b23" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'GrammarFuzzer';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Grammar Coverage" href="GrammarCoverageFuzzer.html" />
    <link rel="prev" title="Fuzzing with Grammars" href="Grammars.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content"><p>This is a beta version of fuzzingbook.org, currently in development. See the <a href="https://fuzzingbook.org/"  style="color:white!important;">classic site</a> for resources.</p></div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/fuzzingbook.png" class="logo__image only-light" alt="The Fuzzing Book - Home"/>
    <script>document.write(`<img src="_static/fuzzingbook.png" class="logo__image only-dark" alt="The Fuzzing Book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    The Fuzzing Book
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tours.html">Tours through the Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="Intro_Testing.html">Introduction to Software Testing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Lexical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Fuzzer.html">Fuzzing: Breaking Things with Random Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Coverage.html">Code Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="MutationFuzzer.html">Mutation-Based Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GreyboxFuzzer.html">Greybox Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="SearchBasedFuzzer.html">Search-Based Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="MutationAnalysis.html">Mutation Analysis</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Syntactical Fuzzing</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Grammars.html">Fuzzing with Grammars</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Efficient Grammar Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarCoverageFuzzer.html">Grammar Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="Parser.html">Parsing Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ProbabilisticGrammarFuzzer.html">Probabilistic Grammar Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GeneratorGrammarFuzzer.html">Fuzzing with Generators</a></li>

<li class="toctree-l1"><a class="reference internal" href="GreyboxGrammarFuzzer.html">Greybox Fuzzing with Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="Reducer.html">Reducing Failure-Inducing Inputs</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Semantical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="FuzzingWithConstraints.html">Fuzzing with Constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarMiner.html">Mining Input Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="InformationFlow.html">Tracking Information Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="ConcolicFuzzer.html">Concolic Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="SymbolicFuzzer.html">Symbolic Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="DynamicInvariants.html">Mining Function Specifications</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Domain-Specific Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ConfigurationFuzzer.html">Testing Configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="APIFuzzer.html">Fuzzing APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Carver.html">Carving Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="PythonFuzzer.html">Testing Compilers</a></li>
<li class="toctree-l1"><a class="reference internal" href="WebFuzzer.html">Testing Web Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="GUIFuzzer.html">Testing Graphical User Interfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Managing Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="FuzzingInTheLarge.html">Fuzzing in the Large</a></li>
<li class="toctree-l1"><a class="reference internal" href="WhenToStopFuzzing.html">When To Stop Fuzzing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="AcademicPrototyping.html">Academic Prototyping</a></li>
<li class="toctree-l1"><a class="reference internal" href="PrototypingWithPython.html">Prototyping with Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="ExpectError.html">Error Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timer.html">Timer</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timeout.html">Timeout</a></li>
<li class="toctree-l1"><a class="reference internal" href="ClassDiagram.html">Class Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="RailroadDiagrams.html">Railroad Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="ControlFlow.html">Control Flow Graph</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About This Book</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ReleaseNotes.html">Fuzzingbook Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="Importing.html">Using Fuzzingbook Code in your own Programs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Guide_for_Authors.html">Guide for Authors</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/master?urlpath=tree/docs/notebooks/GrammarFuzzer.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/uds-se/fuzzingbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/uds-se/fuzzingbook/issues/new?title=Issue%20on%20page%20%2FGrammarFuzzer.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/GrammarFuzzer.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Efficient Grammar Fuzzing</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Efficient Grammar Fuzzing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#derivation-trees">Derivation Trees</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#an-insufficient-algorithm">An Insufficient Algorithm</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Derivation Trees</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#representing-derivation-trees">Representing Derivation Trees</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-display-tree">Excursion: Implementing <code class="docutils literal notranslate"><span class="pre">display_tree()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#end-of-excursion">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-source-code-and-example-for-display-annotated-tree">Excursion: Source code and example for <code class="docutils literal notranslate"><span class="pre">display_annotated_tree()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#expanding-a-node">Expanding a Node</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-check-grammar-implementation">Excursion: <code class="docutils literal notranslate"><span class="pre">check_grammar()</span></code> implementation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#picking-a-children-alternative-to-be-expanded">Picking a Children Alternative to be Expanded</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-a-list-of-possible-expansions">Getting a List of Possible Expansions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-expansion-to-children">Excursion: Implementing <code class="docutils literal notranslate"><span class="pre">expansion_to_children()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#putting-things-together">Putting Things Together</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-expand-node-randomly-implementation">Excursion: <code class="docutils literal notranslate"><span class="pre">expand_node_randomly()</span></code> implementation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">End of Excursion</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#expanding-a-tree">Expanding a Tree</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-expand-tree-once-implementation">Excursion: <code class="docutils literal notranslate"><span class="pre">expand_tree_once()</span></code> implementation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#closing-the-expansion">Closing the Expansion</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-cost-functions">Excursion: Implementing Cost Functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">End of Excursion</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-expand-node-by-cost-implementation">Excursion: <code class="docutils literal notranslate"><span class="pre">expand_node_by_cost()</span></code> implementation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">End of Excursion</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#node-inflation">Node Inflation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#three-expansion-phases">Three Expansion Phases</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementation-of-three-phase-expand-tree">Excursion: Implementation of three-phase <code class="docutils literal notranslate"><span class="pre">expand_tree()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#putting-it-all-together">Putting it all Together</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">Synopsis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">Efficient Grammar Fuzzing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">Derivation Trees</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extending-grammars">Extending Grammars</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#applying-grammars">Applying Grammars</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-caching-method-results">Exercise 1: Caching Method Results</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-grammar-pre-compilation">Exercise 2: Grammar Pre-Compilation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-maintaining-trees-to-be-expanded">Exercise 3: Maintaining Trees to be Expanded</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-4-alternate-random-expansions">Exercise 4: Alternate Random Expansions</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="efficient-grammar-fuzzing">
<h1>Efficient Grammar Fuzzing<a class="headerlink" href="#efficient-grammar-fuzzing" title="Link to this heading">#</a></h1>
<p>In the <a class="reference internal" href="Grammars.html"><span class="std std-doc">chapter on grammars</span></a>, we have seen how to use <em>grammars</em> for very effective and efficient testing.  In this chapter, we refine the previous <em>string-based</em> algorithm into a <em>tree-based</em> algorithm, which is much faster and allows for much more control over the production of fuzz inputs.</p>
<p>The algorithm in this chapter serves as a foundation for several more techniques; this chapter thus is a “hub” in the book.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bookutils</span> <span class="kn">import</span> <span class="n">YouTubeVideo</span>
<span class="n">YouTubeVideo</span><span class="p">(</span><span class="s1">&#39;Ohl8TLcLl3A&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="640"
            height="360"
            src="https://www.youtube-nocookie.com/embed/Ohl8TLcLl3A"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<p><strong>Prerequisites</strong></p>
<ul class="simple">
<li><p>You should know how grammar-based fuzzing works, e.g. from the <a class="reference internal" href="Grammars.html"><span class="std std-doc">chapter on grammars</span></a>.</p></li>
</ul>
<section id="synopsis">
<h2>Synopsis<a class="headerlink" href="#synopsis" title="Link to this heading">#</a></h2>
<!-- Automatically generated. Do not edit. -->
<p>To <a class="reference internal" href="Importing.html"><span class="std std-doc">use the code provided in this chapter</span></a>, write</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fuzzingbook.GrammarFuzzer</span> <span class="kn">import</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>and then make use of the following features.</p>
<section id="id1">
<h3>Efficient Grammar Fuzzing<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<p>This chapter introduces <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code>, an efficient grammar fuzzer that takes a grammar to produce syntactically valid input strings.  Here’s a typical usage:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">Grammars</span> <span class="kn">import</span> <span class="n">US_PHONE_GRAMMAR</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">phone_fuzzer</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">US_PHONE_GRAMMAR</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">phone_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
<span class="go">&#39;(771)306-0659&#39;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code> constructor takes a number of keyword arguments to control its behavior.  <code class="docutils literal notranslate"><span class="pre">start_symbol</span></code>, for instance, allows setting the symbol that expansion starts with (instead of <code class="docutils literal notranslate"><span class="pre">&lt;start&gt;</span></code>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">area_fuzzer</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">US_PHONE_GRAMMAR</span><span class="p">,</span> <span class="n">start_symbol</span><span class="o">=</span><span class="s1">&#39;&lt;area&gt;&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">area_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
<span class="go">&#39;409&#39;</span>
</pre></div>
</div>
<p>Here’s how to parameterize the <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code> constructor:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Produce</span> <span class="n">strings</span> <span class="kn">from</span> <span class="err">`</span><span class="n">grammar</span><span class="err">`</span><span class="p">,</span> <span class="n">starting</span> <span class="k">with</span> <span class="err">`</span><span class="n">start_symbol</span><span class="err">`</span><span class="o">.</span>
<span class="n">If</span> <span class="err">`</span><span class="n">min_nonterminals</span><span class="err">`</span> <span class="ow">or</span> <span class="err">`</span><span class="n">max_nonterminals</span><span class="err">`</span> <span class="ow">is</span> <span class="n">given</span><span class="p">,</span> <span class="n">use</span> <span class="n">them</span> <span class="k">as</span> <span class="n">limits</span> 
<span class="k">for</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">nonterminals</span> <span class="n">produced</span><span class="o">.</span>  
<span class="n">If</span> <span class="err">`</span><span class="n">disp</span><span class="err">`</span> <span class="ow">is</span> <span class="nb">set</span><span class="p">,</span> <span class="n">display</span> <span class="n">the</span> <span class="n">intermediate</span> <span class="n">derivation</span> <span class="n">trees</span><span class="o">.</span>
<span class="n">If</span> <span class="err">`</span><span class="n">log</span><span class="err">`</span> <span class="ow">is</span> <span class="nb">set</span><span class="p">,</span> <span class="n">show</span> <span class="n">intermediate</span> <span class="n">steps</span> <span class="k">as</span> <span class="n">text</span> <span class="n">on</span> <span class="n">standard</span> <span class="n">output</span><span class="o">.</span>

</pre></div>
</div>
<p><img alt="" src="_images/GrammarFuzzer-synopsis-1.svg" /></p>
</section>
<section id="derivation-trees">
<h3>Derivation Trees<a class="headerlink" href="#derivation-trees" title="Link to this heading">#</a></h3>
<p>Internally, <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code> makes use of <a class="reference internal" href="#Derivation-Trees"><span class="xref myst">derivation trees</span></a>, which it expands step by step.  After producing a string, the tree produced can be accessed in the <code class="docutils literal notranslate"><span class="pre">derivation_tree</span></code> attribute.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">display_tree</span><span class="p">(</span><span class="n">phone_fuzzer</span><span class="o">.</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="" src="_images/GrammarFuzzer-synopsis-2.svg" /></p>
<p>In the internal representation of a derivation tree, a <em>node</em> is a pair (<code class="docutils literal notranslate"><span class="pre">symbol</span></code>, <code class="docutils literal notranslate"><span class="pre">children</span></code>).  For nonterminals, <code class="docutils literal notranslate"><span class="pre">symbol</span></code> is the symbol that is being expanded, and <code class="docutils literal notranslate"><span class="pre">children</span></code> is a list of further nodes.  For terminals, <code class="docutils literal notranslate"><span class="pre">symbol</span></code> is the terminal string, and <code class="docutils literal notranslate"><span class="pre">children</span></code> is empty.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">phone_fuzzer</span><span class="o">.</span><span class="n">derivation_tree</span>
<span class="go">(&#39;&lt;start&gt;&#39;,</span>
<span class="go"> [(&#39;&lt;phone-number&gt;&#39;,</span>
<span class="go">   [(&#39;(&#39;, []),</span>
<span class="go">    (&#39;&lt;area&gt;&#39;,</span>
<span class="go">     [(&#39;&lt;lead-digit&gt;&#39;, [(&#39;7&#39;, [])]),</span>
<span class="go">      (&#39;&lt;digit&gt;&#39;, [(&#39;7&#39;, [])]),</span>
<span class="go">      (&#39;&lt;digit&gt;&#39;, [(&#39;1&#39;, [])])]),</span>
<span class="go">    (&#39;)&#39;, []),</span>
<span class="go">    (&#39;&lt;exchange&gt;&#39;,</span>
<span class="go">     [(&#39;&lt;lead-digit&gt;&#39;, [(&#39;3&#39;, [])]),</span>
<span class="go">      (&#39;&lt;digit&gt;&#39;, [(&#39;0&#39;, [])]),</span>
<span class="go">      (&#39;&lt;digit&gt;&#39;, [(&#39;6&#39;, [])])]),</span>
<span class="go">    (&#39;-&#39;, []),</span>
<span class="go">    (&#39;&lt;line&gt;&#39;,</span>
<span class="go">     [(&#39;&lt;digit&gt;&#39;, [(&#39;0&#39;, [])]),</span>
<span class="go">      (&#39;&lt;digit&gt;&#39;, [(&#39;6&#39;, [])]),</span>
<span class="go">      (&#39;&lt;digit&gt;&#39;, [(&#39;5&#39;, [])]),</span>
<span class="go">      (&#39;&lt;digit&gt;&#39;, [(&#39;9&#39;, [])])])])])</span>
</pre></div>
</div>
<p>The chapter contains various helpers to work with derivation trees, including visualization tools – notably, <code class="docutils literal notranslate"><span class="pre">display_tree()</span></code>, above.</p>
</section>
</section>
<section id="an-insufficient-algorithm">
<h2>An Insufficient Algorithm<a class="headerlink" href="#an-insufficient-algorithm" title="Link to this heading">#</a></h2>
<p>In the <a class="reference internal" href="Grammars.html"><span class="std std-doc">previous chapter</span></a>, we have introduced the <code class="docutils literal notranslate"><span class="pre">simple_grammar_fuzzer()</span></code> function which takes a grammar and automatically produces a syntactically valid string from it.  However, <code class="docutils literal notranslate"><span class="pre">simple_grammar_fuzzer()</span></code> is just what its name suggests – simple.  To illustrate the problem, let us get back to the <code class="docutils literal notranslate"><span class="pre">expr_grammar</span></code> we created from <code class="docutils literal notranslate"><span class="pre">EXPR_GRAMMAR_BNF</span></code> in the <a class="reference internal" href="Grammars.html"><span class="std std-doc">chapter on grammars</span></a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bookutils.setup</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bookutils</span> <span class="kn">import</span> <span class="n">quiz</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bookutils</span> <span class="kn">import</span> <span class="n">unicode_escape</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Grammars</span> <span class="kn">import</span> <span class="n">EXPR_EBNF_GRAMMAR</span><span class="p">,</span> <span class="n">convert_ebnf_grammar</span><span class="p">,</span> <span class="n">Grammar</span><span class="p">,</span> <span class="n">Expansion</span>
<span class="kn">from</span> <span class="nn">Grammars</span> <span class="kn">import</span> <span class="n">simple_grammar_fuzzer</span><span class="p">,</span> <span class="n">is_valid_grammar</span><span class="p">,</span> <span class="n">exp_string</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">expr_grammar</span> <span class="o">=</span> <span class="n">convert_ebnf_grammar</span><span class="p">(</span><span class="n">EXPR_EBNF_GRAMMAR</span><span class="p">)</span>
<span class="n">expr_grammar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&lt;start&gt;&#39;: [&#39;&lt;expr&gt;&#39;],
 &#39;&lt;expr&gt;&#39;: [&#39;&lt;term&gt; + &lt;expr&gt;&#39;, &#39;&lt;term&gt; - &lt;expr&gt;&#39;, &#39;&lt;term&gt;&#39;],
 &#39;&lt;term&gt;&#39;: [&#39;&lt;factor&gt; * &lt;term&gt;&#39;, &#39;&lt;factor&gt; / &lt;term&gt;&#39;, &#39;&lt;factor&gt;&#39;],
 &#39;&lt;factor&gt;&#39;: [&#39;&lt;sign-1&gt;&lt;factor&gt;&#39;, &#39;(&lt;expr&gt;)&#39;, &#39;&lt;integer&gt;&lt;symbol-1&gt;&#39;],
 &#39;&lt;sign&gt;&#39;: [&#39;+&#39;, &#39;-&#39;],
 &#39;&lt;integer&gt;&#39;: [&#39;&lt;digit-1&gt;&#39;],
 &#39;&lt;digit&gt;&#39;: [&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;],
 &#39;&lt;symbol&gt;&#39;: [&#39;.&lt;integer&gt;&#39;],
 &#39;&lt;sign-1&gt;&#39;: [&#39;&#39;, &#39;&lt;sign&gt;&#39;],
 &#39;&lt;symbol-1&gt;&#39;: [&#39;&#39;, &#39;&lt;symbol&gt;&#39;],
 &#39;&lt;digit-1&gt;&#39;: [&#39;&lt;digit&gt;&#39;, &#39;&lt;digit&gt;&lt;digit-1&gt;&#39;]}
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">expr_grammar</span></code> has an interesting property.  If we feed it into <code class="docutils literal notranslate"><span class="pre">simple_grammar_fuzzer()</span></code>, the function gets stuck:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ExpectError</span> <span class="kn">import</span> <span class="n">ExpectTimeout</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectTimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">simple_grammar_fuzzer</span><span class="p">(</span><span class="n">grammar</span><span class="o">=</span><span class="n">expr_grammar</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_9136/3259437052.py&quot;, line 2, in &lt;module&gt;
    simple_grammar_fuzzer(grammar=expr_grammar, max_nonterminals=3)
  File &quot;Grammars.ipynb&quot;, line 87, in simple_grammar_fuzzer
    symbol_to_expand = random.choice(nonterminals(term))
                                     ^^^^^^^^^^^^^^^^^^
  File &quot;Grammars.ipynb&quot;, line 61, in nonterminals
    return RE_NONTERMINAL.findall(expansion)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;Timeout.ipynb&quot;, line 43, in timeout_handler
    raise TimeoutError()
TimeoutError (expected)
</pre></div>
</div>
</div>
</div>
<p>Why is that so?  Have a look at the grammar; remember what you know about <code class="docutils literal notranslate"><span class="pre">simple_grammar_fuzzer()</span></code>; and run <code class="docutils literal notranslate"><span class="pre">simple_grammar_fuzzer()</span></code> with <code class="docutils literal notranslate"><span class="pre">log=true</span></code> argument to see the expansions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">quiz</span><span class="p">(</span><span class="s2">&quot;Why does `simple_grammar_fuzzer()` hang?&quot;</span><span class="p">,</span>
     <span class="p">[</span>
         <span class="s2">&quot;It produces an infinite number of additions&quot;</span><span class="p">,</span>
         <span class="s2">&quot;It produces an infinite number of digits&quot;</span><span class="p">,</span>
         <span class="s2">&quot;It produces an infinite number of parentheses&quot;</span><span class="p">,</span>
         <span class="s2">&quot;It produces an infinite number of signs&quot;</span><span class="p">,</span>
     <span class="p">],</span> <span class="s1">&#39;(3 * 3 * 3) ** (3 / (3 * 3))&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">Why does <code>simple_grammar_fuzzer()</code> hang?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="e6bd93ec-d3ed-11ef-8343-6298cf1a5790" id="e6bd93ec-d3ed-11ef-8343-6298cf1a5790-1" onclick="clear_selection('e6bd93ec-d3ed-11ef-8343-6298cf1a5790')">
        <label id="e6bd93ec-d3ed-11ef-8343-6298cf1a5790-1-label" for="e6bd93ec-d3ed-11ef-8343-6298cf1a5790-1">It produces an infinite number of additions</label><br>
    
        <input type="radio" name="e6bd93ec-d3ed-11ef-8343-6298cf1a5790" id="e6bd93ec-d3ed-11ef-8343-6298cf1a5790-2" onclick="clear_selection('e6bd93ec-d3ed-11ef-8343-6298cf1a5790')">
        <label id="e6bd93ec-d3ed-11ef-8343-6298cf1a5790-2-label" for="e6bd93ec-d3ed-11ef-8343-6298cf1a5790-2">It produces an infinite number of digits</label><br>
    
        <input type="radio" name="e6bd93ec-d3ed-11ef-8343-6298cf1a5790" id="e6bd93ec-d3ed-11ef-8343-6298cf1a5790-3" onclick="clear_selection('e6bd93ec-d3ed-11ef-8343-6298cf1a5790')">
        <label id="e6bd93ec-d3ed-11ef-8343-6298cf1a5790-3-label" for="e6bd93ec-d3ed-11ef-8343-6298cf1a5790-3">It produces an infinite number of parentheses</label><br>
    
        <input type="radio" name="e6bd93ec-d3ed-11ef-8343-6298cf1a5790" id="e6bd93ec-d3ed-11ef-8343-6298cf1a5790-4" onclick="clear_selection('e6bd93ec-d3ed-11ef-8343-6298cf1a5790')">
        <label id="e6bd93ec-d3ed-11ef-8343-6298cf1a5790-4-label" for="e6bd93ec-d3ed-11ef-8343-6298cf1a5790-4">It produces an infinite number of signs</label><br>
    
    </div>
    </p>
    <input id="e6bd93ec-d3ed-11ef-8343-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('e6bd93ec-d3ed-11ef-8343-6298cf1a5790', 8, 0, '(3 * 3 * 3) ** (3 / (3 * 3))')">
    <span class="quiz_hint" id="e6bd93ec-d3ed-11ef-8343-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>Indeed! The problem is in this rule:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">expr_grammar</span><span class="p">[</span><span class="s1">&#39;&lt;factor&gt;&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;&lt;sign-1&gt;&lt;factor&gt;&#39;, &#39;(&lt;expr&gt;)&#39;, &#39;&lt;integer&gt;&lt;symbol-1&gt;&#39;]
</pre></div>
</div>
</div>
</div>
<p>Here, any choice except for <code class="docutils literal notranslate"><span class="pre">(expr)</span></code> increases the number of symbols, even if only temporary.  Since we place a hard limit on the number of symbols to expand, the only choice left for expanding <code class="docutils literal notranslate"><span class="pre">&lt;factor&gt;</span></code> is <code class="docutils literal notranslate"><span class="pre">(&lt;expr&gt;)</span></code>, which leads to an <em>infinite addition of parentheses.</em></p>
<p>The problem of potentially infinite expansion is only one of the problems with <code class="docutils literal notranslate"><span class="pre">simple_grammar_fuzzer()</span></code>.  More problems include:</p>
<ol class="arabic simple">
<li><p><em>It is inefficient</em>.  With each iteration, this fuzzer would go search the string produced so far for symbols to expand.  This becomes inefficient as the production string grows.</p></li>
<li><p><em>It is hard to control.</em>  Even while limiting the number of symbols, it is still possible to obtain very long strings – and even infinitely long ones, as discussed above.</p></li>
</ol>
<p>Let us illustrate both problems by plotting the time required for strings of different lengths.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Grammars</span> <span class="kn">import</span> <span class="n">simple_grammar_fuzzer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Grammars</span> <span class="kn">import</span> <span class="n">START_SYMBOL</span><span class="p">,</span> <span class="n">EXPR_GRAMMAR</span><span class="p">,</span> <span class="n">URL_GRAMMAR</span><span class="p">,</span> <span class="n">CGI_GRAMMAR</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Grammars</span> <span class="kn">import</span> <span class="n">RE_NONTERMINAL</span><span class="p">,</span> <span class="n">nonterminals</span><span class="p">,</span> <span class="n">is_nonterminal</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Timer</span> <span class="kn">import</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trials</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">xs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">ys</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trials</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">simple_grammar_fuzzer</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
    <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">average_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span> <span class="o">/</span> <span class="n">trials</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Average time:&quot;</span><span class="p">,</span> <span class="n">average_time</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Average time: 0.10001757324207575
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Time required for generating an output&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/9c5c8a007c91e6e29123f3be585fcd6323746bbb5ae71bfdedbb5d4665058653.png" src="_images/9c5c8a007c91e6e29123f3be585fcd6323746bbb5ae71bfdedbb5d4665058653.png" />
</div>
</div>
<p>We see that (1) the time needed to generate an output increases quadratically with the length of that output, and that (2) a large portion of the produced outputs are tens of thousands of characters long.</p>
<p>To address these problems, we need a <em>smarter algorithm</em> – one that is more efficient, that gets us better control over expansions, and that is able to foresee in <code class="docutils literal notranslate"><span class="pre">expr_grammar</span></code> that the <code class="docutils literal notranslate"><span class="pre">(expr)</span></code> alternative yields a potentially infinite expansion, in contrast to the other two.</p>
</section>
<section id="id2">
<h2>Derivation Trees<a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<p>To both obtain a more efficient algorithm <em>and</em> exercise better control over expansions, we will use a special representation for the strings that our grammar produces.  The general idea is to use a <em>tree</em> structure that will be subsequently expanded – a so-called <em>derivation tree</em>.  This representation allows us to always keep track of our expansion status – answering questions such as which elements have been expanded into which others, and which symbols still need to be expanded.  Furthermore, adding new elements to a tree is far more efficient than replacing strings again and again.</p>
<p>Like other trees used in programming, a derivation tree (also known as <em>parse tree</em> or <em>concrete syntax tree</em>) consists of <em>nodes</em> which have other nodes (called <em>child nodes</em>) as their <em>children</em>.  The tree starts with one node that has no parent; this is called the <em>root node</em>; a node without children is called a <em>leaf</em>.</p>
<p>The grammar expansion process with derivation trees is illustrated in the following steps, using the arithmetic grammar <a class="reference internal" href="Grammars.html"><span class="std std-doc">from
the chapter on grammars</span></a>.  We start with a single node as root of the tree, representing the <em>start symbol</em> – in our case <code class="docutils literal notranslate"><span class="pre">&lt;start&gt;</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="kn">from</span> <span class="nn">graphviz</span> <span class="kn">import</span> <span class="n">Digraph</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="n">tree</span> <span class="o">=</span> <span class="n">Digraph</span><span class="p">(</span><span class="s2">&quot;root&quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;plain&#39;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\&lt;start\&gt;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="n">tree</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/09e99f534577415d68aa4fbc05807cc0a184005e4a71f6344d399c03f9752c03.svg" src="_images/09e99f534577415d68aa4fbc05807cc0a184005e4a71f6344d399c03f9752c03.svg" />
</div>
</div>
<p>To expand the tree, we traverse it, searching for a nonterminal symbol <span class="math notranslate nohighlight">\(S\)</span> without children.  <span class="math notranslate nohighlight">\(S\)</span> thus is a symbol that still has to be expanded.  We then chose an expansion for <span class="math notranslate nohighlight">\(S\)</span> from the grammar.  Then, we add the expansion as a new child of <span class="math notranslate nohighlight">\(S\)</span>.  For our start symbol <code class="docutils literal notranslate"><span class="pre">&lt;start&gt;</span></code>, the only expansion is <code class="docutils literal notranslate"><span class="pre">&lt;expr&gt;</span></code>, so we add it as a child.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="n">tree</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\&lt;start\&gt;&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\&lt;expr\&gt;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="n">tree</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/227cb6dc10ef6ee6fcabe59c5e6654c03d93ac7115f7ab678c0e738b26961eab.svg" src="_images/227cb6dc10ef6ee6fcabe59c5e6654c03d93ac7115f7ab678c0e738b26961eab.svg" />
</div>
</div>
<p>To construct the produced string from a derivation tree, we traverse the tree in order and collect the symbols at the leaves of the tree.  In the case above, we obtain the string <code class="docutils literal notranslate"><span class="pre">&quot;&lt;expr&gt;&quot;</span></code>.</p>
<p>To further expand the tree, we choose another symbol to expand, and add its expansion as new children.  This would get us the <code class="docutils literal notranslate"><span class="pre">&lt;expr&gt;</span></code> symbol, which gets expanded into <code class="docutils literal notranslate"><span class="pre">&lt;expr&gt;</span> <span class="pre">+</span> <span class="pre">&lt;term&gt;</span></code>, adding three children.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="n">tree</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\&lt;expr\&gt;&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\&lt;expr\&gt; &quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\&lt;expr\&gt;&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;+&quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\&lt;expr\&gt;&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\&lt;term\&gt;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="n">tree</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/4003e319ba0e8612858a153c9f57ca71825f80645a6e8a0b7605b5d942a15eb6.svg" src="_images/4003e319ba0e8612858a153c9f57ca71825f80645a6e8a0b7605b5d942a15eb6.svg" />
</div>
</div>
<p>We repeat the expansion until there are no symbols left to expand:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="n">tree</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\&lt;expr\&gt; &quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\&lt;term\&gt; &quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\&lt;term\&gt; &quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\&lt;factor\&gt; &quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\&lt;factor\&gt; &quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\&lt;integer\&gt; &quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\&lt;integer\&gt; &quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\&lt;digit\&gt; &quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\&lt;digit\&gt; &quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;2 &quot;</span><span class="p">)</span>

<span class="n">tree</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\&lt;term\&gt;&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\&lt;factor\&gt;&quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\&lt;factor\&gt;&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\&lt;integer\&gt;&quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\&lt;integer\&gt;&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\&lt;digit\&gt;&quot;</span><span class="p">)</span>
<span class="n">tree</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\&lt;digit\&gt;&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;2&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="n">tree</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/88254d405d67f66e392bc89a450d06e2ceda97653a15dad871ccc749e810cf56.svg" src="_images/88254d405d67f66e392bc89a450d06e2ceda97653a15dad871ccc749e810cf56.svg" />
</div>
</div>
<p>We now have a representation for the string <code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">+</span> <span class="pre">2</span></code>.  In contrast to the string alone, though, the derivation tree records <em>the entire structure</em> (and production history, or <em>derivation</em> history) of the produced string.  It also allows for simple comparison and manipulation – say, replacing one subtree (substructure) against another.</p>
</section>
<section id="representing-derivation-trees">
<h2>Representing Derivation Trees<a class="headerlink" href="#representing-derivation-trees" title="Link to this heading">#</a></h2>
<p>To represent a derivation tree in Python, we use the following format.  A node is a pair</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">SYMBOL_NAME</span><span class="p">,</span> <span class="n">CHILDREN</span><span class="p">)</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">SYMBOL_NAME</span></code> is a string representing the node (i.e. <code class="docutils literal notranslate"><span class="pre">&quot;&lt;start&gt;&quot;</span></code> or <code class="docutils literal notranslate"><span class="pre">&quot;+&quot;</span></code>) and <code class="docutils literal notranslate"><span class="pre">CHILDREN</span></code> is a list of children nodes.</p>
<p><code class="docutils literal notranslate"><span class="pre">CHILDREN</span></code> can take some special values:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">None</span></code> as a placeholder for future expansion.  This means that the node is a <em>nonterminal symbol</em> that should be expanded further.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">[]</span></code> (i.e., the empty list) to indicate <em>no</em> children.  This means that the node is a <em>terminal symbol</em> that can no longer be expanded.</p></li>
</ol>
<p>The type <code class="docutils literal notranslate"><span class="pre">DerivationTree</span></code> captures this very structure. (<code class="docutils literal notranslate"><span class="pre">Any</span></code> should actually read <code class="docutils literal notranslate"><span class="pre">DerivationTree</span></code>, but the Python static type checker cannot handle recursive types well.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DerivationTree</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span>
</pre></div>
</div>
</div>
</div>
<p>Let us take a very simple derivation tree, representing the intermediate step <code class="docutils literal notranslate"><span class="pre">&lt;expr&gt;</span> <span class="pre">+</span> <span class="pre">&lt;term&gt;</span></code>, above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">derivation_tree</span><span class="p">:</span> <span class="n">DerivationTree</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">,</span>
                   <span class="p">[(</span><span class="s2">&quot;&lt;expr&gt;&quot;</span><span class="p">,</span>
                     <span class="p">[(</span><span class="s2">&quot;&lt;expr&gt;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                      <span class="p">(</span><span class="s2">&quot; + &quot;</span><span class="p">,</span> <span class="p">[]),</span>
                         <span class="p">(</span><span class="s2">&quot;&lt;term&gt;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
                     <span class="p">)])</span>
</pre></div>
</div>
</div>
</div>
<p>To better understand the structure of this tree, let us introduce a function <code class="docutils literal notranslate"><span class="pre">display_tree()</span></code> that visualizes this tree.</p>
<section id="excursion-implementing-display-tree">
<h3>Excursion: Implementing <code class="docutils literal notranslate"><span class="pre">display_tree()</span></code><a class="headerlink" href="#excursion-implementing-display-tree" title="Link to this heading">#</a></h3>
<p>We use the <code class="docutils literal notranslate"><span class="pre">dot</span></code> drawing program from the <code class="docutils literal notranslate"><span class="pre">graphviz</span></code> package algorithmically, traversing the above structure.  (Unless you’re deeply interested in tree visualization, you can directly skip to the example below.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">graphviz</span> <span class="kn">import</span> <span class="n">Digraph</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">string</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">dot_escape</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">show_ascii</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return s in a form suitable for dot.</span>
<span class="sd">    If `show_ascii` is True or length of `s` is 1, also append ascii value.&quot;&quot;&quot;</span>
    <span class="n">escaped_s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">show_ascii</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">show_ascii</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Default: Single chars only</span>

    <span class="k">if</span> <span class="n">show_ascii</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">n (10)&#39;</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">n&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;[,&lt;&gt;</span><span class="se">\\\\</span><span class="s1">&quot;]&#39;</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
            <span class="n">escaped_s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">c</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">printable</span> <span class="ow">and</span> <span class="mi">31</span> <span class="o">&lt;</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">127</span><span class="p">:</span>
            <span class="n">escaped_s</span> <span class="o">+=</span> <span class="n">c</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">escaped_s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">x&#39;</span> <span class="o">+</span> <span class="nb">format</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="s1">&#39;02x&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">show_ascii</span><span class="p">:</span>
            <span class="n">escaped_s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; (</span><span class="si">{</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span>

    <span class="k">return</span> <span class="n">escaped_s</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">dot_escape</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;hello&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">dot_escape</span><span class="p">(</span><span class="s2">&quot;&lt;hello&gt;, world&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&lt;hello</span><span class="se">\\</span><span class="s2">&gt;</span><span class="se">\\</span><span class="s2">, world&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">dot_escape</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">n&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">dot_escape</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">show_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">n&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">dot_escape</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">show_ascii</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">n (10)&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">dot_escape</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">show_ascii</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">n (10)&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">dot_escape</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x01</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">show_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">x01&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">dot_escape</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x01</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">x01 (1)&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>While we are interested at present in visualizing a <code class="docutils literal notranslate"><span class="pre">derivation_tree</span></code>, it is in our interest to generalize the visualization procedure. In particular, it would be helpful if our method <code class="docutils literal notranslate"><span class="pre">display_tree()</span></code> can display <em>any</em> tree    like data structure. To enable this, we define a helper method <code class="docutils literal notranslate"><span class="pre">extract_node()</span></code> that extract the current symbol and  children from a given data structure. The default implementation simply extracts the symbol, children, and           annotation from any <code class="docutils literal notranslate"><span class="pre">derivation_tree</span></code> node.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">extract_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="n">symbol</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="o">*</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">node</span>
    <span class="k">return</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">annotation</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>While visualizing a tree, it is often useful to display certain nodes differently. For example, it is sometimes useful to distinguish between non-processed nodes and processed nodes. We define a helper procedure <code class="docutils literal notranslate"><span class="pre">default_node_attr()</span></code> that provides the basic display, which can be customized by the user.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">default_node_attr</span><span class="p">(</span><span class="n">dot</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">ann</span><span class="p">):</span>
    <span class="n">dot</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">nid</span><span class="p">),</span> <span class="n">dot_escape</span><span class="p">(</span><span class="n">symbol</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Similar to nodes, the edges may also require modifications. We define <code class="docutils literal notranslate"><span class="pre">default_edge_attr()</span></code> as a helper        procedure that can be customized by the user.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">default_edge_attr</span><span class="p">(</span><span class="n">dot</span><span class="p">,</span> <span class="n">start_node</span><span class="p">,</span> <span class="n">stop_node</span><span class="p">):</span>
    <span class="n">dot</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">start_node</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">stop_node</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>While visualizing a tree, one may sometimes wish to change the appearance of the tree. For example, it is      sometimes easier to view the tree if it was laid out left to right rather than top to bottom. We define another      helper procedure <code class="docutils literal notranslate"><span class="pre">default_graph_attr()</span></code> for that.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">default_graph_attr</span><span class="p">(</span><span class="n">dot</span><span class="p">):</span>
    <span class="n">dot</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;plain&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we define a method <code class="docutils literal notranslate"><span class="pre">display_tree()</span></code> that accepts these four functions <code class="docutils literal notranslate"><span class="pre">extract_node()</span></code>,               <code class="docutils literal notranslate"><span class="pre">default_edge_attr()</span></code>, <code class="docutils literal notranslate"><span class="pre">default_node_attr()</span></code> and <code class="docutils literal notranslate"><span class="pre">default_graph_attr()</span></code> and uses them to display the tree.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">display_tree</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">,</span>
                 <span class="n">log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">extract_node</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">extract_node</span><span class="p">,</span>
                 <span class="n">node_attr</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">default_node_attr</span><span class="p">,</span>
                 <span class="n">edge_attr</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">default_edge_attr</span><span class="p">,</span>
                 <span class="n">graph_attr</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">default_graph_attr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>

    <span class="c1"># If we import display_tree, we also have to import its functions</span>
    <span class="kn">from</span> <span class="nn">graphviz</span> <span class="kn">import</span> <span class="n">Digraph</span>

    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">traverse_tree</span><span class="p">(</span><span class="n">dot</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="n">annotation</span><span class="p">)</span> <span class="o">=</span> <span class="n">extract_node</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
        <span class="n">node_attr</span><span class="p">(</span><span class="n">dot</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">annotation</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">children</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
                <span class="k">nonlocal</span> <span class="n">counter</span>
                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">child_id</span> <span class="o">=</span> <span class="n">counter</span>
                <span class="n">edge_attr</span><span class="p">(</span><span class="n">dot</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">child_id</span><span class="p">)</span>
                <span class="n">traverse_tree</span><span class="p">(</span><span class="n">dot</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">child_id</span><span class="p">)</span>

    <span class="n">dot</span> <span class="o">=</span> <span class="n">Digraph</span><span class="p">(</span><span class="n">comment</span><span class="o">=</span><span class="s2">&quot;Derivation Tree&quot;</span><span class="p">)</span>
    <span class="n">graph_attr</span><span class="p">(</span><span class="n">dot</span><span class="p">)</span>
    <span class="n">traverse_tree</span><span class="p">(</span><span class="n">dot</span><span class="p">,</span> <span class="n">derivation_tree</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">dot</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dot</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="end-of-excursion">
<h3>End of Excursion<a class="headerlink" href="#end-of-excursion" title="Link to this heading">#</a></h3>
<p>This is what our tree visualizes into:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_tree</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ef2ab0c09ddfdf05788a4030de6dac91004d49489812c39295ae6342db32a4d5.svg" src="_images/ef2ab0c09ddfdf05788a4030de6dac91004d49489812c39295ae6342db32a4d5.svg" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">quiz</span><span class="p">(</span><span class="s2">&quot;And which of these is the internal representation of `derivation_tree`?&quot;</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="s2">&quot;`(&#39;&lt;start&gt;&#39;, [(&#39;&lt;expr&gt;&#39;, ([&#39;&lt;expr&gt; + &lt;term&gt;&#39;]))])`&quot;</span><span class="p">,</span>
        <span class="s2">&quot;`(&#39;&lt;start&gt;&#39;, [(&#39;&lt;expr&gt;&#39;, ([&#39;&lt;expr&gt;&#39;, &#39; + &#39;, &lt;term&gt;&#39;]))])`&quot;</span><span class="p">,</span>
        <span class="s2">&quot;`&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;`&quot;</span><span class="p">,</span>
        <span class="s2">&quot;`(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, None)`&quot;</span>
    <span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;eleven&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;one&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">And which of these is the internal representation of <code>derivation_tree</code>?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="eb319efa-d3ed-11ef-8343-6298cf1a5790" id="eb319efa-d3ed-11ef-8343-6298cf1a5790-1" onclick="clear_selection('eb319efa-d3ed-11ef-8343-6298cf1a5790')">
        <label id="eb319efa-d3ed-11ef-8343-6298cf1a5790-1-label" for="eb319efa-d3ed-11ef-8343-6298cf1a5790-1"><code>('&lt;start&gt;', [('&lt;expr&gt;', (['&lt;expr&gt; + &lt;term&gt;']))])</code></label><br>
    
        <input type="radio" name="eb319efa-d3ed-11ef-8343-6298cf1a5790" id="eb319efa-d3ed-11ef-8343-6298cf1a5790-2" onclick="clear_selection('eb319efa-d3ed-11ef-8343-6298cf1a5790')">
        <label id="eb319efa-d3ed-11ef-8343-6298cf1a5790-2-label" for="eb319efa-d3ed-11ef-8343-6298cf1a5790-2"><code>('&lt;start&gt;', [('&lt;expr&gt;', (['&lt;expr&gt;', ' + ', &lt;term&gt;']))])</code></label><br>
    
        <input type="radio" name="eb319efa-d3ed-11ef-8343-6298cf1a5790" id="eb319efa-d3ed-11ef-8343-6298cf1a5790-3" onclick="clear_selection('eb319efa-d3ed-11ef-8343-6298cf1a5790')">
        <label id="eb319efa-d3ed-11ef-8343-6298cf1a5790-3-label" for="eb319efa-d3ed-11ef-8343-6298cf1a5790-3"><code>('&lt;start&gt;', [('&lt;expr&gt;', [('&lt;expr&gt;', None), (' + ', []), ('&lt;term&gt;', None)])])</code></label><br>
    
        <input type="radio" name="eb319efa-d3ed-11ef-8343-6298cf1a5790" id="eb319efa-d3ed-11ef-8343-6298cf1a5790-4" onclick="clear_selection('eb319efa-d3ed-11ef-8343-6298cf1a5790')">
        <label id="eb319efa-d3ed-11ef-8343-6298cf1a5790-4-label" for="eb319efa-d3ed-11ef-8343-6298cf1a5790-4"><code>(('&lt;start&gt;', [('&lt;expr&gt;', [('&lt;expr&gt;', None), (' + ', []), ('&lt;term&gt;', None)])]), None)</code></label><br>
    
    </div>
    </p>
    <input id="eb319efa-d3ed-11ef-8343-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('eb319efa-d3ed-11ef-8343-6298cf1a5790', 8, 0, '')">
    <span class="quiz_hint" id="eb319efa-d3ed-11ef-8343-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>You can check it out yourself:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">derivation_tree</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;&lt;start&gt;&#39;, [(&#39;&lt;expr&gt;&#39;, [(&#39;&lt;expr&gt;&#39;, None), (&#39; + &#39;, []), (&#39;&lt;term&gt;&#39;, None)])])
</pre></div>
</div>
</div>
</div>
<p>Within this book, we also occasionally use a function <code class="docutils literal notranslate"><span class="pre">display_annotated_tree()</span></code> which allows adding annotations to individual nodes.</p>
</section>
<section id="excursion-source-code-and-example-for-display-annotated-tree">
<h3>Excursion: Source code and example for <code class="docutils literal notranslate"><span class="pre">display_annotated_tree()</span></code><a class="headerlink" href="#excursion-source-code-and-example-for-display-annotated-tree" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">display_annotated_tree()</span></code> displays an annotated tree structure, and lays out the graph left to right.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">display_annotated_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">,</span>
                           <span class="n">a_nodes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                           <span class="n">a_edges</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span>
                           <span class="n">log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">graph_attr</span><span class="p">(</span><span class="n">dot</span><span class="p">):</span>
        <span class="n">dot</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;plain&#39;</span><span class="p">)</span>
        <span class="n">dot</span><span class="o">.</span><span class="n">graph_attr</span><span class="p">[</span><span class="s1">&#39;rankdir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;LR&#39;</span>

    <span class="k">def</span> <span class="nf">annotate_node</span><span class="p">(</span><span class="n">dot</span><span class="p">,</span> <span class="n">nid</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">ann</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">a_nodes</span><span class="p">:</span>
            <span class="n">dot</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">nid</span><span class="p">),</span> 
                     <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dot_escape</span><span class="p">(</span><span class="n">unicode_escape</span><span class="p">(</span><span class="n">symbol</span><span class="p">)),</span>
                                  <span class="n">a_nodes</span><span class="p">[</span><span class="n">nid</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dot</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">nid</span><span class="p">),</span> <span class="n">dot_escape</span><span class="p">(</span><span class="n">unicode_escape</span><span class="p">(</span><span class="n">symbol</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">annotate_edge</span><span class="p">(</span><span class="n">dot</span><span class="p">,</span> <span class="n">start_node</span><span class="p">,</span> <span class="n">stop_node</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">start_node</span><span class="p">,</span> <span class="n">stop_node</span><span class="p">)</span> <span class="ow">in</span> <span class="n">a_edges</span><span class="p">:</span>
            <span class="n">dot</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">start_node</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">stop_node</span><span class="p">),</span>
                     <span class="n">a_edges</span><span class="p">[(</span><span class="n">start_node</span><span class="p">,</span> <span class="n">stop_node</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dot</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">start_node</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">stop_node</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">display_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">,</span>
                        <span class="n">node_attr</span><span class="o">=</span><span class="n">annotate_node</span><span class="p">,</span>
                        <span class="n">edge_attr</span><span class="o">=</span><span class="n">annotate_edge</span><span class="p">,</span>
                        <span class="n">graph_attr</span><span class="o">=</span><span class="n">graph_attr</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_annotated_tree</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">,</span> <span class="p">{</span><span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;plus&#39;</span><span class="p">},</span> <span class="p">{(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span> <span class="s1">&#39;op&#39;</span><span class="p">},</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/94b3d91ece53454481c57d2b7b0b2679f39252c44b4454660c63b82c8480710f.svg" src="_images/94b3d91ece53454481c57d2b7b0b2679f39252c44b4454660c63b82c8480710f.svg" />
</div>
</div>
</section>
<section id="id3">
<h3>End of Excursion<a class="headerlink" href="#id3" title="Link to this heading">#</a></h3>
<p>If we want to see all the leaf nodes in a tree as a string, the following <code class="docutils literal notranslate"><span class="pre">all_terminals()</span></code> function comes in handy:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">all_terminals</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span> <span class="o">=</span> <span class="n">tree</span>
    <span class="k">if</span> <span class="n">children</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># This is a nonterminal symbol not expanded yet</span>
        <span class="k">return</span> <span class="n">symbol</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># This is a terminal symbol</span>
        <span class="k">return</span> <span class="n">symbol</span>

    <span class="c1"># This is an expanded symbol:</span>
    <span class="c1"># Concatenate all terminal symbols from all children</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">all_terminals</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">children</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_terminals</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;&lt;expr&gt; + &lt;term&gt;&#39;
</pre></div>
</div>
</div>
</div>
<p>The alternative <code class="docutils literal notranslate"><span class="pre">tree_to_string()</span></code> function also converts the tree to a string; however, it replaces nonterminal symbols by empty strings.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">tree_to_string</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">symbol</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">tree</span>
    <span class="k">if</span> <span class="n">children</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tree_to_string</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">children</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">is_nonterminal</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span> <span class="k">else</span> <span class="n">symbol</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tree_to_string</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39; + &#39;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="expanding-a-node">
<h2>Expanding a Node<a class="headerlink" href="#expanding-a-node" title="Link to this heading">#</a></h2>
<p>Let us now develop an algorithm that takes a tree with non-expanded symbols (say, <code class="docutils literal notranslate"><span class="pre">derivation_tree</span></code>, above), and expands all these symbols one after the other.  As with earlier fuzzers, we create a special subclass of <code class="docutils literal notranslate"><span class="pre">Fuzzer</span></code> – in this case, <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code>.  A <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code> gets a grammar and a start symbol; the other parameters will be used later to further control creation and to support debugging.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Fuzzer</span> <span class="kn">import</span> <span class="n">Fuzzer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GrammarFuzzer</span><span class="p">(</span><span class="n">Fuzzer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Produce strings from grammars efficiently, using derivation trees.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">grammar</span><span class="p">:</span> <span class="n">Grammar</span><span class="p">,</span>
                 <span class="n">start_symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">START_SYMBOL</span><span class="p">,</span>
                 <span class="n">min_nonterminals</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                 <span class="n">max_nonterminals</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                 <span class="n">disp</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">log</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce strings from `grammar`, starting with `start_symbol`.</span>
<span class="sd">        If `min_nonterminals` or `max_nonterminals` is given, use them as limits </span>
<span class="sd">        for the number of nonterminals produced.  </span>
<span class="sd">        If `disp` is set, display the intermediate derivation trees.</span>
<span class="sd">        If `log` is set, show intermediate steps as text on standard output.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="o">=</span> <span class="n">grammar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_symbol</span> <span class="o">=</span> <span class="n">start_symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_nonterminals</span> <span class="o">=</span> <span class="n">min_nonterminals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_nonterminals</span> <span class="o">=</span> <span class="n">max_nonterminals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disp</span> <span class="o">=</span> <span class="n">disp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_grammar</span><span class="p">()</span>  <span class="c1"># Invokes is_valid_grammar()</span>
</pre></div>
</div>
</div>
</div>
<p>To add further methods to <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code>, we use the hack already introduced for <a class="reference internal" href="MutationFuzzer.html"><span class="std std-doc">the <code class="docutils literal notranslate"><span class="pre">MutationFuzzer</span></code> class</span></a>.  The construct</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GrammarFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">new_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
<p>allows us to add a new method <code class="docutils literal notranslate"><span class="pre">new_method()</span></code> to the <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code> class. (Actually, we get a new <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code> class that extends the old one, but for all our purposes, this does not matter.)</p>
<section id="excursion-check-grammar-implementation">
<h3>Excursion: <code class="docutils literal notranslate"><span class="pre">check_grammar()</span></code> implementation<a class="headerlink" href="#excursion-check-grammar-implementation" title="Link to this heading">#</a></h3>
<p>We can use the above hack to define the helper method <code class="docutils literal notranslate"><span class="pre">check_grammar()</span></code>, which checks the given grammar for consistency:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GrammarFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">check_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check the grammar passed&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span>
        <span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">,</span>
            <span class="n">start_symbol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_symbol</span><span class="p">,</span>
            <span class="n">supported_opts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">supported_opts</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">supported_opts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set of supported options. To be overloaded in subclasses.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># We don&#39;t support specific options</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id4">
<h3>End of Excursion<a class="headerlink" href="#id4" title="Link to this heading">#</a></h3>
<p>Let us now define a helper method <code class="docutils literal notranslate"><span class="pre">init_tree()</span></code> that constructs a tree with just the start symbol:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GrammarFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">init_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DerivationTree</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_symbol</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">)</span>
<span class="n">display_tree</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">init_tree</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/83c7f3fbb7ee284cf25ef09c293eb9c26b552cd73db02fd3d7c2da496fcc1fec.svg" src="_images/83c7f3fbb7ee284cf25ef09c293eb9c26b552cd73db02fd3d7c2da496fcc1fec.svg" />
</div>
</div>
<p>This is the tree we want to expand.</p>
</section>
<section id="picking-a-children-alternative-to-be-expanded">
<h3>Picking a Children Alternative to be Expanded<a class="headerlink" href="#picking-a-children-alternative-to-be-expanded" title="Link to this heading">#</a></h3>
<p>One of the central methods in <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code> is <code class="docutils literal notranslate"><span class="pre">choose_node_expansion()</span></code>. This method gets a node (say, the <code class="docutils literal notranslate"><span class="pre">&lt;start&gt;</span></code> node) and a list of possible lists of children to be expanded (one for every possible expansion from the grammar), chooses one of them, and returns its index in the possible children list.</p>
<p>By overloading this method (notably in later chapters), we can implement different strategies – for now, it simply randomly picks one of the given lists of children (which in turn are lists of derivation trees).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GrammarFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">choose_node_expansion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">,</span>
                              <span class="n">children_alternatives</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">DerivationTree</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return index of expansion in `children_alternatives` to be selected.</span>
<span class="sd">           &#39;children_alternatives`: a list of possible children for `node`.</span>
<span class="sd">           Defaults to random. To be overloaded in subclasses.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">children_alternatives</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="getting-a-list-of-possible-expansions">
<h3>Getting a List of Possible Expansions<a class="headerlink" href="#getting-a-list-of-possible-expansions" title="Link to this heading">#</a></h3>
<p>To actually obtain the list of possible children, we will need a helper function <code class="docutils literal notranslate"><span class="pre">expansion_to_children()</span></code> that takes an expansion string and decomposes it into a list of derivation trees – one for each symbol (terminal or nonterminal) in the string.</p>
<section id="excursion-implementing-expansion-to-children">
<h4>Excursion: Implementing <code class="docutils literal notranslate"><span class="pre">expansion_to_children()</span></code><a class="headerlink" href="#excursion-implementing-expansion-to-children" title="Link to this heading">#</a></h4>
<p>The function <code class="docutils literal notranslate"><span class="pre">expansion_to_children()</span></code> uses the <code class="docutils literal notranslate"><span class="pre">re.split()</span></code> method to split an expansion string into a list of children nodes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">expansion_to_children</span><span class="p">(</span><span class="n">expansion</span><span class="p">:</span> <span class="n">Expansion</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">DerivationTree</span><span class="p">]:</span>
    <span class="c1"># print(&quot;Converting &quot; + repr(expansion))</span>
    <span class="c1"># strings contains all substrings -- both terminals and nonterminals such</span>
    <span class="c1"># that &#39;&#39;.join(strings) == expansion</span>

    <span class="n">expansion</span> <span class="o">=</span> <span class="n">exp_string</span><span class="p">(</span><span class="n">expansion</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expansion</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">expansion</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>  <span class="c1"># Special case: epsilon expansion</span>
        <span class="k">return</span> <span class="p">[(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[])]</span>

    <span class="n">strings</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">RE_NONTERMINAL</span><span class="p">,</span> <span class="n">expansion</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[(</span><span class="n">s</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_nonterminal</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">strings</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id5">
<h4>End of Excursion<a class="headerlink" href="#id5" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">expansion_to_children</span><span class="p">(</span><span class="s2">&quot;&lt;term&gt; + &lt;expr&gt;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39;&lt;term&gt;&#39;, None), (&#39; + &#39;, []), (&#39;&lt;expr&gt;&#39;, None)]
</pre></div>
</div>
</div>
</div>
<p>The case of an <em>epsilon expansion</em>, i.e. expanding into an empty string as in <code class="docutils literal notranslate"><span class="pre">&lt;symbol&gt;</span> <span class="pre">::=</span></code> needs special treatment:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">expansion_to_children</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39;&#39;, [])]
</pre></div>
</div>
</div>
</div>
<p>Just like <code class="docutils literal notranslate"><span class="pre">nonterminals()</span></code> in the <a class="reference internal" href="Grammars.html"><span class="std std-doc">chapter on Grammars</span></a>, we provide for future extensions, allowing the expansion to be a tuple with extra data (which will be ignored).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">expansion_to_children</span><span class="p">((</span><span class="s2">&quot;+&lt;term&gt;&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;extra_data&quot;</span><span class="p">:</span> <span class="mi">1234</span><span class="p">}))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39;+&#39;, []), (&#39;&lt;term&gt;&#39;, None)]
</pre></div>
</div>
</div>
</div>
<p>We realize this helper as a method in <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code> such that it can be overloaded by subclasses:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GrammarFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">expansion_to_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expansion</span><span class="p">:</span> <span class="n">Expansion</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">DerivationTree</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">expansion_to_children</span><span class="p">(</span><span class="n">expansion</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="putting-things-together">
<h3>Putting Things Together<a class="headerlink" href="#putting-things-together" title="Link to this heading">#</a></h3>
<p>With this, we can now take</p>
<ol class="arabic simple">
<li><p>some non-expanded node in the tree,</p></li>
<li><p>choose a random expansion, and</p></li>
<li><p>return the new tree.</p></li>
</ol>
<p>This is what the method <code class="docutils literal notranslate"><span class="pre">expand_node_randomly()</span></code> does.</p>
<section id="excursion-expand-node-randomly-implementation">
<h4>Excursion: <code class="docutils literal notranslate"><span class="pre">expand_node_randomly()</span></code> implementation<a class="headerlink" href="#excursion-expand-node-randomly-implementation" title="Link to this heading">#</a></h4>
<p>The function <code class="docutils literal notranslate"><span class="pre">expand_node_randomly()</span></code> uses a helper function <code class="docutils literal notranslate"><span class="pre">choose_node_expansion()</span></code> to randomly pick an index from an array of possible children.  (<code class="docutils literal notranslate"><span class="pre">choose_node_expansion()</span></code> can be overloaded in subclasses.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GrammarFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">expand_node_randomly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DerivationTree</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Choose a random expansion for `node` and return it&quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span> <span class="o">=</span> <span class="n">node</span>
        <span class="k">assert</span> <span class="n">children</span> <span class="ow">is</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Expanding&quot;</span><span class="p">,</span> <span class="n">all_terminals</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="s2">&quot;randomly&quot;</span><span class="p">)</span>

        <span class="c1"># Fetch the possible expansions from grammar...</span>
        <span class="n">expansions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        <span class="n">children_alternatives</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">DerivationTree</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expansion_to_children</span><span class="p">(</span><span class="n">expansion</span><span class="p">)</span> <span class="k">for</span> <span class="n">expansion</span> <span class="ow">in</span> <span class="n">expansions</span>
        <span class="p">]</span>

        <span class="c1"># ... and select a random expansion</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choose_node_expansion</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">children_alternatives</span><span class="p">)</span>
        <span class="n">chosen_children</span> <span class="o">=</span> <span class="n">children_alternatives</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="c1"># Process children (for subclasses)</span>
        <span class="n">chosen_children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_chosen_children</span><span class="p">(</span><span class="n">chosen_children</span><span class="p">,</span>
                                                       <span class="n">expansions</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

        <span class="c1"># Return with new children</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">chosen_children</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The generic <code class="docutils literal notranslate"><span class="pre">expand_node()</span></code> method can later be used to select different expansion strategies; as of now, it only uses <code class="docutils literal notranslate"><span class="pre">expand_node_randomly()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GrammarFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">expand_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DerivationTree</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_node_randomly</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The helper function <code class="docutils literal notranslate"><span class="pre">process_chosen_children()</span></code> does nothing; it can be overloaded by subclasses to process the children once chosen.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GrammarFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process_chosen_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                <span class="n">chosen_children</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DerivationTree</span><span class="p">],</span>
                                <span class="n">expansion</span><span class="p">:</span> <span class="n">Expansion</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">DerivationTree</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process children after selection.  By default, does nothing.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">chosen_children</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id6">
<h4>End of Excursion<a class="headerlink" href="#id6" title="Link to this heading">#</a></h4>
<p>This is how <code class="docutils literal notranslate"><span class="pre">expand_node_randomly()</span></code> works:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Before expand_node_randomly():&quot;</span><span class="p">)</span>
<span class="n">expr_tree</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&lt;integer&gt;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">display_tree</span><span class="p">(</span><span class="n">expr_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Before expand_node_randomly():
</pre></div>
</div>
<img alt="_images/e3adeebf0e6d553942243b8d6d1e6aa664f37407c0beaefc8823a0b10f20a49b.svg" src="_images/e3adeebf0e6d553942243b8d6d1e6aa664f37407c0beaefc8823a0b10f20a49b.svg" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;After expand_node_randomly():&quot;</span><span class="p">)</span>
<span class="n">expr_tree</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">expand_node_randomly</span><span class="p">(</span><span class="n">expr_tree</span><span class="p">)</span>
<span class="n">display_tree</span><span class="p">(</span><span class="n">expr_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>After expand_node_randomly():
Expanding &lt;integer&gt; randomly
</pre></div>
</div>
<img alt="_images/b2be28408f7d343ffd7801b288c08eb713d0fde473ecc42cd93c96d9a3eba845.svg" src="_images/b2be28408f7d343ffd7801b288c08eb713d0fde473ecc42cd93c96d9a3eba845.svg" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># docassert</span>
<span class="k">assert</span> <span class="n">expr_tree</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&lt;digit&gt;&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">quiz</span><span class="p">(</span><span class="s2">&quot;What tree do we get if we expand the `&lt;digit&gt;` subtree?&quot;</span><span class="p">,</span>
     <span class="p">[</span>
         <span class="s2">&quot;We get another `&lt;digit&gt;` as new child of `&lt;digit&gt;`&quot;</span><span class="p">,</span>
         <span class="s2">&quot;We get some digit as child of `&lt;digit&gt;`&quot;</span><span class="p">,</span>
         <span class="s2">&quot;We get another `&lt;digit&gt;` as second child of `&lt;integer&gt;`&quot;</span><span class="p">,</span>
         <span class="s2">&quot;The entire tree becomes a single node with a digit&quot;</span>
     <span class="p">],</span> <span class="s1">&#39;len(&quot;2&quot;) + len(&quot;2&quot;)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">What tree do we get if we expand the <code>&lt;digit&gt;</code> subtree?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="ec4d5270-d3ed-11ef-8343-6298cf1a5790" id="ec4d5270-d3ed-11ef-8343-6298cf1a5790-1" onclick="clear_selection('ec4d5270-d3ed-11ef-8343-6298cf1a5790')">
        <label id="ec4d5270-d3ed-11ef-8343-6298cf1a5790-1-label" for="ec4d5270-d3ed-11ef-8343-6298cf1a5790-1">We get another <code>&lt;digit&gt;</code> as new child of <code>&lt;digit&gt;</code></label><br>
    
        <input type="radio" name="ec4d5270-d3ed-11ef-8343-6298cf1a5790" id="ec4d5270-d3ed-11ef-8343-6298cf1a5790-2" onclick="clear_selection('ec4d5270-d3ed-11ef-8343-6298cf1a5790')">
        <label id="ec4d5270-d3ed-11ef-8343-6298cf1a5790-2-label" for="ec4d5270-d3ed-11ef-8343-6298cf1a5790-2">We get some digit as child of <code>&lt;digit&gt;</code></label><br>
    
        <input type="radio" name="ec4d5270-d3ed-11ef-8343-6298cf1a5790" id="ec4d5270-d3ed-11ef-8343-6298cf1a5790-3" onclick="clear_selection('ec4d5270-d3ed-11ef-8343-6298cf1a5790')">
        <label id="ec4d5270-d3ed-11ef-8343-6298cf1a5790-3-label" for="ec4d5270-d3ed-11ef-8343-6298cf1a5790-3">We get another <code>&lt;digit&gt;</code> as second child of <code>&lt;integer&gt;</code></label><br>
    
        <input type="radio" name="ec4d5270-d3ed-11ef-8343-6298cf1a5790" id="ec4d5270-d3ed-11ef-8343-6298cf1a5790-4" onclick="clear_selection('ec4d5270-d3ed-11ef-8343-6298cf1a5790')">
        <label id="ec4d5270-d3ed-11ef-8343-6298cf1a5790-4-label" for="ec4d5270-d3ed-11ef-8343-6298cf1a5790-4">The entire tree becomes a single node with a digit</label><br>
    
    </div>
    </p>
    <input id="ec4d5270-d3ed-11ef-8343-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('ec4d5270-d3ed-11ef-8343-6298cf1a5790', 4, 0, 'len(&quot;2&quot;) + len(&quot;2&quot;)')">
    <span class="quiz_hint" id="ec4d5270-d3ed-11ef-8343-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>We can surely put this to the test, right? Here we go:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">digit_subtree</span> <span class="o">=</span> <span class="n">expr_tree</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
<span class="n">display_tree</span><span class="p">(</span><span class="n">digit_subtree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/e11456e929a4782dbad3bf83666bc1517a5c3970108cadfa52eceaa7d17d5aff.svg" src="_images/e11456e929a4782dbad3bf83666bc1517a5c3970108cadfa52eceaa7d17d5aff.svg" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;After expanding the &lt;digit&gt; subtree:&quot;</span><span class="p">)</span>
<span class="n">digit_subtree</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">expand_node_randomly</span><span class="p">(</span><span class="n">digit_subtree</span><span class="p">)</span>
<span class="n">display_tree</span><span class="p">(</span><span class="n">digit_subtree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>After expanding the &lt;digit&gt; subtree:
Expanding &lt;digit&gt; randomly
</pre></div>
</div>
<img alt="_images/adc77094f229a0d5575f6dfe171f312617337b2b783821fe73434c2e559e077c.svg" src="_images/adc77094f229a0d5575f6dfe171f312617337b2b783821fe73434c2e559e077c.svg" />
</div>
</div>
<p>We see that <code class="docutils literal notranslate"><span class="pre">&lt;digit&gt;</span></code> gets expanded again according to the grammar rules – namely, into a single digit.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">quiz</span><span class="p">(</span><span class="s2">&quot;Is the original `expr_tree` affected by this change?&quot;</span><span class="p">,</span>
     <span class="p">[</span>
         <span class="s2">&quot;No, it is unchanged&quot;</span><span class="p">,</span>
         <span class="s2">&quot;Yes, it has also gained a new child&quot;</span>
     <span class="p">],</span> <span class="s2">&quot;1 ** (1 - 1)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
    
    <script>
    var bad_answers = new Map();

    function answer(quiz_id) {
        ans = 0;
        for (i = 1;; i++) {
            checkbox = document.getElementById(quiz_id + "-" + i.toString());
            if (!checkbox)
                break;
            if (checkbox.checked)
                ans |= (1 << i);
        }
        return ans;
    }
    function check_selection(quiz_id, correct_answer, multiple_choice, hint) {
        given_answer = answer(quiz_id);
        if (given_answer == correct_answer)
        {
            document.getElementById(quiz_id + "-submit").value = "Correct!";
            document.getElementById(quiz_id + "-hint").innerHTML = "";

            for (i = 1;; i++) {
                checkbox = document.getElementById(quiz_id + "-" + i.toString());
                label = document.getElementById(quiz_id + "-" + i.toString() + "-label")
                if (!checkbox)
                    break;

                if (checkbox.checked) {
                    label.style.fontWeight = "bold";
                }
                else {
                    label.style.textDecoration = "line-through";
                }
            }
        }
        else 
        {
            document.getElementById(quiz_id + "-submit").value = "Try again";

            if (!bad_answers.has(quiz_id)) {
                bad_answers.set(quiz_id, 1);
            }
            else {
                bad_answers.set(quiz_id, bad_answers.get(quiz_id) + 1);
            }

            if (bad_answers.get(quiz_id) >= 2 && hint.length > 0) {
                document.getElementById(quiz_id + "-hint").innerHTML = 
                    "&nbsp;&nbsp;(Hint: <code>" + hint + "</code>)";
            }

            if (!multiple_choice) {
                for (i = 1;; i++) {
                    checkbox = document.getElementById(quiz_id + "-" + i.toString());
                    label = document.getElementById(quiz_id + "-" + i.toString() + "-label")

                    if (!checkbox)
                        break;
                    if (checkbox.checked) {
                        label.style.textDecoration = "line-through";
                    }
                }
            }
        }
    }
    function clear_selection(quiz_id) {
        document.getElementById(quiz_id + "-submit").value = "Submit";
        document.getElementById(quiz_id + "-hint").innerHTML = "";
    }
    </script>
    
    <div class="quiz">
    <h3 class="quiz_title">Quiz</h3>
    <p>
    <div class="quiz_question">Is the original <code>expr_tree</code> affected by this change?</div>
    </p>
    <p>
    <div class="quiz_options" title="Pick a choice.">
    
        <input type="radio" name="ecd191ca-d3ed-11ef-8343-6298cf1a5790" id="ecd191ca-d3ed-11ef-8343-6298cf1a5790-1" onclick="clear_selection('ecd191ca-d3ed-11ef-8343-6298cf1a5790')">
        <label id="ecd191ca-d3ed-11ef-8343-6298cf1a5790-1-label" for="ecd191ca-d3ed-11ef-8343-6298cf1a5790-1">No, it is unchanged</label><br>
    
        <input type="radio" name="ecd191ca-d3ed-11ef-8343-6298cf1a5790" id="ecd191ca-d3ed-11ef-8343-6298cf1a5790-2" onclick="clear_selection('ecd191ca-d3ed-11ef-8343-6298cf1a5790')">
        <label id="ecd191ca-d3ed-11ef-8343-6298cf1a5790-2-label" for="ecd191ca-d3ed-11ef-8343-6298cf1a5790-2">Yes, it has also gained a new child</label><br>
    
    </div>
    </p>
    <input id="ecd191ca-d3ed-11ef-8343-6298cf1a5790-submit" type="submit" value="Submit" onclick="check_selection('ecd191ca-d3ed-11ef-8343-6298cf1a5790', 2, 0, '1 ** (1 - 1)')">
    <span class="quiz_hint" id="ecd191ca-d3ed-11ef-8343-6298cf1a5790-hint"></span>
    </div>
    </div></div>
</div>
<p>Although we have changed one of the subtrees, the original <code class="docutils literal notranslate"><span class="pre">expr_tree</span></code> is unaffected:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_tree</span><span class="p">(</span><span class="n">expr_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b2be28408f7d343ffd7801b288c08eb713d0fde473ecc42cd93c96d9a3eba845.svg" src="_images/b2be28408f7d343ffd7801b288c08eb713d0fde473ecc42cd93c96d9a3eba845.svg" />
</div>
</div>
<p>That is because <code class="docutils literal notranslate"><span class="pre">expand_node_randomly()</span></code> returns a new (expanded) tree and does not change the tree passed as argument.</p>
</section>
</section>
</section>
<section id="expanding-a-tree">
<h2>Expanding a Tree<a class="headerlink" href="#expanding-a-tree" title="Link to this heading">#</a></h2>
<p>Let us now apply our functions for expanding a single node to some node in the tree.  To this end, we first need to <em>search the tree for non-expanded nodes</em>.  <code class="docutils literal notranslate"><span class="pre">possible_expansions()</span></code> counts how many unexpanded symbols there are in a tree:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GrammarFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">possible_expansions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span> <span class="o">=</span> <span class="n">node</span>
        <span class="k">if</span> <span class="n">children</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">possible_expansions</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">children</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">possible_expansions</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2
</pre></div>
</div>
</div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">any_possible_expansions()</span></code> returns True if the tree has any non-expanded nodes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GrammarFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">any_possible_expansions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span> <span class="o">=</span> <span class="n">node</span>
        <span class="k">if</span> <span class="n">children</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">any_possible_expansions</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">children</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">any_possible_expansions</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>Here comes <code class="docutils literal notranslate"><span class="pre">expand_tree_once()</span></code>, the core method of our tree expansion algorithm.  It first checks whether it is currently being applied on a nonterminal symbol without expansion; if so, it invokes <code class="docutils literal notranslate"><span class="pre">expand_node()</span></code> on it, as discussed above.</p>
<p>If the node is already expanded (i.e. has children), it checks the subset of children which still have non-expanded symbols, randomly selects one of them, and applies itself recursively on that child.</p>
<section id="excursion-expand-tree-once-implementation">
<h3>Excursion: <code class="docutils literal notranslate"><span class="pre">expand_tree_once()</span></code> implementation<a class="headerlink" href="#excursion-expand-tree-once-implementation" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">expand_tree_once()</span></code> method replaces the child <em>in place</em>, meaning that it actually mutates the tree being passed as an argument rather than returning a new tree.  This in-place mutation is what makes this function particularly efficient.  Again, we use a helper method (<code class="docutils literal notranslate"><span class="pre">choose_tree_expansion()</span></code>) to return the chosen index from a list of children that can be expanded.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GrammarFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">choose_tree_expansion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                              <span class="n">tree</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">,</span>
                              <span class="n">children</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DerivationTree</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return index of subtree in `children` to be selected for expansion.</span>
<span class="sd">           Defaults to random.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">expand_tree_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DerivationTree</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Choose an unexpanded symbol in tree; expand it.</span>
<span class="sd">           Can be overloaded in subclasses.&quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span> <span class="o">=</span> <span class="n">tree</span>
        <span class="k">if</span> <span class="n">children</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Expand this node</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_node</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>

        <span class="c1"># Find all children with possible expansions</span>
        <span class="n">expandable_children</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">children</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">any_possible_expansions</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span>

        <span class="c1"># `index_map` translates an index in `expandable_children`</span>
        <span class="c1"># back into the original index in `children`</span>
        <span class="n">index_map</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">children</span><span class="p">)</span>
                     <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">expandable_children</span><span class="p">]</span>

        <span class="c1"># Select a random child</span>
        <span class="n">child_to_be_expanded</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">choose_tree_expansion</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">expandable_children</span><span class="p">)</span>

        <span class="c1"># Expand in place</span>
        <span class="n">children</span><span class="p">[</span><span class="n">index_map</span><span class="p">[</span><span class="n">child_to_be_expanded</span><span class="p">]]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">expand_tree_once</span><span class="p">(</span><span class="n">expandable_children</span><span class="p">[</span><span class="n">child_to_be_expanded</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">tree</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id7">
<h3>End of Excursion<a class="headerlink" href="#id7" title="Link to this heading">#</a></h3>
<p>Let us illustrate how <code class="docutils literal notranslate"><span class="pre">expand_tree_once()</span></code> works. We start with our derivation tree from above…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">derivation_tree</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">,</span>
                   <span class="p">[(</span><span class="s2">&quot;&lt;expr&gt;&quot;</span><span class="p">,</span>
                     <span class="p">[(</span><span class="s2">&quot;&lt;expr&gt;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                      <span class="p">(</span><span class="s2">&quot; + &quot;</span><span class="p">,</span> <span class="p">[]),</span>
                         <span class="p">(</span><span class="s2">&quot;&lt;term&gt;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
                     <span class="p">)])</span>
<span class="n">display_tree</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ef2ab0c09ddfdf05788a4030de6dac91004d49489812c39295ae6342db32a4d5.svg" src="_images/ef2ab0c09ddfdf05788a4030de6dac91004d49489812c39295ae6342db32a4d5.svg" />
</div>
</div>
<p>… and now expand it twice:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">derivation_tree</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">expand_tree_once</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
<span class="n">display_tree</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Expanding &lt;expr&gt; randomly
</pre></div>
</div>
<img alt="_images/51122012859e71258666df52d13a7c2b499febef9a9c4825e93f1a69649e73b9.svg" src="_images/51122012859e71258666df52d13a7c2b499febef9a9c4825e93f1a69649e73b9.svg" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">derivation_tree</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">expand_tree_once</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
<span class="n">display_tree</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Expanding &lt;term&gt; randomly
</pre></div>
</div>
<img alt="_images/fcc54aa3405f35bef973d669765e801e941aee7051b5f245c3e9f28d80e30255.svg" src="_images/fcc54aa3405f35bef973d669765e801e941aee7051b5f245c3e9f28d80e30255.svg" />
</div>
</div>
<p>We see that with each step, one more symbol is expanded.  Now all it takes is to apply this again and again, expanding the tree further and further.</p>
</section>
</section>
<section id="closing-the-expansion">
<h2>Closing the Expansion<a class="headerlink" href="#closing-the-expansion" title="Link to this heading">#</a></h2>
<p>With <code class="docutils literal notranslate"><span class="pre">expand_tree_once()</span></code>, we can keep on expanding the tree – but how do we actually stop?  The key idea here, introduced by Luke in \cite{Luke2000}, is that after inflating the derivation tree to some maximum size, we <em>only want to apply expansions that increase the size of the tree by a minimum</em>.  For <code class="docutils literal notranslate"><span class="pre">&lt;factor&gt;</span></code>, for instance, we would prefer an expansion into <code class="docutils literal notranslate"><span class="pre">&lt;integer&gt;</span></code>, as this will not introduce further recursion (and potential size inflation); for <code class="docutils literal notranslate"><span class="pre">&lt;integer&gt;</span></code>, likewise, an expansion into <code class="docutils literal notranslate"><span class="pre">&lt;digit&gt;</span></code> is preferred, as it will less increase tree size than <code class="docutils literal notranslate"><span class="pre">&lt;digit&gt;&lt;integer&gt;</span></code>.</p>
<p>To identify the <em>cost</em> of expanding a symbol, we introduce two functions that mutually rely on each other:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">symbol_cost()</span></code> returns the minimum cost of all expansions of a symbol, using <code class="docutils literal notranslate"><span class="pre">expansion_cost()</span></code> to compute the cost for each expansion.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">expansion_cost()</span></code> returns the sum of all expansions in <code class="docutils literal notranslate"><span class="pre">expansions</span></code>. If a nonterminal is encountered again during traversal, the cost of the expansion is <span class="math notranslate nohighlight">\(\infty\)</span>, indicating (potentially infinite) recursion.</p></li>
</ul>
<section id="excursion-implementing-cost-functions">
<h3>Excursion: Implementing Cost Functions<a class="headerlink" href="#excursion-implementing-cost-functions" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GrammarFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">symbol_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">seen</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">())</span> \
            <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="n">expansions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expansion_cost</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">seen</span> <span class="o">|</span> <span class="p">{</span><span class="n">symbol</span><span class="p">})</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">expansions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">expansion_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expansion</span><span class="p">:</span> <span class="n">Expansion</span><span class="p">,</span>
                       <span class="n">seen</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="n">nonterminals</span><span class="p">(</span><span class="n">expansion</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>  <span class="c1"># no symbol</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">s</span> <span class="ow">in</span> <span class="n">seen</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

        <span class="c1"># the value of a expansion is the sum of all expandable variables</span>
        <span class="c1"># inside + 1</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol_cost</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">seen</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id8">
<h3>End of Excursion<a class="headerlink" href="#id8" title="Link to this heading">#</a></h3>
<p>Here are two examples: The minimum cost of expanding a digit is 1, since we have to choose from one of its expansions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">f</span><span class="o">.</span><span class="n">symbol_cost</span><span class="p">(</span><span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<p>The minimum cost of expanding <code class="docutils literal notranslate"><span class="pre">&lt;expr&gt;</span></code>, though, is five, as this is the minimum number of expansions required.  (<code class="docutils literal notranslate"><span class="pre">&lt;expr&gt;</span></code> <span class="math notranslate nohighlight">\(\rightarrow\)</span> <code class="docutils literal notranslate"><span class="pre">&lt;term&gt;</span></code> <span class="math notranslate nohighlight">\(\rightarrow\)</span> <code class="docutils literal notranslate"><span class="pre">&lt;factor&gt;</span></code> <span class="math notranslate nohighlight">\(\rightarrow\)</span> <code class="docutils literal notranslate"><span class="pre">&lt;integer&gt;</span></code> <span class="math notranslate nohighlight">\(\rightarrow\)</span> <code class="docutils literal notranslate"><span class="pre">&lt;digit&gt;</span></code> <span class="math notranslate nohighlight">\(\rightarrow\)</span> 1)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">f</span><span class="o">.</span><span class="n">symbol_cost</span><span class="p">(</span><span class="s2">&quot;&lt;expr&gt;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span>
</pre></div>
</div>
</div>
</div>
<p>We define <code class="docutils literal notranslate"><span class="pre">expand_node_by_cost(self,</span> <span class="pre">node,</span> <span class="pre">choose)</span></code>, a variant of <code class="docutils literal notranslate"><span class="pre">expand_node()</span></code> that takes the above cost into account.  It determines the minimum cost <code class="docutils literal notranslate"><span class="pre">cost</span></code> across all children and then chooses a child from the list using the <code class="docutils literal notranslate"><span class="pre">choose</span></code> function, which by default is the minimum cost.  If multiple children all have the same minimum cost, it chooses randomly between these.</p>
<section id="excursion-expand-node-by-cost-implementation">
<h4>Excursion: <code class="docutils literal notranslate"><span class="pre">expand_node_by_cost()</span></code> implementation<a class="headerlink" href="#excursion-expand-node-by-cost-implementation" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GrammarFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">expand_node_by_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">,</span> 
                            <span class="n">choose</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="nb">min</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DerivationTree</span><span class="p">:</span>
        <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span> <span class="o">=</span> <span class="n">node</span>
        <span class="k">assert</span> <span class="n">children</span> <span class="ow">is</span> <span class="kc">None</span>

        <span class="c1"># Fetch the possible expansions from grammar...</span>
        <span class="n">expansions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>

        <span class="n">children_alternatives_with_cost</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">expansion_to_children</span><span class="p">(</span><span class="n">expansion</span><span class="p">),</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">expansion_cost</span><span class="p">(</span><span class="n">expansion</span><span class="p">,</span> <span class="p">{</span><span class="n">symbol</span><span class="p">}),</span>
                                            <span class="n">expansion</span><span class="p">)</span>
                                           <span class="k">for</span> <span class="n">expansion</span> <span class="ow">in</span> <span class="n">expansions</span><span class="p">]</span>

        <span class="n">costs</span> <span class="o">=</span> <span class="p">[</span><span class="n">cost</span> <span class="k">for</span> <span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">expansion</span><span class="p">)</span>
                 <span class="ow">in</span> <span class="n">children_alternatives_with_cost</span><span class="p">]</span>
        <span class="n">chosen_cost</span> <span class="o">=</span> <span class="n">choose</span><span class="p">(</span><span class="n">costs</span><span class="p">)</span>
        <span class="n">children_with_chosen_cost</span> <span class="o">=</span> <span class="p">[</span><span class="n">child</span> <span class="k">for</span> <span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">child_cost</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> 
                                     <span class="ow">in</span> <span class="n">children_alternatives_with_cost</span>
                                     <span class="k">if</span> <span class="n">child_cost</span> <span class="o">==</span> <span class="n">chosen_cost</span><span class="p">]</span>
        <span class="n">expansion_with_chosen_cost</span> <span class="o">=</span> <span class="p">[</span><span class="n">expansion</span> <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">child_cost</span><span class="p">,</span> <span class="n">expansion</span><span class="p">)</span>
                                      <span class="ow">in</span> <span class="n">children_alternatives_with_cost</span>
                                      <span class="k">if</span> <span class="n">child_cost</span> <span class="o">==</span> <span class="n">chosen_cost</span><span class="p">]</span>

        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choose_node_expansion</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">children_with_chosen_cost</span><span class="p">)</span>

        <span class="n">chosen_children</span> <span class="o">=</span> <span class="n">children_with_chosen_cost</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">chosen_expansion</span> <span class="o">=</span> <span class="n">expansion_with_chosen_cost</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">chosen_children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_chosen_children</span><span class="p">(</span>
            <span class="n">chosen_children</span><span class="p">,</span> <span class="n">chosen_expansion</span><span class="p">)</span>

        <span class="c1"># Return with a new list</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">chosen_children</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id9">
<h4>End of Excursion<a class="headerlink" href="#id9" title="Link to this heading">#</a></h4>
<p>The shortcut <code class="docutils literal notranslate"><span class="pre">expand_node_min_cost()</span></code> passes <code class="docutils literal notranslate"><span class="pre">min()</span></code> as the <code class="docutils literal notranslate"><span class="pre">choose</span></code> function, which makes it expand nodes at minimum cost.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GrammarFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">expand_node_min_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DerivationTree</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Expanding&quot;</span><span class="p">,</span> <span class="n">all_terminals</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="s2">&quot;at minimum cost&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_node_by_cost</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="nb">min</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can now apply this function to close the expansion of our derivation tree, using <code class="docutils literal notranslate"><span class="pre">expand_tree_once()</span></code> with the above <code class="docutils literal notranslate"><span class="pre">expand_node_min_cost()</span></code> as expansion function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GrammarFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">expand_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DerivationTree</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_node_min_cost</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">display_tree</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/fcc54aa3405f35bef973d669765e801e941aee7051b5f245c3e9f28d80e30255.svg" src="_images/fcc54aa3405f35bef973d669765e801e941aee7051b5f245c3e9f28d80e30255.svg" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># docassert</span>
<span class="k">assert</span> <span class="n">f</span><span class="o">.</span><span class="n">any_possible_expansions</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">any_possible_expansions</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">):</span>
    <span class="n">derivation_tree</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">expand_tree_once</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
<span class="n">display_tree</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Expanding &lt;term&gt; at minimum cost
</pre></div>
</div>
<img alt="_images/6596d9bfd31f660c6f12b560660b4b61607e0106e644afb688d7632e2baf31fb.svg" src="_images/6596d9bfd31f660c6f12b560660b4b61607e0106e644afb688d7632e2baf31fb.svg" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># docassert</span>
<span class="k">assert</span> <span class="n">f</span><span class="o">.</span><span class="n">any_possible_expansions</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">any_possible_expansions</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">):</span>
    <span class="n">derivation_tree</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">expand_tree_once</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
<span class="n">display_tree</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Expanding &lt;factor&gt; at minimum cost
</pre></div>
</div>
<img alt="_images/82e47ac51fd4f98f128cd579cbd1d27f1c58c87189bf76f7b9f8355738d8f020.svg" src="_images/82e47ac51fd4f98f128cd579cbd1d27f1c58c87189bf76f7b9f8355738d8f020.svg" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># docassert</span>
<span class="k">assert</span> <span class="n">f</span><span class="o">.</span><span class="n">any_possible_expansions</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">any_possible_expansions</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">):</span>
    <span class="n">derivation_tree</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">expand_tree_once</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
<span class="n">display_tree</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Expanding &lt;term&gt; at minimum cost
</pre></div>
</div>
<img alt="_images/168c1888a10d8a0afd83a751d55fea6c780b0ac147459e2a120c23ba0e5caab1.svg" src="_images/168c1888a10d8a0afd83a751d55fea6c780b0ac147459e2a120c23ba0e5caab1.svg" />
</div>
</div>
<p>We keep on expanding until all nonterminals are expanded.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="n">f</span><span class="o">.</span><span class="n">any_possible_expansions</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">):</span>
    <span class="n">derivation_tree</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">expand_tree_once</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Expanding &lt;integer&gt; at minimum cost
Expanding &lt;digit&gt; at minimum cost
Expanding &lt;factor&gt; at minimum cost
Expanding &lt;integer&gt; at minimum cost
Expanding &lt;factor&gt; at minimum cost
Expanding &lt;integer&gt; at minimum cost
Expanding &lt;digit&gt; at minimum cost
Expanding &lt;digit&gt; at minimum cost
</pre></div>
</div>
</div>
</div>
<p>Here is the final tree:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_tree</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/dd486add788edd5e858c4f5f06c2390c4d62666d3cf4b123c1cd727d5b9d60ac.svg" src="_images/dd486add788edd5e858c4f5f06c2390c4d62666d3cf4b123c1cd727d5b9d60ac.svg" />
</div>
</div>
<p>We see that in each step, <code class="docutils literal notranslate"><span class="pre">expand_node_min_cost()</span></code> chooses an expansion that does not increase the number of symbols, eventually closing all open expansions.</p>
</section>
</section>
</section>
<section id="node-inflation">
<h2>Node Inflation<a class="headerlink" href="#node-inflation" title="Link to this heading">#</a></h2>
<p>Especially at the beginning of an expansion, we may be interested in getting <em>as many nodes as possible</em> – that is, we’d like to prefer expansions that give us <em>more</em> nonterminals to expand.  This is actually the exact opposite of what <code class="docutils literal notranslate"><span class="pre">expand_node_min_cost()</span></code> gives us, and we can implement a method <code class="docutils literal notranslate"><span class="pre">expand_node_max_cost()</span></code> that will always choose among the nodes with the <em>highest</em> cost:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GrammarFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">expand_node_max_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DerivationTree</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Expanding&quot;</span><span class="p">,</span> <span class="n">all_terminals</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="s2">&quot;at maximum cost&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_node_by_cost</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="nb">max</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>To illustrate <code class="docutils literal notranslate"><span class="pre">expand_node_max_cost()</span></code>, we can again redefine <code class="docutils literal notranslate"><span class="pre">expand_node()</span></code> to use it, and then use <code class="docutils literal notranslate"><span class="pre">expand_tree_once()</span></code> to show a few expansion steps:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GrammarFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">expand_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DerivationTree</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_node_max_cost</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">derivation_tree</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">,</span>
                   <span class="p">[(</span><span class="s2">&quot;&lt;expr&gt;&quot;</span><span class="p">,</span>
                     <span class="p">[(</span><span class="s2">&quot;&lt;expr&gt;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                      <span class="p">(</span><span class="s2">&quot; + &quot;</span><span class="p">,</span> <span class="p">[]),</span>
                         <span class="p">(</span><span class="s2">&quot;&lt;term&gt;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
                     <span class="p">)])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">display_tree</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ef2ab0c09ddfdf05788a4030de6dac91004d49489812c39295ae6342db32a4d5.svg" src="_images/ef2ab0c09ddfdf05788a4030de6dac91004d49489812c39295ae6342db32a4d5.svg" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># docassert</span>
<span class="k">assert</span> <span class="n">f</span><span class="o">.</span><span class="n">any_possible_expansions</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">any_possible_expansions</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">):</span>
    <span class="n">derivation_tree</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">expand_tree_once</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
<span class="n">display_tree</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Expanding &lt;term&gt; at maximum cost
</pre></div>
</div>
<img alt="_images/fea46eea144557e3f5ea313700b3598c1c420c0007ada54253f58cb5492327f6.svg" src="_images/fea46eea144557e3f5ea313700b3598c1c420c0007ada54253f58cb5492327f6.svg" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># docassert</span>
<span class="k">assert</span> <span class="n">f</span><span class="o">.</span><span class="n">any_possible_expansions</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">any_possible_expansions</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">):</span>
    <span class="n">derivation_tree</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">expand_tree_once</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
<span class="n">display_tree</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Expanding &lt;factor&gt; at maximum cost
</pre></div>
</div>
<img alt="_images/1f02c36fcfd1cf933791094877b4e2cae1d499f806c67123fcc363d44ce51481.svg" src="_images/1f02c36fcfd1cf933791094877b4e2cae1d499f806c67123fcc363d44ce51481.svg" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># docassert</span>
<span class="k">assert</span> <span class="n">f</span><span class="o">.</span><span class="n">any_possible_expansions</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">any_possible_expansions</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">):</span>
    <span class="n">derivation_tree</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">expand_tree_once</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
<span class="n">display_tree</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Expanding &lt;expr&gt; at maximum cost
</pre></div>
</div>
<img alt="_images/adfa87bf07054001b5ffee8fdca9ec12ba0f9be9ee9a3990650bead634c3530f.svg" src="_images/adfa87bf07054001b5ffee8fdca9ec12ba0f9be9ee9a3990650bead634c3530f.svg" />
</div>
</div>
<p>We see that with each step, the number of nonterminals increases.  Obviously, we have to put a limit on this number.</p>
</section>
<section id="three-expansion-phases">
<h2>Three Expansion Phases<a class="headerlink" href="#three-expansion-phases" title="Link to this heading">#</a></h2>
<p>We can now put all three phases together in a single function <code class="docutils literal notranslate"><span class="pre">expand_tree()</span></code> which will work as follows:</p>
<ol class="arabic simple">
<li><p><strong>Max cost expansion.</strong> Expand the tree using expansions with maximum cost until we have at least <code class="docutils literal notranslate"><span class="pre">min_nonterminals</span></code> nonterminals.  This phase can be easily skipped by setting <code class="docutils literal notranslate"><span class="pre">min_nonterminals</span></code> to zero.</p></li>
<li><p><strong>Random expansion.</strong>  Keep on expanding the tree randomly until we reach <code class="docutils literal notranslate"><span class="pre">max_nonterminals</span></code> nonterminals.</p></li>
<li><p><strong>Min cost expansion.</strong> Close the expansion with minimum cost.</p></li>
</ol>
<p>We implement these three phases by having <code class="docutils literal notranslate"><span class="pre">expand_node</span></code> reference the expansion method to apply.  This is controlled by setting <code class="docutils literal notranslate"><span class="pre">expand_node</span></code> (the method reference) to first <code class="docutils literal notranslate"><span class="pre">expand_node_max_cost</span></code> (i.e., calling <code class="docutils literal notranslate"><span class="pre">expand_node()</span></code> invokes <code class="docutils literal notranslate"><span class="pre">expand_node_max_cost()</span></code>), then <code class="docutils literal notranslate"><span class="pre">expand_node_randomly</span></code>, and finally <code class="docutils literal notranslate"><span class="pre">expand_node_min_cost</span></code>.  In the first two phases, we also set a maximum limit of <code class="docutils literal notranslate"><span class="pre">min_nonterminals</span></code> and <code class="docutils literal notranslate"><span class="pre">max_nonterminals</span></code>, respectively.</p>
<section id="excursion-implementation-of-three-phase-expand-tree">
<h3>Excursion: Implementation of three-phase <code class="docutils literal notranslate"><span class="pre">expand_tree()</span></code><a class="headerlink" href="#excursion-implementation-of-three-phase-expand-tree" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GrammarFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">log_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Output a tree if self.log is set; if self.display is also set, show the tree structure&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tree:&quot;</span><span class="p">,</span> <span class="n">all_terminals</span><span class="p">(</span><span class="n">tree</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disp</span><span class="p">:</span>
                <span class="n">display</span><span class="p">(</span><span class="n">display_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">))</span>
            <span class="c1"># print(self.possible_expansions(tree), &quot;possible expansion(s) left&quot;)</span>

    <span class="k">def</span> <span class="nf">expand_tree_with_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">,</span>
                                  <span class="n">expand_node_method</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
                                  <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Expand tree using `expand_node_method` as node expansion function</span>
<span class="sd">        until the number of possible expansions reaches `limit`.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expand_node</span> <span class="o">=</span> <span class="n">expand_node_method</span>  <span class="c1"># type: ignore</span>
        <span class="k">while</span> <span class="p">((</span><span class="n">limit</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">possible_expansions</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">)</span>
               <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">any_possible_expansions</span><span class="p">(</span><span class="n">tree</span><span class="p">)):</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_tree_once</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tree</span>

    <span class="k">def</span> <span class="nf">expand_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DerivationTree</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Expand `tree` in a three-phase strategy until all expansions are complete.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_tree_with_strategy</span><span class="p">(</span>
            <span class="n">tree</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_node_max_cost</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_nonterminals</span><span class="p">)</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_tree_with_strategy</span><span class="p">(</span>
            <span class="n">tree</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_node_randomly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_nonterminals</span><span class="p">)</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_tree_with_strategy</span><span class="p">(</span>
            <span class="n">tree</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_node_min_cost</span><span class="p">)</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">possible_expansions</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">tree</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id10">
<h3>End of Excursion<a class="headerlink" href="#id10" title="Link to this heading">#</a></h3>
<p>Let us try this out on our example. We start with a half-expanded derivation tree:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">initial_derivation_tree</span><span class="p">:</span> <span class="n">DerivationTree</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">,</span>
                   <span class="p">[(</span><span class="s2">&quot;&lt;expr&gt;&quot;</span><span class="p">,</span>
                     <span class="p">[(</span><span class="s2">&quot;&lt;expr&gt;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                      <span class="p">(</span><span class="s2">&quot; + &quot;</span><span class="p">,</span> <span class="p">[]),</span>
                         <span class="p">(</span><span class="s2">&quot;&lt;term&gt;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
                     <span class="p">)])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_tree</span><span class="p">(</span><span class="n">initial_derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ef2ab0c09ddfdf05788a4030de6dac91004d49489812c39295ae6342db32a4d5.svg" src="_images/ef2ab0c09ddfdf05788a4030de6dac91004d49489812c39295ae6342db32a4d5.svg" />
</div>
</div>
<p>We now apply our expansion strategy on this tree.  We see that initially, nodes are expanded at maximum cost, then randomly, and then closing the expansion at minimum cost.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span>
    <span class="n">EXPR_GRAMMAR</span><span class="p">,</span>
    <span class="n">min_nonterminals</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">derivation_tree</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">expand_tree</span><span class="p">(</span><span class="n">initial_derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Tree: &lt;expr&gt; + &lt;term&gt;
Expanding &lt;expr&gt; at maximum cost
Tree: &lt;term&gt; + &lt;expr&gt; + &lt;term&gt;
Expanding &lt;expr&gt; randomly
Tree: &lt;term&gt; + &lt;term&gt; + &lt;term&gt;
Expanding &lt;term&gt; randomly
Tree: &lt;factor&gt; / &lt;term&gt; + &lt;term&gt; + &lt;term&gt;
Expanding &lt;term&gt; randomly
Tree: &lt;factor&gt; / &lt;factor&gt; + &lt;term&gt; + &lt;term&gt;
Expanding &lt;factor&gt; randomly
Tree: &lt;integer&gt; / &lt;factor&gt; + &lt;term&gt; + &lt;term&gt;
Expanding &lt;term&gt; randomly
Tree: &lt;integer&gt; / &lt;factor&gt; + &lt;factor&gt; * &lt;term&gt; + &lt;term&gt;
Expanding &lt;factor&gt; at minimum cost
Tree: &lt;integer&gt; / &lt;integer&gt; + &lt;factor&gt; * &lt;term&gt; + &lt;term&gt;
Expanding &lt;integer&gt; at minimum cost
Tree: &lt;integer&gt; / &lt;digit&gt; + &lt;factor&gt; * &lt;term&gt; + &lt;term&gt;
Expanding &lt;factor&gt; at minimum cost
Tree: &lt;integer&gt; / &lt;digit&gt; + &lt;integer&gt; * &lt;term&gt; + &lt;term&gt;
Expanding &lt;integer&gt; at minimum cost
Tree: &lt;digit&gt; / &lt;digit&gt; + &lt;integer&gt; * &lt;term&gt; + &lt;term&gt;
Expanding &lt;term&gt; at minimum cost
Tree: &lt;digit&gt; / &lt;digit&gt; + &lt;integer&gt; * &lt;term&gt; + &lt;factor&gt;
Expanding &lt;digit&gt; at minimum cost
Tree: &lt;digit&gt; / 5 + &lt;integer&gt; * &lt;term&gt; + &lt;factor&gt;
Expanding &lt;factor&gt; at minimum cost
Tree: &lt;digit&gt; / 5 + &lt;integer&gt; * &lt;term&gt; + &lt;integer&gt;
Expanding &lt;integer&gt; at minimum cost
Tree: &lt;digit&gt; / 5 + &lt;integer&gt; * &lt;term&gt; + &lt;digit&gt;
Expanding &lt;integer&gt; at minimum cost
Tree: &lt;digit&gt; / 5 + &lt;digit&gt; * &lt;term&gt; + &lt;digit&gt;
Expanding &lt;digit&gt; at minimum cost
Tree: 7 / 5 + &lt;digit&gt; * &lt;term&gt; + &lt;digit&gt;
Expanding &lt;digit&gt; at minimum cost
Tree: 7 / 5 + &lt;digit&gt; * &lt;term&gt; + 0
Expanding &lt;term&gt; at minimum cost
Tree: 7 / 5 + &lt;digit&gt; * &lt;factor&gt; + 0
Expanding &lt;factor&gt; at minimum cost
Tree: 7 / 5 + &lt;digit&gt; * &lt;integer&gt; + 0
Expanding &lt;integer&gt; at minimum cost
Tree: 7 / 5 + &lt;digit&gt; * &lt;digit&gt; + 0
Expanding &lt;digit&gt; at minimum cost
Tree: 7 / 5 + 4 * &lt;digit&gt; + 0
Expanding &lt;digit&gt; at minimum cost
Tree: 7 / 5 + 4 * 2 + 0
</pre></div>
</div>
</div>
</div>
<p>This is the final derivation tree:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_tree</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/434f3967a1704639fc708e936b57047214cd75ebf6e9de2d6170f91aec3ec9fc.svg" src="_images/434f3967a1704639fc708e936b57047214cd75ebf6e9de2d6170f91aec3ec9fc.svg" />
</div>
</div>
<p>And this is the resulting string:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_terminals</span><span class="p">(</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;7 / 5 + 4 * 2 + 0&#39;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="putting-it-all-together">
<h2>Putting it all Together<a class="headerlink" href="#putting-it-all-together" title="Link to this heading">#</a></h2>
<p>Based on this, we can now define a function <code class="docutils literal notranslate"><span class="pre">fuzz()</span></code> that – like <code class="docutils literal notranslate"><span class="pre">simple_grammar_fuzzer()</span></code> – simply takes a grammar and produces a string from it.  It thus no longer exposes the complexity of derivation trees.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GrammarFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">fuzz_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DerivationTree</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce a derivation tree from the grammar.&quot;&quot;&quot;</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_tree</span><span class="p">()</span>
        <span class="c1"># print(tree)</span>

        <span class="c1"># Expand all nonterminals</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">all_terminals</span><span class="p">(</span><span class="n">tree</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disp</span><span class="p">:</span>
            <span class="n">display</span><span class="p">(</span><span class="n">display_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">tree</span>

    <span class="k">def</span> <span class="nf">fuzz</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce a string from the grammar.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">derivation_tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fuzz_tree</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">all_terminals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can now apply this on all our defined grammars (and visualize the derivation tree along)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;18.3 * 21.95 / 0&#39;
</pre></div>
</div>
</div>
</div>
<p>After calling <code class="docutils literal notranslate"><span class="pre">fuzz()</span></code>, the produced derivation tree is accessible in the <code class="docutils literal notranslate"><span class="pre">derivation_tree</span></code> attribute:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_tree</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c7c32ed665dc8f13641a39e9cc8116ebff40ccf2f5412ef157bbe98e760ecd77.svg" src="_images/c7c32ed665dc8f13641a39e9cc8116ebff40ccf2f5412ef157bbe98e760ecd77.svg" />
</div>
</div>
<p>Let us try out the grammar fuzzer (and its trees) on other grammar formats.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">URL_GRAMMAR</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;ftp://user:password@www.google.com:53/def?abc=def&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_tree</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1264157fc4a0227fa031b1e741dde6fa51a69ddb085689eb500e0dae9cbaac38.svg" src="_images/1264157fc4a0227fa031b1e741dde6fa51a69ddb085689eb500e0dae9cbaac38.svg" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">CGI_GRAMMAR</span><span class="p">,</span> <span class="n">min_nonterminals</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;e+d+&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_tree</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ad9e4cd38050216e563bc670e23443ca61cdc5d7cb7081fc8d20188ab953ece9.svg" src="_images/ad9e4cd38050216e563bc670e23443ca61cdc5d7cb7081fc8d20188ab953ece9.svg" />
</div>
</div>
<p>How do we stack up against <code class="docutils literal notranslate"><span class="pre">simple_grammar_fuzzer()</span></code>?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trials</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">xs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">ys</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trials</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
    <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
    <span class="n">ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">average_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span> <span class="o">/</span> <span class="n">trials</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Average time:&quot;</span><span class="p">,</span> <span class="n">average_time</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Average time: 0.0263434316823259
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Time required for generating an output&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/477091d1238c22d9a054a2e51c2c7ed6977830f7d48029cddef5d371105748ad.png" src="_images/477091d1238c22d9a054a2e51c2c7ed6977830f7d48029cddef5d371105748ad.png" />
</div>
</div>
<p>Our test generation is much faster, but also our inputs are much smaller.  We see that with derivation trees, we can get much better control over grammar production.</p>
<p>Finally, how does <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code> work with <code class="docutils literal notranslate"><span class="pre">expr_grammar</span></code>, where <code class="docutils literal notranslate"><span class="pre">simple_grammar_fuzzer()</span></code> failed?  It works without any issue:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">expr_grammar</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;(9 + 7) * 7 * 2 * 5 + 7 * 2 / 6&#39;
</pre></div>
</div>
</div>
</div>
<p>With <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code>, we now have a solid foundation on which to build further fuzzers and illustrate more exciting concepts from the world of generating software tests.  Many of these do not even require writing a grammar – instead, they <em>infer</em> a grammar from the domain at hand, and thus allow using grammar-based fuzzing even without writing a grammar.  Stay tuned!</p>
</section>
<section id="id11">
<h2>Synopsis<a class="headerlink" href="#id11" title="Link to this heading">#</a></h2>
<section id="id12">
<h3>Efficient Grammar Fuzzing<a class="headerlink" href="#id12" title="Link to this heading">#</a></h3>
<p>This chapter introduces <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code>, an efficient grammar fuzzer that takes a grammar to produce syntactically valid input strings.  Here’s a typical usage:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Grammars</span> <span class="kn">import</span> <span class="n">US_PHONE_GRAMMAR</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">phone_fuzzer</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">US_PHONE_GRAMMAR</span><span class="p">)</span>
<span class="n">phone_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;(771)306-0659&#39;
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code> constructor takes a number of keyword arguments to control its behavior.  <code class="docutils literal notranslate"><span class="pre">start_symbol</span></code>, for instance, allows setting the symbol that expansion starts with (instead of <code class="docutils literal notranslate"><span class="pre">&lt;start&gt;</span></code>):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">area_fuzzer</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">US_PHONE_GRAMMAR</span><span class="p">,</span> <span class="n">start_symbol</span><span class="o">=</span><span class="s1">&#39;&lt;area&gt;&#39;</span><span class="p">)</span>
<span class="n">area_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;409&#39;
</pre></div>
</div>
</div>
</div>
<p>Here’s how to parameterize the <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code> constructor:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="kn">import</span> <span class="nn">inspect</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="nb">print</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="o">.</span><span class="fm">__init__</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Produce strings from `grammar`, starting with `start_symbol`.
If `min_nonterminals` or `max_nonterminals` is given, use them as limits 
for the number of nonterminals produced.  
If `disp` is set, display the intermediate derivation trees.
If `log` is set, show intermediate steps as text on standard output.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="kn">from</span> <span class="nn">ClassDiagram</span> <span class="kn">import</span> <span class="n">display_class_hierarchy</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="n">display_class_hierarchy</span><span class="p">([</span><span class="n">GrammarFuzzer</span><span class="p">],</span>
                        <span class="n">public_methods</span><span class="o">=</span><span class="p">[</span>
                            <span class="n">Fuzzer</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">Fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">,</span>
                            <span class="n">Fuzzer</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
                            <span class="n">Fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">,</span>
                            <span class="n">GrammarFuzzer</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">GrammarFuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">,</span>
                            <span class="n">GrammarFuzzer</span><span class="o">.</span><span class="n">fuzz_tree</span><span class="p">,</span>
                        <span class="p">],</span>
                        <span class="n">types</span><span class="o">=</span><span class="p">{</span>
                            <span class="s1">&#39;DerivationTree&#39;</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">,</span>
                            <span class="s1">&#39;Expansion&#39;</span><span class="p">:</span> <span class="n">Expansion</span><span class="p">,</span>
                            <span class="s1">&#39;Grammar&#39;</span><span class="p">:</span> <span class="n">Grammar</span>
                        <span class="p">},</span>
                        <span class="n">project</span><span class="o">=</span><span class="s1">&#39;fuzzingbook&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (20241206.2353)
 -->
<!-- Pages: 1 -->
<svg width="324pt" height="458pt"
 viewBox="0.00 0.00 323.62 458.25" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 454.25)">
<g id="a_graph0"><a xlink:title="GrammarFuzzer class hierarchy">
<polygon fill="white" stroke="none" points="-4,4 -4,-454.25 319.62,-454.25 319.62,4 -4,4"/>
</a>
</g>
<!-- GrammarFuzzer -->
<g id="node1" class="node">
<title>GrammarFuzzer</title>
<g id="a_node1"><a xlink:href="#" xlink:title="class GrammarFuzzer:&#10;Produce strings from grammars efficiently, using derivation trees.">
<polygon fill="none" stroke="black" points="0,-0.5 0,-327.75 178,-327.75 178,-0.5 0,-0.5"/>
<text text-anchor="start" x="39.12" y="-311.45" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">GrammarFuzzer</text>
<polyline fill="none" stroke="black" points="0,-301.75 178,-301.75"/>
<g id="a_node1_0"><a xlink:href="#" xlink:title="GrammarFuzzer">
<g id="a_node1_1"><a xlink:href="#" xlink:title="__init__(self, grammar: Dict[str, List[Expansion]], start_symbol: str = &#39;&lt;start&gt;&#39;, min_nonterminals: int = 0, max_nonterminals: int = 10, disp: bool = False, log: Union[bool, int] = False) &#45;&gt; None:&#10;Produce strings from `grammar`, starting with `start_symbol`.&#10;If `min_nonterminals` or `max_nonterminals` is given, use them as limits&#10;for the number of nonterminals produced.&#10;If `disp` is set, display the intermediate derivation trees.&#10;If `log` is set, show intermediate steps as text on standard output.">
<text text-anchor="start" x="8" y="-289.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node1_2"><a xlink:href="#" xlink:title="fuzz(self) &#45;&gt; str:&#10;Produce a string from the grammar.">
<text text-anchor="start" x="8" y="-276.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">fuzz()</text>
</a>
</g>
<g id="a_node1_3"><a xlink:href="#" xlink:title="fuzz_tree(self) &#45;&gt; DerivationTree:&#10;Produce a derivation tree from the grammar.">
<text text-anchor="start" x="8" y="-263.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">fuzz_tree()</text>
</a>
</g>
<g id="a_node1_4"><a xlink:href="#" xlink:title="any_possible_expansions(self, node: DerivationTree) &#45;&gt; bool">
<text text-anchor="start" x="8" y="-250" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">any_possible_expansions()</text>
</a>
</g>
<g id="a_node1_5"><a xlink:href="#" xlink:title="check_grammar(self) &#45;&gt; None:&#10;Check the grammar passed">
<text text-anchor="start" x="8" y="-237.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">check_grammar()</text>
</a>
</g>
<g id="a_node1_6"><a xlink:href="#" xlink:title="choose_node_expansion(self, node: DerivationTree, children_alternatives: List[List[DerivationTree]]) &#45;&gt; int:&#10;Return index of expansion in `children_alternatives` to be selected.&#10;&#39;children_alternatives`: a list of possible children for `node`.&#10;Defaults to random. To be overloaded in subclasses.">
<text text-anchor="start" x="8" y="-225.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">choose_node_expansion()</text>
</a>
</g>
<g id="a_node1_7"><a xlink:href="#" xlink:title="choose_tree_expansion(self, tree: DerivationTree, children: List[DerivationTree]) &#45;&gt; int:&#10;Return index of subtree in `children` to be selected for expansion.&#10;Defaults to random.">
<text text-anchor="start" x="8" y="-211.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">choose_tree_expansion()</text>
</a>
</g>
<g id="a_node1_8"><a xlink:href="#" xlink:title="expand_node(self, node: DerivationTree) &#45;&gt; DerivationTree">
<text text-anchor="start" x="8" y="-199" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">expand_node()</text>
</a>
</g>
<g id="a_node1_9"><a xlink:href="#" xlink:title="expand_node_by_cost(self, node: DerivationTree, choose: Callable = &lt;built&#45;in function min&gt;) &#45;&gt; DerivationTree">
<text text-anchor="start" x="8" y="-186.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">expand_node_by_cost()</text>
</a>
</g>
<g id="a_node1_10"><a xlink:href="#" xlink:title="expand_node_max_cost(self, node: DerivationTree) &#45;&gt; DerivationTree">
<text text-anchor="start" x="8" y="-173.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">expand_node_max_cost()</text>
</a>
</g>
<g id="a_node1_11"><a xlink:href="#" xlink:title="expand_node_min_cost(self, node: DerivationTree) &#45;&gt; DerivationTree">
<text text-anchor="start" x="8" y="-160.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">expand_node_min_cost()</text>
</a>
</g>
<g id="a_node1_12"><a xlink:href="#" xlink:title="expand_node_randomly(self, node: DerivationTree) &#45;&gt; DerivationTree:&#10;Choose a random expansion for `node` and return it">
<text text-anchor="start" x="8" y="-148" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">expand_node_randomly()</text>
</a>
</g>
<g id="a_node1_13"><a xlink:href="#" xlink:title="expand_tree(self, tree: DerivationTree) &#45;&gt; DerivationTree:&#10;Expand `tree` in a three&#45;phase strategy until all expansions are complete.">
<text text-anchor="start" x="8" y="-135.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">expand_tree()</text>
</a>
</g>
<g id="a_node1_14"><a xlink:href="#" xlink:title="expand_tree_once(self, tree: DerivationTree) &#45;&gt; DerivationTree:&#10;Choose an unexpanded symbol in tree; expand it.&#10;Can be overloaded in subclasses.">
<text text-anchor="start" x="8" y="-123.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">expand_tree_once()</text>
</a>
</g>
<g id="a_node1_15"><a xlink:href="#" xlink:title="expand_tree_with_strategy(self, tree: DerivationTree, expand_node_method: Callable, limit: Optional[int] = None):&#10;Expand tree using `expand_node_method` as node expansion function&#10;until the number of possible expansions reaches `limit`.">
<text text-anchor="start" x="8" y="-109.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">expand_tree_with_strategy()</text>
</a>
</g>
<g id="a_node1_16"><a xlink:href="#" xlink:title="expansion_cost(self, expansion: Expansion, seen: Set[str] = set()) &#45;&gt; Union[int, float]">
<text text-anchor="start" x="8" y="-97" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">expansion_cost()</text>
</a>
</g>
<g id="a_node1_17"><a xlink:href="#" xlink:title="expansion_to_children(self, expansion: Expansion) &#45;&gt; List[DerivationTree]">
<text text-anchor="start" x="8" y="-84.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">expansion_to_children()</text>
</a>
</g>
<g id="a_node1_18"><a xlink:href="#" xlink:title="init_tree(self) &#45;&gt; DerivationTree">
<text text-anchor="start" x="8" y="-71.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">init_tree()</text>
</a>
</g>
<g id="a_node1_19"><a xlink:href="#" xlink:title="log_tree(self, tree: DerivationTree) &#45;&gt; None:&#10;Output a tree if self.log is set; if self.display is also set, show the tree structure">
<text text-anchor="start" x="8" y="-58.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">log_tree()</text>
</a>
</g>
<g id="a_node1_20"><a xlink:href="#" xlink:title="possible_expansions(self, node: DerivationTree) &#45;&gt; int">
<text text-anchor="start" x="8" y="-46" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">possible_expansions()</text>
</a>
</g>
<g id="a_node1_21"><a xlink:href="#" xlink:title="process_chosen_children(self, chosen_children: List[DerivationTree], expansion: Expansion) &#45;&gt; List[DerivationTree]:&#10;Process children after selection. &#160;By default, does nothing.">
<text text-anchor="start" x="8" y="-33.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">process_chosen_children()</text>
</a>
</g>
<g id="a_node1_22"><a xlink:href="#" xlink:title="supported_opts(self) &#45;&gt; Set[str]:&#10;Set of supported options. To be overloaded in subclasses.">
<text text-anchor="start" x="8" y="-21.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="10.00">supported_opts()</text>
</a>
</g>
<g id="a_node1_23"><a xlink:href="#" xlink:title="symbol_cost(self, symbol: str, seen: Set[str] = set()) &#45;&gt; Union[int, float]">
<text text-anchor="start" x="8" y="-7.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">symbol_cost()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- Fuzzer -->
<g id="node2" class="node">
<title>Fuzzer</title>
<g id="a_node2"><a xlink:href="Fuzzer.ipynb" xlink:title="class Fuzzer:&#10;Base class for fuzzers.">
<polygon fill="none" stroke="black" points="51,-364.75 51,-449.75 127,-449.75 127,-364.75 51,-364.75"/>
<text text-anchor="start" x="68.38" y="-433.45" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">Fuzzer</text>
<polyline fill="none" stroke="black" points="51,-423.75 127,-423.75"/>
<g id="a_node2_24"><a xlink:href="#" xlink:title="Fuzzer">
<g id="a_node2_25"><a xlink:href="Fuzzer.ipynb" xlink:title="__init__(self) &#45;&gt; None:&#10;Constructor">
<text text-anchor="start" x="59" y="-411.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node2_26"><a xlink:href="Fuzzer.ipynb" xlink:title="fuzz(self) &#45;&gt; str:&#10;Return fuzz input">
<text text-anchor="start" x="59" y="-398.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">fuzz()</text>
</a>
</g>
<g id="a_node2_27"><a xlink:href="Fuzzer.ipynb" xlink:title="run(self, runner: Fuzzer.Runner = &lt;Fuzzer.Runner object at 0x10653dfd0&gt;) &#45;&gt; Tuple[subprocess.CompletedProcess, str]:&#10;Run `runner` with fuzz input">
<text text-anchor="start" x="59" y="-385.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">run()</text>
</a>
</g>
<g id="a_node2_28"><a xlink:href="Fuzzer.ipynb" xlink:title="runs(self, runner: Fuzzer.Runner = &lt;Fuzzer.PrintRunner object at 0x10653db80&gt;, trials: int = 10) &#45;&gt; List[Tuple[subprocess.CompletedProcess, str]]:&#10;Run `runner` with fuzz input, `trials` times">
<text text-anchor="start" x="59" y="-373" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">runs()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- GrammarFuzzer&#45;&gt;Fuzzer -->
<g id="edge1" class="edge">
<title>GrammarFuzzer&#45;&gt;Fuzzer</title>
<path fill="none" stroke="black" d="M89,-327.96C89,-336.73 89,-345.15 89,-353.01"/>
<polygon fill="none" stroke="black" points="85.5,-352.96 89,-362.96 92.5,-352.96 85.5,-352.96"/>
</g>
<!-- Legend -->
<g id="node3" class="node">
<title>Legend</title>
<text text-anchor="start" x="196.38" y="-180.12" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="10.00" fill="#b03a2e">Legend</text>
<text text-anchor="start" x="196.38" y="-170.12" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="202.38" y="-170.12" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="8.00">public_method()</text>
<text text-anchor="start" x="196.38" y="-160.12" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="202.38" y="-160.12" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="8.00">private_method()</text>
<text text-anchor="start" x="196.38" y="-150.12" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="202.38" y="-150.12" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="8.00">overloaded_method()</text>
<text text-anchor="start" x="196.38" y="-141.07" font-family="Helvetica,sans-Serif" font-size="9.00">Hover over names to see doc</text>
</g>
</g>
</svg>
</div></div>
</div>
</section>
<section id="id13">
<h3>Derivation Trees<a class="headerlink" href="#id13" title="Link to this heading">#</a></h3>
<p>Internally, <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code> makes use of <a class="reference internal" href="#Derivation-Trees"><span class="xref myst">derivation trees</span></a>, which it expands step by step.  After producing a string, the tree produced can be accessed in the <code class="docutils literal notranslate"><span class="pre">derivation_tree</span></code> attribute.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_tree</span><span class="p">(</span><span class="n">phone_fuzzer</span><span class="o">.</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/4120d86a5b24d44bd4e0b2ea3528fdf1eb710b9f9a987405aea40d48ecdd618c.svg" src="_images/4120d86a5b24d44bd4e0b2ea3528fdf1eb710b9f9a987405aea40d48ecdd618c.svg" />
</div>
</div>
<p>In the internal representation of a derivation tree, a <em>node</em> is a pair (<code class="docutils literal notranslate"><span class="pre">symbol</span></code>, <code class="docutils literal notranslate"><span class="pre">children</span></code>).  For nonterminals, <code class="docutils literal notranslate"><span class="pre">symbol</span></code> is the symbol that is being expanded, and <code class="docutils literal notranslate"><span class="pre">children</span></code> is a list of further nodes.  For terminals, <code class="docutils literal notranslate"><span class="pre">symbol</span></code> is the terminal string, and <code class="docutils literal notranslate"><span class="pre">children</span></code> is empty.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">phone_fuzzer</span><span class="o">.</span><span class="n">derivation_tree</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;&lt;start&gt;&#39;,
 [(&#39;&lt;phone-number&gt;&#39;,
   [(&#39;(&#39;, []),
    (&#39;&lt;area&gt;&#39;,
     [(&#39;&lt;lead-digit&gt;&#39;, [(&#39;7&#39;, [])]),
      (&#39;&lt;digit&gt;&#39;, [(&#39;7&#39;, [])]),
      (&#39;&lt;digit&gt;&#39;, [(&#39;1&#39;, [])])]),
    (&#39;)&#39;, []),
    (&#39;&lt;exchange&gt;&#39;,
     [(&#39;&lt;lead-digit&gt;&#39;, [(&#39;3&#39;, [])]),
      (&#39;&lt;digit&gt;&#39;, [(&#39;0&#39;, [])]),
      (&#39;&lt;digit&gt;&#39;, [(&#39;6&#39;, [])])]),
    (&#39;-&#39;, []),
    (&#39;&lt;line&gt;&#39;,
     [(&#39;&lt;digit&gt;&#39;, [(&#39;0&#39;, [])]),
      (&#39;&lt;digit&gt;&#39;, [(&#39;6&#39;, [])]),
      (&#39;&lt;digit&gt;&#39;, [(&#39;5&#39;, [])]),
      (&#39;&lt;digit&gt;&#39;, [(&#39;9&#39;, [])])])])])
</pre></div>
</div>
</div>
</div>
<p>The chapter contains various helpers to work with derivation trees, including visualization tools – notably, <code class="docutils literal notranslate"><span class="pre">display_tree()</span></code>, above.</p>
</section>
</section>
<section id="lessons-learned">
<h2>Lessons Learned<a class="headerlink" href="#lessons-learned" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><em>Derivation trees</em> are important for expressing input structure</p></li>
<li><p><em>Grammar fuzzing based on derivation trees</em></p>
<ol class="arabic simple">
<li><p>is much more efficient than string-based grammar fuzzing,</p></li>
<li><p>gives much better control over input generation, and</p></li>
<li><p>effectively avoids running into infinite expansions.</p></li>
</ol>
</li>
</ul>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">#</a></h2>
<p>Congratulations!  You have reached one of the central “hubs” of the book.  From here, there is a wide range of techniques that build on grammar fuzzing.</p>
<section id="extending-grammars">
<h3>Extending Grammars<a class="headerlink" href="#extending-grammars" title="Link to this heading">#</a></h3>
<p>First, we have a number of techniques that all <em>extend</em> grammars in some form:</p>
<ul class="simple">
<li><p><a class="reference internal" href="Parser.html"><span class="std std-doc">Parsing and recombining inputs</span></a> allows making use of existing inputs, again using derivation trees</p></li>
<li><p><a class="reference internal" href="GrammarCoverageFuzzer.html"><span class="std std-doc">Covering grammar expansions</span></a> allows for <em>combinatorial</em> coverage</p></li>
<li><p><a class="reference internal" href="ProbabilisticGrammarFuzzer.html"><span class="std std-doc">Assigning <em>probabilities</em> to individual expansions</span></a> gives additional control over expansions</p></li>
<li><p><a class="reference internal" href="GeneratorGrammarFuzzer.html"><span class="std std-doc">Assigning <em>constraints</em> to individual expansions</span></a> allows expressing <em>semantic constraints</em> on individual rules.</p></li>
</ul>
</section>
<section id="applying-grammars">
<h3>Applying Grammars<a class="headerlink" href="#applying-grammars" title="Link to this heading">#</a></h3>
<p>Second, we can <em>apply</em> grammars in a variety of contexts that all involve some form of learning it automatically:</p>
<ul class="simple">
<li><p><a class="reference internal" href="APIFuzzer.html"><span class="std std-doc">Fuzzing APIs</span></a>, learning a grammar from APIs</p></li>
<li><p><a class="reference internal" href="WebFuzzer.html"><span class="std std-doc">Fuzzing graphical user interfaces</span></a>, learning a grammar from user interfaces for subsequent fuzzing</p></li>
<li><p><a class="reference internal" href="GrammarMiner.html"><span class="std std-doc">Mining grammars</span></a>, learning a grammar for arbitrary input formats</p></li>
</ul>
<p>Keep on expanding!</p>
</section>
</section>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h2>
<p>Derivation trees (then frequently called <em>parse trees</em>) are a standard data structure into which <em>parsers</em> decompose inputs.  The <em>Dragon Book</em> (also known as <em>Compilers: Principles, Techniques, and Tools</em>) \cite{Aho2006} discusses parsing into derivation trees as part of compiling programs.  We also use derivation trees <a class="reference internal" href="Parser.html"><span class="std std-doc">when parsing and recombining inputs</span></a>.</p>
<p>The key idea in this chapter, namely expanding until a limit of symbols is reached, and then always choosing the shortest path, stems from Luke \cite{Luke2000}.</p>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<section id="exercise-1-caching-method-results">
<h3>Exercise 1: Caching Method Results<a class="headerlink" href="#exercise-1-caching-method-results" title="Link to this heading">#</a></h3>
<p>Tracking <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code> reveals that some methods are called again and again, always with the same values.</p>
<p>Set up a class <code class="docutils literal notranslate"><span class="pre">FasterGrammarFuzzer</span></code> with a <em>cache</em> that checks whether the method has been called before, and if so, return the previously computed “memoized” value.  Do this for <code class="docutils literal notranslate"><span class="pre">expansion_to_children()</span></code>.  Compare the number of invocations before and after the optimization.</p>
<p><strong>Important</strong>: For <code class="docutils literal notranslate"><span class="pre">expansion_to_children()</span></code>, make sure that each list returned is an individual copy.  If you return the same (cached) list, this will interfere with the in-place modification of <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code>.  Use the Python <code class="docutils literal notranslate"><span class="pre">copy.deepcopy()</span></code> function for this purpose.</p>
<p><strong>Solution.</strong> Let us demonstrate this for <code class="docutils literal notranslate"><span class="pre">expansion_to_children()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">copy</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FasterGrammarFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Variant of `GrammarFuzzer` with memoized values&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expansion_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Expansion</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">DerivationTree</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expansion_invocations</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expansion_invocations_cached</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">expansion_to_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expansion</span><span class="p">:</span> <span class="n">Expansion</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">DerivationTree</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expansion_invocations</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">expansion</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expansion_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expansion_invocations_cached</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">cached_result</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_expansion_cache</span><span class="p">[</span><span class="n">expansion</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">cached_result</span>

        <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">expansion_to_children</span><span class="p">(</span><span class="n">expansion</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expansion_cache</span><span class="p">[</span><span class="n">expansion</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">FasterGrammarFuzzer</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">,</span> <span class="n">min_nonterminals</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;+-++9.2 * 8.9 / 7 + 3&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="o">.</span><span class="n">_expansion_invocations</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>131
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="o">.</span><span class="n">_expansion_invocations_cached</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>107
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.2f%%</span><span class="s2"> of invocations can be cached&quot;</span> <span class="o">%</span>
      <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">_expansion_invocations_cached</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">f</span><span class="o">.</span><span class="n">_expansion_invocations</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>81.68% of invocations can be cached
</pre></div>
</div>
</div>
</div>
</section>
<section id="exercise-2-grammar-pre-compilation">
<h3>Exercise 2: Grammar Pre-Compilation<a class="headerlink" href="#exercise-2-grammar-pre-compilation" title="Link to this heading">#</a></h3>
<p>Some methods such as <code class="docutils literal notranslate"><span class="pre">symbol_cost()</span></code> or <code class="docutils literal notranslate"><span class="pre">expansion_cost()</span></code> return a value that is dependent on the grammar only.  Set up a class <code class="docutils literal notranslate"><span class="pre">EvenFasterGrammarFuzzer()</span></code> that pre-computes these values once upon initialization, such that later invocations of <code class="docutils literal notranslate"><span class="pre">symbol_cost()</span></code> or <code class="docutils literal notranslate"><span class="pre">expansion_cost()</span></code> need only look up these values.</p>
<p><strong>Solution.</strong> Here’s a possible solution, using a hack to substitute the <code class="docutils literal notranslate"><span class="pre">symbol_cost()</span></code> and <code class="docutils literal notranslate"><span class="pre">expansion_cost()</span></code> functions once the pre-computed values are set up.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">EvenFasterGrammarFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Variant of `GrammarFuzzer` with precomputed costs&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_symbol_costs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expansion_costs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Expansion</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precompute_costs</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">new_symbol_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">seen</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symbol_costs</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">new_expansion_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expansion</span><span class="p">:</span> <span class="n">Expansion</span><span class="p">,</span>
                           <span class="n">seen</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expansion_costs</span><span class="p">[</span><span class="n">expansion</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">precompute_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_symbol_costs</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">symbol_cost</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">expansion</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="n">symbol</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_expansion_costs</span><span class="p">[</span><span class="n">expansion</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">expansion_cost</span><span class="p">(</span><span class="n">expansion</span><span class="p">)</span>

        <span class="c1"># Make sure we now call the caching methods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_symbol_cost</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expansion_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_expansion_cost</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">EvenFasterGrammarFuzzer</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here are the individual costs:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="o">.</span><span class="n">_symbol_costs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&lt;start&gt;&#39;: 6,
 &#39;&lt;expr&gt;&#39;: 5,
 &#39;&lt;term&gt;&#39;: 4,
 &#39;&lt;factor&gt;&#39;: 3,
 &#39;&lt;integer&gt;&#39;: 2,
 &#39;&lt;digit&gt;&#39;: 1}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="o">.</span><span class="n">_expansion_costs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&lt;expr&gt;&#39;: 6,
 &#39;&lt;term&gt; + &lt;expr&gt;&#39;: 10,
 &#39;&lt;term&gt; - &lt;expr&gt;&#39;: 10,
 &#39;&lt;term&gt;&#39;: 5,
 &#39;&lt;factor&gt; * &lt;term&gt;&#39;: 8,
 &#39;&lt;factor&gt; / &lt;term&gt;&#39;: 8,
 &#39;&lt;factor&gt;&#39;: 4,
 &#39;+&lt;factor&gt;&#39;: 4,
 &#39;-&lt;factor&gt;&#39;: 4,
 &#39;(&lt;expr&gt;)&#39;: 6,
 &#39;&lt;integer&gt;.&lt;integer&gt;&#39;: 5,
 &#39;&lt;integer&gt;&#39;: 3,
 &#39;&lt;digit&gt;&lt;integer&gt;&#39;: 4,
 &#39;&lt;digit&gt;&#39;: 2,
 &#39;0&#39;: 1,
 &#39;1&#39;: 1,
 &#39;2&#39;: 1,
 &#39;3&#39;: 1,
 &#39;4&#39;: 1,
 &#39;5&#39;: 1,
 &#39;6&#39;: 1,
 &#39;7&#39;: 1,
 &#39;8&#39;: 1,
 &#39;9&#39;: 1}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">EvenFasterGrammarFuzzer</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;(8 * 0 + 8 + 4 * 3) * +(6 - 7 / 5) / 3 * 6&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="exercise-3-maintaining-trees-to-be-expanded">
<h3>Exercise 3: Maintaining Trees to be Expanded<a class="headerlink" href="#exercise-3-maintaining-trees-to-be-expanded" title="Link to this heading">#</a></h3>
<p>In <code class="docutils literal notranslate"><span class="pre">expand_tree_once()</span></code>, the algorithm traverses the tree again and again to find nonterminals that still can be extended.  Speed up the process by keeping a list of nonterminal symbols in the tree that still can be expanded.</p>
<p><strong>Solution.</strong> Left as exercise for the reader.</p>
</section>
<section id="exercise-4-alternate-random-expansions">
<h3>Exercise 4: Alternate Random Expansions<a class="headerlink" href="#exercise-4-alternate-random-expansions" title="Link to this heading">#</a></h3>
<p>We could define <code class="docutils literal notranslate"><span class="pre">expand_node_randomly()</span></code> such that it simply invokes <code class="docutils literal notranslate"><span class="pre">expand_node_by_cost(node,</span> <span class="pre">random.choice)</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ExerciseGrammarFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">expand_node_randomly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DerivationTree</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Expanding&quot;</span><span class="p">,</span> <span class="n">all_terminals</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="s2">&quot;randomly by cost&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_node_by_cost</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>What is the difference between the original implementation and this alternative?</p>
<p><strong>Solution.</strong> The alternative in <code class="docutils literal notranslate"><span class="pre">ExerciseGrammarFuzzer</span></code> has another probability distribution.  In the original <code class="docutils literal notranslate"><span class="pre">GrammarFuzzer</span></code>, all expansions have the same likelihood of being expanded.  In <code class="docutils literal notranslate"><span class="pre">ExerciseGrammarFuzzer</span></code>, first, a cost is chosen (randomly); then, one of the expansions with this cost is chosen (again randomly).  This means that expansions whose cost is unique have a higher chance of being selected.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Grammars.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Fuzzing with Grammars</p>
      </div>
    </a>
    <a class="right-next"
       href="GrammarCoverageFuzzer.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Grammar Coverage</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Efficient Grammar Fuzzing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#derivation-trees">Derivation Trees</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#an-insufficient-algorithm">An Insufficient Algorithm</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Derivation Trees</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#representing-derivation-trees">Representing Derivation Trees</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-display-tree">Excursion: Implementing <code class="docutils literal notranslate"><span class="pre">display_tree()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#end-of-excursion">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-source-code-and-example-for-display-annotated-tree">Excursion: Source code and example for <code class="docutils literal notranslate"><span class="pre">display_annotated_tree()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#expanding-a-node">Expanding a Node</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-check-grammar-implementation">Excursion: <code class="docutils literal notranslate"><span class="pre">check_grammar()</span></code> implementation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">End of Excursion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#picking-a-children-alternative-to-be-expanded">Picking a Children Alternative to be Expanded</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-a-list-of-possible-expansions">Getting a List of Possible Expansions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-expansion-to-children">Excursion: Implementing <code class="docutils literal notranslate"><span class="pre">expansion_to_children()</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#putting-things-together">Putting Things Together</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-expand-node-randomly-implementation">Excursion: <code class="docutils literal notranslate"><span class="pre">expand_node_randomly()</span></code> implementation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">End of Excursion</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#expanding-a-tree">Expanding a Tree</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-expand-tree-once-implementation">Excursion: <code class="docutils literal notranslate"><span class="pre">expand_tree_once()</span></code> implementation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#closing-the-expansion">Closing the Expansion</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementing-cost-functions">Excursion: Implementing Cost Functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">End of Excursion</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-expand-node-by-cost-implementation">Excursion: <code class="docutils literal notranslate"><span class="pre">expand_node_by_cost()</span></code> implementation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">End of Excursion</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#node-inflation">Node Inflation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#three-expansion-phases">Three Expansion Phases</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#excursion-implementation-of-three-phase-expand-tree">Excursion: Implementation of three-phase <code class="docutils literal notranslate"><span class="pre">expand_tree()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">End of Excursion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#putting-it-all-together">Putting it all Together</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">Synopsis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">Efficient Grammar Fuzzing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">Derivation Trees</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extending-grammars">Extending Grammars</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#applying-grammars">Applying Grammars</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-caching-method-results">Exercise 1: Caching Method Results</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-grammar-pre-compilation">Exercise 2: Grammar Pre-Compilation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-maintaining-trees-to-be-expanded">Exercise 3: Maintaining Trees to be Expanded</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-4-alternate-random-expansions">Exercise 4: Alternate Random Expansions</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Andreas Zeller, Rahul Gopinath, Marcel Böhme, Gordon Fraser, and Christian Holler
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2021-2025 CISPA Helmholtz Center for Information Security (www.cispa.de); © Copyright 2018-2020 Saarland University, authors, and contributors. All Rights Reserved.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>