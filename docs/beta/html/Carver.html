
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Carving Unit Tests &#8212; The Fuzzing Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=42e1b1a5" />
    <link rel="stylesheet" type="text/css" href="_static/mastodon-timeline.css?v=f82c2b23" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Carver';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Testing Compilers" href="PythonFuzzer.html" />
    <link rel="prev" title="Fuzzing APIs" href="APIFuzzer.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content"><p>This is a beta version of fuzzingbook.org, currently in development. See the <a href="https://fuzzingbook.org/"  style="color:white!important;">classic site</a> for resources.</p></div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/fuzzingbook.png" class="logo__image only-light" alt="The Fuzzing Book - Home"/>
    <script>document.write(`<img src="_static/fuzzingbook.png" class="logo__image only-dark" alt="The Fuzzing Book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    The Fuzzing Book
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tours.html">Tours through the Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="Intro_Testing.html">Introduction to Software Testing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Lexical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Fuzzer.html">Fuzzing: Breaking Things with Random Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Coverage.html">Code Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="MutationFuzzer.html">Mutation-Based Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GreyboxFuzzer.html">Greybox Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="SearchBasedFuzzer.html">Search-Based Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="MutationAnalysis.html">Mutation Analysis</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Syntactical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Grammars.html">Fuzzing with Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarFuzzer.html">Efficient Grammar Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarCoverageFuzzer.html">Grammar Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="Parser.html">Parsing Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ProbabilisticGrammarFuzzer.html">Probabilistic Grammar Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GeneratorGrammarFuzzer.html">Fuzzing with Generators</a></li>

<li class="toctree-l1"><a class="reference internal" href="GreyboxGrammarFuzzer.html">Greybox Fuzzing with Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="Reducer.html">Reducing Failure-Inducing Inputs</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Semantical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="FuzzingWithConstraints.html">Fuzzing with Constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarMiner.html">Mining Input Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="InformationFlow.html">Tracking Information Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="ConcolicFuzzer.html">Concolic Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="SymbolicFuzzer.html">Symbolic Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="DynamicInvariants.html">Mining Function Specifications</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Domain-Specific Fuzzing</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ConfigurationFuzzer.html">Testing Configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="APIFuzzer.html">Fuzzing APIs</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Carving Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="PythonFuzzer.html">Testing Compilers</a></li>
<li class="toctree-l1"><a class="reference internal" href="WebFuzzer.html">Testing Web Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="GUIFuzzer.html">Testing Graphical User Interfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Managing Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="FuzzingInTheLarge.html">Fuzzing in the Large</a></li>
<li class="toctree-l1"><a class="reference internal" href="WhenToStopFuzzing.html">When To Stop Fuzzing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="AcademicPrototyping.html">Academic Prototyping</a></li>
<li class="toctree-l1"><a class="reference internal" href="PrototypingWithPython.html">Prototyping with Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="ExpectError.html">Error Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timer.html">Timer</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timeout.html">Timeout</a></li>
<li class="toctree-l1"><a class="reference internal" href="ClassDiagram.html">Class Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="RailroadDiagrams.html">Railroad Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="ControlFlow.html">Control Flow Graph</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About This Book</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ReleaseNotes.html">Fuzzingbook Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="Importing.html">Using Fuzzingbook Code in your own Programs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Guide_for_Authors.html">Guide for Authors</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/master?urlpath=tree/docs/notebooks/Carver.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/uds-se/fuzzingbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/uds-se/fuzzingbook/issues/new?title=Issue%20on%20page%20%2FCarver.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/Carver.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Carving Unit Tests</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#recording-calls">Recording Calls</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#synthesizing-calls">Synthesizing Calls</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#system-tests-vs-unit-tests">System Tests vs Unit Tests</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Carving Unit Tests</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Recording Calls</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#recording-my-sqrt">Recording my_sqrt()</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#carving-urlparse">Carving urlparse()</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#replaying-calls">Replaying Calls</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#serializing-objects">Serializing Objects</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#all-calls">All Calls</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mining-api-grammars-from-carved-calls">Mining API Grammars from Carved Calls</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-calls-to-grammars">From Calls to Grammars</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-grammar-miner-for-calls">A Grammar Miner for Calls</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#initial-grammar">Initial Grammar</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#a-grammar-from-arguments">A Grammar from Arguments</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#a-grammar-from-calls">A Grammar from Calls</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#a-grammar-from-all-calls">A Grammar from all Calls</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fuzzing-web-functions">Fuzzing Web Functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Synopsis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Recording Calls</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Synthesizing Calls</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-carving-for-regression-testing">Exercise 1: Carving for Regression Testing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-store-function-results">Part 1: Store function results</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-access-results">Part 2: Access results</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3-produce-assertions">Part 3: Produce assertions</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-abstracting-arguments">Exercise 2: Abstracting Arguments</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="carving-unit-tests">
<h1>Carving Unit Tests<a class="headerlink" href="#carving-unit-tests" title="Link to this heading">#</a></h1>
<p>So far, we have always generated <em>system input</em>, i.e. data that the program as a whole obtains via its input channels.  If we are interested in testing only a small set of functions, having to go through the system can be very inefficient.  This chapter introduces a technique known as <em>carving</em>, which, given a system test, automatically extracts a set of <em>unit tests</em> that replicate the calls seen during the system test.  The key idea is to <em>record</em> such calls such that we can <em>replay</em> them later – as a whole or selectively.  On top, we also explore how to synthesize API grammars from carved unit tests; this means that we can <em>synthesize API tests without having to write a grammar at all.</em></p>
<p><strong>Prerequisites</strong></p>
<ul class="simple">
<li><p>Carving makes use of dynamic traces of function calls and variables, as introduced in the <a class="reference internal" href="ConfigurationFuzzer.html"><span class="std std-doc">chapter on configuration fuzzing</span></a>.</p></li>
<li><p>Using grammars to test units was introduced in the <a class="reference internal" href="APIFuzzer.html"><span class="std std-doc">chapter on API fuzzing</span></a>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bookutils.setup</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">APIFuzzer</span>
</pre></div>
</div>
</div>
</div>
<section id="synopsis">
<h2>Synopsis<a class="headerlink" href="#synopsis" title="Link to this heading">#</a></h2>
<!-- Automatically generated. Do not edit. -->
<p>To <a class="reference internal" href="Importing.html"><span class="std std-doc">use the code provided in this chapter</span></a>, write</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fuzzingbook.Carver</span> <span class="kn">import</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>and then make use of the following features.</p>
<p>This chapter provides means to <em>record and replay function calls</em> during a system test.  Since individual function calls are much faster than a whole system run, such “carving” mechanisms have the potential to run tests much faster.</p>
<section id="recording-calls">
<h3>Recording Calls<a class="headerlink" href="#recording-calls" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">CallCarver</span></code> class records all calls occurring while it is active.  It is used in conjunction with a <code class="docutils literal notranslate"><span class="pre">with</span></code> clause:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">CallCarver</span><span class="p">()</span> <span class="k">as</span> <span class="n">carver</span><span class="p">:</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">y</span> <span class="o">=</span> <span class="n">my_sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">y</span> <span class="o">=</span> <span class="n">my_sqrt</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<p>After execution, <code class="docutils literal notranslate"><span class="pre">called_functions()</span></code> lists the names of functions encountered:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">carver</span><span class="o">.</span><span class="n">called_functions</span><span class="p">()</span>
<span class="go">[&#39;my_sqrt&#39;, &#39;__exit__&#39;]</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">arguments()</span></code> method lists the arguments recorded for a function.  This is a mapping of the function name to a list of lists of arguments; each argument is a pair (parameter name, value).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">carver</span><span class="o">.</span><span class="n">arguments</span><span class="p">(</span><span class="s1">&#39;my_sqrt&#39;</span><span class="p">)</span>
<span class="go">[[(&#39;x&#39;, 2)], [(&#39;x&#39;, 4)]]</span>
</pre></div>
</div>
<p>Complex arguments are properly serialized, such that they can be easily restored.</p>
</section>
<section id="synthesizing-calls">
<h3>Synthesizing Calls<a class="headerlink" href="#synthesizing-calls" title="Link to this heading">#</a></h3>
<p>While such recorded arguments already could be turned into arguments and calls, a much nicer alternative is to create a <em>grammar</em> for recorded calls.  This allows synthesizing arbitrary <em>combinations</em> of arguments, and also offers a base for further customization of calls.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">CallGrammarMiner</span></code> class turns a list of carved executions into a grammar.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">my_sqrt_miner</span> <span class="o">=</span> <span class="n">CallGrammarMiner</span><span class="p">(</span><span class="n">carver</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">my_sqrt_grammar</span> <span class="o">=</span> <span class="n">my_sqrt_miner</span><span class="o">.</span><span class="n">mine_call_grammar</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">my_sqrt_grammar</span>
<span class="go">{&#39;&lt;start&gt;&#39;: [&#39;&lt;call&gt;&#39;],</span>
<span class="go"> &#39;&lt;call&gt;&#39;: [&#39;&lt;my_sqrt&gt;&#39;],</span>
<span class="go"> &#39;&lt;my_sqrt-x&gt;&#39;: [&#39;2&#39;, &#39;4&#39;],</span>
<span class="go"> &#39;&lt;my_sqrt&gt;&#39;: [&#39;my_sqrt(&lt;my_sqrt-x&gt;)&#39;]}</span>
</pre></div>
</div>
<p>This grammar can be used to synthesize calls.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">fuzzer</span> <span class="o">=</span> <span class="n">GrammarCoverageFuzzer</span><span class="p">(</span><span class="n">my_sqrt_grammar</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
<span class="go">&#39;my_sqrt(4)&#39;</span>
</pre></div>
</div>
<p>These calls can be executed in isolation, effectively extracting unit tests from system tests:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">eval</span><span class="p">(</span><span class="n">fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
<span class="go">1.414213562373095</span>
</pre></div>
</div>
</section>
</section>
<section id="system-tests-vs-unit-tests">
<h2>System Tests vs Unit Tests<a class="headerlink" href="#system-tests-vs-unit-tests" title="Link to this heading">#</a></h2>
<p>Remember the URL grammar introduced for <a class="reference internal" href="Grammars.html"><span class="std std-doc">grammar fuzzing</span></a>?  With such a grammar, we can happily test a Web browser again and again, checking how it reacts to arbitrary page requests.</p>
<p>Let us define a very simple “web browser” that goes and downloads the content given by the URL.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">urllib.parse</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">webbrowser</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Download the http/https resource given by the URL&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">requests</span>  <span class="c1"># Only import if needed</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span>
</pre></div>
</div>
</div>
</div>
<p>Let us apply this on <a class="reference external" href="https://www.fuzzingbook.org/">fuzzingbook.org</a> and measure the time, using the <a class="reference internal" href="Timer.html"><span class="std std-doc">Timer class</span></a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Timer</span> <span class="kn">import</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">webbrowser_timer</span><span class="p">:</span>
    <span class="n">fuzzingbook_contents</span> <span class="o">=</span> <span class="n">webbrowser</span><span class="p">(</span>
        <span class="s2">&quot;http://www.fuzzingbook.org/html/Fuzzer.html&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloaded </span><span class="si">%d</span><span class="s2"> bytes in </span><span class="si">%.2f</span><span class="s2"> seconds&quot;</span> <span class="o">%</span>
      <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fuzzingbook_contents</span><span class="p">),</span> <span class="n">webbrowser_timer</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloaded 474839 bytes in 0.48 seconds
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fuzzingbook_contents</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;\n&lt;!-- A html document --&gt;\n&lt;!-- \nwith standard nbconvert css layout\nwith standard nbconvert input/out&#39;
</pre></div>
</div>
</div>
</div>
<p>A full web browser, of course, would also render the HTML content.  We can achieve this using these commands (but we don’t, as we do not want to replicate the entire Web page here):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">display</span>
<span class="n">HTML</span><span class="p">(</span><span class="n">fuzzingbook_contents</span><span class="p">)</span>
</pre></div>
</div>
<p>Having to start a whole browser (or having it render a Web page) again and again means lots of overhead, though – in particular if we want to test only a subset of its functionality.  In particular, after a change in the code, we would prefer to test only the subset of functions that is affected by the change, rather than running the well-tested functions again and again.</p>
<p>Let us assume we change the function that takes care of parsing the given URL and decomposing it into the individual elements – the scheme (“http”), the network location (<code class="docutils literal notranslate"><span class="pre">&quot;www.fuzzingbook.com&quot;</span></code>), or the path (<code class="docutils literal notranslate"><span class="pre">&quot;/html/Fuzzer.html&quot;</span></code>).  This function is named <code class="docutils literal notranslate"><span class="pre">urlparse()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">urlparse</span><span class="p">(</span><span class="s1">&#39;https://www.fuzzingbook.com/html/Carver.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ParseResult(scheme=&#39;https&#39;, netloc=&#39;www.fuzzingbook.com&#39;, path=&#39;/html/Carver.html&#39;, params=&#39;&#39;, query=&#39;&#39;, fragment=&#39;&#39;)
</pre></div>
</div>
</div>
</div>
<p>You see how the individual elements of the URL – the <em>scheme</em> (<code class="docutils literal notranslate"><span class="pre">&quot;http&quot;</span></code>), the <em>network location</em> (<code class="docutils literal notranslate"><span class="pre">&quot;www.fuzzingbook.com&quot;</span></code>), or the path (<code class="docutils literal notranslate"><span class="pre">&quot;//html/Carver.html&quot;</span></code>) are all properly identified.  Other elements (like <code class="docutils literal notranslate"><span class="pre">params</span></code>, <code class="docutils literal notranslate"><span class="pre">query</span></code>, or <code class="docutils literal notranslate"><span class="pre">fragment</span></code>) are empty, because they were not part of our input.</p>
<p>The interesting thing is that executing only <code class="docutils literal notranslate"><span class="pre">urlparse()</span></code> is orders of magnitude faster than running all of <code class="docutils literal notranslate"><span class="pre">webbrowser()</span></code>.  Let us measure the factor:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">runs</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">urlparse_timer</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">runs</span><span class="p">):</span>
        <span class="n">urlparse</span><span class="p">(</span><span class="s1">&#39;https://www.fuzzingbook.com/html/Carver.html&#39;</span><span class="p">)</span>

<span class="n">avg_urlparse_time</span> <span class="o">=</span> <span class="n">urlparse_timer</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000</span>
<span class="n">avg_urlparse_time</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.4512089546769858e-06
</pre></div>
</div>
</div>
</div>
<p>Compare this to the time required by the web browser</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">webbrowser_timer</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.48406379198422655
</pre></div>
</div>
</div>
</div>
<p>The difference in time is huge:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">webbrowser_timer</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">()</span> <span class="o">/</span> <span class="n">avg_urlparse_time</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>333558.98916153726
</pre></div>
</div>
</div>
</div>
<p>Hence, in the time it takes to run <code class="docutils literal notranslate"><span class="pre">webbrowser()</span></code> once, we can have <em>tens of thousands</em> of executions of <code class="docutils literal notranslate"><span class="pre">urlparse()</span></code> – and this does not even take into account the time it takes the browser to render the downloaded HTML, to run the included scripts, and whatever else happens when a Web page is loaded.  Hence, strategies that allow us to test at the <em>unit</em> level are very promising as they can save lots of overhead.</p>
</section>
<section id="id1">
<h2>Carving Unit Tests<a class="headerlink" href="#id1" title="Link to this heading">#</a></h2>
<p>Testing methods and functions at the unit level requires a very good understanding of the individual units to be tested as well as their interplay with other units.  Setting up an appropriate infrastructure and writing unit tests by hand thus is demanding, yet rewarding.  There is, however, an interesting alternative to writing unit tests by hand.  The technique of <em>carving</em> automatically <em>converts system tests into unit tests</em> by means of recording and replaying function calls:</p>
<ol class="arabic simple">
<li><p>During a system test (given or generated), we <em>record</em> all calls into a function, including all arguments and other variables the function reads.</p></li>
<li><p>From these, we synthesize a self-contained <em>unit test</em> that reconstructs the function call with all arguments.</p></li>
<li><p>This unit test can be executed (replayed) at any time with high efficiency.</p></li>
</ol>
<p>In the remainder of this chapter, let us explore these steps.</p>
</section>
<section id="id2">
<h2>Recording Calls<a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<p>Our first challenge is to record function calls together with their arguments.  (In the interest of simplicity, we restrict ourselves to arguments, ignoring any global variables or other non-arguments that are read by the function.)  To record calls and arguments, we use the mechanism <a class="reference internal" href="Coverage.html"><span class="std std-doc">we introduced for coverage</span></a>: By setting up a tracer function, we track all calls into individual functions, also saving their arguments.  Just like <code class="docutils literal notranslate"><span class="pre">Coverage</span></code> objects, we want to use <code class="docutils literal notranslate"><span class="pre">Carver</span></code> objects to be able to be used in conjunction with the <code class="docutils literal notranslate"><span class="pre">with</span></code> statement, such that we can trace a particular code block:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Carver</span><span class="p">()</span> <span class="k">as</span> <span class="n">carver</span><span class="p">:</span>
    <span class="n">function_to_be_traced</span><span class="p">()</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">carver</span><span class="o">.</span><span class="n">calls</span><span class="p">()</span>
</pre></div>
</div>
<p>The initial definition supports this construct:</p>
<p>\todo{Get tracker from <a class="reference internal" href="DynamicInvariants.html"><span class="std std-doc">dynamic invariants</span></a>}</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Carver</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span> <span class="o">=</span> <span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Start of `with` block</span>
    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_trace_function</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">gettrace</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traceit</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="c1"># End of `with` block</span>
    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_trace_function</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The actual work takes place in the <code class="docutils literal notranslate"><span class="pre">traceit()</span></code> method, which records all calls in the <code class="docutils literal notranslate"><span class="pre">_calls</span></code> attribute.  First, we define two helper functions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">inspect</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_qualified_name</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the fully qualified name of the current function&quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">co_name</span>
    <span class="n">module</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmodule</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">name</span>
    <span class="k">return</span> <span class="n">name</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_arguments</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return call arguments in the given frame&quot;&quot;&quot;</span>
    <span class="c1"># When called, all arguments are local variables</span>
    <span class="n">local_variables</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="p">[(</span><span class="n">var</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
                 <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">local_variables</span><span class="p">]</span>
    <span class="n">arguments</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>  <span class="c1"># Want same order as call</span>
    <span class="k">return</span> <span class="n">arguments</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CallCarver</span><span class="p">(</span><span class="n">Carver</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">add_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">arguments</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add given call to list of calls&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">function_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">[</span><span class="n">function_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">[</span><span class="n">function_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span>

    <span class="c1"># Tracking function: Record all calls and all args</span>
    <span class="k">def</span> <span class="nf">traceit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event</span> <span class="o">!=</span> <span class="s2">&quot;call&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">code</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span>
        <span class="n">function_name</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">co_name</span>
        <span class="n">qualified_name</span> <span class="o">=</span> <span class="n">get_qualified_name</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="n">get_arguments</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_call</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">qualified_name</span> <span class="o">!=</span> <span class="n">function_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_call</span><span class="p">(</span><span class="n">qualified_name</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">simple_call_string</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">arguments</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we need some convenience functions to access the calls:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CallCarver</span><span class="p">(</span><span class="n">CallCarver</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">calls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a dictionary of all calls traced.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span>

    <span class="k">def</span> <span class="nf">arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of all arguments of the given function</span>
<span class="sd">        as (VAR, VALUE) pairs.</span>
<span class="sd">        Raises an exception if the function was not traced.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">[</span><span class="n">function_name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">called_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qualified</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all functions called.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">qualified</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">function_name</span> <span class="k">for</span> <span class="n">function_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">function_name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">function_name</span> <span class="k">for</span> <span class="n">function_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">function_name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<section id="recording-my-sqrt">
<h3>Recording my_sqrt()<a class="headerlink" href="#recording-my-sqrt" title="Link to this heading">#</a></h3>
<p>Let’s try out our new <code class="docutils literal notranslate"><span class="pre">Carver</span></code> class – first on a very simple function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Intro_Testing</span> <span class="kn">import</span> <span class="n">my_sqrt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">CallCarver</span><span class="p">()</span> <span class="k">as</span> <span class="n">sqrt_carver</span><span class="p">:</span>
    <span class="n">my_sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">my_sqrt</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can retrieve all calls seen…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sqrt_carver</span><span class="o">.</span><span class="n">calls</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;my_sqrt&#39;: [[(&#39;x&#39;, 2)], [(&#39;x&#39;, 4)]],
 &#39;Intro_Testing.my_sqrt&#39;: [[(&#39;x&#39;, 2)], [(&#39;x&#39;, 4)]],
 &#39;__exit__&#39;: [[(&#39;tb&#39;, None),
   (&#39;exc_value&#39;, None),
   (&#39;exc_type&#39;, None),
   (&#39;self&#39;, &lt;__main__.CallCarver at 0x164d98e20&gt;)]]}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sqrt_carver</span><span class="o">.</span><span class="n">called_functions</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;my_sqrt&#39;, &#39;__exit__&#39;]
</pre></div>
</div>
</div>
</div>
<p>… as well as the arguments of a particular function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sqrt_carver</span><span class="o">.</span><span class="n">arguments</span><span class="p">(</span><span class="s2">&quot;my_sqrt&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[(&#39;x&#39;, 2)], [(&#39;x&#39;, 4)]]
</pre></div>
</div>
</div>
</div>
<p>We define a convenience function for nicer printing of these lists:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">simple_call_string</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">argument_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return function_name(arg[0], arg[1], ...) as a string&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">function_name</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> \
        <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">var</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                   <span class="k">for</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">argument_list</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">function_name</span> <span class="ow">in</span> <span class="n">sqrt_carver</span><span class="o">.</span><span class="n">called_functions</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">argument_list</span> <span class="ow">in</span> <span class="n">sqrt_carver</span><span class="o">.</span><span class="n">arguments</span><span class="p">(</span><span class="n">function_name</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">simple_call_string</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">argument_list</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>my_sqrt(x=2)
my_sqrt(x=4)
__exit__(tb=None, exc_value=None, exc_type=None, self=&lt;__main__.CallCarver object at 0x164d98e20&gt;)
</pre></div>
</div>
</div>
</div>
<p>This is a syntax we can directly use to invoke <code class="docutils literal notranslate"><span class="pre">my_sqrt()</span></code> again:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;my_sqrt(x=2)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.414213562373095
</pre></div>
</div>
</div>
</div>
</section>
<section id="carving-urlparse">
<h3>Carving urlparse()<a class="headerlink" href="#carving-urlparse" title="Link to this heading">#</a></h3>
<p>What happens if we apply this to <code class="docutils literal notranslate"><span class="pre">webbrowser()</span></code>?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">CallCarver</span><span class="p">()</span> <span class="k">as</span> <span class="n">webbrowser_carver</span><span class="p">:</span>
    <span class="n">webbrowser</span><span class="p">(</span><span class="s2">&quot;https://www.fuzzingbook.org&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We see that retrieving a URL from the Web requires quite some functionality:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">function_list</span> <span class="o">=</span> <span class="n">webbrowser_carver</span><span class="o">.</span><span class="n">called_functions</span><span class="p">(</span><span class="n">qualified</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">function_list</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>361
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">function_list</span><span class="p">[:</span><span class="mi">50</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;requests.api.get&#39;, &#39;requests.api.request&#39;, &#39;requests.sessions.__init__&#39;, &#39;requests.utils.default_headers&#39;, &#39;requests.utils.default_user_agent&#39;, &#39;requests.structures.__init__&#39;, &#39;collections.abc.update&#39;, &#39;abc.__instancecheck__&#39;, &#39;requests.structures.__setitem__&#39;, &#39;requests.hooks.default_hooks&#39;, &#39;requests.hooks.&lt;dictcomp&gt;&#39;, &#39;requests.cookies.cookiejar_from_dict&#39;, &#39;http.cookiejar.__init__&#39;, &#39;threading.RLock&#39;, &#39;http.cookiejar.__iter__&#39;, &#39;requests.cookies.&lt;listcomp&gt;&#39;, &#39;http.cookiejar.deepvalues&#39;, &#39;http.cookiejar.vals_sorted_by_key&#39;, &#39;requests.adapters.__init__&#39;, &#39;urllib3.util.retry.__init__&#39;, &#39;urllib3.util.retry.&lt;listcomp&gt;&#39;, &#39;requests.adapters.init_poolmanager&#39;, &#39;urllib3.poolmanager.__init__&#39;, &#39;urllib3.request.__init__&#39;, &#39;urllib3._collections.__init__&#39;, &#39;requests.sessions.mount&#39;, &#39;requests.sessions.&lt;listcomp&gt;&#39;, &#39;requests.sessions.__enter__&#39;, &#39;requests.sessions.request&#39;, &#39;requests.models.__init__&#39;, &#39;requests.sessions.prepare_request&#39;, &#39;requests.cookies.merge_cookies&#39;, &#39;requests.cookies.update&#39;, &#39;requests.utils.get_netrc_auth&#39;, &#39;collections.abc.get&#39;, &#39;os.__getitem__&#39;, &#39;os.encode&#39;, &#39;requests.utils.&lt;genexpr&gt;&#39;, &#39;posixpath.expanduser&#39;, &#39;posixpath._get_sep&#39;, &#39;collections.abc.__contains__&#39;, &#39;os.decode&#39;, &#39;genericpath.exists&#39;, &#39;urllib.parse.urlparse&#39;, &#39;urllib.parse._coerce_args&#39;, &#39;urllib.parse.urlsplit&#39;, &#39;urllib.parse._splitnetloc&#39;, &#39;urllib.parse._checknetloc&#39;, &#39;urllib.parse._noop&#39;, &#39;netrc.__init__&#39;]
</pre></div>
</div>
</div>
</div>
<p>Among several other functions, we also have a call to <code class="docutils literal notranslate"><span class="pre">urlparse()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">urlparse_argument_list</span> <span class="o">=</span> <span class="n">webbrowser_carver</span><span class="o">.</span><span class="n">arguments</span><span class="p">(</span><span class="s2">&quot;urllib.parse.urlparse&quot;</span><span class="p">)</span>
<span class="n">urlparse_argument_list</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[(&#39;allow_fragments&#39;, True),
  (&#39;scheme&#39;, &#39;&#39;),
  (&#39;url&#39;, &#39;https://www.fuzzingbook.org&#39;)],
 [(&#39;allow_fragments&#39;, True),
  (&#39;scheme&#39;, &#39;&#39;),
  (&#39;url&#39;, &#39;https://www.fuzzingbook.org/&#39;)],
 [(&#39;allow_fragments&#39;, True),
  (&#39;scheme&#39;, &#39;&#39;),
  (&#39;url&#39;, &#39;https://www.fuzzingbook.org/&#39;)],
 [(&#39;allow_fragments&#39;, True),
  (&#39;scheme&#39;, &#39;&#39;),
  (&#39;url&#39;, &#39;https://www.fuzzingbook.org/&#39;)],
 [(&#39;allow_fragments&#39;, True),
  (&#39;scheme&#39;, &#39;&#39;),
  (&#39;url&#39;, &#39;https://www.fuzzingbook.org/&#39;)],
 [(&#39;allow_fragments&#39;, True),
  (&#39;scheme&#39;, &#39;&#39;),
  (&#39;url&#39;, &#39;https://www.fuzzingbook.org/&#39;)],
 [(&#39;allow_fragments&#39;, True),
  (&#39;scheme&#39;, &#39;&#39;),
  (&#39;url&#39;, &#39;https://www.fuzzingbook.org/&#39;)],
 [(&#39;allow_fragments&#39;, True),
  (&#39;scheme&#39;, &#39;&#39;),
  (&#39;url&#39;, &#39;https://www.fuzzingbook.org/&#39;)],
 [(&#39;allow_fragments&#39;, True),
  (&#39;scheme&#39;, &#39;&#39;),
  (&#39;url&#39;, &#39;https://www.fuzzingbook.org/&#39;)],
 [(&#39;allow_fragments&#39;, True),
  (&#39;scheme&#39;, &#39;&#39;),
  (&#39;url&#39;, &#39;https://www.fuzzingbook.org/&#39;)],
 [(&#39;allow_fragments&#39;, True),
  (&#39;scheme&#39;, &#39;&#39;),
  (&#39;url&#39;, &#39;https://www.fuzzingbook.org/&#39;)]]
</pre></div>
</div>
</div>
</div>
<p>Again, we can convert this into a well-formatted call:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">urlparse_call</span> <span class="o">=</span> <span class="n">simple_call_string</span><span class="p">(</span><span class="s2">&quot;urlparse&quot;</span><span class="p">,</span> <span class="n">urlparse_argument_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">urlparse_call</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&quot;urlparse(allow_fragments=True, scheme=&#39;&#39;, url=&#39;https://www.fuzzingbook.org&#39;)&quot;
</pre></div>
</div>
</div>
</div>
<p>Again, we can re-execute this call:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">eval</span><span class="p">(</span><span class="n">urlparse_call</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ParseResult(scheme=&#39;https&#39;, netloc=&#39;www.fuzzingbook.org&#39;, path=&#39;&#39;, params=&#39;&#39;, query=&#39;&#39;, fragment=&#39;&#39;)
</pre></div>
</div>
</div>
</div>
<p>We now have successfully carved the call to <code class="docutils literal notranslate"><span class="pre">urlparse()</span></code> out of the <code class="docutils literal notranslate"><span class="pre">webbrowser()</span></code> execution.</p>
</section>
</section>
<section id="replaying-calls">
<h2>Replaying Calls<a class="headerlink" href="#replaying-calls" title="Link to this heading">#</a></h2>
<p>Replaying calls in their entirety and in all generality is tricky, as there are several challenges to be addressed.  These include:</p>
<ol class="arabic simple">
<li><p>We need to be able to <em>access</em> individual functions.  If we access a function by name, the name must be in scope.  If the name is not visible (for instance, because it is a name internal to the module), we must make it visible.</p></li>
<li><p>Any <em>resources</em> accessed outside of arguments must be recorded and reconstructed for replay as well.  This can be difficult if variables refer to external resources such as files or network resources.</p></li>
<li><p><em>Complex objects</em> must be reconstructed as well.</p></li>
</ol>
<p>These constraints make carving hard or even impossible if the function to be tested interacts heavily with its environment.  To illustrate these issues, consider the <code class="docutils literal notranslate"><span class="pre">email.parser.parse()</span></code> method that is invoked in <code class="docutils literal notranslate"><span class="pre">webbrowser()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">email_parse_argument_list</span> <span class="o">=</span> <span class="n">webbrowser_carver</span><span class="o">.</span><span class="n">arguments</span><span class="p">(</span><span class="s2">&quot;email.parser.parse&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Calls to this method look like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">email_parse_call</span> <span class="o">=</span> <span class="n">simple_call_string</span><span class="p">(</span>
    <span class="s2">&quot;email.parser.Parser.parse&quot;</span><span class="p">,</span>
    <span class="n">email_parse_argument_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">email_parse_call</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;email.parser.Parser.parse(headersonly=False, fp=&lt;_io.StringIO object at 0x165160040&gt;, self=&lt;email.parser.Parser object at 0x164d9a3b0&gt;)&#39;
</pre></div>
</div>
</div>
</div>
<p>We see that <code class="docutils literal notranslate"><span class="pre">email.parser.Parser.parse()</span></code> is part of a <code class="docutils literal notranslate"><span class="pre">email.parser.Parser</span></code> object (<code class="docutils literal notranslate"><span class="pre">self</span></code>) and it gets a <code class="docutils literal notranslate"><span class="pre">StringIO</span></code> object (<code class="docutils literal notranslate"><span class="pre">fp</span></code>).  Both are non-primitive values.  How could we possibly reconstruct them?</p>
<section id="serializing-objects">
<h3>Serializing Objects<a class="headerlink" href="#serializing-objects" title="Link to this heading">#</a></h3>
<p>The answer to the problem of complex objects lies in creating a <em>persistent</em> representation that can be <em>reconstructed</em> at later points in time.  This process is known as <em>serialization</em>; in Python, it is also known as <em>pickling</em>.  The <code class="docutils literal notranslate"><span class="pre">pickle</span></code> module provides means to create a serialized representation of an object.  Let us apply this on the <code class="docutils literal notranslate"><span class="pre">email.parser.Parser</span></code> object we just found:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pickle</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">email_parse_argument_list</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[(&#39;headersonly&#39;, False),
  (&#39;fp&#39;, &lt;_io.StringIO at 0x165160040&gt;),
  (&#39;self&#39;, &lt;email.parser.Parser at 0x164d9a3b0&gt;)]]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">parser_object</span> <span class="o">=</span> <span class="n">email_parse_argument_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
<span class="n">parser_object</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;email.parser.Parser at 0x164d9a3b0&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pickled</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">parser_object</span><span class="p">)</span>
<span class="n">pickled</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>b&#39;\x80\x04\x95w\x00\x00\x00\x00\x00\x00\x00\x8c\x0cemail.parser\x94\x8c\x06Parser\x94\x93\x94)\x81\x94}\x94(\x8c\x06_class\x94\x8c\x0bhttp.client\x94\x8c\x0bHTTPMessage\x94\x93\x94\x8c\x06policy\x94\x8c\x11email._policybase\x94\x8c\x08Compat32\x94\x93\x94)\x81\x94ub.&#39;
</pre></div>
</div>
</div>
</div>
<p>From this string representing the serialized <code class="docutils literal notranslate"><span class="pre">email.parser.Parser</span></code> object, we can recreate the Parser object at any time:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">unpickled_parser_object</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pickled</span><span class="p">)</span>
<span class="n">unpickled_parser_object</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;email.parser.Parser at 0x1653cc430&gt;
</pre></div>
</div>
</div>
</div>
<p>The serialization mechanism allows us to produce a representation for all objects passed as parameters (assuming they can be pickled, that is).  We can now extend the <code class="docutils literal notranslate"><span class="pre">simple_call_string()</span></code> function such that it automatically pickles objects.  Additionally, we set it up such that if the first parameter is named <code class="docutils literal notranslate"><span class="pre">self</span></code> (i.e., it is a class method), we make it a method of the <code class="docutils literal notranslate"><span class="pre">self</span></code> object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">call_value</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="n">value_as_string</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value_as_string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Complex object</span>
        <span class="n">value_as_string</span> <span class="o">=</span> <span class="s2">&quot;pickle.loads(&quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
    <span class="k">return</span> <span class="n">value_as_string</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">call_string</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">argument_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return function_name(arg[0], arg[1], ...) as a string, pickling complex objects&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argument_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="p">(</span><span class="n">first_var</span><span class="p">,</span> <span class="n">first_value</span><span class="p">)</span> <span class="o">=</span> <span class="n">argument_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">first_var</span> <span class="o">==</span> <span class="s2">&quot;self&quot;</span><span class="p">:</span>
            <span class="c1"># Make this a method call</span>
            <span class="n">method_name</span> <span class="o">=</span> <span class="n">function_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">function_name</span> <span class="o">=</span> <span class="n">call_value</span><span class="p">(</span><span class="n">first_value</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">method_name</span>
            <span class="n">argument_list</span> <span class="o">=</span> <span class="n">argument_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="k">return</span> <span class="n">function_name</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> \
        <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">var</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="n">call_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                   <span class="k">for</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">argument_list</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>Let us apply the extended <code class="docutils literal notranslate"><span class="pre">call_string()</span></code> method to create a call for <code class="docutils literal notranslate"><span class="pre">email.parser.parse()</span></code>, including pickled objects:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">call</span> <span class="o">=</span> <span class="n">call_string</span><span class="p">(</span><span class="s2">&quot;email.parser.Parser.parse&quot;</span><span class="p">,</span> <span class="n">email_parse_argument_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">call</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>email.parser.Parser.parse(headersonly=False, fp=pickle.loads(b&#39;\x80\x04\x95\xc4\x02\x00\x00\x00\x00\x00\x00\x8c\x03_io\x94\x8c\x08StringIO\x94\x93\x94)\x81\x94(X\x9b\x02\x00\x00Connection: keep-alive\r\nContent-Length: 51336\r\nServer: GitHub.com\r\nContent-Type: text/html; charset=utf-8\r\nLast-Modified: Sat, 09 Nov 2024 16:09:36 GMT\r\nAccess-Control-Allow-Origin: *\r\nETag: W/&quot;672f8940-4620a&quot;\r\nexpires: Sat, 09 Nov 2024 17:02:19 GMT\r\nCache-Control: max-age=600\r\nContent-Encoding: gzip\r\nx-proxy-cache: MISS\r\nX-GitHub-Request-Id: 4FED:361A70:4094950:424934E:672F9343\r\nAccept-Ranges: bytes\r\nAge: 0\r\nDate: Sat, 09 Nov 2024 16:52:20 GMT\r\nVia: 1.1 varnish\r\nX-Served-By: cache-fra-eddf8230152-FRA\r\nX-Cache: MISS\r\nX-Cache-Hits: 0\r\nX-Timer: S1731171140.907105,VS0,VE105\r\nVary: Accept-Encoding\r\nX-Fastly-Request-ID: ca9f40b3c3e14ac63fadb8002a5b3b2d5be59d1b\r\n\r\n\x94\x8c\x01\n\x94M\x9b\x02Nt\x94b.&#39;), self=pickle.loads(b&#39;\x80\x04\x95w\x00\x00\x00\x00\x00\x00\x00\x8c\x0cemail.parser\x94\x8c\x06Parser\x94\x93\x94)\x81\x94}\x94(\x8c\x06_class\x94\x8c\x0bhttp.client\x94\x8c\x0bHTTPMessage\x94\x93\x94\x8c\x06policy\x94\x8c\x11email._policybase\x94\x8c\x08Compat32\x94\x93\x94)\x81\x94ub.&#39;))
</pre></div>
</div>
</div>
</div>
<p>With this call involving the pickled object, we can now re-run the original call and obtain a valid result:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">email</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">eval</span><span class="p">(</span><span class="n">call</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;http.client.HTTPMessage at 0x1653cd720&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="all-calls">
<h3>All Calls<a class="headerlink" href="#all-calls" title="Link to this heading">#</a></h3>
<p>So far, we have seen only one call of <code class="docutils literal notranslate"><span class="pre">webbrowser()</span></code>.  How many of the calls within <code class="docutils literal notranslate"><span class="pre">webbrowser()</span></code> can we actually carve and replay?  Let us try this out and compute the numbers.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">traceback</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">socket</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_functions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">webbrowser_carver</span><span class="o">.</span><span class="n">called_functions</span><span class="p">(</span><span class="n">qualified</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="n">call_success</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="n">run_success</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exceptions_seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<span class="k">for</span> <span class="n">function_name</span> <span class="ow">in</span> <span class="n">webbrowser_carver</span><span class="o">.</span><span class="n">called_functions</span><span class="p">(</span><span class="n">qualified</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">argument_list</span> <span class="ow">in</span> <span class="n">webbrowser_carver</span><span class="o">.</span><span class="n">arguments</span><span class="p">(</span><span class="n">function_name</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">call</span> <span class="o">=</span> <span class="n">call_string</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">argument_list</span><span class="p">)</span>
            <span class="n">call_success</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">call</span><span class="p">)</span>
            <span class="n">run_success</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">exceptions_seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
            <span class="c1"># print(&quot;-&gt;&quot;, call, file=sys.stderr)</span>
            <span class="c1"># traceback.print_exc()</span>
            <span class="c1"># print(&quot;&quot;, file=sys.stderr)</span>
            <span class="k">continue</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> calls (</span><span class="si">%.2f%%</span><span class="s2">) successfully created and </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> calls (</span><span class="si">%.2f%%</span><span class="s2">) successfully ran&quot;</span> <span class="o">%</span> <span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">call_success</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_functions</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span>
        <span class="n">call_success</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_functions</span><span class="p">),</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">run_success</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_functions</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">run_success</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_functions</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>240/361 calls (66.48%) successfully created and 49/361 calls (13.57%) successfully ran
</pre></div>
</div>
</div>
</div>
<p>About a quarter of the calls succeed.  Let us take a look into some of the error messages we get:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">exceptions_seen</span><span class="p">)[</span><span class="n">i</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>NameError(&quot;name &#39;logging&#39; is not defined&quot;)
TypeError(&quot;cannot pickle &#39;SSLSocket&#39; object&quot;)
AttributeError(&quot;module &#39;enum&#39; has no attribute &#39;__call__&#39;&quot;)
AttributeError(&quot;&#39;NoneType&#39; object has no attribute &#39;readline&#39;&quot;)
NameError(&quot;name &#39;codecs&#39; is not defined&quot;)
SyntaxError(&#39;invalid syntax&#39;, (&#39;&lt;string&gt;&#39;, 1, 17, &quot;requests.models.&lt;genexpr&gt;(.0=pickle.loads(b&#39;\\x80\\x04\\x95\\x1b\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x8c\\x08builtins\\x94\\x8c\\x04iter\\x94\\x93\\x94]\\x94\\x85\\x94R\\x94.&#39;))&quot;, 1, 18))
SyntaxError(&#39;invalid syntax&#39;, (&#39;&lt;string&gt;&#39;, 1, 18, &quot;urllib3.util.url.&lt;genexpr&gt;(.0=pickle.loads(b&#39;\\x80\\x04\\x95\\x1c\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x8c\\x08builtins\\x94\\x8c\\x04iter\\x94\\x93\\x94\\x8c\\x00\\x94\\x85\\x94R\\x94.&#39;))&quot;, 1, 19))
AttributeError(&quot;module &#39;email.parser&#39; has no attribute &#39;parsestr&#39;&quot;)
SyntaxError(&#39;invalid syntax&#39;, (&#39;&lt;string&gt;&#39;, 1, 16, &quot;requests.utils.&lt;genexpr&gt;(f=&#39;.netrc&#39;, .0=pickle.loads(b&#39;\\x80\\x04\\x950\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x8c\\x08builtins\\x94\\x8c\\x04iter\\x94\\x93\\x94\\x8c\\x06.netrc\\x94\\x8c\\x06_netrc\\x94\\x86\\x94\\x85\\x94R\\x94K\\x01b.&#39;))&quot;, 1, 17))
AttributeError(&quot;module &#39;email.message&#39; has no attribute &#39;get&#39;&quot;)
</pre></div>
</div>
</div>
</div>
<p>We see that:</p>
<ul class="simple">
<li><p><strong>A large majority of calls could be converted into call strings.</strong>  If this is not the case, this is mostly due to having non-serialized objects being passed.</p></li>
<li><p><strong>About a quarter of the calls could be executed.</strong>  The error messages for the failing runs are varied; the most frequent being that some internal name is invoked that is not in scope.</p></li>
</ul>
<p>Our carving mechanism should be taken with a grain of salt: We still do not cover the situation where external variables and values (such as global variables) are being accessed, and the serialization mechanism cannot recreate external resources.  Still, if the function of interest falls among those that <em>can</em> be carved and replayed, we can very effectively re-run its calls with their original arguments.</p>
</section>
</section>
<section id="mining-api-grammars-from-carved-calls">
<h2>Mining API Grammars from Carved Calls<a class="headerlink" href="#mining-api-grammars-from-carved-calls" title="Link to this heading">#</a></h2>
<p>So far, we have used carved calls to replay exactly the same invocations as originally encountered.  However, we can also <em>mutate</em> carved calls to effectively fuzz APIs with previously recorded arguments.</p>
<p>The general idea is as follows:</p>
<ol class="arabic simple">
<li><p>First, we record all calls of a specific function from a given execution of the program.</p></li>
<li><p>Second, we create a grammar that incorporates all these calls, with separate rules for each argument and alternatives for each value found; this allows us to produce calls that arbitrarily <em>recombine</em> these arguments.</p></li>
</ol>
<p>Let us explore these steps in the following sections.</p>
<section id="from-calls-to-grammars">
<h3>From Calls to Grammars<a class="headerlink" href="#from-calls-to-grammars" title="Link to this heading">#</a></h3>
<p>Let us start with an example.  The <code class="docutils literal notranslate"><span class="pre">power(x,</span> <span class="pre">y)</span></code> function returns <span class="math notranslate nohighlight">\(x^y\)</span>; it is but a wrapper around the equivalent <code class="docutils literal notranslate"><span class="pre">math.pow()</span></code> function.  (Since <code class="docutils literal notranslate"><span class="pre">power()</span></code> is defined in Python, we can trace it – in contrast to <code class="docutils literal notranslate"><span class="pre">math.pow()</span></code>, which is implemented in C.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">power</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let us invoke <code class="docutils literal notranslate"><span class="pre">power()</span></code> while recording its arguments:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">CallCarver</span><span class="p">()</span> <span class="k">as</span> <span class="n">power_carver</span><span class="p">:</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">power</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">power</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">power_carver</span><span class="o">.</span><span class="n">arguments</span><span class="p">(</span><span class="s2">&quot;power&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[(&#39;y&#39;, 2), (&#39;x&#39;, 1)], [(&#39;y&#39;, 4), (&#39;x&#39;, 3)]]
</pre></div>
</div>
</div>
</div>
<p>From this list of recorded arguments, we could now create a grammar for the <code class="docutils literal notranslate"><span class="pre">power()</span></code> call, with <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> expanding into the values seen:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Grammars</span> <span class="kn">import</span> <span class="n">START_SYMBOL</span><span class="p">,</span> <span class="n">is_valid_grammar</span><span class="p">,</span> <span class="n">new_symbol</span>
<span class="kn">from</span> <span class="nn">Grammars</span> <span class="kn">import</span> <span class="n">extend_grammar</span><span class="p">,</span> <span class="n">Grammar</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">POWER_GRAMMAR</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;power(&lt;x&gt;, &lt;y&gt;)&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;x&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;y&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">]</span>
<span class="p">}</span>

<span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">POWER_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>When fuzzing with this grammar, we then get arbitrary combinations of <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code>; aiming for coverage will ensure that all values are actually tested at least once:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">GrammarCoverageFuzzer</span> <span class="kn">import</span> <span class="n">GrammarCoverageFuzzer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">power_fuzzer</span> <span class="o">=</span> <span class="n">GrammarCoverageFuzzer</span><span class="p">(</span><span class="n">POWER_GRAMMAR</span><span class="p">)</span>
<span class="p">[</span><span class="n">power_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;power(1, 2)&#39;, &#39;power(3, 4)&#39;, &#39;power(1, 2)&#39;, &#39;power(3, 4)&#39;, &#39;power(3, 4)&#39;]
</pre></div>
</div>
</div>
</div>
<p>What we need is a method to automatically convert the arguments as seen in <code class="docutils literal notranslate"><span class="pre">power_carver</span></code> to the grammar as seen in <code class="docutils literal notranslate"><span class="pre">POWER_GRAMMAR</span></code>.  This is what we define in the next section.</p>
</section>
<section id="a-grammar-miner-for-calls">
<h3>A Grammar Miner for Calls<a class="headerlink" href="#a-grammar-miner-for-calls" title="Link to this heading">#</a></h3>
<p>We introduce a class <code class="docutils literal notranslate"><span class="pre">CallGrammarMiner</span></code>, which, given a <code class="docutils literal notranslate"><span class="pre">Carver</span></code>, automatically produces a grammar from the calls seen.  To initialize, we pass the carver object:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CallGrammarMiner</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carver</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">carver</span> <span class="o">=</span> <span class="n">carver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>
</pre></div>
</div>
</div>
</div>
<section id="initial-grammar">
<h4>Initial Grammar<a class="headerlink" href="#initial-grammar" title="Link to this heading">#</a></h4>
<p>The initial grammar produces a single call.  The possible <code class="docutils literal notranslate"><span class="pre">&lt;call&gt;</span></code> expansions are to be constructed later:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">copy</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CallGrammarMiner</span><span class="p">(</span><span class="n">CallGrammarMiner</span><span class="p">):</span>
    <span class="n">CALL_SYMBOL</span> <span class="o">=</span> <span class="s2">&quot;&lt;call&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">initial_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">extend_grammar</span><span class="p">(</span>
            <span class="p">{</span><span class="n">START_SYMBOL</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALL_SYMBOL</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">CALL_SYMBOL</span><span class="p">:</span> <span class="p">[]</span>
             <span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">CallGrammarMiner</span><span class="p">(</span><span class="n">power_carver</span><span class="p">)</span>
<span class="n">initial_grammar</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">initial_grammar</span><span class="p">()</span>
<span class="n">initial_grammar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&lt;start&gt;&#39;: [&#39;&lt;call&gt;&#39;], &#39;&lt;call&gt;&#39;: []}
</pre></div>
</div>
</div>
</div>
</section>
<section id="a-grammar-from-arguments">
<h4>A Grammar from Arguments<a class="headerlink" href="#a-grammar-from-arguments" title="Link to this heading">#</a></h4>
<p>Let us start by creating a grammar from a list of arguments.  The method <code class="docutils literal notranslate"><span class="pre">mine_arguments_grammar()</span></code> creates a grammar for the arguments seen during carving, such as these:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arguments</span> <span class="o">=</span> <span class="n">power_carver</span><span class="o">.</span><span class="n">arguments</span><span class="p">(</span><span class="s2">&quot;power&quot;</span><span class="p">)</span>
<span class="n">arguments</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[(&#39;y&#39;, 2), (&#39;x&#39;, 1)], [(&#39;y&#39;, 4), (&#39;x&#39;, 3)]]
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">mine_arguments_grammar()</span></code> method iterates through the variables seen and creates a mapping <code class="docutils literal notranslate"><span class="pre">variables</span></code> of variable names to a set of values seen (as strings, going through <code class="docutils literal notranslate"><span class="pre">call_value()</span></code>).  In a second step, it then creates a grammar with a rule for each variable name, expanding into the values seen.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CallGrammarMiner</span><span class="p">(</span><span class="n">CallGrammarMiner</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">var_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">grammar</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">new_symbol</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="n">function_name</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">var</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mine_arguments_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">grammar</span><span class="p">):</span>
        <span class="n">var_grammar</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">variables</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">argument_list</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">argument_list</span><span class="p">:</span>
                <span class="n">value_string</span> <span class="o">=</span> <span class="n">call_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="n">value_string</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">value_string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">var_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;langle&gt;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&lt;&quot;</span><span class="p">]</span>
                    <span class="n">value_string</span> <span class="o">=</span> <span class="n">value_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;langle&gt;&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
                    <span class="n">variables</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="n">variables</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value_string</span><span class="p">)</span>

        <span class="n">var_symbols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="n">var_symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_symbol</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">grammar</span><span class="p">)</span>
            <span class="n">var_symbols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var_symbol</span><span class="p">)</span>
            <span class="n">var_grammar</span><span class="p">[</span><span class="n">var_symbol</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">var_grammar</span><span class="p">,</span> <span class="n">var_symbols</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">CallGrammarMiner</span><span class="p">(</span><span class="n">power_carver</span><span class="p">)</span>
<span class="n">var_grammar</span><span class="p">,</span> <span class="n">var_symbols</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">mine_arguments_grammar</span><span class="p">(</span>
    <span class="s2">&quot;power&quot;</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">initial_grammar</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">var_grammar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&lt;power-y&gt;&#39;: [&#39;2&#39;, &#39;4&#39;], &#39;&lt;power-x&gt;&#39;: [&#39;3&#39;, &#39;1&#39;]}
</pre></div>
</div>
</div>
</div>
<p>The additional return value <code class="docutils literal notranslate"><span class="pre">var_symbols</span></code> is a list of argument symbols in the call:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">var_symbols</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;&lt;power-y&gt;&#39;, &#39;&lt;power-x&gt;&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="a-grammar-from-calls">
<h4>A Grammar from Calls<a class="headerlink" href="#a-grammar-from-calls" title="Link to this heading">#</a></h4>
<p>To get the grammar for a single function (<code class="docutils literal notranslate"><span class="pre">mine_function_grammar()</span></code>), we add a call to the function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CallGrammarMiner</span><span class="p">(</span><span class="n">CallGrammarMiner</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">function_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">grammar</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">new_symbol</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="n">function_name</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mine_function_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">grammar</span><span class="p">):</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">carver</span><span class="o">.</span><span class="n">arguments</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>

        <span class="n">var_grammar</span><span class="p">,</span> <span class="n">var_symbols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mine_arguments_grammar</span><span class="p">(</span>
            <span class="n">function_name</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">grammar</span><span class="p">)</span>

        <span class="n">function_grammar</span> <span class="o">=</span> <span class="n">var_grammar</span>
        <span class="n">function_symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_symbol</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">grammar</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_symbols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">var_symbols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;-self&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Method call</span>
            <span class="n">function_grammar</span><span class="p">[</span><span class="n">function_symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">var_symbols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">function_name</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">var_symbols</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">function_grammar</span><span class="p">[</span><span class="n">function_symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">function_name</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">var_symbols</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">function_symbol</span><span class="p">,</span> <span class="s2">&quot;::=&quot;</span><span class="p">,</span> <span class="n">function_grammar</span><span class="p">[</span><span class="n">function_symbol</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">function_grammar</span><span class="p">,</span> <span class="n">function_symbol</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">CallGrammarMiner</span><span class="p">(</span><span class="n">power_carver</span><span class="p">)</span>
<span class="n">function_grammar</span><span class="p">,</span> <span class="n">function_symbol</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">mine_function_grammar</span><span class="p">(</span>
    <span class="s2">&quot;power&quot;</span><span class="p">,</span> <span class="n">initial_grammar</span><span class="p">)</span>
<span class="n">function_grammar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&lt;power-y&gt;&#39;: [&#39;2&#39;, &#39;4&#39;],
 &#39;&lt;power-x&gt;&#39;: [&#39;3&#39;, &#39;1&#39;],
 &#39;&lt;power&gt;&#39;: [&#39;power(&lt;power-y&gt;, &lt;power-x&gt;)&#39;]}
</pre></div>
</div>
</div>
</div>
<p>The additionally returned <code class="docutils literal notranslate"><span class="pre">function_symbol</span></code> holds the name of the function call just added:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">function_symbol</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;&lt;power&gt;&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="a-grammar-from-all-calls">
<h4>A Grammar from all Calls<a class="headerlink" href="#a-grammar-from-all-calls" title="Link to this heading">#</a></h4>
<p>Let us now repeat the above for all function calls seen during carving.  To this end, we simply iterate over all function calls seen:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">power_carver</span><span class="o">.</span><span class="n">called_functions</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;power&#39;, &#39;__exit__&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CallGrammarMiner</span><span class="p">(</span><span class="n">CallGrammarMiner</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">mine_call_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qualified</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">grammar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_grammar</span><span class="p">()</span>
        <span class="n">fn_list</span> <span class="o">=</span> <span class="n">function_list</span>
        <span class="k">if</span> <span class="n">function_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fn_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">carver</span><span class="o">.</span><span class="n">called_functions</span><span class="p">(</span><span class="n">qualified</span><span class="o">=</span><span class="n">qualified</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">function_name</span> <span class="ow">in</span> <span class="n">fn_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">function_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">function_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">function_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">)):</span>
                <span class="k">continue</span>  <span class="c1"># Internal function</span>

            <span class="c1"># Ignore errors with mined functions</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">function_grammar</span><span class="p">,</span> <span class="n">function_symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mine_function_grammar</span><span class="p">(</span>
                    <span class="n">function_name</span><span class="p">,</span> <span class="n">grammar</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">function_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span>

            <span class="k">if</span> <span class="n">function_symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grammar</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALL_SYMBOL</span><span class="p">]:</span>
                <span class="n">grammar</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CALL_SYMBOL</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">function_symbol</span><span class="p">)</span>
            <span class="n">grammar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">function_grammar</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">grammar</span>
</pre></div>
</div>
</div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">mine_call_grammar()</span></code> is the one that clients can and should use – first for mining…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">CallGrammarMiner</span><span class="p">(</span><span class="n">power_carver</span><span class="p">)</span>
<span class="n">power_grammar</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">mine_call_grammar</span><span class="p">()</span>
<span class="n">power_grammar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&lt;start&gt;&#39;: [&#39;&lt;call&gt;&#39;],
 &#39;&lt;call&gt;&#39;: [&#39;&lt;power&gt;&#39;],
 &#39;&lt;power-y&gt;&#39;: [&#39;2&#39;, &#39;4&#39;],
 &#39;&lt;power-x&gt;&#39;: [&#39;3&#39;, &#39;1&#39;],
 &#39;&lt;power&gt;&#39;: [&#39;power(&lt;power-y&gt;, &lt;power-x&gt;)&#39;]}
</pre></div>
</div>
</div>
</div>
<p>…and then for fuzzing:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">power_fuzzer</span> <span class="o">=</span> <span class="n">GrammarCoverageFuzzer</span><span class="p">(</span><span class="n">power_grammar</span><span class="p">)</span>
<span class="p">[</span><span class="n">power_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;power(4, 3)&#39;, &#39;power(2, 1)&#39;, &#39;power(4, 3)&#39;, &#39;power(4, 3)&#39;, &#39;power(2, 3)&#39;]
</pre></div>
</div>
</div>
</div>
<p>With this, we have successfully extracted a grammar from a recorded execution; in contrast to “simple” carving, our grammar allows us to <em>recombine</em> arguments and thus to fuzz at the API level.</p>
</section>
</section>
</section>
<section id="fuzzing-web-functions">
<h2>Fuzzing Web Functions<a class="headerlink" href="#fuzzing-web-functions" title="Link to this heading">#</a></h2>
<p>Let us now apply our grammar miner on a larger API – the <code class="docutils literal notranslate"><span class="pre">urlparse()</span></code> function we already encountered during carving.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">CallCarver</span><span class="p">()</span> <span class="k">as</span> <span class="n">webbrowser_carver</span><span class="p">:</span>
    <span class="n">webbrowser</span><span class="p">(</span><span class="s2">&quot;https://www.fuzzingbook.org&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can mine a grammar from the calls encountered:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">CallGrammarMiner</span><span class="p">(</span><span class="n">webbrowser_carver</span><span class="p">)</span>
<span class="n">webbrowser_grammar</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">mine_call_grammar</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>This is a rather large grammar:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">call_list</span> <span class="o">=</span> <span class="n">webbrowser_grammar</span><span class="p">[</span><span class="s1">&#39;&lt;call&gt;&#39;</span><span class="p">]</span>
<span class="nb">len</span><span class="p">(</span><span class="n">call_list</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>136
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">call_list</span><span class="p">[:</span><span class="mi">20</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;&lt;webbrowser&gt;&#39;, &#39;&lt;default_headers&gt;&#39;, &#39;&lt;default_user_agent&gt;&#39;, &#39;&lt;update&gt;&#39;, &#39;&lt;default_hooks&gt;&#39;, &#39;&lt;cookiejar_from_dict&gt;&#39;, &#39;&lt;RLock&gt;&#39;, &#39;&lt;deepvalues&gt;&#39;, &#39;&lt;vals_sorted_by_key&gt;&#39;, &#39;&lt;init_poolmanager&gt;&#39;, &#39;&lt;mount&gt;&#39;, &#39;&lt;prepare_request&gt;&#39;, &#39;&lt;merge_cookies&gt;&#39;, &#39;&lt;get_netrc_auth&gt;&#39;, &#39;&lt;encode&gt;&#39;, &#39;&lt;expanduser&gt;&#39;, &#39;&lt;decode&gt;&#39;, &#39;&lt;exists&gt;&#39;, &#39;&lt;urlparse&gt;&#39;, &#39;&lt;urlsplit&gt;&#39;]
</pre></div>
</div>
</div>
</div>
<p>Here’s the rule for the <code class="docutils literal notranslate"><span class="pre">urlparse()</span></code> function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">webbrowser_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;urlparse&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;urlparse(&lt;urlparse-allow_fragments&gt;, &lt;urlparse-scheme&gt;, &lt;urlparse-url&gt;)&#39;]
</pre></div>
</div>
</div>
</div>
<p>Here are the arguments.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">webbrowser_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;urlparse-url&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&quot;&#39;https://www.fuzzingbook.org&#39;&quot;, &quot;&#39;https://www.fuzzingbook.org/&#39;&quot;]
</pre></div>
</div>
</div>
</div>
<p>If we now apply a fuzzer on these rules, we systematically cover all variations of arguments seen, including, of course, combinations not seen during carving.  Again, we are fuzzing at the API level here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">urlparse_fuzzer</span> <span class="o">=</span> <span class="n">GrammarCoverageFuzzer</span><span class="p">(</span>
    <span class="n">webbrowser_grammar</span><span class="p">,</span> <span class="n">start_symbol</span><span class="o">=</span><span class="s2">&quot;&lt;urlparse&gt;&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">urlparse_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>urlparse(True, &#39;&#39;, &#39;https://www.fuzzingbook.org&#39;)
urlparse(True, &#39;&#39;, &#39;https://www.fuzzingbook.org/&#39;)
urlparse(True, &#39;&#39;, &#39;https://www.fuzzingbook.org&#39;)
urlparse(True, &#39;&#39;, &#39;https://www.fuzzingbook.org&#39;)
urlparse(True, &#39;&#39;, &#39;https://www.fuzzingbook.org&#39;)
</pre></div>
</div>
</div>
</div>
<p>Just as seen with carving, running tests at the API level is orders of magnitude faster than executing system tests.  Hence, this calls for means to fuzz at the method level:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlsplit</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Timer</span> <span class="kn">import</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">urlsplit_timer</span><span class="p">:</span>
    <span class="n">urlsplit</span><span class="p">(</span><span class="s1">&#39;http://www.fuzzingbook.org/&#39;</span><span class="p">,</span> <span class="s1">&#39;http&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">urlsplit_timer</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.2375006917864084e-05
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">webbrowser_timer</span><span class="p">:</span>
    <span class="n">webbrowser</span><span class="p">(</span><span class="s2">&quot;http://www.fuzzingbook.org&quot;</span><span class="p">)</span>
<span class="n">webbrowser_timer</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.31702329200925305
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">webbrowser_timer</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">()</span> <span class="o">/</span> <span class="n">urlsplit_timer</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>25618.029477754102
</pre></div>
</div>
</div>
</div>
<p>But then again, the caveats encountered during carving apply, notably the requirement to recreate the original function environment.  If we also alter or recombine arguments, we get the additional risk of <em>violating an implicit precondition</em> – that is, invoking a function with arguments the function was never designed for.  Such <em>false alarms</em>, resulting from incorrect invocations rather than incorrect implementations, must then be identified (typically manually) and wed out (for instance, by altering or constraining the grammar).  The huge speed gains at the API level, however, may well justify this additional investment.</p>
</section>
<section id="id3">
<h2>Synopsis<a class="headerlink" href="#id3" title="Link to this heading">#</a></h2>
<p>This chapter provides means to <em>record and replay function calls</em> during a system test.  Since individual function calls are much faster than a whole system run, such “carving” mechanisms have the potential to run tests much faster.</p>
<section id="id4">
<h3>Recording Calls<a class="headerlink" href="#id4" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">CallCarver</span></code> class records all calls occurring while it is active.  It is used in conjunction with a <code class="docutils literal notranslate"><span class="pre">with</span></code> clause:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">CallCarver</span><span class="p">()</span> <span class="k">as</span> <span class="n">carver</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">my_sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">my_sqrt</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>After execution, <code class="docutils literal notranslate"><span class="pre">called_functions()</span></code> lists the names of functions encountered:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">carver</span><span class="o">.</span><span class="n">called_functions</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;my_sqrt&#39;, &#39;__exit__&#39;]
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">arguments()</span></code> method lists the arguments recorded for a function.  This is a mapping of the function name to a list of lists of arguments; each argument is a pair (parameter name, value).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">carver</span><span class="o">.</span><span class="n">arguments</span><span class="p">(</span><span class="s1">&#39;my_sqrt&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[(&#39;x&#39;, 2)], [(&#39;x&#39;, 4)]]
</pre></div>
</div>
</div>
</div>
<p>Complex arguments are properly serialized, such that they can be easily restored.</p>
</section>
<section id="id5">
<h3>Synthesizing Calls<a class="headerlink" href="#id5" title="Link to this heading">#</a></h3>
<p>While such recorded arguments already could be turned into arguments and calls, a much nicer alternative is to create a <em>grammar</em> for recorded calls.  This allows synthesizing arbitrary <em>combinations</em> of arguments, and also offers a base for further customization of calls.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">CallGrammarMiner</span></code> class turns a list of carved executions into a grammar.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">my_sqrt_miner</span> <span class="o">=</span> <span class="n">CallGrammarMiner</span><span class="p">(</span><span class="n">carver</span><span class="p">)</span>
<span class="n">my_sqrt_grammar</span> <span class="o">=</span> <span class="n">my_sqrt_miner</span><span class="o">.</span><span class="n">mine_call_grammar</span><span class="p">()</span>
<span class="n">my_sqrt_grammar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&lt;start&gt;&#39;: [&#39;&lt;call&gt;&#39;],
 &#39;&lt;call&gt;&#39;: [&#39;&lt;my_sqrt&gt;&#39;],
 &#39;&lt;my_sqrt-x&gt;&#39;: [&#39;2&#39;, &#39;4&#39;],
 &#39;&lt;my_sqrt&gt;&#39;: [&#39;my_sqrt(&lt;my_sqrt-x&gt;)&#39;]}
</pre></div>
</div>
</div>
</div>
<p>This grammar can be used to synthesize calls.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fuzzer</span> <span class="o">=</span> <span class="n">GrammarCoverageFuzzer</span><span class="p">(</span><span class="n">my_sqrt_grammar</span><span class="p">)</span>
<span class="n">fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;my_sqrt(4)&#39;
</pre></div>
</div>
</div>
</div>
<p>These calls can be executed in isolation, effectively extracting unit tests from system tests:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">eval</span><span class="p">(</span><span class="n">fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.414213562373095
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="lessons-learned">
<h2>Lessons Learned<a class="headerlink" href="#lessons-learned" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><em>Carving</em> allows for effective replay of function calls recorded during a system test.</p></li>
<li><p>A function call can be <em>orders of magnitude faster</em> than a system invocation.</p></li>
<li><p><em>Serialization</em> allows creating persistent representations of complex objects.</p></li>
<li><p>Functions that heavily interact with their environment and/or access external resources are difficult to carve.</p></li>
<li><p>From carved calls, one can produce API grammars that arbitrarily combine carved arguments.</p></li>
</ul>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">#</a></h2>
<p>In the next chapter, we will discuss <a class="reference internal" href="Reducer.html"><span class="std std-doc">how to reduce failure-inducing inputs</span></a>.</p>
</section>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h2>
<p>Carving was invented by Elbaum et al. \cite{Elbaum2006} and originally implemented for Java.  In this chapter, we follow several of their design choices (including recording and serializing method arguments only).</p>
<p>The combination of carving and fuzzing at the API level is described in \cite{Kampmann2018}.</p>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<section id="exercise-1-carving-for-regression-testing">
<h3>Exercise 1: Carving for Regression Testing<a class="headerlink" href="#exercise-1-carving-for-regression-testing" title="Link to this heading">#</a></h3>
<p>So far, during carving, we only have looked into reproducing <em>calls</em>, but not into actually checking the <em>results</em> of these calls.  This is important for <em>regression testing</em> – i.e. checking whether a change to code does not impede existing functionality.  We can build this by recording not only <em>calls</em>, but also <em>return values</em> – and then later compare whether the same calls result in the same values.  This may not work on all occasions; values that depend on time, randomness, or other external factors may be different.  Still, for functionality that abstracts from these details, checking that nothing has changed is an important part of testing.</p>
<p>Our aim is to design a class <code class="docutils literal notranslate"><span class="pre">ResultCarver</span></code> that extends <code class="docutils literal notranslate"><span class="pre">CallCarver</span></code> by recording both calls and return values.</p>
<p>In a first step, create a <code class="docutils literal notranslate"><span class="pre">traceit()</span></code> method that also tracks return values by extending the <code class="docutils literal notranslate"><span class="pre">traceit()</span></code> method.  The <code class="docutils literal notranslate"><span class="pre">traceit()</span></code> event type is <code class="docutils literal notranslate"><span class="pre">&quot;return&quot;</span></code> and the <code class="docutils literal notranslate"><span class="pre">arg</span></code> parameter is the returned value.  Here is a prototype that only prints out the returned values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ResultCarver</span><span class="p">(</span><span class="n">CallCarver</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">traceit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s2">&quot;return&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Result:&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">traceit</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="c1"># Need to return traceit function such that it is invoked for return</span>
        <span class="c1"># events</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">traceit</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ResultCarver</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">result_carver</span><span class="p">:</span>
    <span class="n">my_sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>my_sqrt(x=2)
Result: 1.414213562373095
__exit__(tb=None, exc_value=None, exc_type=None, self=&lt;__main__.ResultCarver object at 0x1653ccf10&gt;)
</pre></div>
</div>
</div>
</div>
<section id="part-1-store-function-results">
<h4>Part 1: Store function results<a class="headerlink" href="#part-1-store-function-results" title="Link to this heading">#</a></h4>
<p>Extend the above code such that results are <em>stored</em> in a way that associates them with the currently returning function (or method).  To this end, you need to keep track of the <em>current stack of called functions</em>.</p>
<p><strong>Solution.</strong> Here’s a solution, building on the above:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ResultCarver</span><span class="p">(</span><span class="n">CallCarver</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_call_stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">simple_call_string</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">traceit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s2">&quot;call&quot;</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span>
            <span class="n">function_name</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">co_name</span>
            <span class="n">qualified_name</span> <span class="o">=</span> <span class="n">get_qualified_name</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_call_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">qualified_name</span><span class="p">,</span> <span class="n">get_arguments</span><span class="p">(</span><span class="n">frame</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s2">&quot;return&quot;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">arg</span>
            <span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">qualified_name</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_result</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">function_name</span> <span class="o">!=</span> <span class="n">qualified_name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_result</span><span class="p">(</span><span class="n">qualified_name</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="n">simple_call_string</span><span class="p">(</span>
                        <span class="n">function_name</span><span class="p">,</span>
                        <span class="n">arguments</span><span class="p">),</span>
                    <span class="s2">&quot;=&quot;</span><span class="p">,</span>
                    <span class="n">result</span><span class="p">)</span>

        <span class="c1"># Keep on processing current calls</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">traceit</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>

        <span class="c1"># Need to return traceit function such that it is invoked for return</span>
        <span class="c1"># events</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">traceit</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ResultCarver</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">result_carver</span><span class="p">:</span>
    <span class="n">my_sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">result_carver</span><span class="o">.</span><span class="n">_results</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>my_sqrt(x=2)
my_sqrt(x=2) = 1.414213562373095
__exit__(tb=None, exc_value=None, exc_type=None, self=&lt;__main__.ResultCarver object at 0x1653ccf70&gt;)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;my_sqrt(x=2)&#39;: 1.414213562373095,
 &#39;Intro_Testing.my_sqrt(x=2)&#39;: 1.414213562373095}
</pre></div>
</div>
</div>
</div>
</section>
<section id="part-2-access-results">
<h4>Part 2: Access results<a class="headerlink" href="#part-2-access-results" title="Link to this heading">#</a></h4>
<p>Give it a method <code class="docutils literal notranslate"><span class="pre">result()</span></code> that returns the value recorded for that particular function name and result:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ResultCarver</span><span class="p">(</span><span class="n">CallCarver</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">argument</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the result recorded for function_name(argument&quot;&quot;&quot;</span>
</pre></div>
</div>
<p><strong>Solution.</strong> This is mostly done in the code for part 1:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ResultCarver</span><span class="p">(</span><span class="n">ResultCarver</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">argument</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">simple_call_string</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="part-3-produce-assertions">
<h4>Part 3: Produce assertions<a class="headerlink" href="#part-3-produce-assertions" title="Link to this heading">#</a></h4>
<p>For the functions called during <code class="docutils literal notranslate"><span class="pre">webbrowser()</span></code> execution, create a set of <em>assertions</em> that check whether the result returned is still the same.  Test this for <code class="docutils literal notranslate"><span class="pre">urllib.parse.urlparse()</span></code>.</p>
<p><strong>Solution.</strong> Not too hard now:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="kn">import</span> <span class="nn">sys</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>  <span class="c1"># Requires Python 3.11 or later</span>
    <span class="k">with</span> <span class="n">ResultCarver</span><span class="p">()</span> <span class="k">as</span> <span class="n">webbrowser_result_carver</span><span class="p">:</span>
        <span class="n">webbrowser</span><span class="p">(</span><span class="s2">&quot;https://www.cispa.de&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">function_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;urllib.parse.urlparse&quot;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">arguments</span> <span class="ow">in</span> <span class="n">webbrowser_result_carver</span><span class="o">.</span><span class="n">arguments</span><span class="p">(</span><span class="n">function_name</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">call</span> <span class="o">=</span> <span class="n">call_string</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">webbrowser_result_carver</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;assert&quot;</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="s2">&quot;==&quot;</span><span class="p">,</span> <span class="n">call_value</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">continue</span>
</pre></div>
</div>
</div>
</div>
<p>We can run these assertions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">SplitResult</span><span class="p">,</span> <span class="n">ParseResult</span><span class="p">,</span> <span class="n">urlparse</span><span class="p">,</span> <span class="n">urlsplit</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">urlparse</span><span class="p">(</span>
        <span class="n">url</span><span class="o">=</span><span class="s1">&#39;http://www.cispa.de&#39;</span><span class="p">,</span>
        <span class="n">scheme</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">allow_fragments</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">==</span> <span class="n">ParseResult</span><span class="p">(</span>
            <span class="n">scheme</span><span class="o">=</span><span class="s1">&#39;http&#39;</span><span class="p">,</span>
            <span class="n">netloc</span><span class="o">=</span><span class="s1">&#39;www.cispa.de&#39;</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">query</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">fragment</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">urlsplit</span><span class="p">(</span>
        <span class="n">url</span><span class="o">=</span><span class="s1">&#39;http://www.cispa.de&#39;</span><span class="p">,</span>
        <span class="n">scheme</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">allow_fragments</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">==</span> <span class="n">SplitResult</span><span class="p">(</span>
            <span class="n">scheme</span><span class="o">=</span><span class="s1">&#39;http&#39;</span><span class="p">,</span>
            <span class="n">netloc</span><span class="o">=</span><span class="s1">&#39;www.cispa.de&#39;</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">query</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">fragment</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can now add these carved tests to a <em>regression test suite</em> which would be run after every change to ensure that the functionality of <code class="docutils literal notranslate"><span class="pre">urlparse()</span></code> and <code class="docutils literal notranslate"><span class="pre">urlsplit()</span></code> is not changed.</p>
</section>
</section>
<section id="exercise-2-abstracting-arguments">
<h3>Exercise 2: Abstracting Arguments<a class="headerlink" href="#exercise-2-abstracting-arguments" title="Link to this heading">#</a></h3>
<p>When mining an API grammar from executions, set up an abstraction scheme to widen the range of arguments to be used during testing.  If the values for an argument, all conform to some type <code class="docutils literal notranslate"><span class="pre">T</span></code>. abstract it into <code class="docutils literal notranslate"><span class="pre">&lt;T&gt;</span></code>.  For instance, if calls to <code class="docutils literal notranslate"><span class="pre">foo(1)</span></code>, <code class="docutils literal notranslate"><span class="pre">foo(2)</span></code>, <code class="docutils literal notranslate"><span class="pre">foo(3)</span></code> have been seen, the grammar should abstract its calls into <code class="docutils literal notranslate"><span class="pre">foo(&lt;int&gt;)</span></code>, with <code class="docutils literal notranslate"><span class="pre">&lt;int&gt;</span></code> being appropriately defined.</p>
<p>Do this for a number of common types: integers, positive numbers, floating-point numbers, host names, URLs, mail addresses, and more.</p>
<p><strong>Solution.</strong> Left to the reader.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="APIFuzzer.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Fuzzing APIs</p>
      </div>
    </a>
    <a class="right-next"
       href="PythonFuzzer.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Testing Compilers</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#recording-calls">Recording Calls</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#synthesizing-calls">Synthesizing Calls</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#system-tests-vs-unit-tests">System Tests vs Unit Tests</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Carving Unit Tests</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Recording Calls</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#recording-my-sqrt">Recording my_sqrt()</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#carving-urlparse">Carving urlparse()</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#replaying-calls">Replaying Calls</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#serializing-objects">Serializing Objects</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#all-calls">All Calls</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mining-api-grammars-from-carved-calls">Mining API Grammars from Carved Calls</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-calls-to-grammars">From Calls to Grammars</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-grammar-miner-for-calls">A Grammar Miner for Calls</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#initial-grammar">Initial Grammar</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#a-grammar-from-arguments">A Grammar from Arguments</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#a-grammar-from-calls">A Grammar from Calls</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#a-grammar-from-all-calls">A Grammar from all Calls</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fuzzing-web-functions">Fuzzing Web Functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Synopsis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Recording Calls</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Synthesizing Calls</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-carving-for-regression-testing">Exercise 1: Carving for Regression Testing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-store-function-results">Part 1: Store function results</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-access-results">Part 2: Access results</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3-produce-assertions">Part 3: Produce assertions</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-abstracting-arguments">Exercise 2: Abstracting Arguments</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Andreas Zeller, Rahul Gopinath, Marcel Böhme, Gordon Fraser, and Christian Holler
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2021-2025 CISPA Helmholtz Center for Information Security (www.cispa.de); © Copyright 2018-2020 Saarland University, authors, and contributors. All Rights Reserved.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>