
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Testing Configurations &#8212; The Fuzzing Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=42e1b1a5" />
    <link rel="stylesheet" type="text/css" href="_static/mastodon-timeline.css?v=f82c2b23" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'ConfigurationFuzzer';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Fuzzing APIs" href="APIFuzzer.html" />
    <link rel="prev" title="Mining Function Specifications" href="DynamicInvariants.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content"><p>This is a beta version of fuzzingbook.org, currently in development. See the <a href="https://fuzzingbook.org/"  style="color:white!important;">classic site</a> for resources.</p></div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/fuzzingbook.png" class="logo__image only-light" alt="The Fuzzing Book - Home"/>
    <script>document.write(`<img src="_static/fuzzingbook.png" class="logo__image only-dark" alt="The Fuzzing Book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    The Fuzzing Book
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tours.html">Tours through the Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="Intro_Testing.html">Introduction to Software Testing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Lexical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Fuzzer.html">Fuzzing: Breaking Things with Random Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Coverage.html">Code Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="MutationFuzzer.html">Mutation-Based Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GreyboxFuzzer.html">Greybox Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="SearchBasedFuzzer.html">Search-Based Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="MutationAnalysis.html">Mutation Analysis</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Syntactical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Grammars.html">Fuzzing with Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarFuzzer.html">Efficient Grammar Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarCoverageFuzzer.html">Grammar Coverage</a></li>
<li class="toctree-l1"><a class="reference internal" href="Parser.html">Parsing Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="ProbabilisticGrammarFuzzer.html">Probabilistic Grammar Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="GeneratorGrammarFuzzer.html">Fuzzing with Generators</a></li>

<li class="toctree-l1"><a class="reference internal" href="GreyboxGrammarFuzzer.html">Greybox Fuzzing with Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="Reducer.html">Reducing Failure-Inducing Inputs</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Semantical Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="FuzzingWithConstraints.html">Fuzzing with Constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="GrammarMiner.html">Mining Input Grammars</a></li>
<li class="toctree-l1"><a class="reference internal" href="InformationFlow.html">Tracking Information Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="ConcolicFuzzer.html">Concolic Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="SymbolicFuzzer.html">Symbolic Fuzzing</a></li>
<li class="toctree-l1"><a class="reference internal" href="DynamicInvariants.html">Mining Function Specifications</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Domain-Specific Fuzzing</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Testing Configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="APIFuzzer.html">Fuzzing APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Carver.html">Carving Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="PythonFuzzer.html">Testing Compilers</a></li>
<li class="toctree-l1"><a class="reference internal" href="WebFuzzer.html">Testing Web Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="GUIFuzzer.html">Testing Graphical User Interfaces</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Managing Fuzzing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="FuzzingInTheLarge.html">Fuzzing in the Large</a></li>
<li class="toctree-l1"><a class="reference internal" href="WhenToStopFuzzing.html">When To Stop Fuzzing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="AcademicPrototyping.html">Academic Prototyping</a></li>
<li class="toctree-l1"><a class="reference internal" href="PrototypingWithPython.html">Prototyping with Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="ExpectError.html">Error Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timer.html">Timer</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timeout.html">Timeout</a></li>
<li class="toctree-l1"><a class="reference internal" href="ClassDiagram.html">Class Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="RailroadDiagrams.html">Railroad Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="ControlFlow.html">Control Flow Graph</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About This Book</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ReleaseNotes.html">Fuzzingbook Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="Importing.html">Using Fuzzingbook Code in your own Programs</a></li>
<li class="toctree-l1"><a class="reference internal" href="Guide_for_Authors.html">Guide for Authors</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/master?urlpath=tree/docs/notebooks/ConfigurationFuzzer.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/uds-se/fuzzingbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/uds-se/fuzzingbook/issues/new?title=Issue%20on%20page%20%2FConfigurationFuzzer.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/ConfigurationFuzzer.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Testing Configurations</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration-options">Configuration Options</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#options-in-python">Options in Python</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-grammar-for-configurations">A Grammar for Configurations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mining-configuration-options">Mining Configuration Options</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tracking-arguments">Tracking Arguments</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-grammar-miner-for-options-and-arguments">A Grammar Miner for Options and Arguments</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-autopep8">Testing Autopep8</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#autopep8-setup">Autopep8 Setup</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mining-an-autopep8-grammar">Mining an Autopep8 Grammar</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-autopep8-options">Creating Autopep8 Options</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#classes-for-fuzzing-configuration-options">Classes for Fuzzing Configuration Options</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-autopep8">Example: Autopep8</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-mypy">Example: MyPy</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-notedown">Example: Notedown</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#combinatorial-testing">Combinatorial Testing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-ifdef-configuration-fuzzing">Exercise 1: #ifdef Configuration Fuzzing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-extract-preprocessor-variables">Part 1: Extract Preprocessor Variables</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-derive-an-option-grammar">Part 2: Derive an Option Grammar</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3-c-preprocessor-configuration-fuzzing">Part 3: C Preprocessor Configuration Fuzzing</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-ini-configuration-fuzzing">Exercise 2: .ini Configuration Fuzzing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-read-configuration">Part 1: Read Configuration</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-create-a-configuration-grammar">Part 2: Create a Configuration Grammar</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3-mine-a-configuration-grammar">Part 3: Mine a Configuration Grammar</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-extracting-and-fuzzing-c-command-line-options">Exercise 3: Extracting and Fuzzing C Command-Line Options</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-getopt-fuzzing">Part 1: Getopt Fuzzing</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-fuzzing-long-options-in-c">Part 2: Fuzzing Long Options in C</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-4-expansions-in-context">Exercise 4: Expansions in Context</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="testing-configurations">
<h1>Testing Configurations<a class="headerlink" href="#testing-configurations" title="Link to this heading">#</a></h1>
<p>The behavior of a program is not only governed by its data.  The <em>configuration</em> of a program – that is, the settings that govern the execution of a program on its (regular) input data, as set by options or configuration files – just as well influences behavior, and thus can and should be tested.  In this chapter, we explore how to systematically <em>test</em> and <em>cover</em> software configurations.  By <em>automatically inferring configuration options</em>, we can apply these techniques out of the box, with no need for writing a grammar.  Finally, we show how to systematically cover <em>combinations</em> of configuration options, quickly detecting unwanted interferences.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bookutils</span> <span class="kn">import</span> <span class="n">YouTubeVideo</span>
<span class="n">YouTubeVideo</span><span class="p">(</span><span class="s1">&#39;L0ztoXVru2U&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="640"
            height="360"
            src="https://www.youtube-nocookie.com/embed/L0ztoXVru2U"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<p><strong>Prerequisites</strong></p>
<ul class="simple">
<li><p>You should have read the <a class="reference internal" href="Grammars.html"><span class="std std-doc">chapter on grammars</span></a>.</p></li>
<li><p>You should have read the <a class="reference internal" href="GrammarCoverageFuzzer.html"><span class="std std-doc">chapter on grammar coverage</span></a>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bookutils.setup</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Type</span>
</pre></div>
</div>
</div>
</div>
<section id="synopsis">
<h2>Synopsis<a class="headerlink" href="#synopsis" title="Link to this heading">#</a></h2>
<!-- Automatically generated. Do not edit. -->
<p>To <a class="reference internal" href="Importing.html"><span class="std std-doc">use the code provided in this chapter</span></a>, write</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">fuzzingbook.ConfigurationFuzzer</span> <span class="kn">import</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>and then make use of the following features.</p>
<p>This chapter provides two classes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">OptionRunner</span></code> automatically extract command-line options from a Python program;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">OptionFuzzer</span></code> uses these to automatically test a Python program with a large variety of options.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">OptionRunner</span></code> runs a program up to the point where it parses its arguments, and then extracts a grammar that describes its invocations:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">autopep8_runner</span> <span class="o">=</span> <span class="n">OptionRunner</span><span class="p">(</span><span class="s2">&quot;autopep8&quot;</span><span class="p">,</span> <span class="s2">&quot;foo.py&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The grammar can be extracted via the method <code class="docutils literal notranslate"><span class="pre">ebnf_grammar()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">option_ebnf_grammar</span> <span class="o">=</span> <span class="n">autopep8_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">option_ebnf_grammar</span>
<span class="go">{&#39;&lt;start&gt;&#39;: [&#39;(&lt;option&gt;)*&lt;arguments&gt;&#39;],</span>
<span class="go"> &#39;&lt;option&gt;&#39;: [&#39; -h&#39;,</span>
<span class="go">  &#39; --help&#39;,</span>
<span class="go">  &#39; --version&#39;,</span>
<span class="go">  &#39; -v&#39;,</span>
<span class="go">  &#39; --verbose&#39;,</span>
<span class="go">  &#39; -d&#39;,</span>
<span class="go">  &#39; --diff&#39;,</span>
<span class="go">  &#39; -i&#39;,</span>
<span class="go">  &#39; --in-place&#39;,</span>
<span class="go">  &#39; --global-config &lt;filename&gt;&#39;,</span>
<span class="go">  &#39; --ignore-local-config&#39;,</span>
<span class="go">  &#39; -r&#39;,</span>
<span class="go">  &#39; --recursive&#39;,</span>
<span class="go">  &#39; -j &lt;n&gt;&#39;,</span>
<span class="go">  &#39; --jobs &lt;n&gt;&#39;,</span>
<span class="go">  &#39; -p &lt;n&gt;&#39;,</span>
<span class="go">  &#39; --pep8-passes &lt;n&gt;&#39;,</span>
<span class="go">  &#39; -a&#39;,</span>
<span class="go">  &#39; --aggressive&#39;,</span>
<span class="go">  &#39; --experimental&#39;,</span>
<span class="go">  &#39; --exclude &lt;globs&gt;&#39;,</span>
<span class="go">  &#39; --list-fixes&#39;,</span>
<span class="go">  &#39; --ignore &lt;errors&gt;&#39;,</span>
<span class="go">  &#39; --select &lt;errors&gt;&#39;,</span>
<span class="go">  &#39; --max-line-length &lt;n&gt;&#39;,</span>
<span class="go">  &#39; --line-range &lt;line&gt; &lt;line&gt;&#39;,</span>
<span class="go">  &#39; --range &lt;line&gt; &lt;line&gt;&#39;,</span>
<span class="go">  &#39; --indent-size &lt;int&gt;&#39;,</span>
<span class="go">  &#39; --hang-closing&#39;,</span>
<span class="go">  &#39; --exit-code&#39;],</span>
<span class="go"> &#39;&lt;arguments&gt;&#39;: [&#39; foo.py&#39;],</span>
<span class="go"> &#39;&lt;str&gt;&#39;: [&#39;&lt;char&gt;+&#39;],</span>
<span class="go"> &#39;&lt;char&gt;&#39;: [&#39;0&#39;,</span>
<span class="go">  &#39;1&#39;,</span>
<span class="go">  &#39;2&#39;,</span>
<span class="go">  &#39;3&#39;,</span>
<span class="go">  &#39;4&#39;,</span>
<span class="go">  &#39;5&#39;,</span>
<span class="go">  &#39;6&#39;,</span>
<span class="go">  &#39;7&#39;,</span>
<span class="go">  &#39;8&#39;,</span>
<span class="go">  &#39;9&#39;,</span>
<span class="go">  &#39;a&#39;,</span>
<span class="go">  &#39;b&#39;,</span>
<span class="go">  &#39;c&#39;,</span>
<span class="go">  &#39;d&#39;,</span>
<span class="go">  &#39;e&#39;,</span>
<span class="go">  &#39;f&#39;,</span>
<span class="go">  &#39;g&#39;,</span>
<span class="go">  &#39;h&#39;,</span>
<span class="go">  &#39;i&#39;,</span>
<span class="go">  &#39;j&#39;,</span>
<span class="go">  &#39;k&#39;,</span>
<span class="go">  &#39;l&#39;,</span>
<span class="go">  &#39;m&#39;,</span>
<span class="go">  &#39;n&#39;,</span>
<span class="go">  &#39;o&#39;,</span>
<span class="go">  &#39;p&#39;,</span>
<span class="go">  &#39;q&#39;,</span>
<span class="go">  &#39;r&#39;,</span>
<span class="go">  &#39;s&#39;,</span>
<span class="go">  &#39;t&#39;,</span>
<span class="go">  &#39;u&#39;,</span>
<span class="go">  &#39;v&#39;,</span>
<span class="go">  &#39;w&#39;,</span>
<span class="go">  &#39;x&#39;,</span>
<span class="go">  &#39;y&#39;,</span>
<span class="go">  &#39;z&#39;,</span>
<span class="go">  &#39;A&#39;,</span>
<span class="go">  &#39;B&#39;,</span>
<span class="go">  &#39;C&#39;,</span>
<span class="go">  &#39;D&#39;,</span>
<span class="go">  &#39;E&#39;,</span>
<span class="go">  &#39;F&#39;,</span>
<span class="go">  &#39;G&#39;,</span>
<span class="go">  &#39;H&#39;,</span>
<span class="go">  &#39;I&#39;,</span>
<span class="go">  &#39;J&#39;,</span>
<span class="go">  &#39;K&#39;,</span>
<span class="go">  &#39;L&#39;,</span>
<span class="go">  &#39;M&#39;,</span>
<span class="go">  &#39;N&#39;,</span>
<span class="go">  &#39;O&#39;,</span>
<span class="go">  &#39;P&#39;,</span>
<span class="go">  &#39;Q&#39;,</span>
<span class="go">  &#39;R&#39;,</span>
<span class="go">  &#39;S&#39;,</span>
<span class="go">  &#39;T&#39;,</span>
<span class="go">  &#39;U&#39;,</span>
<span class="go">  &#39;V&#39;,</span>
<span class="go">  &#39;W&#39;,</span>
<span class="go">  &#39;X&#39;,</span>
<span class="go">  &#39;Y&#39;,</span>
<span class="go">  &#39;Z&#39;,</span>
<span class="go">  &#39;!&#39;,</span>
<span class="go">  &#39;&quot;&#39;,</span>
<span class="go">  &#39;#&#39;,</span>
<span class="go">  &#39;$&#39;,</span>
<span class="go">  &#39;%&#39;,</span>
<span class="go">  &#39;&amp;&#39;,</span>
<span class="go">  &quot;&#39;&quot;,</span>
<span class="go">  &#39;(&#39;,</span>
<span class="go">  &#39;)&#39;,</span>
<span class="go">  &#39;*&#39;,</span>
<span class="go">  &#39;+&#39;,</span>
<span class="go">  &#39;,&#39;,</span>
<span class="go">  &#39;-&#39;,</span>
<span class="go">  &#39;.&#39;,</span>
<span class="go">  &#39;/&#39;,</span>
<span class="go">  &#39;:&#39;,</span>
<span class="go">  &#39;;&#39;,</span>
<span class="go">  &#39;&lt;&#39;,</span>
<span class="go">  &#39;=&#39;,</span>
<span class="go">  &#39;&gt;&#39;,</span>
<span class="go">  &#39;?&#39;,</span>
<span class="go">  &#39;@&#39;,</span>
<span class="go">  &#39;[&#39;,</span>
<span class="go">  &#39;\\&#39;,</span>
<span class="go">  &#39;]&#39;,</span>
<span class="go">  &#39;^&#39;,</span>
<span class="go">  &#39;_&#39;,</span>
<span class="go">  &#39;`&#39;,</span>
<span class="go">  &#39;{&#39;,</span>
<span class="go">  &#39;|&#39;,</span>
<span class="go">  &#39;}&#39;,</span>
<span class="go">  &#39;~&#39;],</span>
<span class="go"> &#39;&lt;filename&gt;&#39;: [&#39;&lt;str&gt;&#39;],</span>
<span class="go"> &#39;&lt;int&gt;&#39;: [&#39;(-)?&lt;digit&gt;+&#39;],</span>
<span class="go"> &#39;&lt;digit&gt;&#39;: [&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;],</span>
<span class="go"> &#39;&lt;n&gt;&#39;: [&#39;&lt;int&gt;&#39;],</span>
<span class="go"> &#39;&lt;globs&gt;&#39;: [&#39;&lt;str&gt;&#39;],</span>
<span class="go"> &#39;&lt;errors&gt;&#39;: [&#39;&lt;str&gt;&#39;],</span>
<span class="go"> &#39;&lt;line&gt;&#39;: [&#39;&lt;int&gt;&#39;]}</span>
</pre></div>
</div>
<p>The grammar can be immediately used for fuzzing. A <code class="docutils literal notranslate"><span class="pre">GrammarCoverageFuzzer</span></code> will ensure all options are covered:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">Grammars</span> <span class="kn">import</span> <span class="n">convert_ebnf_grammar</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fuzzer</span> <span class="o">=</span> <span class="n">GrammarCoverageFuzzer</span><span class="p">(</span><span class="n">convert_ebnf_grammar</span><span class="p">(</span><span class="n">option_ebnf_grammar</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
<span class="go">[&#39; --max-line-length -64 foo.py&#39;,</span>
<span class="go"> &quot; -a --version --select u --diff --list-fixes -r --range -50 3 --ignore iq --hang-closing --ignore-local-config --aggressive --in-place --indent-size 9 -d --global-config wQ --help --line-range -8226 7 -j 1 -p 2 -h --experimental -i -v --jobs -81 --exclude c --exit-code --verbose --recursive --exclude j --pep8-passes 587 --global-config 5ty --global-config W]96{&lt; --ignore M --exclude . --select &gt; --global-config T --ignore z&#39;C --select %EIL -r -a -v foo.py&quot;,</span>
<span class="go"> &#39; --exclude VKSl --exclude 3[ --global-config ^0x --ignore 4 --exclude _ --global-config 7 --select mh --global-config e --global-config R --global-config JH\\ --exclude OP --ignore = --global-config @ --select ?N --global-config s --select *}v --ignore - --select Do,GA --exclude bkn --ignore U --exclude | --global-config 2 --exclude 8 --select &quot; --exclude pZ --select / --exclude f(aYdg) --select : --global-config ~ --global-config ! --global-config 1B`$X --exclude ; --select F --select &amp; --ignore r --exclude #+ --exit-code --aggressive --select ?/ -p -6 --version --ignore-local-config -r -v foo.py&#39;]</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">OptionFuzzer</span></code> class summarizes these steps.  Its constructor takes an <code class="docutils literal notranslate"><span class="pre">OptionRunner</span></code> to automatically extract the grammar; it does the necessary steps to extract the grammar and fuzz with it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">autopep8_runner</span> <span class="o">=</span> <span class="n">OptionRunner</span><span class="p">(</span><span class="s2">&quot;autopep8&quot;</span><span class="p">,</span> <span class="s2">&quot;foo.py&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">autopep8_fuzzer</span> <span class="o">=</span> <span class="n">OptionFuzzer</span><span class="p">(</span><span class="n">autopep8_runner</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">autopep8_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
<span class="go">[&#39; --version foo.py&#39;,</span>
<span class="go"> &#39; --ignore Rj --jobs -6 --line-range -04 7953 --help --aggressive -v --ignore-local-config -h --experimental -r --global-config 3 --indent-size -8 --exclude ;&amp;M&quot;! -a -p 1 --hang-closing -j 263 --verbose --recursive --in-place --list-fixes --select t@fs --range -0 7 -d --pep8-passes 7 --diff -i --exit-code --max-line-length -3 --global-config L --select u| --global-config \&#39; --global-config r --exclude Ik) --ignore D- --ignore 4 --select XS --global-config 7 --ignore ~. --ignore e9 --exclude ph --ignore U --global-config dz --global-config Q$o --exclude 6( --ignore x --select 5J:N --exclude &lt; --ignore O --global-config ,c --global-config = --exclude W\\ --global-config ? --select l --select ^ --select V --exclude P --select Z --select &gt;0 --select TH --exclude * --exclude G --select 8 --global-config bn --global-config C{a1m --exclude F --ignore _ --ignore g --ignore ]q --exclude wy --ignore % --global-config v --ignore + --global-config EK/ --ignore [#}Y --global-config `i --global-config 2 --ignore BE --global-config A --indent-size -22 --recursive --hang-closing --exclude ` --indent-size -61 --diff -a foo.py&#39;,</span>
<span class="go"> &#39; foo.py&#39;]</span>
</pre></div>
</div>
<p>The final step in testing would now to invoke the program with these arguments.</p>
<p>Note that <code class="docutils literal notranslate"><span class="pre">OptionRunner</span></code> is experimental: It assumes that the Python program in question uses the <code class="docutils literal notranslate"><span class="pre">argparse</span></code> module; and not all <code class="docutils literal notranslate"><span class="pre">argparse</span></code> features are supported.  Still, it does a pretty good job even on nontrivial programs.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">OptionRunner</span></code> constructor accepts an additional <code class="docutils literal notranslate"><span class="pre">miner</span></code> keyword parameter, which takes the class of the argument grammar miner to be used. By default, this is <code class="docutils literal notranslate"><span class="pre">OptionGrammarMiner</span></code> – a helper class that can be used (and extended) to create own option grammar miners.</p>
<p><img alt="" src="_images/ConfigurationFuzzer-synopsis-1.svg" /></p>
</section>
<section id="configuration-options">
<h2>Configuration Options<a class="headerlink" href="#configuration-options" title="Link to this heading">#</a></h2>
<p>When we talk about the input to a program, we usually think of the <em>data</em> it processes. This is also what we have been fuzzing in the past chapters – be it with <a class="reference internal" href="Fuzzer.html"><span class="std std-doc">random input</span></a>, <a class="reference internal" href="MutationFuzzer.html"><span class="std std-doc">mutation-based fuzzing</span></a>, or <a class="reference internal" href="GrammarFuzzer.html"><span class="std std-doc">grammar-based fuzzing</span></a>.  However, programs typically have several input sources, all of which can and should be tested – and included in test generation.</p>
<p>One important source of input is the program’s <em>configuration</em> – that is, a set of inputs that typically is set once when beginning to process data and then stays constant while processing data, while the program is running, or even while the program is deployed.  Such a configuration is frequently set in <em>configuration files</em> (for instance, as key/value pairs); the most ubiquitous method for command-line tools, though, are <em>configuration options</em> on the command line.</p>
<p>As an example, consider the <code class="docutils literal notranslate"><span class="pre">grep</span></code> utility to find textual patterns in files.  The exact mode by which <code class="docutils literal notranslate"><span class="pre">grep</span></code> works is governed by a multitude of options, which can be listed by providing a <code class="docutils literal notranslate"><span class="pre">--help</span></code> option:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>grep<span class="w"> </span>--help
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>usage: grep [-abcdDEFGHhIiJLlMmnOopqRSsUVvwXxZz] [-A num] [-B num] [-C[num]]
	[-e pattern] [-f file] [--binary-files=value] [--color=when]
	[--context[=num]] [--directories=action] [--label] [--line-buffered]
	[--null] [pattern] [file ...]
</pre></div>
</div>
</div>
</div>
<p>All these options need to be tested for whether they operate correctly.  In security testing, any such option may also trigger a yet unknown vulnerability.  Hence, such options can become <em>fuzz targets</em> on their own.  In this chapter, we analyze how to systematically test such options – and better yet, how to extract possible configurations right out of given program files, such that we do not have to specify anything.</p>
</section>
<section id="options-in-python">
<h2>Options in Python<a class="headerlink" href="#options-in-python" title="Link to this heading">#</a></h2>
<p>Let us stick to our common programming language here and examine how options are processed in Python.  The <code class="docutils literal notranslate"><span class="pre">argparse</span></code> module provides a parser for command-line arguments (and options) with great functionality – and great complexity.  You start by defining a parser (<code class="docutils literal notranslate"><span class="pre">argparse.ArgumentParser()</span></code>) to which individual arguments with various features are added, one after another.  Additional parameters for each argument can specify the type (<code class="docutils literal notranslate"><span class="pre">type</span></code>) of the argument (say, integers or strings), or the number of arguments (<code class="docutils literal notranslate"><span class="pre">nargs</span></code>).</p>
<p>By default, arguments are stored under their name in the <code class="docutils literal notranslate"><span class="pre">args</span></code> object coming from <code class="docutils literal notranslate"><span class="pre">parse_args()</span></code> – thus, <code class="docutils literal notranslate"><span class="pre">args.integers</span></code> holds the <code class="docutils literal notranslate"><span class="pre">integer</span></code> arguments added earlier.  Special actions (<code class="docutils literal notranslate"><span class="pre">actions</span></code>) allow storing specific values in given variables; the <code class="docutils literal notranslate"><span class="pre">store_const</span></code> action stores the given <code class="docutils literal notranslate"><span class="pre">const</span></code> in the attribute named by <code class="docutils literal notranslate"><span class="pre">dest</span></code>.  The following example takes a number of integer arguments (<code class="docutils literal notranslate"><span class="pre">integers</span></code>) as well as an operator (<code class="docutils literal notranslate"><span class="pre">--sum</span></code>, <code class="docutils literal notranslate"><span class="pre">--min</span></code>, or <code class="docutils literal notranslate"><span class="pre">--max</span></code>) to be applied on these integers.  The operators all store a function reference in the <code class="docutils literal notranslate"><span class="pre">accumulate</span></code> attribute, which is finally invoked on the integers parsed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">argparse</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_numbers</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">[]):</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;Process some integers.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;integers&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;an integer for the accumulator&#39;</span><span class="p">)</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--sum&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;accumulate&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_const&#39;</span><span class="p">,</span>
                       <span class="n">const</span><span class="o">=</span><span class="nb">sum</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;sum the integers&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--min&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;accumulate&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_const&#39;</span><span class="p">,</span>
                       <span class="n">const</span><span class="o">=</span><span class="nb">min</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;compute the minimum&#39;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--max&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;accumulate&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_const&#39;</span><span class="p">,</span>
                       <span class="n">const</span><span class="o">=</span><span class="nb">max</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;compute the maximum&#39;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">integers</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s how <code class="docutils literal notranslate"><span class="pre">process_numbers()</span></code> works.  We can, for instance, invoke the <code class="docutils literal notranslate"><span class="pre">--min</span></code> option on the given arguments to compute the minimum:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">process_numbers</span><span class="p">([</span><span class="s2">&quot;--min&quot;</span><span class="p">,</span> <span class="s2">&quot;100&quot;</span><span class="p">,</span> <span class="s2">&quot;200&quot;</span><span class="p">,</span> <span class="s2">&quot;300&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100
</pre></div>
</div>
</div>
</div>
<p>Or compute the sum of three numbers:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">process_numbers</span><span class="p">([</span><span class="s2">&quot;--sum&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6
</pre></div>
</div>
</div>
</div>
<p>When defined via <code class="docutils literal notranslate"><span class="pre">add_mutually_exclusive_group()</span></code> (as above), options are mutually exclusive.  Consequently, we can have only one operator:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bookutils.setup</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ExpectError</span> <span class="kn">import</span> <span class="n">ExpectError</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ExpectError</span><span class="p">(</span><span class="ne">SystemExit</span><span class="p">,</span> <span class="n">print_traceback</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">process_numbers</span><span class="p">([</span><span class="s2">&quot;--sum&quot;</span><span class="p">,</span> <span class="s2">&quot;--max&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>usage: ipykernel_launcher.py [-h] (--sum | --min | --max) N [N ...]
ipykernel_launcher.py: error: argument --max: not allowed with argument --sum
SystemExit: 2 (expected)
</pre></div>
</div>
</div>
</div>
</section>
<section id="a-grammar-for-configurations">
<h2>A Grammar for Configurations<a class="headerlink" href="#a-grammar-for-configurations" title="Link to this heading">#</a></h2>
<p>How can we test a system with several options?  The easiest answer is to write a grammar for it.  The grammar <code class="docutils literal notranslate"><span class="pre">PROCESS_NUMBERS_EBNF_GRAMMAR</span></code> reflects the possible combinations of options and arguments:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Grammars</span> <span class="kn">import</span> <span class="n">crange</span><span class="p">,</span> <span class="n">srange</span><span class="p">,</span> <span class="n">convert_ebnf_grammar</span><span class="p">,</span> <span class="n">extend_grammar</span><span class="p">,</span> <span class="n">is_valid_grammar</span>
<span class="kn">from</span> <span class="nn">Grammars</span> <span class="kn">import</span> <span class="n">START_SYMBOL</span><span class="p">,</span> <span class="n">new_symbol</span><span class="p">,</span> <span class="n">Grammar</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PROCESS_NUMBERS_EBNF_GRAMMAR</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;operator&gt; &lt;integers&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;operator&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;--sum&quot;</span><span class="p">,</span> <span class="s2">&quot;--min&quot;</span><span class="p">,</span> <span class="s2">&quot;--max&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;integers&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;integer&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;integers&gt; &lt;integer&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;integer&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;digit&gt;+&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">:</span> <span class="n">crange</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">PROCESS_NUMBERS_EBNF_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PROCESS_NUMBERS_GRAMMAR</span> <span class="o">=</span> <span class="n">convert_ebnf_grammar</span><span class="p">(</span><span class="n">PROCESS_NUMBERS_EBNF_GRAMMAR</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can feed this grammar into our <a class="reference internal" href="GrammarCoverageFuzzer.html"><span class="std std-doc">grammar coverage fuzzer</span></a> and have it cover one option after another:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">GrammarCoverageFuzzer</span> <span class="kn">import</span> <span class="n">GrammarCoverageFuzzer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarCoverageFuzzer</span><span class="p">(</span><span class="n">PROCESS_NUMBERS_GRAMMAR</span><span class="p">,</span> <span class="n">min_nonterminals</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--max 9 5 8 210 80 9756431
--sum 9 4 99 1245 612370
--min 2 3 0 46 15798 7570926
</pre></div>
</div>
</div>
</div>
<p>Of course, we can also invoke <code class="docutils literal notranslate"><span class="pre">process_numbers()</span></code> with these very arguments. To this end, we need to convert the string produced by the grammar back into a list of individual arguments, using <code class="docutils literal notranslate"><span class="pre">split()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarCoverageFuzzer</span><span class="p">(</span><span class="n">PROCESS_NUMBERS_GRAMMAR</span><span class="p">,</span> <span class="n">min_nonterminals</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">process_numbers</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;--max&#39;, &#39;8&#39;, &#39;9&#39;, &#39;3067&#39;, &#39;44&#39;, &#39;13852967057&#39;]
13852967057
[&#39;--sum&#39;, &#39;9&#39;, &#39;8&#39;, &#39;63&#39;, &#39;9278111&#39;, &#39;59206197798&#39;]
59215475989
[&#39;--min&#39;, &#39;4&#39;, &#39;1&#39;, &#39;4864&#39;, &#39;33342&#39;, &#39;7827970808951&#39;]
1
</pre></div>
</div>
</div>
</div>
<p>Similarly, we can define grammars for any program to be tested; as well as define grammars for, say, configuration files.  Yet, the grammar has to be updated with every change to the program, which creates a maintenance burden.  Given that the information required for the grammar is already all encoded in the program, the question arises: <em>Can’t we go and extract configuration options right out of the program in the first place?</em></p>
</section>
<section id="mining-configuration-options">
<h2>Mining Configuration Options<a class="headerlink" href="#mining-configuration-options" title="Link to this heading">#</a></h2>
<p>In this section, we try to extract option and argument information right out of a program, such that we do not have to specify a configuration grammar.  The aim is to have a configuration fuzzer that works on the options and arguments of an arbitrary program, as long as it follows specific conventions for processing its arguments.  In the case of Python programs, this means using the <code class="docutils literal notranslate"><span class="pre">argparse</span></code> module.</p>
<p>Our idea is as follows: We execute the given program up to the point where the arguments are actually parsed – that is, <code class="docutils literal notranslate"><span class="pre">argparse.parse_args()</span></code> is invoked.  Up to this point, we track all calls into the argument parser, notably those calls that define arguments and options (<code class="docutils literal notranslate"><span class="pre">add_argument()</span></code>).  From these, we construct the grammar.</p>
<section id="tracking-arguments">
<h3>Tracking Arguments<a class="headerlink" href="#tracking-arguments" title="Link to this heading">#</a></h3>
<p>Let us illustrate this approach with a simple experiment: We define a trace function (see <a class="reference internal" href="Coverage.html"><span class="std std-doc">our chapter on coverage</span></a> for details) that is active while <code class="docutils literal notranslate"><span class="pre">process_numbers</span></code> is invoked.  If we have a call to a method <code class="docutils literal notranslate"><span class="pre">add_argument</span></code>, we access and print out the local variables (which at this point are the arguments to the method).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">string</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">trace_locals</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">event</span> <span class="o">!=</span> <span class="s2">&quot;call&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">method_name</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
    <span class="k">if</span> <span class="n">method_name</span> <span class="o">!=</span> <span class="s2">&quot;add_argument&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="nb">locals</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">method_name</span><span class="p">,</span> <span class="nb">locals</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>What we get is a list of all calls to <code class="docutils literal notranslate"><span class="pre">add_argument()</span></code>, together with the method arguments passed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="n">trace_locals</span><span class="p">)</span>
<span class="n">process_numbers</span><span class="p">([</span><span class="s2">&quot;--sum&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">])</span>
<span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>add_argument {&#39;self&#39;: ArgumentParser(prog=&#39;ipykernel_launcher.py&#39;, usage=None, description=&#39;Process some integers.&#39;, formatter_class=&lt;class &#39;argparse.HelpFormatter&#39;&gt;, conflict_handler=&#39;error&#39;, add_help=True), &#39;args&#39;: (&#39;-h&#39;, &#39;--help&#39;), &#39;kwargs&#39;: {&#39;action&#39;: &#39;help&#39;, &#39;default&#39;: &#39;==SUPPRESS==&#39;, &#39;help&#39;: &#39;show this help message and exit&#39;}}
add_argument {&#39;self&#39;: ArgumentParser(prog=&#39;ipykernel_launcher.py&#39;, usage=None, description=&#39;Process some integers.&#39;, formatter_class=&lt;class &#39;argparse.HelpFormatter&#39;&gt;, conflict_handler=&#39;error&#39;, add_help=True), &#39;args&#39;: (&#39;integers&#39;,), &#39;kwargs&#39;: {&#39;metavar&#39;: &#39;N&#39;, &#39;type&#39;: &lt;class &#39;int&#39;&gt;, &#39;nargs&#39;: &#39;+&#39;, &#39;help&#39;: &#39;an integer for the accumulator&#39;}}
add_argument {&#39;self&#39;: &lt;argparse._MutuallyExclusiveGroup object at 0x11142f260&gt;, &#39;args&#39;: (&#39;--sum&#39;,), &#39;kwargs&#39;: {&#39;dest&#39;: &#39;accumulate&#39;, &#39;action&#39;: &#39;store_const&#39;, &#39;const&#39;: &lt;built-in function sum&gt;, &#39;help&#39;: &#39;sum the integers&#39;}}
add_argument {&#39;self&#39;: &lt;argparse._MutuallyExclusiveGroup object at 0x11142f260&gt;, &#39;args&#39;: (&#39;--min&#39;,), &#39;kwargs&#39;: {&#39;dest&#39;: &#39;accumulate&#39;, &#39;action&#39;: &#39;store_const&#39;, &#39;const&#39;: &lt;built-in function min&gt;, &#39;help&#39;: &#39;compute the minimum&#39;}}
add_argument {&#39;self&#39;: &lt;argparse._MutuallyExclusiveGroup object at 0x11142f260&gt;, &#39;args&#39;: (&#39;--max&#39;,), &#39;kwargs&#39;: {&#39;dest&#39;: &#39;accumulate&#39;, &#39;action&#39;: &#39;store_const&#39;, &#39;const&#39;: &lt;built-in function max&gt;, &#39;help&#39;: &#39;compute the maximum&#39;}}
6
</pre></div>
</div>
</div>
</div>
<p>From the <code class="docutils literal notranslate"><span class="pre">args</span></code> argument, we can access the individual options and arguments to be defined:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">trace_options</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">event</span> <span class="o">!=</span> <span class="s2">&quot;call&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">method_name</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
    <span class="k">if</span> <span class="n">method_name</span> <span class="o">!=</span> <span class="s2">&quot;add_argument&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="nb">locals</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">locals</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="n">trace_options</span><span class="p">)</span>
<span class="n">process_numbers</span><span class="p">([</span><span class="s2">&quot;--sum&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">])</span>
<span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;-h&#39;, &#39;--help&#39;)
(&#39;integers&#39;,)
(&#39;--sum&#39;,)
(&#39;--min&#39;,)
(&#39;--max&#39;,)
6
</pre></div>
</div>
</div>
</div>
<p>We see that each argument comes as a tuple with one (say, <code class="docutils literal notranslate"><span class="pre">integers</span></code> or <code class="docutils literal notranslate"><span class="pre">--sum</span></code>) or two members (<code class="docutils literal notranslate"><span class="pre">-h</span></code> and <code class="docutils literal notranslate"><span class="pre">--help</span></code>), which denote alternate forms for the same option.  Our job will be to go through the arguments of <code class="docutils literal notranslate"><span class="pre">add_arguments()</span></code> and detect not only the names of options and arguments, but also whether they accept additional parameters, as well as the type of the parameters.</p>
</section>
<section id="a-grammar-miner-for-options-and-arguments">
<h3>A Grammar Miner for Options and Arguments<a class="headerlink" href="#a-grammar-miner-for-options-and-arguments" title="Link to this heading">#</a></h3>
<p>Let us now build a class that gathers all this information to create a grammar.</p>
<p>We use the <code class="docutils literal notranslate"><span class="pre">ParseInterrupt</span></code> exception to interrupt program execution after gathering all arguments and options:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ParseInterrupt</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<p>The class <code class="docutils literal notranslate"><span class="pre">OptionGrammarMiner</span></code> takes an executable function for which the grammar of options and arguments is to be mined:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">OptionGrammarMiner</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper class for extracting option grammars&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor.</span>
<span class="sd">        `function` - a function processing arguments using argparse()</span>
<span class="sd">        `log` - output diagnostics if True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>
</pre></div>
</div>
</div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">mine_ebnf_grammar()</span></code> is where everything happens.  It creates a grammar of the form</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">start</span><span class="o">&gt;</span> <span class="p">:</span><span class="o">:=</span> <span class="o">&lt;</span><span class="n">option</span><span class="o">&gt;*</span> <span class="o">&lt;</span><span class="n">arguments</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">option</span><span class="o">&gt;</span> <span class="p">:</span><span class="o">:=</span> <span class="o">&lt;</span><span class="n">empty</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">arguments</span><span class="o">&gt;</span> <span class="p">:</span><span class="o">:=</span> <span class="o">&lt;</span><span class="n">empty</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>in which the options and arguments will be collected.  It then sets a trace function (see <a class="reference internal" href="Coverage.html"><span class="std std-doc">our chapter on coverage</span></a> for details) that is active while the previously defined <code class="docutils literal notranslate"><span class="pre">function</span></code> is invoked.  Raising <code class="docutils literal notranslate"><span class="pre">ParseInterrupt</span></code> (when <code class="docutils literal notranslate"><span class="pre">parse_args()</span></code> is invoked) ends execution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">OptionGrammarMiner</span><span class="p">(</span><span class="n">OptionGrammarMiner</span><span class="p">):</span>
    <span class="n">OPTION_SYMBOL</span> <span class="o">=</span> <span class="s2">&quot;&lt;option&gt;&quot;</span>
    <span class="n">ARGUMENTS_SYMBOL</span> <span class="o">=</span> <span class="s2">&quot;&lt;arguments&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">mine_ebnf_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract EBNF option grammar&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">START_SYMBOL</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">OPTION_SYMBOL</span> <span class="o">+</span> <span class="s2">&quot;)*&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ARGUMENTS_SYMBOL</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OPTION_SYMBOL</span><span class="p">:</span> <span class="p">[],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ARGUMENTS_SYMBOL</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OPTION_SYMBOL</span>

        <span class="n">old_trace</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">gettrace</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traceit</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">ParseInterrupt</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="n">old_trace</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span>

    <span class="k">def</span> <span class="nf">mine_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract BNF option grammar&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">convert_ebnf_grammar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mine_ebnf_grammar</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<p>The trace function checks for four methods: <code class="docutils literal notranslate"><span class="pre">add_argument()</span></code> is the most important function, resulting in processing arguments; <code class="docutils literal notranslate"><span class="pre">frame.f_locals</span></code> again is the set of local variables, which at this point is mostly the arguments to <code class="docutils literal notranslate"><span class="pre">add_argument()</span></code>.  Since mutually exclusive groups also have a method <code class="docutils literal notranslate"><span class="pre">add_argument()</span></code>, we set the flag <code class="docutils literal notranslate"><span class="pre">in_group</span></code> to differentiate.</p>
<p>Note that we make no specific efforts to differentiate between multiple parsers or groups; we simply assume that there is one parser, and at any point at most one mutually exclusive group.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">OptionGrammarMiner</span><span class="p">(</span><span class="n">OptionGrammarMiner</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">traceit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event</span> <span class="o">!=</span> <span class="s2">&quot;call&quot;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="s2">&quot;self&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">self_var</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s2">&quot;self&quot;</span><span class="p">]</span>
        <span class="n">method_name</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>

        <span class="k">if</span> <span class="n">method_name</span> <span class="o">==</span> <span class="s2">&quot;add_argument&quot;</span><span class="p">:</span>
            <span class="n">in_group</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">self_var</span><span class="p">))</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Group&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_argument</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">,</span> <span class="n">in_group</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method_name</span> <span class="o">==</span> <span class="s2">&quot;add_mutually_exclusive_group&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_group</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">,</span> <span class="n">exclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method_name</span> <span class="o">==</span> <span class="s2">&quot;add_argument_group&quot;</span><span class="p">:</span>
            <span class="c1"># self.add_group(frame.f_locals, exclusive=False)</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">method_name</span> <span class="o">==</span> <span class="s2">&quot;parse_args&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParseInterrupt</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">traceit</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">process_arguments()</span></code> now analyzes the arguments passed and adds them to the grammar:</p>
<ul class="simple">
<li><p>If the argument starts with <code class="docutils literal notranslate"><span class="pre">-</span></code>, it gets added as an optional element to the <code class="docutils literal notranslate"><span class="pre">&lt;option&gt;</span></code> list</p></li>
<li><p>Otherwise, it gets added to the <code class="docutils literal notranslate"><span class="pre">&lt;argument&gt;</span></code> list.</p></li>
</ul>
<p>The optional <code class="docutils literal notranslate"><span class="pre">nargs</span></code> argument specifies how many arguments can follow.  If it is a number, we add the appropriate number of elements to the grammar; if it is an abstract specifier (say, <code class="docutils literal notranslate"><span class="pre">+</span></code> or <code class="docutils literal notranslate"><span class="pre">*</span></code>), we use it directly as EBNF operator.</p>
<p>Given the large number of parameters and optional behavior, this is a somewhat messy function, but it does the job.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">OptionGrammarMiner</span><span class="p">(</span><span class="n">OptionGrammarMiner</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process_argument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">in_group</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">[</span><span class="s2">&quot;kwargs&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">in_group</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">OptionGrammarMiner</span><span class="p">(</span><span class="n">OptionGrammarMiner</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">in_group</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">in_group</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OPTION_SYMBOL</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_group</span>
            <span class="n">metavar</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">arg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ARGUMENTS_SYMBOL</span>
            <span class="n">metavar</span> <span class="o">=</span> <span class="n">arg</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;nargs&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">nargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;nargs&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nargs</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">metavar</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">param</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">nargs</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nargs</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nargs</span><span class="p">):</span>
                <span class="n">arg</span> <span class="o">+=</span> <span class="n">param</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">nargs</span> <span class="ow">in</span> <span class="s2">&quot;?+*&quot;</span>
            <span class="n">arg</span> <span class="o">+=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">param</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span> <span class="n">nargs</span>

        <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">OPTION_SYMBOL</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">add_parameter()</span></code> handles possible parameters of options.  If the argument has an <code class="docutils literal notranslate"><span class="pre">action</span></code> defined, it takes no parameter.  Otherwise, we identify the type of the parameter (as <code class="docutils literal notranslate"><span class="pre">int</span></code> or <code class="docutils literal notranslate"><span class="pre">str</span></code>) and augment the grammar with an appropriate rule.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">inspect</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">OptionGrammarMiner</span><span class="p">(</span><span class="n">OptionGrammarMiner</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">add_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">metavar</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;action&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="c1"># No parameter</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="n">type_</span> <span class="o">=</span> <span class="s2">&quot;str&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;type&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">given_type</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
            <span class="c1"># int types come as &#39;&lt;class int&gt;&#39;</span>
            <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">given_type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">given_type</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">type_</span> <span class="o">=</span> <span class="s2">&quot;int&quot;</span>

        <span class="k">if</span> <span class="n">metavar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;metavar&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">metavar</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;metavar&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">metavar</span> <span class="o">=</span> <span class="n">type_</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_type_rule</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metavar</span> <span class="o">!=</span> <span class="n">type_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_metavar_rule</span><span class="p">(</span><span class="n">metavar</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span>

        <span class="n">param</span> <span class="o">=</span> <span class="s2">&quot; &lt;&quot;</span> <span class="o">+</span> <span class="n">metavar</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span>

        <span class="k">return</span> <span class="n">param</span>
</pre></div>
</div>
</div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">add_type_rule()</span></code> adds a rule for parameter types to the grammar.  If the parameter is identified by a meta-variable (say, <code class="docutils literal notranslate"><span class="pre">N</span></code>), we add a rule for this as well to improve legibility.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">OptionGrammarMiner</span><span class="p">(</span><span class="n">OptionGrammarMiner</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">add_type_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">type_</span> <span class="o">==</span> <span class="s2">&quot;int&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_int_rule</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_str_rule</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_int_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="s2">&quot;&lt;int&gt;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;(-)?&lt;digit&gt;+&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crange</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_str_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="s2">&quot;&lt;str&gt;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&lt;char&gt;+&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="s2">&quot;&lt;char&gt;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">srange</span><span class="p">(</span>
            <span class="n">string</span><span class="o">.</span><span class="n">digits</span>
            <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span>
            <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_metavar_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metavar</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="n">metavar</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="n">type_</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>The method <code class="docutils literal notranslate"><span class="pre">add_group()</span></code> adds a new mutually exclusive group to the grammar.  We define a new symbol (say, <code class="docutils literal notranslate"><span class="pre">&lt;group&gt;</span></code>) for the options added to the group, and use the <code class="docutils literal notranslate"><span class="pre">required</span></code> and <code class="docutils literal notranslate"><span class="pre">exclusive</span></code> flags to define an appropriate expansion operator.  The group is then prefixed to the grammar, as in</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">start</span><span class="o">&gt;</span> <span class="p">:</span><span class="o">:=</span> <span class="o">&lt;</span><span class="n">group</span><span class="o">&gt;&lt;</span><span class="n">option</span><span class="o">&gt;*</span> <span class="o">&lt;</span><span class="n">arguments</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">group</span><span class="o">&gt;</span> <span class="p">:</span><span class="o">:=</span> <span class="o">&lt;</span><span class="n">empty</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>and filled with the next calls to <code class="docutils literal notranslate"><span class="pre">add_argument()</span></code> within the group.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">OptionGrammarMiner</span><span class="p">(</span><span class="n">OptionGrammarMiner</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">add_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">exclusive</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">[</span><span class="s2">&quot;kwargs&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">required</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;required&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">new_symbol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">,</span> <span class="s2">&quot;&lt;group&gt;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">required</span> <span class="ow">and</span> <span class="n">exclusive</span><span class="p">:</span>
            <span class="n">group_expansion</span> <span class="o">=</span> <span class="n">group</span>
        <span class="k">if</span> <span class="n">required</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exclusive</span><span class="p">:</span>
            <span class="n">group_expansion</span> <span class="o">=</span> <span class="n">group</span> <span class="o">+</span> <span class="s2">&quot;+&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">required</span> <span class="ow">and</span> <span class="n">exclusive</span><span class="p">:</span>
            <span class="n">group_expansion</span> <span class="o">=</span> <span class="n">group</span> <span class="o">+</span> <span class="s2">&quot;?&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">required</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exclusive</span><span class="p">:</span>
            <span class="n">group_expansion</span> <span class="o">=</span> <span class="n">group</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="n">START_SYMBOL</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_expansion</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="n">START_SYMBOL</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_group</span> <span class="o">=</span> <span class="n">group</span>
</pre></div>
</div>
</div>
</div>
<p>That’s it!  With this, we can now extract the grammar from our <code class="docutils literal notranslate"><span class="pre">process_numbers()</span></code> program.  Turning on logging again reveals the variables we draw upon.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">miner</span> <span class="o">=</span> <span class="n">OptionGrammarMiner</span><span class="p">(</span><span class="n">process_numbers</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">process_numbers_grammar</span> <span class="o">=</span> <span class="n">miner</span><span class="o">.</span><span class="n">mine_ebnf_grammar</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;-h&#39;, &#39;--help&#39;)
{&#39;action&#39;: &#39;help&#39;, &#39;default&#39;: &#39;==SUPPRESS==&#39;, &#39;help&#39;: &#39;show this help message and exit&#39;}

(&#39;integers&#39;,)
{&#39;metavar&#39;: &#39;N&#39;, &#39;type&#39;: &lt;class &#39;int&#39;&gt;, &#39;nargs&#39;: &#39;+&#39;, &#39;help&#39;: &#39;an integer for the accumulator&#39;}

{&#39;required&#39;: True}
(&#39;--sum&#39;,)
{&#39;dest&#39;: &#39;accumulate&#39;, &#39;action&#39;: &#39;store_const&#39;, &#39;const&#39;: &lt;built-in function sum&gt;, &#39;help&#39;: &#39;sum the integers&#39;}

(&#39;--min&#39;,)
{&#39;dest&#39;: &#39;accumulate&#39;, &#39;action&#39;: &#39;store_const&#39;, &#39;const&#39;: &lt;built-in function min&gt;, &#39;help&#39;: &#39;compute the minimum&#39;}

(&#39;--max&#39;,)
{&#39;dest&#39;: &#39;accumulate&#39;, &#39;action&#39;: &#39;store_const&#39;, &#39;const&#39;: &lt;built-in function max&gt;, &#39;help&#39;: &#39;compute the maximum&#39;}
</pre></div>
</div>
</div>
</div>
<p>Here is the extracted grammar:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">process_numbers_grammar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&lt;start&gt;&#39;: [&#39;&lt;group&gt;(&lt;option&gt;)*&lt;arguments&gt;&#39;],
 &#39;&lt;option&gt;&#39;: [&#39; -h&#39;, &#39; --help&#39;],
 &#39;&lt;arguments&gt;&#39;: [&#39;( &lt;integers&gt;)+&#39;],
 &#39;&lt;int&gt;&#39;: [&#39;(-)?&lt;digit&gt;+&#39;],
 &#39;&lt;digit&gt;&#39;: [&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;],
 &#39;&lt;integers&gt;&#39;: [&#39;&lt;int&gt;&#39;],
 &#39;&lt;group&gt;&#39;: [&#39; --sum&#39;, &#39; --min&#39;, &#39; --max&#39;]}
</pre></div>
</div>
</div>
</div>
<p>The grammar properly identifies the group found:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">process_numbers_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;&lt;group&gt;(&lt;option&gt;)*&lt;arguments&gt;&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">process_numbers_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;group&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39; --sum&#39;, &#39; --min&#39;, &#39; --max&#39;]
</pre></div>
</div>
</div>
</div>
<p>It also identifies a <code class="docutils literal notranslate"><span class="pre">--help</span></code> option provided not by us, but by the <code class="docutils literal notranslate"><span class="pre">argparse</span></code> module:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">process_numbers_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;option&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39; -h&#39;, &#39; --help&#39;]
</pre></div>
</div>
</div>
</div>
<p>The grammar also correctly identifies the types of the arguments:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">process_numbers_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;arguments&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;( &lt;integers&gt;)+&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">process_numbers_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;integers&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;&lt;int&gt;&#39;]
</pre></div>
</div>
</div>
</div>
<p>The rules for <code class="docutils literal notranslate"><span class="pre">int</span></code> are set as defined by <code class="docutils literal notranslate"><span class="pre">add_int_rule()</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">process_numbers_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;int&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;(-)?&lt;digit&gt;+&#39;]
</pre></div>
</div>
</div>
</div>
<p>We can take this grammar and convert it to BNF, such that we can fuzz with it right away:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">process_numbers_grammar</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grammar</span> <span class="o">=</span> <span class="n">convert_ebnf_grammar</span><span class="p">(</span><span class="n">process_numbers_grammar</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarCoverageFuzzer</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> --sum 9
 --max -h --help --help -16 -0
 --min --help 2745341 8
 --min 1 27
 --sum --help --help -2
 --sum --help 0 3 -77
 --sum -3
 --sum --help 429 8 10 0295 -694 1
 --max -h 91 -1425 99
 --sum -795 -94 8 -44
</pre></div>
</div>
</div>
</div>
<p>Each and every invocation adheres to the rules as set forth in the <code class="docutils literal notranslate"><span class="pre">argparse</span></code> calls.  By mining options and arguments from existing programs, we can now fuzz these options out of the box – without having to specify a grammar.</p>
</section>
</section>
<section id="testing-autopep8">
<h2>Testing Autopep8<a class="headerlink" href="#testing-autopep8" title="Link to this heading">#</a></h2>
<p>Let us try out the option grammar miner on real-world Python programs.  <code class="docutils literal notranslate"><span class="pre">autopep8</span></code> is a tool that automatically converts Python code to the <a class="reference external" href="https://www.python.org/dev/peps/pep-0008/">PEP 8 Style Guide for Python Code</a>.  (Actually, all Python code in this book runs through <code class="docutils literal notranslate"><span class="pre">autopep8</span></code> during production.)  <code class="docutils literal notranslate"><span class="pre">autopep8</span></code> offers a wide range of options, as can be seen by invoking it with <code class="docutils literal notranslate"><span class="pre">--help</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>autopep8<span class="w"> </span>--help
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>usage: autopep8 [-h] [--version] [-v] [-d] [-i] [--global-config filename]
                [--ignore-local-config] [-r] [-j n] [-p n] [-a]
                [--experimental] [--exclude globs] [--list-fixes]
                [--ignore errors] [--select errors] [--max-line-length n]
                [--line-range line line] [--hang-closing] [--exit-code]
                [files ...]

Automatically formats Python code to conform to the PEP 8 style guide.

positional arguments:
  files                 files to format or &#39;-&#39; for standard in

options:
  -h, --help            show this help message and exit
  --version             show program&#39;s version number and exit
  -v, --verbose         print verbose messages; multiple -v result in more
                        verbose messages
  -d, --diff            print the diff for the fixed source
  -i, --in-place        make changes to files in place
  --global-config filename
                        path to a global pep8 config file; if this file does
                        not exist then this is ignored (default:
                        /Users/zeller/.config/pep8)
  --ignore-local-config
                        don&#39;t look for and apply local config files; if not
                        passed, defaults are updated with any config files in
                        the project&#39;s root directory
  -r, --recursive       run recursively over directories; must be used with
                        --in-place or --diff
  -j n, --jobs n        number of parallel jobs; match CPU count if value is
                        less than 1
  -p n, --pep8-passes n
                        maximum number of additional pep8 passes (default:
                        infinite)
  -a, --aggressive      enable non-whitespace changes; multiple -a result in
                        more aggressive changes
  --experimental        enable experimental fixes
  --exclude globs       exclude file/directory names that match these comma-
                        separated globs
  --list-fixes          list codes for fixes; used by --ignore and --select
  --ignore errors       do not fix these errors/warnings (default:
                        E226,E24,W50,W690)
  --select errors       fix only these errors/warnings (e.g. E4,W)
  --max-line-length n   set maximum allowed line length (default: 79)
  --line-range line line, --range line line
                        only fix errors found within this inclusive range of
                        line numbers (e.g. 1 99); line numbers are indexed at
                        1
  --hang-closing        hang-closing option passed to pycodestyle
  --exit-code           change to behavior of exit code. default behavior of
                        return value, 0 is no differences, 1 is error exit.
                        return 2 when add this option. 2 is exists
                        differences.
</pre></div>
</div>
</div>
</div>
<section id="autopep8-setup">
<h3>Autopep8 Setup<a class="headerlink" href="#autopep8-setup" title="Link to this heading">#</a></h3>
<p>We want to systematically test these options.  In order to deploy our configuration grammar miner, we need to find the source code of the executable:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">find_executable</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">get_exec_path</span><span class="p">():</span>
        <span class="n">qualified_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">qualified_name</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">qualified_name</span>
    <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">autopep8_executable</span> <span class="o">=</span> <span class="n">find_executable</span><span class="p">(</span><span class="s2">&quot;autopep8&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">autopep8_executable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="n">autopep8_executable</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;/Users/zeller/.pyenv/versions/3.10.2/bin/autopep8&#39;
</pre></div>
</div>
</div>
</div>
<p>Next, we build a function that reads the contents of the file and executes it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">autopep8</span><span class="p">():</span>
    <span class="n">executable</span> <span class="o">=</span> <span class="n">find_executable</span><span class="p">(</span><span class="s2">&quot;autopep8&quot;</span><span class="p">)</span>

    <span class="c1"># First line has to contain &quot;/usr/bin/env python&quot; or like</span>
    <span class="n">first_line</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">executable</span><span class="p">)</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">first_line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;python&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>

    <span class="n">contents</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">executable</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="mining-an-autopep8-grammar">
<h3>Mining an Autopep8 Grammar<a class="headerlink" href="#mining-an-autopep8-grammar" title="Link to this heading">#</a></h3>
<p>We can use the <code class="docutils literal notranslate"><span class="pre">autopep8()</span></code> function in our grammar miner:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">autopep8_miner</span> <span class="o">=</span> <span class="n">OptionGrammarMiner</span><span class="p">(</span><span class="n">autopep8</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>and extract a grammar for it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">autopep8_ebnf_grammar</span> <span class="o">=</span> <span class="n">autopep8_miner</span><span class="o">.</span><span class="n">mine_ebnf_grammar</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>This works because here, <code class="docutils literal notranslate"><span class="pre">autopep8</span></code> is not a separate process (and a separate Python interpreter), but we run the <code class="docutils literal notranslate"><span class="pre">autopep8()</span></code> function (and the <code class="docutils literal notranslate"><span class="pre">autopep8</span></code> code) in our current Python interpreter – up to the call to <code class="docutils literal notranslate"><span class="pre">parse_args()</span></code>, where we interrupt execution again.  At this point, the <code class="docutils literal notranslate"><span class="pre">autopep8</span></code> code has done nothing but setting up the argument parser – which is what we are interested in.</p>
<p>The grammar options mined reflect precisely the options seen when providing <code class="docutils literal notranslate"><span class="pre">--help</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">autopep8_ebnf_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;option&gt;&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39; -h&#39;, &#39; --help&#39;, &#39; --version&#39;, &#39; -v&#39;, &#39; --verbose&#39;, &#39; -d&#39;, &#39; --diff&#39;, &#39; -i&#39;, &#39; --in-place&#39;, &#39; --global-config &lt;filename&gt;&#39;, &#39; --ignore-local-config&#39;, &#39; -r&#39;, &#39; --recursive&#39;, &#39; -j &lt;n&gt;&#39;, &#39; --jobs &lt;n&gt;&#39;, &#39; -p &lt;n&gt;&#39;, &#39; --pep8-passes &lt;n&gt;&#39;, &#39; -a&#39;, &#39; --aggressive&#39;, &#39; --experimental&#39;, &#39; --exclude &lt;globs&gt;&#39;, &#39; --list-fixes&#39;, &#39; --ignore &lt;errors&gt;&#39;, &#39; --select &lt;errors&gt;&#39;, &#39; --max-line-length &lt;n&gt;&#39;, &#39; --line-range &lt;line&gt; &lt;line&gt;&#39;, &#39; --range &lt;line&gt; &lt;line&gt;&#39;, &#39; --indent-size &lt;int&gt;&#39;, &#39; --hang-closing&#39;, &#39; --exit-code&#39;]
</pre></div>
</div>
</div>
</div>
<p>Metavariables like <code class="docutils literal notranslate"><span class="pre">&lt;n&gt;</span></code> or <code class="docutils literal notranslate"><span class="pre">&lt;line&gt;</span></code> are placeholders for integers.  We assume all metavariables of the same name have the same type:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">autopep8_ebnf_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;line&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;&lt;int&gt;&#39;]
</pre></div>
</div>
</div>
</div>
<p>The grammar miner has inferred that the argument to <code class="docutils literal notranslate"><span class="pre">autopep8</span></code> is a list of files:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">autopep8_ebnf_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;arguments&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;( &lt;files&gt;)*&#39;]
</pre></div>
</div>
</div>
</div>
<p>which in turn all are strings:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">autopep8_ebnf_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;files&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;&lt;str&gt;&#39;]
</pre></div>
</div>
</div>
</div>
<p>As we are only interested in testing options, not arguments, we fix the arguments to a single mandatory input.  (Otherwise, we’d have plenty of random file names generated.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">autopep8_ebnf_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;arguments&gt;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot; &lt;files&gt;&quot;</span><span class="p">]</span>
<span class="n">autopep8_ebnf_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;files&gt;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;foo.py&quot;</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">autopep8_ebnf_grammar</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="creating-autopep8-options">
<h3>Creating Autopep8 Options<a class="headerlink" href="#creating-autopep8-options" title="Link to this heading">#</a></h3>
<p>Let us now use the inferred grammar for fuzzing.  Again, we convert the EBNF grammar into a regular BNF grammar:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">autopep8_grammar</span> <span class="o">=</span> <span class="n">convert_ebnf_grammar</span><span class="p">(</span><span class="n">autopep8_ebnf_grammar</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">autopep8_grammar</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And we can use the grammar for fuzzing all options:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarCoverageFuzzer</span><span class="p">(</span><span class="n">autopep8_grammar</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> -r foo.py
 -h --experimental --hang-closing foo.py
 --list-fixes -v foo.py
 --aggressive -d foo.py
 --indent-size 9 --help foo.py
 --exit-code --recursive foo.py
 --diff --version -i foo.py
 --max-line-length 0 --in-place --verbose foo.py
 --ignore-local-config -a foo.py
 --select x -i --exit-code foo.py
 -j 8 --diff foo.py
 -d -v -d foo.py
 -p 6 -i foo.py
 -v --diff foo.py
 --ignore uA --recursive foo.py
 --jobs 5 -r foo.py
 --range 4 1 foo.py
 --ignore-local-config -i foo.py
 -r --exit-code foo.py
 -v -r foo.py
</pre></div>
</div>
</div>
</div>
<p>Let us apply these options on the actual program.  We need a file <code class="docutils literal notranslate"><span class="pre">foo.py</span></code> that will serve as input: (Note that the following commands will overwrite the file <code class="docutils literal notranslate"><span class="pre">foo.py</span></code>, if it already exists in the current working directory. Be aware of this, if you downloaded the notebooks and are working locally.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_foo_py</span><span class="p">():</span>
    <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;foo.py&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">def twice(x = 2):</span>
<span class="s2">    return  x  +  x</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">create_foo_py</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;foo.py&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>def twice(x = 2):
    return  x  +  x
</pre></div>
</div>
</div>
</div>
<p>We see how <code class="docutils literal notranslate"><span class="pre">autopep8</span></code> fixes the spacing:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>autopep8<span class="w"> </span>foo.py
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>def twice(x=2):
    return x + x
</pre></div>
</div>
</div>
</div>
<p>Let us now put things together.  We define a <code class="docutils literal notranslate"><span class="pre">ProgramRunner</span></code> that will run the <code class="docutils literal notranslate"><span class="pre">autopep8</span></code> executable with arguments coming from the mined <code class="docutils literal notranslate"><span class="pre">autopep8</span></code> grammar.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Fuzzer</span> <span class="kn">import</span> <span class="n">ProgramRunner</span>
</pre></div>
</div>
</div>
</div>
<p>Running <code class="docutils literal notranslate"><span class="pre">autopep8</span></code> with the mined options reveals a surprisingly high number of passing runs.  (We see that some options depend on each other or are mutually exclusive, but this is handled by the program logic, not the argument parser, and hence out of our scope.)  The <code class="docutils literal notranslate"><span class="pre">GrammarCoverageFuzzer</span></code> ensures that each option is tested at least once.  (Digits and letters, too, by the way.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarCoverageFuzzer</span><span class="p">(</span><span class="n">autopep8_grammar</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">invocation</span> <span class="o">=</span> <span class="s2">&quot;autopep8&quot;</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;$ &quot;</span> <span class="o">+</span> <span class="n">invocation</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">invocation</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">autopep8_runner</span> <span class="o">=</span> <span class="n">ProgramRunner</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">outcome</span> <span class="o">=</span> <span class="n">autopep8_runner</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>$ autopep8 foo.py
$ autopep8 --diff --max-line-length 4 --exit-code --range 5 8 -p 2 foo.py
$ autopep8 --ignore z --verbose -r --list-fixes foo.py
--recursive must be used with --in-place or --diff$ autopep8 --exclude 5 -h -i --aggressive --in-place foo.py
$ autopep8 --select a --help --experimental foo.py
$ autopep8 --indent-size -30 --recursive foo.py
--recursive must be used with --in-place or --diff$ autopep8 --global-config &lt; -j 9 -v -a foo.py
parallel jobs requires --in-place$ autopep8 --line-range 7 1 --hang-closing -d foo.py
First value of --range should be less than or equal to the second$ autopep8 --pep8-passes 6 --hang-closing --version --ignore-local-config foo.py
$ autopep8 --jobs -2 --experimental --version foo.py
$ autopep8 --ignore Y: --select ! --global-config e foo.py
$ autopep8 --select 1 -a --recursive --aggressive foo.py
--recursive must be used with --in-place or --diff$ autopep8 --ignore * --ignore `0 --global-config _ --verbose foo.py
[file:foo.py]
---&gt;  Applying global fix for E265
---&gt;  5 issue(s) to fix {&#39;E251&#39;: {2}, &#39;E271&#39;: {3}, &#39;E221&#39;: {3}, &#39;E222&#39;: {3}}
---&gt;  3 issue(s) to fix {&#39;E251&#39;: {2}, &#39;E221&#39;: {3}, &#39;E222&#39;: {3}}
---&gt;  1 issue(s) to fix {&#39;E222&#39;: {3}}
---&gt;  0 issue(s) to fix {}
$ autopep8 --global-config ,\ --exclude r -v foo.py
[file:foo.py]
---&gt;  Applying global fix for E265
---&gt;  5 issue(s) to fix {&#39;E251&#39;: {2}, &#39;E271&#39;: {3}, &#39;E221&#39;: {3}, &#39;E222&#39;: {3}}
---&gt;  3 issue(s) to fix {&#39;E251&#39;: {2}, &#39;E221&#39;: {3}, &#39;E222&#39;: {3}}
---&gt;  1 issue(s) to fix {&#39;E222&#39;: {3}}
---&gt;  0 issue(s) to fix {}
$ autopep8 --global-config xd6M --recursive foo.py
--recursive must be used with --in-place or --diff$ autopep8 --select R --exclude L --version --ignore-local-config foo.py
$ autopep8 --select &quot; --verbose -h -d foo.py
$ autopep8 --diff -i -h foo.py
$ autopep8 --in-place --select w --version -i foo.py
$ autopep8 --ignore 49 --exclude lI -i foo.py
</pre></div>
</div>
</div>
</div>
<p>Our <code class="docutils literal notranslate"><span class="pre">foo.py</span></code> file now has been formatted in place a number of times:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;foo.py&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>def twice(x=2):
    return x + x
</pre></div>
</div>
</div>
</div>
<p>We don’t need it anymore, so we clean up things:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;foo.py&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="classes-for-fuzzing-configuration-options">
<h2>Classes for Fuzzing Configuration Options<a class="headerlink" href="#classes-for-fuzzing-configuration-options" title="Link to this heading">#</a></h2>
<p>Let us now create reusable classes that we can use for testing arbitrary programs.  (Okay, make that “arbitrary programs that are written in Python and use the <code class="docutils literal notranslate"><span class="pre">argparse</span></code> module to process command-line arguments.”)</p>
<p>The class <code class="docutils literal notranslate"><span class="pre">OptionRunner</span></code> is a subclass of <code class="docutils literal notranslate"><span class="pre">ProgramRunner</span></code> that takes care of automatically determining the grammar, using the same steps we used for <code class="docutils literal notranslate"><span class="pre">autopep8</span></code>, above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Grammars</span> <span class="kn">import</span> <span class="n">unreachable_nonterminals</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">OptionRunner</span><span class="p">(</span><span class="n">ProgramRunner</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run a program while determining its option grammar&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
                 <span class="n">arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                 <span class="n">log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">miner_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">OptionGrammarMiner</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor.</span>
<span class="sd">        `program` - the (Python) program to be executed</span>
<span class="sd">        `arguments` - an (optional) string with arguments for `program`</span>
<span class="sd">        `log` - if True, enable logging in miner</span>
<span class="sd">        `miner_class` - the `OptionGrammarMiner` class to be used</span>
<span class="sd">                  (default: `OptionGrammarMiner`)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_executable</span> <span class="o">=</span> <span class="n">program</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_executable</span> <span class="o">=</span> <span class="n">program</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">miner_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">miner_class</span> <span class="o">=</span> <span class="n">OptionGrammarMiner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">miner_class</span> <span class="o">=</span> <span class="n">miner_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">find_contents</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">find_grammar</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">arguments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_arguments</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">program</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>First, we find the contents of the Python executable:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">OptionRunner</span><span class="p">(</span><span class="n">OptionRunner</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">find_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executable</span> <span class="o">=</span> <span class="n">find_executable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_executable</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_executable</span> <span class="o">+</span> <span class="s2">&quot;: not found&quot;</span><span class="p">)</span>

        <span class="n">first_line</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_executable</span><span class="p">)</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">first_line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;python&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_executable</span> <span class="o">+</span> <span class="s2">&quot;: not a Python executable&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_executable</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">invoker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># We are passing the local variables as is, such that we can access `self`</span>
        <span class="c1"># We set __name__ to &#39;__main__&#39; to invoke the script as an executable</span>
        <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;__name__&#39;</span><span class="p">:</span> <span class="s1">&#39;__main__&#39;</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">executable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executable</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we determine the grammar using the <code class="docutils literal notranslate"><span class="pre">OptionGrammarMiner</span></code> class:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">OptionRunner</span><span class="p">(</span><span class="n">OptionRunner</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">find_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">miner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">miner_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invoker</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ebnf_grammar</span> <span class="o">=</span> <span class="n">miner</span><span class="o">.</span><span class="n">mine_ebnf_grammar</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">ebnf_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return extracted grammar in EBNF form&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ebnf_grammar</span>

    <span class="k">def</span> <span class="nf">grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return extracted grammar in BNF form&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">convert_ebnf_grammar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ebnf_grammar</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The two service methods <code class="docutils literal notranslate"><span class="pre">set_arguments()</span></code> and <code class="docutils literal notranslate"><span class="pre">set_invocation()</span></code> help us to change the arguments and program, respectively.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">OptionRunner</span><span class="p">(</span><span class="n">OptionRunner</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">set_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ebnf_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;arguments&gt;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">args</span><span class="p">]</span>
        <span class="c1"># Delete rules for previous arguments</span>
        <span class="k">for</span> <span class="n">nonterminal</span> <span class="ow">in</span> <span class="n">unreachable_nonterminals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ebnf_grammar</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ebnf_grammar</span><span class="p">[</span><span class="n">nonterminal</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">set_invocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">program</span> <span class="o">=</span> <span class="n">program</span>
</pre></div>
</div>
</div>
</div>
<p>We can instantiate the class on <code class="docutils literal notranslate"><span class="pre">autopep8</span></code> and immediately get the grammar:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">autopep8_runner</span> <span class="o">=</span> <span class="n">OptionRunner</span><span class="p">(</span><span class="s2">&quot;autopep8&quot;</span><span class="p">,</span> <span class="s2">&quot;foo.py&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">autopep8_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">&quot;&lt;option&gt;&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39; -h&#39;, &#39; --help&#39;, &#39; --version&#39;, &#39; -v&#39;, &#39; --verbose&#39;, &#39; -d&#39;, &#39; --diff&#39;, &#39; -i&#39;, &#39; --in-place&#39;, &#39; --global-config &lt;filename&gt;&#39;, &#39; --ignore-local-config&#39;, &#39; -r&#39;, &#39; --recursive&#39;, &#39; -j &lt;n&gt;&#39;, &#39; --jobs &lt;n&gt;&#39;, &#39; -p &lt;n&gt;&#39;, &#39; --pep8-passes &lt;n&gt;&#39;, &#39; -a&#39;, &#39; --aggressive&#39;, &#39; --experimental&#39;, &#39; --exclude &lt;globs&gt;&#39;, &#39; --list-fixes&#39;, &#39; --ignore &lt;errors&gt;&#39;, &#39; --select &lt;errors&gt;&#39;, &#39; --max-line-length &lt;n&gt;&#39;, &#39; --line-range &lt;line&gt; &lt;line&gt;&#39;, &#39; --range &lt;line&gt; &lt;line&gt;&#39;, &#39; --indent-size &lt;int&gt;&#39;, &#39; --hang-closing&#39;, &#39; --exit-code&#39;]
</pre></div>
</div>
</div>
</div>
<p>An <code class="docutils literal notranslate"><span class="pre">OptionFuzzer</span></code> interacts with the given <code class="docutils literal notranslate"><span class="pre">OptionRunner</span></code> to obtain its grammar, which is then passed to its <code class="docutils literal notranslate"><span class="pre">GrammarCoverageFuzzer</span></code> superclass.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">OptionFuzzer</span><span class="p">(</span><span class="n">GrammarCoverageFuzzer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fuzz a (Python) program using its arguments&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runner</span><span class="p">:</span> <span class="n">OptionRunner</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor. `runner` is an OptionRunner.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">runner</span><span class="p">),</span> <span class="n">OptionRunner</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runner</span> <span class="o">=</span> <span class="n">runner</span>
        <span class="n">grammar</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">grammar</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>When invoking <code class="docutils literal notranslate"><span class="pre">run()</span></code>, the <code class="docutils literal notranslate"><span class="pre">OptionFuzzer</span></code> creates a new invocation (using <code class="docutils literal notranslate"><span class="pre">fuzz()</span></code> from its grammar) and runs the now given (or previously set) runner with the arguments from the grammar.  Note that the runner specified in <code class="docutils literal notranslate"><span class="pre">run()</span></code> can differ from the one set during initialization; this allows for mining options from one program and applying it in another context.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">OptionFuzzer</span><span class="p">(</span><span class="n">OptionFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inp</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">runner</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">runner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span>
        <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">runner</span><span class="p">),</span> <span class="n">OptionRunner</span><span class="p">)</span>
        <span class="n">invocation</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">executable</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
        <span class="n">runner</span><span class="o">.</span><span class="n">set_invocation</span><span class="p">(</span><span class="n">invocation</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="example-autopep8">
<h3>Example: Autopep8<a class="headerlink" href="#example-autopep8" title="Link to this heading">#</a></h3>
<p>Let us apply our newly defined classes on the <code class="docutils literal notranslate"><span class="pre">autopep8</span></code> runner:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">autopep8_fuzzer</span> <span class="o">=</span> <span class="n">OptionFuzzer</span><span class="p">(</span><span class="n">autopep8_runner</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">autopep8_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> foo.py
 --in-place --ignore-local-config --jobs 6 --recursive -i foo.py
 --help -a --indent-size -95 --pep8-passes 3 --exclude = -r foo.py
</pre></div>
</div>
</div>
</div>
<p>We can now systematically test <code class="docutils literal notranslate"><span class="pre">autopep8</span></code> with these classes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">autopep8_fuzzer</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">autopep8_runner</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(CompletedProcess(args=[&#39;/Users/zeller/.pyenv/versions/3.10.2/bin/autopep8&#39;, &#39;--hang-closing&#39;, &#39;--exit-code&#39;, &#39;-d&#39;, &#39;--version&#39;, &#39;foo.py&#39;], returncode=0, stdout=&#39;autopep8 1.6.0 (pycodestyle: 2.12.1)\n&#39;, stderr=&#39;&#39;),
 &#39;PASS&#39;)
</pre></div>
</div>
</div>
</div>
</section>
<section id="example-mypy">
<h3>Example: MyPy<a class="headerlink" href="#example-mypy" title="Link to this heading">#</a></h3>
<p>We can extract options for the <code class="docutils literal notranslate"><span class="pre">mypy</span></code> static type checker for Python:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">find_executable</span><span class="p">(</span><span class="s2">&quot;mypy&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mypy_runner</span> <span class="o">=</span> <span class="n">OptionRunner</span><span class="p">(</span><span class="s2">&quot;mypy&quot;</span><span class="p">,</span> <span class="s2">&quot;foo.py&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mypy_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">&quot;&lt;option&gt;&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39; -h&#39;, &#39; --help&#39;, &#39; -v&#39;, &#39; --verbose&#39;, &#39; -V&#39;, &#39; --version&#39;, &#39; -O &lt;FORMAT&gt;&#39;, &#39; --output &lt;FORMAT&gt;&#39;, &#39; --config-file &lt;str&gt;&#39;, &#39; --warn-unused-configs&#39;, &#39; --no-warn-unused-configs&#39;, &#39; --no-namespace-packages&#39;, &#39; --namespace-packages&#39;, &#39; --ignore-missing-imports&#39;, &#39; --follow-untyped-imports&#39;, &#39; --follow-imports &lt;str&gt;&#39;, &#39; --python-executable&#39;, &#39; --no-site-packages&#39;, &#39; --no-silence-site-packages&#39;, &#39; --python-version &lt;x.y&gt;&#39;, &#39; --platform&#39;, &#39; --always-true&#39;, &#39; --always-false&#39;, &#39; --disallow-any-expr&#39;, &#39; --disallow-any-decorated&#39;, &#39; --disallow-any-explicit&#39;, &#39; --disallow-any-generics&#39;, &#39; --allow-any-generics&#39;, &#39; --disallow-any-unimported&#39;, &#39; --allow-any-unimported&#39;, &#39; --disallow-subclassing-any&#39;, &#39; --allow-subclassing-any&#39;, &#39; --disallow-untyped-calls&#39;, &#39; --allow-untyped-calls&#39;, &#39; --untyped-calls-exclude&#39;, &#39; --disallow-untyped-defs&#39;, &#39; --allow-untyped-defs&#39;, &#39; --disallow-incomplete-defs&#39;, &#39; --allow-incomplete-defs&#39;, &#39; --check-untyped-defs&#39;, &#39; --no-check-untyped-defs&#39;, &#39; --disallow-untyped-decorators&#39;, &#39; --allow-untyped-decorators&#39;, &#39; --implicit-optional&#39;, &#39; --no-implicit-optional&#39;, &#39; --strict-optional&#39;, &#39; --no-strict-optional&#39;, &#39; --force-uppercase-builtins&#39;, &#39; --no-force-uppercase-builtins&#39;, &#39; --force-union-syntax&#39;, &#39; --no-force-union-syntax&#39;, &#39; --warn-redundant-casts&#39;, &#39; --no-warn-redundant-casts&#39;, &#39; --warn-unused-ignores&#39;, &#39; --no-warn-unused-ignores&#39;, &#39; --no-warn-no-return&#39;, &#39; --warn-no-return&#39;, &#39; --warn-return-any&#39;, &#39; --no-warn-return-any&#39;, &#39; --warn-unreachable&#39;, &#39; --no-warn-unreachable&#39;, &#39; --report-deprecated-as-note&#39;, &#39; --no-report-deprecated-as-note&#39;, &#39; --allow-untyped-globals&#39;, &#39; --disallow-untyped-globals&#39;, &#39; --allow-redefinition&#39;, &#39; --disallow-redefinition&#39;, &#39; --no-implicit-reexport&#39;, &#39; --implicit-reexport&#39;, &#39; --strict-equality&#39;, &#39; --no-strict-equality&#39;, &#39; --extra-checks&#39;, &#39; --no-extra-checks&#39;, &#39; --strict&#39;, &#39; --disable-error-code&#39;, &#39; --enable-error-code&#39;, &#39; --show-error-context&#39;, &#39; --hide-error-context&#39;, &#39; --show-column-numbers&#39;, &#39; --hide-column-numbers&#39;, &#39; --show-error-end&#39;, &#39; --hide-error-end&#39;, &#39; --hide-error-codes&#39;, &#39; --show-error-codes&#39;, &#39; --show-error-code-links&#39;, &#39; --hide-error-code-links&#39;, &#39; --pretty&#39;, &#39; --no-pretty&#39;, &#39; --no-color-output&#39;, &#39; --color-output&#39;, &#39; --no-error-summary&#39;, &#39; --error-summary&#39;, &#39; --show-absolute-path&#39;, &#39; --hide-absolute-path&#39;, &#39; --soft-error-limit &lt;int&gt;&#39;, &#39; -i&#39;, &#39; --incremental&#39;, &#39; --no-incremental&#39;, &#39; --cache-dir&#39;, &#39; --sqlite-cache&#39;, &#39; --no-sqlite-cache&#39;, &#39; --cache-fine-grained&#39;, &#39; --skip-version-check&#39;, &#39; --skip-cache-mtime-checks&#39;, &#39; --pdb&#39;, &#39; --show-traceback&#39;, &#39; --tb&#39;, &#39; --raise-exceptions&#39;, &#39; --custom-typing-module &lt;MODULE&gt;&#39;, &#39; --old-type-inference&#39;, &#39; --new-type-inference&#39;, &#39; --enable-incomplete-feature&#39;, &#39; --custom-typeshed-dir &lt;DIR&gt;&#39;, &#39; --warn-incomplete-stub&#39;, &#39; --no-warn-incomplete-stub&#39;, &#39; --shadow-file&#39;, &#39; --fast-exit&#39;, &#39; --no-fast-exit&#39;, &#39; --allow-empty-bodies&#39;, &#39; --disallow-empty-bodies&#39;, &#39; --export-ref-info&#39;, &#39; --any-exprs-report &lt;DIR&gt;&#39;, &#39; --cobertura-xml-report &lt;DIR&gt;&#39;, &#39; --html-report &lt;DIR&gt;&#39;, &#39; --linecount-report &lt;DIR&gt;&#39;, &#39; --linecoverage-report &lt;DIR&gt;&#39;, &#39; --lineprecision-report &lt;DIR&gt;&#39;, &#39; --txt-report &lt;DIR&gt;&#39;, &#39; --xml-report &lt;DIR&gt;&#39;, &#39; --xslt-html-report &lt;DIR&gt;&#39;, &#39; --xslt-txt-report &lt;DIR&gt;&#39;, &#39; --quickstart-file &lt;str&gt;&#39;, &#39; --junit-xml &lt;str&gt;&#39;, &#39; --junit-format &lt;str&gt;&#39;, &#39; --find-occurrences &lt;CLASS.MEMBER&gt;&#39;, &#39; --scripts-are-modules&#39;, &#39; --install-types&#39;, &#39; --no-install-types&#39;, &#39; --non-interactive&#39;, &#39; --interactive&#39;, &#39; --stats&#39;, &#39; --inferstats&#39;, &#39; --dump-build-stats&#39;, &#39; --timing-stats &lt;str&gt;&#39;, &#39; --line-checking-stats &lt;str&gt;&#39;, &#39; --debug-cache&#39;, &#39; --dump-deps&#39;, &#39; --dump-graph&#39;, &#39; --semantic-analysis-only&#39;, &#39; --test-env&#39;, &#39; --local-partial-types&#39;, &#39; --logical-deps&#39;, &#39; --bazel&#39;, &#39; --package-root&#39;, &#39; --cache-map( &lt;str&gt;)+&#39;, &#39; --debug-serialize&#39;, &#39; --disable-bytearray-promotion&#39;, &#39; --disable-memoryview-promotion&#39;, &#39; --strict-concatenate&#39;, &#39; --explicit-package-bases&#39;, &#39; --no-explicit-package-bases&#39;, &#39; --fast-module-lookup&#39;, &#39; --no-fast-module-lookup&#39;, &#39; --exclude&#39;, &#39; -m&#39;, &#39; --module&#39;, &#39; -p&#39;, &#39; --package&#39;, &#39; -c&#39;, &#39; --command&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mypy_fuzzer</span> <span class="o">=</span> <span class="n">OptionFuzzer</span><span class="p">(</span><span class="n">mypy_runner</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">mypy_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> --namespace-packages foo.py
 --no-warn-no-return --enable-incomplete-feature -m --disallow-empty-bodies foo.py
 --dump-deps --disallow-subclassing-any --disallow-any-decorated --show-error-end --no-install-types --cache-fine-grained --sqlite-cache --no-warn-unreachable --no-warn-return-any --force-uppercase-builtins --debug-serialize --disable-bytearray-promotion --implicit-reexport --linecount-report l --fast-exit --allow-untyped-globals --no-color-output --color-output --show-error-code-links --inferstats --cache-map @ S --allow-any-generics --error-summary foo.py
 --allow-subclassing-any --no-incremental --fast-module-lookup --no-site-packages --old-type-inference --allow-redefinition --no-force-uppercase-builtins --incremental --new-type-inference foo.py
 --disallow-any-explicit --no-implicit-optional --no-warn-incomplete-stub foo.py
 --disallow-any-unimported --warn-unused-configs --hide-error-codes --allow-untyped-calls --follow-untyped-imports foo.py
 -h --no-report-deprecated-as-note --xslt-txt-report ze --command --dump-graph foo.py
 --find-occurrences 1 --strict-optional --hide-column-numbers --export-ref-info foo.py
 --soft-error-limit 06 --semantic-analysis-only foo.py
 --no-pretty --no-strict-equality --no-namespace-packages --tb --pdb --warn-redundant-casts --strict --install-types --disable-memoryview-promotion foo.py
</pre></div>
</div>
</div>
</div>
</section>
<section id="example-notedown">
<h3>Example: Notedown<a class="headerlink" href="#example-notedown" title="Link to this heading">#</a></h3>
<p>Here’s the configuration options for the <code class="docutils literal notranslate"><span class="pre">notedown</span></code> Notebook to Markdown converter:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">find_executable</span><span class="p">(</span><span class="s2">&quot;notedown&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
    <span class="c1"># Workaround: `notedown` can issue a `DeprecationWarning`</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span><span class="p">)</span>
    <span class="n">notedown_runner</span> <span class="o">=</span> <span class="n">OptionRunner</span><span class="p">(</span><span class="s2">&quot;notedown&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">notedown_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">&quot;&lt;option&gt;&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39; -h&#39;, &#39; --help&#39;, &#39; -o( &lt;str&gt;)?&#39;, &#39; --output( &lt;str&gt;)?&#39;, &#39; --from &lt;str&gt;&#39;, &#39; --to &lt;str&gt;&#39;, &#39; --run&#39;, &#39; --execute&#39;, &#39; --timeout &lt;int&gt;&#39;, &#39; --strip&#39;, &#39; --precode( &lt;str&gt;)+&#39;, &#39; --knit( &lt;str&gt;)?&#39;, &#39; --rmagic&#39;, &#39; --nomagic&#39;, &#39; --render&#39;, &#39; --template &lt;str&gt;&#39;, &#39; --match &lt;str&gt;&#39;, &#39; --examples&#39;, &#39; --version&#39;, &#39; --debug&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">notedown_fuzzer</span> <span class="o">=</span> <span class="n">OptionFuzzer</span><span class="p">(</span><span class="n">notedown_runner</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">notedown_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> --version O[
 --help --from tF --match C --execute
 --timeout -50 --template ! --debug --examples --rmagic --output M4kI --strip --render mQ
 --run -h --nomagic c
 --to eW --render &#39;
 -o --knit ^%J --precode } --render --execute --render $
 --precode . s -h --run \
 --nomagic -h --execute #
 --execute --run ai
 --output --knit --run --version --execute A
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="combinatorial-testing">
<h2>Combinatorial Testing<a class="headerlink" href="#combinatorial-testing" title="Link to this heading">#</a></h2>
<p>Our <code class="docutils literal notranslate"><span class="pre">CoverageGrammarFuzzer</span></code> does a good job in covering each and every option at least once, which is great for systematic testing.  However, as we also can see in our examples above, some options require each other, while others interfere with each other.  What we should do as good testers is not only to cover every option individually, but also <em>combinations</em> of options.</p>
<p>The Python <code class="docutils literal notranslate"><span class="pre">itertools</span></code> module gives us means to create combinations from lists.  We can, for instance, take the <code class="docutils literal notranslate"><span class="pre">notedown</span></code> options and create a list of all pairs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">option_list</span> <span class="o">=</span> <span class="n">notedown_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">&quot;&lt;option&gt;&quot;</span><span class="p">]</span>
<span class="n">pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">option_list</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>There’s quite a number of pairs:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>190
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">pairs</span><span class="p">[:</span><span class="mi">20</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39; -h&#39;, &#39; --help&#39;), (&#39; -h&#39;, &#39; -o( &lt;str&gt;)?&#39;), (&#39; -h&#39;, &#39; --output( &lt;str&gt;)?&#39;), (&#39; -h&#39;, &#39; --from &lt;str&gt;&#39;), (&#39; -h&#39;, &#39; --to &lt;str&gt;&#39;), (&#39; -h&#39;, &#39; --run&#39;), (&#39; -h&#39;, &#39; --execute&#39;), (&#39; -h&#39;, &#39; --timeout &lt;int&gt;&#39;), (&#39; -h&#39;, &#39; --strip&#39;), (&#39; -h&#39;, &#39; --precode( &lt;str&gt;)+&#39;), (&#39; -h&#39;, &#39; --knit( &lt;str&gt;)?&#39;), (&#39; -h&#39;, &#39; --rmagic&#39;), (&#39; -h&#39;, &#39; --nomagic&#39;), (&#39; -h&#39;, &#39; --render&#39;), (&#39; -h&#39;, &#39; --template &lt;str&gt;&#39;), (&#39; -h&#39;, &#39; --match &lt;str&gt;&#39;), (&#39; -h&#39;, &#39; --examples&#39;), (&#39; -h&#39;, &#39; --version&#39;), (&#39; -h&#39;, &#39; --debug&#39;), (&#39; --help&#39;, &#39; -o( &lt;str&gt;)?&#39;)]
</pre></div>
</div>
</div>
</div>
<p>Testing every such pair of options frequently suffices to cover all interferences between options.  (Programs rarely have conditions involving three or more configuration settings.)  To this end, we <em>change</em> the grammar from having a list of options to having a list of <em>option pairs</em>, such that covering these will automatically cover all pairs.</p>
<p>We create a function <code class="docutils literal notranslate"><span class="pre">pairwise()</span></code> that takes a list of options as occurring in our grammar and returns a list of <em>pairwise options</em> – that is, our original options, but concatenated.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pairwise</span><span class="p">(</span><span class="n">option_list</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">option_1</span> <span class="o">+</span> <span class="n">option_2</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">option_1</span><span class="p">,</span> <span class="n">option_2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">option_list</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s the first 20 pairs:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">pairwise</span><span class="p">(</span><span class="n">option_list</span><span class="p">)[:</span><span class="mi">20</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39; -h --help&#39;, &#39; -h -o( &lt;str&gt;)?&#39;, &#39; -h --output( &lt;str&gt;)?&#39;, &#39; -h --from &lt;str&gt;&#39;, &#39; -h --to &lt;str&gt;&#39;, &#39; -h --run&#39;, &#39; -h --execute&#39;, &#39; -h --timeout &lt;int&gt;&#39;, &#39; -h --strip&#39;, &#39; -h --precode( &lt;str&gt;)+&#39;, &#39; -h --knit( &lt;str&gt;)?&#39;, &#39; -h --rmagic&#39;, &#39; -h --nomagic&#39;, &#39; -h --render&#39;, &#39; -h --template &lt;str&gt;&#39;, &#39; -h --match &lt;str&gt;&#39;, &#39; -h --examples&#39;, &#39; -h --version&#39;, &#39; -h --debug&#39;, &#39; --help -o( &lt;str&gt;)?&#39;]
</pre></div>
</div>
</div>
</div>
<p>The new grammar <code class="docutils literal notranslate"><span class="pre">pairwise_notedown_grammar</span></code> is a copy of the <code class="docutils literal notranslate"><span class="pre">notedown</span></code> grammar, but with the list of options replaced with the above pairwise option list.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">notedown_grammar</span> <span class="o">=</span> <span class="n">notedown_runner</span><span class="o">.</span><span class="n">grammar</span><span class="p">()</span>
<span class="n">pairwise_notedown_grammar</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">notedown_grammar</span><span class="p">)</span>
<span class="n">pairwise_notedown_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;option&gt;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pairwise</span><span class="p">(</span><span class="n">notedown_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;option&gt;&quot;</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">pairwise_notedown_grammar</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Using the “pairwise” grammar to fuzz now covers one pair after another:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">notedown_pairwise_fuzzer</span> <span class="o">=</span> <span class="n">GrammarCoverageFuzzer</span><span class="p">(</span>
    <span class="n">pairwise_notedown_grammar</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">notedown_pairwise_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> --nomagic --debug
 -h --help --examples --version l
 --execute --examples --run --execute
 --execute --debug --render --debug
 --help --render --strip --version
 -h --debug _U
 --execute --render --render --version Q
 --execute --rmagic -h --run
 --rmagic --version --help --execute d
 --strip --render --examples --debug ?
</pre></div>
</div>
</div>
</div>
<p>Can we actually test all combinations of options?  Not in practice, as the number of combinations quickly grows as the length increases.  It decreases again as the number of options reaches the maximum (with 20 options, there is only 1 combination involving <em>all</em> options), but the absolute numbers are still staggering:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">combination_length</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">):</span>
    <span class="n">tuples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">option_list</span><span class="p">,</span> <span class="n">combination_length</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">combination_length</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tuples</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1 20
2 190
3 1140
4 4845
5 15504
6 38760
7 77520
8 125970
9 167960
10 184756
11 167960
12 125970
13 77520
14 38760
15 15504
16 4845
17 1140
18 190
19 20
</pre></div>
</div>
</div>
</div>
<p>Formally, the number of combinations of length <span class="math notranslate nohighlight">\(k\)</span> in a set of options of length <span class="math notranslate nohighlight">\(n\)</span> is the binomial coefficient
$<span class="math notranslate nohighlight">\(
{n \choose k} = \frac{n!}{k!(n - k)!}
\)</span>$</p>
<p>which for <span class="math notranslate nohighlight">\(k = 2\)</span> (all pairs) gives us</p>
<div class="math notranslate nohighlight">
\[
{n \choose 2} = \frac{n!}{2(n - 2)!} = \frac{n (n - 1)}{2}
\]</div>
<p>For <code class="docutils literal notranslate"><span class="pre">autopep8</span></code> with its 30 options…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">autopep8_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">&quot;&lt;option&gt;&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>30
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># docassert</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">autopep8_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">&quot;&lt;option&gt;&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">30</span>
</pre></div>
</div>
</div>
</div>
<p>… we thus need 870 tests to cover all pairs:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">autopep8_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">&quot;&lt;option&gt;&quot;</span><span class="p">])</span> <span class="o">*</span> \
    <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">autopep8_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">&quot;&lt;option&gt;&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>870
</pre></div>
</div>
</div>
</div>
<p>For <code class="docutils literal notranslate"><span class="pre">mypy</span></code> with its 140+ options, though, we already end up with 20,000+ tests to be conducted:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">mypy_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">&quot;&lt;option&gt;&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>170
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># docassert</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">mypy_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">&quot;&lt;option&gt;&quot;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">140</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">mypy_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">&quot;&lt;option&gt;&quot;</span><span class="p">])</span> <span class="o">*</span> \
    <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mypy_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">&quot;&lt;option&gt;&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>28730
</pre></div>
</div>
</div>
</div>
<p>Even if each pair takes a second to run, we’d still be done in three hours of testing, though.</p>
<p>If your program has more options that you all want to get covered in combinations, it is advisable that you limit the number of configurations further – for instance by limiting combinatorial testing to those combinations that possibly can interact with each other; and covering all other (presumably orthogonal) options individually.</p>
<p>This mechanism of creating configurations by extending grammars can be easily extended to other configuration targets.  One may want to explore a greater number of configurations, or expansions in specific contexts.  The <a class="reference internal" href="#Exercises"><span class="xref myst">exercises</span></a>, below, have a number of options ready for you.</p>
</section>
<section id="id1">
<h2>Synopsis<a class="headerlink" href="#id1" title="Link to this heading">#</a></h2>
<p>This chapter provides two classes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">OptionRunner</span></code> automatically extract command-line options from a Python program;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">OptionFuzzer</span></code> uses these to automatically test a Python program with a large variety of options.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">OptionRunner</span></code> runs a program up to the point where it parses its arguments, and then extracts a grammar that describes its invocations:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">autopep8_runner</span> <span class="o">=</span> <span class="n">OptionRunner</span><span class="p">(</span><span class="s2">&quot;autopep8&quot;</span><span class="p">,</span> <span class="s2">&quot;foo.py&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The grammar can be extracted via the method <code class="docutils literal notranslate"><span class="pre">ebnf_grammar()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">option_ebnf_grammar</span> <span class="o">=</span> <span class="n">autopep8_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()</span>
<span class="n">option_ebnf_grammar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&lt;start&gt;&#39;: [&#39;(&lt;option&gt;)*&lt;arguments&gt;&#39;],
 &#39;&lt;option&gt;&#39;: [&#39; -h&#39;,
  &#39; --help&#39;,
  &#39; --version&#39;,
  &#39; -v&#39;,
  &#39; --verbose&#39;,
  &#39; -d&#39;,
  &#39; --diff&#39;,
  &#39; -i&#39;,
  &#39; --in-place&#39;,
  &#39; --global-config &lt;filename&gt;&#39;,
  &#39; --ignore-local-config&#39;,
  &#39; -r&#39;,
  &#39; --recursive&#39;,
  &#39; -j &lt;n&gt;&#39;,
  &#39; --jobs &lt;n&gt;&#39;,
  &#39; -p &lt;n&gt;&#39;,
  &#39; --pep8-passes &lt;n&gt;&#39;,
  &#39; -a&#39;,
  &#39; --aggressive&#39;,
  &#39; --experimental&#39;,
  &#39; --exclude &lt;globs&gt;&#39;,
  &#39; --list-fixes&#39;,
  &#39; --ignore &lt;errors&gt;&#39;,
  &#39; --select &lt;errors&gt;&#39;,
  &#39; --max-line-length &lt;n&gt;&#39;,
  &#39; --line-range &lt;line&gt; &lt;line&gt;&#39;,
  &#39; --range &lt;line&gt; &lt;line&gt;&#39;,
  &#39; --indent-size &lt;int&gt;&#39;,
  &#39; --hang-closing&#39;,
  &#39; --exit-code&#39;],
 &#39;&lt;arguments&gt;&#39;: [&#39; foo.py&#39;],
 &#39;&lt;str&gt;&#39;: [&#39;&lt;char&gt;+&#39;],
 &#39;&lt;char&gt;&#39;: [&#39;0&#39;,
  &#39;1&#39;,
  &#39;2&#39;,
  &#39;3&#39;,
  &#39;4&#39;,
  &#39;5&#39;,
  &#39;6&#39;,
  &#39;7&#39;,
  &#39;8&#39;,
  &#39;9&#39;,
  &#39;a&#39;,
  &#39;b&#39;,
  &#39;c&#39;,
  &#39;d&#39;,
  &#39;e&#39;,
  &#39;f&#39;,
  &#39;g&#39;,
  &#39;h&#39;,
  &#39;i&#39;,
  &#39;j&#39;,
  &#39;k&#39;,
  &#39;l&#39;,
  &#39;m&#39;,
  &#39;n&#39;,
  &#39;o&#39;,
  &#39;p&#39;,
  &#39;q&#39;,
  &#39;r&#39;,
  &#39;s&#39;,
  &#39;t&#39;,
  &#39;u&#39;,
  &#39;v&#39;,
  &#39;w&#39;,
  &#39;x&#39;,
  &#39;y&#39;,
  &#39;z&#39;,
  &#39;A&#39;,
  &#39;B&#39;,
  &#39;C&#39;,
  &#39;D&#39;,
  &#39;E&#39;,
  &#39;F&#39;,
  &#39;G&#39;,
  &#39;H&#39;,
  &#39;I&#39;,
  &#39;J&#39;,
  &#39;K&#39;,
  &#39;L&#39;,
  &#39;M&#39;,
  &#39;N&#39;,
  &#39;O&#39;,
  &#39;P&#39;,
  &#39;Q&#39;,
  &#39;R&#39;,
  &#39;S&#39;,
  &#39;T&#39;,
  &#39;U&#39;,
  &#39;V&#39;,
  &#39;W&#39;,
  &#39;X&#39;,
  &#39;Y&#39;,
  &#39;Z&#39;,
  &#39;!&#39;,
  &#39;&quot;&#39;,
  &#39;#&#39;,
  &#39;$&#39;,
  &#39;%&#39;,
  &#39;&amp;&#39;,
  &quot;&#39;&quot;,
  &#39;(&#39;,
  &#39;)&#39;,
  &#39;*&#39;,
  &#39;+&#39;,
  &#39;,&#39;,
  &#39;-&#39;,
  &#39;.&#39;,
  &#39;/&#39;,
  &#39;:&#39;,
  &#39;;&#39;,
  &#39;&lt;&#39;,
  &#39;=&#39;,
  &#39;&gt;&#39;,
  &#39;?&#39;,
  &#39;@&#39;,
  &#39;[&#39;,
  &#39;\\&#39;,
  &#39;]&#39;,
  &#39;^&#39;,
  &#39;_&#39;,
  &#39;`&#39;,
  &#39;{&#39;,
  &#39;|&#39;,
  &#39;}&#39;,
  &#39;~&#39;],
 &#39;&lt;filename&gt;&#39;: [&#39;&lt;str&gt;&#39;],
 &#39;&lt;int&gt;&#39;: [&#39;(-)?&lt;digit&gt;+&#39;],
 &#39;&lt;digit&gt;&#39;: [&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;],
 &#39;&lt;n&gt;&#39;: [&#39;&lt;int&gt;&#39;],
 &#39;&lt;globs&gt;&#39;: [&#39;&lt;str&gt;&#39;],
 &#39;&lt;errors&gt;&#39;: [&#39;&lt;str&gt;&#39;],
 &#39;&lt;line&gt;&#39;: [&#39;&lt;int&gt;&#39;]}
</pre></div>
</div>
</div>
</div>
<p>The grammar can be immediately used for fuzzing. A <code class="docutils literal notranslate"><span class="pre">GrammarCoverageFuzzer</span></code> will ensure all options are covered:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Grammars</span> <span class="kn">import</span> <span class="n">convert_ebnf_grammar</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fuzzer</span> <span class="o">=</span> <span class="n">GrammarCoverageFuzzer</span><span class="p">(</span><span class="n">convert_ebnf_grammar</span><span class="p">(</span><span class="n">option_ebnf_grammar</span><span class="p">))</span>
<span class="p">[</span><span class="n">fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39; --max-line-length -64 foo.py&#39;,
 &quot; -a --version --select u --diff --list-fixes -r --range -50 3 --ignore iq --hang-closing --ignore-local-config --aggressive --in-place --indent-size 9 -d --global-config wQ --help --line-range -8226 7 -j 1 -p 2 -h --experimental -i -v --jobs -81 --exclude c --exit-code --verbose --recursive --exclude j --pep8-passes 587 --global-config 5ty --global-config W]96{&lt; --ignore M --exclude . --select &gt; --global-config T --ignore z&#39;C --select %EIL -r -a -v foo.py&quot;,
 &#39; --exclude VKSl --exclude 3[ --global-config ^0x --ignore 4 --exclude _ --global-config 7 --select mh --global-config e --global-config R --global-config JH\\ --exclude OP --ignore = --global-config @ --select ?N --global-config s --select *}v --ignore - --select Do,GA --exclude bkn --ignore U --exclude | --global-config 2 --exclude 8 --select &quot; --exclude pZ --select / --exclude f(aYdg) --select : --global-config ~ --global-config ! --global-config 1B`$X --exclude ; --select F --select &amp; --ignore r --exclude #+ --exit-code --aggressive --select ?/ -p -6 --version --ignore-local-config -r -v foo.py&#39;]
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">OptionFuzzer</span></code> class summarizes these steps.  Its constructor takes an <code class="docutils literal notranslate"><span class="pre">OptionRunner</span></code> to automatically extract the grammar; it does the necessary steps to extract the grammar and fuzz with it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">autopep8_runner</span> <span class="o">=</span> <span class="n">OptionRunner</span><span class="p">(</span><span class="s2">&quot;autopep8&quot;</span><span class="p">,</span> <span class="s2">&quot;foo.py&quot;</span><span class="p">)</span>
<span class="n">autopep8_fuzzer</span> <span class="o">=</span> <span class="n">OptionFuzzer</span><span class="p">(</span><span class="n">autopep8_runner</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">autopep8_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39; --version foo.py&#39;,
 &#39; --ignore Rj --jobs -6 --line-range -04 7953 --help --aggressive -v --ignore-local-config -h --experimental -r --global-config 3 --indent-size -8 --exclude ;&amp;M&quot;! -a -p 1 --hang-closing -j 263 --verbose --recursive --in-place --list-fixes --select t@fs --range -0 7 -d --pep8-passes 7 --diff -i --exit-code --max-line-length -3 --global-config L --select u| --global-config \&#39; --global-config r --exclude Ik) --ignore D- --ignore 4 --select XS --global-config 7 --ignore ~. --ignore e9 --exclude ph --ignore U --global-config dz --global-config Q$o --exclude 6( --ignore x --select 5J:N --exclude &lt; --ignore O --global-config ,c --global-config = --exclude W\\ --global-config ? --select l --select ^ --select V --exclude P --select Z --select &gt;0 --select TH --exclude * --exclude G --select 8 --global-config bn --global-config C{a1m --exclude F --ignore _ --ignore g --ignore ]q --exclude wy --ignore % --global-config v --ignore + --global-config EK/ --ignore [#}Y --global-config `i --global-config 2 --ignore BE --global-config A --indent-size -22 --recursive --hang-closing --exclude ` --indent-size -61 --diff -a foo.py&#39;,
 &#39; foo.py&#39;]
</pre></div>
</div>
</div>
</div>
<p>The final step in testing would now to invoke the program with these arguments.</p>
<p>Note that <code class="docutils literal notranslate"><span class="pre">OptionRunner</span></code> is experimental: It assumes that the Python program in question uses the <code class="docutils literal notranslate"><span class="pre">argparse</span></code> module; and not all <code class="docutils literal notranslate"><span class="pre">argparse</span></code> features are supported.  Still, it does a pretty good job even on nontrivial programs.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">OptionRunner</span></code> constructor accepts an additional <code class="docutils literal notranslate"><span class="pre">miner</span></code> keyword parameter, which takes the class of the argument grammar miner to be used. By default, this is <code class="docutils literal notranslate"><span class="pre">OptionGrammarMiner</span></code> – a helper class that can be used (and extended) to create own option grammar miners.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="kn">from</span> <span class="nn">ClassDiagram</span> <span class="kn">import</span> <span class="n">display_class_hierarchy</span>
<span class="kn">from</span> <span class="nn">Fuzzer</span> <span class="kn">import</span> <span class="n">Fuzzer</span><span class="p">,</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">ProgramRunner</span>
<span class="kn">from</span> <span class="nn">Grammars</span> <span class="kn">import</span> <span class="n">Expansion</span>
<span class="kn">from</span> <span class="nn">GrammarFuzzer</span> <span class="kn">import</span> <span class="n">GrammarFuzzer</span><span class="p">,</span> <span class="n">DerivationTree</span>
<span class="kn">from</span> <span class="nn">GrammarCoverageFuzzer</span> <span class="kn">import</span> <span class="n">TrackingGrammarCoverageFuzzer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore</span>
<span class="n">display_class_hierarchy</span><span class="p">([</span><span class="n">OptionRunner</span><span class="p">,</span> <span class="n">OptionFuzzer</span><span class="p">,</span> <span class="n">OptionGrammarMiner</span><span class="p">],</span>
                        <span class="n">public_methods</span><span class="o">=</span><span class="p">[</span>
                            <span class="n">Fuzzer</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">Fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">,</span>
                            <span class="n">Fuzzer</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
                            <span class="n">Fuzzer</span><span class="o">.</span><span class="n">runs</span><span class="p">,</span>
                            <span class="n">GrammarFuzzer</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">GrammarFuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">,</span>
                            <span class="n">GrammarFuzzer</span><span class="o">.</span><span class="n">fuzz_tree</span><span class="p">,</span>
                            <span class="n">TrackingGrammarCoverageFuzzer</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">OptionFuzzer</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">OptionFuzzer</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
                            <span class="n">Runner</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">Runner</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
                            <span class="n">ProgramRunner</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">ProgramRunner</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">OptionRunner</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">OptionRunner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">,</span>
                            <span class="n">OptionRunner</span><span class="o">.</span><span class="n">grammar</span><span class="p">,</span>
                            <span class="n">OptionGrammarMiner</span><span class="o">.</span><span class="fm">__init__</span><span class="p">,</span>
                            <span class="n">OptionGrammarMiner</span><span class="o">.</span><span class="n">mine_ebnf_grammar</span><span class="p">,</span>
                            <span class="n">OptionGrammarMiner</span><span class="o">.</span><span class="n">mine_grammar</span><span class="p">,</span>
                        <span class="p">],</span>
                        <span class="n">types</span><span class="o">=</span><span class="p">{</span>
                            <span class="s1">&#39;DerivationTree&#39;</span><span class="p">:</span> <span class="n">DerivationTree</span><span class="p">,</span>
                            <span class="s1">&#39;Expansion&#39;</span><span class="p">:</span> <span class="n">Expansion</span><span class="p">,</span>
                            <span class="s1">&#39;Grammar&#39;</span><span class="p">:</span> <span class="n">Grammar</span>
                        <span class="p">},</span>
                        <span class="n">project</span><span class="o">=</span><span class="s1">&#39;fuzzingbook&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (20241206.2353)
 -->
<!-- Pages: 1 -->
<svg width="586pt" height="771pt"
 viewBox="0.00 0.00 586.12 771.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 767)">
<g id="a_graph0"><a xlink:title="OptionRunner class hierarchy">
<polygon fill="white" stroke="none" points="-4,4 -4,-767 582.12,-767 582.12,4 -4,4"/>
</a>
</g>
<!-- OptionRunner -->
<g id="node1" class="node">
<title>OptionRunner</title>
<g id="a_node1"><a xlink:href="#" xlink:title="class OptionRunner:&#10;Run a program while determining its option grammar">
<polygon fill="none" stroke="black" points="1.5,-36.38 1.5,-185.12 113.5,-185.12 113.5,-36.38 1.5,-36.38"/>
<text text-anchor="start" x="14" y="-168.82" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">OptionRunner</text>
<polyline fill="none" stroke="black" points="1.5,-159.12 113.5,-159.12"/>
<g id="a_node1_0"><a xlink:href="#" xlink:title="OptionRunner">
<g id="a_node1_1"><a xlink:href="#" xlink:title="__init__(self, program: Union[str, List[str]], arguments: Optional[str] = None, *, log: bool = False, miner_class: Optional[Type[OptionGrammarMiner]] = None):&#10;Constructor.&#10;`program` &#45; the (Python) program to be executed&#10;`arguments` &#45; an (optional) string with arguments for `program`&#10;`log` &#45; if True, enable logging in miner&#10;`miner_class` &#45; the `OptionGrammarMiner` class to be used&#10;(default: `OptionGrammarMiner`)">
<text text-anchor="start" x="9.5" y="-146.62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node1_2"><a xlink:href="#" xlink:title="ebnf_grammar(self):&#10;Return extracted grammar in EBNF form">
<text text-anchor="start" x="9.5" y="-133.88" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">ebnf_grammar()</text>
</a>
</g>
<g id="a_node1_3"><a xlink:href="#" xlink:title="grammar(self):&#10;Return extracted grammar in BNF form">
<text text-anchor="start" x="9.5" y="-121.12" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">grammar()</text>
</a>
</g>
<g id="a_node1_4"><a xlink:href="#" xlink:title="executable(self)">
<text text-anchor="start" x="9.5" y="-107.38" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">executable()</text>
</a>
</g>
<g id="a_node1_5"><a xlink:href="#" xlink:title="find_contents(self)">
<text text-anchor="start" x="9.5" y="-94.62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">find_contents()</text>
</a>
</g>
<g id="a_node1_6"><a xlink:href="#" xlink:title="find_grammar(self)">
<text text-anchor="start" x="9.5" y="-81.88" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">find_grammar()</text>
</a>
</g>
<g id="a_node1_7"><a xlink:href="#" xlink:title="invoker(self)">
<text text-anchor="start" x="9.5" y="-69.12" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">invoker()</text>
</a>
</g>
<g id="a_node1_8"><a xlink:href="#" xlink:title="set_arguments(self, args)">
<text text-anchor="start" x="9.5" y="-56.38" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">set_arguments()</text>
</a>
</g>
<g id="a_node1_9"><a xlink:href="#" xlink:title="set_invocation(self, program)">
<text text-anchor="start" x="9.5" y="-43.62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">set_invocation()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- ProgramRunner -->
<g id="node2" class="node">
<title>ProgramRunner</title>
<g id="a_node2"><a xlink:href="Fuzzer.ipynb" xlink:title="class ProgramRunner:&#10;Test a program with inputs.">
<polygon fill="none" stroke="black" points="0,-258 0,-304.75 115,-304.75 115,-258 0,-258"/>
<text text-anchor="start" x="8" y="-288.45" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">ProgramRunner</text>
<polyline fill="none" stroke="black" points="0,-278.75 115,-278.75"/>
<g id="a_node2_10"><a xlink:href="#" xlink:title="ProgramRunner">
<g id="a_node2_11"><a xlink:href="Fuzzer.ipynb" xlink:title="__init__(self, program: Union[str, List[str]]) &#45;&gt; None:&#10;Initialize.&#10;`program` is a program spec as passed to `subprocess.run()`">
<text text-anchor="start" x="27.5" y="-266.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- OptionRunner&#45;&gt;ProgramRunner -->
<g id="edge1" class="edge">
<title>OptionRunner&#45;&gt;ProgramRunner</title>
<path fill="none" stroke="black" d="M57.5,-185.22C57.5,-206.42 57.5,-228.55 57.5,-246.13"/>
<polygon fill="none" stroke="black" points="54,-245.99 57.5,-255.99 61,-245.99 54,-245.99"/>
</g>
<!-- Runner -->
<g id="node3" class="node">
<title>Runner</title>
<g id="a_node3"><a xlink:href="Fuzzer.ipynb" xlink:title="class Runner:&#10;Base class for testing inputs.">
<polygon fill="none" stroke="black" points="19.5,-341.75 19.5,-447.5 95.5,-447.5 95.5,-341.75 19.5,-341.75"/>
<text text-anchor="start" x="34.62" y="-431.2" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">Runner</text>
<polyline fill="none" stroke="black" points="19.5,-421.5 95.5,-421.5"/>
<g id="a_node3_12"><a xlink:href="#" xlink:title="Runner">
<g id="a_node3_13"><a xlink:href="Fuzzer.ipynb" xlink:title="FAIL = &#39;FAIL&#39;">
<text text-anchor="start" x="27.5" y="-408" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">FAIL</text>
</a>
</g>
<g id="a_node3_14"><a xlink:href="Fuzzer.ipynb" xlink:title="PASS = &#39;PASS&#39;">
<text text-anchor="start" x="27.5" y="-395.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">PASS</text>
</a>
</g>
<g id="a_node3_15"><a xlink:href="Fuzzer.ipynb" xlink:title="UNRESOLVED = &#39;UNRESOLVED&#39;">
<text text-anchor="start" x="27.5" y="-382.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">UNRESOLVED</text>
</a>
</g>
</a>
</g>
<polyline fill="none" stroke="black" points="19.5,-375.25 95.5,-375.25"/>
<g id="a_node3_16"><a xlink:href="#" xlink:title="Runner">
<g id="a_node3_17"><a xlink:href="Fuzzer.ipynb" xlink:title="__init__(self) &#45;&gt; None:&#10;Initialize">
<text text-anchor="start" x="27.5" y="-362.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node3_18"><a xlink:href="Fuzzer.ipynb" xlink:title="run(self, inp: str) &#45;&gt; Any:&#10;Run the runner with the given input">
<text text-anchor="start" x="27.5" y="-350" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">run()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- ProgramRunner&#45;&gt;Runner -->
<g id="edge2" class="edge">
<title>ProgramRunner&#45;&gt;Runner</title>
<path fill="none" stroke="black" d="M57.5,-305.16C57.5,-312.58 57.5,-321.21 57.5,-330.12"/>
<polygon fill="none" stroke="black" points="54,-329.97 57.5,-339.97 61,-329.97 54,-329.97"/>
</g>
<!-- OptionFuzzer -->
<g id="node4" class="node">
<title>OptionFuzzer</title>
<g id="a_node4"><a xlink:href="#" xlink:title="class OptionFuzzer:&#10;Fuzz a (Python) program using its arguments">
<polygon fill="none" stroke="black" points="171.25,-81 171.25,-140.5 269.75,-140.5 269.75,-81 171.25,-81"/>
<text text-anchor="start" x="179.25" y="-124.2" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">OptionFuzzer</text>
<polyline fill="none" stroke="black" points="171.25,-114.5 269.75,-114.5"/>
<g id="a_node4_19"><a xlink:href="#" xlink:title="OptionFuzzer">
<g id="a_node4_20"><a xlink:href="#" xlink:title="__init__(self, runner: OptionRunner, *args, **kwargs):&#10;Constructor. `runner` is an OptionRunner.">
<text text-anchor="start" x="190.5" y="-102" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node4_21"><a xlink:href="#" xlink:title="run(self, runner=None, inp=&#39;&#39;):&#10;Run `runner` with fuzz input">
<text text-anchor="start" x="190.5" y="-89.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">run()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- GrammarCoverageFuzzer -->
<g id="node5" class="node">
<title>GrammarCoverageFuzzer</title>
<g id="a_node5"><a xlink:href="GrammarCoverageFuzzer.ipynb" xlink:title="class GrammarCoverageFuzzer:&#10;Produce from grammars, aiming for coverage of all expansions.">
<polygon fill="none" stroke="black" points="133.75,-263.38 133.75,-299.38 307.25,-299.38 307.25,-263.38 133.75,-263.38"/>
<text text-anchor="start" x="141.75" y="-278.07" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">GrammarCoverageFuzzer</text>
</a>
</g>
</g>
<!-- OptionFuzzer&#45;&gt;GrammarCoverageFuzzer -->
<g id="edge3" class="edge">
<title>OptionFuzzer&#45;&gt;GrammarCoverageFuzzer</title>
<path fill="none" stroke="black" d="M220.5,-140.74C220.5,-171.83 220.5,-220.89 220.5,-251.81"/>
<polygon fill="none" stroke="black" points="217,-251.57 220.5,-261.57 224,-251.57 217,-251.57"/>
</g>
<!-- SimpleGrammarCoverageFuzzer -->
<g id="node6" class="node">
<title>SimpleGrammarCoverageFuzzer</title>
<g id="a_node6"><a xlink:href="GrammarCoverageFuzzer.ipynb" xlink:title="class SimpleGrammarCoverageFuzzer:&#10;When choosing expansions, prefer expansions not covered.">
<polygon fill="none" stroke="black" points="113.12,-376.62 113.12,-412.62 327.88,-412.62 327.88,-376.62 113.12,-376.62"/>
<text text-anchor="start" x="121.12" y="-391.32" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">SimpleGrammarCoverageFuzzer</text>
</a>
</g>
</g>
<!-- GrammarCoverageFuzzer&#45;&gt;SimpleGrammarCoverageFuzzer -->
<g id="edge4" class="edge">
<title>GrammarCoverageFuzzer&#45;&gt;SimpleGrammarCoverageFuzzer</title>
<path fill="none" stroke="black" d="M220.5,-299.76C220.5,-317.23 220.5,-344.46 220.5,-365.1"/>
<polygon fill="none" stroke="black" points="217,-364.85 220.5,-374.85 224,-364.85 217,-364.85"/>
</g>
<!-- TrackingGrammarCoverageFuzzer -->
<g id="node7" class="node">
<title>TrackingGrammarCoverageFuzzer</title>
<g id="a_node7"><a xlink:href="GrammarCoverageFuzzer.ipynb" xlink:title="class TrackingGrammarCoverageFuzzer:&#10;Track grammar coverage during production">
<polygon fill="none" stroke="black" points="106.38,-484.5 106.38,-531.25 334.62,-531.25 334.62,-484.5 106.38,-484.5"/>
<text text-anchor="start" x="114.38" y="-514.95" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">TrackingGrammarCoverageFuzzer</text>
<polyline fill="none" stroke="black" points="106.38,-505.25 334.62,-505.25"/>
<g id="a_node7_22"><a xlink:href="#" xlink:title="TrackingGrammarCoverageFuzzer">
<g id="a_node7_23"><a xlink:href="GrammarCoverageFuzzer.ipynb" xlink:title="__init__(self, *args, **kwargs) &#45;&gt; None:&#10;Produce strings from `grammar`, starting with `start_symbol`.&#10;If `min_nonterminals` or `max_nonterminals` is given, use them as limits&#10;for the number of nonterminals produced.&#10;If `disp` is set, display the intermediate derivation trees.&#10;If `log` is set, show intermediate steps as text on standard output.">
<text text-anchor="start" x="190.5" y="-492.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- SimpleGrammarCoverageFuzzer&#45;&gt;TrackingGrammarCoverageFuzzer -->
<g id="edge5" class="edge">
<title>SimpleGrammarCoverageFuzzer&#45;&gt;TrackingGrammarCoverageFuzzer</title>
<path fill="none" stroke="black" d="M220.5,-413.01C220.5,-428.97 220.5,-453.09 220.5,-472.87"/>
<polygon fill="none" stroke="black" points="217,-472.71 220.5,-482.71 224,-472.71 217,-472.71"/>
</g>
<!-- GrammarFuzzer -->
<g id="node8" class="node">
<title>GrammarFuzzer</title>
<g id="a_node8"><a xlink:href="GrammarFuzzer.ipynb" xlink:title="class GrammarFuzzer:&#10;Produce strings from grammars efficiently, using derivation trees.">
<polygon fill="none" stroke="black" points="162.62,-568.25 162.62,-640.5 278.38,-640.5 278.38,-568.25 162.62,-568.25"/>
<text text-anchor="start" x="170.62" y="-624.2" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">GrammarFuzzer</text>
<polyline fill="none" stroke="black" points="162.62,-614.5 278.38,-614.5"/>
<g id="a_node8_24"><a xlink:href="#" xlink:title="GrammarFuzzer">
<g id="a_node8_25"><a xlink:href="GrammarFuzzer.ipynb" xlink:title="__init__(self, grammar: Dict[str, List[Expansion]], start_symbol: str = &#39;&lt;start&gt;&#39;, min_nonterminals: int = 0, max_nonterminals: int = 10, disp: bool = False, log: Union[bool, int] = False) &#45;&gt; None:&#10;Produce strings from `grammar`, starting with `start_symbol`.&#10;If `min_nonterminals` or `max_nonterminals` is given, use them as limits&#10;for the number of nonterminals produced.&#10;If `disp` is set, display the intermediate derivation trees.&#10;If `log` is set, show intermediate steps as text on standard output.">
<text text-anchor="start" x="187.5" y="-602" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node8_26"><a xlink:href="GrammarFuzzer.ipynb" xlink:title="fuzz(self) &#45;&gt; str:&#10;Produce a string from the grammar.">
<text text-anchor="start" x="187.5" y="-589.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">fuzz()</text>
</a>
</g>
<g id="a_node8_27"><a xlink:href="GrammarFuzzer.ipynb" xlink:title="fuzz_tree(self) &#45;&gt; DerivationTree:&#10;Produce a derivation tree from the grammar.">
<text text-anchor="start" x="187.5" y="-576.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">fuzz_tree()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- TrackingGrammarCoverageFuzzer&#45;&gt;GrammarFuzzer -->
<g id="edge6" class="edge">
<title>TrackingGrammarCoverageFuzzer&#45;&gt;GrammarFuzzer</title>
<path fill="none" stroke="black" d="M220.5,-531.27C220.5,-538.86 220.5,-547.65 220.5,-556.42"/>
<polygon fill="none" stroke="black" points="217,-556.33 220.5,-566.33 224,-556.33 217,-556.33"/>
</g>
<!-- Fuzzer -->
<g id="node9" class="node">
<title>Fuzzer</title>
<g id="a_node9"><a xlink:href="Fuzzer.ipynb" xlink:title="class Fuzzer:&#10;Base class for fuzzers.">
<polygon fill="none" stroke="black" points="182.5,-677.5 182.5,-762.5 258.5,-762.5 258.5,-677.5 182.5,-677.5"/>
<text text-anchor="start" x="199.88" y="-746.2" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">Fuzzer</text>
<polyline fill="none" stroke="black" points="182.5,-736.5 258.5,-736.5"/>
<g id="a_node9_28"><a xlink:href="#" xlink:title="Fuzzer">
<g id="a_node9_29"><a xlink:href="Fuzzer.ipynb" xlink:title="__init__(self) &#45;&gt; None:&#10;Constructor">
<text text-anchor="start" x="190.5" y="-724" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node9_30"><a xlink:href="Fuzzer.ipynb" xlink:title="fuzz(self) &#45;&gt; str:&#10;Return fuzz input">
<text text-anchor="start" x="190.5" y="-711.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">fuzz()</text>
</a>
</g>
<g id="a_node9_31"><a xlink:href="Fuzzer.ipynb" xlink:title="run(self, runner: Fuzzer.Runner = &lt;Fuzzer.Runner object at 0x111377e30&gt;) &#45;&gt; Tuple[subprocess.CompletedProcess, str]:&#10;Run `runner` with fuzz input">
<text text-anchor="start" x="190.5" y="-698.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">run()</text>
</a>
</g>
<g id="a_node9_32"><a xlink:href="Fuzzer.ipynb" xlink:title="runs(self, runner: Fuzzer.Runner = &lt;Fuzzer.PrintRunner object at 0x111377a10&gt;, trials: int = 10) &#45;&gt; List[Tuple[subprocess.CompletedProcess, str]]:&#10;Run `runner` with fuzz input, `trials` times">
<text text-anchor="start" x="190.5" y="-685.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">runs()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- GrammarFuzzer&#45;&gt;Fuzzer -->
<g id="edge7" class="edge">
<title>GrammarFuzzer&#45;&gt;Fuzzer</title>
<path fill="none" stroke="black" d="M220.5,-640.7C220.5,-648.68 220.5,-657.31 220.5,-665.83"/>
<polygon fill="none" stroke="black" points="217,-665.8 220.5,-675.8 224,-665.8 217,-665.8"/>
</g>
<!-- OptionGrammarMiner -->
<g id="node10" class="node">
<title>OptionGrammarMiner</title>
<g id="a_node10"><a xlink:href="#" xlink:title="class OptionGrammarMiner:&#10;Helper class for extracting option grammars">
<polygon fill="none" stroke="black" points="288.25,-0.5 288.25,-221 440.75,-221 440.75,-0.5 288.25,-0.5"/>
<text text-anchor="start" x="296.25" y="-204.7" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">OptionGrammarMiner</text>
<polyline fill="none" stroke="black" points="288.25,-195 440.75,-195"/>
<g id="a_node10_33"><a xlink:href="#" xlink:title="OptionGrammarMiner">
<g id="a_node10_34"><a xlink:href="#" xlink:title="ARGUMENTS_SYMBOL = &#39;&lt;arguments&gt;&#39;">
<text text-anchor="start" x="316.5" y="-181.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">ARGUMENTS_SYMBOL</text>
</a>
</g>
<g id="a_node10_35"><a xlink:href="#" xlink:title="OPTION_SYMBOL = &#39;&lt;option&gt;&#39;">
<text text-anchor="start" x="316.5" y="-168.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">OPTION_SYMBOL</text>
</a>
</g>
</a>
</g>
<polyline fill="none" stroke="black" points="288.25,-161.5 440.75,-161.5"/>
<g id="a_node10_36"><a xlink:href="#" xlink:title="OptionGrammarMiner">
<g id="a_node10_37"><a xlink:href="#" xlink:title="__init__(self, function: Callable, log: bool = False):&#10;Constructor.&#10;`function` &#45; a function processing arguments using argparse()&#10;`log` &#45; output diagnostics if True">
<text text-anchor="start" x="307.5" y="-149" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node10_38"><a xlink:href="#" xlink:title="mine_ebnf_grammar(self):&#10;Extract EBNF option grammar">
<text text-anchor="start" x="307.5" y="-136.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">mine_ebnf_grammar()</text>
</a>
</g>
<g id="a_node10_39"><a xlink:href="#" xlink:title="mine_grammar(self):&#10;Extract BNF option grammar">
<text text-anchor="start" x="307.5" y="-123.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">mine_grammar()</text>
</a>
</g>
<g id="a_node10_40"><a xlink:href="#" xlink:title="add_group(self, locals, exclusive)">
<text text-anchor="start" x="307.5" y="-109.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">add_group()</text>
</a>
</g>
<g id="a_node10_41"><a xlink:href="#" xlink:title="add_int_rule(self)">
<text text-anchor="start" x="307.5" y="-97" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">add_int_rule()</text>
</a>
</g>
<g id="a_node10_42"><a xlink:href="#" xlink:title="add_metavar_rule(self, metavar, type_)">
<text text-anchor="start" x="307.5" y="-84.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">add_metavar_rule()</text>
</a>
</g>
<g id="a_node10_43"><a xlink:href="#" xlink:title="add_parameter(self, kwargs, metavar)">
<text text-anchor="start" x="307.5" y="-71.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">add_parameter()</text>
</a>
</g>
<g id="a_node10_44"><a xlink:href="#" xlink:title="add_str_rule(self)">
<text text-anchor="start" x="307.5" y="-58.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">add_str_rule()</text>
</a>
</g>
<g id="a_node10_45"><a xlink:href="#" xlink:title="add_type_rule(self, type_)">
<text text-anchor="start" x="307.5" y="-46" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">add_type_rule()</text>
</a>
</g>
<g id="a_node10_46"><a xlink:href="#" xlink:title="process_arg(self, arg, in_group, kwargs)">
<text text-anchor="start" x="307.5" y="-33.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">process_arg()</text>
</a>
</g>
<g id="a_node10_47"><a xlink:href="#" xlink:title="process_argument(self, locals, in_group)">
<text text-anchor="start" x="307.5" y="-20.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">process_argument()</text>
</a>
</g>
<g id="a_node10_48"><a xlink:href="#" xlink:title="traceit(self, frame, event, arg)">
<text text-anchor="start" x="307.5" y="-7.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">traceit()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- Legend -->
<g id="node11" class="node">
<title>Legend</title>
<text text-anchor="start" x="458.88" y="-126.75" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="10.00" fill="#b03a2e">Legend</text>
<text text-anchor="start" x="458.88" y="-116.75" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="464.88" y="-116.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="8.00">public_method()</text>
<text text-anchor="start" x="458.88" y="-106.75" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="464.88" y="-106.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="8.00">private_method()</text>
<text text-anchor="start" x="458.88" y="-96.75" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="464.88" y="-96.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="8.00">overloaded_method()</text>
<text text-anchor="start" x="458.88" y="-87.7" font-family="Helvetica,sans-Serif" font-size="9.00">Hover over names to see doc</text>
</g>
</g>
</svg>
</div></div>
</div>
</section>
<section id="lessons-learned">
<h2>Lessons Learned<a class="headerlink" href="#lessons-learned" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Besides regular input data, program <em>configurations</em> make an important testing target.</p></li>
<li><p>For a given program using a standard library to parse command-line options and arguments, one can automatically extract these and convert them into a grammar.</p></li>
<li><p>To cover not only single options, but combinations of options, one can expand the grammar to cover all pairs, or come up with even more ambitious targets.</p></li>
</ul>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">#</a></h2>
<p>If you liked the idea of mining a grammar from a program, do not miss:</p>
<ul class="simple">
<li><p><a class="reference internal" href="GrammarMiner.html"><span class="std std-doc">how to mine grammars for input data</span></a></p></li>
</ul>
<p>Our next steps in the book focus on:</p>
<ul class="simple">
<li><p><a class="reference internal" href="Parser.html"><span class="std std-doc">how to parse and recombine inputs</span></a></p></li>
<li><p><a class="reference internal" href="ProbabilisticGrammarFuzzer.html"><span class="std std-doc">how to assign weights and probabilities to specific productions</span></a></p></li>
<li><p><a class="reference internal" href="Reducer.html"><span class="std std-doc">how to simplify inputs that cause a failure</span></a></p></li>
</ul>
</section>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h2>
<p>Although configuration data is just as likely to cause failures as other input data, it has received relatively little attention in test generation – possibly because, unlike “regular” input data, configuration data is not so much under control of external parties, and because, again unlike regular data, there is little variance in configurations.  Creating models for software configurations and using these models for testing is commonplace, as is the idea of pairwise testing.  For an overview, see \cite{Pezze2008}; for a discussion and comparison of state-of-the-art techniques, see \cite{Petke2015}.</p>
<p>More specifically, \cite{Sutton2007} also discuss techniques to systematically cover command-line options.  Dai et al. \cite{Dai2010} apply configuration fuzzing by changing variables associated with configuration files.</p>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<section id="exercise-1-ifdef-configuration-fuzzing">
<h3>Exercise 1: #ifdef Configuration Fuzzing<a class="headerlink" href="#exercise-1-ifdef-configuration-fuzzing" title="Link to this heading">#</a></h3>
<p>In C programs, the <em>C preprocessor</em> can be used to choose which code parts should be compiled and which ones should not.  As an example, in the C code</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifdef LONG_FOO</span>
<span class="kt">long</span><span class="w"> </span><span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span>
<span class="cp">#endif</span>
</pre></div>
</div>
<p>the compiler will compile the function <code class="docutils literal notranslate"><span class="pre">foo()</span></code> with return type<code class="docutils literal notranslate"><span class="pre">long</span></code> if the <em>preprocessor variable</em> <code class="docutils literal notranslate"><span class="pre">LONG_FOO</span></code> is defined, and with return type <code class="docutils literal notranslate"><span class="pre">int</span></code> if not.  Such preprocessor variables are either set in the source files (using <code class="docutils literal notranslate"><span class="pre">#define</span></code>, as in <code class="docutils literal notranslate"><span class="pre">#define</span> <span class="pre">LONG_FOO</span></code>) or on the C compiler command line (using <code class="docutils literal notranslate"><span class="pre">-D&lt;variable&gt;</span></code> or <code class="docutils literal notranslate"><span class="pre">-D&lt;variable&gt;=&lt;value&gt;</span></code>, as in <code class="docutils literal notranslate"><span class="pre">-DLONG_FOO</span></code>.</p>
<p>Such <em>conditional compilation</em> is used to configure C programs towards their environment.  System-specific code can contain lots of conditional compilation.  As an example, consider this excerpt of <code class="docutils literal notranslate"><span class="pre">xmlparse.c</span></code>, the XML parser that is part of the Python runtime library:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#if defined(_WIN32) &amp;&amp; !defined(LOAD_LIBRARY_SEARCH_SYSTEM32)</span>
<span class="cp"># define LOAD_LIBRARY_SEARCH_SYSTEM32  0x00000800</span>
<span class="cp">#endif</span>

<span class="cp">#if !defined(HAVE_GETRANDOM) &amp;&amp; !defined(HAVE_SYSCALL_GETRANDOM) \</span>
<span class="cp">    &amp;&amp; !defined(HAVE_ARC4RANDOM_BUF) &amp;&amp; !defined(HAVE_ARC4RANDOM) \</span>
<span class="cp">    &amp;&amp; !defined(XML_DEV_URANDOM) \</span>
<span class="cp">    &amp;&amp; !defined(_WIN32) \</span>
<span class="cp">    &amp;&amp; !defined(XML_POOR_ENTROPY)</span>
<span class="cp"># error</span>
<span class="cp">#endif</span>

<span class="cp">#if !defined(TIOCSWINSZ) || defined(__SCO__) || defined(__UNIXWARE__)</span>
<span class="cp">#define USE_SYSV_ENVVARS	</span><span class="cm">/* COLUMNS/LINES vs. TERMCAP */</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef XML_UNICODE_WCHAR_T</span>
<span class="cp">#define XML_T(x) (const wchar_t)x</span>
<span class="cp">#define XML_L(x) L ## x</span>
<span class="cp">#else</span>
<span class="cp">#define XML_T(x) (const unsigned short)x</span>
<span class="cp">#define XML_L(x) x</span>
<span class="cp">#endif</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">fun</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">XML_T</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
<p>A typical configuration for the C preprocessor on the above code could be <code class="docutils literal notranslate"><span class="pre">cc</span> <span class="pre">-c</span> <span class="pre">-D_WIN32</span> <span class="pre">-DXML_POOR_ENTROPY</span> <span class="pre">-DXML_UNICODE_WCHAR_T</span> <span class="pre">xmlparse.c</span></code>, defining the given preprocessor variables and selecting the appropriate code fragments.</p>
<p>Since the compiler can only compile one configuration at a time (implying that we can also only <em>test</em> one resulting executable at a time), your task is to find out which of these configurations actually compile.  To this end, proceed in three steps.</p>
<section id="part-1-extract-preprocessor-variables">
<h4>Part 1: Extract Preprocessor Variables<a class="headerlink" href="#part-1-extract-preprocessor-variables" title="Link to this heading">#</a></h4>
<p>Write a <em>function</em> <code class="docutils literal notranslate"><span class="pre">cpp_identifiers()</span></code> that, given a set of lines (say, from <code class="docutils literal notranslate"><span class="pre">open(filename).readlines()</span></code>), extracts all preprocessor variables referenced in <code class="docutils literal notranslate"><span class="pre">#if</span></code> or <code class="docutils literal notranslate"><span class="pre">#ifdef</span></code> preprocessor instructions.  Apply <code class="docutils literal notranslate"><span class="pre">ifdef_identifiers()</span></code> on the sample C input above, such that</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cpp_identifiers</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;xmlparse.c&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">())</span> 
</pre></div>
</div>
<p>returns the set</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;_WIN32&#39;</span><span class="p">,</span> <span class="s1">&#39;LOAD_LIBRARY_SEARCH_SYSTEM32&#39;</span><span class="p">,</span> <span class="s1">&#39;HAVE_GETRANDOM&#39;</span><span class="p">,</span> <span class="s1">&#39;HAVE_SYSCALL_GETRANDOM&#39;</span><span class="p">,</span> <span class="s1">&#39;HAVE_ARC4RANDOM_BUF&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">}</span>

</pre></div>
</div>
<p><strong>Solution.</strong>  Let us start with creating a sample input file, <code class="docutils literal notranslate"><span class="pre">xmlparse.c</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;xmlparse.c&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">#if defined(_WIN32) &amp;&amp; !defined(LOAD_LIBRARY_SEARCH_SYSTEM32)</span>
<span class="sd"># define LOAD_LIBRARY_SEARCH_SYSTEM32  0x00000800</span>
<span class="sd">#endif</span>

<span class="sd">#if !defined(HAVE_GETRANDOM) &amp;&amp; !defined(HAVE_SYSCALL_GETRANDOM) \</span>
<span class="sd">    &amp;&amp; !defined(HAVE_ARC4RANDOM_BUF) &amp;&amp; !defined(HAVE_ARC4RANDOM) \</span>
<span class="sd">    &amp;&amp; !defined(XML_DEV_URANDOM) \</span>
<span class="sd">    &amp;&amp; !defined(_WIN32) \</span>
<span class="sd">    &amp;&amp; !defined(XML_POOR_ENTROPY)</span>
<span class="sd"># error</span>
<span class="sd">#endif</span>

<span class="sd">#if !defined(TIOCSWINSZ) || defined(__SCO__) || defined(__UNIXWARE__)</span>
<span class="sd">#define USE_SYSV_ENVVARS	/* COLUMNS/LINES vs. TERMCAP */</span>
<span class="sd">#endif</span>

<span class="sd">#ifdef XML_UNICODE_WCHAR_T</span>
<span class="sd">#define XML_T(x) (const wchar_t)x</span>
<span class="sd">#define XML_L(x) L ## x</span>
<span class="sd">#else</span>
<span class="sd">#define XML_T(x) (const unsigned short)x</span>
<span class="sd">#define XML_L(x) x</span>
<span class="sd">#endif</span>

<span class="sd">int fun(int x) { return XML_T(x); }</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>To find C preprocessor <code class="docutils literal notranslate"><span class="pre">#if</span></code> directives and preprocessor variables, we use regular expressions matching them.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">re_cpp_if_directive</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s*#\s*(el)?if&quot;</span><span class="p">)</span>
<span class="n">re_cpp_identifier</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[a-zA-Z_$]+&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cpp_identifiers</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
    <span class="n">identifiers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">re_cpp_if_directive</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="n">identifiers</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">re_cpp_identifier</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>

    <span class="c1"># These are preprocessor keywords</span>
    <span class="n">identifiers</span> <span class="o">-=</span> <span class="p">{</span><span class="s2">&quot;if&quot;</span><span class="p">,</span> <span class="s2">&quot;ifdef&quot;</span><span class="p">,</span> <span class="s2">&quot;ifndef&quot;</span><span class="p">,</span> <span class="s2">&quot;defined&quot;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">identifiers</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cpp_ids</span> <span class="o">=</span> <span class="n">cpp_identifiers</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;xmlparse.c&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">())</span>
<span class="n">cpp_ids</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;HAVE_ARC&#39;,
 &#39;HAVE_GETRANDOM&#39;,
 &#39;HAVE_SYSCALL_GETRANDOM&#39;,
 &#39;LOAD_LIBRARY_SEARCH_SYSTEM&#39;,
 &#39;RANDOM&#39;,
 &#39;RANDOM_BUF&#39;,
 &#39;TIOCSWINSZ&#39;,
 &#39;XML_DEV_URANDOM&#39;,
 &#39;XML_POOR_ENTROPY&#39;,
 &#39;XML_UNICODE_WCHAR_T&#39;,
 &#39;_WIN&#39;,
 &#39;__SCO__&#39;,
 &#39;__UNIXWARE__&#39;}
</pre></div>
</div>
</div>
</div>
</section>
<section id="part-2-derive-an-option-grammar">
<h4>Part 2: Derive an Option Grammar<a class="headerlink" href="#part-2-derive-an-option-grammar" title="Link to this heading">#</a></h4>
<p>With the help of <code class="docutils literal notranslate"><span class="pre">cpp_identifiers()</span></code>, create a grammar which has C compiler invocations with a list of options, where each option takes the form <code class="docutils literal notranslate"><span class="pre">-D&lt;variable&gt;</span></code> for a preprocessor variable <code class="docutils literal notranslate"><span class="pre">&lt;variable&gt;</span></code>.  Using this grammar <code class="docutils literal notranslate"><span class="pre">cpp_grammar</span></code>, a fuzzer</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">=</span> <span class="n">GrammarCoverageFuzzer</span><span class="p">(</span><span class="n">cpp_grammar</span><span class="p">)</span>
</pre></div>
</div>
<p>would create C compiler invocations such as</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
<span class="p">[</span><span class="s1">&#39;cc -DHAVE_SYSCALL_GETRANDOM xmlparse.c&#39;</span><span class="p">,</span>
 <span class="s1">&#39;cc -D__SCO__ -DRANDOM_BUF -DXML_UNICODE_WCHAR_T -D__UNIXWARE__ xmlparse.c&#39;</span><span class="p">,</span>
 <span class="s1">&#39;cc -DXML_POOR_ENTROPY xmlparse.c&#39;</span><span class="p">,</span>
 <span class="s1">&#39;cc -DRANDOM xmlparse.c&#39;</span><span class="p">,</span>
 <span class="s1">&#39;cc -D_WIN xmlparse.c&#39;</span><span class="p">,</span>
 <span class="s1">&#39;cc -DHAVE_ARC xmlparse.c&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
<p><strong>Solution.</strong> This is not very difficult:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Grammars</span> <span class="kn">import</span> <span class="n">Grammar</span><span class="p">,</span> <span class="n">is_valid_grammar</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cpp_grammar</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;start&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;cc -c&lt;options&gt; &quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">],</span>
    <span class="s2">&quot;&lt;options&gt;&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&lt;option&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;options&gt;&lt;option&gt;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;&lt;option&gt;&quot;</span><span class="p">:</span> <span class="p">[]</span>
<span class="p">}</span>

<span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">cpp_ids</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">new_symbol</span><span class="p">(</span><span class="n">cpp_grammar</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="nb">id</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">)</span>
    <span class="n">cpp_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;option&gt;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">cpp_grammar</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot; -D&quot;</span> <span class="o">+</span> <span class="nb">id</span><span class="p">]</span>

<span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">cpp_grammar</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cpp_grammar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;&lt;start&gt;&#39;: [&#39;cc -c&lt;options&gt; xmlparse.c&#39;],
 &#39;&lt;options&gt;&#39;: [&#39;&lt;option&gt;&#39;, &#39;&lt;options&gt;&lt;option&gt;&#39;],
 &#39;&lt;option&gt;&#39;: [&#39;&lt;TIOCSWINSZ&gt;&#39;,
  &#39;&lt;__SCO__&gt;&#39;,
  &#39;&lt;LOAD_LIBRARY_SEARCH_SYSTEM&gt;&#39;,
  &#39;&lt;HAVE_SYSCALL_GETRANDOM&gt;&#39;,
  &#39;&lt;__UNIXWARE__&gt;&#39;,
  &#39;&lt;HAVE_ARC&gt;&#39;,
  &#39;&lt;XML_UNICODE_WCHAR_T&gt;&#39;,
  &#39;&lt;HAVE_GETRANDOM&gt;&#39;,
  &#39;&lt;_WIN&gt;&#39;,
  &#39;&lt;RANDOM&gt;&#39;,
  &#39;&lt;RANDOM_BUF&gt;&#39;,
  &#39;&lt;XML_DEV_URANDOM&gt;&#39;,
  &#39;&lt;XML_POOR_ENTROPY&gt;&#39;],
 &#39;&lt;TIOCSWINSZ&gt;&#39;: [&#39; -DTIOCSWINSZ&#39;],
 &#39;&lt;__SCO__&gt;&#39;: [&#39; -D__SCO__&#39;],
 &#39;&lt;LOAD_LIBRARY_SEARCH_SYSTEM&gt;&#39;: [&#39; -DLOAD_LIBRARY_SEARCH_SYSTEM&#39;],
 &#39;&lt;HAVE_SYSCALL_GETRANDOM&gt;&#39;: [&#39; -DHAVE_SYSCALL_GETRANDOM&#39;],
 &#39;&lt;__UNIXWARE__&gt;&#39;: [&#39; -D__UNIXWARE__&#39;],
 &#39;&lt;HAVE_ARC&gt;&#39;: [&#39; -DHAVE_ARC&#39;],
 &#39;&lt;XML_UNICODE_WCHAR_T&gt;&#39;: [&#39; -DXML_UNICODE_WCHAR_T&#39;],
 &#39;&lt;HAVE_GETRANDOM&gt;&#39;: [&#39; -DHAVE_GETRANDOM&#39;],
 &#39;&lt;_WIN&gt;&#39;: [&#39; -D_WIN&#39;],
 &#39;&lt;RANDOM&gt;&#39;: [&#39; -DRANDOM&#39;],
 &#39;&lt;RANDOM_BUF&gt;&#39;: [&#39; -DRANDOM_BUF&#39;],
 &#39;&lt;XML_DEV_URANDOM&gt;&#39;: [&#39; -DXML_DEV_URANDOM&#39;],
 &#39;&lt;XML_POOR_ENTROPY&gt;&#39;: [&#39; -DXML_POOR_ENTROPY&#39;]}
</pre></div>
</div>
</div>
</div>
</section>
<section id="part-3-c-preprocessor-configuration-fuzzing">
<h4>Part 3: C Preprocessor Configuration Fuzzing<a class="headerlink" href="#part-3-c-preprocessor-configuration-fuzzing" title="Link to this heading">#</a></h4>
<p>Using the grammar just produced, use a <code class="docutils literal notranslate"><span class="pre">GrammarCoverageFuzzer</span></code> to</p>
<ol class="arabic simple">
<li><p>Test each processor variable individually</p></li>
<li><p>Test each pair of processor variables, using <code class="docutils literal notranslate"><span class="pre">pairwise()</span></code>.</p></li>
</ol>
<p>What happens if you actually run the invocations?</p>
<p><strong>Solution.</strong> We can simply run the coverage fuzzer, as described above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">=</span> <span class="n">GrammarCoverageFuzzer</span><span class="p">(</span><span class="n">cpp_grammar</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;cc -c -D__UNIXWARE__ -D__SCO__ xmlparse.c&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">Fuzzer</span> <span class="kn">import</span> <span class="n">ProgramRunner</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">invocation</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">,</span> <span class="n">invocation</span><span class="p">)</span>
    <span class="c1"># subprocess.call(invocation, shell=True)</span>
    <span class="n">cc_runner</span> <span class="o">=</span> <span class="n">ProgramRunner</span><span class="p">(</span><span class="n">invocation</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
    <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">outcome</span><span class="p">)</span> <span class="o">=</span> <span class="n">cc_runner</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>$ cc -c -D_WIN -DXML_UNICODE_WCHAR_T -DXML_DEV_URANDOM xmlparse.c
xmlparse.c:22:25: error: expected &#39;)&#39;
   22 | int fun(int x) { return XML_T(x); }
      |                         ^
xmlparse.c:15:25: note: expanded from macro &#39;XML_T&#39;
   15 | #define XML_T(x) (const wchar_t)x
      |                         ^
xmlparse.c:22:25: note: to match this &#39;(&#39;
xmlparse.c:15:18: note: expanded from macro &#39;XML_T&#39;
   15 | #define XML_T(x) (const wchar_t)x
      |                  ^
xmlparse.c:22:25: error: type specifier missing, defaults to &#39;int&#39;; ISO C99 and later do not support implicit int [-Wimplicit-int]
   22 | int fun(int x) { return XML_T(x); }
      |                         ^~~~~~~~
xmlparse.c:15:25: note: expanded from macro &#39;XML_T&#39;
   15 | #define XML_T(x) (const wchar_t)x
      |                   ~~~~~ ^
2 errors generated.
$ cc -c -DLOAD_LIBRARY_SEARCH_SYSTEM -DHAVE_GETRANDOM xmlparse.c
$ cc -c -DXML_POOR_ENTROPY -DHAVE_SYSCALL_GETRANDOM -DHAVE_ARC xmlparse.c
$ cc -c -DRANDOM_BUF -DTIOCSWINSZ xmlparse.c
xmlparse.c:7:3: error: 
    7 | # error
      |   ^
1 error generated.
$ cc -c -DRANDOM xmlparse.c
xmlparse.c:7:3: error: 
    7 | # error
      |   ^
1 error generated.
$ cc -c -DXML_DEV_URANDOM -D__UNIXWARE__ -DTIOCSWINSZ xmlparse.c
$ cc -c -D__SCO__ -D__UNIXWARE__ xmlparse.c
xmlparse.c:7:3: error: 
    7 | # error
      |   ^
1 error generated.
$ cc -c -DTIOCSWINSZ -DRANDOM_BUF xmlparse.c
xmlparse.c:7:3: error: 
    7 | # error
      |   ^
1 error generated.
$ cc -c -DXML_POOR_ENTROPY -DLOAD_LIBRARY_SEARCH_SYSTEM -DXML_POOR_ENTROPY -D__UNIXWARE__ xmlparse.c
$ cc -c -DHAVE_SYSCALL_GETRANDOM -DLOAD_LIBRARY_SEARCH_SYSTEM -DXML_UNICODE_WCHAR_T -DLOAD_LIBRARY_SEARCH_SYSTEM xmlparse.c
xmlparse.c:22:25: error: expected &#39;)&#39;
   22 | int fun(int x) { return XML_T(x); }
      |                         ^
xmlparse.c:15:25: note: expanded from macro &#39;XML_T&#39;
   15 | #define XML_T(x) (const wchar_t)x
      |                         ^
xmlparse.c:22:25: note: to match this &#39;(&#39;
xmlparse.c:15:18: note: expanded from macro &#39;XML_T&#39;
   15 | #define XML_T(x) (const wchar_t)x
      |                  ^
xmlparse.c:22:25: error: type specifier missing, defaults to &#39;int&#39;; ISO C99 and later do not support implicit int [-Wimplicit-int]
   22 | int fun(int x) { return XML_T(x); }
      |                         ^~~~~~~~
xmlparse.c:15:25: note: expanded from macro &#39;XML_T&#39;
   15 | #define XML_T(x) (const wchar_t)x
      |                   ~~~~~ ^
2 errors generated.
</pre></div>
</div>
</div>
</div>
<p>To test all pairs, we can use <code class="docutils literal notranslate"><span class="pre">pairwise()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pairwise_cpp_grammar</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">cpp_grammar</span><span class="p">)</span>
<span class="n">pairwise_cpp_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;option&gt;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pairwise</span><span class="p">(</span><span class="n">cpp_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;option&gt;&quot;</span><span class="p">])</span>
<span class="n">pairwise_cpp_grammar</span><span class="p">[</span><span class="s2">&quot;&lt;option&gt;&quot;</span><span class="p">][:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;&lt;TIOCSWINSZ&gt;&lt;__SCO__&gt;&#39;,
 &#39;&lt;TIOCSWINSZ&gt;&lt;LOAD_LIBRARY_SEARCH_SYSTEM&gt;&#39;,
 &#39;&lt;TIOCSWINSZ&gt;&lt;HAVE_SYSCALL_GETRANDOM&gt;&#39;,
 &#39;&lt;TIOCSWINSZ&gt;&lt;__UNIXWARE__&gt;&#39;,
 &#39;&lt;TIOCSWINSZ&gt;&lt;HAVE_ARC&gt;&#39;,
 &#39;&lt;TIOCSWINSZ&gt;&lt;XML_UNICODE_WCHAR_T&gt;&#39;,
 &#39;&lt;TIOCSWINSZ&gt;&lt;HAVE_GETRANDOM&gt;&#39;,
 &#39;&lt;TIOCSWINSZ&gt;&lt;_WIN&gt;&#39;,
 &#39;&lt;TIOCSWINSZ&gt;&lt;RANDOM&gt;&#39;,
 &#39;&lt;TIOCSWINSZ&gt;&lt;RANDOM_BUF&gt;&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">invocation</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">,</span> <span class="n">invocation</span><span class="p">)</span>
    <span class="c1"># subprocess.call(invocation, shell=True)</span>
    <span class="n">cc_runner</span> <span class="o">=</span> <span class="n">ProgramRunner</span><span class="p">(</span><span class="n">invocation</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
    <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">outcome</span><span class="p">)</span> <span class="o">=</span> <span class="n">cc_runner</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>$ cc -c -DHAVE_SYSCALL_GETRANDOM -DXML_DEV_URANDOM xmlparse.c
$ cc -c -DRANDOM_BUF xmlparse.c
xmlparse.c:7:3: error: 
    7 | # error
      |   ^
1 error generated.
$ cc -c -DXML_POOR_ENTROPY xmlparse.c
$ cc -c -DRANDOM_BUF -D__UNIXWARE__ -DRANDOM_BUF -DLOAD_LIBRARY_SEARCH_SYSTEM -DXML_DEV_URANDOM xmlparse.c
$ cc -c -D__SCO__ xmlparse.c
xmlparse.c:7:3: error: 
    7 | # error
      |   ^
1 error generated.
$ cc -c -DHAVE_GETRANDOM -DLOAD_LIBRARY_SEARCH_SYSTEM xmlparse.c
$ cc -c -DHAVE_SYSCALL_GETRANDOM xmlparse.c
$ cc -c -DRANDOM xmlparse.c
xmlparse.c:7:3: error: 
    7 | # error
      |   ^
1 error generated.
$ cc -c -D_WIN xmlparse.c
xmlparse.c:7:3: error: 
    7 | # error
      |   ^
1 error generated.
$ cc -c -DHAVE_ARC xmlparse.c
xmlparse.c:7:3: error: 
    7 | # error
      |   ^
1 error generated.
</pre></div>
</div>
</div>
</div>
<p>Some of the compilation errors we get could be expected – for instance, defining <code class="docutils literal notranslate"><span class="pre">XML_UNICODE_WCHAR_T</span></code> when actually, the type is not supported in our environment.  Other errors may not be expected – and it is these errors we would find through systematic configuration fuzzing, as described above.</p>
<p>At the end, don’t forget to clean up:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;xmlparse.c&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;xmlparse.o&quot;</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;xmlparse.o&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="exercise-2-ini-configuration-fuzzing">
<h3>Exercise 2: .ini Configuration Fuzzing<a class="headerlink" href="#exercise-2-ini-configuration-fuzzing" title="Link to this heading">#</a></h3>
<p>Besides command-line options, <em>configuration files</em> are another important source of configurations.  In this exercise, we will consider the very simple configuration language provided by the Python <code class="docutils literal notranslate"><span class="pre">ConfigParser</span></code> module, which is very similar to what is found in Microsoft Windows <em>.ini</em> files.</p>
<p>The following example for a <code class="docutils literal notranslate"><span class="pre">ConfigParser</span></code> input file stems right from <a class="reference external" href="https://docs.python.org/3/library/configparser.html">the ConfigParser documentation</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">DEFAULT</span><span class="p">]</span>
<span class="n">ServerAliveInterval</span> <span class="o">=</span> <span class="mi">45</span>
<span class="n">Compression</span> <span class="o">=</span> <span class="n">yes</span>
<span class="n">CompressionLevel</span> <span class="o">=</span> <span class="mi">9</span>
<span class="n">ForwardX11</span> <span class="o">=</span> <span class="n">yes</span>

<span class="p">[</span><span class="n">bitbucket</span><span class="o">.</span><span class="n">org</span><span class="p">]</span>
<span class="n">User</span> <span class="o">=</span> <span class="n">hg</span>

<span class="p">[</span><span class="n">topsecret</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">com</span><span class="p">]</span>
<span class="n">Port</span> <span class="o">=</span> <span class="mi">50022</span>
<span class="n">ForwardX11</span> <span class="o">=</span> <span class="n">no</span>
</pre></div>
</div>
<p>The above <code class="docutils literal notranslate"><span class="pre">ConfigParser</span></code> file can be created programmatically:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">configparser</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
<span class="n">config</span><span class="p">[</span><span class="s1">&#39;DEFAULT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ServerAliveInterval&#39;</span><span class="p">:</span> <span class="s1">&#39;45&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Compression&#39;</span><span class="p">:</span> <span class="s1">&#39;yes&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;CompressionLevel&#39;</span><span class="p">:</span> <span class="s1">&#39;9&#39;</span><span class="p">}</span>
<span class="n">config</span><span class="p">[</span><span class="s1">&#39;bitbucket.org&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">config</span><span class="p">[</span><span class="s1">&#39;bitbucket.org&#39;</span><span class="p">][</span><span class="s1">&#39;User&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;hg&#39;</span>
<span class="n">config</span><span class="p">[</span><span class="s1">&#39;topsecret.server.com&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">topsecret</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;topsecret.server.com&#39;</span><span class="p">]</span>
<span class="n">topsecret</span><span class="p">[</span><span class="s1">&#39;Port&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;50022&#39;</span>     <span class="c1"># mutates the parser</span>
<span class="n">topsecret</span><span class="p">[</span><span class="s1">&#39;ForwardX11&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>  <span class="c1"># same here</span>
<span class="n">config</span><span class="p">[</span><span class="s1">&#39;DEFAULT&#39;</span><span class="p">][</span><span class="s1">&#39;ForwardX11&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;example.ini&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">configfile</span><span class="p">:</span>
    <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">configfile</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;example.ini&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">configfile</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">configfile</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[DEFAULT]
serveraliveinterval = 45
compression = yes
compressionlevel = 9
forwardx11 = yes

[bitbucket.org]
user = hg

[topsecret.server.com]
port = 50022
forwardx11 = no
</pre></div>
</div>
</div>
</div>
<p>and be read in again:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;example.ini&#39;</span><span class="p">)</span>
<span class="n">topsecret</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;topsecret.server.com&#39;</span><span class="p">]</span>
<span class="n">topsecret</span><span class="p">[</span><span class="s1">&#39;Port&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;50022&#39;
</pre></div>
</div>
</div>
</div>
<section id="part-1-read-configuration">
<h4>Part 1: Read Configuration<a class="headerlink" href="#part-1-read-configuration" title="Link to this heading">#</a></h4>
<p>Using <code class="docutils literal notranslate"><span class="pre">configparser</span></code>, create a program reading in the above configuration file and accessing the individual elements.</p>
</section>
<section id="part-2-create-a-configuration-grammar">
<h4>Part 2: Create a Configuration Grammar<a class="headerlink" href="#part-2-create-a-configuration-grammar" title="Link to this heading">#</a></h4>
<p>Design a grammar that will automatically create configuration files suitable for your above program.  Fuzz your program with it.</p>
</section>
<section id="part-3-mine-a-configuration-grammar">
<h4>Part 3: Mine a Configuration Grammar<a class="headerlink" href="#part-3-mine-a-configuration-grammar" title="Link to this heading">#</a></h4>
<p>By dynamically tracking the individual accesses to configuration elements, you can again extract a basic grammar from the execution.  To this end, create a subclass of <code class="docutils literal notranslate"><span class="pre">ConfigParser</span></code> with a special method <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TrackingConfigParser</span><span class="p">(</span><span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Accessing&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>For a <code class="docutils literal notranslate"><span class="pre">TrackingConfigParser</span></code> object <code class="docutils literal notranslate"><span class="pre">p</span></code>, <code class="docutils literal notranslate"><span class="pre">p.__getitem__(key)</span></code> will be invoked whenever <code class="docutils literal notranslate"><span class="pre">p[key]</span></code> is accessed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tracking_config_parser</span> <span class="o">=</span> <span class="n">TrackingConfigParser</span><span class="p">()</span>
<span class="n">tracking_config_parser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;example.ini&#39;</span><span class="p">)</span>
<span class="n">section</span> <span class="o">=</span> <span class="n">tracking_config_parser</span><span class="p">[</span><span class="s1">&#39;topsecret.server.com&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Accessing &#39;topsecret.server.com&#39;
</pre></div>
</div>
</div>
</div>
<p>Using <code class="docutils literal notranslate"><span class="pre">__getitem__()</span></code>, as above, implement a tracking mechanism that, while your program accesses the read configuration, automatically saves options accessed and values read.  Create a prototype grammar from these values; use it for fuzzing.</p>
<p>At the end, don’t forget to clean up:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;example.ini&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Solution.</strong> Left to the reader.  Enjoy!</p>
</section>
</section>
<section id="exercise-3-extracting-and-fuzzing-c-command-line-options">
<h3>Exercise 3: Extracting and Fuzzing C Command-Line Options<a class="headerlink" href="#exercise-3-extracting-and-fuzzing-c-command-line-options" title="Link to this heading">#</a></h3>
<p>In C programs, the <code class="docutils literal notranslate"><span class="pre">getopt()</span></code> function are frequently used to process configuration options.  A call</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">getopt</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="s2">&quot;bf:&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>indicates that the program accepts two options <code class="docutils literal notranslate"><span class="pre">-b</span></code> and <code class="docutils literal notranslate"><span class="pre">-f</span></code>, with <code class="docutils literal notranslate"><span class="pre">-f</span></code> taking an argument (as indicated by the following colon).</p>
<section id="part-1-getopt-fuzzing">
<h4>Part 1: Getopt Fuzzing<a class="headerlink" href="#part-1-getopt-fuzzing" title="Link to this heading">#</a></h4>
<p>Write a framework which, for a given C program, automatically extracts the argument to <code class="docutils literal notranslate"><span class="pre">getopt()</span></code> and derives a fuzzing grammar for it.  There are multiple ways to achieve this:</p>
<ol class="arabic simple">
<li><p>Scan the program source code for occurrences of <code class="docutils literal notranslate"><span class="pre">getopt()</span></code> and return the string passed.  (Crude, but should frequently work.)</p></li>
<li><p>Insert your own implementation of <code class="docutils literal notranslate"><span class="pre">getopt()</span></code> into the source code (effectively replacing <code class="docutils literal notranslate"><span class="pre">getopt()</span></code> from the runtime library), which outputs the <code class="docutils literal notranslate"><span class="pre">getopt()</span></code> argument and exits the program.  Recompile and run.</p></li>
<li><p>(Advanced.) As above, but instead of changing the source code, hook into the <em>dynamic linker</em> which at runtime links the program with the C runtime library.  Set the library loading path (on Linux and Unix, this is the <code class="docutils literal notranslate"><span class="pre">LD_LIBRARY_PATH</span></code> environment variable) such that your own version of <code class="docutils literal notranslate"><span class="pre">getopt()</span></code> is linked first, and the regular libraries later.  Executing the program (without recompiling) should yield the desired result.</p></li>
</ol>
<p>Apply this on <code class="docutils literal notranslate"><span class="pre">grep</span></code> and <code class="docutils literal notranslate"><span class="pre">ls</span></code>; report the resulting grammars and results.</p>
<p><strong>Solution.</strong> Left to the reader.  Enjoy hacking!</p>
</section>
<section id="part-2-fuzzing-long-options-in-c">
<h4>Part 2: Fuzzing Long Options in C<a class="headerlink" href="#part-2-fuzzing-long-options-in-c" title="Link to this heading">#</a></h4>
<p>Same as Part 1, but also hook into the GNU variant <code class="docutils literal notranslate"><span class="pre">getopt_long()</span></code>, which accepts “long” arguments with double dashes such as <code class="docutils literal notranslate"><span class="pre">--help</span></code>.  Note that method 1, above, will not work here, since the “long” options are defined in a separately defined structure.</p>
<p><strong>Solution.</strong> Left to the reader.  Enjoy hacking!</p>
</section>
</section>
<section id="exercise-4-expansions-in-context">
<h3>Exercise 4: Expansions in Context<a class="headerlink" href="#exercise-4-expansions-in-context" title="Link to this heading">#</a></h3>
<p>In our above option configurations, we have multiple symbols which all expand to the same integer.  For instance, the <code class="docutils literal notranslate"><span class="pre">--line-range</span></code> option of <code class="docutils literal notranslate"><span class="pre">autopep8</span></code> takes two <code class="docutils literal notranslate"><span class="pre">&lt;line&gt;</span></code> parameters which both expand into the same <code class="docutils literal notranslate"><span class="pre">&lt;int&gt;</span></code> symbol:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;option&gt; ::= ... | --line-range &lt;line&gt; &lt;line&gt; | ...
&lt;line&gt; ::= &lt;int&gt;
&lt;int&gt; ::= (-)?&lt;digit&gt;+
&lt;digit&gt; ::= 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">autopep8_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">&quot;&lt;line&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;&lt;int&gt;&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">autopep8_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">&quot;&lt;int&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;(-)?&lt;digit&gt;+&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">autopep8_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">&quot;&lt;digit&gt;&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;]
</pre></div>
</div>
</div>
</div>
<p>Once the <code class="docutils literal notranslate"><span class="pre">GrammarCoverageFuzzer</span></code> has covered all variations of <code class="docutils literal notranslate"><span class="pre">&lt;int&gt;</span></code> (especially by covering all digits) for <em>one</em> option, though, it will no longer strive to achieve such coverage for the next option.  Yet, it could be desirable to achieve such coverage for each option separately.</p>
<p>One way to achieve this with our existing <code class="docutils literal notranslate"><span class="pre">GrammarCoverageFuzzer</span></code> is again to change the grammar accordingly.  The idea is to <em>duplicate</em> expansions – that is, to replace an expansion of a symbol <span class="math notranslate nohighlight">\(s\)</span> with a new symbol <span class="math notranslate nohighlight">\(s'\)</span> whose definition is duplicated from <span class="math notranslate nohighlight">\(s\)</span>.  This way, <span class="math notranslate nohighlight">\(s'\)</span> and <span class="math notranslate nohighlight">\(s\)</span> are separate symbols from a coverage point of view and would be independently covered.</p>
<p>As an example, consider again the above <code class="docutils literal notranslate"><span class="pre">--line-range</span></code> option.  If we want our tests to independently cover all elements of the two <code class="docutils literal notranslate"><span class="pre">&lt;line&gt;</span></code> parameters, we can duplicate the second <code class="docutils literal notranslate"><span class="pre">&lt;line&gt;</span></code> expansion into a new symbol <code class="docutils literal notranslate"><span class="pre">&lt;line'&gt;</span></code> with subsequent duplicated expansions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;option&gt; ::= ... | --line-range &lt;line&gt; &lt;line&#39;&gt; | ...
&lt;line&gt; ::= &lt;int&gt;
&lt;line&#39;&gt; ::= &lt;int&#39;&gt;
&lt;int&gt; ::= (-)?&lt;digit&gt;+
&lt;int&#39;&gt; ::= (-)?&lt;digit&#39;&gt;+
&lt;digit&gt; ::= 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9
&lt;digit&#39;&gt; ::= 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9
</pre></div>
</div>
<p>Design a function <code class="docutils literal notranslate"><span class="pre">inline(grammar,</span> <span class="pre">symbol)</span></code> that returns a duplicate of <code class="docutils literal notranslate"><span class="pre">grammar</span></code> in which every occurrence of <code class="docutils literal notranslate"><span class="pre">&lt;symbol&gt;</span></code> and its expansions become separate copies.  The above grammar could be a result of <code class="docutils literal notranslate"><span class="pre">inline(autopep8_runner.ebnf_grammar(),</span> <span class="pre">&quot;&lt;line&gt;&quot;)</span></code>.</p>
<p>When copying, expansions in the copy should also refer to symbols in the copy.  Hence, when expanding <code class="docutils literal notranslate"><span class="pre">&lt;int&gt;</span></code> in</p>
<p><code class="docutils literal notranslate"><span class="pre">&lt;int&gt;</span> <span class="pre">::=</span> <span class="pre">&lt;int&gt;&lt;digit&gt;</span></code></p>
<p>make that</p>
<div class="highlight-&lt;int&gt; notranslate"><div class="highlight"><pre><span></span>&lt;int&#39;&gt; ::= &lt;int&#39;&gt;&lt;digit&#39;&gt;
</pre></div>
</div>
<p>(and not <code class="docutils literal notranslate"><span class="pre">&lt;int'&gt;</span> <span class="pre">::=</span> <span class="pre">&lt;int&gt;&lt;digit'&gt;</span></code> or <code class="docutils literal notranslate"><span class="pre">&lt;int'&gt;</span> <span class="pre">::=</span> <span class="pre">&lt;int&gt;&lt;digit&gt;</span></code>).</p>
<p>Be sure to add precisely one new set of symbols for each occurrence in the original grammar, and not to expand further in the presence of recursion.</p>
<p><strong>Solution.</strong> Again, left to the reader.  Enjoy!</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="DynamicInvariants.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Mining Function Specifications</p>
      </div>
    </a>
    <a class="right-next"
       href="APIFuzzer.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Fuzzing APIs</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration-options">Configuration Options</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#options-in-python">Options in Python</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-grammar-for-configurations">A Grammar for Configurations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mining-configuration-options">Mining Configuration Options</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tracking-arguments">Tracking Arguments</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-grammar-miner-for-options-and-arguments">A Grammar Miner for Options and Arguments</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-autopep8">Testing Autopep8</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#autopep8-setup">Autopep8 Setup</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mining-an-autopep8-grammar">Mining an Autopep8 Grammar</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-autopep8-options">Creating Autopep8 Options</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#classes-for-fuzzing-configuration-options">Classes for Fuzzing Configuration Options</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-autopep8">Example: Autopep8</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-mypy">Example: MyPy</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-notedown">Example: Notedown</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#combinatorial-testing">Combinatorial Testing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned">Lessons Learned</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1-ifdef-configuration-fuzzing">Exercise 1: #ifdef Configuration Fuzzing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-extract-preprocessor-variables">Part 1: Extract Preprocessor Variables</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-derive-an-option-grammar">Part 2: Derive an Option Grammar</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3-c-preprocessor-configuration-fuzzing">Part 3: C Preprocessor Configuration Fuzzing</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2-ini-configuration-fuzzing">Exercise 2: .ini Configuration Fuzzing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-read-configuration">Part 1: Read Configuration</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-create-a-configuration-grammar">Part 2: Create a Configuration Grammar</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3-mine-a-configuration-grammar">Part 3: Mine a Configuration Grammar</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3-extracting-and-fuzzing-c-command-line-options">Exercise 3: Extracting and Fuzzing C Command-Line Options</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-getopt-fuzzing">Part 1: Getopt Fuzzing</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-fuzzing-long-options-in-c">Part 2: Fuzzing Long Options in C</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-4-expansions-in-context">Exercise 4: Expansions in Context</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Andreas Zeller, Rahul Gopinath, Marcel Böhme, Gordon Fraser, and Christian Holler
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2021-2025 CISPA Helmholtz Center for Information Security (www.cispa.de); © Copyright 2018-2020 Saarland University, authors, and contributors. All Rights Reserved.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>